<!doctype html>














<!-- `site.alt_lang` can specify a language different from the UI -->
<html lang="en" data-mode="light">
  <!-- The Head -->

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta
    name="viewport"
    content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover"
  >

  

  

  
    <!-- Begin Jekyll SEO tag v2.8.0 -->
<meta name="generator" content="Jekyll v4.3.2" />
<meta property="og:title" content="O3 Cpu Decode" />
<meta property="og:locale" content="en" />
<meta name="description" content="Sending fetched instructions to decode stage gem5/src/cpu/o3/fetch_impl.hh 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 961 962 // Pick a random thread to start trying to grab instructions from 963 auto tid_itr = activeThreads-&gt;begin(); 964 std::advance(tid_itr, random_mt.random&lt;uint8_t&gt;(0, activeThreads-&gt;size() - 1)); 965 966 while (available_insts != 0 &amp;&amp; insts_to_decode &lt; decodeWidth) { 967 ThreadID tid = *tid_itr; 968 if (!stalls[tid].decode &amp;&amp; !fetchQueue[tid].empty()) { 969 const auto&amp; inst = fetchQueue[tid].front(); 970 toDecode-&gt;insts[toDecode-&gt;size++] = inst; 971 DPRINTF(Fetch, &quot;[tid:%i] [sn:%llu] Sending instruction to decode &quot; 972 &quot;from fetch queue. Fetch queue size: %i.\n&quot;, 973 tid, inst-&gt;seqNum, fetchQueue[tid].size()); 974 975 wroteToTimeBuffer = true; 976 fetchQueue[tid].pop_front(); 977 insts_to_decode++; 978 available_insts--; 979 } 980 981 tid_itr++; 982 // Wrap around if at end of active threads list 983 if (tid_itr == activeThreads-&gt;end()) 984 tid_itr = activeThreads-&gt;begin(); 985 } 986 987 // If there was activity this cycle, inform the CPU of it. 988 if (wroteToTimeBuffer) { 989 DPRINTF(Activity, &quot;Activity this cycle.\n&quot;); 990 cpu-&gt;activityThisCycle(); 991 } 992 993 // Reset the number of the instruction we&#39;ve fetched. 994 numInst = 0; 995 } //end of the fetch.tick The last job of the fetch stage is passing the fetched instructions to the next stage, decode stage. On the above code, toDecode member field of the fetch is used as an storage located in between the fetch and decode stage." />
<meta property="og:description" content="Sending fetched instructions to decode stage gem5/src/cpu/o3/fetch_impl.hh 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 961 962 // Pick a random thread to start trying to grab instructions from 963 auto tid_itr = activeThreads-&gt;begin(); 964 std::advance(tid_itr, random_mt.random&lt;uint8_t&gt;(0, activeThreads-&gt;size() - 1)); 965 966 while (available_insts != 0 &amp;&amp; insts_to_decode &lt; decodeWidth) { 967 ThreadID tid = *tid_itr; 968 if (!stalls[tid].decode &amp;&amp; !fetchQueue[tid].empty()) { 969 const auto&amp; inst = fetchQueue[tid].front(); 970 toDecode-&gt;insts[toDecode-&gt;size++] = inst; 971 DPRINTF(Fetch, &quot;[tid:%i] [sn:%llu] Sending instruction to decode &quot; 972 &quot;from fetch queue. Fetch queue size: %i.\n&quot;, 973 tid, inst-&gt;seqNum, fetchQueue[tid].size()); 974 975 wroteToTimeBuffer = true; 976 fetchQueue[tid].pop_front(); 977 insts_to_decode++; 978 available_insts--; 979 } 980 981 tid_itr++; 982 // Wrap around if at end of active threads list 983 if (tid_itr == activeThreads-&gt;end()) 984 tid_itr = activeThreads-&gt;begin(); 985 } 986 987 // If there was activity this cycle, inform the CPU of it. 988 if (wroteToTimeBuffer) { 989 DPRINTF(Activity, &quot;Activity this cycle.\n&quot;); 990 cpu-&gt;activityThisCycle(); 991 } 992 993 // Reset the number of the instruction we&#39;ve fetched. 994 numInst = 0; 995 } //end of the fetch.tick The last job of the fetch stage is passing the fetched instructions to the next stage, decode stage. On the above code, toDecode member field of the fetch is used as an storage located in between the fetch and decode stage." />
<link rel="canonical" href="http://localhost:4000/posts/O3-CPU-Decode/" />
<meta property="og:url" content="http://localhost:4000/posts/O3-CPU-Decode/" />
<meta property="og:site_name" content="Ruach" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-05-28T00:00:00-04:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="O3 Cpu Decode" />
<meta name="twitter:site" content="@ruach_lee" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2021-05-28T00:00:00-04:00","datePublished":"2021-05-28T00:00:00-04:00","description":"Sending fetched instructions to decode stage gem5/src/cpu/o3/fetch_impl.hh 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 961 962 // Pick a random thread to start trying to grab instructions from 963 auto tid_itr = activeThreads-&gt;begin(); 964 std::advance(tid_itr, random_mt.random&lt;uint8_t&gt;(0, activeThreads-&gt;size() - 1)); 965 966 while (available_insts != 0 &amp;&amp; insts_to_decode &lt; decodeWidth) { 967 ThreadID tid = *tid_itr; 968 if (!stalls[tid].decode &amp;&amp; !fetchQueue[tid].empty()) { 969 const auto&amp; inst = fetchQueue[tid].front(); 970 toDecode-&gt;insts[toDecode-&gt;size++] = inst; 971 DPRINTF(Fetch, &quot;[tid:%i] [sn:%llu] Sending instruction to decode &quot; 972 &quot;from fetch queue. Fetch queue size: %i.\\n&quot;, 973 tid, inst-&gt;seqNum, fetchQueue[tid].size()); 974 975 wroteToTimeBuffer = true; 976 fetchQueue[tid].pop_front(); 977 insts_to_decode++; 978 available_insts--; 979 } 980 981 tid_itr++; 982 // Wrap around if at end of active threads list 983 if (tid_itr == activeThreads-&gt;end()) 984 tid_itr = activeThreads-&gt;begin(); 985 } 986 987 // If there was activity this cycle, inform the CPU of it. 988 if (wroteToTimeBuffer) { 989 DPRINTF(Activity, &quot;Activity this cycle.\\n&quot;); 990 cpu-&gt;activityThisCycle(); 991 } 992 993 // Reset the number of the instruction we&#39;ve fetched. 994 numInst = 0; 995 } //end of the fetch.tick The last job of the fetch stage is passing the fetched instructions to the next stage, decode stage. On the above code, toDecode member field of the fetch is used as an storage located in between the fetch and decode stage.","headline":"O3 Cpu Decode","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/posts/O3-CPU-Decode/"},"url":"http://localhost:4000/posts/O3-CPU-Decode/"}</script>
<!-- End Jekyll SEO tag -->

  

  <title>O3 Cpu Decode | Ruach
  </title>

  <!--
  The Favicons for Web, Android, Microsoft, and iOS (iPhone and iPad) Apps
  Generated by: https://realfavicongenerator.net/
-->



<link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png">
<link rel="manifest" href="/assets/img/favicons/site.webmanifest">
<link rel="shortcut icon" href="/assets/img/favicons/favicon.ico">
<meta name="apple-mobile-web-app-title" content="Ruach">
<meta name="application-name" content="Ruach">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml">
<meta name="theme-color" content="#ffffff">


  
    
      <link rel="preconnect" href="https://fonts.googleapis.com" >
      <link rel="dns-prefetch" href="https://fonts.googleapis.com" >
    
      <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      <link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin>
    
      <link rel="preconnect" href="https://fonts.googleapis.com" >
      <link rel="dns-prefetch" href="https://fonts.googleapis.com" >
    
      <link rel="preconnect" href="https://cdn.jsdelivr.net" >
      <link rel="dns-prefetch" href="https://cdn.jsdelivr.net" >
    

    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap">
  

  <!-- GA -->
  

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.2/css/all.min.css">

  <link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css">

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.21.2/dist/tocbot.min.css">
  

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css">
  

  
    <!-- Manific Popup -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css">
  

  <!-- JavaScript -->

  

  <!-- A placeholder to allow defining custom metadata -->

</head>


  <body>
    <!-- The Side Bar -->

<aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end">
  <header class="profile-wrapper">
    <a href="/" id="avatar" class="rounded-circle">
      
        
        <img src="/assets/img/jaehyuk.png" width="112" height="112" alt="avatar" onerror="this.style.display='none'">
      
    </a>

    <h1 class="site-title">
      <a href="/">Ruach</a>
    </h1>
    <p class="site-subtitle fst-italic mb-0">Security Researcher at Gatech</p>
  </header>
  <!-- .profile-wrapper -->

  <nav class="flex-column flex-grow-1 w-100 ps-0">
    <ul class="nav">
      <!-- home -->
      <li class="nav-item">
        <a href="/" class="nav-link">
          <i class="fa-fw fas fa-home"></i>
          <span>HOME</span>
        </a>
      </li>
      <!-- the real tabs -->
      
        <li class="nav-item">
          <a href="/categories/" class="nav-link">
            <i class="fa-fw fas fa-stream"></i>
            

            <span>CATEGORIES</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/tags/" class="nav-link">
            <i class="fa-fw fas fa-tags"></i>
            

            <span>TAGS</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/archives/" class="nav-link">
            <i class="fa-fw fas fa-archive"></i>
            

            <span>ARCHIVES</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/about/" class="nav-link">
            <i class="fa-fw fas fa-info-circle"></i>
            

            <span>ABOUT</span>
          </a>
        </li>
        <!-- .nav-item -->
      
    </ul>
  </nav>

  <div class="sidebar-bottom d-flex flex-wrap  align-items-center w-100">
    

    
      

      
        <a
          href="javascript:location.href = 'mailto:' + ['jaehyuk','gatech.edu'].join('@')"
          aria-label="email"
          

          

          

          
        >
          <i class="fas fa-envelope"></i>
        </a>
      
    
      

      
        <a
          href="https://www.linkedin.com/in/jaehyuk-lee-29b33b121/"
          aria-label="linkedin"
          

          
            target="_blank"
            
          

          

          
            rel="noopener noreferrer"
          
        >
          <i class="fab fa-linkedin"></i>
        </a>
      
    
      

      
        <a
          href="https://github.com/Ruach"
          aria-label="github"
          

          
            target="_blank"
            
          

          

          
            rel="noopener noreferrer"
          
        >
          <i class="fab fa-github"></i>
        </a>
      
    
      

      
        <a
          href="https://stackoverflow.com/users/4460514/ruach?tab=profile"
          aria-label="stack-overflow"
          

          
            target="_blank"
            
          

          

          
            rel="noopener noreferrer"
          
        >
          <i class="fab fa-stack-overflow"></i>
        </a>
      
    
  </div>
  <!-- .sidebar-bottom -->
</aside>
<!-- #sidebar -->


    <div id="main-wrapper" class="d-flex justify-content-center">
      <div class="container d-flex flex-column px-xxl-5">
        <!-- The Top Bar -->

<header id="topbar-wrapper" aria-label="Top Bar">
  <div
    id="topbar"
    class="d-flex align-items-center justify-content-between px-lg-3 h-100"
  >
    <nav id="breadcrumb" aria-label="Breadcrumb">
      

      
        
          
            <span>
              <a href="/">
                Home
              </a>
            </span>

          
        
          
        
          
            
              <span>O3 Cpu Decode</span>
            

          
        
      
    </nav>
    <!-- endof #breadcrumb -->

    <button type="button" id="sidebar-trigger" class="btn btn-link">
      <i class="fas fa-bars fa-fw"></i>
    </button>

    <div id="topbar-title">
      Post
    </div>

    <button type="button" id="search-trigger" class="btn btn-link">
      <i class="fas fa-search fa-fw"></i>
    </button>

    <search class="align-items-center ms-3 ms-lg-0">
      <i class="fas fa-search fa-fw"></i>
      <input
        class="form-control"
        id="search-input"
        type="search"
        aria-label="search"
        autocomplete="off"
        placeholder="Search..."
      >
    </search>
    <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button>
  </div>
</header>


        <div class="row flex-grow-1">
          <main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4">
            
              <!-- Refactor the HTML structure -->



<!--
  In order to allow a wide table to scroll horizontally,
  we suround the markdown table with `<div class="table-wrapper">` and `</div>`
-->



<!--
  Fixed kramdown code highlight rendering:
  https://github.com/penibelst/jekyll-compress-html/issues/101
  https://github.com/penibelst/jekyll-compress-html/issues/71#issuecomment-188144901
-->



<!-- Change the icon of checkbox -->



<!-- Handle images -->





<!-- Add header for code snippets -->



<!-- Create heading anchors -->





  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    

    
  

  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    

    
  

  
  

  

  
  

  




<!-- return -->




<article class="px-1">
  <header>
    <h1 data-toc-skip>O3 Cpu Decode</h1>

    <div class="post-meta text-muted">
      <!-- published date -->
      <span>
        Posted
        <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1622174400"
  data-df="ll"
  
    data-bs-toggle="tooltip" data-bs-placement="bottom"
  
>
  May 28, 2021
</time>

      </span>

      <!-- lastmod date -->
      

      

      <div class="d-flex justify-content-between">
        <!-- author(s) -->
        <span>
          

          By

          <em>
            
              <a href="https://ruach.github.io">Jaehyuk Lee</a>
            
          </em>
        </span>

        <!-- read time -->
        <!-- Calculate the post's reading time, and display the word count in tooltip -->



<!-- words per minute -->










<!-- return element -->
<span
  class="readtime"
  data-bs-toggle="tooltip"
  data-bs-placement="bottom"
  title="4532 words"
>
  <em>25 min</em> read</span>

      </div>
      <!-- .d-flex -->
    </div>
    <!-- .post-meta -->
  </header>

  <div class="content">
    <h1 id="sending-fetched-instructions-to-decode-stage">Sending fetched instructions to decode stage</h1>
<p><em>gem5/src/cpu/o3/fetch_impl.hh</em></p>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
</pre></td><td class="rouge-code"><pre> <span class="mi">961</span> 
 <span class="mi">962</span>     <span class="c1">// Pick a random thread to start trying to grab instructions from</span>
 <span class="mi">963</span>     <span class="k">auto</span> <span class="n">tid_itr</span> <span class="o">=</span> <span class="n">activeThreads</span><span class="o">-&gt;</span><span class="n">begin</span><span class="p">();</span>
 <span class="mi">964</span>     <span class="n">std</span><span class="o">::</span><span class="n">advance</span><span class="p">(</span><span class="n">tid_itr</span><span class="p">,</span> <span class="n">random_mt</span><span class="p">.</span><span class="n">random</span><span class="o">&lt;</span><span class="kt">uint8_t</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">activeThreads</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
 <span class="mi">965</span> 
 <span class="mi">966</span>     <span class="nf">while</span> <span class="p">(</span><span class="n">available_insts</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">insts_to_decode</span> <span class="o">&lt;</span> <span class="n">decodeWidth</span><span class="p">)</span> <span class="p">{</span>
 <span class="mi">967</span>         <span class="n">ThreadID</span> <span class="n">tid</span> <span class="o">=</span> <span class="o">*</span><span class="n">tid_itr</span><span class="p">;</span>
 <span class="mi">968</span>         <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">stalls</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">decode</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">fetchQueue</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
 <span class="mi">969</span>             <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">inst</span> <span class="o">=</span> <span class="n">fetchQueue</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">front</span><span class="p">();</span>
 <span class="mi">970</span>             <span class="n">toDecode</span><span class="o">-&gt;</span><span class="n">insts</span><span class="p">[</span><span class="n">toDecode</span><span class="o">-&gt;</span><span class="n">size</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">inst</span><span class="p">;</span>
 <span class="mi">971</span>             <span class="n">DPRINTF</span><span class="p">(</span><span class="n">Fetch</span><span class="p">,</span> <span class="s">"[tid:%i] [sn:%llu] Sending instruction to decode "</span>
 <span class="mi">972</span>                     <span class="s">"from fetch queue. Fetch queue size: %i.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
 <span class="mi">973</span>                     <span class="n">tid</span><span class="p">,</span> <span class="n">inst</span><span class="o">-&gt;</span><span class="n">seqNum</span><span class="p">,</span> <span class="n">fetchQueue</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">size</span><span class="p">());</span>
 <span class="mi">974</span> 
 <span class="mi">975</span>             <span class="n">wroteToTimeBuffer</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
 <span class="mi">976</span>             <span class="n">fetchQueue</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">pop_front</span><span class="p">();</span>
 <span class="mi">977</span>             <span class="n">insts_to_decode</span><span class="o">++</span><span class="p">;</span>
 <span class="mi">978</span>             <span class="n">available_insts</span><span class="o">--</span><span class="p">;</span>
 <span class="mi">979</span>         <span class="p">}</span>
 <span class="mi">980</span> 
 <span class="mi">981</span>         <span class="n">tid_itr</span><span class="o">++</span><span class="p">;</span>
 <span class="mi">982</span>         <span class="c1">// Wrap around if at end of active threads list</span>
 <span class="mi">983</span>         <span class="nf">if</span> <span class="p">(</span><span class="n">tid_itr</span> <span class="o">==</span> <span class="n">activeThreads</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">())</span>
 <span class="mi">984</span>             <span class="n">tid_itr</span> <span class="o">=</span> <span class="n">activeThreads</span><span class="o">-&gt;</span><span class="n">begin</span><span class="p">();</span>
 <span class="mi">985</span>     <span class="p">}</span>
 <span class="mi">986</span> 
 <span class="mi">987</span>     <span class="c1">// If there was activity this cycle, inform the CPU of it.</span>
 <span class="mi">988</span>     <span class="nf">if</span> <span class="p">(</span><span class="n">wroteToTimeBuffer</span><span class="p">)</span> <span class="p">{</span>
 <span class="mi">989</span>         <span class="n">DPRINTF</span><span class="p">(</span><span class="n">Activity</span><span class="p">,</span> <span class="s">"Activity this cycle.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
 <span class="mi">990</span>         <span class="n">cpu</span><span class="o">-&gt;</span><span class="n">activityThisCycle</span><span class="p">();</span>
 <span class="mi">991</span>     <span class="p">}</span>
 <span class="mi">992</span> 
 <span class="mi">993</span>     <span class="c1">// Reset the number of the instruction we've fetched.</span>
 <span class="mi">994</span>     <span class="n">numInst</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
 <span class="mi">995</span> <span class="p">}</span>   <span class="c1">//end of the fetch.tick</span>
</pre></td></tr></tbody></table></code></div></div>
<p>The last job of the fetch stage is passing the fetched instructions
to the next stage, decode stage. 
On the above code, <strong>toDecode</strong> member field of the fetch 
is used as an storage located in between the fetch and decode stage.</p>

<h2 id="fetchstruct-passing-fetch-stages-information-to-decode-stage"><span class="me-2">FetchStruct: passing fetch stage’s information to decode stage</span><a href="#fetchstruct-passing-fetch-stages-information-to-decode-stage" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<p><em>gem5/src/cpu/o3/fetch.hh</em></p>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="mi">431</span>     <span class="c1">//Might be annoying how this name is different than the queue.</span>
<span class="mi">432</span>     <span class="cm">/** Wire used to write any information heading to decode. */</span>
<span class="mi">433</span>     <span class="k">typename</span> <span class="n">TimeBuffer</span><span class="o">&lt;</span><span class="n">FetchStruct</span><span class="o">&gt;::</span><span class="n">wire</span> <span class="n">toDecode</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></div></div>

<p>The toDecode is declared as a wire class defined in the TimeBuffer class. 
Also, because the TimeBuffer is a template class, 
it passes the FetchStruct that contains all fetch stage’s information
required by the decode stage. Let’s take a look at the FetchStruct 
to understand which information is passed to the decode stage.</p>

<p><em>gem5/src/cpu/o3/cpu_policy.hh</em></p>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td class="rouge-code"><pre> <span class="mi">60</span> <span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">Impl</span><span class="p">&gt;</span>
 <span class="mi">61</span> <span class="k">struct</span> <span class="nc">SimpleCPUPolicy</span>
 <span class="mi">62</span> <span class="p">{</span>
 <span class="p">......</span>
 <span class="mi">89</span>     <span class="cm">/** The struct for communication between fetch and decode. */</span>
 <span class="mi">90</span>     <span class="k">typedef</span> <span class="n">DefaultFetchDefaultDecode</span><span class="o">&lt;</span><span class="n">Impl</span><span class="o">&gt;</span> <span class="n">FetchStruct</span><span class="p">;</span>
 <span class="mi">91</span> 
 <span class="mi">92</span>     <span class="cm">/** The struct for communication between decode and rename. */</span>
 <span class="mi">93</span>     <span class="k">typedef</span> <span class="n">DefaultDecodeDefaultRename</span><span class="o">&lt;</span><span class="n">Impl</span><span class="o">&gt;</span> <span class="n">DecodeStruct</span><span class="p">;</span>
 <span class="mi">94</span> 
 <span class="mi">95</span>     <span class="cm">/** The struct for communication between rename and IEW. */</span>
 <span class="mi">96</span>     <span class="k">typedef</span> <span class="n">DefaultRenameDefaultIEW</span><span class="o">&lt;</span><span class="n">Impl</span><span class="o">&gt;</span> <span class="n">RenameStruct</span><span class="p">;</span>
 <span class="mi">97</span> 
 <span class="mi">98</span>     <span class="cm">/** The struct for communication between IEW and commit. */</span>
 <span class="mi">99</span>     <span class="k">typedef</span> <span class="n">DefaultIEWDefaultCommit</span><span class="o">&lt;</span><span class="n">Impl</span><span class="o">&gt;</span> <span class="n">IEWStruct</span><span class="p">;</span>
<span class="mi">100</span> 
<span class="mi">101</span>     <span class="cm">/** The struct for communication within the IEW stage. */</span>
<span class="mi">102</span>     <span class="k">typedef</span> <span class="o">::</span><span class="n">IssueStruct</span><span class="o">&lt;</span><span class="n">Impl</span><span class="o">&gt;</span> <span class="n">IssueStruct</span><span class="p">;</span>
<span class="mi">103</span> 
<span class="mi">104</span>     <span class="cm">/** The struct for all backwards communication. */</span>
<span class="mi">105</span>     <span class="k">typedef</span> <span class="n">TimeBufStruct</span><span class="o">&lt;</span><span class="n">Impl</span><span class="o">&gt;</span> <span class="n">TimeStruct</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></div></div>

<p><em>gem5/src/cpu/o3/comm.h</em></p>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre> <span class="mi">55</span> <span class="cm">/** Struct that defines the information passed from fetch to decode. */</span>
 <span class="mi">56</span> <span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">Impl</span><span class="p">&gt;</span>
 <span class="mi">57</span> <span class="k">struct</span> <span class="nc">DefaultFetchDefaultDecode</span> <span class="p">{</span>
 <span class="mi">58</span>     <span class="k">typedef</span> <span class="k">typename</span> <span class="n">Impl</span><span class="o">::</span><span class="n">DynInstPtr</span> <span class="n">DynInstPtr</span><span class="p">;</span>
 <span class="mi">59</span> 
 <span class="mi">60</span>     <span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
 <span class="mi">61</span> 
 <span class="mi">62</span>     <span class="n">DynInstPtr</span> <span class="n">insts</span><span class="p">[</span><span class="n">Impl</span><span class="o">::</span><span class="n">MaxWidth</span><span class="p">];</span>
 <span class="mi">63</span>     <span class="n">Fault</span> <span class="n">fetchFault</span><span class="p">;</span>
 <span class="mi">64</span>     <span class="n">InstSeqNum</span> <span class="n">fetchFaultSN</span><span class="p">;</span>
 <span class="mi">65</span>     <span class="kt">bool</span> <span class="n">clearFetchFault</span><span class="p">;</span>
 <span class="mi">66</span> <span class="p">};</span>
</pre></td></tr></tbody></table></code></div></div>
<p>As shown in the above code, 
it passes the instructions fetched from the Icache. 
Then how this information is passed to the decode stage?
The answer is the TimeBuffer!</p>

<h2 id="timebuffer-and-wire-sending-the-data-between-two-stages"><span class="me-2">TimeBuffer and wire sending the data between two stages</span><a href="#timebuffer-and-wire-sending-the-data-between-two-stages" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<p>In actual hardware implementation, the register should be placed 
in between the two pipeline stages to share the information
processed by the previous stage to the next stage. 
For that purpose, GEM5 utilize the TimeBuffer and Wire classes.</p>

<h3 id="timebuffer-implementation-and-usage"><span class="me-2">TimeBuffer implementation and usage</span><a href="#timebuffer-implementation-and-usage" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>TimeBuffer is implemented as a template class 
designed to pass any information 
between two different stages. 
Also, it emulates actual behavior of registers.
Therefore, at every clock tick, 
the TimeBuffer is advanced 
and points to different content of the registers.</p>

<h3 id="constructor-and-desctructor-of-the-timebuffer"><span class="me-2">Constructor and Desctructor of the TimeBuffer</span><a href="#constructor-and-desctructor-of-the-timebuffer" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
</pre></td><td class="rouge-code"><pre> <span class="mi">39</span> <span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="p">&gt;</span>
 <span class="mi">40</span> <span class="k">class</span> <span class="nc">TimeBuffer</span>
 <span class="mi">41</span> <span class="p">{</span>
 <span class="mi">42</span>   <span class="k">protected</span><span class="o">:</span>
 <span class="mi">43</span>     <span class="kt">int</span> <span class="n">past</span><span class="p">;</span>
 <span class="mi">44</span>     <span class="kt">int</span> <span class="n">future</span><span class="p">;</span>
 <span class="mi">45</span>     <span class="kt">unsigned</span> <span class="n">size</span><span class="p">;</span>
 <span class="mi">46</span>     <span class="kt">int</span> <span class="n">_id</span><span class="p">;</span>
 <span class="mi">47</span> 
 <span class="mi">48</span>     <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
 <span class="mi">49</span>     <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">char</span> <span class="o">*&gt;</span> <span class="n">index</span><span class="p">;</span>
 <span class="mi">50</span>     <span class="kt">unsigned</span> <span class="n">base</span><span class="p">;</span>
 <span class="mi">51</span> 
 <span class="mi">52</span>     <span class="kt">void</span> <span class="n">valid</span><span class="p">(</span><span class="kt">int</span> <span class="n">idx</span><span class="p">)</span> <span class="k">const</span>
 <span class="mi">53</span>     <span class="p">{</span>
 <span class="mi">54</span>         <span class="n">assert</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="n">past</span> <span class="o">&amp;&amp;</span> <span class="n">idx</span> <span class="o">&lt;=</span> <span class="n">future</span><span class="p">);</span>
 <span class="mi">55</span>     <span class="p">}</span>
<span class="p">......</span>
<span class="mi">139</span>   <span class="k">public</span><span class="o">:</span>
<span class="mi">140</span>     <span class="nf">TimeBuffer</span><span class="p">(</span><span class="kt">int</span> <span class="n">p</span><span class="p">,</span> <span class="kt">int</span> <span class="n">f</span><span class="p">)</span>
<span class="mi">141</span>         <span class="o">:</span> <span class="n">past</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="n">future</span><span class="p">(</span><span class="n">f</span><span class="p">),</span> <span class="n">size</span><span class="p">(</span><span class="n">past</span> <span class="o">+</span> <span class="n">future</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
<span class="mi">142</span>           <span class="n">data</span><span class="p">(</span><span class="k">new</span> <span class="kt">char</span><span class="p">[</span><span class="n">size</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">T</span><span class="p">)]),</span> <span class="n">index</span><span class="p">(</span><span class="n">size</span><span class="p">),</span> <span class="n">base</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="mi">143</span>     <span class="p">{</span>   
<span class="mi">144</span>         <span class="n">assert</span><span class="p">(</span><span class="n">past</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">future</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">);</span>
<span class="mi">145</span>         <span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span> 
<span class="mi">146</span>         <span class="k">for</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">147</span>             <span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">;</span>
<span class="mi">148</span>             <span class="n">std</span><span class="o">::</span><span class="n">memset</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">T</span><span class="p">));</span>
<span class="mi">149</span>             <span class="k">new</span> <span class="p">(</span><span class="n">ptr</span><span class="p">)</span> <span class="n">T</span><span class="p">;</span>
<span class="mi">150</span>             <span class="n">ptr</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">T</span><span class="p">);</span>
<span class="mi">151</span>         <span class="p">}</span>
<span class="mi">152</span>         
<span class="mi">153</span>         <span class="n">_id</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="mi">154</span>     <span class="p">}</span>
<span class="mi">155</span> 
<span class="mi">156</span>     <span class="n">TimeBuffer</span><span class="p">()</span>
<span class="mi">157</span>         <span class="o">:</span> <span class="n">data</span><span class="p">(</span><span class="nb">NULL</span><span class="p">)</span>
<span class="mi">158</span>     <span class="p">{</span>
<span class="mi">159</span>     <span class="p">}</span>
<span class="mi">160</span> 
<span class="mi">161</span>     <span class="o">~</span><span class="n">TimeBuffer</span><span class="p">()</span>
<span class="mi">162</span>     <span class="p">{</span>
<span class="mi">163</span>         <span class="k">for</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
<span class="mi">164</span>             <span class="p">(</span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">T</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span><span class="o">-&gt;~</span><span class="n">T</span><span class="p">();</span>
<span class="mi">165</span>         <span class="k">delete</span> <span class="p">[]</span> <span class="n">data</span><span class="p">;</span>
<span class="mi">166</span>     <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>
<p>Because the TimeBuffer needs to allocate and deallocate new class object 
at every clock cycle, 
it’s constructor is designed to utilize 
a preallocated memory called <strong>data</strong> member field. 
With the help of <strong>placement new</strong>, 
its constructor can initialize 
new object at specific location, index vector. 
As shown in its constructor, 
it populates T typed object, 
size times on the data array. 
It makes the index vector point to the allocated objects. 
At its desctructor, it deletes the data array and every objects
pointed to by the index vector.</p>

<h3 id="advance-timebuffer"><span class="me-2">advance TimeBuffer</span><a href="#advance-timebuffer" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="rouge-code"><pre> <span class="mi">542</span>     <span class="c1">//Tick each of the stages</span>
 <span class="mi">543</span>     <span class="n">fetch</span><span class="p">.</span><span class="n">tick</span><span class="p">();</span>
 <span class="mi">544</span> 
 <span class="mi">545</span>     <span class="n">decode</span><span class="p">.</span><span class="n">tick</span><span class="p">();</span>
 <span class="mi">546</span> 
 <span class="mi">547</span>     <span class="n">rename</span><span class="p">.</span><span class="n">tick</span><span class="p">();</span>
 <span class="mi">548</span> 
 <span class="mi">549</span>     <span class="n">iew</span><span class="p">.</span><span class="n">tick</span><span class="p">();</span>
 <span class="mi">550</span> 
 <span class="mi">551</span>     <span class="n">commit</span><span class="p">.</span><span class="n">tick</span><span class="p">();</span>
 <span class="mi">552</span> 
 <span class="mi">553</span>     <span class="c1">// Now advance the time buffers</span>
 <span class="mi">554</span>     <span class="n">timeBuffer</span><span class="p">.</span><span class="n">advance</span><span class="p">();</span>
 <span class="mi">555</span> 
 <span class="mi">556</span>     <span class="n">fetchQueue</span><span class="p">.</span><span class="n">advance</span><span class="p">();</span>
 <span class="mi">557</span>     <span class="n">decodeQueue</span><span class="p">.</span><span class="n">advance</span><span class="p">();</span>
 <span class="mi">558</span>     <span class="n">renameQueue</span><span class="p">.</span><span class="n">advance</span><span class="p">();</span>
 <span class="mi">559</span>     <span class="n">iewQueue</span><span class="p">.</span><span class="n">advance</span><span class="p">();</span>
 <span class="mi">560</span> 
 <span class="mi">561</span>     <span class="n">activityRec</span><span class="p">.</span><span class="n">advance</span><span class="p">();</span>
</pre></td></tr></tbody></table></code></div></div>
<p>The most important function of the TimeBuffer is the <strong>advance</strong>.
This function is invoked at every clock cycle of the processor 
to advance the TimeBuffer. 
Let’s take a look at how the advance function 
emulates next clock tick.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="mi">178</span>     <span class="kt">void</span>
<span class="mi">179</span>     <span class="n">advance</span><span class="p">()</span>
<span class="mi">180</span>     <span class="p">{</span>
<span class="mi">181</span>         <span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">base</span> <span class="o">&gt;=</span> <span class="n">size</span><span class="p">)</span>
<span class="mi">182</span>             <span class="n">base</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="mi">183</span> 
<span class="mi">184</span>         <span class="kt">int</span> <span class="n">ptr</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="n">future</span><span class="p">;</span>
<span class="mi">185</span>         <span class="k">if</span> <span class="p">(</span><span class="n">ptr</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">size</span><span class="p">)</span>
<span class="mi">186</span>             <span class="n">ptr</span> <span class="o">-=</span> <span class="n">size</span><span class="p">;</span>
<span class="mi">187</span>         <span class="p">(</span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">T</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">index</span><span class="p">[</span><span class="n">ptr</span><span class="p">]))</span><span class="o">-&gt;~</span><span class="n">T</span><span class="p">();</span>
<span class="mi">188</span>         <span class="n">std</span><span class="o">::</span><span class="n">memset</span><span class="p">(</span><span class="n">index</span><span class="p">[</span><span class="n">ptr</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">T</span><span class="p">));</span>
<span class="mi">189</span>         <span class="k">new</span> <span class="p">(</span><span class="n">index</span><span class="p">[</span><span class="n">ptr</span><span class="p">])</span> <span class="n">T</span><span class="p">;</span>
<span class="mi">190</span>     <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>The base member field is initialized as zero at the construction 
and incremented at every clock cycle 
because the advance function is invoked at every clock cycle. 
Also, because it emulates circular storage, 
the base should be initialized as zero
when it exceeds size (line 181-182). 
And the <strong>future</strong> is the fixed constant 
passed by the configuration python script.
Therefore, after the first initialization with offset future, 
at every clock cycle, it allocates new object typed T. 
Before populating new object, 
it first invoke deconstructor (line 188) 
and initiate new object with the placement new (line 189).</p>

<h2 id="wire"><span class="me-2">Wire</span><a href="#wire" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<h3 id="example-motivating-interaction-between-fetch-and-decode"><span class="me-2">Example motivating interaction between fetch and decode</span><a href="#example-motivating-interaction-between-fetch-and-decode" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p><em>gem5/src/cpu/o3/cpu.cc</em></p>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre> <span class="mi">182</span>     <span class="c1">// Also setup each of the stages' queues.</span>
 <span class="mi">183</span>     <span class="n">fetch</span><span class="p">.</span><span class="n">setFetchQueue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fetchQueue</span><span class="p">);</span>
 <span class="mi">184</span>     <span class="n">decode</span><span class="p">.</span><span class="n">setFetchQueue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fetchQueue</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></div></div>

<p><em>gem5/src/cpu/o3/fetch_impl.hh</em></p>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre> <span class="mi">312</span> <span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">Impl</span><span class="p">&gt;</span>
 <span class="mi">313</span> <span class="kt">void</span>
 <span class="mi">314</span> <span class="n">DefaultFetch</span><span class="o">&lt;</span><span class="n">Impl</span><span class="o">&gt;::</span><span class="n">setFetchQueue</span><span class="p">(</span><span class="n">TimeBuffer</span><span class="o">&lt;</span><span class="n">FetchStruct</span><span class="o">&gt;</span> <span class="o">*</span><span class="n">ftb_ptr</span><span class="p">)</span>
 <span class="mi">315</span> <span class="p">{</span>
 <span class="mi">316</span>     <span class="c1">// Create wire to write information to proper place in fetch time buf.</span>
 <span class="mi">317</span>     <span class="n">toDecode</span> <span class="o">=</span> <span class="n">ftb_ptr</span><span class="o">-&gt;</span><span class="n">getWire</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
 <span class="mi">318</span> <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>
<p><em>gem5/src/cpu/o3/decode_impl.hh</em></p>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="mi">195</span> <span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">Impl</span><span class="p">&gt;</span>
<span class="mi">196</span> <span class="kt">void</span>
<span class="mi">197</span> <span class="n">DefaultDecode</span><span class="o">&lt;</span><span class="n">Impl</span><span class="o">&gt;::</span><span class="n">setFetchQueue</span><span class="p">(</span><span class="n">TimeBuffer</span><span class="o">&lt;</span><span class="n">FetchStruct</span><span class="o">&gt;</span> <span class="o">*</span><span class="n">fq_ptr</span><span class="p">)</span>
<span class="mi">198</span> <span class="p">{</span>
<span class="mi">199</span>     <span class="n">fetchQueue</span> <span class="o">=</span> <span class="n">fq_ptr</span><span class="p">;</span>
<span class="mi">200</span> 
<span class="mi">201</span>     <span class="c1">// Setup wire to read information from fetch queue.</span>
<span class="mi">202</span>     <span class="n">fromFetch</span> <span class="o">=</span> <span class="n">fetchQueue</span><span class="o">-&gt;</span><span class="n">getWire</span><span class="p">(</span><span class="o">-</span><span class="n">fetchToDecodeDelay</span><span class="p">);</span>
<span class="mi">203</span> <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>
<p><em>gem5/src/cpu/timebuf.hh</em></p>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="mi">234</span>     <span class="n">wire</span> <span class="nf">getWire</span><span class="p">(</span><span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="mi">235</span>     <span class="p">{</span>
<span class="mi">236</span>         <span class="n">valid</span><span class="p">(</span><span class="n">idx</span><span class="p">);</span>
<span class="mi">237</span> 
<span class="mi">238</span>         <span class="k">return</span> <span class="nf">wire</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
<span class="mi">239</span>     <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>As shown in the above code, 
two different stages fetch and decode 
invoke setFetchQueue function 
with the same TimeBuffer, fetchQueue.
However, 
note that those two invocations are serviced 
from different functions of each class. 
As shown in the above code, 
both function invokes getWire, 
but with different argument, 
0 and -fetchToDecodeDelay respectively. 
The getWire function returns the wire object 
initialized with this and idx.
Here this means the TimeBuffer itself and this will be assigned 
to the buffer member field of the wire object. 
Also, idx will be assigned to 
the index member field of the wire object.
Because the index is a constant number and used to access the register 
managed by the buffer, it will generate fetchToDecodeDelay clock timing delays 
between the fetch and decode stage.
Let’s see how this timing delay can be imposed on the register access in detail.</p>

<h3 id="wire-overloads-the-member-reference-operator-to-access-the-timebuffer"><span class="me-2">Wire overloads the member reference operator to access the TimeBuffer</span><a href="#wire-overloads-the-member-reference-operator-to-access-the-timebuffer" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>Remember that the wire has member field buffer which is the TimeBuffer that actually 
maintains all the register values that should be passed to the next stage. 
However, in general, the register is a flip-flop it cannot be read and written
at the same cycle. 
Therefore, naturally, the next stage will get the data written to the register 
after n clock cycles are elapsed.
This behavior of the register is emulated by the wire and TimeBuffer.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td><td class="rouge-code"><pre> <span class="mi">57</span>   <span class="k">public</span><span class="o">:</span>
 <span class="mi">58</span>     <span class="k">friend</span> <span class="k">class</span> <span class="nc">wire</span><span class="p">;</span>
 <span class="mi">59</span>     <span class="k">class</span> <span class="nc">wire</span>
 <span class="mi">60</span>     <span class="p">{</span>
 <span class="mi">61</span>         <span class="k">friend</span> <span class="k">class</span> <span class="nc">TimeBuffer</span><span class="p">;</span>
 <span class="mi">62</span>       <span class="k">protected</span><span class="o">:</span>
 <span class="mi">63</span>         <span class="n">TimeBuffer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
 <span class="mi">64</span>         <span class="kt">int</span> <span class="n">index</span><span class="p">;</span>
 <span class="mi">65</span> 
 <span class="mi">66</span>         <span class="kt">void</span> <span class="n">set</span><span class="p">(</span><span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
 <span class="mi">67</span>         <span class="p">{</span>   
 <span class="mi">68</span>             <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">valid</span><span class="p">(</span><span class="n">idx</span><span class="p">);</span>
 <span class="mi">69</span>             <span class="n">index</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>
 <span class="mi">70</span>         <span class="p">}</span>
 <span class="mi">71</span> 
 <span class="mi">72</span>         <span class="nf">wire</span><span class="p">(</span><span class="n">TimeBuffer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">i</span><span class="p">)</span>
 <span class="mi">73</span>             <span class="o">:</span> <span class="n">buffer</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="n">index</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
 <span class="mi">74</span>         <span class="p">{</span> <span class="p">}</span>
<span class="p">......</span>
<span class="mi">134</span>         <span class="n">T</span> <span class="o">&amp;</span><span class="k">operator</span><span class="o">*</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="o">*</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">access</span><span class="p">(</span><span class="n">index</span><span class="p">);</span> <span class="p">}</span>
<span class="mi">135</span>         <span class="n">T</span> <span class="o">*</span><span class="k">operator</span><span class="o">-&gt;</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">access</span><span class="p">(</span><span class="n">index</span><span class="p">);</span> <span class="p">}</span>
<span class="mi">136</span>     <span class="p">};</span>
</pre></td></tr></tbody></table></code></div></div>

<p>When the wire is accessed by the -&gt; operator, it invokes 
access function of the TimeBuffer contained in the buffer member field. 
Also note that it passes the index argument set at the construction of the wire.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre></td><td class="rouge-code"><pre><span class="mi">192</span>   <span class="k">protected</span><span class="o">:</span>
<span class="mi">193</span>     <span class="c1">//Calculate the index into this-&gt;index for element at position idx</span>
<span class="mi">194</span>     <span class="c1">//relative to now</span>
<span class="mi">195</span>     <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">calculateVectorIndex</span><span class="p">(</span><span class="kt">int</span> <span class="n">idx</span><span class="p">)</span> <span class="k">const</span>
<span class="mi">196</span>     <span class="p">{</span>
<span class="mi">197</span>         <span class="c1">//Need more complex math here to calculate index.</span>
<span class="mi">198</span>         <span class="n">valid</span><span class="p">(</span><span class="n">idx</span><span class="p">);</span>
<span class="mi">199</span> 
<span class="mi">200</span>         <span class="kt">int</span> <span class="n">vector_index</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">+</span> <span class="n">base</span><span class="p">;</span>
<span class="mi">201</span>         <span class="nf">if</span> <span class="p">(</span><span class="n">vector_index</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">202</span>             <span class="n">vector_index</span> <span class="o">-=</span> <span class="n">size</span><span class="p">;</span>
<span class="mi">203</span>         <span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">vector_index</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">204</span>             <span class="n">vector_index</span> <span class="o">+=</span> <span class="n">size</span><span class="p">;</span>
<span class="mi">205</span>         <span class="p">}</span>
<span class="mi">206</span> 
<span class="mi">207</span>         <span class="k">return</span> <span class="n">vector_index</span><span class="p">;</span>
<span class="mi">208</span>     <span class="p">}</span>
<span class="mi">209</span> 
<span class="mi">210</span>   <span class="k">public</span><span class="o">:</span>
<span class="mi">211</span>     <span class="n">T</span> <span class="o">*</span><span class="nf">access</span><span class="p">(</span><span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="mi">212</span>     <span class="p">{</span>
<span class="mi">213</span>         <span class="kt">int</span> <span class="n">vector_index</span> <span class="o">=</span> <span class="n">calculateVectorIndex</span><span class="p">(</span><span class="n">idx</span><span class="p">);</span>
<span class="mi">214</span> 
<span class="mi">215</span>         <span class="k">return</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">T</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">index</span><span class="p">[</span><span class="n">vector_index</span><span class="p">]);</span>
<span class="mi">216</span>     <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>
<p>When the access is invoked, it first calculates the index for the vector. 
Note that it adds two variable idx and base. 
The base member field is increased by 1 every clock cycle as we’ve seen 
in the <strong>advance</strong> function before. 
the idx field is passed from the wire class that embeds the TimeBuffer. 
For example, it is 0 and -1 for the fetch and decode stage respectively. 
Therefore, in this settings, the decode stage will access the register 
set by the previous clock cycle by the fetch stage. 
Therefore, by setting the index field of the wire at its initialization properly, 
we can set the delays of register access in two different stages.</p>

<h1 id="decode-stage-pipeline-analysis">Decode stage pipeline analysis</h1>

<p><em>gem5/src/cpu/o3/decode_impl.hh</em></p>
<h2 id="tick-of-the-decode-stage"><span class="me-2">tick of the decode stage</span><a href="#tick-of-the-decode-stage" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
</pre></td><td class="rouge-code"><pre><span class="mi">567</span> <span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">Impl</span><span class="p">&gt;</span>
<span class="mi">568</span> <span class="kt">void</span>
<span class="mi">569</span> <span class="n">DefaultDecode</span><span class="o">&lt;</span><span class="n">Impl</span><span class="o">&gt;::</span><span class="n">tick</span><span class="p">()</span>
<span class="mi">570</span> <span class="p">{</span>
<span class="mi">571</span>     <span class="n">wroteToTimeBuffer</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="mi">572</span> 
<span class="mi">573</span>     <span class="kt">bool</span> <span class="n">status_change</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="mi">574</span> 
<span class="mi">575</span>     <span class="n">toRenameIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="mi">576</span> 
<span class="mi">577</span>     <span class="n">list</span><span class="o">&lt;</span><span class="n">ThreadID</span><span class="o">&gt;::</span><span class="n">iterator</span> <span class="n">threads</span> <span class="o">=</span> <span class="n">activeThreads</span><span class="o">-&gt;</span><span class="n">begin</span><span class="p">();</span>
<span class="mi">578</span>     <span class="n">list</span><span class="o">&lt;</span><span class="n">ThreadID</span><span class="o">&gt;::</span><span class="n">iterator</span> <span class="n">end</span> <span class="o">=</span> <span class="n">activeThreads</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">();</span>
<span class="mi">579</span> 
<span class="mi">580</span>     <span class="n">sortInsts</span><span class="p">();</span>
<span class="mi">581</span> 
<span class="mi">582</span>     <span class="c1">//Check stall and squash signals.</span>
<span class="mi">583</span>     <span class="k">while</span> <span class="p">(</span><span class="n">threads</span> <span class="o">!=</span> <span class="n">end</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">584</span>         <span class="n">ThreadID</span> <span class="n">tid</span> <span class="o">=</span> <span class="o">*</span><span class="n">threads</span><span class="o">++</span><span class="p">;</span>
<span class="mi">585</span> 
<span class="mi">586</span>         <span class="n">DPRINTF</span><span class="p">(</span><span class="n">Decode</span><span class="p">,</span><span class="s">"Processing [tid:%i]</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="n">tid</span><span class="p">);</span>
<span class="mi">587</span>         <span class="n">status_change</span> <span class="o">=</span>  <span class="n">checkSignalsAndUpdate</span><span class="p">(</span><span class="n">tid</span><span class="p">)</span> <span class="o">||</span> <span class="n">status_change</span><span class="p">;</span>
<span class="mi">588</span> 
<span class="mi">589</span>         <span class="n">decode</span><span class="p">(</span><span class="n">status_change</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
<span class="mi">590</span>     <span class="p">}</span>
<span class="mi">591</span> 
<span class="mi">592</span>     <span class="nf">if</span> <span class="p">(</span><span class="n">status_change</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">593</span>         <span class="n">updateStatus</span><span class="p">();</span>
<span class="mi">594</span>     <span class="p">}</span>
<span class="mi">595</span> 
<span class="mi">596</span>     <span class="nf">if</span> <span class="p">(</span><span class="n">wroteToTimeBuffer</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">597</span>         <span class="n">DPRINTF</span><span class="p">(</span><span class="n">Activity</span><span class="p">,</span> <span class="s">"Activity this cycle.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="mi">598</span> 
<span class="mi">599</span>         <span class="n">cpu</span><span class="o">-&gt;</span><span class="n">activityThisCycle</span><span class="p">();</span>
<span class="mi">600</span>     <span class="p">}</span>
<span class="mi">601</span> <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>
<p>As we’ve seen before, the tick function of each stage is the most important function
because it is executed every core clock cycle. 
The tick function consists of three important functions: sortInsts, checkSignalsAndUpdate and decode</p>

<h2 id="sortinsts"><span class="me-2">sortInsts</span><a href="#sortinsts" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<p>At the end of the decode stage, it pushes the fetched instructions to the 
toDecode register buffers. Therefore, the decode stage should fetch those instructions
from the same register located in between the fetch and decode stage.</p>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="mi">483</span> <span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">Impl</span><span class="p">&gt;</span>
<span class="mi">484</span> <span class="kt">void</span>
<span class="mi">485</span> <span class="n">DefaultDecode</span><span class="o">&lt;</span><span class="n">Impl</span><span class="o">&gt;::</span><span class="n">sortInsts</span><span class="p">()</span>
<span class="mi">486</span> <span class="p">{</span>
<span class="mi">487</span>     <span class="kt">int</span> <span class="n">insts_from_fetch</span> <span class="o">=</span> <span class="n">fromFetch</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
<span class="mi">488</span>     <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">insts_from_fetch</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">489</span>         <span class="n">insts</span><span class="p">[</span><span class="n">fromFetch</span><span class="o">-&gt;</span><span class="n">insts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">threadNumber</span><span class="p">].</span><span class="n">push</span><span class="p">(</span><span class="n">fromFetch</span><span class="o">-&gt;</span><span class="n">insts</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="mi">490</span>     <span class="p">}</span>
<span class="mi">491</span> <span class="p">}</span>   
</pre></td></tr></tbody></table></code></div></div>

<p>The sortInsts extracts the instructions 
stored in the register (<strong>fromFetch</strong>) and 
save them in the local instruction buffer (<strong>insts</strong>). 
Note that the register changes every tick, 
so each stage should copy and paste the register data
to its local memory to process.</p>

<h2 id="checksignalsandupdate"><span class="me-2">checkSignalsAndUpdate</span><a href="#checksignalsandupdate" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre></td><td class="rouge-code"><pre><span class="mi">507</span> <span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">Impl</span><span class="p">&gt;</span>
<span class="mi">508</span> <span class="kt">bool</span>
<span class="mi">509</span> <span class="n">DefaultDecode</span><span class="o">&lt;</span><span class="n">Impl</span><span class="o">&gt;::</span><span class="n">checkSignalsAndUpdate</span><span class="p">(</span><span class="n">ThreadID</span> <span class="n">tid</span><span class="p">)</span>
<span class="mi">510</span> <span class="p">{</span>
<span class="mi">511</span>     <span class="c1">// Check if there's a squash signal, squash if there is.</span>
<span class="mi">512</span>     <span class="c1">// Check stall signals, block if necessary.</span>
<span class="mi">513</span>     <span class="c1">// If status was blocked</span>
<span class="mi">514</span>     <span class="c1">//     Check if stall conditions have passed</span>
<span class="mi">515</span>     <span class="c1">//         if so then go to unblocking</span>
<span class="mi">516</span>     <span class="c1">// If status was Squashing</span>
<span class="mi">517</span>     <span class="c1">//     check if squashing is not high.  Switch to running this cycle.</span>
<span class="mi">518</span>
<span class="mi">519</span>     <span class="c1">// Update the per thread stall statuses.</span>
<span class="mi">520</span>     <span class="n">readStallSignals</span><span class="p">(</span><span class="n">tid</span><span class="p">);</span>
<span class="mi">521</span>
<span class="mi">522</span>     <span class="c1">// Check squash signals from commit.</span>
<span class="mi">523</span>     <span class="k">if</span> <span class="p">(</span><span class="n">fromCommit</span><span class="o">-&gt;</span><span class="n">commitInfo</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">squash</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">524</span>
<span class="mi">525</span>         <span class="n">DPRINTF</span><span class="p">(</span><span class="n">Decode</span><span class="p">,</span> <span class="s">"[tid:%i] Squashing instructions due to squash "</span>
<span class="mi">526</span>                 <span class="s">"from commit.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
<span class="mi">527</span>
<span class="mi">528</span>         <span class="n">squash</span><span class="p">(</span><span class="n">tid</span><span class="p">);</span>
<span class="mi">529</span>
<span class="mi">530</span>         <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="mi">531</span>     <span class="p">}</span>
<span class="mi">532</span>
<span class="mi">533</span>     <span class="nf">if</span> <span class="p">(</span><span class="n">checkStall</span><span class="p">(</span><span class="n">tid</span><span class="p">))</span> <span class="p">{</span>
<span class="mi">534</span>         <span class="k">return</span> <span class="n">block</span><span class="p">(</span><span class="n">tid</span><span class="p">);</span>
<span class="mi">535</span>     <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>
<p>Before executing the decode function, 
it should first check 
whether the other stages has sent a signal to stall.</p>

<h3 id="readstallsignals"><span class="me-2">readStallSignals</span><a href="#readstallsignals" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="mi">493</span> <span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">Impl</span><span class="p">&gt;</span>
<span class="mi">494</span> <span class="kt">void</span>
<span class="mi">495</span> <span class="n">DefaultDecode</span><span class="o">&lt;</span><span class="n">Impl</span><span class="o">&gt;::</span><span class="n">readStallSignals</span><span class="p">(</span><span class="n">ThreadID</span> <span class="n">tid</span><span class="p">)</span>
<span class="mi">496</span> <span class="p">{</span>
<span class="mi">497</span>     <span class="k">if</span> <span class="p">(</span><span class="n">fromRename</span><span class="o">-&gt;</span><span class="n">renameBlock</span><span class="p">[</span><span class="n">tid</span><span class="p">])</span> <span class="p">{</span>
<span class="mi">498</span>         <span class="n">stalls</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">rename</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="mi">499</span>     <span class="p">}</span>
<span class="mi">500</span> 
<span class="mi">501</span>     <span class="nf">if</span> <span class="p">(</span><span class="n">fromRename</span><span class="o">-&gt;</span><span class="n">renameUnblock</span><span class="p">[</span><span class="n">tid</span><span class="p">])</span> <span class="p">{</span>
<span class="mi">502</span>         <span class="n">assert</span><span class="p">(</span><span class="n">stalls</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">rename</span><span class="p">);</span>
<span class="mi">503</span>         <span class="n">stalls</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">rename</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="mi">504</span>     <span class="p">}</span>
<span class="mi">505</span> <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>
<p>Rename stage can send two signals to the decode stage, 
block signal and unblock signal through the fromRename wire.
Based on the signal sent from the rename stage, 
it sets or unset an associated entry of the member field stalls.</p>

<h3 id="when-stall-just-block-the-decode-and-return"><span class="me-2">When stall, just block the decode and return</span><a href="#when-stall-just-block-the-decode-and-return" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="mi">234</span> <span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">Impl</span><span class="p">&gt;</span>
<span class="mi">235</span> <span class="kt">bool</span>
<span class="mi">236</span> <span class="n">DefaultDecode</span><span class="o">&lt;</span><span class="n">Impl</span><span class="o">&gt;::</span><span class="n">checkStall</span><span class="p">(</span><span class="n">ThreadID</span> <span class="n">tid</span><span class="p">)</span> <span class="k">const</span>
<span class="mi">237</span> <span class="p">{</span>
<span class="mi">238</span>     <span class="kt">bool</span> <span class="n">ret_val</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="mi">239</span> 
<span class="mi">240</span>     <span class="k">if</span> <span class="p">(</span><span class="n">stalls</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">rename</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">241</span>         <span class="n">DPRINTF</span><span class="p">(</span><span class="n">Decode</span><span class="p">,</span><span class="s">"[tid:%i] Stall fom Rename stage detected.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
<span class="mi">242</span>         <span class="n">ret_val</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="mi">243</span>     <span class="p">}</span>
<span class="mi">244</span> 
<span class="mi">245</span>     <span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
<span class="mi">246</span> <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>When the decode stage has received the stall signal, 
it returns true, 
which results in invoking block function and 
returning is result.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre></td><td class="rouge-code"><pre><span class="mi">255</span> <span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">Impl</span><span class="p">&gt;</span>
<span class="mi">256</span> <span class="kt">bool</span>
<span class="mi">257</span> <span class="n">DefaultDecode</span><span class="o">&lt;</span><span class="n">Impl</span><span class="o">&gt;::</span><span class="n">block</span><span class="p">(</span><span class="n">ThreadID</span> <span class="n">tid</span><span class="p">)</span>
<span class="mi">258</span> <span class="p">{</span>
<span class="mi">259</span>     <span class="n">DPRINTF</span><span class="p">(</span><span class="n">Decode</span><span class="p">,</span> <span class="s">"[tid:%i] Blocking.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
<span class="mi">260</span> 
<span class="mi">261</span>     <span class="c1">// Add the current inputs to the skid buffer so they can be</span>
<span class="mi">262</span>     <span class="c1">// reprocessed when this stage unblocks.</span>
<span class="mi">263</span>     <span class="n">skidInsert</span><span class="p">(</span><span class="n">tid</span><span class="p">);</span>
<span class="mi">264</span> 
<span class="mi">265</span>     <span class="c1">// If the decode status is blocked or unblocking then decode has not yet</span>
<span class="mi">266</span>     <span class="c1">// signalled fetch to unblock. In that case, there is no need to tell</span>
<span class="mi">267</span>     <span class="c1">// fetch to block.</span>
<span class="mi">268</span>     <span class="k">if</span> <span class="p">(</span><span class="n">decodeStatus</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">!=</span> <span class="n">Blocked</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">269</span>         <span class="c1">// Set the status to Blocked.</span>
<span class="mi">270</span>         <span class="n">decodeStatus</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">=</span> <span class="n">Blocked</span><span class="p">;</span>
<span class="mi">271</span> 
<span class="mi">272</span>         <span class="k">if</span> <span class="p">(</span><span class="n">toFetch</span><span class="o">-&gt;</span><span class="n">decodeUnblock</span><span class="p">[</span><span class="n">tid</span><span class="p">])</span> <span class="p">{</span>
<span class="mi">273</span>             <span class="n">toFetch</span><span class="o">-&gt;</span><span class="n">decodeUnblock</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="mi">274</span>         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="mi">275</span>             <span class="n">toFetch</span><span class="o">-&gt;</span><span class="n">decodeBlock</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="mi">276</span>             <span class="n">wroteToTimeBuffer</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="mi">277</span>         <span class="p">}</span>
<span class="mi">278</span> 
<span class="mi">279</span>         <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="mi">280</span>     <span class="p">}</span>
<span class="mi">281</span> 
<span class="mi">282</span>     <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="mi">283</span> <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>When the decode stage has instruction to be processed
delivered from the fetch stage,
it needs to be maintained in the skid buffer 
so that they can be reprocessed 
when the decode stage is unblocked.
Note that different pipelines can still works 
even though the decode pipeline is blocked,
and the input can continuously arrive to the decode stage.</p>

<h3 id="squash-pipeline-when-the-commit-stage-sent-squash-signal"><span class="me-2">squash pipeline when the commit stage sent squash signal</span><a href="#squash-pipeline-when-the-commit-stage-sent-squash-signal" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>After reading the stall signal, it should also check 
whether the commit stage has sent a squash signal.
The decode stage can check whether it needs to squash 
by checking the fromCommit wire.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
</pre></td><td class="rouge-code"><pre><span class="mi">304</span> <span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">Impl</span><span class="p">&gt;</span>
<span class="mi">305</span> <span class="kt">void</span>
<span class="mi">306</span> <span class="n">DefaultDecode</span><span class="o">&lt;</span><span class="n">Impl</span><span class="o">&gt;::</span><span class="n">squash</span><span class="p">(</span><span class="k">const</span> <span class="n">DynInstPtr</span> <span class="o">&amp;</span><span class="n">inst</span><span class="p">,</span> <span class="n">ThreadID</span> <span class="n">tid</span><span class="p">)</span>
<span class="mi">307</span> <span class="p">{</span>
<span class="mi">308</span>     <span class="n">DPRINTF</span><span class="p">(</span><span class="n">Decode</span><span class="p">,</span> <span class="s">"[tid:%i] [sn:%llu] Squashing due to incorrect branch "</span>
<span class="mi">309</span>             <span class="s">"prediction detected at decode.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span> <span class="n">inst</span><span class="o">-&gt;</span><span class="n">seqNum</span><span class="p">);</span>
<span class="mi">310</span>
<span class="mi">311</span>     <span class="c1">// Send back mispredict information.</span>
<span class="mi">312</span>     <span class="n">toFetch</span><span class="o">-&gt;</span><span class="n">decodeInfo</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">branchMispredict</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="mi">313</span>     <span class="n">toFetch</span><span class="o">-&gt;</span><span class="n">decodeInfo</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">predIncorrect</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="mi">314</span>     <span class="n">toFetch</span><span class="o">-&gt;</span><span class="n">decodeInfo</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">mispredictInst</span> <span class="o">=</span> <span class="n">inst</span><span class="p">;</span>
<span class="mi">315</span>     <span class="n">toFetch</span><span class="o">-&gt;</span><span class="n">decodeInfo</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">squash</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="mi">316</span>     <span class="n">toFetch</span><span class="o">-&gt;</span><span class="n">decodeInfo</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">doneSeqNum</span> <span class="o">=</span> <span class="n">inst</span><span class="o">-&gt;</span><span class="n">seqNum</span><span class="p">;</span>
<span class="mi">317</span>     <span class="n">toFetch</span><span class="o">-&gt;</span><span class="n">decodeInfo</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">nextPC</span> <span class="o">=</span> <span class="n">inst</span><span class="o">-&gt;</span><span class="n">branchTarget</span><span class="p">();</span>
<span class="mi">318</span>     <span class="n">toFetch</span><span class="o">-&gt;</span><span class="n">decodeInfo</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">branchTaken</span> <span class="o">=</span> <span class="n">inst</span><span class="o">-&gt;</span><span class="n">pcState</span><span class="p">().</span><span class="n">branching</span><span class="p">();</span>
<span class="mi">319</span>     <span class="n">toFetch</span><span class="o">-&gt;</span><span class="n">decodeInfo</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">squashInst</span> <span class="o">=</span> <span class="n">inst</span><span class="p">;</span>
<span class="mi">320</span>     <span class="k">if</span> <span class="p">(</span><span class="n">toFetch</span><span class="o">-&gt;</span><span class="n">decodeInfo</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">mispredictInst</span><span class="o">-&gt;</span><span class="n">isUncondCtrl</span><span class="p">())</span> <span class="p">{</span>
<span class="mi">321</span>             <span class="n">toFetch</span><span class="o">-&gt;</span><span class="n">decodeInfo</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">branchTaken</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="mi">322</span>     <span class="p">}</span>
<span class="mi">323</span>
<span class="mi">324</span>     <span class="n">InstSeqNum</span> <span class="n">squash_seq_num</span> <span class="o">=</span> <span class="n">inst</span><span class="o">-&gt;</span><span class="n">seqNum</span><span class="p">;</span>
<span class="mi">325</span>
<span class="mi">326</span>     <span class="c1">// Might have to tell fetch to unblock.</span>
<span class="mi">327</span>     <span class="nf">if</span> <span class="p">(</span><span class="n">decodeStatus</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">==</span> <span class="n">Blocked</span> <span class="o">||</span>
<span class="mi">328</span>         <span class="n">decodeStatus</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">==</span> <span class="n">Unblocking</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">329</span>         <span class="n">toFetch</span><span class="o">-&gt;</span><span class="n">decodeUnblock</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="mi">330</span>     <span class="p">}</span>
<span class="mi">331</span>
<span class="mi">332</span>     <span class="c1">// Set status to squashing.</span>
<span class="mi">333</span>     <span class="n">decodeStatus</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">=</span> <span class="n">Squashing</span><span class="p">;</span>
<span class="mi">334</span>
<span class="mi">335</span>     <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">fromFetch</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">336</span>         <span class="k">if</span> <span class="p">(</span><span class="n">fromFetch</span><span class="o">-&gt;</span><span class="n">insts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">threadNumber</span> <span class="o">==</span> <span class="n">tid</span> <span class="o">&amp;&amp;</span>
<span class="mi">337</span>             <span class="n">fromFetch</span><span class="o">-&gt;</span><span class="n">insts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">seqNum</span> <span class="o">&gt;</span> <span class="n">squash_seq_num</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">338</span>             <span class="n">fromFetch</span><span class="o">-&gt;</span><span class="n">insts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">setSquashed</span><span class="p">();</span>
<span class="mi">339</span>         <span class="p">}</span>
<span class="mi">340</span>     <span class="p">}</span>
<span class="mi">341</span>
<span class="mi">342</span>     <span class="c1">// Clear the instruction list and skid buffer in case they have any</span>
<span class="mi">343</span>     <span class="c1">// insts in them.</span>
<span class="mi">344</span>     <span class="nf">while</span> <span class="p">(</span><span class="o">!</span><span class="n">insts</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
<span class="mi">345</span>         <span class="n">insts</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">pop</span><span class="p">();</span>
<span class="mi">346</span>     <span class="p">}</span>
<span class="mi">347</span>
<span class="mi">348</span>     <span class="nf">while</span> <span class="p">(</span><span class="o">!</span><span class="n">skidBuffer</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
<span class="mi">349</span>         <span class="n">skidBuffer</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">pop</span><span class="p">();</span>
<span class="mi">350</span>     <span class="p">}</span>
<span class="mi">351</span>
<span class="mi">352</span>     <span class="c1">// Squash instructions up until this one</span>
<span class="mi">353</span>     <span class="n">cpu</span><span class="o">-&gt;</span><span class="n">removeInstsUntil</span><span class="p">(</span><span class="n">squash_seq_num</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
<span class="mi">354</span> <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Note that squash signal incurs complex operations compared to stalls.
When the stall signal is received, 
the decode stage just waits until 
the stall signal is removed, receiving the unblock signal. 
However, when the stall signal is received, 
it should clear out the pipeline and associated data structures.</p>

<h3 id="when-the-decode-stage-finishes-blocking-and-squashing-operation"><span class="me-2">When the decode stage finishes blocking and squashing operation</span><a href="#when-the-decode-stage-finishes-blocking-and-squashing-operation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre></td><td class="rouge-code"><pre><span class="mi">508</span> <span class="kt">bool</span>
<span class="mi">509</span> <span class="n">DefaultDecode</span><span class="o">&lt;</span><span class="n">Impl</span><span class="o">&gt;::</span><span class="n">checkSignalsAndUpdate</span><span class="p">(</span><span class="n">ThreadID</span> <span class="n">tid</span><span class="p">)</span>
<span class="mi">510</span> <span class="p">{</span>
<span class="p">......</span>
<span class="mi">537</span>     <span class="k">if</span> <span class="p">(</span><span class="n">decodeStatus</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">==</span> <span class="n">Blocked</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">538</span>         <span class="n">DPRINTF</span><span class="p">(</span><span class="n">Decode</span><span class="p">,</span> <span class="s">"[tid:%i] Done blocking, switching to unblocking.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
<span class="mi">539</span>                 <span class="n">tid</span><span class="p">);</span>
<span class="mi">540</span>
<span class="mi">541</span>         <span class="n">decodeStatus</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">=</span> <span class="n">Unblocking</span><span class="p">;</span>
<span class="mi">542</span>
<span class="mi">543</span>         <span class="n">unblock</span><span class="p">(</span><span class="n">tid</span><span class="p">);</span>
<span class="mi">544</span>
<span class="mi">545</span>         <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="mi">546</span>     <span class="p">}</span>
<span class="mi">547</span>
<span class="mi">548</span>     <span class="nf">if</span> <span class="p">(</span><span class="n">decodeStatus</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">==</span> <span class="n">Squashing</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">549</span>         <span class="c1">// Switch status to running if decode isn't being told to block or</span>
<span class="mi">550</span>         <span class="c1">// squash this cycle.</span>
<span class="mi">551</span>         <span class="n">DPRINTF</span><span class="p">(</span><span class="n">Decode</span><span class="p">,</span> <span class="s">"[tid:%i] Done squashing, switching to running.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
<span class="mi">552</span>                 <span class="n">tid</span><span class="p">);</span>
<span class="mi">553</span>
<span class="mi">554</span>         <span class="n">decodeStatus</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">=</span> <span class="n">Running</span><span class="p">;</span>
<span class="mi">555</span>
<span class="mi">556</span>         <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="mi">557</span>     <span class="p">}</span>
<span class="mi">558</span>
<span class="mi">559</span>     <span class="c1">// If we've reached this point, we have not gotten any signals that</span>
<span class="mi">560</span>     <span class="c1">// cause decode to change its status.  Decode remains the same as before.</span>
<span class="mi">561</span>     <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="mi">562</span> <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>After the decode stage is recovered from the stall or squashing. 
it needs to change the block or stall state 
to the Running state so that it can
receive the instructions to decode from the fetch stage. 
For the Blocked state, 
it will execute the line 537-546 
And when the squash signal is turned off from commit stage, 
it will execute the rest of the code (548-557).</p>

<h2 id="why-we-need-another-decode-even-though-we-decoded"><span class="me-2">Why we need another decode even though we decoded?</span><a href="#why-we-need-another-decode-even-though-we-decoded" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<p>It would be confusing 
because we already finished instruction decoding 
in the fetch stage. 
We already know which instructions are located 
in the fetch buffer. 
Why we need another decode function?
The decode stage does not do much, but 
it should check any PC-relative branches are correct.
Most of the decode operations are actually done 
by the decodeInsts function.</p>

<p>600 template<class Impl="">
601 void
602 DefaultDecode<Impl>::decode(bool &amp;status_change, ThreadID tid)
603 {
604     // If status is Running or idle,
605     //     call decodeInsts()
606     // If status is Unblocking,
607     //     buffer any instructions coming from fetch
608     //     continue trying to empty skid buffer
609     //     check if stall conditions have passed
610 
611     if (decodeStatus[tid] == Blocked) {
612         ++decodeBlockedCycles;
613     } else if (decodeStatus[tid] == Squashing) {
614         ++decodeSquashCycles;
615     }
616 
617     // Decode should try to decode as many instructions as its bandwidth
618     // will allow, as long as it is not currently blocked.
619     if (decodeStatus[tid] == Running ||
620         decodeStatus[tid] == Idle) {
621         DPRINTF(Decode, "[tid:%i] Not blocked, so attempting to run "
622                 "stage.\n",tid);
623 
624         decodeInsts(tid);
625     } else if (decodeStatus[tid] == Unblocking) {
626         // Make sure that the skid buffer has something in it if the
627         // status is unblocking.
628         assert(!skidsEmpty());
629 
630         // If the status was unblocking, then instructions from the skid
631         // buffer were used.  Remove those instructions and handle
632         // the rest of unblocking.
633         decodeInsts(tid);
634 
635         if (fetchInstsValid()) {
636             // Add the current inputs to the skid buffer so they can be
637             // reprocessed when this stage unblocks.
638             skidInsert(tid);
639         }
640 
641         status_change = unblock(tid) || status_change;
642     }
643 }</Impl></class></p>

<h3 id="decode-stage-check-buffers-to-retrieve-instruction-to-decode"><span class="me-2">decode stage check buffers to retrieve instruction to decode</span><a href="#decode-stage-check-buffers-to-retrieve-instruction-to-decode" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre></td><td class="rouge-code"><pre><span class="mi">645</span> <span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">Impl</span><span class="p">&gt;</span>
<span class="mi">646</span> <span class="kt">void</span>
<span class="mi">647</span> <span class="n">DefaultDecode</span><span class="o">&lt;</span><span class="n">Impl</span><span class="o">&gt;::</span><span class="n">decodeInsts</span><span class="p">(</span><span class="n">ThreadID</span> <span class="n">tid</span><span class="p">)</span>
<span class="mi">648</span> <span class="p">{</span>
<span class="mi">649</span>     <span class="c1">// Instructions can come either from the skid buffer or the list of</span>
<span class="mi">650</span>     <span class="c1">// instructions coming from fetch, depending on decode's status.</span>
<span class="mi">651</span>     <span class="kt">int</span> <span class="n">insts_available</span> <span class="o">=</span> <span class="n">decodeStatus</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">==</span> <span class="n">Unblocking</span> <span class="o">?</span>
<span class="mi">652</span>         <span class="n">skidBuffer</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">size</span><span class="p">()</span> <span class="o">:</span> <span class="n">insts</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">size</span><span class="p">();</span>
<span class="mi">653</span> 
<span class="mi">654</span>     <span class="k">if</span> <span class="p">(</span><span class="n">insts_available</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">655</span>         <span class="n">DPRINTF</span><span class="p">(</span><span class="n">Decode</span><span class="p">,</span> <span class="s">"[tid:%i] Nothing to do, breaking out"</span>
<span class="mi">656</span>                 <span class="s">" early.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="n">tid</span><span class="p">);</span>
<span class="mi">657</span>         <span class="c1">// Should I change the status to idle?</span>
<span class="mi">658</span>         <span class="o">++</span><span class="n">decodeIdleCycles</span><span class="p">;</span>
<span class="mi">659</span>         <span class="k">return</span><span class="p">;</span>
<span class="mi">660</span>     <span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">decodeStatus</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">==</span> <span class="n">Unblocking</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">661</span>         <span class="n">DPRINTF</span><span class="p">(</span><span class="n">Decode</span><span class="p">,</span> <span class="s">"[tid:%i] Unblocking, removing insts from skid "</span>
<span class="mi">662</span>                 <span class="s">"buffer.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="n">tid</span><span class="p">);</span>
<span class="mi">663</span>         <span class="o">++</span><span class="n">decodeUnblockCycles</span><span class="p">;</span>
<span class="mi">664</span>     <span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">decodeStatus</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">==</span> <span class="n">Running</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">665</span>         <span class="o">++</span><span class="n">decodeRunCycles</span><span class="p">;</span>
<span class="mi">666</span>     <span class="p">}</span>
<span class="mi">667</span> 
<span class="mi">668</span>     <span class="n">std</span><span class="o">::</span><span class="n">queue</span><span class="o">&lt;</span><span class="n">DynInstPtr</span><span class="o">&gt;</span>
<span class="mi">669</span>         <span class="o">&amp;</span><span class="n">insts_to_decode</span> <span class="o">=</span> <span class="n">decodeStatus</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">==</span> <span class="n">Unblocking</span> <span class="o">?</span>
<span class="mi">670</span>         <span class="n">skidBuffer</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">:</span> <span class="n">insts</span><span class="p">[</span><span class="n">tid</span><span class="p">];</span>
<span class="mi">671</span> 
<span class="mi">672</span>     <span class="nf">DPRINTF</span><span class="p">(</span><span class="n">Decode</span><span class="p">,</span> <span class="s">"[tid:%i] Sending instruction to rename.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="n">tid</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Note that the decodeInsts can be invoked
in two different state of the decode stage. 
The Running and Unblocking. 
Running status means that decode stage 
continuously receive the packet from the fetch stage.
However, the Unblocking stage means that 
it was blocked and was recovering,
which means the packets are still in the skidBuffer.
Therefore, 
it should decode instructions
stacked in the skidBuffer
while it has been blocked.</p>

<h3 id="forwarding-decoded-instructions-to-rename-stage"><span class="me-2">forwarding decoded instructions to rename stage</span><a href="#forwarding-decoded-instructions-to-rename-stage" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="mi">185</span> <span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">Impl</span><span class="p">&gt;</span>
<span class="mi">186</span> <span class="kt">void</span>
<span class="mi">187</span> <span class="n">DefaultDecode</span><span class="o">&lt;</span><span class="n">Impl</span><span class="o">&gt;::</span><span class="n">setDecodeQueue</span><span class="p">(</span><span class="n">TimeBuffer</span><span class="o">&lt;</span><span class="n">DecodeStruct</span><span class="o">&gt;</span> <span class="o">*</span><span class="n">dq_ptr</span><span class="p">)</span>
<span class="mi">188</span> <span class="p">{</span>
<span class="mi">189</span>     <span class="n">decodeQueue</span> <span class="o">=</span> <span class="n">dq_ptr</span><span class="p">;</span>
<span class="mi">190</span> 
<span class="mi">191</span>     <span class="c1">// Setup wire to write information to proper place in decode queue.</span>
<span class="mi">192</span>     <span class="n">toRename</span> <span class="o">=</span> <span class="n">decodeQueue</span><span class="o">-&gt;</span><span class="n">getWire</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="mi">193</span> <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Similar to the toDecode wire in the fetch stage, 
decode stage needs a wire 
to send the decoded instructions to another register 
connected with the rename stage. 
For that purpose, it declares toRename wire.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
</pre></td><td class="rouge-code"><pre><span class="mi">674</span>     <span class="nf">while</span> <span class="p">(</span><span class="n">insts_available</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">toRenameIndex</span> <span class="o">&lt;</span> <span class="n">decodeWidth</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">675</span>         <span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">insts_to_decode</span><span class="p">.</span><span class="n">empty</span><span class="p">());</span>
<span class="mi">676</span> 
<span class="mi">677</span>         <span class="n">DynInstPtr</span> <span class="n">inst</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">insts_to_decode</span><span class="p">.</span><span class="n">front</span><span class="p">());</span>
<span class="mi">678</span> 
<span class="mi">679</span>         <span class="n">insts_to_decode</span><span class="p">.</span><span class="n">pop</span><span class="p">();</span>
<span class="mi">680</span> 
<span class="mi">681</span>         <span class="n">DPRINTF</span><span class="p">(</span><span class="n">Decode</span><span class="p">,</span> <span class="s">"[tid:%i] Processing instruction [sn:%lli] with "</span>
<span class="mi">682</span>                 <span class="s">"PC %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span> <span class="n">inst</span><span class="o">-&gt;</span><span class="n">seqNum</span><span class="p">,</span> <span class="n">inst</span><span class="o">-&gt;</span><span class="n">pcState</span><span class="p">());</span>
<span class="mi">683</span> 
<span class="mi">684</span>         <span class="k">if</span> <span class="p">(</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">isSquashed</span><span class="p">())</span> <span class="p">{</span>
<span class="mi">685</span>             <span class="n">DPRINTF</span><span class="p">(</span><span class="n">Decode</span><span class="p">,</span> <span class="s">"[tid:%i] Instruction %i with PC %s is "</span>
<span class="mi">686</span>                     <span class="s">"squashed, skipping.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
<span class="mi">687</span>                     <span class="n">tid</span><span class="p">,</span> <span class="n">inst</span><span class="o">-&gt;</span><span class="n">seqNum</span><span class="p">,</span> <span class="n">inst</span><span class="o">-&gt;</span><span class="n">pcState</span><span class="p">());</span>
<span class="mi">688</span>             
<span class="mi">689</span>             <span class="o">++</span><span class="n">decodeSquashedInsts</span><span class="p">;</span>
<span class="mi">690</span>             
<span class="mi">691</span>             <span class="o">--</span><span class="n">insts_available</span><span class="p">;</span>
<span class="mi">692</span>             
<span class="mi">693</span>             <span class="k">continue</span><span class="p">;</span>
<span class="mi">694</span>         <span class="p">}</span>
<span class="mi">695</span> 
<span class="mi">696</span>         <span class="c1">// Also check if instructions have no source registers.  Mark</span>
<span class="mi">697</span>         <span class="c1">// them as ready to issue at any time.  Not sure if this check</span>
<span class="mi">698</span>         <span class="c1">// should exist here or at a later stage; however it doesn't matter</span>
<span class="mi">699</span>         <span class="c1">// too much for function correctness.</span>
<span class="mi">700</span>         <span class="nf">if</span> <span class="p">(</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">numSrcRegs</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">701</span>             <span class="n">inst</span><span class="o">-&gt;</span><span class="n">setCanIssue</span><span class="p">();</span>
<span class="mi">702</span>         <span class="p">}</span>
<span class="mi">703</span> 
<span class="mi">704</span>         <span class="c1">// This current instruction is valid, so add it into the decode</span>
<span class="mi">705</span>         <span class="c1">// queue.  The next instruction may not be valid, so check to</span>
<span class="mi">706</span>         <span class="c1">// see if branches were predicted correctly.</span>
<span class="mi">707</span>         <span class="n">toRename</span><span class="o">-&gt;</span><span class="n">insts</span><span class="p">[</span><span class="n">toRenameIndex</span><span class="p">]</span> <span class="o">=</span> <span class="n">inst</span><span class="p">;</span>
<span class="mi">708</span> 
<span class="mi">709</span>         <span class="o">++</span><span class="p">(</span><span class="n">toRename</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
<span class="mi">710</span>         <span class="o">++</span><span class="n">toRenameIndex</span><span class="p">;</span>
<span class="mi">711</span>         <span class="o">++</span><span class="n">decodeDecodedInsts</span><span class="p">;</span>
<span class="mi">712</span>         <span class="o">--</span><span class="n">insts_available</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></div></div>

<p>The while loop selects one instruction from the buffer 
and sends it to the rename stage
through the toRename wire.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
</pre></td><td class="rouge-code"><pre><span class="mi">720</span>         <span class="c1">// Ensure that if it was predicted as a branch, it really is a</span>
<span class="mi">721</span>         <span class="c1">// branch.</span>
<span class="mi">722</span>         <span class="nf">if</span> <span class="p">(</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">readPredTaken</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">isControl</span><span class="p">())</span> <span class="p">{</span>
<span class="mi">723</span>             <span class="n">panic</span><span class="p">(</span><span class="s">"Instruction predicted as a branch!"</span><span class="p">);</span>
<span class="mi">724</span> 
<span class="mi">725</span>             <span class="o">++</span><span class="n">decodeControlMispred</span><span class="p">;</span>
<span class="mi">726</span> 
<span class="mi">727</span>             <span class="c1">// Might want to set some sort of boolean and just do</span>
<span class="mi">728</span>             <span class="c1">// a check at the end</span>
<span class="mi">729</span>             <span class="n">squash</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span> <span class="n">inst</span><span class="o">-&gt;</span><span class="n">threadNumber</span><span class="p">);</span>
<span class="mi">730</span> 
<span class="mi">731</span>             <span class="k">break</span><span class="p">;</span>
<span class="mi">732</span>         <span class="p">}</span>
<span class="mi">733</span> 
<span class="mi">734</span>         <span class="c1">// Go ahead and compute any PC-relative branches.</span>
<span class="mi">735</span>         <span class="c1">// This includes direct unconditional control and</span>
<span class="mi">736</span>         <span class="c1">// direct conditional control that is predicted taken.</span>
<span class="mi">737</span>         <span class="k">if</span> <span class="p">(</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">isDirectCtrl</span><span class="p">()</span> <span class="o">&amp;&amp;</span>
<span class="mi">738</span>            <span class="p">(</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">isUncondCtrl</span><span class="p">()</span> <span class="o">||</span> <span class="n">inst</span><span class="o">-&gt;</span><span class="n">readPredTaken</span><span class="p">()))</span>
<span class="mi">739</span>         <span class="p">{</span>
<span class="mi">740</span>             <span class="o">++</span><span class="n">decodeBranchResolved</span><span class="p">;</span>
<span class="mi">741</span> 
<span class="mi">742</span>             <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">branchTarget</span><span class="p">()</span> <span class="o">==</span> <span class="n">inst</span><span class="o">-&gt;</span><span class="n">readPredTarg</span><span class="p">()))</span> <span class="p">{</span>
<span class="mi">743</span>                 <span class="o">++</span><span class="n">decodeBranchMispred</span><span class="p">;</span>
<span class="mi">744</span> 
<span class="mi">745</span>                 <span class="c1">// Might want to set some sort of boolean and just do</span>
<span class="mi">746</span>                 <span class="c1">// a check at the end</span>
<span class="mi">747</span>                 <span class="n">squash</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span> <span class="n">inst</span><span class="o">-&gt;</span><span class="n">threadNumber</span><span class="p">);</span>
<span class="mi">748</span>                 <span class="n">TheISA</span><span class="o">::</span><span class="n">PCState</span> <span class="n">target</span> <span class="o">=</span> <span class="n">inst</span><span class="o">-&gt;</span><span class="n">branchTarget</span><span class="p">();</span>
<span class="mi">749</span> 
<span class="mi">750</span>                 <span class="n">DPRINTF</span><span class="p">(</span><span class="n">Decode</span><span class="p">,</span>
<span class="mi">751</span>                         <span class="s">"[tid:%i] [sn:%llu] "</span>
<span class="mi">752</span>                         <span class="s">"Updating predictions: PredPC: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
<span class="mi">753</span>                         <span class="n">tid</span><span class="p">,</span> <span class="n">inst</span><span class="o">-&gt;</span><span class="n">seqNum</span><span class="p">,</span> <span class="n">target</span><span class="p">);</span>
<span class="mi">754</span>                 <span class="c1">//The micro pc after an instruction level branch should be 0</span>
<span class="mi">755</span>                 <span class="n">inst</span><span class="o">-&gt;</span><span class="n">setPredTarg</span><span class="p">(</span><span class="n">target</span><span class="p">);</span>
<span class="mi">756</span>                 <span class="k">break</span><span class="p">;</span>
<span class="mi">757</span>             <span class="p">}</span>
<span class="mi">758</span>         <span class="p">}</span>
<span class="mi">759</span>     <span class="p">}</span> <span class="c1">//end of the while loop</span>
</pre></td></tr></tbody></table></code></div></div>

<p>One thing to note is 
it really decodes the instruction and check 
whether the current instruction is really branch.
If it was predicted as a branch,
but turned out to be a non-branch instruction,
then it should squash the current instruction.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="mi">761</span>     <span class="c1">// If we didn't process all instructions, then we will need to block</span>
<span class="mi">762</span>     <span class="c1">// and put all those instructions into the skid buffer.</span>
<span class="mi">763</span>     <span class="nf">if</span> <span class="p">(</span><span class="o">!</span><span class="n">insts_to_decode</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
<span class="mi">764</span>         <span class="n">block</span><span class="p">(</span><span class="n">tid</span><span class="p">);</span>
<span class="mi">765</span>     <span class="p">}</span>
<span class="mi">766</span> 
<span class="mi">767</span>     <span class="c1">// Record that decode has written to the time buffer for activity</span>
<span class="mi">768</span>     <span class="c1">// tracking.</span>
<span class="mi">769</span>     <span class="nf">if</span> <span class="p">(</span><span class="n">toRenameIndex</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">770</span>         <span class="n">wroteToTimeBuffer</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="mi">771</span>     <span class="p">}</span>

</pre></td></tr></tbody></table></code></div></div>


  </div>

  <div class="post-tail-wrapper text-muted">
    <!-- categories -->
    
      <div class="post-meta mb-3">
        <i class="far fa-folder-open fa-fw me-1"></i>
        
          <a href="/categories/gem5/">GEM5</a>,
          <a href="/categories/pipeline/">Pipeline</a>,
          <a href="/categories/o3/">O3</a>
      </div>
    

    <!-- tags -->
    

    <div
      class="
        post-tail-bottom
        d-flex justify-content-between align-items-center mt-5 pb-2
      "
    >
      <div class="license-wrapper">
        
          

          This post is licensed under 
        <a href="https://creativecommons.org/licenses/by/4.0/">
          CC BY 4.0
        </a>
         by the author.
        
      </div>

      <!-- Post sharing snippet -->

<div class="share-wrapper d-flex align-items-center">
  <span class="share-label text-muted">Share</span>
  <span class="share-icons">
    
    
    

    

      

      <a
        href="https://twitter.com/intent/tweet?text=O3%20Cpu%20Decode%20-%20Ruach&url=http%3A%2F%2Flocalhost%3A4000%2Fposts%2FO3-CPU-Decode%2F"
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Twitter"
        target="_blank"
        rel="noopener"
        aria-label="Twitter"
      >
        <i class="fa-fw fa-brands fa-square-x-twitter"></i>
      </a>
    

      

      <a
        href="https://www.facebook.com/sharer/sharer.php?title=O3%20Cpu%20Decode%20-%20Ruach&u=http%3A%2F%2Flocalhost%3A4000%2Fposts%2FO3-CPU-Decode%2F"
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Facebook"
        target="_blank"
        rel="noopener"
        aria-label="Facebook"
      >
        <i class="fa-fw fab fa-facebook-square"></i>
      </a>
    

      

      <a
        href="https://t.me/share/url?url=http%3A%2F%2Flocalhost%3A4000%2Fposts%2FO3-CPU-Decode%2F&text=O3%20Cpu%20Decode%20-%20Ruach"
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Telegram"
        target="_blank"
        rel="noopener"
        aria-label="Telegram"
      >
        <i class="fa-fw fab fa-telegram"></i>
      </a>
    

      

      <a
        href="https://www.linkedin.com/sharing/share-offsite/?url=http%3A%2F%2Flocalhost%3A4000%2Fposts%2FO3-CPU-Decode%2F"
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Linkedin"
        target="_blank"
        rel="noopener"
        aria-label="Linkedin"
      >
        <i class="fa-fw fab fa-linkedin"></i>
      </a>
    

    <button
      id="copy-link"
      aria-label="Copy link"
      class="btn small"
      data-bs-toggle="tooltip"
      data-bs-placement="top"
      title="Copy link"
      data-title-succeed="Link copied successfully!"
    >
      <i class="fa-fw fas fa-link pe-none fs-6"></i>
    </button>
  </span>
</div>

    </div>
    <!-- .post-tail-bottom -->
  </div>
  <!-- div.post-tail-wrapper -->
</article>


            
          </main>

          <!-- panel -->
          <aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 mb-5 text-muted">
            <div class="access">
              <!-- Get the last 5 posts from lastmod list. -->















              <!-- The trending tags list -->


















            </div>

            
              
              



  <section id="toc-wrapper" class="ps-0 pe-4">
    <h2 class="panel-heading ps-3 pt-2 mb-2">Contents</h2>
    <nav id="toc"></nav>
  </section>


            
          </aside>
        </div>

        <div class="row">
          <!-- tail -->
          <div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4">
            
              
              <!-- Recommend the other 3 posts according to the tags and categories of the current post. -->

<!-- The total size of related posts -->


<!-- An random integer that bigger than 0 -->


<!-- Equals to TAG_SCORE / {max_categories_hierarchy} -->














  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  
    
  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  











  <aside id="related-posts" aria-labelledby="related-label">
    <h3 class="mb-4" id="related-label">Further Reading</h3>
    <nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4">
      
        <article class="col">
          <a href="/posts/O3-CPU-Fetch/" class="post-preview card h-100">
            <div class="card-body">
              <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1622088000"
  data-df="ll"
  
>
  May 27, 2021
</time>

              <h4 class="pt-0 my-2">O3 Cpu Fetch</h4>
              <div class="text-muted">
                <p>
                  





                  Fetch
 895 template &amp;lt;class Impl&amp;gt;
 896 void
 897 DefaultFetch&amp;lt;Impl&amp;gt;::tick()
 898 {
 899     list&amp;lt;ThreadID&amp;gt;::iterator threads = activeThreads-&amp;gt;begin();
 900     list&amp;lt;ThreadID&amp;...
                </p>
              </div>
            </div>
          </a>
        </article>
      
        <article class="col">
          <a href="/posts/O3-CPU-rename/" class="post-preview card h-100">
            <div class="card-body">
              <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1622260800"
  data-df="ll"
  
>
  May 29, 2021
</time>

              <h4 class="pt-0 my-2">O3 Cpu Rename</h4>
              <div class="text-muted">
                <p>
                  





                  Rename
It maintains the rename history of all instructions 
with destination registers, storing the arch register, 
the new physical register, and the old physical register.
The information is requ...
                </p>
              </div>
            </div>
          </a>
        </article>
      
        <article class="col">
          <a href="/posts/O3-CPU-iew/" class="post-preview card h-100">
            <div class="card-body">
              <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1622520000"
  data-df="ll"
  
>
  Jun  1, 2021
</time>

              <h4 class="pt-0 my-2">O3 Cpu Iew</h4>
              <div class="text-muted">
                <p>
                  





                  IEW: Issue/Execute/Writeback

  GEM5 handles both execute and writeback when the execute() 
function is called on an instruction. Therefore, GEM5 combines 
Issue, Execute, and Writeback stage into ...
                </p>
              </div>
            </div>
          </a>
        </article>
      
    </nav>
  </aside>
  <!-- #related-posts -->


            
              
              <!-- Navigation buttons at the bottom of the post. -->

<nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation">
  
  

  
    <a
      href="/posts/O3-CPU-Fetch/"
      class="btn btn-outline-primary"
      aria-label="Older"
    >
      <p>O3 Cpu Fetch</p>
    </a>
  

  
    <a
      href="/posts/O3-CPU-rename/"
      class="btn btn-outline-primary"
      aria-label="Newer"
    >
      <p>O3 Cpu Rename</p>
    </a>
  
</nav>

            
              
              <!--  The comments switcher -->


            

            <!-- The Footer -->

<footer
  aria-label="Site Info"
  class="
    d-flex flex-column justify-content-center text-muted
    flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3
  "
>
  <p>
    ©
    <time>2023</time>
    <a href="https://ruach.github.io">Jaehyuk Lee</a>.
    
      <span
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author."
      >Some rights reserved.</span>
    
  </p>

  <p>Using the <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme for <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>
  </p>
</footer>

          </div>
        </div>

        <!-- The Search results -->

<div id="search-result-wrapper" class="d-flex justify-content-center unloaded">
  <div class="col-11 content">
    <div id="search-hints">
      <!-- The trending tags list -->


















    </div>
    <div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div>
  </div>
</div>

      </div>

      <aside aria-label="Scroll to Top">
        <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow">
          <i class="fas fa-angle-up"></i>
        </button>
      </aside>
    </div>

    <div id="mask"></div>

    
      <aside
  id="notification"
  class="toast"
  role="alert"
  aria-live="assertive"
  aria-atomic="true"
  data-bs-animation="true"
  data-bs-autohide="false"
>
  <div class="toast-header">
    <button
      type="button"
      class="btn-close ms-auto"
      data-bs-dismiss="toast"
      aria-label="Close"
    ></button>
  </div>
  <div class="toast-body text-center pt-0">
    <p class="px-2 mb-3">A new version of content is available.</p>
    <button type="button" class="btn btn-primary" aria-label="Update">
      Update
    </button>
  </div>
</aside>

    

    <!-- JavaScripts -->

    <!-- JS selector for site. -->

<!-- commons -->



<!-- layout specified -->


  

  
    <!-- image lazy-loading & popup & clipboard -->
    
  















  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  



  <script src="https://cdn.jsdelivr.net/combine/npm/jquery@3.7.1/dist/jquery.min.js,npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js,npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/magnific-popup@1.1.0/dist/jquery.magnific-popup.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.10/dayjs.min.js,npm/dayjs@1.11.10/locale/en.min.js,npm/dayjs@1.11.10/plugin/relativeTime.min.js,npm/dayjs@1.11.10/plugin/localizedFormat.min.js,npm/tocbot@4.21.2/dist/tocbot.min.js"></script>






<script defer src="/assets/js/dist/post.min.js"></script>






    

    <!--
  Jekyll Simple Search loader
  See: <https://github.com/christian-fei/Simple-Jekyll-Search>
-->





<script>
  /* Note: dependent library will be loaded in `js-selector.html` */
  SimpleJekyllSearch({
    searchInput: document.getElementById('search-input'),
    resultsContainer: document.getElementById('search-results'),
    json: '/assets/js/data/search.json',
    searchResultTemplate: '  <article class="px-1 px-sm-2 px-lg-4 px-xl-0">    <header>      <h2><a href="{url}">{title}</a></h2>      <div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1">        {categories}        {tags}      </div>    </header>    <p>{snippet}</p>  </article>',
    noResultsText: '<p class="mt-5"></p>',
    templateMiddleware: function(prop, value, template) {
      if (prop === 'categories') {
        if (value === '') {
          return `${value}`;
        } else {
          return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`;
        }
      }

      if (prop === 'tags') {
        if (value === '') {
          return `${value}`;
        } else {
          return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`;
        }
      }
    }
  });
</script>

  </body>
</html>

