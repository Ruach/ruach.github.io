<!doctype html>














<!-- `site.alt_lang` can specify a language different from the UI -->
<html lang="en" data-mode="light">
  <!-- The Head -->

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta
    name="viewport"
    content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover"
  >

  

  

  
    <!-- Begin Jekyll SEO tag v2.8.0 -->
<meta name="generator" content="Jekyll v4.3.2" />
<meta property="og:title" content="O3 Cpu Rename" />
<meta property="og:locale" content="en" />
<meta name="description" content="Rename It maintains the rename history of all instructions with destination registers, storing the arch register, the new physical register, and the old physical register. The information is required to enable undoing of mappings if squashing happens, or freeing up registers upon commit. Rename stage can be blocked when the ROB, IQ, or LSQ is going to be full. Rename also handles barriers and serializing instructions by stalling them in rename until the back-end drains. It blocks the stage until the ROB is empty, and there are no instructions in flight to the ROB." />
<meta property="og:description" content="Rename It maintains the rename history of all instructions with destination registers, storing the arch register, the new physical register, and the old physical register. The information is required to enable undoing of mappings if squashing happens, or freeing up registers upon commit. Rename stage can be blocked when the ROB, IQ, or LSQ is going to be full. Rename also handles barriers and serializing instructions by stalling them in rename until the back-end drains. It blocks the stage until the ROB is empty, and there are no instructions in flight to the ROB." />
<link rel="canonical" href="http://localhost:4000/posts/O3-CPU-rename/" />
<meta property="og:url" content="http://localhost:4000/posts/O3-CPU-rename/" />
<meta property="og:site_name" content="Ruach" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-05-29T00:00:00-04:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="O3 Cpu Rename" />
<meta name="twitter:site" content="@ruach_lee" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2021-05-29T00:00:00-04:00","datePublished":"2021-05-29T00:00:00-04:00","description":"Rename It maintains the rename history of all instructions with destination registers, storing the arch register, the new physical register, and the old physical register. The information is required to enable undoing of mappings if squashing happens, or freeing up registers upon commit. Rename stage can be blocked when the ROB, IQ, or LSQ is going to be full. Rename also handles barriers and serializing instructions by stalling them in rename until the back-end drains. It blocks the stage until the ROB is empty, and there are no instructions in flight to the ROB.","headline":"O3 Cpu Rename","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/posts/O3-CPU-rename/"},"url":"http://localhost:4000/posts/O3-CPU-rename/"}</script>
<!-- End Jekyll SEO tag -->

  

  <title>O3 Cpu Rename | Ruach
  </title>

  <!--
  The Favicons for Web, Android, Microsoft, and iOS (iPhone and iPad) Apps
  Generated by: https://realfavicongenerator.net/
-->



<link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png">
<link rel="manifest" href="/assets/img/favicons/site.webmanifest">
<link rel="shortcut icon" href="/assets/img/favicons/favicon.ico">
<meta name="apple-mobile-web-app-title" content="Ruach">
<meta name="application-name" content="Ruach">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml">
<meta name="theme-color" content="#ffffff">


  
    
      <link rel="preconnect" href="https://fonts.googleapis.com" >
      <link rel="dns-prefetch" href="https://fonts.googleapis.com" >
    
      <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      <link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin>
    
      <link rel="preconnect" href="https://fonts.googleapis.com" >
      <link rel="dns-prefetch" href="https://fonts.googleapis.com" >
    
      <link rel="preconnect" href="https://cdn.jsdelivr.net" >
      <link rel="dns-prefetch" href="https://cdn.jsdelivr.net" >
    

    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap">
  

  <!-- GA -->
  

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.2/css/all.min.css">

  <link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css">

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.21.2/dist/tocbot.min.css">
  

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css">
  

  
    <!-- Manific Popup -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css">
  

  <!-- JavaScript -->

  

  <!-- A placeholder to allow defining custom metadata -->

</head>


  <body>
    <!-- The Side Bar -->

<aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end">
  <header class="profile-wrapper">
    <a href="/" id="avatar" class="rounded-circle">
      
        
        <img src="/assets/img/jaehyuk.png" width="112" height="112" alt="avatar" onerror="this.style.display='none'">
      
    </a>

    <h1 class="site-title">
      <a href="/">Ruach</a>
    </h1>
    <p class="site-subtitle fst-italic mb-0">Security Researcher at Gatech</p>
  </header>
  <!-- .profile-wrapper -->

  <nav class="flex-column flex-grow-1 w-100 ps-0">
    <ul class="nav">
      <!-- home -->
      <li class="nav-item">
        <a href="/" class="nav-link">
          <i class="fa-fw fas fa-home"></i>
          <span>HOME</span>
        </a>
      </li>
      <!-- the real tabs -->
      
        <li class="nav-item">
          <a href="/categories/" class="nav-link">
            <i class="fa-fw fas fa-stream"></i>
            

            <span>CATEGORIES</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/tags/" class="nav-link">
            <i class="fa-fw fas fa-tags"></i>
            

            <span>TAGS</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/archives/" class="nav-link">
            <i class="fa-fw fas fa-archive"></i>
            

            <span>ARCHIVES</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/about/" class="nav-link">
            <i class="fa-fw fas fa-info-circle"></i>
            

            <span>ABOUT</span>
          </a>
        </li>
        <!-- .nav-item -->
      
    </ul>
  </nav>

  <div class="sidebar-bottom d-flex flex-wrap  align-items-center w-100">
    

    
      

      
        <a
          href="javascript:location.href = 'mailto:' + ['jaehyuk','gatech.edu'].join('@')"
          aria-label="email"
          

          

          

          
        >
          <i class="fas fa-envelope"></i>
        </a>
      
    
      

      
        <a
          href="https://www.linkedin.com/in/jaehyuk-lee-29b33b121/"
          aria-label="linkedin"
          

          
            target="_blank"
            
          

          

          
            rel="noopener noreferrer"
          
        >
          <i class="fab fa-linkedin"></i>
        </a>
      
    
      

      
        <a
          href="https://github.com/Ruach"
          aria-label="github"
          

          
            target="_blank"
            
          

          

          
            rel="noopener noreferrer"
          
        >
          <i class="fab fa-github"></i>
        </a>
      
    
      

      
        <a
          href="https://stackoverflow.com/users/4460514/ruach?tab=profile"
          aria-label="stack-overflow"
          

          
            target="_blank"
            
          

          

          
            rel="noopener noreferrer"
          
        >
          <i class="fab fa-stack-overflow"></i>
        </a>
      
    
  </div>
  <!-- .sidebar-bottom -->
</aside>
<!-- #sidebar -->


    <div id="main-wrapper" class="d-flex justify-content-center">
      <div class="container d-flex flex-column px-xxl-5">
        <!-- The Top Bar -->

<header id="topbar-wrapper" aria-label="Top Bar">
  <div
    id="topbar"
    class="d-flex align-items-center justify-content-between px-lg-3 h-100"
  >
    <nav id="breadcrumb" aria-label="Breadcrumb">
      

      
        
          
            <span>
              <a href="/">
                Home
              </a>
            </span>

          
        
          
        
          
            
              <span>O3 Cpu Rename</span>
            

          
        
      
    </nav>
    <!-- endof #breadcrumb -->

    <button type="button" id="sidebar-trigger" class="btn btn-link">
      <i class="fas fa-bars fa-fw"></i>
    </button>

    <div id="topbar-title">
      Post
    </div>

    <button type="button" id="search-trigger" class="btn btn-link">
      <i class="fas fa-search fa-fw"></i>
    </button>

    <search class="align-items-center ms-3 ms-lg-0">
      <i class="fas fa-search fa-fw"></i>
      <input
        class="form-control"
        id="search-input"
        type="search"
        aria-label="search"
        autocomplete="off"
        placeholder="Search..."
      >
    </search>
    <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button>
  </div>
</header>


        <div class="row flex-grow-1">
          <main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4">
            
              <!-- Refactor the HTML structure -->



<!--
  In order to allow a wide table to scroll horizontally,
  we suround the markdown table with `<div class="table-wrapper">` and `</div>`
-->



<!--
  Fixed kramdown code highlight rendering:
  https://github.com/penibelst/jekyll-compress-html/issues/101
  https://github.com/penibelst/jekyll-compress-html/issues/71#issuecomment-188144901
-->



<!-- Change the icon of checkbox -->



<!-- Handle images -->





<!-- Add header for code snippets -->



<!-- Create heading anchors -->





  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    

    
  

  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    

    
  

  
  

  

  
  

  




<!-- return -->




<article class="px-1">
  <header>
    <h1 data-toc-skip>O3 Cpu Rename</h1>

    <div class="post-meta text-muted">
      <!-- published date -->
      <span>
        Posted
        <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1622260800"
  data-df="ll"
  
    data-bs-toggle="tooltip" data-bs-placement="bottom"
  
>
  May 29, 2021
</time>

      </span>

      <!-- lastmod date -->
      

      

      <div class="d-flex justify-content-between">
        <!-- author(s) -->
        <span>
          

          By

          <em>
            
              <a href="https://ruach.github.io">Jaehyuk Lee</a>
            
          </em>
        </span>

        <!-- read time -->
        <!-- Calculate the post's reading time, and display the word count in tooltip -->



<!-- words per minute -->










<!-- return element -->
<span
  class="readtime"
  data-bs-toggle="tooltip"
  data-bs-placement="bottom"
  title="9040 words"
>
  <em>50 min</em> read</span>

      </div>
      <!-- .d-flex -->
    </div>
    <!-- .post-meta -->
  </header>

  <div class="content">
    <h1 id="rename">Rename</h1>
<p>It maintains the rename history of all instructions 
with destination registers, storing the arch register, 
the new physical register, and the old physical register.
The information is required 
to enable undoing of mappings 
if squashing happens, or
freeing up registers upon commit. 
Rename stage can be blocked
when the ROB, IQ, or LSQ is going to be full. 
Rename also handles 
barriers and serializing instructions
by stalling them in rename until the back-end drains.
It blocks the stage until the ROB is empty,
and there are no instructions in flight to the ROB.</p>

<h3 id="interface-of-rename-stage"><span class="me-2">Interface of rename stage</span><a href="#interface-of-rename-stage" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p><strong>cpu/o3/rename_impl.hh</strong></p>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
</pre></td><td class="rouge-code"><pre> <span class="mi">214</span> <span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">Impl</span><span class="p">&gt;</span>
 <span class="mi">215</span> <span class="kt">void</span>
 <span class="mi">216</span> <span class="n">DefaultRename</span><span class="o">&lt;</span><span class="n">Impl</span><span class="o">&gt;::</span><span class="n">setTimeBuffer</span><span class="p">(</span><span class="n">TimeBuffer</span><span class="o">&lt;</span><span class="n">TimeStruct</span><span class="o">&gt;</span> <span class="o">*</span><span class="n">tb_ptr</span><span class="p">)</span>
 <span class="mi">217</span> <span class="p">{</span>
 <span class="mi">218</span>     <span class="n">timeBuffer</span> <span class="o">=</span> <span class="n">tb_ptr</span><span class="p">;</span>
 <span class="mi">219</span> 
 <span class="mi">220</span>     <span class="c1">// Setup wire to read information from time buffer, from IEW stage.</span>
 <span class="mi">221</span>     <span class="n">fromIEW</span> <span class="o">=</span> <span class="n">timeBuffer</span><span class="o">-&gt;</span><span class="n">getWire</span><span class="p">(</span><span class="o">-</span><span class="n">iewToRenameDelay</span><span class="p">);</span>
 <span class="mi">222</span> 
 <span class="mi">223</span>     <span class="c1">// Setup wire to read infromation from time buffer, from commit stage.</span>
 <span class="mi">224</span>     <span class="n">fromCommit</span> <span class="o">=</span> <span class="n">timeBuffer</span><span class="o">-&gt;</span><span class="n">getWire</span><span class="p">(</span><span class="o">-</span><span class="n">commitToRenameDelay</span><span class="p">);</span>
 <span class="mi">225</span> 
 <span class="mi">226</span>     <span class="c1">// Setup wire to write information to previous stages.</span>
 <span class="mi">227</span>     <span class="n">toDecode</span> <span class="o">=</span> <span class="n">timeBuffer</span><span class="o">-&gt;</span><span class="n">getWire</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
 <span class="mi">228</span> <span class="p">}</span>
 <span class="mi">229</span> 
 <span class="mi">230</span> <span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">Impl</span><span class="p">&gt;</span>
 <span class="mi">231</span> <span class="kt">void</span>
 <span class="mi">232</span> <span class="n">DefaultRename</span><span class="o">&lt;</span><span class="n">Impl</span><span class="o">&gt;::</span><span class="n">setRenameQueue</span><span class="p">(</span><span class="n">TimeBuffer</span><span class="o">&lt;</span><span class="n">RenameStruct</span><span class="o">&gt;</span> <span class="o">*</span><span class="n">rq_ptr</span><span class="p">)</span>
 <span class="mi">233</span> <span class="p">{</span>
 <span class="mi">234</span>     <span class="n">renameQueue</span> <span class="o">=</span> <span class="n">rq_ptr</span><span class="p">;</span>
 <span class="mi">235</span> 
 <span class="mi">236</span>     <span class="c1">// Setup wire to write information to future stages.</span>
 <span class="mi">237</span>     <span class="n">toIEW</span> <span class="o">=</span> <span class="n">renameQueue</span><span class="o">-&gt;</span><span class="n">getWire</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
 <span class="mi">238</span> <span class="p">}</span>
 <span class="mi">239</span> 
 <span class="mi">240</span> <span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">Impl</span><span class="p">&gt;</span>
 <span class="mi">241</span> <span class="kt">void</span>
 <span class="mi">242</span> <span class="n">DefaultRename</span><span class="o">&lt;</span><span class="n">Impl</span><span class="o">&gt;::</span><span class="n">setDecodeQueue</span><span class="p">(</span><span class="n">TimeBuffer</span><span class="o">&lt;</span><span class="n">DecodeStruct</span><span class="o">&gt;</span> <span class="o">*</span><span class="n">dq_ptr</span><span class="p">)</span>
 <span class="mi">243</span> <span class="p">{</span>
 <span class="mi">244</span>     <span class="n">decodeQueue</span> <span class="o">=</span> <span class="n">dq_ptr</span><span class="p">;</span>
 <span class="mi">245</span> 
 <span class="mi">246</span>     <span class="c1">// Setup wire to get information from decode.</span>
 <span class="mi">247</span>     <span class="n">fromDecode</span> <span class="o">=</span> <span class="n">decodeQueue</span><span class="o">-&gt;</span><span class="n">getWire</span><span class="p">(</span><span class="o">-</span><span class="n">decodeToRenameDelay</span><span class="p">);</span>
 <span class="mi">248</span> <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>
<p>Mainly, there are three interfaces connected to the rename stage.
First of all, 
to deliver the information processed by the rename stage
to the IEW stage, it has toIEW wire. 
Also, to read some information from two other stages, decode and commit,
it sets up fromDecode and fromCommit wires.</p>

<h2 id="tick-function-of-the-rename-stage"><span class="me-2">Tick function of the rename stage</span><a href="#tick-function-of-the-rename-stage" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
</pre></td><td class="rouge-code"><pre> <span class="mi">427</span> <span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">Impl</span><span class="p">&gt;</span>
 <span class="mi">428</span> <span class="kt">void</span>
 <span class="mi">429</span> <span class="n">DefaultRename</span><span class="o">&lt;</span><span class="n">Impl</span><span class="o">&gt;::</span><span class="n">tick</span><span class="p">()</span>
 <span class="mi">430</span> <span class="p">{</span>
 <span class="mi">431</span>     <span class="n">wroteToTimeBuffer</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
 <span class="mi">432</span> 
 <span class="mi">433</span>     <span class="n">blockThisCycle</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
 <span class="mi">434</span> 
 <span class="mi">435</span>     <span class="kt">bool</span> <span class="n">status_change</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
 <span class="mi">436</span> 
 <span class="mi">437</span>     <span class="n">toIEWIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
 <span class="mi">438</span> 
 <span class="mi">439</span>     <span class="n">sortInsts</span><span class="p">();</span>
 <span class="mi">440</span> 
 <span class="mi">441</span>     <span class="n">list</span><span class="o">&lt;</span><span class="n">ThreadID</span><span class="o">&gt;::</span><span class="n">iterator</span> <span class="n">threads</span> <span class="o">=</span> <span class="n">activeThreads</span><span class="o">-&gt;</span><span class="n">begin</span><span class="p">();</span>
 <span class="mi">442</span>     <span class="n">list</span><span class="o">&lt;</span><span class="n">ThreadID</span><span class="o">&gt;::</span><span class="n">iterator</span> <span class="n">end</span> <span class="o">=</span> <span class="n">activeThreads</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">();</span>
 <span class="mi">443</span> 
 <span class="mi">444</span>     <span class="c1">// Check stall and squash signals.</span>
 <span class="mi">445</span>     <span class="k">while</span> <span class="p">(</span><span class="n">threads</span> <span class="o">!=</span> <span class="n">end</span><span class="p">)</span> <span class="p">{</span>
 <span class="mi">446</span>         <span class="n">ThreadID</span> <span class="n">tid</span> <span class="o">=</span> <span class="o">*</span><span class="n">threads</span><span class="o">++</span><span class="p">;</span>
 <span class="mi">447</span> 
 <span class="mi">448</span>         <span class="n">DPRINTF</span><span class="p">(</span><span class="n">Rename</span><span class="p">,</span> <span class="s">"Processing [tid:%i]</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
 <span class="mi">449</span> 
 <span class="mi">450</span>         <span class="n">status_change</span> <span class="o">=</span> <span class="n">checkSignalsAndUpdate</span><span class="p">(</span><span class="n">tid</span><span class="p">)</span> <span class="o">||</span> <span class="n">status_change</span><span class="p">;</span>
 <span class="mi">451</span> 
 <span class="mi">452</span>         <span class="n">rename</span><span class="p">(</span><span class="n">status_change</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
 <span class="mi">453</span>     <span class="p">}</span>
 <span class="mi">454</span> 
 <span class="mi">455</span>     <span class="nf">if</span> <span class="p">(</span><span class="n">status_change</span><span class="p">)</span> <span class="p">{</span>
 <span class="mi">456</span>         <span class="n">updateStatus</span><span class="p">();</span>
 <span class="mi">457</span>     <span class="p">}</span>
 <span class="mi">458</span> 
 <span class="mi">459</span>     <span class="nf">if</span> <span class="p">(</span><span class="n">wroteToTimeBuffer</span><span class="p">)</span> <span class="p">{</span>
 <span class="mi">460</span>         <span class="n">DPRINTF</span><span class="p">(</span><span class="n">Activity</span><span class="p">,</span> <span class="s">"Activity this cycle.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
 <span class="mi">461</span>         <span class="n">cpu</span><span class="o">-&gt;</span><span class="n">activityThisCycle</span><span class="p">();</span>
 <span class="mi">462</span>     <span class="p">}</span>
 <span class="mi">463</span> 
 <span class="mi">464</span>     <span class="n">threads</span> <span class="o">=</span> <span class="n">activeThreads</span><span class="o">-&gt;</span><span class="n">begin</span><span class="p">();</span>
 <span class="mi">465</span> 
 <span class="mi">466</span>     <span class="nf">while</span> <span class="p">(</span><span class="n">threads</span> <span class="o">!=</span> <span class="n">end</span><span class="p">)</span> <span class="p">{</span>
 <span class="mi">467</span>         <span class="n">ThreadID</span> <span class="n">tid</span> <span class="o">=</span> <span class="o">*</span><span class="n">threads</span><span class="o">++</span><span class="p">;</span>
 <span class="mi">468</span> 
 <span class="mi">469</span>         <span class="c1">// If we committed this cycle then doneSeqNum will be &gt; 0</span>
 <span class="mi">470</span>         <span class="k">if</span> <span class="p">(</span><span class="n">fromCommit</span><span class="o">-&gt;</span><span class="n">commitInfo</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">doneSeqNum</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
 <span class="mi">471</span>             <span class="o">!</span><span class="n">fromCommit</span><span class="o">-&gt;</span><span class="n">commitInfo</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">squash</span> <span class="o">&amp;&amp;</span>
 <span class="mi">472</span>             <span class="n">renameStatus</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">!=</span> <span class="n">Squashing</span><span class="p">)</span> <span class="p">{</span>
 <span class="mi">473</span> 
 <span class="mi">474</span>             <span class="n">removeFromHistory</span><span class="p">(</span><span class="n">fromCommit</span><span class="o">-&gt;</span><span class="n">commitInfo</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">doneSeqNum</span><span class="p">,</span>
 <span class="mi">475</span>                                   <span class="n">tid</span><span class="p">);</span>
 <span class="mi">476</span>         <span class="p">}</span>
 <span class="mi">477</span>     <span class="p">}</span>
 <span class="mi">478</span> 
 <span class="mi">479</span>     <span class="c1">// @todo: make into updateProgress function</span>
 <span class="mi">480</span>     <span class="k">for</span> <span class="p">(</span><span class="n">ThreadID</span> <span class="n">tid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">tid</span> <span class="o">&lt;</span> <span class="n">numThreads</span><span class="p">;</span> <span class="n">tid</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
 <span class="mi">481</span>         <span class="n">instsInProgress</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">-=</span> <span class="n">fromIEW</span><span class="o">-&gt;</span><span class="n">iewInfo</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">dispatched</span><span class="p">;</span>
 <span class="mi">482</span>         <span class="n">loadsInProgress</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">-=</span> <span class="n">fromIEW</span><span class="o">-&gt;</span><span class="n">iewInfo</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">dispatchedToLQ</span><span class="p">;</span>
 <span class="mi">483</span>         <span class="n">storesInProgress</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">-=</span> <span class="n">fromIEW</span><span class="o">-&gt;</span><span class="n">iewInfo</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">dispatchedToSQ</span><span class="p">;</span>
 <span class="mi">484</span>         <span class="n">assert</span><span class="p">(</span><span class="n">loadsInProgress</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">);</span>
 <span class="mi">485</span>         <span class="n">assert</span><span class="p">(</span><span class="n">storesInProgress</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">);</span>
 <span class="mi">486</span>         <span class="n">assert</span><span class="p">(</span><span class="n">instsInProgress</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">&gt;=</span><span class="mi">0</span><span class="p">);</span>
 <span class="mi">487</span>     <span class="p">}</span>
 <span class="mi">488</span> 
 <span class="mi">489</span> <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="sortinsts"><span class="me-2">sortInsts</span><a href="#sortinsts" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre> <span class="mi">836</span> <span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">Impl</span><span class="p">&gt;</span>
 <span class="mi">837</span> <span class="kt">void</span>
 <span class="mi">838</span> <span class="n">DefaultRename</span><span class="o">&lt;</span><span class="n">Impl</span><span class="o">&gt;::</span><span class="n">sortInsts</span><span class="p">()</span>
 <span class="mi">839</span> <span class="p">{</span>
 <span class="mi">840</span>     <span class="kt">int</span> <span class="n">insts_from_decode</span> <span class="o">=</span> <span class="n">fromDecode</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
 <span class="mi">841</span>     <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">insts_from_decode</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
 <span class="mi">842</span>         <span class="k">const</span> <span class="n">DynInstPtr</span> <span class="o">&amp;</span><span class="n">inst</span> <span class="o">=</span> <span class="n">fromDecode</span><span class="o">-&gt;</span><span class="n">insts</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
 <span class="mi">843</span>         <span class="n">insts</span><span class="p">[</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">threadNumber</span><span class="p">].</span><span class="n">push_back</span><span class="p">(</span><span class="n">inst</span><span class="p">);</span>
 <span class="mi">844</span> <span class="err">#</span><span class="k">if</span> <span class="n">TRACING_ON</span>
 <span class="mi">845</span>         <span class="k">if</span> <span class="p">(</span><span class="n">DTRACE</span><span class="p">(</span><span class="n">O3PipeView</span><span class="p">))</span> <span class="p">{</span>
 <span class="mi">846</span>             <span class="n">inst</span><span class="o">-&gt;</span><span class="n">renameTick</span> <span class="o">=</span> <span class="n">curTick</span><span class="p">()</span> <span class="o">-</span> <span class="n">inst</span><span class="o">-&gt;</span><span class="n">fetchTick</span><span class="p">;</span>
 <span class="mi">847</span>         <span class="p">}</span>
 <span class="mi">848</span> <span class="err">#</span><span class="n">endif</span>
 <span class="mi">849</span>     <span class="p">}</span>
 <span class="mi">850</span> <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>
<p>Because the register maintains all instructions 
regardless of origin of the instructions (initiated by which thread), 
it should sort instructions based on the thread 
that instantiated the instruction. 
For that purpose, each instruction maintains information 
representing which thread is the owner of that instruction.</p>

<h3 id="checksignalsandupdate"><span class="me-2">checkSignalsAndUpdate</span><a href="#checksignalsandupdate" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
</pre></td><td class="rouge-code"><pre><span class="mi">1331</span> <span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">Impl</span><span class="p">&gt;</span>
<span class="mi">1332</span> <span class="kt">bool</span>
<span class="mi">1333</span> <span class="n">DefaultRename</span><span class="o">&lt;</span><span class="n">Impl</span><span class="o">&gt;::</span><span class="n">checkSignalsAndUpdate</span><span class="p">(</span><span class="n">ThreadID</span> <span class="n">tid</span><span class="p">)</span>
<span class="mi">1334</span> <span class="p">{</span>
<span class="mi">1335</span>     <span class="c1">// Check if there's a squash signal, squash if there is</span>
<span class="mi">1336</span>     <span class="c1">// Check stall signals, block if necessary.</span>
<span class="mi">1337</span>     <span class="c1">// If status was blocked</span>
<span class="mi">1338</span>     <span class="c1">//     check if stall conditions have passed</span>
<span class="mi">1339</span>     <span class="c1">//         if so then go to unblocking</span>
<span class="mi">1340</span>     <span class="c1">// If status was Squashing</span>
<span class="mi">1341</span>     <span class="c1">//     check if squashing is not high.  Switch to running this cycle.</span>
<span class="mi">1342</span>     <span class="c1">// If status was serialize stall</span>
<span class="mi">1343</span>     <span class="c1">//     check if ROB is empty and no insts are in flight to the ROB</span>
<span class="mi">1344</span> 
<span class="mi">1345</span>     <span class="n">readFreeEntries</span><span class="p">(</span><span class="n">tid</span><span class="p">);</span>
<span class="mi">1346</span>     <span class="n">readStallSignals</span><span class="p">(</span><span class="n">tid</span><span class="p">);</span>
<span class="mi">1347</span> 
<span class="mi">1348</span>     <span class="k">if</span> <span class="p">(</span><span class="n">fromCommit</span><span class="o">-&gt;</span><span class="n">commitInfo</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">squash</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">1349</span>         <span class="n">DPRINTF</span><span class="p">(</span><span class="n">Rename</span><span class="p">,</span> <span class="s">"[tid:%i] Squashing instructions due to squash from "</span>
<span class="mi">1350</span>                 <span class="s">"commit.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
<span class="mi">1351</span> 
<span class="mi">1352</span>         <span class="n">squash</span><span class="p">(</span><span class="n">fromCommit</span><span class="o">-&gt;</span><span class="n">commitInfo</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">doneSeqNum</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
<span class="mi">1353</span> 
<span class="mi">1354</span>         <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="mi">1355</span>     <span class="p">}</span>
<span class="mi">1356</span> 
<span class="mi">1357</span>     <span class="nf">if</span> <span class="p">(</span><span class="n">checkStall</span><span class="p">(</span><span class="n">tid</span><span class="p">))</span> <span class="p">{</span>
<span class="mi">1358</span>         <span class="k">return</span> <span class="n">block</span><span class="p">(</span><span class="n">tid</span><span class="p">);</span>
<span class="mi">1359</span>     <span class="p">}</span>
<span class="mi">1360</span> 
<span class="mi">1361</span>     <span class="nf">if</span> <span class="p">(</span><span class="n">renameStatus</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">==</span> <span class="n">Blocked</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">1362</span>         <span class="n">DPRINTF</span><span class="p">(</span><span class="n">Rename</span><span class="p">,</span> <span class="s">"[tid:%i] Done blocking, switching to unblocking.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
<span class="mi">1363</span>                 <span class="n">tid</span><span class="p">);</span>
<span class="mi">1364</span> 
<span class="mi">1365</span>         <span class="n">renameStatus</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">=</span> <span class="n">Unblocking</span><span class="p">;</span>
<span class="mi">1366</span> 
<span class="mi">1367</span>         <span class="n">unblock</span><span class="p">(</span><span class="n">tid</span><span class="p">);</span>
<span class="mi">1368</span> 
<span class="mi">1369</span>         <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="mi">1370</span>     <span class="p">}</span>
<span class="mi">1371</span> 
<span class="mi">1372</span>     <span class="nf">if</span> <span class="p">(</span><span class="n">renameStatus</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">==</span> <span class="n">Squashing</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">1373</span>         <span class="c1">// Switch status to running if rename isn't being told to block or</span>
<span class="mi">1374</span>         <span class="c1">// squash this cycle.</span>
<span class="mi">1375</span>         <span class="k">if</span> <span class="p">(</span><span class="n">resumeSerialize</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">1376</span>             <span class="n">DPRINTF</span><span class="p">(</span><span class="n">Rename</span><span class="p">,</span>
<span class="mi">1377</span>                     <span class="s">"[tid:%i] Done squashing, switching to serialize.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
<span class="mi">1378</span> 
<span class="mi">1379</span>             <span class="n">renameStatus</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">=</span> <span class="n">SerializeStall</span><span class="p">;</span>
<span class="mi">1380</span>             <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="mi">1381</span>         <span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">resumeUnblocking</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">1382</span>             <span class="n">DPRINTF</span><span class="p">(</span><span class="n">Rename</span><span class="p">,</span>
<span class="mi">1383</span>                     <span class="s">"[tid:%i] Done squashing, switching to unblocking.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
<span class="mi">1384</span>                     <span class="n">tid</span><span class="p">);</span>
<span class="mi">1385</span>             <span class="n">renameStatus</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">=</span> <span class="n">Unblocking</span><span class="p">;</span>
<span class="mi">1386</span>             <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="mi">1387</span>         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="mi">1388</span>             <span class="n">DPRINTF</span><span class="p">(</span><span class="n">Rename</span><span class="p">,</span> <span class="s">"[tid:%i] Done squashing, switching to running.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
<span class="mi">1389</span>                     <span class="n">tid</span><span class="p">);</span>
<span class="mi">1390</span>             <span class="n">renameStatus</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">=</span> <span class="n">Running</span><span class="p">;</span>
<span class="mi">1391</span>             <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="mi">1392</span>         <span class="p">}</span>
<span class="mi">1393</span>     <span class="p">}</span>
<span class="mi">1394</span> 
<span class="mi">1395</span>     <span class="nf">if</span> <span class="p">(</span><span class="n">renameStatus</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">==</span> <span class="n">SerializeStall</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">1396</span>         <span class="c1">// Stall ends once the ROB is free.</span>
<span class="mi">1397</span>         <span class="n">DPRINTF</span><span class="p">(</span><span class="n">Rename</span><span class="p">,</span> <span class="s">"[tid:%i] Done with serialize stall, switching to "</span>
<span class="mi">1398</span>                 <span class="s">"unblocking.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
<span class="mi">1399</span> 
<span class="mi">1400</span>         <span class="n">DynInstPtr</span> <span class="n">serial_inst</span> <span class="o">=</span> <span class="n">serializeInst</span><span class="p">[</span><span class="n">tid</span><span class="p">];</span>
<span class="mi">1401</span> 
<span class="mi">1402</span>         <span class="n">renameStatus</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">=</span> <span class="n">Unblocking</span><span class="p">;</span>
<span class="mi">1403</span> 
<span class="mi">1404</span>         <span class="n">unblock</span><span class="p">(</span><span class="n">tid</span><span class="p">);</span>
<span class="mi">1405</span> 
<span class="mi">1406</span>         <span class="n">DPRINTF</span><span class="p">(</span><span class="n">Rename</span><span class="p">,</span> <span class="s">"[tid:%i] Processing instruction [%lli] with "</span>
<span class="mi">1407</span>                 <span class="s">"PC %s.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span> <span class="n">serial_inst</span><span class="o">-&gt;</span><span class="n">seqNum</span><span class="p">,</span> <span class="n">serial_inst</span><span class="o">-&gt;</span><span class="n">pcState</span><span class="p">());</span>
<span class="mi">1408</span> 
<span class="mi">1409</span>         <span class="c1">// Put instruction into queue here.</span>
<span class="mi">1410</span>         <span class="n">serial_inst</span><span class="o">-&gt;</span><span class="n">clearSerializeBefore</span><span class="p">();</span>
<span class="mi">1411</span> 
<span class="mi">1412</span>         <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skidBuffer</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
<span class="mi">1413</span>             <span class="n">skidBuffer</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">push_front</span><span class="p">(</span><span class="n">serial_inst</span><span class="p">);</span>
<span class="mi">1414</span>         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="mi">1415</span>             <span class="n">insts</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">push_front</span><span class="p">(</span><span class="n">serial_inst</span><span class="p">);</span>
<span class="mi">1416</span>         <span class="p">}</span>
<span class="mi">1417</span> 
<span class="mi">1418</span>         <span class="nf">DPRINTF</span><span class="p">(</span><span class="n">Rename</span><span class="p">,</span> <span class="s">"[tid:%i] Instruction must be processed by rename."</span>
<span class="mi">1419</span>                 <span class="s">" Adding to front of list.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
<span class="mi">1420</span> 
<span class="mi">1421</span>         <span class="n">serializeInst</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="mi">1422</span> 
<span class="mi">1423</span>         <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="mi">1424</span>     <span class="p">}</span>
<span class="mi">1425</span> 
<span class="mi">1426</span>     <span class="c1">// If we've reached this point, we have not gotten any signals that</span>
<span class="mi">1427</span>     <span class="c1">// cause rename to change its status.  Rename remains the same as before.</span>
<span class="mi">1428</span>     <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="mi">1429</span> <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Note that most of the operation sequence of the checkSignalsAndUpdate 
is very similar to the checkSignalsAndUpdate of the decode stage.
It checks the stall and squash signal and execute associated code.
For the stall, it executes the block function. 
For the squash, it invokes the squash function.
However, in detail there are two noticeable differences
in the readFreeEntries and checkStall function.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
</pre></td><td class="rouge-code"><pre><span class="mi">1295</span> <span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">Impl</span><span class="p">&gt;</span>
<span class="mi">1296</span> <span class="kt">void</span>
<span class="mi">1297</span> <span class="n">DefaultRename</span><span class="o">&lt;</span><span class="n">Impl</span><span class="o">&gt;::</span><span class="n">readFreeEntries</span><span class="p">(</span><span class="n">ThreadID</span> <span class="n">tid</span><span class="p">)</span>
<span class="mi">1298</span> <span class="p">{</span>
<span class="mi">1299</span>     <span class="k">if</span> <span class="p">(</span><span class="n">fromIEW</span><span class="o">-&gt;</span><span class="n">iewInfo</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">usedIQ</span><span class="p">)</span>
<span class="mi">1300</span>         <span class="n">freeEntries</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">iqEntries</span> <span class="o">=</span> <span class="n">fromIEW</span><span class="o">-&gt;</span><span class="n">iewInfo</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">freeIQEntries</span><span class="p">;</span>
<span class="mi">1301</span> 
<span class="mi">1302</span>     <span class="k">if</span> <span class="p">(</span><span class="n">fromIEW</span><span class="o">-&gt;</span><span class="n">iewInfo</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">usedLSQ</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">1303</span>         <span class="n">freeEntries</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">lqEntries</span> <span class="o">=</span> <span class="n">fromIEW</span><span class="o">-&gt;</span><span class="n">iewInfo</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">freeLQEntries</span><span class="p">;</span>
<span class="mi">1304</span>         <span class="n">freeEntries</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">sqEntries</span> <span class="o">=</span> <span class="n">fromIEW</span><span class="o">-&gt;</span><span class="n">iewInfo</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">freeSQEntries</span><span class="p">;</span>
<span class="mi">1305</span>     <span class="p">}</span>
<span class="mi">1306</span> 
<span class="mi">1307</span>     <span class="nf">if</span> <span class="p">(</span><span class="n">fromCommit</span><span class="o">-&gt;</span><span class="n">commitInfo</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">usedROB</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">1308</span>         <span class="n">freeEntries</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">robEntries</span> <span class="o">=</span>
<span class="mi">1309</span>             <span class="n">fromCommit</span><span class="o">-&gt;</span><span class="n">commitInfo</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">freeROBEntries</span><span class="p">;</span>
<span class="mi">1310</span>         <span class="n">emptyROB</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">=</span> <span class="n">fromCommit</span><span class="o">-&gt;</span><span class="n">commitInfo</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">emptyROB</span><span class="p">;</span>
<span class="mi">1311</span>     <span class="p">}</span>
<span class="mi">1312</span> 
<span class="mi">1313</span>     <span class="nf">DPRINTF</span><span class="p">(</span><span class="n">Rename</span><span class="p">,</span> <span class="s">"[tid:%i] Free IQ: %i, Free ROB: %i, "</span>
<span class="mi">1314</span>                     <span class="s">"Free LQ: %i, Free SQ: %i, FreeRM %i(%i %i %i %i %i)</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
<span class="mi">1315</span>             <span class="n">tid</span><span class="p">,</span>
<span class="mi">1316</span>             <span class="n">freeEntries</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">iqEntries</span><span class="p">,</span>
<span class="mi">1317</span>             <span class="n">freeEntries</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">robEntries</span><span class="p">,</span>
<span class="mi">1318</span>             <span class="n">freeEntries</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">lqEntries</span><span class="p">,</span>
<span class="mi">1319</span>             <span class="n">freeEntries</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">sqEntries</span><span class="p">,</span>
<span class="mi">1320</span>             <span class="n">renameMap</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">numFreeEntries</span><span class="p">(),</span>
<span class="mi">1321</span>             <span class="n">renameMap</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">numFreeIntEntries</span><span class="p">(),</span>
<span class="mi">1322</span>             <span class="n">renameMap</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">numFreeFloatEntries</span><span class="p">(),</span>
<span class="mi">1323</span>             <span class="n">renameMap</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">numFreeVecEntries</span><span class="p">(),</span>
<span class="mi">1324</span>             <span class="n">renameMap</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">numFreePredEntries</span><span class="p">(),</span>
<span class="mi">1325</span>             <span class="n">renameMap</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">numFreeCCEntries</span><span class="p">());</span>
<span class="mi">1326</span> 
<span class="mi">1327</span>     <span class="nf">DPRINTF</span><span class="p">(</span><span class="n">Rename</span><span class="p">,</span> <span class="s">"[tid:%i] %i instructions not yet in ROB</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
<span class="mi">1328</span>             <span class="n">tid</span><span class="p">,</span> <span class="n">instsInProgress</span><span class="p">[</span><span class="n">tid</span><span class="p">]);</span>
<span class="mi">1329</span> <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>After the IEW stage executes and commit the instructions,
it should reports the Rename stage that 
it has used the allocated resources and
good to reassign them to other instructions 
for renaming. 
We will see how the freeEntries are retrieved
to its resource pool and reassigned to other instructions.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre></td><td class="rouge-code"><pre><span class="mi">1263</span> <span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">Impl</span><span class="p">&gt;</span>
<span class="mi">1264</span> <span class="kt">bool</span>
<span class="mi">1265</span> <span class="n">DefaultRename</span><span class="o">&lt;</span><span class="n">Impl</span><span class="o">&gt;::</span><span class="n">checkStall</span><span class="p">(</span><span class="n">ThreadID</span> <span class="n">tid</span><span class="p">)</span>
<span class="mi">1266</span> <span class="p">{</span>
<span class="mi">1267</span>     <span class="kt">bool</span> <span class="n">ret_val</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="mi">1268</span> 
<span class="mi">1269</span>     <span class="k">if</span> <span class="p">(</span><span class="n">stalls</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">iew</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">1270</span>         <span class="n">DPRINTF</span><span class="p">(</span><span class="n">Rename</span><span class="p">,</span><span class="s">"[tid:%i] Stall from IEW stage detected.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
<span class="mi">1271</span>         <span class="n">ret_val</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="mi">1272</span>     <span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">calcFreeROBEntries</span><span class="p">(</span><span class="n">tid</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">1273</span>         <span class="n">DPRINTF</span><span class="p">(</span><span class="n">Rename</span><span class="p">,</span><span class="s">"[tid:%i] Stall: ROB has 0 free entries.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
<span class="mi">1274</span>         <span class="n">ret_val</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="mi">1275</span>     <span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">calcFreeIQEntries</span><span class="p">(</span><span class="n">tid</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">1276</span>         <span class="n">DPRINTF</span><span class="p">(</span><span class="n">Rename</span><span class="p">,</span><span class="s">"[tid:%i] Stall: IQ has 0 free entries.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
<span class="mi">1277</span>         <span class="n">ret_val</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="mi">1278</span>     <span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">calcFreeLQEntries</span><span class="p">(</span><span class="n">tid</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">calcFreeSQEntries</span><span class="p">(</span><span class="n">tid</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">1279</span>         <span class="n">DPRINTF</span><span class="p">(</span><span class="n">Rename</span><span class="p">,</span><span class="s">"[tid:%i] Stall: LSQ has 0 free entries.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
<span class="mi">1280</span>         <span class="n">ret_val</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="mi">1281</span>     <span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">renameMap</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">numFreeEntries</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">1282</span>         <span class="n">DPRINTF</span><span class="p">(</span><span class="n">Rename</span><span class="p">,</span><span class="s">"[tid:%i] Stall: RenameMap has 0 free entries.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
<span class="mi">1283</span>         <span class="n">ret_val</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="mi">1284</span>     <span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">renameStatus</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">==</span> <span class="n">SerializeStall</span> <span class="o">&amp;&amp;</span>
<span class="mi">1285</span>                <span class="p">(</span><span class="o">!</span><span class="n">emptyROB</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">||</span> <span class="n">instsInProgress</span><span class="p">[</span><span class="n">tid</span><span class="p">]))</span> <span class="p">{</span>
<span class="mi">1286</span>         <span class="n">DPRINTF</span><span class="p">(</span><span class="n">Rename</span><span class="p">,</span><span class="s">"[tid:%i] Stall: Serialize stall and ROB is not "</span>
<span class="mi">1287</span>                 <span class="s">"empty.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
<span class="mi">1288</span>                 <span class="n">tid</span><span class="p">);</span>
<span class="mi">1289</span>         <span class="n">ret_val</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="mi">1290</span>     <span class="p">}</span>
<span class="mi">1291</span> 
<span class="mi">1292</span>     <span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
<span class="mi">1293</span> <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>There could be various reasons of the stall.
It might be because of the stall signal 
received from other stages
or 
the internal issues of the rename stage 
due to lack of resources.</p>

<h2 id="rename-1"><span class="me-2">rename</span><a href="#rename-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
</pre></td><td class="rouge-code"><pre> <span class="mi">491</span> <span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">Impl</span><span class="p">&gt;</span>
 <span class="mi">492</span> <span class="kt">void</span>
 <span class="mi">493</span> <span class="n">DefaultRename</span><span class="o">&lt;</span><span class="n">Impl</span><span class="o">&gt;::</span><span class="n">rename</span><span class="p">(</span><span class="kt">bool</span> <span class="o">&amp;</span><span class="n">status_change</span><span class="p">,</span> <span class="n">ThreadID</span> <span class="n">tid</span><span class="p">)</span>
 <span class="mi">494</span> <span class="p">{</span>
 <span class="mi">495</span>     <span class="c1">// If status is Running or idle,</span>
 <span class="mi">496</span>     <span class="c1">//     call renameInsts()</span>
 <span class="mi">497</span>     <span class="c1">// If status is Unblocking,</span>
 <span class="mi">498</span>     <span class="c1">//     buffer any instructions coming from decode</span>
 <span class="mi">499</span>     <span class="c1">//     continue trying to empty skid buffer</span>
 <span class="mi">500</span>     <span class="c1">//     check if stall conditions have passed</span>
 <span class="mi">501</span> 
 <span class="mi">502</span>     <span class="k">if</span> <span class="p">(</span><span class="n">renameStatus</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">==</span> <span class="n">Blocked</span><span class="p">)</span> <span class="p">{</span>
 <span class="mi">503</span>         <span class="o">++</span><span class="n">renameBlockCycles</span><span class="p">;</span>
 <span class="mi">504</span>     <span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">renameStatus</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">==</span> <span class="n">Squashing</span><span class="p">)</span> <span class="p">{</span>
 <span class="mi">505</span>         <span class="o">++</span><span class="n">renameSquashCycles</span><span class="p">;</span>
 <span class="mi">506</span>     <span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">renameStatus</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">==</span> <span class="n">SerializeStall</span><span class="p">)</span> <span class="p">{</span>
 <span class="mi">507</span>         <span class="o">++</span><span class="n">renameSerializeStallCycles</span><span class="p">;</span>
 <span class="mi">508</span>         <span class="c1">// If we are currently in SerializeStall and resumeSerialize</span>
 <span class="mi">509</span>         <span class="c1">// was set, then that means that we are resuming serializing</span>
 <span class="mi">510</span>         <span class="c1">// this cycle.  Tell the previous stages to block.</span>
 <span class="mi">511</span>         <span class="k">if</span> <span class="p">(</span><span class="n">resumeSerialize</span><span class="p">)</span> <span class="p">{</span>
 <span class="mi">512</span>             <span class="n">resumeSerialize</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
 <span class="mi">513</span>             <span class="n">block</span><span class="p">(</span><span class="n">tid</span><span class="p">);</span>
 <span class="mi">514</span>             <span class="n">toDecode</span><span class="o">-&gt;</span><span class="n">renameUnblock</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
 <span class="mi">515</span>         <span class="p">}</span>
 <span class="mi">516</span>     <span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">renameStatus</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">==</span> <span class="n">Unblocking</span><span class="p">)</span> <span class="p">{</span>
 <span class="mi">517</span>         <span class="k">if</span> <span class="p">(</span><span class="n">resumeUnblocking</span><span class="p">)</span> <span class="p">{</span>
 <span class="mi">518</span>             <span class="n">block</span><span class="p">(</span><span class="n">tid</span><span class="p">);</span>
 <span class="mi">519</span>             <span class="n">resumeUnblocking</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
 <span class="mi">520</span>             <span class="n">toDecode</span><span class="o">-&gt;</span><span class="n">renameUnblock</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
 <span class="mi">521</span>         <span class="p">}</span>
 <span class="mi">522</span>     <span class="p">}</span>
 <span class="mi">523</span> 
 <span class="mi">524</span>     <span class="nf">if</span> <span class="p">(</span><span class="n">renameStatus</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">==</span> <span class="n">Running</span> <span class="o">||</span>
 <span class="mi">525</span>         <span class="n">renameStatus</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">==</span> <span class="n">Idle</span><span class="p">)</span> <span class="p">{</span>
 <span class="mi">526</span>         <span class="n">DPRINTF</span><span class="p">(</span><span class="n">Rename</span><span class="p">,</span>
 <span class="mi">527</span>                 <span class="s">"[tid:%i] "</span>
 <span class="mi">528</span>                 <span class="s">"Not blocked, so attempting to run stage.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
 <span class="mi">529</span>                 <span class="n">tid</span><span class="p">);</span>
 <span class="mi">530</span> 
 <span class="mi">531</span>         <span class="n">renameInsts</span><span class="p">(</span><span class="n">tid</span><span class="p">);</span>
 <span class="mi">532</span>     <span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">renameStatus</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">==</span> <span class="n">Unblocking</span><span class="p">)</span> <span class="p">{</span>
 <span class="mi">533</span>         <span class="n">renameInsts</span><span class="p">(</span><span class="n">tid</span><span class="p">);</span>
 <span class="mi">534</span> 
 <span class="mi">535</span>         <span class="k">if</span> <span class="p">(</span><span class="n">validInsts</span><span class="p">())</span> <span class="p">{</span>
 <span class="mi">536</span>             <span class="c1">// Add the current inputs to the skid buffer so they can be</span>
 <span class="mi">537</span>             <span class="c1">// reprocessed when this stage unblocks.</span>
 <span class="mi">538</span>             <span class="n">skidInsert</span><span class="p">(</span><span class="n">tid</span><span class="p">);</span>
 <span class="mi">539</span>         <span class="p">}</span>
 <span class="mi">540</span> 
 <span class="mi">541</span>         <span class="c1">// If we switched over to blocking, then there's a potential for</span>
 <span class="mi">542</span>         <span class="c1">// an overall status change.</span>
 <span class="mi">543</span>         <span class="n">status_change</span> <span class="o">=</span> <span class="n">unblock</span><span class="p">(</span><span class="n">tid</span><span class="p">)</span> <span class="o">||</span> <span class="n">status_change</span> <span class="o">||</span> <span class="n">blockThisCycle</span><span class="p">;</span>
 <span class="mi">544</span>     <span class="p">}</span>
 <span class="mi">545</span> <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>When there is no stall or blocking, 
now it can rename the instructions.
When the current renameStatus is Running or Idle, 
it will invoke renameInsts function 
to rename the instructions 
Also, when the renameStatus is Unblocking,
which means that the rename stage is being recovered from the Blocking status, 
it should also invoke the renameInsts function.</p>

<h3 id="renameinsts-the-main-rename-function"><span class="me-2">renameInsts: the main rename function</span><a href="#renameinsts-the-main-rename-function" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>The most of the rename function operations are done by the <strong>renameInsts</strong> function.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td><td class="rouge-code"><pre> <span class="mi">547</span> <span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">Impl</span><span class="p">&gt;</span>
 <span class="mi">548</span> <span class="kt">void</span>
 <span class="mi">549</span> <span class="n">DefaultRename</span><span class="o">&lt;</span><span class="n">Impl</span><span class="o">&gt;::</span><span class="n">renameInsts</span><span class="p">(</span><span class="n">ThreadID</span> <span class="n">tid</span><span class="p">)</span>
 <span class="mi">550</span> <span class="p">{</span>
 <span class="mi">551</span>     <span class="c1">// Instructions can be either in the skid buffer or the queue of</span>
 <span class="mi">552</span>     <span class="c1">// instructions coming from decode, depending on the status.</span>
 <span class="mi">553</span>     <span class="kt">int</span> <span class="n">insts_available</span> <span class="o">=</span> <span class="n">renameStatus</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">==</span> <span class="n">Unblocking</span> <span class="o">?</span>
 <span class="mi">554</span>         <span class="n">skidBuffer</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">size</span><span class="p">()</span> <span class="o">:</span> <span class="n">insts</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">size</span><span class="p">();</span>
 <span class="mi">555</span> 
 <span class="mi">556</span>     <span class="c1">// Check the decode queue to see if instructions are available.</span>
 <span class="mi">557</span>     <span class="c1">// If there are no available instructions to rename, then do nothing.</span>
 <span class="mi">558</span>     <span class="k">if</span> <span class="p">(</span><span class="n">insts_available</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
 <span class="mi">559</span>         <span class="n">DPRINTF</span><span class="p">(</span><span class="n">Rename</span><span class="p">,</span> <span class="s">"[tid:%i] Nothing to do, breaking out early.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
 <span class="mi">560</span>                 <span class="n">tid</span><span class="p">);</span>
 <span class="mi">561</span>         <span class="c1">// Should I change status to idle?</span>
 <span class="mi">562</span>         <span class="o">++</span><span class="n">renameIdleCycles</span><span class="p">;</span>
 <span class="mi">563</span>         <span class="k">return</span><span class="p">;</span>
 <span class="mi">564</span>     <span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">renameStatus</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">==</span> <span class="n">Unblocking</span><span class="p">)</span> <span class="p">{</span>
 <span class="mi">565</span>         <span class="o">++</span><span class="n">renameUnblockCycles</span><span class="p">;</span>
 <span class="mi">566</span>     <span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">renameStatus</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">==</span> <span class="n">Running</span><span class="p">)</span> <span class="p">{</span>
 <span class="mi">567</span>         <span class="o">++</span><span class="n">renameRunCycles</span><span class="p">;</span>
 <span class="mi">568</span>     <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>First, it checks the current status of the rename stage. 
If the current status is Unblock, 
it should fetches instructions from the skidBuffer instead of the insts buffer. 
Also, even though it is running or idle status, 
it might not have available instructions because of stall, squash.
Therefore, it first checks whether the instructions are ready to be renamed.</p>

<h3 id="checking-rob-and-iq-space"><span class="me-2">Checking ROB and IQ space</span><a href="#checking-rob-and-iq-space" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
</pre></td><td class="rouge-code"><pre> <span class="mi">570</span>     <span class="c1">// Will have to do a different calculation for the number of free</span>
 <span class="mi">571</span>     <span class="c1">// entries.</span>
 <span class="mi">572</span>     <span class="kt">int</span> <span class="n">free_rob_entries</span> <span class="o">=</span> <span class="n">calcFreeROBEntries</span><span class="p">(</span><span class="n">tid</span><span class="p">);</span>
 <span class="mi">573</span>     <span class="kt">int</span> <span class="n">free_iq_entries</span>  <span class="o">=</span> <span class="n">calcFreeIQEntries</span><span class="p">(</span><span class="n">tid</span><span class="p">);</span>
 <span class="mi">574</span>     <span class="kt">int</span> <span class="n">min_free_entries</span> <span class="o">=</span> <span class="n">free_rob_entries</span><span class="p">;</span>
 <span class="mi">575</span> 
 <span class="mi">576</span>     <span class="n">FullSource</span> <span class="n">source</span> <span class="o">=</span> <span class="n">ROB</span><span class="p">;</span>
 <span class="mi">577</span> 
 <span class="mi">578</span>     <span class="nf">if</span> <span class="p">(</span><span class="n">free_iq_entries</span> <span class="o">&lt;</span> <span class="n">min_free_entries</span><span class="p">)</span> <span class="p">{</span>
 <span class="mi">579</span>         <span class="n">min_free_entries</span> <span class="o">=</span> <span class="n">free_iq_entries</span><span class="p">;</span>
 <span class="mi">580</span>         <span class="n">source</span> <span class="o">=</span> <span class="n">IQ</span><span class="p">;</span>
 <span class="mi">581</span>     <span class="p">}</span>
 <span class="mi">582</span> 
 <span class="mi">583</span>     <span class="c1">// Check if there's any space left.</span>
 <span class="mi">584</span>     <span class="nf">if</span> <span class="p">(</span><span class="n">min_free_entries</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
 <span class="mi">585</span>         <span class="n">DPRINTF</span><span class="p">(</span><span class="n">Rename</span><span class="p">,</span>
 <span class="mi">586</span>                 <span class="s">"[tid:%i] Blocking due to no free ROB/IQ/ entries.</span><span class="se">\n</span><span class="s">"</span>
 <span class="mi">587</span>                 <span class="s">"ROB has %i free entries.</span><span class="se">\n</span><span class="s">"</span>
 <span class="mi">588</span>                 <span class="s">"IQ has %i free entries.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
 <span class="mi">589</span>                 <span class="n">tid</span><span class="p">,</span> <span class="n">free_rob_entries</span><span class="p">,</span> <span class="n">free_iq_entries</span><span class="p">);</span>
 <span class="mi">590</span> 
 <span class="mi">591</span>         <span class="n">blockThisCycle</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
 <span class="mi">592</span> 
 <span class="mi">593</span>         <span class="n">block</span><span class="p">(</span><span class="n">tid</span><span class="p">);</span>
 <span class="mi">594</span> 
 <span class="mi">595</span>         <span class="n">incrFullStat</span><span class="p">(</span><span class="n">source</span><span class="p">);</span>
 <span class="mi">596</span> 
 <span class="mi">597</span>         <span class="k">return</span><span class="p">;</span>
 <span class="mi">598</span>     <span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">min_free_entries</span> <span class="o">&lt;</span> <span class="n">insts_available</span><span class="p">)</span> <span class="p">{</span>
 <span class="mi">599</span>         <span class="n">DPRINTF</span><span class="p">(</span><span class="n">Rename</span><span class="p">,</span>
 <span class="mi">600</span>                 <span class="s">"[tid:%i] "</span>
 <span class="mi">601</span>                 <span class="s">"Will have to block this cycle. "</span>
 <span class="mi">602</span>                 <span class="s">"%i insts available, "</span>
 <span class="mi">603</span>                 <span class="s">"but only %i insts can be renamed due to ROB/IQ/LSQ limits.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
 <span class="mi">604</span>                 <span class="n">tid</span><span class="p">,</span> <span class="n">insts_available</span><span class="p">,</span> <span class="n">min_free_entries</span><span class="p">);</span>
 <span class="mi">605</span> 
 <span class="mi">606</span>         <span class="n">insts_available</span> <span class="o">=</span> <span class="n">min_free_entries</span><span class="p">;</span>
 <span class="mi">607</span> 
 <span class="mi">608</span>         <span class="n">blockThisCycle</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
 <span class="mi">609</span> 
 <span class="mi">610</span>         <span class="n">incrFullStat</span><span class="p">(</span><span class="n">source</span><span class="p">);</span>
 <span class="mi">611</span>     <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>It needs to check ROB and instruction queue entries are available
before the renaming. 
When there is no space, it should stall right a way.
However, if those entries are partially available,
only the available parts of the instructions are processed 
and postpone stall to later
(blockThisCycle = true).</p>

<h3 id="checking-serialization"><span class="me-2">Checking serialization</span><a href="#checking-serialization" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td><td class="rouge-code"><pre> <span class="mi">613</span>     <span class="n">InstQueue</span> <span class="o">&amp;</span><span class="n">insts_to_rename</span> <span class="o">=</span> <span class="n">renameStatus</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">==</span> <span class="n">Unblocking</span> <span class="o">?</span>
 <span class="mi">614</span>         <span class="n">skidBuffer</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">:</span> <span class="n">insts</span><span class="p">[</span><span class="n">tid</span><span class="p">];</span>
 <span class="mi">615</span> 
 <span class="mi">616</span>     <span class="nf">DPRINTF</span><span class="p">(</span><span class="n">Rename</span><span class="p">,</span>
 <span class="mi">617</span>             <span class="s">"[tid:%i] "</span>
 <span class="mi">618</span>             <span class="s">"%i available instructions to send iew.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
 <span class="mi">619</span>             <span class="n">tid</span><span class="p">,</span> <span class="n">insts_available</span><span class="p">);</span>
 <span class="mi">620</span> 
 <span class="mi">621</span>     <span class="nf">DPRINTF</span><span class="p">(</span><span class="n">Rename</span><span class="p">,</span>
 <span class="mi">622</span>             <span class="s">"[tid:%i] "</span>
 <span class="mi">623</span>             <span class="s">"%i insts pipelining from Rename | "</span>
 <span class="mi">624</span>             <span class="s">"%i insts dispatched to IQ last cycle.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
 <span class="mi">625</span>             <span class="n">tid</span><span class="p">,</span> <span class="n">instsInProgress</span><span class="p">[</span><span class="n">tid</span><span class="p">],</span> <span class="n">fromIEW</span><span class="o">-&gt;</span><span class="n">iewInfo</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">dispatched</span><span class="p">);</span>
 <span class="mi">626</span> 
 <span class="mi">627</span>     <span class="c1">// Handle serializing the next instruction if necessary.</span>
 <span class="mi">628</span>     <span class="nf">if</span> <span class="p">(</span><span class="n">serializeOnNextInst</span><span class="p">[</span><span class="n">tid</span><span class="p">])</span> <span class="p">{</span>
 <span class="mi">629</span>         <span class="k">if</span> <span class="p">(</span><span class="n">emptyROB</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">instsInProgress</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
 <span class="mi">630</span>             <span class="c1">// ROB already empty; no need to serialize.</span>
 <span class="mi">631</span>             <span class="n">serializeOnNextInst</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
 <span class="mi">632</span>         <span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="o">!</span><span class="n">insts_to_rename</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
 <span class="mi">633</span>             <span class="n">insts_to_rename</span><span class="p">.</span><span class="n">front</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setSerializeBefore</span><span class="p">();</span>
 <span class="mi">634</span>         <span class="p">}</span>
 <span class="mi">635</span>     <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>It also manages serializing instructions and generate stalls 
to enforce serialization operation. 
To this end, 
it provides associated functions and fields.
I will not cover the details here 
because they are utilized later when each instruction is processed
by the rename stage’s main loop,</p>

<h3 id="checking-availability-of-the-lq-and-sq"><span class="me-2">Checking availability of the LQ and SQ</span><a href="#checking-availability-of-the-lq-and-sq" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre></td><td class="rouge-code"><pre> <span class="mi">637</span>     <span class="kt">int</span> <span class="n">renamed_insts</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
 <span class="mi">638</span> 
 <span class="mi">639</span>     <span class="nf">while</span> <span class="p">(</span><span class="n">insts_available</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>  <span class="n">toIEWIndex</span> <span class="o">&lt;</span> <span class="n">renameWidth</span><span class="p">)</span> <span class="p">{</span>
 <span class="mi">640</span>         <span class="n">DPRINTF</span><span class="p">(</span><span class="n">Rename</span><span class="p">,</span> <span class="s">"[tid:%i] Sending instructions to IEW.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
 <span class="mi">641</span> 
 <span class="mi">642</span>         <span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">insts_to_rename</span><span class="p">.</span><span class="n">empty</span><span class="p">());</span>
 <span class="mi">643</span> 
 <span class="mi">644</span>         <span class="n">DynInstPtr</span> <span class="n">inst</span> <span class="o">=</span> <span class="n">insts_to_rename</span><span class="p">.</span><span class="n">front</span><span class="p">();</span>
 <span class="mi">645</span> 
 <span class="mi">646</span>         <span class="c1">//For all kind of instructions, check ROB and IQ first</span>
 <span class="mi">647</span>         <span class="c1">//For load instruction, check LQ size and take into account the inflight loads</span>
 <span class="mi">648</span>         <span class="c1">//For store instruction, check SQ size and take into account the inflight stores</span>
 <span class="mi">649</span> 
 <span class="mi">650</span>         <span class="k">if</span> <span class="p">(</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">isLoad</span><span class="p">())</span> <span class="p">{</span>
 <span class="mi">651</span>             <span class="k">if</span> <span class="p">(</span><span class="n">calcFreeLQEntries</span><span class="p">(</span><span class="n">tid</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
 <span class="mi">652</span>                 <span class="n">DPRINTF</span><span class="p">(</span><span class="n">Rename</span><span class="p">,</span> <span class="s">"[tid:%i] Cannot rename due to no free LQ</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
 <span class="mi">653</span>                 <span class="n">source</span> <span class="o">=</span> <span class="n">LQ</span><span class="p">;</span>
 <span class="mi">654</span>                 <span class="n">incrFullStat</span><span class="p">(</span><span class="n">source</span><span class="p">);</span>
 <span class="mi">655</span>                 <span class="k">break</span><span class="p">;</span>
 <span class="mi">656</span>             <span class="p">}</span>
 <span class="mi">657</span>         <span class="p">}</span>
 <span class="mi">658</span> 
 <span class="mi">659</span>         <span class="nf">if</span> <span class="p">(</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">isStore</span><span class="p">()</span> <span class="o">||</span> <span class="n">inst</span><span class="o">-&gt;</span><span class="n">isAtomic</span><span class="p">())</span> <span class="p">{</span>
 <span class="mi">660</span>             <span class="k">if</span> <span class="p">(</span><span class="n">calcFreeSQEntries</span><span class="p">(</span><span class="n">tid</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
 <span class="mi">661</span>                 <span class="n">DPRINTF</span><span class="p">(</span><span class="n">Rename</span><span class="p">,</span> <span class="s">"[tid:%i] Cannot rename due to no free SQ</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
 <span class="mi">662</span>                 <span class="n">source</span> <span class="o">=</span> <span class="n">SQ</span><span class="p">;</span>
 <span class="mi">663</span>                 <span class="n">incrFullStat</span><span class="p">(</span><span class="n">source</span><span class="p">);</span>
 <span class="mi">664</span>                 <span class="k">break</span><span class="p">;</span>
 <span class="mi">665</span>             <span class="p">}</span>
 <span class="mi">666</span>         <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Now we will take a look at the main loop of the rename stage.
It traverse all instructions stored in the insts_to_rename. 
Note that instructions can be retrieved from the Insts or the skidBuffer 
depending on the status of the current rename stage. 
Although we already checked 
the availability of IQ and ROB,
rename stage further checks 
the availability of the LoadQueue (LQ) and StoreQueue (SQ)
if the instruction is memory related operation.
Note that issuing memory operation will consume 
one entry from the corresponding queue.
If the LQ or SQ is full, then set the source as LQ or SQ 
to let the rest of the decode stage to know that 
the instruction cannot be issued to the next stage 
due to the lack of LQ or SQ and break the loop and stall
the rename stage(For statistics).</p>

<h3 id="consume-one-instruction-and-check-register-availability"><span class="me-2">Consume one instruction and check register availability</span><a href="#consume-one-instruction-and-check-register-availability" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
</pre></td><td class="rouge-code"><pre> <span class="mi">668</span>         <span class="n">insts_to_rename</span><span class="p">.</span><span class="n">pop_front</span><span class="p">();</span>
 <span class="mi">669</span> 
 <span class="mi">670</span>         <span class="nf">if</span> <span class="p">(</span><span class="n">renameStatus</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">==</span> <span class="n">Unblocking</span><span class="p">)</span> <span class="p">{</span>
 <span class="mi">671</span>             <span class="n">DPRINTF</span><span class="p">(</span><span class="n">Rename</span><span class="p">,</span>
 <span class="mi">672</span>                     <span class="s">"[tid:%i] "</span>
 <span class="mi">673</span>                     <span class="s">"Removing [sn:%llu] PC:%s from rename skidBuffer</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
 <span class="mi">674</span>                     <span class="n">tid</span><span class="p">,</span> <span class="n">inst</span><span class="o">-&gt;</span><span class="n">seqNum</span><span class="p">,</span> <span class="n">inst</span><span class="o">-&gt;</span><span class="n">pcState</span><span class="p">());</span>
 <span class="mi">675</span>         <span class="p">}</span>
 <span class="mi">676</span> 
 <span class="mi">677</span>         <span class="nf">if</span> <span class="p">(</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">isSquashed</span><span class="p">())</span> <span class="p">{</span>
 <span class="mi">678</span>             <span class="n">DPRINTF</span><span class="p">(</span><span class="n">Rename</span><span class="p">,</span>
 <span class="mi">679</span>                     <span class="s">"[tid:%i] "</span>
 <span class="mi">680</span>                     <span class="s">"instruction %i with PC %s is squashed, skipping.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
 <span class="mi">681</span>                     <span class="n">tid</span><span class="p">,</span> <span class="n">inst</span><span class="o">-&gt;</span><span class="n">seqNum</span><span class="p">,</span> <span class="n">inst</span><span class="o">-&gt;</span><span class="n">pcState</span><span class="p">());</span>
 <span class="mi">682</span> 
 <span class="mi">683</span>             <span class="o">++</span><span class="n">renameSquashedInsts</span><span class="p">;</span>
 <span class="mi">684</span> 
 <span class="mi">685</span>             <span class="c1">// Decrement how many instructions are available.</span>
 <span class="mi">686</span>             <span class="o">--</span><span class="n">insts_available</span><span class="p">;</span>
 <span class="mi">687</span> 
 <span class="mi">688</span>             <span class="k">continue</span><span class="p">;</span>
 <span class="mi">689</span>         <span class="p">}</span>
 <span class="mi">690</span> 
 <span class="mi">691</span>         <span class="nf">DPRINTF</span><span class="p">(</span><span class="n">Rename</span><span class="p">,</span>
 <span class="mi">692</span>                 <span class="s">"[tid:%i] "</span>
 <span class="mi">693</span>                 <span class="s">"Processing instruction [sn:%llu] with PC %s.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
 <span class="mi">694</span>                 <span class="n">tid</span><span class="p">,</span> <span class="n">inst</span><span class="o">-&gt;</span><span class="n">seqNum</span><span class="p">,</span> <span class="n">inst</span><span class="o">-&gt;</span><span class="n">pcState</span><span class="p">());</span>
 <span class="mi">695</span> 
 <span class="mi">696</span>         <span class="c1">// Check here to make sure there are enough destination registers</span>
 <span class="mi">697</span>         <span class="c1">// to rename to.  Otherwise block.</span>
 <span class="mi">698</span>         <span class="nf">if</span> <span class="p">(</span><span class="o">!</span><span class="n">renameMap</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">canRename</span><span class="p">(</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">numIntDestRegs</span><span class="p">(),</span>
 <span class="mi">699</span>                                        <span class="n">inst</span><span class="o">-&gt;</span><span class="n">numFPDestRegs</span><span class="p">(),</span>
 <span class="mi">700</span>                                        <span class="n">inst</span><span class="o">-&gt;</span><span class="n">numVecDestRegs</span><span class="p">(),</span>
 <span class="mi">701</span>                                        <span class="n">inst</span><span class="o">-&gt;</span><span class="n">numVecElemDestRegs</span><span class="p">(),</span>
 <span class="mi">702</span>                                        <span class="n">inst</span><span class="o">-&gt;</span><span class="n">numVecPredDestRegs</span><span class="p">(),</span>
 <span class="mi">703</span>                                        <span class="n">inst</span><span class="o">-&gt;</span><span class="n">numCCDestRegs</span><span class="p">()))</span> <span class="p">{</span>
 <span class="mi">704</span>             <span class="n">DPRINTF</span><span class="p">(</span><span class="n">Rename</span><span class="p">,</span>
 <span class="mi">705</span>                     <span class="s">"Blocking due to "</span>
 <span class="mi">706</span>                     <span class="s">" lack of free physical registers to rename to.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
 <span class="mi">707</span>             <span class="n">blockThisCycle</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
 <span class="mi">708</span>             <span class="n">insts_to_rename</span><span class="p">.</span><span class="n">push_front</span><span class="p">(</span><span class="n">inst</span><span class="p">);</span>
 <span class="mi">709</span>             <span class="o">++</span><span class="n">renameFullRegistersEvents</span><span class="p">;</span>
 <span class="mi">710</span> 
 <span class="mi">711</span>             <span class="k">break</span><span class="p">;</span>
 <span class="mi">712</span>         <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>
<p>After it is guaranteed that the resources 
such as ROB, IQ, LQ, SQ are suffice to rename new instruction,
it consumes one instruction from the buffer (Line 668).
However, if there are not enough physical registers 
to rename the instruction’s operands, 
then it should not be consumed.</p>

<h2 id="renamemap"><span class="me-2">renameMap</span><a href="#renamemap" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<p><em>gem5/src/cpu/o3/cpu.hh</em></p>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="mi">583</span>     <span class="cm">/** The rename map. */</span>
<span class="mi">584</span>     <span class="k">typename</span> <span class="n">CPUPolicy</span><span class="o">::</span><span class="n">RenameMap</span> <span class="n">renameMap</span><span class="p">[</span><span class="n">Impl</span><span class="o">::</span><span class="n">MaxThreads</span><span class="p">];</span>
</pre></td></tr></tbody></table></code></div></div>
<p><em>gem5/src/cpu/o3/cpu_policy.hh</em></p>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre> <span class="mi">60</span> <span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">Impl</span><span class="p">&gt;</span>
 <span class="mi">61</span> <span class="k">struct</span> <span class="nc">SimpleCPUPolicy</span>
 <span class="mi">62</span> <span class="p">{</span>
 <span class="mi">63</span>     <span class="cm">/** Typedef for the freelist of registers. */</span>
 <span class="mi">64</span>     <span class="k">typedef</span> <span class="n">UnifiedFreeList</span> <span class="n">FreeList</span><span class="p">;</span>
 <span class="mi">65</span>     <span class="cm">/** Typedef for the rename map. */</span>
 <span class="mi">66</span>     <span class="k">typedef</span> <span class="n">UnifiedRenameMap</span> <span class="n">RenameMap</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></div></div>
<p>The renameMap contains all the hardware registers 
accessible by the processor. 
For example, 
even though the ISA exposes only handful of registers
to the users, 
there are lots of internal registers to execute instructions. 
The O3 CPU utilize the <strong>UnifiedRenameMap</strong>. 
Let’s take a look at the details.</p>

<h3 id="unifiedrenamemap-has-different-types-of-simplerenamemaps"><span class="me-2">UnifiedRenameMap has different types of SimpleRenameMaps</span><a href="#unifiedrenamemap-has-different-types-of-simplerenamemaps" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre></td><td class="rouge-code"><pre><span class="mi">163</span> <span class="cm">/**
164  * Unified register rename map for all classes of registers.  Wraps a
165  * set of class-specific rename maps.  Methods that do not specify a
166  * register class (e.g., rename()) take register ids,
167  * while methods that do specify a register class (e.g., renameInt())
168  * take register indices.
169  */</span>
<span class="mi">170</span> <span class="k">class</span> <span class="nc">UnifiedRenameMap</span>
<span class="mi">171</span> <span class="p">{</span>
<span class="mi">172</span>   <span class="k">private</span><span class="o">:</span>
<span class="mi">173</span>     <span class="k">static</span> <span class="k">constexpr</span> <span class="kt">uint32_t</span> <span class="n">NVecElems</span> <span class="o">=</span> <span class="n">TheISA</span><span class="o">::</span><span class="n">NumVecElemPerVecReg</span><span class="p">;</span>
<span class="mi">174</span>     <span class="k">using</span> <span class="n">VecReg</span> <span class="o">=</span> <span class="n">TheISA</span><span class="o">::</span><span class="n">VecReg</span><span class="p">;</span>
<span class="mi">175</span>     <span class="k">using</span> <span class="n">VecPredReg</span> <span class="o">=</span> <span class="n">TheISA</span><span class="o">::</span><span class="n">VecPredReg</span><span class="p">;</span>
<span class="mi">176</span> 
<span class="mi">177</span>     <span class="cm">/** The integer register rename map */</span>
<span class="mi">178</span>     <span class="n">SimpleRenameMap</span> <span class="n">intMap</span><span class="p">;</span>
<span class="mi">179</span> 
<span class="mi">180</span>     <span class="cm">/** The floating-point register rename map */</span>
<span class="mi">181</span>     <span class="n">SimpleRenameMap</span> <span class="n">floatMap</span><span class="p">;</span>
<span class="mi">182</span> 
<span class="mi">183</span>     <span class="cm">/** The condition-code register rename map */</span>
<span class="mi">184</span>     <span class="n">SimpleRenameMap</span> <span class="n">ccMap</span><span class="p">;</span>
<span class="mi">185</span> 
<span class="mi">186</span>     <span class="cm">/** The vector register rename map */</span>
<span class="mi">187</span>     <span class="n">SimpleRenameMap</span> <span class="n">vecMap</span><span class="p">;</span>
<span class="mi">188</span> 
<span class="mi">189</span>     <span class="cm">/** The vector element register rename map */</span>
<span class="mi">190</span>     <span class="n">SimpleRenameMap</span> <span class="n">vecElemMap</span><span class="p">;</span>
<span class="mi">191</span> 
<span class="mi">192</span>     <span class="cm">/** The predicate register rename map */</span>
<span class="mi">193</span>     <span class="n">SimpleRenameMap</span> <span class="n">predMap</span><span class="p">;</span>
<span class="mi">194</span> 
<span class="mi">195</span>     <span class="k">using</span> <span class="n">VecMode</span> <span class="o">=</span> <span class="n">Enums</span><span class="o">::</span><span class="n">VecRegRenameMode</span><span class="p">;</span>
<span class="mi">196</span>     <span class="n">VecMode</span> <span class="n">vecMode</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></div></div>
<p>The renameMap used by the O3 is 
just a wrapper of the renameMap of each types of registers. 
As shown in the above class definition, 
it contains integer, float, vector, and other types of registes</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
</pre></td><td class="rouge-code"><pre> <span class="mi">237</span>         <span class="n">renameMap</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regFile</span><span class="p">,</span> <span class="n">TheISA</span><span class="o">::</span><span class="n">ZeroReg</span><span class="p">,</span> <span class="n">fpZeroReg</span><span class="p">,</span>
 <span class="mi">238</span>                             <span class="o">&amp;</span><span class="n">freeList</span><span class="p">,</span> <span class="n">vecMode</span><span class="p">);</span>
 <span class="p">......</span>
 <span class="mi">241</span>     <span class="c1">// Initialize rename map to assign physical registers to the</span>
 <span class="mi">242</span>     <span class="c1">// architectural registers for active threads only.</span>
 <span class="mi">243</span>     <span class="k">for</span> <span class="p">(</span><span class="n">ThreadID</span> <span class="n">tid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">tid</span> <span class="o">&lt;</span> <span class="n">active_threads</span><span class="p">;</span> <span class="n">tid</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
 <span class="mi">244</span>         <span class="k">for</span> <span class="p">(</span><span class="n">RegIndex</span> <span class="n">ridx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ridx</span> <span class="o">&lt;</span> <span class="n">TheISA</span><span class="o">::</span><span class="n">NumIntRegs</span><span class="p">;</span> <span class="o">++</span><span class="n">ridx</span><span class="p">)</span> <span class="p">{</span>
 <span class="mi">245</span>             <span class="c1">// Note that we can't use the rename() method because we don't</span>
 <span class="mi">246</span>             <span class="c1">// want special treatment for the zero register at this point</span>
 <span class="mi">247</span>             <span class="n">PhysRegIdPtr</span> <span class="n">phys_reg</span> <span class="o">=</span> <span class="n">freeList</span><span class="p">.</span><span class="n">getIntReg</span><span class="p">();</span>
 <span class="mi">248</span>             <span class="n">renameMap</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">setEntry</span><span class="p">(</span><span class="n">RegId</span><span class="p">(</span><span class="n">IntRegClass</span><span class="p">,</span> <span class="n">ridx</span><span class="p">),</span> <span class="n">phys_reg</span><span class="p">);</span>
 <span class="mi">249</span>             <span class="n">commitRenameMap</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">setEntry</span><span class="p">(</span><span class="n">RegId</span><span class="p">(</span><span class="n">IntRegClass</span><span class="p">,</span> <span class="n">ridx</span><span class="p">),</span> <span class="n">phys_reg</span><span class="p">);</span>
 <span class="mi">250</span>         <span class="p">}</span>
 <span class="mi">251</span> 
 <span class="mi">252</span>         <span class="k">for</span> <span class="p">(</span><span class="n">RegIndex</span> <span class="n">ridx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ridx</span> <span class="o">&lt;</span> <span class="n">TheISA</span><span class="o">::</span><span class="n">NumFloatRegs</span><span class="p">;</span> <span class="o">++</span><span class="n">ridx</span><span class="p">)</span> <span class="p">{</span>
 <span class="mi">253</span>             <span class="n">PhysRegIdPtr</span> <span class="n">phys_reg</span> <span class="o">=</span> <span class="n">freeList</span><span class="p">.</span><span class="n">getFloatReg</span><span class="p">();</span>
 <span class="mi">254</span>             <span class="n">renameMap</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">setEntry</span><span class="p">(</span><span class="n">RegId</span><span class="p">(</span><span class="n">FloatRegClass</span><span class="p">,</span> <span class="n">ridx</span><span class="p">),</span> <span class="n">phys_reg</span><span class="p">);</span>
 <span class="mi">255</span>             <span class="n">commitRenameMap</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">setEntry</span><span class="p">(</span>
 <span class="mi">256</span>                     <span class="n">RegId</span><span class="p">(</span><span class="n">FloatRegClass</span><span class="p">,</span> <span class="n">ridx</span><span class="p">),</span> <span class="n">phys_reg</span><span class="p">);</span>
 <span class="mi">257</span>         <span class="p">}</span>
 <span class="mi">258</span> 
 <span class="mi">259</span>         <span class="cm">/* Here we need two 'interfaces' the 'whole register' and the
 260          * 'register element'. At any point only one of them will be
 261          * active. */</span>
 <span class="mi">262</span>         <span class="nf">if</span> <span class="p">(</span><span class="n">vecMode</span> <span class="o">==</span> <span class="n">Enums</span><span class="o">::</span><span class="n">Full</span><span class="p">)</span> <span class="p">{</span>
 <span class="mi">263</span>             <span class="cm">/* Initialize the full-vector interface */</span>
 <span class="mi">264</span>             <span class="k">for</span> <span class="p">(</span><span class="n">RegIndex</span> <span class="n">ridx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ridx</span> <span class="o">&lt;</span> <span class="n">TheISA</span><span class="o">::</span><span class="n">NumVecRegs</span><span class="p">;</span> <span class="o">++</span><span class="n">ridx</span><span class="p">)</span> <span class="p">{</span>
 <span class="mi">265</span>                 <span class="n">RegId</span> <span class="n">rid</span> <span class="o">=</span> <span class="n">RegId</span><span class="p">(</span><span class="n">VecRegClass</span><span class="p">,</span> <span class="n">ridx</span><span class="p">);</span>
 <span class="mi">266</span>                 <span class="n">PhysRegIdPtr</span> <span class="n">phys_reg</span> <span class="o">=</span> <span class="n">freeList</span><span class="p">.</span><span class="n">getVecReg</span><span class="p">();</span>
 <span class="mi">267</span>                 <span class="n">renameMap</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">setEntry</span><span class="p">(</span><span class="n">rid</span><span class="p">,</span> <span class="n">phys_reg</span><span class="p">);</span>
 <span class="mi">268</span>                 <span class="n">commitRenameMap</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">setEntry</span><span class="p">(</span><span class="n">rid</span><span class="p">,</span> <span class="n">phys_reg</span><span class="p">);</span>
 <span class="mi">269</span>             <span class="p">}</span>
 <span class="mi">270</span>         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
 <span class="mi">271</span>             <span class="cm">/* Initialize the vector-element interface */</span>
 <span class="mi">272</span>             <span class="k">for</span> <span class="p">(</span><span class="n">RegIndex</span> <span class="n">ridx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ridx</span> <span class="o">&lt;</span> <span class="n">TheISA</span><span class="o">::</span><span class="n">NumVecRegs</span><span class="p">;</span> <span class="o">++</span><span class="n">ridx</span><span class="p">)</span> <span class="p">{</span>
 <span class="mi">273</span>                 <span class="k">for</span> <span class="p">(</span><span class="n">ElemIndex</span> <span class="n">ldx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ldx</span> <span class="o">&lt;</span> <span class="n">TheISA</span><span class="o">::</span><span class="n">NumVecElemPerVecReg</span><span class="p">;</span>
 <span class="mi">274</span>                         <span class="o">++</span><span class="n">ldx</span><span class="p">)</span> <span class="p">{</span>
 <span class="mi">275</span>                     <span class="n">RegId</span> <span class="n">lrid</span> <span class="o">=</span> <span class="n">RegId</span><span class="p">(</span><span class="n">VecElemClass</span><span class="p">,</span> <span class="n">ridx</span><span class="p">,</span> <span class="n">ldx</span><span class="p">);</span>
 <span class="mi">276</span>                     <span class="n">PhysRegIdPtr</span> <span class="n">phys_elem</span> <span class="o">=</span> <span class="n">freeList</span><span class="p">.</span><span class="n">getVecElem</span><span class="p">();</span>
 <span class="mi">277</span>                     <span class="n">renameMap</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">setEntry</span><span class="p">(</span><span class="n">lrid</span><span class="p">,</span> <span class="n">phys_elem</span><span class="p">);</span>
 <span class="mi">278</span>                     <span class="n">commitRenameMap</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">setEntry</span><span class="p">(</span><span class="n">lrid</span><span class="p">,</span> <span class="n">phys_elem</span><span class="p">);</span>
 <span class="mi">279</span>                 <span class="p">}</span>
 <span class="mi">280</span>             <span class="p">}</span>
 <span class="mi">281</span>         <span class="p">}</span>
 <span class="mi">282</span> 
 <span class="mi">283</span>         <span class="k">for</span> <span class="p">(</span><span class="n">RegIndex</span> <span class="n">ridx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ridx</span> <span class="o">&lt;</span> <span class="n">TheISA</span><span class="o">::</span><span class="n">NumVecPredRegs</span><span class="p">;</span> <span class="o">++</span><span class="n">ridx</span><span class="p">)</span> <span class="p">{</span>
 <span class="mi">284</span>             <span class="n">PhysRegIdPtr</span> <span class="n">phys_reg</span> <span class="o">=</span> <span class="n">freeList</span><span class="p">.</span><span class="n">getVecPredReg</span><span class="p">();</span>
 <span class="mi">285</span>             <span class="n">renameMap</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">setEntry</span><span class="p">(</span><span class="n">RegId</span><span class="p">(</span><span class="n">VecPredRegClass</span><span class="p">,</span> <span class="n">ridx</span><span class="p">),</span> <span class="n">phys_reg</span><span class="p">);</span>
 <span class="mi">286</span>             <span class="n">commitRenameMap</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">setEntry</span><span class="p">(</span>
 <span class="mi">287</span>                     <span class="n">RegId</span><span class="p">(</span><span class="n">VecPredRegClass</span><span class="p">,</span> <span class="n">ridx</span><span class="p">),</span> <span class="n">phys_reg</span><span class="p">);</span>
 <span class="mi">288</span>         <span class="p">}</span>
 <span class="mi">289</span> 
 <span class="mi">290</span>         <span class="k">for</span> <span class="p">(</span><span class="n">RegIndex</span> <span class="n">ridx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ridx</span> <span class="o">&lt;</span> <span class="n">TheISA</span><span class="o">::</span><span class="n">NumCCRegs</span><span class="p">;</span> <span class="o">++</span><span class="n">ridx</span><span class="p">)</span> <span class="p">{</span>
 <span class="mi">291</span>             <span class="n">PhysRegIdPtr</span> <span class="n">phys_reg</span> <span class="o">=</span> <span class="n">freeList</span><span class="p">.</span><span class="n">getCCReg</span><span class="p">();</span>
 <span class="mi">292</span>             <span class="n">renameMap</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">setEntry</span><span class="p">(</span><span class="n">RegId</span><span class="p">(</span><span class="n">CCRegClass</span><span class="p">,</span> <span class="n">ridx</span><span class="p">),</span> <span class="n">phys_reg</span><span class="p">);</span>
 <span class="mi">293</span>             <span class="n">commitRenameMap</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">setEntry</span><span class="p">(</span><span class="n">RegId</span><span class="p">(</span><span class="n">CCRegClass</span><span class="p">,</span> <span class="n">ridx</span><span class="p">),</span> <span class="n">phys_reg</span><span class="p">);</span>
 <span class="mi">294</span>         <span class="p">}</span>
 <span class="mi">295</span>     <span class="p">}</span>
 <span class="mi">296</span> 
 <span class="mi">297</span>     <span class="n">rename</span><span class="p">.</span><span class="n">setRenameMap</span><span class="p">(</span><span class="n">renameMap</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></div></div>
<p>The above code initialize all entries of the renameMap. 
When the setEntry is invoked through the UnifiedRenameMap, 
it invokes setEntry function of the SimpleRenameMap
for all register types of the O3 CPU.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
</pre></td><td class="rouge-code"><pre><span class="mi">302</span>     <span class="cm">/**
303      * Update rename map with a specific mapping.  Generally used to
304      * roll back to old mappings on a squash.  This version takes a
305      * flattened architectural register id and calls the
306      * appropriate class-specific rename table.
307      * @param arch_reg The architectural register to remap.
308      * @param phys_reg The physical register to remap it to.
309      */</span>
<span class="mi">310</span>     <span class="kt">void</span> <span class="nf">setEntry</span><span class="p">(</span><span class="k">const</span> <span class="n">RegId</span><span class="o">&amp;</span> <span class="n">arch_reg</span><span class="p">,</span> <span class="n">PhysRegIdPtr</span> <span class="n">phys_reg</span><span class="p">)</span>
<span class="mi">311</span>     <span class="p">{</span>
<span class="mi">312</span>         <span class="k">switch</span> <span class="p">(</span><span class="n">arch_reg</span><span class="p">.</span><span class="n">classValue</span><span class="p">())</span> <span class="p">{</span>
<span class="mi">313</span>           <span class="k">case</span> <span class="n">IntRegClass</span><span class="p">:</span>
<span class="mi">314</span>             <span class="n">assert</span><span class="p">(</span><span class="n">phys_reg</span><span class="o">-&gt;</span><span class="n">isIntPhysReg</span><span class="p">());</span>
<span class="mi">315</span>             <span class="k">return</span> <span class="n">intMap</span><span class="p">.</span><span class="n">setEntry</span><span class="p">(</span><span class="n">arch_reg</span><span class="p">,</span> <span class="n">phys_reg</span><span class="p">);</span>
<span class="mi">316</span> 
<span class="mi">317</span>           <span class="k">case</span> <span class="n">FloatRegClass</span><span class="p">:</span>
<span class="mi">318</span>             <span class="n">assert</span><span class="p">(</span><span class="n">phys_reg</span><span class="o">-&gt;</span><span class="n">isFloatPhysReg</span><span class="p">());</span>
<span class="mi">319</span>             <span class="k">return</span> <span class="n">floatMap</span><span class="p">.</span><span class="n">setEntry</span><span class="p">(</span><span class="n">arch_reg</span><span class="p">,</span> <span class="n">phys_reg</span><span class="p">);</span>
<span class="mi">320</span> 
<span class="mi">321</span>           <span class="k">case</span> <span class="n">VecRegClass</span><span class="p">:</span>
<span class="mi">322</span>             <span class="n">assert</span><span class="p">(</span><span class="n">phys_reg</span><span class="o">-&gt;</span><span class="n">isVectorPhysReg</span><span class="p">());</span>
<span class="mi">323</span>             <span class="n">assert</span><span class="p">(</span><span class="n">vecMode</span> <span class="o">==</span> <span class="n">Enums</span><span class="o">::</span><span class="n">Full</span><span class="p">);</span>
<span class="mi">324</span>             <span class="k">return</span> <span class="n">vecMap</span><span class="p">.</span><span class="n">setEntry</span><span class="p">(</span><span class="n">arch_reg</span><span class="p">,</span> <span class="n">phys_reg</span><span class="p">);</span>
<span class="mi">325</span> 
<span class="mi">326</span>           <span class="k">case</span> <span class="n">VecElemClass</span><span class="p">:</span>
<span class="mi">327</span>             <span class="n">assert</span><span class="p">(</span><span class="n">phys_reg</span><span class="o">-&gt;</span><span class="n">isVectorPhysElem</span><span class="p">());</span>
<span class="mi">328</span>             <span class="n">assert</span><span class="p">(</span><span class="n">vecMode</span> <span class="o">==</span> <span class="n">Enums</span><span class="o">::</span><span class="n">Elem</span><span class="p">);</span>
<span class="mi">329</span>             <span class="k">return</span> <span class="n">vecElemMap</span><span class="p">.</span><span class="n">setEntry</span><span class="p">(</span><span class="n">arch_reg</span><span class="p">,</span> <span class="n">phys_reg</span><span class="p">);</span>
<span class="mi">330</span> 
<span class="mi">331</span>           <span class="k">case</span> <span class="n">VecPredRegClass</span><span class="p">:</span>
<span class="mi">332</span>             <span class="n">assert</span><span class="p">(</span><span class="n">phys_reg</span><span class="o">-&gt;</span><span class="n">isVecPredPhysReg</span><span class="p">());</span>
<span class="mi">333</span>             <span class="k">return</span> <span class="n">predMap</span><span class="p">.</span><span class="n">setEntry</span><span class="p">(</span><span class="n">arch_reg</span><span class="p">,</span> <span class="n">phys_reg</span><span class="p">);</span>
<span class="mi">334</span> 
<span class="mi">335</span>           <span class="k">case</span> <span class="n">CCRegClass</span><span class="p">:</span>
<span class="mi">336</span>             <span class="n">assert</span><span class="p">(</span><span class="n">phys_reg</span><span class="o">-&gt;</span><span class="n">isCCPhysReg</span><span class="p">());</span>
<span class="mi">337</span>             <span class="k">return</span> <span class="n">ccMap</span><span class="p">.</span><span class="n">setEntry</span><span class="p">(</span><span class="n">arch_reg</span><span class="p">,</span> <span class="n">phys_reg</span><span class="p">);</span>
<span class="mi">338</span> 
<span class="mi">339</span>           <span class="k">case</span> <span class="n">MiscRegClass</span><span class="p">:</span>
<span class="mi">340</span>             <span class="c1">// Misc registers do not actually rename, so don't change</span>
<span class="mi">341</span>             <span class="c1">// their mappings.  We end up here when a commit or squash</span>
<span class="mi">342</span>             <span class="c1">// tries to update or undo a hardwired misc reg nmapping,</span>
<span class="mi">343</span>             <span class="c1">// which should always be setting it to what it already is.</span>
<span class="mi">344</span>             <span class="n">assert</span><span class="p">(</span><span class="n">phys_reg</span> <span class="o">==</span> <span class="n">lookup</span><span class="p">(</span><span class="n">arch_reg</span><span class="p">));</span>
<span class="mi">345</span>             <span class="k">return</span><span class="p">;</span>
<span class="mi">346</span> 
<span class="mi">347</span>           <span class="k">default</span><span class="o">:</span>
<span class="mi">348</span>             <span class="n">panic</span><span class="p">(</span><span class="s">"rename setEntry(): unknown reg class %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
<span class="mi">349</span>                   <span class="n">arch_reg</span><span class="p">.</span><span class="n">className</span><span class="p">());</span>
<span class="mi">350</span>         <span class="p">}</span>
<span class="mi">351</span>     <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>The setEntry inserts new entry to the renameMap. 
However, because UnifiedRenameMap is just a wrapper class 
consisting of multiple SimpleRenameMaps 
with different types of registers, 
it inserts an entry to associated SimpleRenameMaps object
based on the type of register.</p>

<h3 id="canrename-checks-availability-of-the-register-resource"><span class="me-2">canRename checks availability of the register resource.</span><a href="#canrename-checks-availability-of-the-register-resource" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre> <span class="mi">696</span>         <span class="c1">// Check here to make sure there are enough destination registers</span>
 <span class="mi">697</span>         <span class="c1">// to rename to.  Otherwise block.</span>
 <span class="mi">698</span>         <span class="nf">if</span> <span class="p">(</span><span class="o">!</span><span class="n">renameMap</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">canRename</span><span class="p">(</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">numIntDestRegs</span><span class="p">(),</span>
 <span class="mi">699</span>                                        <span class="n">inst</span><span class="o">-&gt;</span><span class="n">numFPDestRegs</span><span class="p">(),</span>
 <span class="mi">700</span>                                        <span class="n">inst</span><span class="o">-&gt;</span><span class="n">numVecDestRegs</span><span class="p">(),</span>
 <span class="mi">701</span>                                        <span class="n">inst</span><span class="o">-&gt;</span><span class="n">numVecElemDestRegs</span><span class="p">(),</span>
 <span class="mi">702</span>                                        <span class="n">inst</span><span class="o">-&gt;</span><span class="n">numVecPredDestRegs</span><span class="p">(),</span>
 <span class="mi">703</span>                                        <span class="n">inst</span><span class="o">-&gt;</span><span class="n">numCCDestRegs</span><span class="p">()))</span> <span class="p">{</span>
 <span class="mi">704</span>             <span class="n">DPRINTF</span><span class="p">(</span><span class="n">Rename</span><span class="p">,</span>
 <span class="mi">705</span>                     <span class="s">"Blocking due to "</span>
 <span class="mi">706</span>                     <span class="s">" lack of free physical registers to rename to.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
 <span class="mi">707</span>             <span class="n">blockThisCycle</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
 <span class="mi">708</span>             <span class="n">insts_to_rename</span><span class="p">.</span><span class="n">push_front</span><span class="p">(</span><span class="n">inst</span><span class="p">);</span>
 <span class="mi">709</span>             <span class="o">++</span><span class="n">renameFullRegistersEvents</span><span class="p">;</span>
 <span class="mi">710</span>
 <span class="mi">711</span>             <span class="k">break</span><span class="p">;</span>
 <span class="mi">712</span>         <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>
<p>Before the rename its registers, 
it first checks 
whether the current physical resources are available</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre>    <span class="cm">/**
     * Return whether there are enough registers to serve the request.
     */</span>
    <span class="kt">bool</span> <span class="nf">canRename</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">intRegs</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">floatRegs</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">vectorRegs</span><span class="p">,</span>
                   <span class="kt">uint32_t</span> <span class="n">vecElemRegs</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">vecPredRegs</span><span class="p">,</span>
                   <span class="kt">uint32_t</span> <span class="n">ccRegs</span><span class="p">)</span> <span class="k">const</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">intRegs</span> <span class="o">&lt;=</span> <span class="n">intMap</span><span class="p">.</span><span class="n">numFreeEntries</span><span class="p">()</span> <span class="o">&amp;&amp;</span>
            <span class="n">floatRegs</span> <span class="o">&lt;=</span> <span class="n">floatMap</span><span class="p">.</span><span class="n">numFreeEntries</span><span class="p">()</span> <span class="o">&amp;&amp;</span>
            <span class="n">vectorRegs</span> <span class="o">&lt;=</span> <span class="n">vecMap</span><span class="p">.</span><span class="n">numFreeEntries</span><span class="p">()</span> <span class="o">&amp;&amp;</span>
            <span class="n">vecElemRegs</span> <span class="o">&lt;=</span> <span class="n">vecElemMap</span><span class="p">.</span><span class="n">numFreeEntries</span><span class="p">()</span> <span class="o">&amp;&amp;</span>
            <span class="n">vecPredRegs</span> <span class="o">&lt;=</span> <span class="n">predMap</span><span class="p">.</span><span class="n">numFreeEntries</span><span class="p">()</span> <span class="o">&amp;&amp;</span>
            <span class="n">ccRegs</span> <span class="o">&lt;=</span> <span class="n">ccMap</span><span class="p">.</span><span class="n">numFreeEntries</span><span class="p">();</span>
    <span class="p">}</span>

</pre></td></tr></tbody></table></code></div></div>

<h2 id="handle-serialization-instruction"><span class="me-2">Handle serialization instruction</span><a href="#handle-serialization-instruction" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<p>If there is enough resources to rename instructions,
now it checks whether current instructions 
should be serialized or protected by the memory barriers.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
</pre></td><td class="rouge-code"><pre> <span class="mi">714</span>         <span class="c1">// Handle serializeAfter/serializeBefore instructions.</span>
 <span class="mi">715</span>         <span class="c1">// serializeAfter marks the next instruction as serializeBefore.</span>
 <span class="mi">716</span>         <span class="c1">// serializeBefore makes the instruction wait in rename until the ROB</span>
 <span class="mi">717</span>         <span class="c1">// is empty.</span>
 <span class="mi">718</span> 
 <span class="mi">719</span>         <span class="c1">// In this model, IPR accesses are serialize before</span>
 <span class="mi">720</span>         <span class="c1">// instructions, and store conditionals are serialize after</span>
 <span class="mi">721</span>         <span class="c1">// instructions.  This is mainly due to lack of support for</span>
 <span class="mi">722</span>         <span class="c1">// out-of-order operations of either of those classes of</span>
 <span class="mi">723</span>         <span class="c1">// instructions.</span>
 <span class="mi">724</span>         <span class="nf">if</span> <span class="p">((</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">isIprAccess</span><span class="p">()</span> <span class="o">||</span> <span class="n">inst</span><span class="o">-&gt;</span><span class="n">isSerializeBefore</span><span class="p">())</span> <span class="o">&amp;&amp;</span>
 <span class="mi">725</span>             <span class="o">!</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">isSerializeHandled</span><span class="p">())</span> <span class="p">{</span>
 <span class="mi">726</span>             <span class="n">DPRINTF</span><span class="p">(</span><span class="n">Rename</span><span class="p">,</span> <span class="s">"Serialize before instruction encountered.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
 <span class="mi">727</span> 
 <span class="mi">728</span>             <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">isTempSerializeBefore</span><span class="p">())</span> <span class="p">{</span>
 <span class="mi">729</span>                 <span class="n">renamedSerializing</span><span class="o">++</span><span class="p">;</span>
 <span class="mi">730</span>                 <span class="n">inst</span><span class="o">-&gt;</span><span class="n">setSerializeHandled</span><span class="p">();</span>
 <span class="mi">731</span>             <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
 <span class="mi">732</span>                 <span class="n">renamedTempSerializing</span><span class="o">++</span><span class="p">;</span>
 <span class="mi">733</span>             <span class="p">}</span>
 <span class="mi">734</span> 
 <span class="mi">735</span>             <span class="c1">// Change status over to SerializeStall so that other stages know</span>
 <span class="mi">736</span>             <span class="c1">// what this is blocked on.</span>
 <span class="mi">737</span>             <span class="n">renameStatus</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">=</span> <span class="n">SerializeStall</span><span class="p">;</span>
 <span class="mi">738</span> 
 <span class="mi">739</span>             <span class="n">serializeInst</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">=</span> <span class="n">inst</span><span class="p">;</span>
 <span class="mi">740</span> 
 <span class="mi">741</span>             <span class="n">blockThisCycle</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
 <span class="mi">742</span> 
 <span class="mi">743</span>             <span class="k">break</span><span class="p">;</span>
 <span class="mi">744</span>         <span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">((</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">isStoreConditional</span><span class="p">()</span> <span class="o">||</span> <span class="n">inst</span><span class="o">-&gt;</span><span class="n">isSerializeAfter</span><span class="p">())</span> <span class="o">&amp;&amp;</span>
 <span class="mi">745</span>                    <span class="o">!</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">isSerializeHandled</span><span class="p">())</span> <span class="p">{</span>
 <span class="mi">746</span>             <span class="n">DPRINTF</span><span class="p">(</span><span class="n">Rename</span><span class="p">,</span> <span class="s">"Serialize after instruction encountered.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
 <span class="mi">747</span> 
 <span class="mi">748</span>             <span class="n">renamedSerializing</span><span class="o">++</span><span class="p">;</span>
 <span class="mi">749</span> 
 <span class="mi">750</span>             <span class="n">inst</span><span class="o">-&gt;</span><span class="n">setSerializeHandled</span><span class="p">();</span>
 <span class="mi">751</span> 
 <span class="mi">752</span>             <span class="n">serializeAfter</span><span class="p">(</span><span class="n">insts_to_rename</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
 <span class="mi">753</span>         <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p><strong>StaticInst</strong> class has flags member field 
which represents properties of one instruction 
such as serializing, memory barrier, load operation, etc. 
Also, it has corresponding get methods to retrieve those flags 
from the StaticInst objects. 
Remember that all the instructions 
we generated at the fetch stage 
was the object of the StaticInst. 
Also, its flags are set 
based on the implementation of the microops of different architectures. 
Therefore, 
the rename stage determines 
whether it should block the stage or moves to the next instruction
by checking the isSerializeAfter and isSerializeBefore 
of the current static instruction,
Note that the serializeBefore means that 
the current instruction should be blocked.
Therefore, it sets current instruction as serializeInst (Line 739)
and status of the current rename stage as SerializeStall
and break the loop.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="mi">1431</span> <span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">Impl</span><span class="p">&gt;</span>
<span class="mi">1432</span> <span class="kt">void</span>
<span class="mi">1433</span> <span class="n">DefaultRename</span><span class="o">&lt;</span><span class="n">Impl</span><span class="o">&gt;::</span><span class="n">serializeAfter</span><span class="p">(</span><span class="n">InstQueue</span> <span class="o">&amp;</span><span class="n">inst_list</span><span class="p">,</span> <span class="n">ThreadID</span> <span class="n">tid</span><span class="p">)</span>
<span class="mi">1434</span> <span class="p">{</span>
<span class="mi">1435</span>     <span class="k">if</span> <span class="p">(</span><span class="n">inst_list</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
<span class="mi">1436</span>         <span class="c1">// Mark a bit to say that I must serialize on the next instruction.</span>
<span class="mi">1437</span>         <span class="n">serializeOnNextInst</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="mi">1438</span>         <span class="k">return</span><span class="p">;</span>
<span class="mi">1439</span>     <span class="p">}</span>
<span class="mi">1440</span> 
<span class="mi">1441</span>     <span class="c1">// Set the next instruction as serializing.</span>
<span class="mi">1442</span>     <span class="n">inst_list</span><span class="p">.</span><span class="n">front</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setSerializeBefore</span><span class="p">();</span>
<span class="mi">1443</span> <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>
<p>However, when the instruction has serializeAfter flag,
the next instruction after the current instruction should be blocked
not the current one. 
In this case we should consider two cases of the rename stage. 
When it has no instructions to be renamed after the current one,
we cannot set the next instruction to be serialized.
Therefore, just let the rename stage be aware of that
the next instruction should be serialized (Line 1437).
If there is another instruction in the queue, 
it directly set the flag of that instruction
by invoking setSerializeBefore function (1442).</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre> <span class="mi">627</span>     <span class="c1">// Handle serializing the next instruction if necessary.</span>
 <span class="mi">628</span>     <span class="nf">if</span> <span class="p">(</span><span class="n">serializeOnNextInst</span><span class="p">[</span><span class="n">tid</span><span class="p">])</span> <span class="p">{</span>
 <span class="mi">629</span>         <span class="k">if</span> <span class="p">(</span><span class="n">emptyROB</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">instsInProgress</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
 <span class="mi">630</span>             <span class="c1">// ROB already empty; no need to serialize.</span>
 <span class="mi">631</span>             <span class="n">serializeOnNextInst</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
 <span class="mi">632</span>         <span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="o">!</span><span class="n">insts_to_rename</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
 <span class="mi">633</span>             <span class="n">insts_to_rename</span><span class="p">.</span><span class="n">front</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setSerializeBefore</span><span class="p">();</span>
 <span class="mi">634</span>         <span class="p">}</span>
 <span class="mi">635</span>     <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>As shown in the above code (Line 632-633),
at the next clock cycle,
when the renameInsts function is executed,
it checks whether the serializeOnNextInst has been set.
which means that the last instruction was serializeAfter instruction 
at the previous clock cycle. 
In that case it sets the current instruction
to be renamed as serializeBefore to make serialization.</p>

<h3 id="wait-until-all-issued-instructions-are-resolved"><span class="me-2">Wait until all issued instructions are resolved</span><a href="#wait-until-all-issued-instructions-are-resolved" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>Remember that the tick function of the rename stage 
always check the signal before invoking the rename function.
This <strong>checkSignalsAndUpdate</strong> function 
checks whether the rename stage can be continued.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre></td><td class="rouge-code"><pre><span class="mi">1333</span> <span class="n">DefaultRename</span><span class="o">&lt;</span><span class="n">Impl</span><span class="o">&gt;::</span><span class="n">checkSignalsAndUpdate</span><span class="p">(</span><span class="n">ThreadID</span> <span class="n">tid</span><span class="p">)</span>
<span class="mi">1334</span> <span class="p">{</span>
<span class="mi">1335</span>     <span class="c1">// Check if there's a squash signal, squash if there is</span>
<span class="mi">1336</span>     <span class="c1">// Check stall signals, block if necessary.</span>
<span class="mi">1337</span>     <span class="c1">// If status was blocked</span>
<span class="mi">1338</span>     <span class="c1">//     check if stall conditions have passed</span>
<span class="mi">1339</span>     <span class="c1">//         if so then go to unblocking</span>
<span class="mi">1340</span>     <span class="c1">// If status was Squashing</span>
<span class="mi">1341</span>     <span class="c1">//     check if squashing is not high.  Switch to running this cycle.</span>
<span class="mi">1342</span>     <span class="c1">// If status was serialize stall</span>
<span class="mi">1343</span>     <span class="c1">//     check if ROB is empty and no insts are in flight to the ROB</span>
<span class="mi">1344</span> 
<span class="mi">1345</span>     <span class="n">readFreeEntries</span><span class="p">(</span><span class="n">tid</span><span class="p">);</span>
<span class="mi">1346</span>     <span class="n">readStallSignals</span><span class="p">(</span><span class="n">tid</span><span class="p">);</span>
<span class="mi">1347</span> 
<span class="mi">1348</span>     <span class="k">if</span> <span class="p">(</span><span class="n">fromCommit</span><span class="o">-&gt;</span><span class="n">commitInfo</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">squash</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">1349</span>         <span class="n">DPRINTF</span><span class="p">(</span><span class="n">Rename</span><span class="p">,</span> <span class="s">"[tid:%i] Squashing instructions due to squash from "</span>
<span class="mi">1350</span>                 <span class="s">"commit.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
<span class="mi">1351</span> 
<span class="mi">1352</span>         <span class="n">squash</span><span class="p">(</span><span class="n">fromCommit</span><span class="o">-&gt;</span><span class="n">commitInfo</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">doneSeqNum</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
<span class="mi">1353</span> 
<span class="mi">1354</span>         <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="mi">1355</span>     <span class="p">}</span>
<span class="mi">1356</span> 
<span class="mi">1357</span>     <span class="nf">if</span> <span class="p">(</span><span class="n">checkStall</span><span class="p">(</span><span class="n">tid</span><span class="p">))</span> <span class="p">{</span>
<span class="mi">1358</span>         <span class="k">return</span> <span class="n">block</span><span class="p">(</span><span class="n">tid</span><span class="p">);</span>
<span class="mi">1359</span>     <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>One of the important function of checkSignalsAndUpdate is 
<strong>checkStall</strong> function
that checks whether the current rename stage is ready to be free from the stall.
If the rename stage should be stalled more, 
then it returns false and continue to block 
the rename stage at current clock cycle (Line 1358). 
However, 
if it turns out that 
previous stall doesn’t block the rename stage further,
it tries to recover from the stall based on their previous stall reasons.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre></td><td class="rouge-code"><pre><span class="mi">1265</span> <span class="n">DefaultRename</span><span class="o">&lt;</span><span class="n">Impl</span><span class="o">&gt;::</span><span class="n">checkStall</span><span class="p">(</span><span class="n">ThreadID</span> <span class="n">tid</span><span class="p">)</span>
<span class="mi">1266</span> <span class="p">{</span>   
<span class="mi">1267</span>     <span class="kt">bool</span> <span class="n">ret_val</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="mi">1268</span>     
<span class="mi">1269</span>     <span class="k">if</span> <span class="p">(</span><span class="n">stalls</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">iew</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">1270</span>         <span class="n">DPRINTF</span><span class="p">(</span><span class="n">Rename</span><span class="p">,</span><span class="s">"[tid:%i] Stall from IEW stage detected.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
<span class="mi">1271</span>         <span class="n">ret_val</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="mi">1272</span>     <span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">calcFreeROBEntries</span><span class="p">(</span><span class="n">tid</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">1273</span>         <span class="n">DPRINTF</span><span class="p">(</span><span class="n">Rename</span><span class="p">,</span><span class="s">"[tid:%i] Stall: ROB has 0 free entries.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
<span class="mi">1274</span>         <span class="n">ret_val</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="mi">1275</span>     <span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">calcFreeIQEntries</span><span class="p">(</span><span class="n">tid</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">1276</span>         <span class="n">DPRINTF</span><span class="p">(</span><span class="n">Rename</span><span class="p">,</span><span class="s">"[tid:%i] Stall: IQ has 0 free entries.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
<span class="mi">1277</span>         <span class="n">ret_val</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="mi">1278</span>     <span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">calcFreeLQEntries</span><span class="p">(</span><span class="n">tid</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">calcFreeSQEntries</span><span class="p">(</span><span class="n">tid</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">1279</span>         <span class="n">DPRINTF</span><span class="p">(</span><span class="n">Rename</span><span class="p">,</span><span class="s">"[tid:%i] Stall: LSQ has 0 free entries.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
<span class="mi">1280</span>         <span class="n">ret_val</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="mi">1281</span>     <span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">renameMap</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">numFreeEntries</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">1282</span>         <span class="n">DPRINTF</span><span class="p">(</span><span class="n">Rename</span><span class="p">,</span><span class="s">"[tid:%i] Stall: RenameMap has 0 free entries.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
<span class="mi">1283</span>         <span class="n">ret_val</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="mi">1284</span>     <span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">renameStatus</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">==</span> <span class="n">SerializeStall</span> <span class="o">&amp;&amp;</span>
<span class="mi">1285</span>                <span class="p">(</span><span class="o">!</span><span class="n">emptyROB</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">||</span> <span class="n">instsInProgress</span><span class="p">[</span><span class="n">tid</span><span class="p">]))</span> <span class="p">{</span>
<span class="mi">1286</span>         <span class="n">DPRINTF</span><span class="p">(</span><span class="n">Rename</span><span class="p">,</span><span class="s">"[tid:%i] Stall: Serialize stall and ROB is not "</span>
<span class="mi">1287</span>                 <span class="s">"empty.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
<span class="mi">1288</span>                 <span class="n">tid</span><span class="p">);</span>
<span class="mi">1289</span>         <span class="n">ret_val</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="mi">1290</span>     <span class="p">}</span>
<span class="mi">1291</span>     
<span class="mi">1292</span>     <span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
<span class="mi">1293</span> <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>
<p>For example,
when the current renameStatus is SerializeStall,
the rename stage should not be executed again 
until all previous instruction in the pipeline 
will be dispatched to the execution units. 
Therefore, it invokes instsInProgress[tid]
to check whether current hardware thread 
still have some remaining instructions to process. 
When the all previous instructions are resolved,
it will return false and checkStall will return false.
If the checkStall returns false and doesn’t block the rename stage anymore,
it will try to recover from the stall 
based on their previous stall reasons.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre></td><td class="rouge-code"><pre><span class="mi">1395</span>     <span class="nf">if</span> <span class="p">(</span><span class="n">renameStatus</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">==</span> <span class="n">SerializeStall</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">1396</span>         <span class="c1">// Stall ends once the ROB is free.</span>
<span class="mi">1397</span>         <span class="n">DPRINTF</span><span class="p">(</span><span class="n">Rename</span><span class="p">,</span> <span class="s">"[tid:%i] Done with serialize stall, switching to "</span>
<span class="mi">1398</span>                 <span class="s">"unblocking.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
<span class="mi">1399</span>         
<span class="mi">1400</span>         <span class="n">DynInstPtr</span> <span class="n">serial_inst</span> <span class="o">=</span> <span class="n">serializeInst</span><span class="p">[</span><span class="n">tid</span><span class="p">];</span>
<span class="mi">1401</span>         
<span class="mi">1402</span>         <span class="n">renameStatus</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">=</span> <span class="n">Unblocking</span><span class="p">;</span>
<span class="mi">1403</span>         
<span class="mi">1404</span>         <span class="n">unblock</span><span class="p">(</span><span class="n">tid</span><span class="p">);</span>
<span class="mi">1405</span>         
<span class="mi">1406</span>         <span class="n">DPRINTF</span><span class="p">(</span><span class="n">Rename</span><span class="p">,</span> <span class="s">"[tid:%i] Processing instruction [%lli] with "</span>
<span class="mi">1407</span>                 <span class="s">"PC %s.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span> <span class="n">serial_inst</span><span class="o">-&gt;</span><span class="n">seqNum</span><span class="p">,</span> <span class="n">serial_inst</span><span class="o">-&gt;</span><span class="n">pcState</span><span class="p">());</span>
<span class="mi">1408</span>         
<span class="mi">1409</span>         <span class="c1">// Put instruction into queue here.</span>
<span class="mi">1410</span>         <span class="n">serial_inst</span><span class="o">-&gt;</span><span class="n">clearSerializeBefore</span><span class="p">();</span>
<span class="mi">1411</span>         
<span class="mi">1412</span>         <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skidBuffer</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
<span class="mi">1413</span>             <span class="n">skidBuffer</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">push_front</span><span class="p">(</span><span class="n">serial_inst</span><span class="p">);</span>
<span class="mi">1414</span>         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="mi">1415</span>             <span class="n">insts</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">push_front</span><span class="p">(</span><span class="n">serial_inst</span><span class="p">);</span>
<span class="mi">1416</span>         <span class="p">}</span>
<span class="mi">1417</span>         
<span class="mi">1418</span>         <span class="nf">DPRINTF</span><span class="p">(</span><span class="n">Rename</span><span class="p">,</span> <span class="s">"[tid:%i] Instruction must be processed by rename."</span>
<span class="mi">1419</span>                 <span class="s">" Adding to front of list.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
<span class="mi">1420</span>         
<span class="mi">1421</span>         <span class="n">serializeInst</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="mi">1422</span>         
<span class="mi">1423</span>         <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="mi">1424</span>     <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>For example, 
if the previous reason of stall was SerializeStall,
the Line 1395-1424 will be executed.
Note that the serialized instruction could not been executed 
until all previous instructions had been dispatched by the IEW stage.
Therefore, 
the serializing instruction should be reinserted 
into the instruction buffer of the rename stage (Line 1412-1416).
Also, it cleans up the serializeInst field of the rename stage (line 1421).
Next time when the rename stage is recovered from the unblocking stage,
it will process the serializing instruction that have stalled the rename stage.</p>

<h3 id="x86-in-gem5-provides-macro-setting-serialization"><span class="me-2">X86 in GEM5 provides macro setting serialization</span><a href="#x86-in-gem5-provides-macro-setting-serialization" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td class="rouge-code"><pre><span class="mi">147</span>         <span class="n">def</span> <span class="n">serializeBefore</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="o">:</span>
<span class="mi">148</span>             <span class="n">self</span><span class="p">.</span><span class="n">serialize_before</span> <span class="o">=</span> <span class="n">True</span>
<span class="mi">149</span>         <span class="n">def</span> <span class="n">serializeAfter</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="o">:</span>
<span class="mi">150</span>             <span class="n">self</span><span class="p">.</span><span class="n">serialize_after</span> <span class="o">=</span> <span class="n">True</span>
<span class="mi">151</span> 
<span class="mi">152</span>         <span class="n">def</span> <span class="n">function_call</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="o">:</span>
<span class="mi">153</span>             <span class="n">self</span><span class="p">.</span><span class="n">function_call</span> <span class="o">=</span> <span class="n">True</span>
<span class="mi">154</span>         <span class="n">def</span> <span class="n">function_return</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="o">:</span>
<span class="mi">155</span>             <span class="n">self</span><span class="p">.</span><span class="n">function_return</span> <span class="o">=</span> <span class="n">True</span>
<span class="mi">156</span> 
<span class="mi">157</span>         <span class="n">def</span> <span class="n">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span><span class="o">:</span>
<span class="mi">158</span>             <span class="n">super</span><span class="p">(</span><span class="n">X86Macroop</span><span class="p">,</span> <span class="n">self</span><span class="p">).</span><span class="n">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
<span class="mi">159</span>             <span class="n">self</span><span class="p">.</span><span class="n">directives</span> <span class="o">=</span> <span class="p">{</span>
<span class="mi">160</span>                 <span class="s">"adjust_env"</span> <span class="o">:</span> <span class="n">self</span><span class="p">.</span><span class="n">setAdjustEnv</span><span class="p">,</span>
<span class="mi">161</span>                 <span class="s">"adjust_imm"</span> <span class="o">:</span> <span class="n">self</span><span class="p">.</span><span class="n">adjustImm</span><span class="p">,</span>
<span class="mi">162</span>                 <span class="s">"adjust_disp"</span> <span class="o">:</span> <span class="n">self</span><span class="p">.</span><span class="n">adjustDisp</span><span class="p">,</span>
<span class="mi">163</span>                 <span class="s">"serialize_before"</span> <span class="o">:</span> <span class="n">self</span><span class="p">.</span><span class="n">serializeBefore</span><span class="p">,</span>
<span class="mi">164</span>                 <span class="s">"serialize_after"</span> <span class="o">:</span> <span class="n">self</span><span class="p">.</span><span class="n">serializeAfter</span><span class="p">,</span>
<span class="mi">165</span>                 <span class="s">"function_call"</span> <span class="o">:</span> <span class="n">self</span><span class="p">.</span><span class="n">function_call</span><span class="p">,</span>
<span class="mi">166</span>                 <span class="s">"function_return"</span> <span class="o">:</span> <span class="n">self</span><span class="p">.</span><span class="n">function_return</span>
<span class="mi">167</span>             <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>
<p>For macroop definition, 
when .serialize_before or .serialize_after keyword is found in their definition,
the GEM5 parser invokes the self.serializeBefore and self.serializeAfter function respectively 
to set the serialize_before and serialize_after memeber field as true.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre></td><td class="rouge-code"><pre><span class="mi">205</span>         <span class="n">def</span> <span class="n">getDefinition</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span><span class="o">:</span>
<span class="mi">206</span>             <span class="err">#</span><span class="n">FIXME</span> <span class="n">This</span> <span class="n">first</span> <span class="n">parameter</span> <span class="n">should</span> <span class="n">be</span> <span class="n">the</span> <span class="n">mnemonic</span><span class="p">.</span> <span class="n">I</span> <span class="n">need</span> <span class="n">to</span>
<span class="mi">207</span>             <span class="err">#</span><span class="n">write</span> <span class="n">some</span> <span class="n">code</span> <span class="n">which</span> <span class="n">pulls</span> <span class="n">that</span> <span class="n">out</span>
<span class="mi">208</span>             <span class="n">numMicroops</span> <span class="o">=</span> <span class="n">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">microops</span><span class="p">)</span>
<span class="mi">209</span>             <span class="n">allocMicroops</span> <span class="o">=</span> <span class="err">''</span>
<span class="mi">210</span>             <span class="n">micropc</span> <span class="o">=</span> <span class="mi">0</span>
<span class="mi">211</span>             <span class="k">for</span> <span class="n">op</span> <span class="n">in</span> <span class="n">self</span><span class="p">.</span><span class="n">microops</span><span class="o">:</span>
<span class="mi">212</span>                 <span class="n">flags</span> <span class="o">=</span> <span class="p">[</span><span class="s">"IsMicroop"</span><span class="p">]</span>
<span class="mi">213</span>                 <span class="k">if</span> <span class="n">micropc</span> <span class="o">==</span> <span class="mi">0</span><span class="o">:</span>
<span class="mi">214</span>                     <span class="n">flags</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">"IsFirstMicroop"</span><span class="p">)</span>
<span class="mi">215</span> 
<span class="mi">216</span>                     <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">serialize_before</span><span class="o">:</span>
<span class="mi">217</span>                         <span class="n">flags</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">"IsSerializing"</span><span class="p">)</span>
<span class="mi">218</span>                         <span class="n">flags</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">"IsSerializeBefore"</span><span class="p">)</span>
<span class="mi">219</span> 
<span class="mi">220</span>                 <span class="k">if</span> <span class="n">micropc</span> <span class="o">==</span> <span class="n">numMicroops</span> <span class="o">-</span> <span class="mi">1</span><span class="o">:</span>
<span class="mi">221</span>                     <span class="n">flags</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">"IsLastMicroop"</span><span class="p">)</span>
<span class="mi">222</span> 
<span class="mi">223</span>                     <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">serialize_after</span><span class="o">:</span>
<span class="mi">224</span>                         <span class="n">flags</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">"IsSerializing"</span><span class="p">)</span>
<span class="mi">225</span>                         <span class="n">flags</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">"IsSerializeAfter"</span><span class="p">)</span>
<span class="mi">226</span> 
<span class="mi">227</span>                     <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">function_call</span><span class="o">:</span>
<span class="mi">228</span>                         <span class="n">flags</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">"IsCall"</span><span class="p">)</span>
<span class="mi">229</span>                         <span class="n">flags</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">"IsUncondControl"</span><span class="p">)</span>
<span class="mi">230</span>                     <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">function_return</span><span class="o">:</span>
<span class="mi">231</span>                         <span class="n">flags</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">"IsReturn"</span><span class="p">)</span>
<span class="mi">232</span>                         <span class="n">flags</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">"IsUncondControl"</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></div></div>
<p>When the macroop definition is automatically generated, 
it checks those two flags and set IsSerializeBefore to the first microop 
and IsSerializeAfter to the last microop 
consisting of the macroop.</p>

<h2 id="rename-registers-and-pass-the-renamed-instruction-to-the-next-stage"><span class="me-2">Rename registers and pass the renamed instruction to the next stage</span><a href="#rename-registers-and-pass-the-renamed-instruction-to-the-next-stage" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<p>After handling serialization instruction, 
it should rename registers of the instruction.</p>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre></td><td class="rouge-code"><pre> <span class="mi">755</span>         <span class="nf">renameSrcRegs</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span> <span class="n">inst</span><span class="o">-&gt;</span><span class="n">threadNumber</span><span class="p">);</span>
 <span class="mi">756</span> 
 <span class="mi">757</span>         <span class="nf">renameDestRegs</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span> <span class="n">inst</span><span class="o">-&gt;</span><span class="n">threadNumber</span><span class="p">);</span>
 <span class="mi">758</span> 
 <span class="mi">759</span>         <span class="nf">if</span> <span class="p">(</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">isAtomic</span><span class="p">()</span> <span class="o">||</span> <span class="n">inst</span><span class="o">-&gt;</span><span class="n">isStore</span><span class="p">())</span> <span class="p">{</span>
 <span class="mi">760</span>             <span class="n">storesInProgress</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
 <span class="mi">761</span>         <span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">isLoad</span><span class="p">())</span> <span class="p">{</span>
 <span class="mi">762</span>             <span class="n">loadsInProgress</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
 <span class="mi">763</span>         <span class="p">}</span>
 <span class="mi">764</span> 
 <span class="mi">765</span>         <span class="o">++</span><span class="n">renamed_insts</span><span class="p">;</span>
 <span class="mi">766</span>         <span class="c1">// Notify potential listeners that source and destination registers for</span>
 <span class="mi">767</span>         <span class="c1">// this instruction have been renamed.</span>
 <span class="mi">768</span>         <span class="n">ppRename</span><span class="o">-&gt;</span><span class="n">notify</span><span class="p">(</span><span class="n">inst</span><span class="p">);</span>
 <span class="mi">769</span> 
 <span class="mi">770</span>         <span class="c1">// Put instruction in rename queue.</span>
 <span class="mi">771</span>         <span class="n">toIEW</span><span class="o">-&gt;</span><span class="n">insts</span><span class="p">[</span><span class="n">toIEWIndex</span><span class="p">]</span> <span class="o">=</span> <span class="n">inst</span><span class="p">;</span>
 <span class="mi">772</span>         <span class="o">++</span><span class="p">(</span><span class="n">toIEW</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
 <span class="mi">773</span> 
 <span class="mi">774</span>         <span class="c1">// Increment which instruction we're on.</span>
 <span class="mi">775</span>         <span class="o">++</span><span class="n">toIEWIndex</span><span class="p">;</span>
 <span class="mi">776</span> 
 <span class="mi">777</span>         <span class="c1">// Decrement how many instructions are available.</span>
 <span class="mi">778</span>         <span class="o">--</span><span class="n">insts_available</span><span class="p">;</span>
 <span class="mi">779</span>     <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="renamesrcregs"><span class="me-2">renameSrcRegs</span><a href="#renamesrcregs" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
</pre></td><td class="rouge-code"><pre><span class="mi">1064</span> <span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">Impl</span><span class="p">&gt;</span>
<span class="mi">1065</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="mi">1066</span> <span class="n">DefaultRename</span><span class="o">&lt;</span><span class="n">Impl</span><span class="o">&gt;::</span><span class="n">renameSrcRegs</span><span class="p">(</span><span class="k">const</span> <span class="n">DynInstPtr</span> <span class="o">&amp;</span><span class="n">inst</span><span class="p">,</span> <span class="n">ThreadID</span> <span class="n">tid</span><span class="p">)</span>
<span class="mi">1067</span> <span class="p">{</span>
<span class="mi">1068</span>     <span class="n">ThreadContext</span> <span class="o">*</span><span class="n">tc</span> <span class="o">=</span> <span class="n">inst</span><span class="o">-&gt;</span><span class="n">tcBase</span><span class="p">();</span>
<span class="mi">1069</span>     <span class="n">RenameMap</span> <span class="o">*</span><span class="n">map</span> <span class="o">=</span> <span class="n">renameMap</span><span class="p">[</span><span class="n">tid</span><span class="p">];</span>
<span class="mi">1070</span>     <span class="kt">unsigned</span> <span class="n">num_src_regs</span> <span class="o">=</span> <span class="n">inst</span><span class="o">-&gt;</span><span class="n">numSrcRegs</span><span class="p">();</span>
<span class="mi">1071</span> 
<span class="mi">1072</span>     <span class="c1">// Get the architectual register numbers from the source and</span>
<span class="mi">1073</span>     <span class="c1">// operands, and redirect them to the right physical register.</span>
<span class="mi">1074</span>     <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">src_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">src_idx</span> <span class="o">&lt;</span> <span class="n">num_src_regs</span><span class="p">;</span> <span class="n">src_idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">1075</span>         <span class="k">const</span> <span class="n">RegId</span><span class="o">&amp;</span> <span class="n">src_reg</span> <span class="o">=</span> <span class="n">inst</span><span class="o">-&gt;</span><span class="n">srcRegIdx</span><span class="p">(</span><span class="n">src_idx</span><span class="p">);</span>
<span class="mi">1076</span>         <span class="n">PhysRegIdPtr</span> <span class="n">renamed_reg</span><span class="p">;</span>
<span class="mi">1077</span> 
<span class="mi">1078</span>         <span class="n">renamed_reg</span> <span class="o">=</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">lookup</span><span class="p">(</span><span class="n">tc</span><span class="o">-&gt;</span><span class="n">flattenRegId</span><span class="p">(</span><span class="n">src_reg</span><span class="p">));</span>
<span class="mi">1079</span>         <span class="k">switch</span> <span class="p">(</span><span class="n">src_reg</span><span class="p">.</span><span class="n">classValue</span><span class="p">())</span> <span class="p">{</span>
<span class="mi">1080</span>           <span class="k">case</span> <span class="n">IntRegClass</span><span class="p">:</span>
<span class="mi">1081</span>             <span class="n">intRenameLookups</span><span class="o">++</span><span class="p">;</span>
<span class="mi">1082</span>             <span class="k">break</span><span class="p">;</span>
<span class="mi">1083</span>           <span class="k">case</span> <span class="n">FloatRegClass</span><span class="p">:</span>
<span class="mi">1084</span>             <span class="n">fpRenameLookups</span><span class="o">++</span><span class="p">;</span>
<span class="mi">1085</span>             <span class="k">break</span><span class="p">;</span>
<span class="mi">1086</span>           <span class="k">case</span> <span class="n">VecRegClass</span><span class="p">:</span>
<span class="mi">1087</span>           <span class="k">case</span> <span class="n">VecElemClass</span><span class="p">:</span>
<span class="mi">1088</span>             <span class="n">vecRenameLookups</span><span class="o">++</span><span class="p">;</span>
<span class="mi">1089</span>             <span class="k">break</span><span class="p">;</span>
<span class="mi">1090</span>           <span class="k">case</span> <span class="n">VecPredRegClass</span><span class="p">:</span>
<span class="mi">1091</span>             <span class="n">vecPredRenameLookups</span><span class="o">++</span><span class="p">;</span>
<span class="mi">1092</span>             <span class="k">break</span><span class="p">;</span>
<span class="mi">1093</span>           <span class="k">case</span> <span class="n">CCRegClass</span><span class="p">:</span>
<span class="mi">1094</span>           <span class="k">case</span> <span class="n">MiscRegClass</span><span class="p">:</span>
<span class="mi">1095</span>             <span class="k">break</span><span class="p">;</span>
<span class="mi">1096</span> 
<span class="mi">1097</span>           <span class="k">default</span><span class="o">:</span>
<span class="mi">1098</span>             <span class="n">panic</span><span class="p">(</span><span class="s">"Invalid register class: %d."</span><span class="p">,</span> <span class="n">src_reg</span><span class="p">.</span><span class="n">classValue</span><span class="p">());</span>
<span class="mi">1099</span>         <span class="p">}</span>
<span class="mi">1100</span> 
<span class="mi">1101</span>         <span class="nf">DPRINTF</span><span class="p">(</span><span class="n">Rename</span><span class="p">,</span>
<span class="mi">1102</span>                 <span class="s">"[tid:%i] "</span>
<span class="mi">1103</span>                 <span class="s">"Looking up %s arch reg %i, got phys reg %i (%s)</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
<span class="mi">1104</span>                 <span class="n">tid</span><span class="p">,</span> <span class="n">src_reg</span><span class="p">.</span><span class="n">className</span><span class="p">(),</span>
<span class="mi">1105</span>                 <span class="n">src_reg</span><span class="p">.</span><span class="n">index</span><span class="p">(),</span> <span class="n">renamed_reg</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">(),</span>
<span class="mi">1106</span>                 <span class="n">renamed_reg</span><span class="o">-&gt;</span><span class="n">className</span><span class="p">());</span>
<span class="mi">1107</span> 
<span class="mi">1108</span>         <span class="n">inst</span><span class="o">-&gt;</span><span class="n">renameSrcReg</span><span class="p">(</span><span class="n">src_idx</span><span class="p">,</span> <span class="n">renamed_reg</span><span class="p">);</span>
<span class="mi">1109</span> 
<span class="mi">1110</span>         <span class="c1">// See if the register is ready or not.</span>
<span class="mi">1111</span>         <span class="nf">if</span> <span class="p">(</span><span class="n">scoreboard</span><span class="o">-&gt;</span><span class="n">getReg</span><span class="p">(</span><span class="n">renamed_reg</span><span class="p">))</span> <span class="p">{</span>
<span class="mi">1112</span>             <span class="n">DPRINTF</span><span class="p">(</span><span class="n">Rename</span><span class="p">,</span>
<span class="mi">1113</span>                     <span class="s">"[tid:%i] "</span>
<span class="mi">1114</span>                     <span class="s">"Register %d (flat: %d) (%s) is ready.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
<span class="mi">1115</span>                     <span class="n">tid</span><span class="p">,</span> <span class="n">renamed_reg</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">(),</span> <span class="n">renamed_reg</span><span class="o">-&gt;</span><span class="n">flatIndex</span><span class="p">(),</span>
<span class="mi">1116</span>                     <span class="n">renamed_reg</span><span class="o">-&gt;</span><span class="n">className</span><span class="p">());</span>
<span class="mi">1117</span> 
<span class="mi">1118</span>             <span class="n">inst</span><span class="o">-&gt;</span><span class="n">markSrcRegReady</span><span class="p">(</span><span class="n">src_idx</span><span class="p">);</span>
<span class="mi">1119</span>         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="mi">1120</span>             <span class="n">DPRINTF</span><span class="p">(</span><span class="n">Rename</span><span class="p">,</span>
<span class="mi">1121</span>                     <span class="s">"[tid:%i] "</span>
<span class="mi">1122</span>                     <span class="s">"Register %d (flat: %d) (%s) is not ready.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
<span class="mi">1123</span>                     <span class="n">tid</span><span class="p">,</span> <span class="n">renamed_reg</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">(),</span> <span class="n">renamed_reg</span><span class="o">-&gt;</span><span class="n">flatIndex</span><span class="p">(),</span>
<span class="mi">1124</span>                     <span class="n">renamed_reg</span><span class="o">-&gt;</span><span class="n">className</span><span class="p">());</span>
<span class="mi">1125</span>         <span class="p">}</span>
<span class="mi">1126</span> 
<span class="mi">1127</span>         <span class="o">++</span><span class="n">renameRenameLookups</span><span class="p">;</span>
<span class="mi">1128</span>     <span class="p">}</span>
<span class="mi">1129</span> <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>
<p>The main operation of the renameSrcRegs is to look up register map 
and find out if the architecture registers used as the current instruction’s source 
have been renamed to the another physical registers. 
If it has been renamed to other physical registers,
it should consider those registers instead of the 
architectural registers in the rest of the rename stages. 
This mapping will be stored in the instruction
through the renameSrcReg function (Line 1108).</p>

<h3 id="lookup-renamemap-to-find-physical-register-if-it-has-been-renamed"><span class="me-2">lookup renameMap to find physical register if it has been renamed</span><a href="#lookup-renamemap-to-find-physical-register-if-it-has-been-renamed" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
</pre></td><td class="rouge-code"><pre> <span class="mi">66</span> <span class="k">class</span> <span class="nc">SimpleRenameMap</span>
 <span class="mi">67</span> <span class="p">{</span>
<span class="p">......</span>
<span class="mi">122</span>     <span class="cm">/**
123      * Look up the physical register mapped to an architectural register.
124      * @param arch_reg The architectural register to look up.
125      * @return The physical register it is currently mapped to.
126      */</span>
<span class="mi">127</span>     <span class="n">PhysRegIdPtr</span> <span class="n">lookup</span><span class="p">(</span><span class="k">const</span> <span class="n">RegId</span><span class="o">&amp;</span> <span class="n">arch_reg</span><span class="p">)</span> <span class="k">const</span>
<span class="mi">128</span>     <span class="p">{</span>
<span class="mi">129</span>         <span class="n">assert</span><span class="p">(</span><span class="n">arch_reg</span><span class="p">.</span><span class="n">flatIndex</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">map</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
<span class="mi">130</span>         <span class="k">return</span> <span class="n">map</span><span class="p">[</span><span class="n">arch_reg</span><span class="p">.</span><span class="n">flatIndex</span><span class="p">()];</span>
<span class="mi">131</span>     <span class="p">}</span>
<span class="p">......</span>
<span class="mi">170</span> <span class="k">class</span> <span class="nc">UnifiedRenameMap</span>
<span class="mi">171</span> <span class="p">{</span>
<span class="p">......</span>
<span class="mi">261</span>     <span class="cm">/**
262      * Look up the physical register mapped to an architectural register.
263      * This version takes a flattened architectural register id
264      * and calls the appropriate class-specific rename table.
265      * @param arch_reg The architectural register to look up.
266      * @return The physical register it is currently mapped to.
267      */</span>
<span class="mi">268</span>     <span class="n">PhysRegIdPtr</span> <span class="n">lookup</span><span class="p">(</span><span class="k">const</span> <span class="n">RegId</span><span class="o">&amp;</span> <span class="n">arch_reg</span><span class="p">)</span> <span class="k">const</span>
<span class="mi">269</span>     <span class="p">{</span>
<span class="mi">270</span>         <span class="k">switch</span> <span class="p">(</span><span class="n">arch_reg</span><span class="p">.</span><span class="n">classValue</span><span class="p">())</span> <span class="p">{</span>
<span class="mi">271</span>           <span class="k">case</span> <span class="n">IntRegClass</span><span class="p">:</span>
<span class="mi">272</span>             <span class="k">return</span> <span class="n">intMap</span><span class="p">.</span><span class="n">lookup</span><span class="p">(</span><span class="n">arch_reg</span><span class="p">);</span>
<span class="mi">273</span> 
<span class="mi">274</span>           <span class="k">case</span> <span class="n">FloatRegClass</span><span class="p">:</span>
<span class="mi">275</span>             <span class="k">return</span>  <span class="n">floatMap</span><span class="p">.</span><span class="n">lookup</span><span class="p">(</span><span class="n">arch_reg</span><span class="p">);</span>
<span class="mi">276</span> 
<span class="mi">277</span>           <span class="k">case</span> <span class="n">VecRegClass</span><span class="p">:</span>
<span class="mi">278</span>             <span class="n">assert</span><span class="p">(</span><span class="n">vecMode</span> <span class="o">==</span> <span class="n">Enums</span><span class="o">::</span><span class="n">Full</span><span class="p">);</span>
<span class="mi">279</span>             <span class="k">return</span>  <span class="n">vecMap</span><span class="p">.</span><span class="n">lookup</span><span class="p">(</span><span class="n">arch_reg</span><span class="p">);</span>
<span class="mi">280</span> 
<span class="mi">281</span>           <span class="k">case</span> <span class="n">VecElemClass</span><span class="p">:</span>
<span class="mi">282</span>             <span class="n">assert</span><span class="p">(</span><span class="n">vecMode</span> <span class="o">==</span> <span class="n">Enums</span><span class="o">::</span><span class="n">Elem</span><span class="p">);</span>
<span class="mi">283</span>             <span class="k">return</span>  <span class="n">vecElemMap</span><span class="p">.</span><span class="n">lookup</span><span class="p">(</span><span class="n">arch_reg</span><span class="p">);</span>
<span class="mi">284</span> 
<span class="mi">285</span>           <span class="k">case</span> <span class="n">VecPredRegClass</span><span class="p">:</span>
<span class="mi">286</span>             <span class="k">return</span> <span class="n">predMap</span><span class="p">.</span><span class="n">lookup</span><span class="p">(</span><span class="n">arch_reg</span><span class="p">);</span>
<span class="mi">287</span> 
<span class="mi">288</span>           <span class="k">case</span> <span class="n">CCRegClass</span><span class="p">:</span>
<span class="mi">289</span>             <span class="k">return</span> <span class="n">ccMap</span><span class="p">.</span><span class="n">lookup</span><span class="p">(</span><span class="n">arch_reg</span><span class="p">);</span>
<span class="mi">290</span> 
<span class="mi">291</span>           <span class="k">case</span> <span class="n">MiscRegClass</span><span class="p">:</span>
<span class="mi">292</span>             <span class="c1">// misc regs aren't really renamed, they keep the same</span>
<span class="mi">293</span>             <span class="c1">// mapping throughout the execution.</span>
<span class="mi">294</span>             <span class="k">return</span> <span class="n">regFile</span><span class="o">-&gt;</span><span class="n">getMiscRegId</span><span class="p">(</span><span class="n">arch_reg</span><span class="p">.</span><span class="n">flatIndex</span><span class="p">());</span>
<span class="mi">295</span> 
<span class="mi">296</span>           <span class="k">default</span><span class="o">:</span>
<span class="mi">297</span>             <span class="n">panic</span><span class="p">(</span><span class="s">"rename lookup(): unknown reg class %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
<span class="mi">298</span>                   <span class="n">arch_reg</span><span class="p">.</span><span class="n">className</span><span class="p">());</span>
<span class="mi">299</span>         <span class="p">}</span>
<span class="mi">300</span>     <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>
<p>If it has been renamed already, 
the <strong>lookup</strong> function returns actual physical register 
to which the architecture register has been mapped.
The map used in the rename stage is UnifiedRenameMap and 
contains multiple SimpleRenameMap with the various register type.
Therefore, it first invokes the lookup function of the UnifiedRenameMap,
and further invokes the lookup function of the SimpleRenameMap 
depending on the register type that we are trying to rename.</p>

<h3 id="check-scoreboard"><span class="me-2">check scoreboard</span><a href="#check-scoreboard" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>After the lookup, it checks the scoreboard 
if the target registers are available to be read.
Note that the renamed register is passed to the scoreboard, getReg.
O3 is out-of-order processor and renames the registers
to eliminate register dependency such as write after read.
The scoreboard let the processor know 
when the register is ready to be accessed. 
Particularly, the getReg interface of the scoreboard can check 
whether specific phyiscal register is currently available.
If it returns true, 
it means that the asked register is ready to be used. 
It invokes the markSrcRegReady function (Line 1118)
to mark that operand of instruction is ready to be used. 
Also, it sets the instruction to be issued 
when all operands of that instructions are ready.
However, if the getReg returns false, 
it means that one source register is not available at that cycle, so 
it should not set the flag and make the instruction to wait 
until the register is ready. 
The scoreboard and its interfaces will be described in the <a href="">below section</a>.</p>

<h3 id="renamedestregs"><span class="me-2">renameDestRegs</span><a href="#renamedestregs" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
</pre></td><td class="rouge-code"><pre><span class="mi">1131</span> <span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">Impl</span><span class="p">&gt;</span>
<span class="mi">1132</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="mi">1133</span> <span class="n">DefaultRename</span><span class="o">&lt;</span><span class="n">Impl</span><span class="o">&gt;::</span><span class="n">renameDestRegs</span><span class="p">(</span><span class="k">const</span> <span class="n">DynInstPtr</span> <span class="o">&amp;</span><span class="n">inst</span><span class="p">,</span> <span class="n">ThreadID</span> <span class="n">tid</span><span class="p">)</span>
<span class="mi">1134</span> <span class="p">{</span>
<span class="mi">1135</span>     <span class="n">ThreadContext</span> <span class="o">*</span><span class="n">tc</span> <span class="o">=</span> <span class="n">inst</span><span class="o">-&gt;</span><span class="n">tcBase</span><span class="p">();</span>
<span class="mi">1136</span>     <span class="n">RenameMap</span> <span class="o">*</span><span class="n">map</span> <span class="o">=</span> <span class="n">renameMap</span><span class="p">[</span><span class="n">tid</span><span class="p">];</span>
<span class="mi">1137</span>     <span class="kt">unsigned</span> <span class="n">num_dest_regs</span> <span class="o">=</span> <span class="n">inst</span><span class="o">-&gt;</span><span class="n">numDestRegs</span><span class="p">();</span>
<span class="mi">1138</span> 
<span class="mi">1139</span>     <span class="c1">// Rename the destination registers.</span>
<span class="mi">1140</span>     <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">dest_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">dest_idx</span> <span class="o">&lt;</span> <span class="n">num_dest_regs</span><span class="p">;</span> <span class="n">dest_idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">1141</span>         <span class="k">const</span> <span class="n">RegId</span><span class="o">&amp;</span> <span class="n">dest_reg</span> <span class="o">=</span> <span class="n">inst</span><span class="o">-&gt;</span><span class="n">destRegIdx</span><span class="p">(</span><span class="n">dest_idx</span><span class="p">);</span>
<span class="mi">1142</span>         <span class="k">typename</span> <span class="n">RenameMap</span><span class="o">::</span><span class="n">RenameInfo</span> <span class="n">rename_result</span><span class="p">;</span>
<span class="mi">1143</span> 
<span class="mi">1144</span>         <span class="n">RegId</span> <span class="n">flat_dest_regid</span> <span class="o">=</span> <span class="n">tc</span><span class="o">-&gt;</span><span class="n">flattenRegId</span><span class="p">(</span><span class="n">dest_reg</span><span class="p">);</span>
<span class="mi">1145</span>         <span class="n">flat_dest_regid</span><span class="p">.</span><span class="n">setNumPinnedWrites</span><span class="p">(</span><span class="n">dest_reg</span><span class="p">.</span><span class="n">getNumPinnedWrites</span><span class="p">());</span>
<span class="mi">1146</span> 
<span class="mi">1147</span>         <span class="n">rename_result</span> <span class="o">=</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">rename</span><span class="p">(</span><span class="n">flat_dest_regid</span><span class="p">);</span>
<span class="mi">1148</span> 
<span class="mi">1149</span>         <span class="n">inst</span><span class="o">-&gt;</span><span class="n">flattenDestReg</span><span class="p">(</span><span class="n">dest_idx</span><span class="p">,</span> <span class="n">flat_dest_regid</span><span class="p">);</span>
<span class="mi">1150</span> 
<span class="mi">1151</span>         <span class="n">scoreboard</span><span class="o">-&gt;</span><span class="n">unsetReg</span><span class="p">(</span><span class="n">rename_result</span><span class="p">.</span><span class="n">first</span><span class="p">);</span>
<span class="mi">1152</span> 
<span class="mi">1153</span>         <span class="n">DPRINTF</span><span class="p">(</span><span class="n">Rename</span><span class="p">,</span>
<span class="mi">1154</span>                 <span class="s">"[tid:%i] "</span>
<span class="mi">1155</span>                 <span class="s">"Renaming arch reg %i (%s) to physical reg %i (%i).</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
<span class="mi">1156</span>                 <span class="n">tid</span><span class="p">,</span> <span class="n">dest_reg</span><span class="p">.</span><span class="n">index</span><span class="p">(),</span> <span class="n">dest_reg</span><span class="p">.</span><span class="n">className</span><span class="p">(),</span>
<span class="mi">1157</span>                 <span class="n">rename_result</span><span class="p">.</span><span class="n">first</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">(),</span>
<span class="mi">1158</span>                 <span class="n">rename_result</span><span class="p">.</span><span class="n">first</span><span class="o">-&gt;</span><span class="n">flatIndex</span><span class="p">());</span>
<span class="mi">1159</span> 
<span class="mi">1160</span>         <span class="c1">// Record the rename information so that a history can be kept.</span>
<span class="mi">1161</span>         <span class="n">RenameHistory</span> <span class="n">hb_entry</span><span class="p">(</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">seqNum</span><span class="p">,</span> <span class="n">flat_dest_regid</span><span class="p">,</span>
<span class="mi">1162</span>                                <span class="n">rename_result</span><span class="p">.</span><span class="n">first</span><span class="p">,</span>
<span class="mi">1163</span>                                <span class="n">rename_result</span><span class="p">.</span><span class="n">second</span><span class="p">);</span>
<span class="mi">1164</span> 
<span class="mi">1165</span>         <span class="n">historyBuffer</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">push_front</span><span class="p">(</span><span class="n">hb_entry</span><span class="p">);</span>
<span class="mi">1166</span> 
<span class="mi">1167</span>         <span class="n">DPRINTF</span><span class="p">(</span><span class="n">Rename</span><span class="p">,</span> <span class="s">"[tid:%i] [sn:%llu] "</span>
<span class="mi">1168</span>                 <span class="s">"Adding instruction to history buffer (size=%i).</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
<span class="mi">1169</span>                 <span class="n">tid</span><span class="p">,(</span><span class="o">*</span><span class="n">historyBuffer</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">begin</span><span class="p">()).</span><span class="n">instSeqNum</span><span class="p">,</span>
<span class="mi">1170</span>                 <span class="n">historyBuffer</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">size</span><span class="p">());</span>
<span class="mi">1171</span> 
<span class="mi">1172</span>         <span class="c1">// Tell the instruction to rename the appropriate destination</span>
<span class="mi">1173</span>         <span class="c1">// register (dest_idx) to the new physical register</span>
<span class="mi">1174</span>         <span class="c1">// (rename_result.first), and record the previous physical</span>
<span class="mi">1175</span>         <span class="c1">// register that the same logical register was renamed to</span>
<span class="mi">1176</span>         <span class="c1">// (rename_result.second).</span>
<span class="mi">1177</span>         <span class="n">inst</span><span class="o">-&gt;</span><span class="n">renameDestReg</span><span class="p">(</span><span class="n">dest_idx</span><span class="p">,</span>
<span class="mi">1178</span>                             <span class="n">rename_result</span><span class="p">.</span><span class="n">first</span><span class="p">,</span>
<span class="mi">1179</span>                             <span class="n">rename_result</span><span class="p">.</span><span class="n">second</span><span class="p">);</span>
<span class="mi">1180</span> 
<span class="mi">1181</span>         <span class="o">++</span><span class="n">renameRenamedOperands</span><span class="p">;</span>
<span class="mi">1182</span>     <span class="p">}</span>
<span class="mi">1183</span> <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>
<p>Basically, the renameDestRegs function is similar to the renameSrcRegs 
However, renaming destination register can change 
register map and the scoreboard
of the destination register. 
For the source registers,
it should check the scoreboard
because it might have dependencies on the previous instructions.
However, 
because the destination register does not have dependencies on
previous instructions, 
it can map current destination register to any physical register 
if the resources are available. 
Therefore, instead of invoking lookup 
as we did for the source register,
it invokes rename function.</p>

<h3 id="rename-renames-specific-register-to-the-other"><span class="me-2">rename: renames specific register to the other</span><a href="#rename-renames-specific-register-to-the-other" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
</pre></td><td class="rouge-code"><pre><span class="mi">221</span>     <span class="cm">/**
222      * Tell rename map to get a new free physical register to remap
223      * the specified architectural register. This version takes a
224      * RegId and reads the  appropriate class-specific rename table.
225      * @param arch_reg The architectural register id to remap.
226      * @return A RenameInfo pair indicating both the new and previous
227      * physical registers.
228      */</span>
<span class="mi">229</span>     <span class="n">RenameInfo</span> <span class="nf">rename</span><span class="p">(</span><span class="k">const</span> <span class="n">RegId</span><span class="o">&amp;</span> <span class="n">arch_reg</span><span class="p">)</span>
<span class="mi">230</span>     <span class="p">{</span>
<span class="mi">231</span>         <span class="k">switch</span> <span class="p">(</span><span class="n">arch_reg</span><span class="p">.</span><span class="n">classValue</span><span class="p">())</span> <span class="p">{</span>
<span class="mi">232</span>           <span class="k">case</span> <span class="n">IntRegClass</span><span class="p">:</span>
<span class="mi">233</span>             <span class="k">return</span> <span class="n">intMap</span><span class="p">.</span><span class="n">rename</span><span class="p">(</span><span class="n">arch_reg</span><span class="p">);</span>
<span class="mi">234</span>           <span class="k">case</span> <span class="n">FloatRegClass</span><span class="p">:</span>
<span class="mi">235</span>             <span class="k">return</span> <span class="n">floatMap</span><span class="p">.</span><span class="n">rename</span><span class="p">(</span><span class="n">arch_reg</span><span class="p">);</span>
<span class="mi">236</span>           <span class="k">case</span> <span class="n">VecRegClass</span><span class="p">:</span>
<span class="mi">237</span>             <span class="n">assert</span><span class="p">(</span><span class="n">vecMode</span> <span class="o">==</span> <span class="n">Enums</span><span class="o">::</span><span class="n">Full</span><span class="p">);</span>
<span class="mi">238</span>             <span class="k">return</span> <span class="n">vecMap</span><span class="p">.</span><span class="n">rename</span><span class="p">(</span><span class="n">arch_reg</span><span class="p">);</span>
<span class="mi">239</span>           <span class="k">case</span> <span class="n">VecElemClass</span><span class="p">:</span>
<span class="mi">240</span>             <span class="n">assert</span><span class="p">(</span><span class="n">vecMode</span> <span class="o">==</span> <span class="n">Enums</span><span class="o">::</span><span class="n">Elem</span><span class="p">);</span>
<span class="mi">241</span>             <span class="k">return</span> <span class="n">vecElemMap</span><span class="p">.</span><span class="n">rename</span><span class="p">(</span><span class="n">arch_reg</span><span class="p">);</span>
<span class="mi">242</span>           <span class="k">case</span> <span class="n">VecPredRegClass</span><span class="p">:</span>
<span class="mi">243</span>             <span class="k">return</span> <span class="n">predMap</span><span class="p">.</span><span class="n">rename</span><span class="p">(</span><span class="n">arch_reg</span><span class="p">);</span>
<span class="mi">244</span>           <span class="k">case</span> <span class="n">CCRegClass</span><span class="p">:</span>
<span class="mi">245</span>             <span class="k">return</span> <span class="n">ccMap</span><span class="p">.</span><span class="n">rename</span><span class="p">(</span><span class="n">arch_reg</span><span class="p">);</span>
<span class="mi">246</span>           <span class="k">case</span> <span class="n">MiscRegClass</span><span class="p">:</span>
<span class="mi">247</span>             <span class="p">{</span>
<span class="mi">248</span>             <span class="c1">// misc regs aren't really renamed, just remapped</span>
<span class="mi">249</span>             <span class="n">PhysRegIdPtr</span> <span class="n">phys_reg</span> <span class="o">=</span> <span class="n">lookup</span><span class="p">(</span><span class="n">arch_reg</span><span class="p">);</span>
<span class="mi">250</span>             <span class="c1">// Set the new register to the previous one to keep the same</span>
<span class="mi">251</span>             <span class="c1">// mapping throughout the execution.</span>
<span class="mi">252</span>             <span class="k">return</span> <span class="n">RenameInfo</span><span class="p">(</span><span class="n">phys_reg</span><span class="p">,</span> <span class="n">phys_reg</span><span class="p">);</span>
<span class="mi">253</span>             <span class="p">}</span>
<span class="mi">254</span> 
<span class="mi">255</span>           <span class="k">default</span><span class="o">:</span>
<span class="mi">256</span>             <span class="nf">panic</span><span class="p">(</span><span class="s">"rename rename(): unknown reg class %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
<span class="mi">257</span>                   <span class="n">arch_reg</span><span class="p">.</span><span class="n">className</span><span class="p">());</span>
<span class="mi">258</span>         <span class="p">}</span>
<span class="mi">259</span>     <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Because rename stage has access on various physical registers, 
it should ask proper physical register map 
to rename the architecture register to its physical register. 
Note that the return value, RenameInfo,
is a pair indicating both the new and previous.</p>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre>    <span class="cm">/**
     * Pair of a physical register and a physical register.  Used to
     * return the physical register that a logical register has been
     * renamed to, and the previous physical register that the same
     * logical register was previously mapped to.
     */</span>
    <span class="k">typedef</span> <span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">PhysRegIdPtr</span><span class="p">,</span> <span class="n">PhysRegIdPtr</span><span class="o">&gt;</span> <span class="n">RenameInfo</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></div></div>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre></td><td class="rouge-code"><pre> <span class="mi">73</span> <span class="n">SimpleRenameMap</span><span class="o">::</span><span class="n">RenameInfo</span>
 <span class="mi">74</span> <span class="n">SimpleRenameMap</span><span class="o">::</span><span class="n">rename</span><span class="p">(</span><span class="k">const</span> <span class="n">RegId</span><span class="o">&amp;</span> <span class="n">arch_reg</span><span class="p">)</span>
 <span class="mi">75</span> <span class="p">{</span>
 <span class="mi">76</span>     <span class="n">PhysRegIdPtr</span> <span class="n">renamed_reg</span><span class="p">;</span>
 <span class="mi">77</span>     <span class="c1">// Record the current physical register that is renamed to the</span>
 <span class="mi">78</span>     <span class="c1">// requested architected register.</span>
 <span class="mi">79</span>     <span class="n">PhysRegIdPtr</span> <span class="n">prev_reg</span> <span class="o">=</span> <span class="n">map</span><span class="p">[</span><span class="n">arch_reg</span><span class="p">.</span><span class="n">flatIndex</span><span class="p">()];</span>
 <span class="mi">80</span> 
 <span class="mi">81</span>     <span class="k">if</span> <span class="p">(</span><span class="n">arch_reg</span> <span class="o">==</span> <span class="n">zeroReg</span><span class="p">)</span> <span class="p">{</span>
 <span class="mi">82</span>         <span class="n">assert</span><span class="p">(</span><span class="n">prev_reg</span><span class="o">-&gt;</span><span class="n">isZeroReg</span><span class="p">());</span>
 <span class="mi">83</span>         <span class="n">renamed_reg</span> <span class="o">=</span> <span class="n">prev_reg</span><span class="p">;</span>
 <span class="mi">84</span>     <span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">prev_reg</span><span class="o">-&gt;</span><span class="n">getNumPinnedWrites</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
 <span class="mi">85</span>         <span class="c1">// Do not rename if the register is pinned</span>
 <span class="mi">86</span>         <span class="n">assert</span><span class="p">(</span><span class="n">arch_reg</span><span class="p">.</span><span class="n">getNumPinnedWrites</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>  <span class="c1">// Prevent pinning the</span>
 <span class="mi">87</span>                                                      <span class="c1">// same register twice</span>
 <span class="mi">88</span>         <span class="n">DPRINTF</span><span class="p">(</span><span class="n">Rename</span><span class="p">,</span> <span class="s">"Renaming pinned reg, numPinnedWrites %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
 <span class="mi">89</span>                 <span class="n">prev_reg</span><span class="o">-&gt;</span><span class="n">getNumPinnedWrites</span><span class="p">());</span>
 <span class="mi">90</span>         <span class="n">renamed_reg</span> <span class="o">=</span> <span class="n">prev_reg</span><span class="p">;</span>
 <span class="mi">91</span>         <span class="n">renamed_reg</span><span class="o">-&gt;</span><span class="n">decrNumPinnedWrites</span><span class="p">();</span>
 <span class="mi">92</span>     <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
 <span class="mi">93</span>         <span class="n">renamed_reg</span> <span class="o">=</span> <span class="n">freeList</span><span class="o">-&gt;</span><span class="n">getReg</span><span class="p">();</span>
 <span class="mi">94</span>         <span class="n">map</span><span class="p">[</span><span class="n">arch_reg</span><span class="p">.</span><span class="n">flatIndex</span><span class="p">()]</span> <span class="o">=</span> <span class="n">renamed_reg</span><span class="p">;</span>
 <span class="mi">95</span>         <span class="n">renamed_reg</span><span class="o">-&gt;</span><span class="n">setNumPinnedWrites</span><span class="p">(</span><span class="n">arch_reg</span><span class="p">.</span><span class="n">getNumPinnedWrites</span><span class="p">());</span>
 <span class="mi">96</span>         <span class="n">renamed_reg</span><span class="o">-&gt;</span><span class="n">setNumPinnedWritesToComplete</span><span class="p">(</span>
 <span class="mi">97</span>             <span class="n">arch_reg</span><span class="p">.</span><span class="n">getNumPinnedWrites</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
 <span class="mi">98</span>     <span class="p">}</span>
 <span class="mi">99</span> 
<span class="mi">100</span>     <span class="nf">DPRINTF</span><span class="p">(</span><span class="n">Rename</span><span class="p">,</span> <span class="s">"Renamed reg %d to physical reg %d (%d) old mapping was"</span>
<span class="mi">101</span>             <span class="s">" %d (%d)</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
<span class="mi">102</span>             <span class="n">arch_reg</span><span class="p">,</span> <span class="n">renamed_reg</span><span class="o">-&gt;</span><span class="n">flatIndex</span><span class="p">(),</span> <span class="n">renamed_reg</span><span class="o">-&gt;</span><span class="n">flatIndex</span><span class="p">(),</span>
<span class="mi">103</span>             <span class="n">prev_reg</span><span class="o">-&gt;</span><span class="n">flatIndex</span><span class="p">(),</span> <span class="n">prev_reg</span><span class="o">-&gt;</span><span class="n">flatIndex</span><span class="p">());</span>
<span class="mi">104</span> 
<span class="mi">105</span>     <span class="k">return</span> <span class="nf">RenameInfo</span><span class="p">(</span><span class="n">renamed_reg</span><span class="p">,</span> <span class="n">prev_reg</span><span class="p">);</span>
<span class="mi">106</span> <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>
<p>The prev_reg indicates the previous physical register 
mapped to the current architecture register.
Also, it maps any available physical register to the current architecture register (Line 93)
and update its mapping (Line 94).</p>

<h3 id="make-the-renamed-register-as-not-ready"><span class="me-2">Make the renamed register as not ready</span><a href="#make-the-renamed-register-as-not-ready" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>It invokes unsetReg to make the scoreboard mark 
the physical register previously mapped to 
currently remapped destination architecture register
as not ready.
\TODO{What is the purpose of it?}</p>

<h3 id="populating-history-buffer-entry-per-destination-register-rename"><span class="me-2">Populating history buffer entry per destination register rename</span><a href="#populating-history-buffer-entry-per-destination-register-rename" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>After the renaming is done (line 1161-1163),
it generates history entry for providing \TODO{is it for precise exception?? what purpose is it?}</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre></td><td class="rouge-code"><pre><span class="mi">303</span>     <span class="k">struct</span> <span class="nc">RenameHistory</span> <span class="p">{</span>
<span class="mi">304</span>         <span class="n">RenameHistory</span><span class="p">(</span><span class="n">InstSeqNum</span> <span class="n">_instSeqNum</span><span class="p">,</span> <span class="k">const</span> <span class="n">RegId</span><span class="o">&amp;</span> <span class="n">_archReg</span><span class="p">,</span>
<span class="mi">305</span>                       <span class="n">PhysRegIdPtr</span> <span class="n">_newPhysReg</span><span class="p">,</span>
<span class="mi">306</span>                       <span class="n">PhysRegIdPtr</span> <span class="n">_prevPhysReg</span><span class="p">)</span>
<span class="mi">307</span>             <span class="o">:</span> <span class="n">instSeqNum</span><span class="p">(</span><span class="n">_instSeqNum</span><span class="p">),</span> <span class="n">archReg</span><span class="p">(</span><span class="n">_archReg</span><span class="p">),</span>
<span class="mi">308</span>               <span class="n">newPhysReg</span><span class="p">(</span><span class="n">_newPhysReg</span><span class="p">),</span> <span class="n">prevPhysReg</span><span class="p">(</span><span class="n">_prevPhysReg</span><span class="p">)</span>
<span class="mi">309</span>         <span class="p">{</span>
<span class="mi">310</span>         <span class="p">}</span>
<span class="mi">311</span> 
<span class="mi">312</span>         <span class="cm">/** The sequence number of the instruction that renamed. */</span>
<span class="mi">313</span>         <span class="n">InstSeqNum</span> <span class="n">instSeqNum</span><span class="p">;</span>
<span class="mi">314</span>         <span class="cm">/** The architectural register index that was renamed. */</span>
<span class="mi">315</span>         <span class="n">RegId</span> <span class="n">archReg</span><span class="p">;</span>
<span class="mi">316</span>         <span class="cm">/** The new physical register that the arch. register is renamed to. */</span>
<span class="mi">317</span>         <span class="n">PhysRegIdPtr</span> <span class="n">newPhysReg</span><span class="p">;</span>
<span class="mi">318</span>         <span class="cm">/** The old physical register that the arch. register was renamed to.
319          */</span>
<span class="mi">320</span>         <span class="n">PhysRegIdPtr</span> <span class="n">prevPhysReg</span><span class="p">;</span>
<span class="mi">321</span>     <span class="p">};</span>                       
<span class="mi">322</span> 
<span class="mi">323</span>     <span class="cm">/** A per-thread list of all destination register renames, used to either
324      * undo rename mappings or free old physical registers.
325      */</span>
<span class="mi">326</span>     <span class="n">std</span><span class="o">::</span><span class="n">list</span><span class="o">&lt;</span><span class="n">RenameHistory</span><span class="o">&gt;</span> <span class="n">historyBuffer</span><span class="p">[</span><span class="n">Impl</span><span class="o">::</span><span class="n">MaxThreads</span><span class="p">];</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="end-of-the-main-loop"><span class="me-2">End of the main loop</span><a href="#end-of-the-main-loop" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>After renaming destination and source registers, 
it pushes the renamed instruction to the toIEW register.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="rouge-code"><pre> <span class="mi">781</span>     <span class="n">instsInProgress</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">+=</span> <span class="n">renamed_insts</span><span class="p">;</span>
 <span class="mi">782</span>     <span class="n">renameRenamedInsts</span> <span class="o">+=</span> <span class="n">renamed_insts</span><span class="p">;</span>
 <span class="mi">783</span> 
 <span class="mi">784</span>     <span class="c1">// If we wrote to the time buffer, record this.</span>
 <span class="mi">785</span>     <span class="nf">if</span> <span class="p">(</span><span class="n">toIEWIndex</span><span class="p">)</span> <span class="p">{</span>
 <span class="mi">786</span>         <span class="n">wroteToTimeBuffer</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
 <span class="mi">787</span>     <span class="p">}</span>
 <span class="mi">788</span> 
 <span class="mi">789</span>     <span class="c1">// Check if there's any instructions left that haven't yet been renamed.</span>
 <span class="mi">790</span>     <span class="c1">// If so then block.</span>
 <span class="mi">791</span>     <span class="nf">if</span> <span class="p">(</span><span class="n">insts_available</span><span class="p">)</span> <span class="p">{</span>
 <span class="mi">792</span>         <span class="n">blockThisCycle</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
 <span class="mi">793</span>     <span class="p">}</span>
 <span class="mi">794</span> 
 <span class="mi">795</span>     <span class="nf">if</span> <span class="p">(</span><span class="n">blockThisCycle</span><span class="p">)</span> <span class="p">{</span>
 <span class="mi">796</span>         <span class="n">block</span><span class="p">(</span><span class="n">tid</span><span class="p">);</span>
 <span class="mi">797</span>         <span class="n">toDecode</span><span class="o">-&gt;</span><span class="n">renameUnblock</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
 <span class="mi">798</span>     <span class="p">}</span>
 <span class="mi">799</span> <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>
<p>Now we are good to go to IEW stage!</p>

<h2 id="scoreboard"><span class="me-2">scoreboard</span><a href="#scoreboard" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<h3 id="scoreboard-interface"><span class="me-2">scoreboard interface</span><a href="#scoreboard-interface" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p><em>gem5/src/cpu/o3/scoreboard.hh</em></p>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
</pre></td><td class="rouge-code"><pre> <span class="mi">46</span> <span class="cm">/**
 47  * Implements a simple scoreboard to track which registers are
 48  * ready. This class operates on the unified physical register space,
 49  * because the different classes of registers do not need to be distinguished.
 50  * Registers being part of a fixed mapping are always considered ready.
 51  */</span>
 <span class="mi">52</span> <span class="k">class</span> <span class="nc">Scoreboard</span>
 <span class="mi">53</span> <span class="p">{</span>
 <span class="mi">54</span>   <span class="k">private</span><span class="o">:</span>
 <span class="mi">55</span>     <span class="cm">/** The object name, for DPRINTF.  We have to declare this
 56      *  explicitly because Scoreboard is not a SimObject. */</span>
 <span class="mi">57</span>     <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">_name</span><span class="p">;</span>
 <span class="mi">58</span> 
 <span class="mi">59</span>     <span class="cm">/** Scoreboard of physical integer registers, saying whether or not they
 60      *  are ready. */</span>
 <span class="mi">61</span>     <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span> <span class="n">regScoreBoard</span><span class="p">;</span>
 <span class="mi">62</span> 
 <span class="mi">63</span>     <span class="cm">/** The number of actual physical registers */</span>
 <span class="mi">64</span>     <span class="kt">unsigned</span> <span class="n">M5_CLASS_VAR_USED</span> <span class="n">numPhysRegs</span><span class="p">;</span>
 <span class="mi">65</span> 
 <span class="mi">66</span>   <span class="k">public</span><span class="o">:</span>
 <span class="mi">67</span>     <span class="cm">/** Constructs a scoreboard.
 68      *  @param _numPhysicalRegs Number of physical registers.
 69      *  @param _numMiscRegs Number of miscellaneous registers.
 70      */</span>
 <span class="mi">71</span>     <span class="n">Scoreboard</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="o">&amp;</span><span class="n">_my_name</span><span class="p">,</span>
 <span class="mi">72</span>                <span class="kt">unsigned</span> <span class="n">_numPhysicalRegs</span><span class="p">);</span>
 <span class="mi">73</span> 
 <span class="mi">74</span>     <span class="cm">/** Destructor. */</span>
 <span class="mi">75</span>     <span class="o">~</span><span class="n">Scoreboard</span><span class="p">()</span> <span class="p">{}</span>
 <span class="mi">76</span> 
 <span class="mi">77</span>     <span class="cm">/** Returns the name of the scoreboard. */</span>
 <span class="mi">78</span>     <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">name</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">_name</span><span class="p">;</span> <span class="p">};</span>
 <span class="mi">79</span> 
 <span class="mi">80</span>     <span class="cm">/** Checks if the register is ready. */</span>
 <span class="mi">81</span>     <span class="kt">bool</span> <span class="nf">getReg</span><span class="p">(</span><span class="n">PhysRegIdPtr</span> <span class="n">phys_reg</span><span class="p">)</span> <span class="k">const</span>
 <span class="mi">82</span>     <span class="p">{</span>
 <span class="mi">83</span>         <span class="n">assert</span><span class="p">(</span><span class="n">phys_reg</span><span class="o">-&gt;</span><span class="n">flatIndex</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">numPhysRegs</span><span class="p">);</span>
 <span class="mi">84</span> 
 <span class="mi">85</span>         <span class="nf">if</span> <span class="p">(</span><span class="n">phys_reg</span><span class="o">-&gt;</span><span class="n">isFixedMapping</span><span class="p">())</span> <span class="p">{</span>
 <span class="mi">86</span>             <span class="c1">// Fixed mapping regs are always ready</span>
 <span class="mi">87</span>             <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
 <span class="mi">88</span>         <span class="p">}</span>
 <span class="mi">89</span> 
 <span class="mi">90</span>         <span class="kt">bool</span> <span class="n">ready</span> <span class="o">=</span> <span class="n">regScoreBoard</span><span class="p">[</span><span class="n">phys_reg</span><span class="o">-&gt;</span><span class="n">flatIndex</span><span class="p">()];</span>
 <span class="mi">91</span> 
 <span class="mi">92</span>         <span class="nf">if</span> <span class="p">(</span><span class="n">phys_reg</span><span class="o">-&gt;</span><span class="n">isZeroReg</span><span class="p">())</span>
 <span class="mi">93</span>             <span class="n">assert</span><span class="p">(</span><span class="n">ready</span><span class="p">);</span>
 <span class="mi">94</span> 
 <span class="mi">95</span>         <span class="k">return</span> <span class="n">ready</span><span class="p">;</span>
 <span class="mi">96</span>     <span class="p">}</span>
 <span class="mi">97</span> 
 <span class="mi">98</span>     <span class="cm">/** Sets the register as ready. */</span>
 <span class="mi">99</span>     <span class="kt">void</span> <span class="nf">setReg</span><span class="p">(</span><span class="n">PhysRegIdPtr</span> <span class="n">phys_reg</span><span class="p">)</span>
<span class="mi">100</span>     <span class="p">{</span>
<span class="mi">101</span>         <span class="n">assert</span><span class="p">(</span><span class="n">phys_reg</span><span class="o">-&gt;</span><span class="n">flatIndex</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">numPhysRegs</span><span class="p">);</span>
<span class="mi">102</span> 
<span class="mi">103</span>         <span class="nf">if</span> <span class="p">(</span><span class="n">phys_reg</span><span class="o">-&gt;</span><span class="n">isFixedMapping</span><span class="p">())</span> <span class="p">{</span>
<span class="mi">104</span>             <span class="c1">// Fixed mapping regs are always ready, ignore attempts to change</span>
<span class="mi">105</span>             <span class="c1">// that</span>
<span class="mi">106</span>             <span class="k">return</span><span class="p">;</span>
<span class="mi">107</span>         <span class="p">}</span>
<span class="mi">108</span> 
<span class="mi">109</span>         <span class="nf">DPRINTF</span><span class="p">(</span><span class="n">Scoreboard</span><span class="p">,</span> <span class="s">"Setting reg %i (%s) as ready</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
<span class="mi">110</span>                 <span class="n">phys_reg</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">(),</span> <span class="n">phys_reg</span><span class="o">-&gt;</span><span class="n">className</span><span class="p">());</span>
<span class="mi">111</span> 
<span class="mi">112</span>         <span class="n">regScoreBoard</span><span class="p">[</span><span class="n">phys_reg</span><span class="o">-&gt;</span><span class="n">flatIndex</span><span class="p">()]</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="mi">113</span>     <span class="p">}</span>
<span class="mi">114</span> 
<span class="mi">115</span>     <span class="cm">/** Sets the register as not ready. */</span>
<span class="mi">116</span>     <span class="kt">void</span> <span class="nf">unsetReg</span><span class="p">(</span><span class="n">PhysRegIdPtr</span> <span class="n">phys_reg</span><span class="p">)</span>
<span class="mi">117</span>     <span class="p">{</span>
<span class="mi">118</span>         <span class="n">assert</span><span class="p">(</span><span class="n">phys_reg</span><span class="o">-&gt;</span><span class="n">flatIndex</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">numPhysRegs</span><span class="p">);</span>
<span class="mi">119</span> 
<span class="mi">120</span>         <span class="nf">if</span> <span class="p">(</span><span class="n">phys_reg</span><span class="o">-&gt;</span><span class="n">isFixedMapping</span><span class="p">())</span> <span class="p">{</span>
<span class="mi">121</span>             <span class="c1">// Fixed mapping regs are always ready, ignore attempts to</span>
<span class="mi">122</span>             <span class="c1">// change that</span>
<span class="mi">123</span>             <span class="k">return</span><span class="p">;</span>
<span class="mi">124</span>         <span class="p">}</span>
<span class="mi">125</span> 
<span class="mi">126</span>         <span class="c1">// zero reg should never be marked unready</span>
<span class="mi">127</span>         <span class="k">if</span> <span class="p">(</span><span class="n">phys_reg</span><span class="o">-&gt;</span><span class="n">isZeroReg</span><span class="p">())</span>
<span class="mi">128</span>             <span class="k">return</span><span class="p">;</span>
<span class="mi">129</span> 
<span class="mi">130</span>         <span class="n">regScoreBoard</span><span class="p">[</span><span class="n">phys_reg</span><span class="o">-&gt;</span><span class="n">flatIndex</span><span class="p">()]</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="mi">131</span>     <span class="p">}</span>
<span class="mi">132</span> 
<span class="mi">133</span> <span class="p">};</span>
</pre></td></tr></tbody></table></code></div></div>
<p>Scoreboard is implemented as a simple vector (regScoreBoard) to indicate 
specific register is ready to be used or not. 
And it provide three interfaces to set or get the status 
of the specific register maintained by the scoreboard.</p>

<h3 id="scoreboard-used-by-the-o3-cpu"><span class="me-2">scoreboard used by the O3 CPU</span><a href="#scoreboard-used-by-the-o3-cpu" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p><em>gem5/src/cpu/o3/cpu.hh</em></p>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="mi">602</span>     <span class="cm">/** Integer Register Scoreboard */</span>
<span class="mi">603</span>     <span class="n">Scoreboard</span> <span class="n">scoreboard</span><span class="p">;</span> 
</pre></td></tr></tbody></table></code></div></div>

<p><em>gem5/src/cpu/o3/cpu.cc</em></p>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre> <span class="mi">218</span>     <span class="n">rename</span><span class="p">.</span><span class="n">setScoreboard</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scoreboard</span><span class="p">);</span>
 <span class="mi">219</span>     <span class="n">iew</span><span class="p">.</span><span class="n">setScoreboard</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scoreboard</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></div></div>

<p>When it comes to real hardware implementation, 
the scoreboard should be accessible by the multiple stages 
at the same time. 
However, because it is software emulation,
GEM5 doesn’t provide port-wise emulation 
to service different modules at the same time.
Note that GEM5 executes in single thread 
and cannot be executed in multi-threads. 
Anyway, the scoreboard is accessed by two different stages in the O3CPU: 
rename and iew.</p>


  </div>

  <div class="post-tail-wrapper text-muted">
    <!-- categories -->
    
      <div class="post-meta mb-3">
        <i class="far fa-folder-open fa-fw me-1"></i>
        
          <a href="/categories/gem5/">GEM5</a>,
          <a href="/categories/pipeline/">Pipeline</a>,
          <a href="/categories/o3/">O3</a>
      </div>
    

    <!-- tags -->
    

    <div
      class="
        post-tail-bottom
        d-flex justify-content-between align-items-center mt-5 pb-2
      "
    >
      <div class="license-wrapper">
        
          

          This post is licensed under 
        <a href="https://creativecommons.org/licenses/by/4.0/">
          CC BY 4.0
        </a>
         by the author.
        
      </div>

      <!-- Post sharing snippet -->

<div class="share-wrapper d-flex align-items-center">
  <span class="share-label text-muted">Share</span>
  <span class="share-icons">
    
    
    

    

      

      <a
        href="https://twitter.com/intent/tweet?text=O3%20Cpu%20Rename%20-%20Ruach&url=http%3A%2F%2Flocalhost%3A4000%2Fposts%2FO3-CPU-rename%2F"
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Twitter"
        target="_blank"
        rel="noopener"
        aria-label="Twitter"
      >
        <i class="fa-fw fa-brands fa-square-x-twitter"></i>
      </a>
    

      

      <a
        href="https://www.facebook.com/sharer/sharer.php?title=O3%20Cpu%20Rename%20-%20Ruach&u=http%3A%2F%2Flocalhost%3A4000%2Fposts%2FO3-CPU-rename%2F"
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Facebook"
        target="_blank"
        rel="noopener"
        aria-label="Facebook"
      >
        <i class="fa-fw fab fa-facebook-square"></i>
      </a>
    

      

      <a
        href="https://t.me/share/url?url=http%3A%2F%2Flocalhost%3A4000%2Fposts%2FO3-CPU-rename%2F&text=O3%20Cpu%20Rename%20-%20Ruach"
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Telegram"
        target="_blank"
        rel="noopener"
        aria-label="Telegram"
      >
        <i class="fa-fw fab fa-telegram"></i>
      </a>
    

      

      <a
        href="https://www.linkedin.com/sharing/share-offsite/?url=http%3A%2F%2Flocalhost%3A4000%2Fposts%2FO3-CPU-rename%2F"
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Linkedin"
        target="_blank"
        rel="noopener"
        aria-label="Linkedin"
      >
        <i class="fa-fw fab fa-linkedin"></i>
      </a>
    

    <button
      id="copy-link"
      aria-label="Copy link"
      class="btn small"
      data-bs-toggle="tooltip"
      data-bs-placement="top"
      title="Copy link"
      data-title-succeed="Link copied successfully!"
    >
      <i class="fa-fw fas fa-link pe-none fs-6"></i>
    </button>
  </span>
</div>

    </div>
    <!-- .post-tail-bottom -->
  </div>
  <!-- div.post-tail-wrapper -->
</article>


            
          </main>

          <!-- panel -->
          <aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 mb-5 text-muted">
            <div class="access">
              <!-- Get the last 5 posts from lastmod list. -->















              <!-- The trending tags list -->


















            </div>

            
              
              



  <section id="toc-wrapper" class="ps-0 pe-4">
    <h2 class="panel-heading ps-3 pt-2 mb-2">Contents</h2>
    <nav id="toc"></nav>
  </section>


            
          </aside>
        </div>

        <div class="row">
          <!-- tail -->
          <div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4">
            
              
              <!-- Recommend the other 3 posts according to the tags and categories of the current post. -->

<!-- The total size of related posts -->


<!-- An random integer that bigger than 0 -->


<!-- Equals to TAG_SCORE / {max_categories_hierarchy} -->














  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  
    
  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  











  <aside id="related-posts" aria-labelledby="related-label">
    <h3 class="mb-4" id="related-label">Further Reading</h3>
    <nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4">
      
        <article class="col">
          <a href="/posts/O3-CPU-Fetch/" class="post-preview card h-100">
            <div class="card-body">
              <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1622088000"
  data-df="ll"
  
>
  May 27, 2021
</time>

              <h4 class="pt-0 my-2">O3 Cpu Fetch</h4>
              <div class="text-muted">
                <p>
                  





                  Fetch
 895 template &amp;lt;class Impl&amp;gt;
 896 void
 897 DefaultFetch&amp;lt;Impl&amp;gt;::tick()
 898 {
 899     list&amp;lt;ThreadID&amp;gt;::iterator threads = activeThreads-&amp;gt;begin();
 900     list&amp;lt;ThreadID&amp;...
                </p>
              </div>
            </div>
          </a>
        </article>
      
        <article class="col">
          <a href="/posts/O3-CPU-Decode/" class="post-preview card h-100">
            <div class="card-body">
              <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1622174400"
  data-df="ll"
  
>
  May 28, 2021
</time>

              <h4 class="pt-0 my-2">O3 Cpu Decode</h4>
              <div class="text-muted">
                <p>
                  





                  Sending fetched instructions to decode stage
gem5/src/cpu/o3/fetch_impl.hh
 961 
 962     // Pick a random thread to start trying to grab instructions from
 963     auto tid_itr = activeThreads-&amp;gt...
                </p>
              </div>
            </div>
          </a>
        </article>
      
        <article class="col">
          <a href="/posts/O3-CPU-iew/" class="post-preview card h-100">
            <div class="card-body">
              <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1622520000"
  data-df="ll"
  
>
  Jun  1, 2021
</time>

              <h4 class="pt-0 my-2">O3 Cpu Iew</h4>
              <div class="text-muted">
                <p>
                  





                  IEW: Issue/Execute/Writeback

  GEM5 handles both execute and writeback when the execute() 
function is called on an instruction. Therefore, GEM5 combines 
Issue, Execute, and Writeback stage into ...
                </p>
              </div>
            </div>
          </a>
        </article>
      
    </nav>
  </aside>
  <!-- #related-posts -->


            
              
              <!-- Navigation buttons at the bottom of the post. -->

<nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation">
  
  

  
    <a
      href="/posts/O3-CPU-Decode/"
      class="btn btn-outline-primary"
      aria-label="Older"
    >
      <p>O3 Cpu Decode</p>
    </a>
  

  
    <a
      href="/posts/O3-CPU-iew/"
      class="btn btn-outline-primary"
      aria-label="Newer"
    >
      <p>O3 Cpu Iew</p>
    </a>
  
</nav>

            
              
              <!--  The comments switcher -->

  
  <!-- https://giscus.app/ -->
<script type="text/javascript">
  (function () {
    const origin = 'https://giscus.app';
    const iframe = 'iframe.giscus-frame';
    const lightTheme = 'light';
    const darkTheme = 'dark_dimmed';

    let initTheme = lightTheme;
    const html = document.documentElement;

    if (
      (html.hasAttribute('data-mode') &&
        html.getAttribute('data-mode') === 'dark') ||
      (!html.hasAttribute('data-mode') &&
        window.matchMedia('(prefers-color-scheme: dark)').matches)
    ) {
      initTheme = darkTheme;
    }

    let giscusAttributes = {
      src: 'https://giscus.app/client.js',
      'data-repo': 'Ruach/ruach.github.io',
      'data-repo-id': '',
      'data-category': '',
      'data-category-id': '',
      'data-mapping': 'pathname',
      'data-reactions-enabled': '1',
      'data-emit-metadata': '0',
      'data-theme': initTheme,
      'data-input-position': 'bottom',
      'data-lang': 'en',
      'data-loading': 'lazy',
      crossorigin: 'anonymous',
      async: ''
    };

    let giscusScript = document.createElement('script');
    Object.entries(giscusAttributes).forEach(([key, value]) =>
      giscusScript.setAttribute(key, value)
    );
    document.getElementById('tail-wrapper').appendChild(giscusScript);

    addEventListener('message', (event) => {
      if (
        event.source === window &&
        event.data &&
        event.data.direction === ModeToggle.ID
      ) {
        /* global theme mode changed */
        const mode = event.data.message;
        const theme = mode === ModeToggle.DARK_MODE ? darkTheme : lightTheme;

        const message = {
          setConfig: {
            theme: theme
          }
        };

        const giscus = document.querySelector(iframe).contentWindow;
        giscus.postMessage({ giscus: message }, origin);
      }
    });
  })();
</script>



            

            <!-- The Footer -->

<footer
  aria-label="Site Info"
  class="
    d-flex flex-column justify-content-center text-muted
    flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3
  "
>
  <p>
    ©
    <time>2023</time>
    <a href="https://ruach.github.io">Jaehyuk Lee</a>.
    
      <span
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author."
      >Some rights reserved.</span>
    
  </p>

  <p>Using the <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme for <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>
  </p>
</footer>

          </div>
        </div>

        <!-- The Search results -->

<div id="search-result-wrapper" class="d-flex justify-content-center unloaded">
  <div class="col-11 content">
    <div id="search-hints">
      <!-- The trending tags list -->


















    </div>
    <div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div>
  </div>
</div>

      </div>

      <aside aria-label="Scroll to Top">
        <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow">
          <i class="fas fa-angle-up"></i>
        </button>
      </aside>
    </div>

    <div id="mask"></div>

    
      <aside
  id="notification"
  class="toast"
  role="alert"
  aria-live="assertive"
  aria-atomic="true"
  data-bs-animation="true"
  data-bs-autohide="false"
>
  <div class="toast-header">
    <button
      type="button"
      class="btn-close ms-auto"
      data-bs-dismiss="toast"
      aria-label="Close"
    ></button>
  </div>
  <div class="toast-body text-center pt-0">
    <p class="px-2 mb-3">A new version of content is available.</p>
    <button type="button" class="btn btn-primary" aria-label="Update">
      Update
    </button>
  </div>
</aside>

    

    <!-- JavaScripts -->

    <!-- JS selector for site. -->

<!-- commons -->



<!-- layout specified -->


  

  
    <!-- image lazy-loading & popup & clipboard -->
    
  















  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  



  <script src="https://cdn.jsdelivr.net/combine/npm/jquery@3.7.1/dist/jquery.min.js,npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js,npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/magnific-popup@1.1.0/dist/jquery.magnific-popup.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.10/dayjs.min.js,npm/dayjs@1.11.10/locale/en.min.js,npm/dayjs@1.11.10/plugin/relativeTime.min.js,npm/dayjs@1.11.10/plugin/localizedFormat.min.js,npm/tocbot@4.21.2/dist/tocbot.min.js"></script>






<script defer src="/assets/js/dist/post.min.js"></script>






    

    <!--
  Jekyll Simple Search loader
  See: <https://github.com/christian-fei/Simple-Jekyll-Search>
-->





<script>
  /* Note: dependent library will be loaded in `js-selector.html` */
  SimpleJekyllSearch({
    searchInput: document.getElementById('search-input'),
    resultsContainer: document.getElementById('search-results'),
    json: '/assets/js/data/search.json',
    searchResultTemplate: '  <article class="px-1 px-sm-2 px-lg-4 px-xl-0">    <header>      <h2><a href="{url}">{title}</a></h2>      <div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1">        {categories}        {tags}      </div>    </header>    <p>{snippet}</p>  </article>',
    noResultsText: '<p class="mt-5"></p>',
    templateMiddleware: function(prop, value, template) {
      if (prop === 'categories') {
        if (value === '') {
          return `${value}`;
        } else {
          return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`;
        }
      }

      if (prop === 'tags') {
        if (value === '') {
          return `${value}`;
        } else {
          return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`;
        }
      }
    }
  });
</script>

  </body>
</html>

