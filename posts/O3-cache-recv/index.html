<!doctype html>














<!-- `site.alt_lang` can specify a language different from the UI -->
<html lang="en" data-mode="light">
  <!-- The Head -->

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta
    name="viewport"
    content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover"
  >

  

  

  
    <!-- Begin Jekyll SEO tag v2.8.0 -->
<meta name="generator" content="Jekyll v4.3.2" />
<meta property="og:title" content="O3 Cache Recv" />
<meta property="og:locale" content="en" />
<meta name="description" content="Cache receive 1 2 3 4 5 6 2510 bool 2511 BaseCache::MemSidePort::recvTimingResp(PacketPtr pkt) 2512 { 2513 cache-&gt;recvTimingResp(pkt); 2514 return true; 2515 }" />
<meta property="og:description" content="Cache receive 1 2 3 4 5 6 2510 bool 2511 BaseCache::MemSidePort::recvTimingResp(PacketPtr pkt) 2512 { 2513 cache-&gt;recvTimingResp(pkt); 2514 return true; 2515 }" />
<link rel="canonical" href="https://ruach.github.io/posts/O3-cache-recv/" />
<meta property="og:url" content="https://ruach.github.io/posts/O3-cache-recv/" />
<meta property="og:site_name" content="Ruach" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-06-10T00:00:00-04:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="O3 Cache Recv" />
<meta name="twitter:site" content="@ruach_lee" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2021-06-10T00:00:00-04:00","datePublished":"2021-06-10T00:00:00-04:00","description":"Cache receive 1 2 3 4 5 6 2510 bool 2511 BaseCache::MemSidePort::recvTimingResp(PacketPtr pkt) 2512 { 2513 cache-&gt;recvTimingResp(pkt); 2514 return true; 2515 }","headline":"O3 Cache Recv","mainEntityOfPage":{"@type":"WebPage","@id":"https://ruach.github.io/posts/O3-cache-recv/"},"url":"https://ruach.github.io/posts/O3-cache-recv/"}</script>
<!-- End Jekyll SEO tag -->

  

  <title>O3 Cache Recv | Ruach
  </title>

  <!--
  The Favicons for Web, Android, Microsoft, and iOS (iPhone and iPad) Apps
  Generated by: https://realfavicongenerator.net/
-->



<link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png">
<link rel="manifest" href="/assets/img/favicons/site.webmanifest">
<link rel="shortcut icon" href="/assets/img/favicons/favicon.ico">
<meta name="apple-mobile-web-app-title" content="Ruach">
<meta name="application-name" content="Ruach">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml">
<meta name="theme-color" content="#ffffff">


  
    
      <link rel="preconnect" href="https://fonts.googleapis.com" >
      <link rel="dns-prefetch" href="https://fonts.googleapis.com" >
    
      <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      <link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin>
    
      <link rel="preconnect" href="https://fonts.googleapis.com" >
      <link rel="dns-prefetch" href="https://fonts.googleapis.com" >
    
      <link rel="preconnect" href="https://cdn.jsdelivr.net" >
      <link rel="dns-prefetch" href="https://cdn.jsdelivr.net" >
    

    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap">
  

  <!-- GA -->
  

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.2/css/all.min.css">

  <link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css">

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.21.2/dist/tocbot.min.css">
  

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css">
  

  
    <!-- Manific Popup -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css">
  

  <!-- JavaScript -->

  

  <!-- A placeholder to allow defining custom metadata -->

</head>


  <body>
    <!-- The Side Bar -->

<aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end">
  <header class="profile-wrapper">
    <a href="/" id="avatar" class="rounded-circle">
      
        
        <img src="/assets/img/jaehyuk.png" width="112" height="112" alt="avatar" onerror="this.style.display='none'">
      
    </a>

    <h1 class="site-title">
      <a href="/">Ruach</a>
    </h1>
    <p class="site-subtitle fst-italic mb-0">Security Researcher at Gatech</p>
  </header>
  <!-- .profile-wrapper -->

  <nav class="flex-column flex-grow-1 w-100 ps-0">
    <ul class="nav">
      <!-- home -->
      <li class="nav-item">
        <a href="/" class="nav-link">
          <i class="fa-fw fas fa-home"></i>
          <span>HOME</span>
        </a>
      </li>
      <!-- the real tabs -->
      
        <li class="nav-item">
          <a href="/categories/" class="nav-link">
            <i class="fa-fw fas fa-stream"></i>
            

            <span>CATEGORIES</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/tags/" class="nav-link">
            <i class="fa-fw fas fa-tags"></i>
            

            <span>TAGS</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/archives/" class="nav-link">
            <i class="fa-fw fas fa-archive"></i>
            

            <span>ARCHIVES</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/about/" class="nav-link">
            <i class="fa-fw fas fa-info-circle"></i>
            

            <span>ABOUT</span>
          </a>
        </li>
        <!-- .nav-item -->
      
    </ul>
  </nav>

  <div class="sidebar-bottom d-flex flex-wrap  align-items-center w-100">
    

    
      

      
        <a
          href="javascript:location.href = 'mailto:' + ['jaehyuk','gatech.edu'].join('@')"
          aria-label="email"
          

          

          

          
        >
          <i class="fas fa-envelope"></i>
        </a>
      
    
      

      
        <a
          href="https://www.linkedin.com/in/jaehyuk-lee-29b33b121/"
          aria-label="linkedin"
          

          
            target="_blank"
            
          

          

          
            rel="noopener noreferrer"
          
        >
          <i class="fab fa-linkedin"></i>
        </a>
      
    
      

      
        <a
          href="https://github.com/Ruach"
          aria-label="github"
          

          
            target="_blank"
            
          

          

          
            rel="noopener noreferrer"
          
        >
          <i class="fab fa-github"></i>
        </a>
      
    
      

      
        <a
          href="https://stackoverflow.com/users/4460514/ruach?tab=profile"
          aria-label="stack-overflow"
          

          
            target="_blank"
            
          

          

          
            rel="noopener noreferrer"
          
        >
          <i class="fab fa-stack-overflow"></i>
        </a>
      
    
  </div>
  <!-- .sidebar-bottom -->
</aside>
<!-- #sidebar -->


    <div id="main-wrapper" class="d-flex justify-content-center">
      <div class="container d-flex flex-column px-xxl-5">
        <!-- The Top Bar -->

<header id="topbar-wrapper" aria-label="Top Bar">
  <div
    id="topbar"
    class="d-flex align-items-center justify-content-between px-lg-3 h-100"
  >
    <nav id="breadcrumb" aria-label="Breadcrumb">
      

      
        
          
            <span>
              <a href="/">
                Home
              </a>
            </span>

          
        
          
        
          
            
              <span>O3 Cache Recv</span>
            

          
        
      
    </nav>
    <!-- endof #breadcrumb -->

    <button type="button" id="sidebar-trigger" class="btn btn-link">
      <i class="fas fa-bars fa-fw"></i>
    </button>

    <div id="topbar-title">
      Post
    </div>

    <button type="button" id="search-trigger" class="btn btn-link">
      <i class="fas fa-search fa-fw"></i>
    </button>

    <search class="align-items-center ms-3 ms-lg-0">
      <i class="fas fa-search fa-fw"></i>
      <input
        class="form-control"
        id="search-input"
        type="search"
        aria-label="search"
        autocomplete="off"
        placeholder="Search..."
      >
    </search>
    <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button>
  </div>
</header>


        <div class="row flex-grow-1">
          <main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4">
            
              <!-- Refactor the HTML structure -->



<!--
  In order to allow a wide table to scroll horizontally,
  we suround the markdown table with `<div class="table-wrapper">` and `</div>`
-->



<!--
  Fixed kramdown code highlight rendering:
  https://github.com/penibelst/jekyll-compress-html/issues/101
  https://github.com/penibelst/jekyll-compress-html/issues/71#issuecomment-188144901
-->



<!-- Change the icon of checkbox -->



<!-- Handle images -->





<!-- Add header for code snippets -->



<!-- Create heading anchors -->





  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    

    
  

  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    

    
  

  
  

  

  
  

  




<!-- return -->




<article class="px-1">
  <header>
    <h1 data-toc-skip>O3 Cache Recv</h1>

    <div class="post-meta text-muted">
      <!-- published date -->
      <span>
        Posted
        <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1623297600"
  data-df="ll"
  
    data-bs-toggle="tooltip" data-bs-placement="bottom"
  
>
  Jun 10, 2021
</time>

      </span>

      <!-- lastmod date -->
      

      

      <div class="d-flex justify-content-between">
        <!-- author(s) -->
        <span>
          

          By

          <em>
            
              <a href="https://ruach.github.io">Jaehyuk Lee</a>
            
          </em>
        </span>

        <!-- read time -->
        <!-- Calculate the post's reading time, and display the word count in tooltip -->



<!-- words per minute -->










<!-- return element -->
<span
  class="readtime"
  data-bs-toggle="tooltip"
  data-bs-placement="bottom"
  title="3778 words"
>
  <em>20 min</em> read</span>

      </div>
      <!-- .d-flex -->
    </div>
    <!-- .post-meta -->
  </header>

  <div class="content">
    <h1 id="cache-receive">Cache receive</h1>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="mi">2510</span> <span class="kt">bool</span>
<span class="mi">2511</span> <span class="n">BaseCache</span><span class="o">::</span><span class="n">MemSidePort</span><span class="o">::</span><span class="n">recvTimingResp</span><span class="p">(</span><span class="n">PacketPtr</span> <span class="n">pkt</span><span class="p">)</span>
<span class="mi">2512</span> <span class="p">{</span>
<span class="mi">2513</span>     <span class="n">cache</span><span class="o">-&gt;</span><span class="n">recvTimingResp</span><span class="p">(</span><span class="n">pkt</span><span class="p">);</span>
<span class="mi">2514</span>     <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="mi">2515</span> <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<h2 id="basecacherecvtimingresp"><span class="me-2">BaseCache::recvTimingResp</span><a href="#basecacherecvtimingresp" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
</pre></td><td class="rouge-code"><pre> <span class="mi">419</span> <span class="kt">void</span>
 <span class="mi">420</span> <span class="n">BaseCache</span><span class="o">::</span><span class="n">recvTimingResp</span><span class="p">(</span><span class="n">PacketPtr</span> <span class="n">pkt</span><span class="p">)</span>
 <span class="mi">421</span> <span class="p">{</span>
 <span class="mi">422</span>     <span class="n">assert</span><span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">isResponse</span><span class="p">());</span>
 <span class="mi">423</span> 
 <span class="mi">424</span>     <span class="c1">// all header delay should be paid for by the crossbar, unless</span>
 <span class="mi">425</span>     <span class="c1">// this is a prefetch response from above</span>
 <span class="mi">426</span>     <span class="n">panic_if</span><span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">headerDelay</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">!=</span> <span class="n">MemCmd</span><span class="o">::</span><span class="n">HardPFResp</span><span class="p">,</span>
 <span class="mi">427</span>              <span class="s">"%s saw a non-zero packet delay</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">name</span><span class="p">());</span>
 <span class="mi">428</span> 
 <span class="mi">429</span>     <span class="k">const</span> <span class="kt">bool</span> <span class="n">is_error</span> <span class="o">=</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">isError</span><span class="p">();</span>
 <span class="mi">430</span> 
 <span class="mi">431</span>     <span class="k">if</span> <span class="p">(</span><span class="n">is_error</span><span class="p">)</span> <span class="p">{</span>
 <span class="mi">432</span>         <span class="n">DPRINTF</span><span class="p">(</span><span class="n">Cache</span><span class="p">,</span> <span class="s">"%s: Cache received %s with error</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
 <span class="mi">433</span>                 <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">print</span><span class="p">());</span>
 <span class="mi">434</span>     <span class="p">}</span>
 <span class="mi">435</span> 
 <span class="mi">436</span>     <span class="nf">DPRINTF</span><span class="p">(</span><span class="n">Cache</span><span class="p">,</span> <span class="s">"%s: Handling response %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
 <span class="mi">437</span>             <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">print</span><span class="p">());</span>
 <span class="mi">438</span> 
 <span class="mi">439</span>     <span class="c1">// if this is a write, we should be looking at an uncacheable</span>
 <span class="mi">440</span>     <span class="c1">// write</span>
 <span class="mi">441</span>     <span class="nf">if</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">isWrite</span><span class="p">())</span> <span class="p">{</span>
 <span class="mi">442</span>         <span class="n">assert</span><span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">isUncacheable</span><span class="p">());</span>
 <span class="mi">443</span>         <span class="n">handleUncacheableWriteResp</span><span class="p">(</span><span class="n">pkt</span><span class="p">);</span>
 <span class="mi">444</span>         <span class="k">return</span><span class="p">;</span>
 <span class="mi">445</span>     <span class="p">}</span>
 <span class="mi">446</span> 
 <span class="mi">447</span>     <span class="c1">// we have dealt with any (uncacheable) writes above, from here on</span>
 <span class="mi">448</span>     <span class="c1">// we know we are dealing with an MSHR due to a miss or a prefetch</span>
 <span class="mi">449</span>     <span class="n">MSHR</span> <span class="o">*</span><span class="n">mshr</span> <span class="o">=</span> <span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="n">MSHR</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">popSenderState</span><span class="p">());</span>
 <span class="mi">450</span>     <span class="nf">assert</span><span class="p">(</span><span class="n">mshr</span><span class="p">);</span>
 <span class="mi">451</span> 
 <span class="mi">452</span>     <span class="nf">if</span> <span class="p">(</span><span class="n">mshr</span> <span class="o">==</span> <span class="n">noTargetMSHR</span><span class="p">)</span> <span class="p">{</span>
 <span class="mi">453</span>         <span class="c1">// we always clear at least one target</span>
 <span class="mi">454</span>         <span class="n">clearBlocked</span><span class="p">(</span><span class="n">Blocked_NoTargets</span><span class="p">);</span>
 <span class="mi">455</span>         <span class="n">noTargetMSHR</span> <span class="o">=</span> <span class="nb">nullptr</span><span class="p">;</span>
 <span class="mi">456</span>     <span class="p">}</span>
 <span class="mi">457</span> 
 <span class="mi">458</span>     <span class="c1">// Initial target is used just for stats</span>
 <span class="mi">459</span>     <span class="k">const</span> <span class="n">QueueEntry</span><span class="o">::</span><span class="n">Target</span> <span class="o">*</span><span class="n">initial_tgt</span> <span class="o">=</span> <span class="n">mshr</span><span class="o">-&gt;</span><span class="n">getTarget</span><span class="p">();</span>
 <span class="mi">460</span>     <span class="k">const</span> <span class="n">Tick</span> <span class="n">miss_latency</span> <span class="o">=</span> <span class="n">curTick</span><span class="p">()</span> <span class="o">-</span> <span class="n">initial_tgt</span><span class="o">-&gt;</span><span class="n">recvTime</span><span class="p">;</span>
 <span class="mi">461</span>     <span class="nf">if</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">isUncacheable</span><span class="p">())</span> <span class="p">{</span>
 <span class="mi">462</span>         <span class="n">assert</span><span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">requestorId</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">system</span><span class="o">-&gt;</span><span class="n">maxRequestors</span><span class="p">());</span>
 <span class="mi">463</span>         <span class="n">stats</span><span class="p">.</span><span class="n">cmdStats</span><span class="p">(</span><span class="n">initial_tgt</span><span class="o">-&gt;</span><span class="n">pkt</span><span class="p">)</span>
 <span class="mi">464</span>             <span class="p">.</span><span class="n">mshrUncacheableLatency</span><span class="p">[</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">requestorId</span><span class="p">()]</span> <span class="o">+=</span> <span class="n">miss_latency</span><span class="p">;</span>
 <span class="mi">465</span>     <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
 <span class="mi">466</span>         <span class="n">assert</span><span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">requestorId</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">system</span><span class="o">-&gt;</span><span class="n">maxRequestors</span><span class="p">());</span>
 <span class="mi">467</span>         <span class="n">stats</span><span class="p">.</span><span class="n">cmdStats</span><span class="p">(</span><span class="n">initial_tgt</span><span class="o">-&gt;</span><span class="n">pkt</span><span class="p">)</span>
 <span class="mi">468</span>             <span class="p">.</span><span class="n">mshrMissLatency</span><span class="p">[</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">requestorId</span><span class="p">()]</span> <span class="o">+=</span> <span class="n">miss_latency</span><span class="p">;</span>
 <span class="mi">469</span>     <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<h2 id="filling-the-cache-with-the-fetched-data-recvtimingresp"><span class="me-2">Filling the cache with the fetched data (recvTimingResp)</span><a href="#filling-the-cache-with-the-fetched-data-recvtimingresp" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td><td class="rouge-code"><pre> <span class="mi">471</span>     <span class="n">PacketList</span> <span class="n">writebacks</span><span class="p">;</span>
 <span class="mi">472</span> 
 <span class="mi">473</span>     <span class="kt">bool</span> <span class="n">is_fill</span> <span class="o">=</span> <span class="o">!</span><span class="n">mshr</span><span class="o">-&gt;</span><span class="n">isForward</span> <span class="o">&amp;&amp;</span>
 <span class="mi">474</span>         <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">isRead</span><span class="p">()</span> <span class="o">||</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">MemCmd</span><span class="o">::</span><span class="n">UpgradeResp</span> <span class="o">||</span>
 <span class="mi">475</span>          <span class="n">mshr</span><span class="o">-&gt;</span><span class="n">wasWholeLineWrite</span><span class="p">);</span>
 <span class="mi">476</span> 
 <span class="mi">477</span>     <span class="c1">// make sure that if the mshr was due to a whole line write then</span>
 <span class="mi">478</span>     <span class="c1">// the response is an invalidation</span>
 <span class="mi">479</span>     <span class="nf">assert</span><span class="p">(</span><span class="o">!</span><span class="n">mshr</span><span class="o">-&gt;</span><span class="n">wasWholeLineWrite</span> <span class="o">||</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">isInvalidate</span><span class="p">());</span>
 <span class="mi">480</span> 
 <span class="mi">481</span>     <span class="n">CacheBlk</span> <span class="o">*</span><span class="n">blk</span> <span class="o">=</span> <span class="n">tags</span><span class="o">-&gt;</span><span class="n">findBlock</span><span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">getAddr</span><span class="p">(),</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">isSecure</span><span class="p">());</span>
 <span class="mi">482</span> 
 <span class="mi">483</span>     <span class="nf">if</span> <span class="p">(</span><span class="n">is_fill</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">is_error</span><span class="p">)</span> <span class="p">{</span>
 <span class="mi">484</span>         <span class="n">DPRINTF</span><span class="p">(</span><span class="n">Cache</span><span class="p">,</span> <span class="s">"Block for addr %#llx being updated in Cache</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
 <span class="mi">485</span>                 <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">getAddr</span><span class="p">());</span>
 <span class="mi">486</span> 
 <span class="mi">487</span>         <span class="k">const</span> <span class="kt">bool</span> <span class="n">allocate</span> <span class="o">=</span> <span class="p">(</span><span class="n">writeAllocator</span> <span class="o">&amp;&amp;</span> <span class="n">mshr</span><span class="o">-&gt;</span><span class="n">wasWholeLineWrite</span><span class="p">)</span> <span class="o">?</span>
 <span class="mi">488</span>             <span class="n">writeAllocator</span><span class="o">-&gt;</span><span class="n">allocate</span><span class="p">()</span> <span class="o">:</span> <span class="n">mshr</span><span class="o">-&gt;</span><span class="n">allocOnFill</span><span class="p">();</span>
 <span class="mi">489</span>         <span class="n">blk</span> <span class="o">=</span> <span class="n">handleFill</span><span class="p">(</span><span class="n">pkt</span><span class="p">,</span> <span class="n">blk</span><span class="p">,</span> <span class="n">writebacks</span><span class="p">,</span> <span class="n">allocate</span><span class="p">);</span>
 <span class="mi">490</span>         <span class="n">assert</span><span class="p">(</span><span class="n">blk</span> <span class="o">!=</span> <span class="nb">nullptr</span><span class="p">);</span>
 <span class="mi">491</span>         <span class="n">ppFill</span><span class="o">-&gt;</span><span class="n">notify</span><span class="p">(</span><span class="n">pkt</span><span class="p">);</span>
 <span class="mi">492</span>     <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>
<p>First of all, it needs to search the current cache to find out the block
mapped to the current request’s address.</p>

<h3 id="handlefill"><span class="me-2">handleFill</span><a href="#handlefill" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre></td><td class="rouge-code"><pre><span class="mi">1433</span> <span class="n">CacheBlk</span><span class="o">*</span>
<span class="mi">1434</span> <span class="n">BaseCache</span><span class="o">::</span><span class="n">handleFill</span><span class="p">(</span><span class="n">PacketPtr</span> <span class="n">pkt</span><span class="p">,</span> <span class="n">CacheBlk</span> <span class="o">*</span><span class="n">blk</span><span class="p">,</span> <span class="n">PacketList</span> <span class="o">&amp;</span><span class="n">writebacks</span><span class="p">,</span>
<span class="mi">1435</span>                       <span class="kt">bool</span> <span class="n">allocate</span><span class="p">)</span>
<span class="mi">1436</span> <span class="p">{</span>
<span class="mi">1437</span>     <span class="n">assert</span><span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">isResponse</span><span class="p">());</span>
<span class="mi">1438</span>     <span class="n">Addr</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">getAddr</span><span class="p">();</span>
<span class="mi">1439</span>     <span class="kt">bool</span> <span class="n">is_secure</span> <span class="o">=</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">isSecure</span><span class="p">();</span>
<span class="mi">1440</span>     <span class="k">const</span> <span class="kt">bool</span> <span class="n">has_old_data</span> <span class="o">=</span> <span class="n">blk</span> <span class="o">&amp;&amp;</span> <span class="n">blk</span><span class="o">-&gt;</span><span class="n">isValid</span><span class="p">();</span>
<span class="mi">1441</span>     <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">old_state</span> <span class="o">=</span> <span class="n">blk</span> <span class="o">?</span> <span class="n">blk</span><span class="o">-&gt;</span><span class="n">print</span><span class="p">()</span> <span class="o">:</span> <span class="s">""</span><span class="p">;</span>
<span class="mi">1442</span> 
<span class="mi">1443</span>     <span class="c1">// When handling a fill, we should have no writes to this line.</span>
<span class="mi">1444</span>     <span class="n">assert</span><span class="p">(</span><span class="n">addr</span> <span class="o">==</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">getBlockAddr</span><span class="p">(</span><span class="n">blkSize</span><span class="p">));</span>
<span class="mi">1445</span>     <span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">writeBuffer</span><span class="p">.</span><span class="n">findMatch</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">is_secure</span><span class="p">));</span>
<span class="mi">1446</span> 
<span class="mi">1447</span>     <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">blk</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">1448</span>         <span class="c1">// better have read new data...</span>
<span class="mi">1449</span>         <span class="n">assert</span><span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">hasData</span><span class="p">()</span> <span class="o">||</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">MemCmd</span><span class="o">::</span><span class="n">InvalidateResp</span><span class="p">);</span>
<span class="mi">1450</span> 
<span class="mi">1451</span>         <span class="c1">// need to do a replacement if allocating, otherwise we stick</span>
<span class="mi">1452</span>         <span class="c1">// with the temporary storage</span>
<span class="mi">1453</span>         <span class="n">blk</span> <span class="o">=</span> <span class="n">allocate</span> <span class="o">?</span> <span class="n">allocateBlock</span><span class="p">(</span><span class="n">pkt</span><span class="p">,</span> <span class="n">writebacks</span><span class="p">)</span> <span class="o">:</span> <span class="nb">nullptr</span><span class="p">;</span>
<span class="mi">1454</span> 
<span class="mi">1455</span>         <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">blk</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">1456</span>             <span class="c1">// No replaceable block or a mostly exclusive</span>
<span class="mi">1457</span>             <span class="c1">// cache... just use temporary storage to complete the</span>
<span class="mi">1458</span>             <span class="c1">// current request and then get rid of it</span>
<span class="mi">1459</span>             <span class="n">blk</span> <span class="o">=</span> <span class="n">tempBlock</span><span class="p">;</span>
<span class="mi">1460</span>             <span class="n">tempBlock</span><span class="o">-&gt;</span><span class="n">insert</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">is_secure</span><span class="p">);</span>
<span class="mi">1461</span>             <span class="n">DPRINTF</span><span class="p">(</span><span class="n">Cache</span><span class="p">,</span> <span class="s">"using temp block for %#llx (%s)</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span>
<span class="mi">1462</span>                     <span class="n">is_secure</span> <span class="o">?</span> <span class="s">"s"</span> <span class="o">:</span> <span class="s">"ns"</span><span class="p">);</span>
<span class="mi">1463</span>         <span class="p">}</span>
<span class="mi">1464</span>     <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="mi">1465</span>         <span class="c1">// existing block... probably an upgrade</span>
<span class="mi">1466</span>         <span class="c1">// don't clear block status... if block is already dirty we</span>
<span class="mi">1467</span>         <span class="c1">// don't want to lose that</span>
<span class="mi">1468</span>     <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>
<p>When the blk is nullptr, 
it allocates new block 
depending on the allocate flag.
When the flat is set, it allocates new block in the cache 
by invoking allocateBlock function. Note that writebacks is passed 
together with the packet. When the cache has no slot for the 
new data, then it evicts the pre-allocated one and will be handled 
by the writebacks. 
If there is no require for allocating new block, 
it assigns tempBlock instead of allocating new one.
Note that it is required because the block is necessary in any case 
to process the current request.</p>

<p>The allocate flag is determined mostly based on the inclusiveness of
current cache level. 
When current cache level is exclusive to the lower cache level,
it doesn’t need to allocate cache line for the current cache level 
and just forward the request to the upper level.
Note that even for the exclusive cache, if one cache level is 
higher than the other, the request from more higher level cache 
or the memory should goes through the current cache level.</p>

<h3 id="setcoherencebits"><span class="me-2">setCoherenceBits:???</span><a href="#setcoherencebits" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
</pre></td><td class="rouge-code"><pre><span class="mi">1469</span> 
<span class="mi">1470</span>     <span class="c1">// Block is guaranteed to be valid at this point</span>
<span class="mi">1471</span>     <span class="nf">assert</span><span class="p">(</span><span class="n">blk</span><span class="o">-&gt;</span><span class="n">isValid</span><span class="p">());</span>
<span class="mi">1472</span>     <span class="nf">assert</span><span class="p">(</span><span class="n">blk</span><span class="o">-&gt;</span><span class="n">isSecure</span><span class="p">()</span> <span class="o">==</span> <span class="n">is_secure</span><span class="p">);</span>
<span class="mi">1473</span>     <span class="nf">assert</span><span class="p">(</span><span class="n">regenerateBlkAddr</span><span class="p">(</span><span class="n">blk</span><span class="p">)</span> <span class="o">==</span> <span class="n">addr</span><span class="p">);</span>
<span class="mi">1474</span> 
<span class="mi">1475</span>     <span class="n">blk</span><span class="o">-&gt;</span><span class="n">setCoherenceBits</span><span class="p">(</span><span class="n">CacheBlk</span><span class="o">::</span><span class="n">ReadableBit</span><span class="p">);</span>
<span class="mi">1476</span> 
<span class="mi">1477</span>     <span class="c1">// sanity check for whole-line writes, which should always be</span>
<span class="mi">1478</span>     <span class="c1">// marked as writable as part of the fill, and then later marked</span>
<span class="mi">1479</span>     <span class="c1">// dirty as part of satisfyRequest</span>
<span class="mi">1480</span>     <span class="nf">if</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">MemCmd</span><span class="o">::</span><span class="n">InvalidateResp</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">1481</span>         <span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">hasSharers</span><span class="p">());</span>
<span class="mi">1482</span>     <span class="p">}</span>
<span class="mi">1483</span> 
<span class="mi">1484</span>     <span class="c1">// here we deal with setting the appropriate state of the line,</span>
<span class="mi">1485</span>     <span class="c1">// and we start by looking at the hasSharers flag, and ignore the</span>
<span class="mi">1486</span>     <span class="c1">// cacheResponding flag (normally signalling dirty data) if the</span>
<span class="mi">1487</span>     <span class="c1">// packet has sharers, thus the line is never allocated as Owned</span>
<span class="mi">1488</span>     <span class="c1">// (dirty but not writable), and always ends up being either</span>
<span class="mi">1489</span>     <span class="c1">// Shared, Exclusive or Modified, see Packet::setCacheResponding</span>
<span class="mi">1490</span>     <span class="c1">// for more details</span>
<span class="mi">1491</span>     <span class="nf">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">hasSharers</span><span class="p">())</span> <span class="p">{</span>
<span class="mi">1492</span>         <span class="c1">// we could get a writable line from memory (rather than a</span>
<span class="mi">1493</span>         <span class="c1">// cache) even in a read-only cache, note that we set this bit</span>
<span class="mi">1494</span>         <span class="c1">// even for a read-only cache, possibly revisit this decision</span>
<span class="mi">1495</span>         <span class="n">blk</span><span class="o">-&gt;</span><span class="n">setCoherenceBits</span><span class="p">(</span><span class="n">CacheBlk</span><span class="o">::</span><span class="n">WritableBit</span><span class="p">);</span>
<span class="mi">1496</span> 
<span class="mi">1497</span>         <span class="c1">// check if we got this via cache-to-cache transfer (i.e., from a</span>
<span class="mi">1498</span>         <span class="c1">// cache that had the block in Modified or Owned state)</span>
<span class="mi">1499</span>         <span class="k">if</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">cacheResponding</span><span class="p">())</span> <span class="p">{</span>
<span class="mi">1500</span>             <span class="c1">// we got the block in Modified state, and invalidated the</span>
<span class="mi">1501</span>             <span class="c1">// owners copy</span>
<span class="mi">1502</span>             <span class="n">blk</span><span class="o">-&gt;</span><span class="n">setCoherenceBits</span><span class="p">(</span><span class="n">CacheBlk</span><span class="o">::</span><span class="n">DirtyBit</span><span class="p">);</span>
<span class="mi">1503</span> 
<span class="mi">1504</span>             <span class="n">chatty_assert</span><span class="p">(</span><span class="o">!</span><span class="n">isReadOnly</span><span class="p">,</span> <span class="s">"Should never see dirty snoop response "</span>
<span class="mi">1505</span>                           <span class="s">"in read-only cache %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">name</span><span class="p">());</span>
<span class="mi">1506</span> 
<span class="mi">1507</span>         <span class="p">}</span>
<span class="mi">1508</span>     <span class="p">}</span>
<span class="mi">1509</span> 
<span class="mi">1510</span>     <span class="nf">DPRINTF</span><span class="p">(</span><span class="n">Cache</span><span class="p">,</span> <span class="s">"Block addr %#llx (%s) moving from %s to %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
<span class="mi">1511</span>             <span class="n">addr</span><span class="p">,</span> <span class="n">is_secure</span> <span class="o">?</span> <span class="s">"s"</span> <span class="o">:</span> <span class="s">"ns"</span><span class="p">,</span> <span class="n">old_state</span><span class="p">,</span> <span class="n">blk</span><span class="o">-&gt;</span><span class="n">print</span><span class="p">());</span>
<span class="mi">1512</span> 
</pre></td></tr></tbody></table></code></div></div>

<h3 id="filling-the-block-and-returning-the-filled-block"><span class="me-2">Filling the block and returning the filled block</span><a href="#filling-the-block-and-returning-the-filled-block" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre><span class="mi">1513</span>     <span class="c1">// if we got new data, copy it in (checking for a read response</span>
<span class="mi">1514</span>     <span class="c1">// and a response that has data is the same in the end)</span>
<span class="mi">1515</span>     <span class="nf">if</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">isRead</span><span class="p">())</span> <span class="p">{</span>
<span class="mi">1516</span>         <span class="c1">// sanity checks</span>
<span class="mi">1517</span>         <span class="n">assert</span><span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">hasData</span><span class="p">());</span>
<span class="mi">1518</span>         <span class="n">assert</span><span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">getSize</span><span class="p">()</span> <span class="o">==</span> <span class="n">blkSize</span><span class="p">);</span>
<span class="mi">1519</span> 
<span class="mi">1520</span>         <span class="n">updateBlockData</span><span class="p">(</span><span class="n">blk</span><span class="p">,</span> <span class="n">pkt</span><span class="p">,</span> <span class="n">has_old_data</span><span class="p">);</span>
<span class="mi">1521</span>     <span class="p">}</span>
<span class="mi">1522</span>     <span class="c1">// The block will be ready when the payload arrives and the fill is done</span>
<span class="mi">1523</span>     <span class="n">blk</span><span class="o">-&gt;</span><span class="n">setWhenReady</span><span class="p">(</span><span class="n">clockEdge</span><span class="p">(</span><span class="n">fillLatency</span><span class="p">)</span> <span class="o">+</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">headerDelay</span> <span class="o">+</span>
<span class="mi">1524</span>                       <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">payloadDelay</span><span class="p">);</span>
<span class="mi">1525</span> 
<span class="mi">1526</span>     <span class="k">return</span> <span class="n">blk</span><span class="p">;</span>
<span class="mi">1527</span> <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre></td><td class="rouge-code"><pre> <span class="mi">694</span> <span class="kt">void</span>
 <span class="mi">695</span> <span class="n">BaseCache</span><span class="o">::</span><span class="n">updateBlockData</span><span class="p">(</span><span class="n">CacheBlk</span> <span class="o">*</span><span class="n">blk</span><span class="p">,</span> <span class="k">const</span> <span class="n">PacketPtr</span> <span class="n">cpkt</span><span class="p">,</span>
 <span class="mi">696</span>     <span class="kt">bool</span> <span class="n">has_old_data</span><span class="p">)</span>
 <span class="mi">697</span> <span class="p">{</span>
 <span class="mi">698</span>     <span class="n">DataUpdate</span> <span class="n">data_update</span><span class="p">(</span><span class="n">regenerateBlkAddr</span><span class="p">(</span><span class="n">blk</span><span class="p">),</span> <span class="n">blk</span><span class="o">-&gt;</span><span class="n">isSecure</span><span class="p">());</span>
 <span class="mi">699</span>     <span class="k">if</span> <span class="p">(</span><span class="n">ppDataUpdate</span><span class="o">-&gt;</span><span class="n">hasListeners</span><span class="p">())</span> <span class="p">{</span>
 <span class="mi">700</span>         <span class="k">if</span> <span class="p">(</span><span class="n">has_old_data</span><span class="p">)</span> <span class="p">{</span>
 <span class="mi">701</span>             <span class="n">data_update</span><span class="p">.</span><span class="n">oldData</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">uint64_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">blk</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
 <span class="mi">702</span>                 <span class="n">blk</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="p">(</span><span class="n">blkSize</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint64_t</span><span class="p">)));</span>
 <span class="mi">703</span>         <span class="p">}</span>
 <span class="mi">704</span>     <span class="p">}</span>
 <span class="mi">705</span> 
 <span class="mi">706</span>     <span class="c1">// Actually perform the data update</span>
 <span class="mi">707</span>     <span class="nf">if</span> <span class="p">(</span><span class="n">cpkt</span><span class="p">)</span> <span class="p">{</span>
 <span class="mi">708</span>         <span class="n">cpkt</span><span class="o">-&gt;</span><span class="n">writeDataToBlock</span><span class="p">(</span><span class="n">blk</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">blkSize</span><span class="p">);</span>
 <span class="mi">709</span>     <span class="p">}</span>
 <span class="mi">710</span> 
 <span class="mi">711</span>     <span class="nf">if</span> <span class="p">(</span><span class="n">ppDataUpdate</span><span class="o">-&gt;</span><span class="n">hasListeners</span><span class="p">())</span> <span class="p">{</span>
 <span class="mi">712</span>         <span class="k">if</span> <span class="p">(</span><span class="n">cpkt</span><span class="p">)</span> <span class="p">{</span>
 <span class="mi">713</span>             <span class="n">data_update</span><span class="p">.</span><span class="n">newData</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">uint64_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">blk</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
 <span class="mi">714</span>                 <span class="n">blk</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="p">(</span><span class="n">blkSize</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint64_t</span><span class="p">)));</span>
 <span class="mi">715</span>         <span class="p">}</span>
 <span class="mi">716</span>         <span class="n">ppDataUpdate</span><span class="o">-&gt;</span><span class="n">notify</span><span class="p">(</span><span class="n">data_update</span><span class="p">);</span>
 <span class="mi">717</span>     <span class="p">}</span>
 <span class="mi">718</span> <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>
<p>The actual data write is done by the updateBlockData function.
Because the received packet contains the actual data 
that should be filled in the cache block, 
it copies the data from the packet to the cache block.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="mi">271</span>     <span class="cm">/**  
272      * Set tick at which block's data will be available for access. The new
273      * tick must be chronologically sequential with respect to previous
274      * accesses.
275      *   
276      * @param tick New data ready tick.
277      */</span>  
<span class="mi">278</span>     <span class="kt">void</span> <span class="nf">setWhenReady</span><span class="p">(</span><span class="k">const</span> <span class="n">Tick</span> <span class="n">tick</span><span class="p">)</span>
<span class="mi">279</span>     <span class="p">{</span>        
<span class="mi">280</span>         <span class="n">assert</span><span class="p">(</span><span class="n">tick</span> <span class="o">&gt;=</span> <span class="n">_tickInserted</span><span class="p">);</span>
<span class="mi">281</span>         <span class="n">whenReady</span> <span class="o">=</span> <span class="n">tick</span><span class="p">;</span>
<span class="mi">282</span>     <span class="p">}</span>    
</pre></td></tr></tbody></table></code></div></div>

<p>Also, it needs to set the when the block will becomes ready 
by invoking setWhenReady function.</p>

<h2 id="promote-mshr-and-service-its-targets-recvtimingresp"><span class="me-2">Promote MSHR and service its targets (recvTimingResp)</span><a href="#promote-mshr-and-service-its-targets-recvtimingresp" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="rouge-code"><pre> <span class="mi">493</span> 
 <span class="mi">494</span>     <span class="nf">if</span> <span class="p">(</span><span class="n">blk</span> <span class="o">&amp;&amp;</span> <span class="n">blk</span><span class="o">-&gt;</span><span class="n">isValid</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">isClean</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">isInvalidate</span><span class="p">())</span> <span class="p">{</span>
 <span class="mi">495</span>         <span class="c1">// The block was marked not readable while there was a pending</span>
 <span class="mi">496</span>         <span class="c1">// cache maintenance operation, restore its flag.</span>
 <span class="mi">497</span>         <span class="n">blk</span><span class="o">-&gt;</span><span class="n">setCoherenceBits</span><span class="p">(</span><span class="n">CacheBlk</span><span class="o">::</span><span class="n">ReadableBit</span><span class="p">);</span>
 <span class="mi">498</span> 
 <span class="mi">499</span>         <span class="c1">// This was a cache clean operation (without invalidate)</span>
 <span class="mi">500</span>         <span class="c1">// and we have a copy of the block already. Since there</span>
 <span class="mi">501</span>         <span class="c1">// is no invalidation, we can promote targets that don't</span>
 <span class="mi">502</span>         <span class="c1">// require a writable copy</span>
 <span class="mi">503</span>         <span class="n">mshr</span><span class="o">-&gt;</span><span class="n">promoteReadable</span><span class="p">();</span>
 <span class="mi">504</span>     <span class="p">}</span>
 <span class="mi">505</span> 
 <span class="mi">506</span>     <span class="nf">if</span> <span class="p">(</span><span class="n">blk</span> <span class="o">&amp;&amp;</span> <span class="n">blk</span><span class="o">-&gt;</span><span class="n">isSet</span><span class="p">(</span><span class="n">CacheBlk</span><span class="o">::</span><span class="n">WritableBit</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
 <span class="mi">507</span>         <span class="o">!</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">isCacheInvalidate</span><span class="p">())</span> <span class="p">{</span>
 <span class="mi">508</span>         <span class="c1">// If at this point the referenced block is writable and the</span>
 <span class="mi">509</span>         <span class="c1">// response is not a cache invalidate, we promote targets that</span>
 <span class="mi">510</span>         <span class="c1">// were deferred as we couldn't guarrantee a writable copy</span>
 <span class="mi">511</span>         <span class="n">mshr</span><span class="o">-&gt;</span><span class="n">promoteWritable</span><span class="p">();</span>
 <span class="mi">512</span>     <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<h2 id="servicemshrtargets-recvtimingresp"><span class="me-2">serviceMSHRTargets (recvTimingResp)</span><a href="#servicemshrtargets-recvtimingresp" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre> <span class="mi">514</span>     <span class="nf">serviceMSHRTargets</span><span class="p">(</span><span class="n">mshr</span><span class="p">,</span> <span class="n">pkt</span><span class="p">,</span> <span class="n">blk</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></div></div>
<p>Although it has updated the cache block, still the targets of the MSHR entries 
are waiting the data block is coming to the cache.
The main job of the serviceMSHRTargets function is looping 
targets of the MSHR entries associates with currently received response packet. 
Because there are three different sources for the targets, 
it should be handled differently.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
</pre></td><td class="rouge-code"><pre> <span class="mi">683</span> <span class="kt">void</span>
 <span class="mi">684</span> <span class="n">Cache</span><span class="o">::</span><span class="n">serviceMSHRTargets</span><span class="p">(</span><span class="n">MSHR</span> <span class="o">*</span><span class="n">mshr</span><span class="p">,</span> <span class="k">const</span> <span class="n">PacketPtr</span> <span class="n">pkt</span><span class="p">,</span> <span class="n">CacheBlk</span> <span class="o">*</span><span class="n">blk</span><span class="p">)</span>
 <span class="mi">685</span> <span class="p">{</span>
 <span class="mi">686</span>     <span class="n">QueueEntry</span><span class="o">::</span><span class="n">Target</span> <span class="o">*</span><span class="n">initial_tgt</span> <span class="o">=</span> <span class="n">mshr</span><span class="o">-&gt;</span><span class="n">getTarget</span><span class="p">();</span>
 <span class="mi">687</span>     <span class="c1">// First offset for critical word first calculations</span>
 <span class="mi">688</span>     <span class="k">const</span> <span class="kt">int</span> <span class="n">initial_offset</span> <span class="o">=</span> <span class="n">initial_tgt</span><span class="o">-&gt;</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">getOffset</span><span class="p">(</span><span class="n">blkSize</span><span class="p">);</span>
 <span class="mi">689</span> 
 <span class="mi">690</span>     <span class="k">const</span> <span class="kt">bool</span> <span class="n">is_error</span> <span class="o">=</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">isError</span><span class="p">();</span>
 <span class="mi">691</span>     <span class="c1">// allow invalidation responses originating from write-line</span>
 <span class="mi">692</span>     <span class="c1">// requests to be discarded</span>
 <span class="mi">693</span>     <span class="kt">bool</span> <span class="n">is_invalidate</span> <span class="o">=</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">isInvalidate</span><span class="p">()</span> <span class="o">&amp;&amp;</span>
 <span class="mi">694</span>         <span class="o">!</span><span class="n">mshr</span><span class="o">-&gt;</span><span class="n">wasWholeLineWrite</span><span class="p">;</span>
 <span class="mi">695</span> 
 <span class="mi">696</span>     <span class="n">MSHR</span><span class="o">::</span><span class="n">TargetList</span> <span class="n">targets</span> <span class="o">=</span> <span class="n">mshr</span><span class="o">-&gt;</span><span class="n">extractServiceableTargets</span><span class="p">(</span><span class="n">pkt</span><span class="p">);</span>
 <span class="mi">697</span>     <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="n">target</span><span class="o">:</span> <span class="n">targets</span><span class="p">)</span> <span class="p">{</span>
 <span class="mi">698</span>         <span class="n">Packet</span> <span class="o">*</span><span class="n">tgt_pkt</span> <span class="o">=</span> <span class="n">target</span><span class="p">.</span><span class="n">pkt</span><span class="p">;</span>
 <span class="mi">699</span>         <span class="k">switch</span> <span class="p">(</span><span class="n">target</span><span class="p">.</span><span class="n">source</span><span class="p">)</span> <span class="p">{</span>
 <span class="mi">700</span>           <span class="k">case</span> <span class="n">MSHR</span><span class="o">::</span><span class="n">Target</span><span class="o">::</span><span class="n">FromCPU</span><span class="p">:</span>
 <span class="mi">701</span>             <span class="n">Tick</span> <span class="n">completion_time</span><span class="p">;</span>
 <span class="mi">702</span>             <span class="c1">// Here we charge on completion_time the delay of the xbar if the</span>
 <span class="mi">703</span>             <span class="c1">// packet comes from it, charged on headerDelay.</span>
 <span class="mi">704</span>             <span class="n">completion_time</span> <span class="o">=</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">headerDelay</span><span class="p">;</span>
 <span class="mi">705</span> 
 <span class="mi">706</span>             <span class="c1">// Software prefetch handling for cache closest to core</span>
 <span class="mi">707</span>             <span class="k">if</span> <span class="p">(</span><span class="n">tgt_pkt</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">isSWPrefetch</span><span class="p">())</span> <span class="p">{</span>
 <span class="mi">708</span>                 <span class="k">if</span> <span class="p">(</span><span class="n">tgt_pkt</span><span class="o">-&gt;</span><span class="n">needsWritable</span><span class="p">())</span> <span class="p">{</span>
 <span class="mi">709</span>                     <span class="c1">// All other copies of the block were invalidated and we</span>
 <span class="mi">710</span>                     <span class="c1">// have an exclusive copy.</span>
 <span class="mi">711</span> 
 <span class="mi">712</span>                     <span class="c1">// The coherence protocol assumes that if we fetched an</span>
 <span class="mi">713</span>                     <span class="c1">// exclusive copy of the block, we have the intention to</span>
 <span class="mi">714</span>                     <span class="c1">// modify it. Therefore the MSHR for the PrefetchExReq has</span>
 <span class="mi">715</span>                     <span class="c1">// been the point of ordering and this cache has commited</span>
 <span class="mi">716</span>                     <span class="c1">// to respond to snoops for the block.</span>
 <span class="mi">717</span>                     <span class="c1">//</span>
 <span class="mi">718</span>                     <span class="c1">// In most cases this is true anyway - a PrefetchExReq</span>
 <span class="mi">719</span>                     <span class="c1">// will be followed by a WriteReq. However, if that</span>
 <span class="mi">720</span>                     <span class="c1">// doesn't happen, the block is not marked as dirty and</span>
 <span class="mi">721</span>                     <span class="c1">// the cache doesn't respond to snoops that has committed</span>
 <span class="mi">722</span>                     <span class="c1">// to do so.</span>
 <span class="mi">723</span>                     <span class="c1">//</span>
 <span class="mi">724</span>                     <span class="c1">// To avoid deadlocks in cases where there is a snoop</span>
 <span class="mi">725</span>                     <span class="c1">// between the PrefetchExReq and the expected WriteReq, we</span>
 <span class="mi">726</span>                     <span class="c1">// proactively mark the block as Dirty.</span>
 <span class="mi">727</span>                     <span class="n">assert</span><span class="p">(</span><span class="n">blk</span><span class="p">);</span>
 <span class="mi">728</span>                     <span class="n">blk</span><span class="o">-&gt;</span><span class="n">setCoherenceBits</span><span class="p">(</span><span class="n">CacheBlk</span><span class="o">::</span><span class="n">DirtyBit</span><span class="p">);</span>
 <span class="mi">729</span> 
 <span class="mi">730</span>                     <span class="n">panic_if</span><span class="p">(</span><span class="n">isReadOnly</span><span class="p">,</span> <span class="s">"Prefetch exclusive requests from "</span>
 <span class="mi">731</span>                             <span class="s">"read-only cache %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">name</span><span class="p">());</span>
 <span class="mi">732</span>                 <span class="p">}</span>
 <span class="mi">733</span> 
 <span class="mi">734</span>                 <span class="c1">// a software prefetch would have already been ack'd</span>
 <span class="mi">735</span>                 <span class="c1">// immediately with dummy data so the core would be able to</span>
 <span class="mi">736</span>                 <span class="c1">// retire it. This request completes right here, so we</span>
 <span class="mi">737</span>                 <span class="c1">// deallocate it.</span>
 <span class="mi">738</span>                 <span class="k">delete</span> <span class="n">tgt_pkt</span><span class="p">;</span>
 <span class="mi">739</span>                 <span class="k">break</span><span class="p">;</span> <span class="c1">// skip response</span>
 <span class="mi">740</span>             <span class="p">}</span>
 <span class="mi">741</span> 
 <span class="mi">742</span>             <span class="c1">// unlike the other packet flows, where data is found in other</span>
 <span class="mi">743</span>             <span class="c1">// caches or memory and brought back, write-line requests always</span>
 <span class="mi">744</span>             <span class="c1">// have the data right away, so the above check for "is fill?"</span>
 <span class="mi">745</span>             <span class="c1">// cannot actually be determined until examining the stored MSHR</span>
 <span class="mi">746</span>             <span class="c1">// state. We "catch up" with that logic here, which is duplicated</span>
 <span class="mi">747</span>             <span class="c1">// from above.</span>
 <span class="mi">748</span>             <span class="nf">if</span> <span class="p">(</span><span class="n">tgt_pkt</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">MemCmd</span><span class="o">::</span><span class="n">WriteLineReq</span><span class="p">)</span> <span class="p">{</span>
 <span class="mi">749</span>                 <span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">is_error</span><span class="p">);</span>
 <span class="mi">750</span>                 <span class="n">assert</span><span class="p">(</span><span class="n">blk</span><span class="p">);</span>
 <span class="mi">751</span>                 <span class="n">assert</span><span class="p">(</span><span class="n">blk</span><span class="o">-&gt;</span><span class="n">isSet</span><span class="p">(</span><span class="n">CacheBlk</span><span class="o">::</span><span class="n">WritableBit</span><span class="p">));</span>
 <span class="mi">752</span>             <span class="p">}</span>
 <span class="mi">753</span> 
 <span class="mi">754</span>             <span class="c1">// Here we decide whether we will satisfy the target using</span>
 <span class="mi">755</span>             <span class="c1">// data from the block or from the response. We use the</span>
 <span class="mi">756</span>             <span class="c1">// block data to satisfy the request when the block is</span>
 <span class="mi">757</span>             <span class="c1">// present and valid and in addition the response in not</span>
 <span class="mi">758</span>             <span class="c1">// forwarding data to the cache above (we didn't fill</span>
 <span class="mi">759</span>             <span class="c1">// either); otherwise we use the packet data.</span>
 <span class="mi">760</span>             <span class="nf">if</span> <span class="p">(</span><span class="n">blk</span> <span class="o">&amp;&amp;</span> <span class="n">blk</span><span class="o">-&gt;</span><span class="n">isValid</span><span class="p">()</span> <span class="o">&amp;&amp;</span>
 <span class="mi">761</span>                 <span class="p">(</span><span class="o">!</span><span class="n">mshr</span><span class="o">-&gt;</span><span class="n">isForward</span> <span class="o">||</span> <span class="o">!</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">hasData</span><span class="p">()))</span> <span class="p">{</span>
 <span class="mi">762</span>                 <span class="n">satisfyRequest</span><span class="p">(</span><span class="n">tgt_pkt</span><span class="p">,</span> <span class="n">blk</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="n">mshr</span><span class="o">-&gt;</span><span class="n">hasPostDowngrade</span><span class="p">());</span>
 <span class="mi">763</span> 
 <span class="mi">764</span>                 <span class="c1">// How many bytes past the first request is this one</span>
 <span class="mi">765</span>                 <span class="kt">int</span> <span class="n">transfer_offset</span> <span class="o">=</span>
 <span class="mi">766</span>                     <span class="n">tgt_pkt</span><span class="o">-&gt;</span><span class="n">getOffset</span><span class="p">(</span><span class="n">blkSize</span><span class="p">)</span> <span class="o">-</span> <span class="n">initial_offset</span><span class="p">;</span>
 <span class="mi">767</span>                 <span class="k">if</span> <span class="p">(</span><span class="n">transfer_offset</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
 <span class="mi">768</span>                     <span class="n">transfer_offset</span> <span class="o">+=</span> <span class="n">blkSize</span><span class="p">;</span>
 <span class="mi">769</span>                 <span class="p">}</span>
 <span class="mi">770</span> 
 <span class="mi">771</span>                 <span class="c1">// If not critical word (offset) return payloadDelay.</span>
 <span class="mi">772</span>                 <span class="c1">// responseLatency is the latency of the return path</span>
 <span class="mi">773</span>                 <span class="c1">// from lower level caches/memory to an upper level cache or</span>
 <span class="mi">774</span>                 <span class="c1">// the core.</span>
 <span class="mi">775</span>                 <span class="n">completion_time</span> <span class="o">+=</span> <span class="n">clockEdge</span><span class="p">(</span><span class="n">responseLatency</span><span class="p">)</span> <span class="o">+</span>
 <span class="mi">776</span>                     <span class="p">(</span><span class="n">transfer_offset</span> <span class="o">?</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">payloadDelay</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
 <span class="mi">777</span> 
 <span class="mi">778</span>                 <span class="nf">assert</span><span class="p">(</span><span class="o">!</span><span class="n">tgt_pkt</span><span class="o">-&gt;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">isUncacheable</span><span class="p">());</span>
 <span class="mi">779</span> 
 <span class="mi">780</span>                 <span class="nf">assert</span><span class="p">(</span><span class="n">tgt_pkt</span><span class="o">-&gt;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">requestorId</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">system</span><span class="o">-&gt;</span><span class="n">maxRequestors</span><span class="p">());</span>
 <span class="mi">781</span>                 <span class="n">stats</span><span class="p">.</span><span class="n">cmdStats</span><span class="p">(</span><span class="n">tgt_pkt</span><span class="p">)</span>
 <span class="mi">782</span>                     <span class="p">.</span><span class="n">missLatency</span><span class="p">[</span><span class="n">tgt_pkt</span><span class="o">-&gt;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">requestorId</span><span class="p">()]</span> <span class="o">+=</span>
 <span class="mi">783</span>                     <span class="n">completion_time</span> <span class="o">-</span> <span class="n">target</span><span class="p">.</span><span class="n">recvTime</span><span class="p">;</span>
 <span class="mi">784</span>             <span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">MemCmd</span><span class="o">::</span><span class="n">UpgradeFailResp</span><span class="p">)</span> <span class="p">{</span>
 <span class="mi">785</span>                 <span class="c1">// failed StoreCond upgrade</span>
 <span class="mi">786</span>                 <span class="n">assert</span><span class="p">(</span><span class="n">tgt_pkt</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">MemCmd</span><span class="o">::</span><span class="n">StoreCondReq</span> <span class="o">||</span>
 <span class="mi">787</span>                        <span class="n">tgt_pkt</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">MemCmd</span><span class="o">::</span><span class="n">StoreCondFailReq</span> <span class="o">||</span>
 <span class="mi">788</span>                        <span class="n">tgt_pkt</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">MemCmd</span><span class="o">::</span><span class="n">SCUpgradeFailReq</span><span class="p">);</span>
 <span class="mi">789</span>                 <span class="c1">// responseLatency is the latency of the return path</span>
 <span class="mi">790</span>                 <span class="c1">// from lower level caches/memory to an upper level cache or</span>
 <span class="mi">791</span>                 <span class="c1">// the core.</span>
 <span class="mi">792</span>                 <span class="n">completion_time</span> <span class="o">+=</span> <span class="n">clockEdge</span><span class="p">(</span><span class="n">responseLatency</span><span class="p">)</span> <span class="o">+</span>
 <span class="mi">793</span>                     <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">payloadDelay</span><span class="p">;</span>
 <span class="mi">794</span>                 <span class="n">tgt_pkt</span><span class="o">-&gt;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">setExtraData</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
 <span class="mi">795</span>             <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
 <span class="mi">796</span>                 <span class="k">if</span> <span class="p">(</span><span class="n">is_invalidate</span> <span class="o">&amp;&amp;</span> <span class="n">blk</span> <span class="o">&amp;&amp;</span> <span class="n">blk</span><span class="o">-&gt;</span><span class="n">isValid</span><span class="p">())</span> <span class="p">{</span>
 <span class="mi">797</span>                     <span class="c1">// We are about to send a response to a cache above</span>
 <span class="mi">798</span>                     <span class="c1">// that asked for an invalidation; we need to</span>
 <span class="mi">799</span>                     <span class="c1">// invalidate our copy immediately as the most</span>
 <span class="mi">800</span>                     <span class="c1">// up-to-date copy of the block will now be in the</span>
 <span class="mi">801</span>                     <span class="c1">// cache above. It will also prevent this cache from</span>
 <span class="mi">802</span>                     <span class="c1">// responding (if the block was previously dirty) to</span>
 <span class="mi">803</span>                     <span class="c1">// snoops as they should snoop the caches above where</span>
 <span class="mi">804</span>                     <span class="c1">// they will get the response from.</span>
 <span class="mi">805</span>                     <span class="n">invalidateBlock</span><span class="p">(</span><span class="n">blk</span><span class="p">);</span>
 <span class="mi">806</span>                 <span class="p">}</span>
 <span class="mi">807</span>                 <span class="c1">// not a cache fill, just forwarding response</span>
 <span class="mi">808</span>                 <span class="c1">// responseLatency is the latency of the return path</span>
 <span class="mi">809</span>                 <span class="c1">// from lower level cahces/memory to the core.</span>
 <span class="mi">810</span>                 <span class="n">completion_time</span> <span class="o">+=</span> <span class="n">clockEdge</span><span class="p">(</span><span class="n">responseLatency</span><span class="p">)</span> <span class="o">+</span>
 <span class="mi">811</span>                     <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">payloadDelay</span><span class="p">;</span>
 <span class="mi">812</span>                 <span class="nf">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_error</span><span class="p">)</span> <span class="p">{</span>
 <span class="mi">813</span>                     <span class="k">if</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">isRead</span><span class="p">())</span> <span class="p">{</span>
 <span class="mi">814</span>                         <span class="c1">// sanity check</span>
 <span class="mi">815</span>                         <span class="n">assert</span><span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">matchAddr</span><span class="p">(</span><span class="n">tgt_pkt</span><span class="p">));</span>
 <span class="mi">816</span>                         <span class="n">assert</span><span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">getSize</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="n">tgt_pkt</span><span class="o">-&gt;</span><span class="n">getSize</span><span class="p">());</span>
 <span class="mi">817</span> 
 <span class="mi">818</span>                         <span class="n">tgt_pkt</span><span class="o">-&gt;</span><span class="n">setData</span><span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">getConstPtr</span><span class="o">&lt;</span><span class="kt">uint8_t</span><span class="o">&gt;</span><span class="p">());</span>
 <span class="mi">819</span>                     <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
 <span class="mi">820</span>                         <span class="c1">// MSHR targets can read data either from the</span>
 <span class="mi">821</span>                         <span class="c1">// block or the response pkt. If we can't get data</span>
 <span class="mi">822</span>                         <span class="c1">// from the block (i.e., invalid or has old data)</span>
 <span class="mi">823</span>                         <span class="c1">// or the response (did not bring in any data)</span>
 <span class="mi">824</span>                         <span class="c1">// then make sure that the target didn't expect</span>
 <span class="mi">825</span>                         <span class="c1">// any.</span>
 <span class="mi">826</span>                         <span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">tgt_pkt</span><span class="o">-&gt;</span><span class="n">hasRespData</span><span class="p">());</span>
 <span class="mi">827</span>                     <span class="p">}</span>
 <span class="mi">828</span>                 <span class="p">}</span>
 <span class="mi">829</span> 
 <span class="mi">830</span>                 <span class="c1">// this response did not allocate here and therefore</span>
 <span class="mi">831</span>                 <span class="c1">// it was not consumed, make sure that any flags are</span>
 <span class="mi">832</span>                 <span class="c1">// carried over to cache above</span>
 <span class="mi">833</span>                 <span class="n">tgt_pkt</span><span class="o">-&gt;</span><span class="n">copyResponderFlags</span><span class="p">(</span><span class="n">pkt</span><span class="p">);</span>
 <span class="mi">834</span>             <span class="p">}</span>
 <span class="mi">835</span>             <span class="n">tgt_pkt</span><span class="o">-&gt;</span><span class="n">makeTimingResponse</span><span class="p">();</span>
 <span class="mi">836</span>             <span class="c1">// if this packet is an error copy that to the new packet</span>
 <span class="mi">837</span>             <span class="nf">if</span> <span class="p">(</span><span class="n">is_error</span><span class="p">)</span>
 <span class="mi">838</span>                 <span class="n">tgt_pkt</span><span class="o">-&gt;</span><span class="n">copyError</span><span class="p">(</span><span class="n">pkt</span><span class="p">);</span>
 <span class="mi">839</span>             <span class="nf">if</span> <span class="p">(</span><span class="n">tgt_pkt</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">MemCmd</span><span class="o">::</span><span class="n">ReadResp</span> <span class="o">&amp;&amp;</span>
 <span class="mi">840</span>                 <span class="p">(</span><span class="n">is_invalidate</span> <span class="o">||</span> <span class="n">mshr</span><span class="o">-&gt;</span><span class="n">hasPostInvalidate</span><span class="p">()))</span> <span class="p">{</span>
 <span class="mi">841</span>                 <span class="c1">// If intermediate cache got ReadRespWithInvalidate,</span>
 <span class="mi">842</span>                 <span class="c1">// propagate that.  Response should not have</span>
 <span class="mi">843</span>                 <span class="c1">// isInvalidate() set otherwise.</span>
 <span class="mi">844</span>                 <span class="n">tgt_pkt</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">MemCmd</span><span class="o">::</span><span class="n">ReadRespWithInvalidate</span><span class="p">;</span>
 <span class="mi">845</span>                 <span class="n">DPRINTF</span><span class="p">(</span><span class="n">Cache</span><span class="p">,</span> <span class="s">"%s: updated cmd to %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
 <span class="mi">846</span>                         <span class="n">tgt_pkt</span><span class="o">-&gt;</span><span class="n">print</span><span class="p">());</span>
 <span class="mi">847</span>             <span class="p">}</span>
 <span class="mi">848</span>             <span class="c1">// Reset the bus additional time as it is now accounted for</span>
 <span class="mi">849</span>             <span class="n">tgt_pkt</span><span class="o">-&gt;</span><span class="n">headerDelay</span> <span class="o">=</span> <span class="n">tgt_pkt</span><span class="o">-&gt;</span><span class="n">payloadDelay</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
 <span class="mi">850</span>             <span class="n">cpuSidePort</span><span class="p">.</span><span class="n">schedTimingResp</span><span class="p">(</span><span class="n">tgt_pkt</span><span class="p">,</span> <span class="n">completion_time</span><span class="p">);</span>
 <span class="mi">851</span>             <span class="k">break</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></div></div>

<p>For the FromCPU case, there are two main conditions that we need to take care. 
First of all, when the blk associated with current cache block response 
is available, then it will invoke satisfyRequest function. 
However, when the blk points to nullptr, then 
it just copies data from the response packet to the packet 
selected among the targets. 
Regardless of the availability of the blk, 
it invokes schedTimingResp through the cpuSidePort 
to send the response packet to the upper cache or processor. 
Note that this response packet deliver one of targets of the resolved MSHR. 
At the time of exit of the loop, all packers associated with the resolved MSHR entry
will be handled.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
</pre></td><td class="rouge-code"><pre> <span class="mi">853</span>           <span class="k">case</span> <span class="n">MSHR</span><span class="o">::</span><span class="n">Target</span><span class="o">::</span><span class="n">FromPrefetcher</span><span class="p">:</span>
 <span class="mi">854</span>             <span class="nf">assert</span><span class="p">(</span><span class="n">tgt_pkt</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">MemCmd</span><span class="o">::</span><span class="n">HardPFReq</span><span class="p">);</span>
 <span class="mi">855</span>             <span class="nf">if</span> <span class="p">(</span><span class="n">blk</span><span class="p">)</span>
 <span class="mi">856</span>                 <span class="n">blk</span><span class="o">-&gt;</span><span class="n">setPrefetched</span><span class="p">();</span>
 <span class="mi">857</span>             <span class="k">delete</span> <span class="n">tgt_pkt</span><span class="p">;</span>
 <span class="mi">858</span>             <span class="k">break</span><span class="p">;</span>
 <span class="mi">859</span> 
 <span class="mi">860</span>           <span class="k">case</span> <span class="n">MSHR</span><span class="o">::</span><span class="n">Target</span><span class="o">::</span><span class="n">FromSnoop</span><span class="p">:</span>
 <span class="mi">861</span>             <span class="c1">// I don't believe that a snoop can be in an error state</span>
 <span class="mi">862</span>             <span class="nf">assert</span><span class="p">(</span><span class="o">!</span><span class="n">is_error</span><span class="p">);</span>
 <span class="mi">863</span>             <span class="c1">// response to snoop request</span>
 <span class="mi">864</span>             <span class="nf">DPRINTF</span><span class="p">(</span><span class="n">Cache</span><span class="p">,</span> <span class="s">"processing deferred snoop...</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
 <span class="mi">865</span>             <span class="c1">// If the response is invalidating, a snooping target can</span>
 <span class="mi">866</span>             <span class="c1">// be satisfied if it is also invalidating. If the reponse is, not</span>
 <span class="mi">867</span>             <span class="c1">// only invalidating, but more specifically an InvalidateResp and</span>
 <span class="mi">868</span>             <span class="c1">// the MSHR was created due to an InvalidateReq then a cache above</span>
 <span class="mi">869</span>             <span class="c1">// is waiting to satisfy a WriteLineReq. In this case even an</span>
 <span class="mi">870</span>             <span class="c1">// non-invalidating snoop is added as a target here since this is</span>
 <span class="mi">871</span>             <span class="c1">// the ordering point. When the InvalidateResp reaches this cache,</span>
 <span class="mi">872</span>             <span class="c1">// the snooping target will snoop further the cache above with the</span>
 <span class="mi">873</span>             <span class="c1">// WriteLineReq.</span>
 <span class="mi">874</span>             <span class="nf">assert</span><span class="p">(</span><span class="o">!</span><span class="n">is_invalidate</span> <span class="o">||</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">MemCmd</span><span class="o">::</span><span class="n">InvalidateResp</span> <span class="o">||</span>
 <span class="mi">875</span>                    <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">isCacheMaintenance</span><span class="p">()</span> <span class="o">||</span>
 <span class="mi">876</span>                    <span class="n">mshr</span><span class="o">-&gt;</span><span class="n">hasPostInvalidate</span><span class="p">());</span>
 <span class="mi">877</span>             <span class="nf">handleSnoop</span><span class="p">(</span><span class="n">tgt_pkt</span><span class="p">,</span> <span class="n">blk</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="n">mshr</span><span class="o">-&gt;</span><span class="n">hasPostInvalidate</span><span class="p">());</span>
 <span class="mi">878</span>             <span class="k">break</span><span class="p">;</span>
 <span class="mi">879</span> 
 <span class="mi">880</span>           <span class="k">default</span><span class="o">:</span>
 <span class="mi">881</span>             <span class="nf">panic</span><span class="p">(</span><span class="s">"Illegal target-&gt;source enum %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">target</span><span class="p">.</span><span class="n">source</span><span class="p">);</span>
 <span class="mi">882</span>         <span class="p">}</span>
 <span class="mi">883</span>     <span class="p">}</span>
 <span class="mi">884</span> 
 <span class="mi">885</span>     <span class="nf">maintainClusivity</span><span class="p">(</span><span class="n">targets</span><span class="p">.</span><span class="n">hasFromCache</span><span class="p">,</span> <span class="n">blk</span><span class="p">);</span>
 <span class="mi">886</span> 
 <span class="mi">887</span>     <span class="nf">if</span> <span class="p">(</span><span class="n">blk</span> <span class="o">&amp;&amp;</span> <span class="n">blk</span><span class="o">-&gt;</span><span class="n">isValid</span><span class="p">())</span> <span class="p">{</span>
 <span class="mi">888</span>         <span class="c1">// an invalidate response stemming from a write line request</span>
 <span class="mi">889</span>         <span class="c1">// should not invalidate the block, so check if the</span>
 <span class="mi">890</span>         <span class="c1">// invalidation should be discarded</span>
 <span class="mi">891</span>         <span class="k">if</span> <span class="p">(</span><span class="n">is_invalidate</span> <span class="o">||</span> <span class="n">mshr</span><span class="o">-&gt;</span><span class="n">hasPostInvalidate</span><span class="p">())</span> <span class="p">{</span>
 <span class="mi">892</span>             <span class="n">invalidateBlock</span><span class="p">(</span><span class="n">blk</span><span class="p">);</span>
 <span class="mi">893</span>         <span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">mshr</span><span class="o">-&gt;</span><span class="n">hasPostDowngrade</span><span class="p">())</span> <span class="p">{</span>
 <span class="mi">894</span>             <span class="n">blk</span><span class="o">-&gt;</span><span class="n">clearCoherenceBits</span><span class="p">(</span><span class="n">CacheBlk</span><span class="o">::</span><span class="n">WritableBit</span><span class="p">);</span>
 <span class="mi">895</span>         <span class="p">}</span>
 <span class="mi">896</span>     <span class="p">}</span>
 <span class="mi">897</span> <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>## Finishing MSHR resolving (recvTimingResp)</p>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
</pre></td><td class="rouge-code"><pre> <span class="mi">516</span>     <span class="nf">if</span> <span class="p">(</span><span class="n">mshr</span><span class="o">-&gt;</span><span class="n">promoteDeferredTargets</span><span class="p">())</span> <span class="p">{</span>
 <span class="mi">517</span>         <span class="c1">// avoid later read getting stale data while write miss is</span>
 <span class="mi">518</span>         <span class="c1">// outstanding.. see comment in timingAccess()</span>
 <span class="mi">519</span>         <span class="k">if</span> <span class="p">(</span><span class="n">blk</span><span class="p">)</span> <span class="p">{</span>
 <span class="mi">520</span>             <span class="n">blk</span><span class="o">-&gt;</span><span class="n">clearCoherenceBits</span><span class="p">(</span><span class="n">CacheBlk</span><span class="o">::</span><span class="n">ReadableBit</span><span class="p">);</span>
 <span class="mi">521</span>         <span class="p">}</span>
 <span class="mi">522</span>         <span class="n">mshrQueue</span><span class="p">.</span><span class="n">markPending</span><span class="p">(</span><span class="n">mshr</span><span class="p">);</span>
 <span class="mi">523</span>         <span class="nf">schedMemSideSendEvent</span><span class="p">(</span><span class="n">clockEdge</span><span class="p">()</span> <span class="o">+</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">payloadDelay</span><span class="p">);</span>
 <span class="mi">524</span>     <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
 <span class="mi">525</span>         <span class="c1">// while we deallocate an mshr from the queue we still have to</span>
 <span class="mi">526</span>         <span class="c1">// check the isFull condition before and after as we might</span>
 <span class="mi">527</span>         <span class="c1">// have been using the reserved entries already</span>
 <span class="mi">528</span>         <span class="k">const</span> <span class="kt">bool</span> <span class="n">was_full</span> <span class="o">=</span> <span class="n">mshrQueue</span><span class="p">.</span><span class="n">isFull</span><span class="p">();</span>
 <span class="mi">529</span>         <span class="n">mshrQueue</span><span class="p">.</span><span class="n">deallocate</span><span class="p">(</span><span class="n">mshr</span><span class="p">);</span>
 <span class="mi">530</span>         <span class="k">if</span> <span class="p">(</span><span class="n">was_full</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">mshrQueue</span><span class="p">.</span><span class="n">isFull</span><span class="p">())</span> <span class="p">{</span>
 <span class="mi">531</span>             <span class="n">clearBlocked</span><span class="p">(</span><span class="n">Blocked_NoMSHRs</span><span class="p">);</span>
 <span class="mi">532</span>         <span class="p">}</span>
 <span class="mi">533</span> 
 <span class="mi">534</span>         <span class="c1">// Request the bus for a prefetch if this deallocation freed enough</span>
 <span class="mi">535</span>         <span class="c1">// MSHRs for a prefetch to take place</span>
 <span class="mi">536</span>         <span class="nf">if</span> <span class="p">(</span><span class="n">prefetcher</span> <span class="o">&amp;&amp;</span> <span class="n">mshrQueue</span><span class="p">.</span><span class="n">canPrefetch</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">isBlocked</span><span class="p">())</span> <span class="p">{</span>
 <span class="mi">537</span>             <span class="n">Tick</span> <span class="n">next_pf_time</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">max</span><span class="p">(</span><span class="n">prefetcher</span><span class="o">-&gt;</span><span class="n">nextPrefetchReadyTime</span><span class="p">(),</span>
 <span class="mi">538</span>                                          <span class="n">clockEdge</span><span class="p">());</span>
 <span class="mi">539</span>             <span class="k">if</span> <span class="p">(</span><span class="n">next_pf_time</span> <span class="o">!=</span> <span class="n">MaxTick</span><span class="p">)</span>
 <span class="mi">540</span>                 <span class="n">schedMemSideSendEvent</span><span class="p">(</span><span class="n">next_pf_time</span><span class="p">);</span>
 <span class="mi">541</span>         <span class="p">}</span>
 <span class="mi">542</span>     <span class="p">}</span>
 <span class="mi">543</span> 
 <span class="mi">544</span>     <span class="c1">// if we used temp block, check to see if its valid and then clear it out</span>
 <span class="mi">545</span>     <span class="nf">if</span> <span class="p">(</span><span class="n">blk</span> <span class="o">==</span> <span class="n">tempBlock</span> <span class="o">&amp;&amp;</span> <span class="n">tempBlock</span><span class="o">-&gt;</span><span class="n">isValid</span><span class="p">())</span> <span class="p">{</span>
 <span class="mi">546</span>         <span class="n">evictBlock</span><span class="p">(</span><span class="n">blk</span><span class="p">,</span> <span class="n">writebacks</span><span class="p">);</span>
 <span class="mi">547</span>     <span class="p">}</span>
 <span class="mi">548</span> 
 <span class="mi">549</span>     <span class="k">const</span> <span class="n">Tick</span> <span class="n">forward_time</span> <span class="o">=</span> <span class="n">clockEdge</span><span class="p">(</span><span class="n">forwardLatency</span><span class="p">)</span> <span class="o">+</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">headerDelay</span><span class="p">;</span>
 <span class="mi">550</span>     <span class="c1">// copy writebacks to write buffer</span>
 <span class="mi">551</span>     <span class="nf">doWritebacks</span><span class="p">(</span><span class="n">writebacks</span><span class="p">,</span> <span class="n">forward_time</span><span class="p">);</span>
 <span class="mi">552</span> 
 <span class="mi">553</span>     <span class="nf">DPRINTF</span><span class="p">(</span><span class="n">CacheVerbose</span><span class="p">,</span> <span class="s">"%s: Leaving with %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">print</span><span class="p">());</span>
 <span class="mi">554</span>     <span class="k">delete</span> <span class="n">pkt</span><span class="p">;</span>
 <span class="mi">555</span> <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>After processing all targets of the currently selected MSHR entry, 
we should promote deferred targets or deallocate the MSHR entry.
Although we finish processing the targets of the selected MSHR, 
there could be deferred targets for that MSHR entry.
In that case, those targets should be moved to the MSHR, and 
the selected MSHR should not be freed. 
However, if there is no deferred targets, then the selected MSHR 
can be freed. 
Also, if the cache was blocked because of full of MSHR, 
it clear blocking. Furthermore, if possible, 
it generates prefetch request and send it to the memory. 
After the deallocation, 
the evicted packet should be written backs to the higher level cache 
or the memory. The doWritebacks function handles this write back operations.
Also, when the current block is tempBlock and no cache entry has been allocated
for the current response, it should evict the current block.
\XXX{I don’t know why tempBlock need to be evicted here..? Cause it didn’t generate new cache block..}</p>


  </div>

  <div class="post-tail-wrapper text-muted">
    <!-- categories -->
    

    <!-- tags -->
    

    <div
      class="
        post-tail-bottom
        d-flex justify-content-between align-items-center mt-5 pb-2
      "
    >
      <div class="license-wrapper">
        
          

          This post is licensed under 
        <a href="https://creativecommons.org/licenses/by/4.0/">
          CC BY 4.0
        </a>
         by the author.
        
      </div>

      <!-- Post sharing snippet -->

<div class="share-wrapper d-flex align-items-center">
  <span class="share-label text-muted">Share</span>
  <span class="share-icons">
    
    
    

    

      

      <a
        href="https://twitter.com/intent/tweet?text=O3%20Cache%20Recv%20-%20Ruach&url=https%3A%2F%2Fruach.github.io%2Fposts%2FO3-cache-recv%2F"
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Twitter"
        target="_blank"
        rel="noopener"
        aria-label="Twitter"
      >
        <i class="fa-fw fa-brands fa-square-x-twitter"></i>
      </a>
    

      

      <a
        href="https://www.facebook.com/sharer/sharer.php?title=O3%20Cache%20Recv%20-%20Ruach&u=https%3A%2F%2Fruach.github.io%2Fposts%2FO3-cache-recv%2F"
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Facebook"
        target="_blank"
        rel="noopener"
        aria-label="Facebook"
      >
        <i class="fa-fw fab fa-facebook-square"></i>
      </a>
    

      

      <a
        href="https://t.me/share/url?url=https%3A%2F%2Fruach.github.io%2Fposts%2FO3-cache-recv%2F&text=O3%20Cache%20Recv%20-%20Ruach"
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Telegram"
        target="_blank"
        rel="noopener"
        aria-label="Telegram"
      >
        <i class="fa-fw fab fa-telegram"></i>
      </a>
    

      

      <a
        href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fruach.github.io%2Fposts%2FO3-cache-recv%2F"
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Linkedin"
        target="_blank"
        rel="noopener"
        aria-label="Linkedin"
      >
        <i class="fa-fw fab fa-linkedin"></i>
      </a>
    

    <button
      id="copy-link"
      aria-label="Copy link"
      class="btn small"
      data-bs-toggle="tooltip"
      data-bs-placement="top"
      title="Copy link"
      data-title-succeed="Link copied successfully!"
    >
      <i class="fa-fw fas fa-link pe-none fs-6"></i>
    </button>
  </span>
</div>

    </div>
    <!-- .post-tail-bottom -->
  </div>
  <!-- div.post-tail-wrapper -->
</article>


            
          </main>

          <!-- panel -->
          <aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 mb-5 text-muted">
            <div class="access">
              <!-- Get the last 5 posts from lastmod list. -->















              <!-- The trending tags list -->


















            </div>

            
              
              



  <section id="toc-wrapper" class="ps-0 pe-4">
    <h2 class="panel-heading ps-3 pt-2 mb-2">Contents</h2>
    <nav id="toc"></nav>
  </section>


            
          </aside>
        </div>

        <div class="row">
          <!-- tail -->
          <div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4">
            
              
              <!-- Recommend the other 3 posts according to the tags and categories of the current post. -->

<!-- The total size of related posts -->


<!-- An random integer that bigger than 0 -->


<!-- Equals to TAG_SCORE / {max_categories_hierarchy} -->

























            
              
              <!-- Navigation buttons at the bottom of the post. -->

<nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation">
  
  

  
    <a
      href="/posts/O3-CPU-commit/"
      class="btn btn-outline-primary"
      aria-label="Older"
    >
      <p>O3 Cpu Commit</p>
    </a>
  

  
    <a
      href="/posts/O3-cache-block/"
      class="btn btn-outline-primary"
      aria-label="Newer"
    >
      <p>O3 Cache Block</p>
    </a>
  
</nav>

            
              
              <!--  The comments switcher -->

  
  <!-- The Disqus lazy loading. -->

<div id="disqus_thread">
  <p class="text-center text-muted small">Comments powered by <a href="https://disqus.com/">Disqus</a>.</p>
</div>

<script type="text/javascript">
  var disqus_config = function () {
    this.page.url = 'https://ruach.github.io/posts/O3-cache-recv/';
    this.page.identifier = '/posts/O3-cache-recv/';
  };

  /* Lazy loading */
  var disqus_observer = new IntersectionObserver(
    function (entries) {
      if (entries[0].isIntersecting) {
        (function () {
          var d = document,
            s = d.createElement('script');
          s.src = 'https://ruach.disqus.com/embed.js';
          s.setAttribute('data-timestamp', +new Date());
          (d.head || d.body).appendChild(s);
        })();

        disqus_observer.disconnect();
      }
    },
    { threshold: [0] }
  );

  disqus_observer.observe(document.querySelector('#disqus_thread'));

  /* Auto switch theme */
  function reloadDisqus() {
    if (event.source === window && event.data && event.data.direction === ModeToggle.ID) {
      /* Disqus hasn't been loaded */
      if (typeof DISQUS === 'undefined') {
        return;
      }

      if (document.readyState == 'complete') {
        DISQUS.reset({ reload: true, config: disqus_config });
      }
    }
  }

  if (document.querySelector('.mode-toggle')) {
    window.addEventListener('message', reloadDisqus);
  }
</script>



            

            <!-- The Footer -->

<footer
  aria-label="Site Info"
  class="
    d-flex flex-column justify-content-center text-muted
    flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3
  "
>
  <p>
    ©
    <time>2023</time>
    <a href="https://ruach.github.io">Jaehyuk Lee</a>.
    
      <span
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author."
      >Some rights reserved.</span>
    
  </p>

  <p>Using the <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme for <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>
  </p>
</footer>

          </div>
        </div>

        <!-- The Search results -->

<div id="search-result-wrapper" class="d-flex justify-content-center unloaded">
  <div class="col-11 content">
    <div id="search-hints">
      <!-- The trending tags list -->


















    </div>
    <div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div>
  </div>
</div>

      </div>

      <aside aria-label="Scroll to Top">
        <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow">
          <i class="fas fa-angle-up"></i>
        </button>
      </aside>
    </div>

    <div id="mask"></div>

    
      <aside
  id="notification"
  class="toast"
  role="alert"
  aria-live="assertive"
  aria-atomic="true"
  data-bs-animation="true"
  data-bs-autohide="false"
>
  <div class="toast-header">
    <button
      type="button"
      class="btn-close ms-auto"
      data-bs-dismiss="toast"
      aria-label="Close"
    ></button>
  </div>
  <div class="toast-body text-center pt-0">
    <p class="px-2 mb-3">A new version of content is available.</p>
    <button type="button" class="btn btn-primary" aria-label="Update">
      Update
    </button>
  </div>
</aside>

    

    <!-- JavaScripts -->

    <!-- JS selector for site. -->

<!-- commons -->



<!-- layout specified -->


  

  
    <!-- image lazy-loading & popup & clipboard -->
    
  















  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  



  <script src="https://cdn.jsdelivr.net/combine/npm/jquery@3.7.1/dist/jquery.min.js,npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js,npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/magnific-popup@1.1.0/dist/jquery.magnific-popup.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.10/dayjs.min.js,npm/dayjs@1.11.10/locale/en.min.js,npm/dayjs@1.11.10/plugin/relativeTime.min.js,npm/dayjs@1.11.10/plugin/localizedFormat.min.js,npm/tocbot@4.21.2/dist/tocbot.min.js"></script>






<script defer src="/assets/js/dist/post.min.js"></script>






    

    <!--
  Jekyll Simple Search loader
  See: <https://github.com/christian-fei/Simple-Jekyll-Search>
-->





<script>
  /* Note: dependent library will be loaded in `js-selector.html` */
  SimpleJekyllSearch({
    searchInput: document.getElementById('search-input'),
    resultsContainer: document.getElementById('search-results'),
    json: '/assets/js/data/search.json',
    searchResultTemplate: '  <article class="px-1 px-sm-2 px-lg-4 px-xl-0">    <header>      <h2><a href="{url}">{title}</a></h2>      <div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1">        {categories}        {tags}      </div>    </header>    <p>{snippet}</p>  </article>',
    noResultsText: '<p class="mt-5"></p>',
    templateMiddleware: function(prop, value, template) {
      if (prop === 'categories') {
        if (value === '') {
          return `${value}`;
        } else {
          return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`;
        }
      }

      if (prop === 'tags') {
        if (value === '') {
          return `${value}`;
        } else {
          return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`;
        }
      }
    }
  });
</script>

  </body>
</html>

