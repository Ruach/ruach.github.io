<!doctype html>














<!-- `site.alt_lang` can specify a language different from the UI -->
<html lang="en" data-mode="light">
  <!-- The Head -->

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta
    name="viewport"
    content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover"
  >

  

  

  
    <!-- Begin Jekyll SEO tag v2.8.0 -->
<meta name="generator" content="Jekyll v4.3.3" />
<meta property="og:title" content="QEMU Side Memory Management for VM with RAMBLOCK" />
<meta property="og:locale" content="en" />
<meta name="description" content="QEMU side memory management The MemoryRegion is the link between guest physical address space and the RAMBlocks containing the memory. Each MemoryRegion has the ram_addr_t offset of the RAMBlock and each RAMBlock has a MemoryRegion pointer. Note that MemoryRegion is more general than just RAM. It can also represent I/O memory where read/write callback functions are invoked on access. This is how hardware register accesses from a guest CPU are dispatched to emulated devices. The address_space_rw() function dispatches load/store accesses to the appropriate MemoryRegions. If a MemoryRegion is a RAM region then the data will be accessed from the RAMBlock’s mmapped guest RAM. The address_space_memory global variable is the guest physical memory space." />
<meta property="og:description" content="QEMU side memory management The MemoryRegion is the link between guest physical address space and the RAMBlocks containing the memory. Each MemoryRegion has the ram_addr_t offset of the RAMBlock and each RAMBlock has a MemoryRegion pointer. Note that MemoryRegion is more general than just RAM. It can also represent I/O memory where read/write callback functions are invoked on access. This is how hardware register accesses from a guest CPU are dispatched to emulated devices. The address_space_rw() function dispatches load/store accesses to the appropriate MemoryRegions. If a MemoryRegion is a RAM region then the data will be accessed from the RAMBlock’s mmapped guest RAM. The address_space_memory global variable is the guest physical memory space." />
<link rel="canonical" href="https://ruach.github.io/posts/QEMU-KVM-ADDRESS-SPACE/" />
<meta property="og:url" content="https://ruach.github.io/posts/QEMU-KVM-ADDRESS-SPACE/" />
<meta property="og:site_name" content="Ruach" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2023-04-11T00:00:00-04:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="QEMU Side Memory Management for VM with RAMBLOCK" />
<meta name="twitter:site" content="@ruach_lee" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2023-04-11T00:00:00-04:00","datePublished":"2023-04-11T00:00:00-04:00","description":"QEMU side memory management The MemoryRegion is the link between guest physical address space and the RAMBlocks containing the memory. Each MemoryRegion has the ram_addr_t offset of the RAMBlock and each RAMBlock has a MemoryRegion pointer. Note that MemoryRegion is more general than just RAM. It can also represent I/O memory where read/write callback functions are invoked on access. This is how hardware register accesses from a guest CPU are dispatched to emulated devices. The address_space_rw() function dispatches load/store accesses to the appropriate MemoryRegions. If a MemoryRegion is a RAM region then the data will be accessed from the RAMBlock’s mmapped guest RAM. The address_space_memory global variable is the guest physical memory space.","headline":"QEMU Side Memory Management for VM with RAMBLOCK","mainEntityOfPage":{"@type":"WebPage","@id":"https://ruach.github.io/posts/QEMU-KVM-ADDRESS-SPACE/"},"url":"https://ruach.github.io/posts/QEMU-KVM-ADDRESS-SPACE/"}</script>
<!-- End Jekyll SEO tag -->

  

  <title>QEMU Side Memory Management for VM with RAMBLOCK | Ruach
  </title>

  <!--
  The Favicons for Web, Android, Microsoft, and iOS (iPhone and iPad) Apps
  Generated by: https://realfavicongenerator.net/
-->



<link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png">
<link rel="manifest" href="/assets/img/favicons/site.webmanifest">
<link rel="shortcut icon" href="/assets/img/favicons/favicon.ico">
<meta name="apple-mobile-web-app-title" content="Ruach">
<meta name="application-name" content="Ruach">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml">
<meta name="theme-color" content="#ffffff">


  
    
      <link rel="preconnect" href="https://fonts.googleapis.com" >
      <link rel="dns-prefetch" href="https://fonts.googleapis.com" >
    
      <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      <link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin>
    
      <link rel="preconnect" href="https://fonts.googleapis.com" >
      <link rel="dns-prefetch" href="https://fonts.googleapis.com" >
    
      <link rel="preconnect" href="https://cdn.jsdelivr.net" >
      <link rel="dns-prefetch" href="https://cdn.jsdelivr.net" >
    

    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap">
  

  <!-- GA -->
  

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.2/css/all.min.css">

  <link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css">

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.21.2/dist/tocbot.min.css">
  

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css">
  

  
    <!-- Manific Popup -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css">
  

  <!-- JavaScript -->

  

  <!-- A placeholder to allow defining custom metadata -->

</head>


  <body>
    <!-- The Side Bar -->

<aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end">
  <header class="profile-wrapper">
    <a href="/" id="avatar" class="rounded-circle">
      
        
        <img src="/assets/img/jaehyuk.png" width="112" height="112" alt="avatar" onerror="this.style.display='none'">
      
    </a>

    <h1 class="site-title">
      <a href="/">Ruach</a>
    </h1>
    <p class="site-subtitle fst-italic mb-0">Jaehyuk Lee</p>
  </header>
  <!-- .profile-wrapper -->

  <nav class="flex-column flex-grow-1 w-100 ps-0">
    <ul class="nav">
      <!-- home -->
      <li class="nav-item">
        <a href="/" class="nav-link">
          <i class="fa-fw fas fa-home"></i>
          <span>HOME</span>
        </a>
      </li>
      <!-- the real tabs -->
      
        <li class="nav-item">
          <a href="/categories/" class="nav-link">
            <i class="fa-fw fas fa-stream"></i>
            

            <span>CATEGORIES</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/archives/" class="nav-link">
            <i class="fa-fw fas fa-archive"></i>
            

            <span>ARCHIVES</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/about/" class="nav-link">
            <i class="fa-fw fas fa-info-circle"></i>
            

            <span>ABOUT</span>
          </a>
        </li>
        <!-- .nav-item -->
      
    </ul>
  </nav>

  <div class="sidebar-bottom d-flex flex-wrap  align-items-center w-100">
    

    
      

      
        <a
          href="javascript:location.href = 'mailto:' + ['jaehyuk','gatech.edu'].join('@')"
          aria-label="email"
          

          

          

          
        >
          <i class="fas fa-envelope"></i>
        </a>
      
    
      

      
        <a
          href="https://www.linkedin.com/in/jaehyuk-lee-29b33b121/"
          aria-label="linkedin"
          

          
            target="_blank"
            
          

          

          
            rel="noopener noreferrer"
          
        >
          <i class="fab fa-linkedin"></i>
        </a>
      
    
      

      
        <a
          href="https://github.com/Ruach"
          aria-label="github"
          

          
            target="_blank"
            
          

          

          
            rel="noopener noreferrer"
          
        >
          <i class="fab fa-github"></i>
        </a>
      
    
      

      
        <a
          href="https://stackoverflow.com/users/4460514/ruach?tab=profile"
          aria-label="stack-overflow"
          

          
            target="_blank"
            
          

          

          
            rel="noopener noreferrer"
          
        >
          <i class="fab fa-stack-overflow"></i>
        </a>
      
    
  </div>
  <!-- .sidebar-bottom -->
</aside>
<!-- #sidebar -->


    <div id="main-wrapper" class="d-flex justify-content-center">
      <div class="container d-flex flex-column px-xxl-5">
        <!-- The Top Bar -->

<header id="topbar-wrapper" aria-label="Top Bar">
  <div
    id="topbar"
    class="d-flex align-items-center justify-content-between px-lg-3 h-100"
  >
    <nav id="breadcrumb" aria-label="Breadcrumb">
      

      
        
          
            <span>
              <a href="/">
                Home
              </a>
            </span>

          
        
          
        
          
            
              <span>QEMU Side Memory Management for VM with RAMBLOCK</span>
            

          
        
      
    </nav>
    <!-- endof #breadcrumb -->

    <button type="button" id="sidebar-trigger" class="btn btn-link">
      <i class="fas fa-bars fa-fw"></i>
    </button>

    <div id="topbar-title">
      Post
    </div>

    <button type="button" id="search-trigger" class="btn btn-link">
      <i class="fas fa-search fa-fw"></i>
    </button>

    <search class="align-items-center ms-3 ms-lg-0">
      <i class="fas fa-search fa-fw"></i>
      <input
        class="form-control"
        id="search-input"
        type="search"
        aria-label="search"
        autocomplete="off"
        placeholder="Search..."
      >
    </search>
    <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button>
  </div>
</header>


        <div class="row flex-grow-1">
          <main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4">
            
              <!-- Refactor the HTML structure -->



<!--
  In order to allow a wide table to scroll horizontally,
  we suround the markdown table with `<div class="table-wrapper">` and `</div>`
-->



<!--
  Fixed kramdown code highlight rendering:
  https://github.com/penibelst/jekyll-compress-html/issues/101
  https://github.com/penibelst/jekyll-compress-html/issues/71#issuecomment-188144901
-->



<!-- Change the icon of checkbox -->



<!-- Handle images -->





<!-- Add header for code snippets -->



<!-- Create heading anchors -->





  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    

    
  

  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    

    
  

  
  

  

  
  

  




<!-- return -->




<article class="px-1">
  <header>
    <h1 data-toc-skip>QEMU Side Memory Management for VM with RAMBLOCK</h1>

    <div class="post-meta text-muted">
      <!-- published date -->
      <span>
        Posted
        <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1681185600"
  data-df="ll"
  
    data-bs-toggle="tooltip" data-bs-placement="bottom"
  
>
  Apr 11, 2023
</time>

      </span>

      <!-- lastmod date -->
      

      

      <div class="d-flex justify-content-between">
        <!-- author(s) -->
        <span>
          

          By

          <em>
            
              <a href="https://ruach.github.io">Jaehyuk Lee</a>
            
          </em>
        </span>

        <!-- read time -->
        <!-- Calculate the post's reading time, and display the word count in tooltip -->



<!-- words per minute -->










<!-- return element -->
<span
  class="readtime"
  data-bs-toggle="tooltip"
  data-bs-placement="bottom"
  title="4668 words"
>
  <em>25 min</em> read</span>

      </div>
      <!-- .d-flex -->
    </div>
    <!-- .post-meta -->
  </header>

  <div class="content">
    <h2 id="qemu-side-memory-management"><span class="me-2">QEMU side memory management</span><a href="#qemu-side-memory-management" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<blockquote>
  <p><strong>The MemoryRegion is the link between guest physical address space and the 
RAMBlocks containing the memory</strong>. Each MemoryRegion has the ram_addr_t offset 
of the RAMBlock and each RAMBlock has a MemoryRegion pointer.
Note that MemoryRegion is more general than just RAM. It can also represent I/O
memory where read/write callback functions are invoked on access. This is how 
hardware register accesses from a guest CPU are dispatched to emulated devices.
The address_space_rw() function dispatches load/store accesses to the 
appropriate MemoryRegions. If a MemoryRegion is a RAM region then the data will
be accessed from the RAMBlock’s mmapped guest RAM. The <strong>address_space_memory</strong> 
global variable is the guest physical memory space.</p>
</blockquote>

<p>http://blog.vmsplice.net/2016/01/qemu-internals-how-guest-physical-ram.html</p>

<blockquote>
  <p>A region is created by one of the memory_region_init*() functions and attached
to an object, which acts as its owner or parent. QEMU ensures that the owner 
object remains alive as long as the region is visible to the guest, or as long
as the region is in use by a virtual CPU or another device. After creation, a 
<strong>region can be added to an address space or a container</strong> with 
memory_region_add_subregion(), and removed using memory_region_del_subregion().</p>
</blockquote>

<p>https://qemu.weilnetz.de/doc/devel/memory.html</p>

<h3 id="important-data-structures-managing-vms-on-qemu-side"><span class="me-2">Important data structures managing VMs on QEMU side</span><a href="#important-data-structures-managing-vms-on-qemu-side" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre></td><td class="rouge-code"><pre><span class="k">struct</span> <span class="nc">KVMState</span>
<span class="p">{</span>
    <span class="n">AccelState</span> <span class="n">parent_obj</span><span class="p">;</span>

    <span class="kt">int</span> <span class="n">nr_slots</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">fd</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">vmfd</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">coalesced_mmio</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">coalesced_pio</span><span class="p">;</span>
    <span class="k">struct</span> <span class="nc">kvm_coalesced_mmio_ring</span> <span class="o">*</span><span class="n">coalesced_mmio_ring</span><span class="p">;</span>
    <span class="kt">bool</span> <span class="n">coalesced_flush_in_progress</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">vcpu_events</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">robust_singlestep</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">debugregs</span><span class="p">;</span>
    <span class="p">......</span>
    <span class="n">KVMMemoryListener</span> <span class="n">memory_listener</span><span class="p">;</span>
    <span class="n">QLIST_HEAD</span><span class="p">(,</span> <span class="n">KVMParkedVcpu</span><span class="p">)</span> <span class="n">kvm_parked_vcpus</span><span class="p">;</span>

    <span class="cm">/* For "info mtree -f" to tell if an MR is registered in KVM */</span>
    <span class="kt">int</span> <span class="n">nr_as</span><span class="p">;</span>
    <span class="k">struct</span> <span class="nc">KVMAs</span> <span class="p">{</span>
        <span class="n">KVMMemoryListener</span> <span class="o">*</span><span class="n">ml</span><span class="p">;</span>
        <span class="n">AddressSpace</span> <span class="o">*</span><span class="n">as</span><span class="p">;</span>
    <span class="p">}</span> <span class="o">*</span><span class="n">as</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></div></div>
<p>In QEMU, KVMState is a data structure that represents the state of a virtual 
machine managed by the Kernel-based Virtual Machine (KVM) hypervisor. The 
KVMState structure contains various fields that represent the virtual machine’s 
CPU state, memory state, device state, and other properties.</p>

<p>The KVMState structure is used extensively throughout QEMU to manage the state 
of virtual machines running under the KVM hypervisor. QEMU uses the KVMState 
structure to initialize and configure the virtual machine, handle interrupts and
other events, and manage interactions between the virtual machine and the host.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="rouge-code"><pre><span class="k">struct</span> <span class="nc">MemoryRegion</span> <span class="p">{</span>
    <span class="n">Object</span> <span class="n">parent_obj</span><span class="p">;</span>

    <span class="cm">/* private: */</span>         
                           
    <span class="cm">/* The following fields should fit in a cache line */</span>
    <span class="kt">bool</span> <span class="n">romd_mode</span><span class="p">;</span>        
    <span class="kt">bool</span> <span class="n">ram</span><span class="p">;</span>              
    <span class="kt">bool</span> <span class="n">subpage</span><span class="p">;</span>
    <span class="kt">bool</span> <span class="n">readonly</span><span class="p">;</span> <span class="cm">/* For RAM regions */</span>
    <span class="kt">bool</span> <span class="n">nonvolatile</span><span class="p">;</span>
    <span class="kt">bool</span> <span class="n">rom_device</span><span class="p">;</span>
    <span class="kt">bool</span> <span class="n">flush_coalesced_mmio</span><span class="p">;</span>
    <span class="kt">uint8_t</span> <span class="n">dirty_log_mask</span><span class="p">;</span>
    <span class="kt">bool</span> <span class="n">is_iommu</span><span class="p">;</span>
    <span class="n">RAMBlock</span> <span class="o">*</span><span class="n">ram_block</span><span class="p">;</span>
    <span class="n">Object</span> <span class="o">*</span><span class="n">owner</span><span class="p">;</span>                    
                                      
    <span class="k">const</span> <span class="n">MemoryRegionOps</span> <span class="o">*</span><span class="n">ops</span><span class="p">;</span>       
    <span class="p">......</span>
</pre></td></tr></tbody></table></code></div></div>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre><span class="cm">/**
 * struct AddressSpace: describes a mapping of addresses to #MemoryRegion objects
 */</span>
<span class="k">struct</span> <span class="nc">AddressSpace</span> <span class="p">{</span>
    <span class="cm">/* private: */</span>
    <span class="k">struct</span> <span class="nc">rcu_head</span> <span class="n">rcu</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
    <span class="n">MemoryRegion</span> <span class="o">*</span><span class="n">root</span><span class="p">;</span>

    <span class="cm">/* Accessed via RCU.  */</span>
    <span class="k">struct</span> <span class="nc">FlatView</span> <span class="o">*</span><span class="n">current_map</span><span class="p">;</span>

    <span class="kt">int</span> <span class="n">ioeventfd_nb</span><span class="p">;</span>
    <span class="k">struct</span> <span class="nc">MemoryRegionIoeventfd</span> <span class="o">*</span><span class="n">ioeventfds</span><span class="p">;</span>
    <span class="n">QTAILQ_HEAD</span><span class="p">(,</span> <span class="n">MemoryListener</span><span class="p">)</span> <span class="n">listeners</span><span class="p">;</span>
    <span class="n">QTAILQ_ENTRY</span><span class="p">(</span><span class="n">AddressSpace</span><span class="p">)</span> <span class="n">address_spaces_link</span><span class="p">;</span>
<span class="p">};</span>
</pre></td></tr></tbody></table></code></div></div>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td><td class="rouge-code"><pre><span class="k">struct</span> <span class="nc">RAMBlock</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="nc">rcu_head</span> <span class="n">rcu</span><span class="p">;</span>
    <span class="k">struct</span> <span class="nc">MemoryRegion</span> <span class="o">*</span><span class="n">mr</span><span class="p">;</span>
    <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">host</span><span class="p">;</span>
    <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">colo_cache</span><span class="p">;</span> <span class="cm">/* For colo, VM's ram cache */</span>
    <span class="n">ram_addr_t</span> <span class="n">offset</span><span class="p">;</span>
    <span class="n">ram_addr_t</span> <span class="n">used_length</span><span class="p">;</span>
    <span class="n">ram_addr_t</span> <span class="n">max_length</span><span class="p">;</span>
    <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">resized</span><span class="p">)(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="n">length</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">host</span><span class="p">);</span>
    <span class="kt">uint32_t</span> <span class="n">flags</span><span class="p">;</span>
    <span class="cm">/* Protected by iothread lock.  */</span>
    <span class="kt">char</span> <span class="n">idstr</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
    <span class="cm">/* RCU-enabled, writes protected by the ramlist lock */</span>
    <span class="n">QLIST_ENTRY</span><span class="p">(</span><span class="n">RAMBlock</span><span class="p">)</span> <span class="n">next</span><span class="p">;</span>
    <span class="n">QLIST_HEAD</span><span class="p">(,</span> <span class="n">RAMBlockNotifier</span><span class="p">)</span> <span class="n">ramblock_notifiers</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">fd</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">private_fd</span><span class="p">;</span>
    <span class="kt">size_t</span> <span class="n">page_size</span><span class="p">;</span>
    <span class="cm">/* dirty bitmap used during migration */</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">bmap</span><span class="p">;</span>
    <span class="cm">/* bitmap of already received pages in postcopy */</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">receivedmap</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="for-tdx"><span class="me-2">For TDX</span><a href="#for-tdx" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>Because RAMBlock is a basic unit to manage the memories for the VM instances,
it extends the RAMBlock to support private memory and shared memory in one 
RAMBlock. Note that it has two member fields (fd and private_fd) for shared and
private address space, respectively.</p>

<h2 id="memory-region--address-space-initialization"><span class="me-2">Memory region &amp; address space initialization</span><a href="#memory-region--address-space-initialization" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<h3 id="global-structures-for-memory-and-io-for-vms"><span class="me-2">Global structures for memory and IO for VMs</span><a href="#global-structures-for-memory-and-io-for-vms" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="k">static</span> <span class="n">MemoryRegion</span> <span class="o">*</span><span class="n">system_memory</span><span class="p">;</span>
<span class="k">static</span> <span class="n">MemoryRegion</span> <span class="o">*</span><span class="n">system_io</span><span class="p">;</span>

<span class="n">AddressSpace</span> <span class="n">address_space_io</span><span class="p">;</span>
<span class="n">AddressSpace</span> <span class="n">address_space_memory</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></div></div>
<p>Globally, regardless of the architecture, MemoryRegion and AddressSpace for 
system memory and IO are required to provide memory and IO for the VMs.</p>

<h3 id="initialize-address-space"><span class="me-2">Initialize address space</span><a href="#initialize-address-space" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre></td><td class="rouge-code"><pre><span class="k">static</span> <span class="kt">void</span> <span class="nf">qemu_create_machine</span><span class="p">(</span><span class="n">QDict</span> <span class="o">*</span><span class="n">qdict</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">MachineClass</span> <span class="o">*</span><span class="n">machine_class</span> <span class="o">=</span> <span class="n">select_machine</span><span class="p">(</span><span class="n">qdict</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">error_fatal</span><span class="p">);</span>
    <span class="n">object_set_machine_compat_props</span><span class="p">(</span><span class="n">machine_class</span><span class="o">-&gt;</span><span class="n">compat_props</span><span class="p">);</span>

    <span class="n">set_memory_options</span><span class="p">(</span><span class="n">machine_class</span><span class="p">);</span>

    <span class="n">current_machine</span> <span class="o">=</span> <span class="n">MACHINE</span><span class="p">(</span><span class="n">object_new_with_class</span><span class="p">(</span><span class="n">OBJECT_CLASS</span><span class="p">(</span><span class="n">machine_class</span><span class="p">)));</span>
    <span class="n">object_property_add_child</span><span class="p">(</span><span class="n">object_get_root</span><span class="p">(),</span> <span class="s">"machine"</span><span class="p">,</span>
                              <span class="n">OBJECT</span><span class="p">(</span><span class="n">current_machine</span><span class="p">));</span>
    <span class="n">object_property_add_child</span><span class="p">(</span><span class="n">container_get</span><span class="p">(</span><span class="n">OBJECT</span><span class="p">(</span><span class="n">current_machine</span><span class="p">),</span>
                                            <span class="s">"/unattached"</span><span class="p">),</span>
                              <span class="s">"sysbus"</span><span class="p">,</span> <span class="n">OBJECT</span><span class="p">(</span><span class="n">sysbus_get_default</span><span class="p">()));</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">machine_class</span><span class="o">-&gt;</span><span class="n">minimum_page_bits</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">set_preferred_target_page_bits</span><span class="p">(</span><span class="n">machine_class</span><span class="o">-&gt;</span><span class="n">minimum_page_bits</span><span class="p">))</span> <span class="p">{</span>
            <span class="cm">/* This would be a board error: specifying a minimum smaller than
             * a target's compile-time fixed setting.
             */</span>
            <span class="n">g_assert_not_reached</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">cpu_exec_init_all</span><span class="p">();</span>
<span class="p">......</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="kt">void</span> <span class="nf">cpu_exec_init_all</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>                                           
    <span class="n">qemu_mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ram_list</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
    <span class="n">finalize_target_page_bits</span><span class="p">();</span>
    <span class="n">io_mem_init</span><span class="p">();</span>
    <span class="n">memory_map_init</span><span class="p">();</span>
    <span class="n">qemu_mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">map_client_list_lock</span><span class="p">);</span>
<span class="p">}</span>   
</pre></td></tr></tbody></table></code></div></div>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="k">static</span> <span class="kt">void</span> <span class="nf">memory_map_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">system_memory</span> <span class="o">=</span> <span class="n">g_malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">system_memory</span><span class="p">));</span>

    <span class="n">memory_region_init</span><span class="p">(</span><span class="n">system_memory</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">"system"</span><span class="p">,</span> <span class="n">UINT64_MAX</span><span class="p">);</span>
    <span class="n">address_space_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">address_space_memory</span><span class="p">,</span> <span class="n">system_memory</span><span class="p">,</span> <span class="s">"memory"</span><span class="p">);</span>

    <span class="n">system_io</span> <span class="o">=</span> <span class="n">g_malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">system_io</span><span class="p">));</span>
    <span class="n">memory_region_init_io</span><span class="p">(</span><span class="n">system_io</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">unassigned_io_ops</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">"io"</span><span class="p">,</span>
                          <span class="mi">65536</span><span class="p">);</span>
    <span class="n">address_space_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">address_space_io</span><span class="p">,</span> <span class="n">system_io</span><span class="p">,</span> <span class="s">"I/O"</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>This is where the system_memory and system_io memory region is allocated and 
initialized. memory_region_init function initialize some member fields such as 
name and size. The initialized <strong>memory region is registered as the root memory 
region of corresponding address spaces by the address_space_init function.</strong></p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="kt">void</span> <span class="nf">address_space_init</span><span class="p">(</span><span class="n">AddressSpace</span> <span class="o">*</span><span class="n">as</span><span class="p">,</span> <span class="n">MemoryRegion</span> <span class="o">*</span><span class="n">root</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>   
    <span class="n">memory_region_ref</span><span class="p">(</span><span class="n">root</span><span class="p">);</span>
    <span class="n">as</span><span class="o">-&gt;</span><span class="n">root</span> <span class="o">=</span> <span class="n">root</span><span class="p">;</span>
    <span class="n">as</span><span class="o">-&gt;</span><span class="n">current_map</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">as</span><span class="o">-&gt;</span><span class="n">ioeventfd_nb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> 
    <span class="n">as</span><span class="o">-&gt;</span><span class="n">ioeventfds</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">QTAILQ_INIT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">as</span><span class="o">-&gt;</span><span class="n">listeners</span><span class="p">);</span>
    <span class="n">QTAILQ_INSERT_TAIL</span><span class="p">(</span><span class="o">&amp;</span><span class="n">address_spaces</span><span class="p">,</span> <span class="n">as</span><span class="p">,</span> <span class="n">address_spaces_link</span><span class="p">);</span>
    <span class="n">as</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">g_strdup</span><span class="p">(</span><span class="n">name</span> <span class="o">?</span> <span class="n">name</span> <span class="o">:</span> <span class="s">"anonymous"</span><span class="p">);</span>
    <span class="n">address_space_update_topology</span><span class="p">(</span><span class="n">as</span><span class="p">);</span>
    <span class="n">address_space_update_ioeventfdy</span><span class="p">(</span><span class="n">as</span><span class="p">);</span>
<span class="p">}</span>       
</pre></td></tr></tbody></table></code></div></div>
<p>Now the system_memory and system_io are registered as the root memory regions of
the address_space_memory and address_space_io, respectively. However, note that 
it just established links between the memory region and the address space, and 
there is no actual memory registered for those two address spaces.</p>

<h2 id="real-memory-allocation-through-ramblock"><span class="me-2">Real memory allocation through RAMBlock</span><a href="#real-memory-allocation-through-ramblock" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td><td class="rouge-code"><pre><span class="cm">/* PC hardware initialisation */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pc_init1</span><span class="p">(</span><span class="n">MachineState</span> <span class="o">*</span><span class="n">machine</span><span class="p">,</span>
                     <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">host_type</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pci_type</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">PCMachineState</span> <span class="o">*</span><span class="n">pcms</span> <span class="o">=</span> <span class="n">PC_MACHINE</span><span class="p">(</span><span class="n">machine</span><span class="p">);</span>
    <span class="n">PCMachineClass</span> <span class="o">*</span><span class="n">pcmc</span> <span class="o">=</span> <span class="n">PC_MACHINE_GET_CLASS</span><span class="p">(</span><span class="n">pcms</span><span class="p">);</span>
    <span class="n">X86MachineState</span> <span class="o">*</span><span class="n">x86ms</span> <span class="o">=</span> <span class="n">X86_MACHINE</span><span class="p">(</span><span class="n">machine</span><span class="p">);</span>
    <span class="n">MemoryRegion</span> <span class="o">*</span><span class="n">system_memory</span> <span class="o">=</span> <span class="n">get_system_memory</span><span class="p">();</span>
    <span class="n">MemoryRegion</span> <span class="o">*</span><span class="n">system_io</span> <span class="o">=</span> <span class="n">get_system_io</span><span class="p">();</span>
<span class="p">......</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">pcmc</span><span class="o">-&gt;</span><span class="n">pci_enabled</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">pci_memory</span> <span class="o">=</span> <span class="n">g_new</span><span class="p">(</span><span class="n">MemoryRegion</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
        <span class="n">memory_region_init</span><span class="p">(</span><span class="n">pci_memory</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">"pci"</span><span class="p">,</span> <span class="n">UINT64_MAX</span><span class="p">);</span>
        <span class="n">rom_memory</span> <span class="o">=</span> <span class="n">pci_memory</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="p">......</span>
    <span class="cm">/* allocate ram and load rom/bios */</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xen_enabled</span><span class="p">())</span> <span class="p">{</span>
        <span class="n">pc_memory_init</span><span class="p">(</span><span class="n">pcms</span><span class="p">,</span> <span class="n">system_memory</span><span class="p">,</span>
                       <span class="n">rom_memory</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ram_memory</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

</pre></td></tr></tbody></table></code></div></div>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre></td><td class="rouge-code"><pre><span class="kt">void</span> <span class="nf">pc_memory_init</span><span class="p">(</span><span class="n">PCMachineState</span> <span class="o">*</span><span class="n">pcms</span><span class="p">,</span>
                    <span class="n">MemoryRegion</span> <span class="o">*</span><span class="n">system_memory</span><span class="p">,</span>
                    <span class="n">MemoryRegion</span> <span class="o">*</span><span class="n">rom_memory</span><span class="p">,</span>
                    <span class="n">MemoryRegion</span> <span class="o">**</span><span class="n">ram_memory</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">linux_boot</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
    <span class="n">MemoryRegion</span> <span class="o">*</span><span class="n">option_rom_mr</span><span class="p">;</span>
    <span class="n">MemoryRegion</span> <span class="o">*</span><span class="n">ram_below_4g</span><span class="p">,</span> <span class="o">*</span><span class="n">ram_above_4g</span><span class="p">;</span>
<span class="p">......</span>
    <span class="o">*</span><span class="n">ram_memory</span> <span class="o">=</span> <span class="n">machine</span><span class="o">-&gt;</span><span class="n">ram</span><span class="p">;</span>
    <span class="n">ram_below_4g</span> <span class="o">=</span> <span class="n">g_malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ram_below_4g</span><span class="p">));</span>
    <span class="n">memory_region_init_alias</span><span class="p">(</span><span class="n">ram_below_4g</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">"ram-below-4g"</span><span class="p">,</span> <span class="n">machine</span><span class="o">-&gt;</span><span class="n">ram</span><span class="p">,</span>
                             <span class="mi">0</span><span class="p">,</span> <span class="n">x86ms</span><span class="o">-&gt;</span><span class="n">below_4g_mem_size</span><span class="p">);</span>
    <span class="n">memory_region_add_subregion</span><span class="p">(</span><span class="n">system_memory</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ram_below_4g</span><span class="p">);</span>
    <span class="n">e820_add_entry</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">x86ms</span><span class="o">-&gt;</span><span class="n">below_4g_mem_size</span><span class="p">,</span> <span class="n">E820_RAM</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">x86ms</span><span class="o">-&gt;</span><span class="n">above_4g_mem_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ram_above_4g</span> <span class="o">=</span> <span class="n">g_malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ram_above_4g</span><span class="p">));</span>
        <span class="n">memory_region_init_alias</span><span class="p">(</span><span class="n">ram_above_4g</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">"ram-above-4g"</span><span class="p">,</span>
                                 <span class="n">machine</span><span class="o">-&gt;</span><span class="n">ram</span><span class="p">,</span>
                                 <span class="n">x86ms</span><span class="o">-&gt;</span><span class="n">below_4g_mem_size</span><span class="p">,</span>
                                 <span class="n">x86ms</span><span class="o">-&gt;</span><span class="n">above_4g_mem_size</span><span class="p">);</span>
        <span class="n">memory_region_add_subregion</span><span class="p">(</span><span class="n">system_memory</span><span class="p">,</span> <span class="mh">0x100000000ULL</span><span class="p">,</span>
                                    <span class="n">ram_above_4g</span><span class="p">);</span>
        <span class="n">e820_add_entry</span><span class="p">(</span><span class="mh">0x100000000ULL</span><span class="p">,</span> <span class="n">x86ms</span><span class="o">-&gt;</span><span class="n">above_4g_mem_size</span><span class="p">,</span> <span class="n">E820_RAM</span><span class="p">);</span>
    <span class="p">}</span>

</pre></td></tr></tbody></table></code></div></div>

<h3 id="register-new-memory-region-as-a-subregion"><span class="me-2">Register new memory region as a subregion</span><a href="#register-new-memory-region-as-a-subregion" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>memory_region_add_subregion function registers the newly generated memory region 
to the existing memory region as a sub-region. The param mr is the existing 
memory region, and the subregion is the newly generated memory region that will
be registered to the mr. The offset is the GPA of the new memory region.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="kt">void</span> <span class="nf">memory_region_add_subregion</span><span class="p">(</span><span class="n">MemoryRegion</span> <span class="o">*</span><span class="n">mr</span><span class="p">,</span>
                                 <span class="n">hwaddr</span> <span class="n">offset</span><span class="p">,</span>
                                 <span class="n">MemoryRegion</span> <span class="o">*</span><span class="n">subregion</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">subregion</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">memory_region_add_subregion_common</span><span class="p">(</span><span class="n">mr</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">subregion</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre><span class="k">static</span> <span class="kt">void</span> <span class="nf">memory_region_add_subregion_common</span><span class="p">(</span><span class="n">MemoryRegion</span> <span class="o">*</span><span class="n">mr</span><span class="p">,</span>
                                               <span class="n">hwaddr</span> <span class="n">offset</span><span class="p">,</span>
                                               <span class="n">MemoryRegion</span> <span class="o">*</span><span class="n">subregion</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">MemoryRegion</span> <span class="o">*</span><span class="n">alias</span><span class="p">;</span>

    <span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">subregion</span><span class="o">-&gt;</span><span class="n">container</span><span class="p">);</span>
    <span class="n">subregion</span><span class="o">-&gt;</span><span class="n">container</span> <span class="o">=</span> <span class="n">mr</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">alias</span> <span class="o">=</span> <span class="n">subregion</span><span class="o">-&gt;</span><span class="n">alias</span><span class="p">;</span> <span class="n">alias</span><span class="p">;</span> <span class="n">alias</span> <span class="o">=</span> <span class="n">alias</span><span class="o">-&gt;</span><span class="n">alias</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">alias</span><span class="o">-&gt;</span><span class="n">mapped_via_alias</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">subregion</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
    <span class="n">memory_region_update_container_subregions</span><span class="p">(</span><span class="n">subregion</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="rouge-code"><pre><span class="k">static</span> <span class="kt">void</span> <span class="nf">memory_region_update_container_subregions</span><span class="p">(</span><span class="n">MemoryRegion</span> <span class="o">*</span><span class="n">subregion</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">MemoryRegion</span> <span class="o">*</span><span class="n">mr</span> <span class="o">=</span> <span class="n">subregion</span><span class="o">-&gt;</span><span class="n">container</span><span class="p">;</span>
    <span class="n">MemoryRegion</span> <span class="o">*</span><span class="n">other</span><span class="p">;</span>

    <span class="n">memory_region_transaction_begin</span><span class="p">();</span>

    <span class="n">memory_region_ref</span><span class="p">(</span><span class="n">subregion</span><span class="p">);</span>
    <span class="n">QTAILQ_FOREACH</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mr</span><span class="o">-&gt;</span><span class="n">subregions</span><span class="p">,</span> <span class="n">subregions_link</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">subregion</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">&gt;=</span> <span class="n">other</span><span class="o">-&gt;</span><span class="n">priority</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">QTAILQ_INSERT_BEFORE</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">subregion</span><span class="p">,</span> <span class="n">subregions_link</span><span class="p">);</span>
            <span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">QTAILQ_INSERT_TAIL</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mr</span><span class="o">-&gt;</span><span class="n">subregions</span><span class="p">,</span> <span class="n">subregion</span><span class="p">,</span> <span class="n">subregions_link</span><span class="p">);</span>
<span class="n">done</span><span class="o">:</span>
    <span class="n">memory_region_update_pending</span> <span class="o">|=</span> <span class="n">mr</span><span class="o">-&gt;</span><span class="n">enabled</span> <span class="o">&amp;&amp;</span> <span class="n">subregion</span><span class="o">-&gt;</span><span class="n">enabled</span><span class="p">;</span>
    <span class="n">memory_region_transaction_commit</span><span class="p">();</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>
<p>Because the sub-regions of one memory region are maintained by the subregions 
member field of the root MemoryRegion, the newly generated sub-region should
also be registered in that list. Now the sub-region is successfully registered
in the subregions list of the root MemoryRegion. However, note that this link
was established on QEMU side, which further requires KVM side memory management. 
Remember that the subregions are maintained as a tree form and should be
translated into the <strong>flatview</strong> to be processed by the KVM side easily. Refer
to [[]] about flatview.</p>

<h2 id="notify-new-memory-region-to-kvm-side"><span class="me-2">Notify new memory region to KVM side</span><a href="#notify-new-memory-region-to-kvm-side" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="k">static</span> <span class="kt">void</span> <span class="nf">kvm_region_add</span><span class="p">(</span><span class="n">MemoryListener</span> <span class="o">*</span><span class="n">listener</span><span class="p">,</span>
                           <span class="n">MemoryRegionSection</span> <span class="o">*</span><span class="n">section</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">KVMMemoryListener</span> <span class="o">*</span><span class="n">kml</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">listener</span><span class="p">,</span> <span class="n">KVMMemoryListener</span><span class="p">,</span> <span class="n">listener</span><span class="p">);</span>

    <span class="n">memory_region_ref</span><span class="p">(</span><span class="n">section</span><span class="o">-&gt;</span><span class="n">mr</span><span class="p">);</span>
    <span class="n">kvm_set_phys_mem</span><span class="p">(</span><span class="n">kml</span><span class="p">,</span> <span class="n">section</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>
<p>kvm_region_add function is registered as the region_add hook function of the 
KVMMemoryListener. Therefore, it will be invoked whenever XXX (Not sure when
it is actually invoked..)</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
</pre></td><td class="rouge-code"><pre><span class="k">static</span> <span class="kt">void</span> <span class="nf">kvm_set_phys_mem</span><span class="p">(</span><span class="n">KVMMemoryListener</span> <span class="o">*</span><span class="n">kml</span><span class="p">,</span>
                             <span class="n">MemoryRegionSection</span> <span class="o">*</span><span class="n">section</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">add</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">KVMSlot</span> <span class="o">*</span><span class="n">mem</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
    <span class="n">MemoryRegion</span> <span class="o">*</span><span class="n">mr</span> <span class="o">=</span> <span class="n">section</span><span class="o">-&gt;</span><span class="n">mr</span><span class="p">;</span>
    <span class="kt">bool</span> <span class="n">writeable</span> <span class="o">=</span> <span class="o">!</span><span class="n">mr</span><span class="o">-&gt;</span><span class="n">readonly</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">mr</span><span class="o">-&gt;</span><span class="n">rom_device</span><span class="p">;</span>
    <span class="n">hwaddr</span> <span class="n">start_addr</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">slot_size</span><span class="p">,</span> <span class="n">mr_offset</span><span class="p">;</span>
    <span class="n">ram_addr_t</span> <span class="n">ram_start_offset</span><span class="p">;</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">ram</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memory_region_is_ram</span><span class="p">(</span><span class="n">mr</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">writeable</span> <span class="o">||</span> <span class="o">!</span><span class="n">kvm_readonly_mem_allowed</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mr</span><span class="o">-&gt;</span><span class="n">romd_mode</span><span class="p">)</span> <span class="p">{</span>
            <span class="cm">/* If the memory device is not in romd_mode, then we actually want
             * to remove the kvm memory slot so all accesses will trap. */</span>
            <span class="n">add</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">size</span> <span class="o">=</span> <span class="n">kvm_align_section</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">start_addr</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/* The offset of the kvmslot within the memory region */</span>
    <span class="n">mr_offset</span> <span class="o">=</span> <span class="n">section</span><span class="o">-&gt;</span><span class="n">offset_within_region</span> <span class="o">+</span> <span class="n">start_addr</span> <span class="o">-</span>
        <span class="n">section</span><span class="o">-&gt;</span><span class="n">offset_within_address_space</span><span class="p">;</span>

    <span class="cm">/* use aligned delta to align the ram address and offset */</span>
    <span class="n">ram</span> <span class="o">=</span> <span class="n">memory_region_get_ram_ptr</span><span class="p">(</span><span class="n">mr</span><span class="p">)</span> <span class="o">+</span> <span class="n">mr_offset</span><span class="p">;</span>
    <span class="n">ram_start_offset</span> <span class="o">=</span> <span class="n">memory_region_get_ram_addr</span><span class="p">(</span><span class="n">mr</span><span class="p">)</span> <span class="o">+</span> <span class="n">mr_offset</span><span class="p">;</span>

    <span class="n">kvm_slots_lock</span><span class="p">();</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">add</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">do</span> <span class="p">{</span>
            <span class="n">slot_size</span> <span class="o">=</span> <span class="n">MIN</span><span class="p">(</span><span class="n">kvm_max_slot_size</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
            <span class="n">mem</span> <span class="o">=</span> <span class="n">kvm_lookup_matching_slot</span><span class="p">(</span><span class="n">kml</span><span class="p">,</span> <span class="n">start_addr</span><span class="p">,</span> <span class="n">slot_size</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mem</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">KVM_MEM_LOG_DIRTY_PAGES</span><span class="p">)</span> <span class="p">{</span>
                <span class="cm">/*
                 * NOTE: We should be aware of the fact that here we're only
                 * doing a best effort to sync dirty bits.  No matter whether
                 * we're using dirty log or dirty ring, we ignored two facts:
                 *
                 * (1) dirty bits can reside in hardware buffers (PML)
                 *
                 * (2) after we collected dirty bits here, pages can be dirtied
                 * again before we do the final KVM_SET_USER_MEMORY_REGION to
                 * remove the slot.
                 *
                 * Not easy.  Let's cross the fingers until it's fixed.
                 */</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">kvm_state</span><span class="o">-&gt;</span><span class="n">kvm_dirty_ring_size</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">kvm_dirty_ring_reap_locked</span><span class="p">(</span><span class="n">kvm_state</span><span class="p">);</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="n">kvm_slot_get_dirty_log</span><span class="p">(</span><span class="n">kvm_state</span><span class="p">,</span> <span class="n">mem</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="n">kvm_slot_sync_dirty_pages</span><span class="p">(</span><span class="n">mem</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="cm">/* unregister the slot */</span>
            <span class="n">g_free</span><span class="p">(</span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">dirty_bmap</span><span class="p">);</span>
            <span class="n">mem</span><span class="o">-&gt;</span><span class="n">dirty_bmap</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
            <span class="n">mem</span><span class="o">-&gt;</span><span class="n">memory_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">mem</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">err</span> <span class="o">=</span> <span class="n">kvm_set_user_memory_region</span><span class="p">(</span><span class="n">kml</span><span class="p">,</span> <span class="n">mem</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"%s: error unregistering slot: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
                        <span class="n">__func__</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="o">-</span><span class="n">err</span><span class="p">));</span>
                <span class="n">abort</span><span class="p">();</span>
            <span class="p">}</span>
            <span class="n">start_addr</span> <span class="o">+=</span> <span class="n">slot_size</span><span class="p">;</span>
            <span class="n">size</span> <span class="o">-=</span> <span class="n">slot_size</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">size</span><span class="p">);</span>
        <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/* register the new slot */</span>
    <span class="k">do</span> <span class="p">{</span>
        <span class="n">slot_size</span> <span class="o">=</span> <span class="n">MIN</span><span class="p">(</span><span class="n">kvm_max_slot_size</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
        <span class="n">mem</span> <span class="o">=</span> <span class="n">kvm_alloc_slot</span><span class="p">(</span><span class="n">kml</span><span class="p">);</span>
        <span class="n">mem</span><span class="o">-&gt;</span><span class="n">as_id</span> <span class="o">=</span> <span class="n">kml</span><span class="o">-&gt;</span><span class="n">as_id</span><span class="p">;</span>
        <span class="n">mem</span><span class="o">-&gt;</span><span class="n">memory_size</span> <span class="o">=</span> <span class="n">slot_size</span><span class="p">;</span>
        <span class="n">mem</span><span class="o">-&gt;</span><span class="n">start_addr</span> <span class="o">=</span> <span class="n">start_addr</span><span class="p">;</span>
        <span class="n">mem</span><span class="o">-&gt;</span><span class="n">ram_start_offset</span> <span class="o">=</span> <span class="n">ram_start_offset</span><span class="p">;</span>
        <span class="n">mem</span><span class="o">-&gt;</span><span class="n">ram</span> <span class="o">=</span> <span class="n">ram</span><span class="p">;</span>
        <span class="n">mem</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">kvm_mem_flags</span><span class="p">(</span><span class="n">mr</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">KVM_MEM_PRIVATE</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">mem</span><span class="o">-&gt;</span><span class="n">fd</span> <span class="o">=</span> <span class="n">mr</span><span class="o">-&gt;</span><span class="n">ram_block</span><span class="o">-&gt;</span><span class="n">private_fd</span><span class="p">;</span>
            <span class="n">mem</span><span class="o">-&gt;</span><span class="n">ofs</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="o">*</span><span class="p">)</span><span class="n">ram</span> <span class="o">-</span> <span class="n">mr</span><span class="o">-&gt;</span><span class="n">ram_block</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">mem</span><span class="o">-&gt;</span><span class="n">fd</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
            <span class="n">mem</span><span class="o">-&gt;</span><span class="n">ofs</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">kvm_slot_init_dirty_bitmap</span><span class="p">(</span><span class="n">mem</span><span class="p">);</span>
        <span class="n">err</span> <span class="o">=</span> <span class="n">kvm_set_user_memory_region</span><span class="p">(</span><span class="n">kml</span><span class="p">,</span> <span class="n">mem</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"%s: error registering slot: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
                    <span class="n">strerror</span><span class="p">(</span><span class="o">-</span><span class="n">err</span><span class="p">));</span>
            <span class="n">abort</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="n">start_addr</span> <span class="o">+=</span> <span class="n">slot_size</span><span class="p">;</span>
        <span class="n">ram_start_offset</span> <span class="o">+=</span> <span class="n">slot_size</span><span class="p">;</span>
        <span class="n">ram</span> <span class="o">+=</span> <span class="n">slot_size</span><span class="p">;</span>
        <span class="n">size</span> <span class="o">-=</span> <span class="n">slot_size</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">size</span><span class="p">);</span>

<span class="n">out</span><span class="o">:</span>
    <span class="n">kvm_slots_unlock</span><span class="p">();</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="get-kvmslot-for-new-memory"><span class="me-2">Get KVMSlot for new memory</span><a href="#get-kvmslot-for-new-memory" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="rouge-code"><pre><span class="k">typedef</span> <span class="k">struct</span> <span class="nc">KVMSlot</span>
<span class="p">{</span>
    <span class="n">hwaddr</span> <span class="n">start_addr</span><span class="p">;</span>
    <span class="n">ram_addr_t</span> <span class="n">memory_size</span><span class="p">;</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">ram</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">slot</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">flags</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">old_flags</span><span class="p">;</span>
    <span class="cm">/* Dirty bitmap cache for the slot */</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">dirty_bmap</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dirty_bmap_size</span><span class="p">;</span>
    <span class="cm">/* Cache of the address space ID */</span>
    <span class="kt">int</span> <span class="n">as_id</span><span class="p">;</span>
    <span class="cm">/* Cache of the offset in ram address space */</span>
    <span class="n">ram_addr_t</span> <span class="n">ram_start_offset</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">fd</span><span class="p">;</span>
    <span class="n">hwaddr</span> <span class="n">ofs</span><span class="p">;</span>
<span class="p">}</span> <span class="n">KVMSlot</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></div></div>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="cm">/* Called with KVMMemoryListener.slots_lock held */</span>
<span class="k">static</span> <span class="n">KVMSlot</span> <span class="o">*</span><span class="nf">kvm_alloc_slot</span><span class="p">(</span><span class="n">KVMMemoryListener</span> <span class="o">*</span><span class="n">kml</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">KVMSlot</span> <span class="o">*</span><span class="n">slot</span> <span class="o">=</span> <span class="n">kvm_get_free_slot</span><span class="p">(</span><span class="n">kml</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">slot</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">slot</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"%s: no free slot available</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
    <span class="n">abort</span><span class="p">();</span>
<span class="p">}</span>

</pre></td></tr></tbody></table></code></div></div>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre><span class="cm">/* Called with KVMMemoryListener.slots_lock held */</span>
<span class="k">static</span> <span class="n">KVMSlot</span> <span class="o">*</span><span class="nf">kvm_get_free_slot</span><span class="p">(</span><span class="n">KVMMemoryListener</span> <span class="o">*</span><span class="n">kml</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">KVMState</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">kvm_state</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">nr_slots</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">kml</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">memory_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="o">&amp;</span><span class="n">kml</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="kvm_set_user_memory_region-ioctl-to-communicate-with-kvm"><span class="me-2">KVM_SET_USER_MEMORY_REGION ioctl to communicate with KVM</span><a href="#kvm_set_user_memory_region-ioctl-to-communicate-with-kvm" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
</pre></td><td class="rouge-code"><pre><span class="k">static</span> <span class="kt">int</span> <span class="nf">kvm_set_user_memory_region</span><span class="p">(</span><span class="n">KVMMemoryListener</span> <span class="o">*</span><span class="n">kml</span><span class="p">,</span> <span class="n">KVMSlot</span> <span class="o">*</span><span class="n">slot</span><span class="p">,</span> <span class="kt">bool</span> <span class="k">new</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">KVMState</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">kvm_state</span><span class="p">;</span>
    <span class="k">struct</span> <span class="nc">kvm_userspace_memory_region_ext</span> <span class="n">mem</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

    <span class="n">mem</span><span class="p">.</span><span class="n">region</span><span class="p">.</span><span class="n">slot</span> <span class="o">=</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">slot</span> <span class="o">|</span> <span class="p">(</span><span class="n">kml</span><span class="o">-&gt;</span><span class="n">as_id</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
    <span class="n">mem</span><span class="p">.</span><span class="n">region</span><span class="p">.</span><span class="n">guest_phys_addr</span> <span class="o">=</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">start_addr</span><span class="p">;</span>
    <span class="n">mem</span><span class="p">.</span><span class="n">region</span><span class="p">.</span><span class="n">userspace_addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">ram</span><span class="p">;</span>
    <span class="n">mem</span><span class="p">.</span><span class="n">region</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">KVM_MEM_PRIVATE</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">mem</span><span class="p">.</span><span class="n">private_fd</span> <span class="o">=</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">;</span>
        <span class="n">mem</span><span class="p">.</span><span class="n">private_offset</span> <span class="o">=</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">ofs</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">mem</span><span class="p">.</span><span class="n">private_fd</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="n">mem</span><span class="p">.</span><span class="n">private_offset</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">kvm_tdx_enabled</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">KVM_MEM_PRIVATE</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">warn_report</span><span class="p">(</span><span class="s">"%s: Non-private memory backend is used for TDX"</span>
                    <span class="s">" slot %d,"</span>
                    <span class="s">" start_addr 0x%"</span> <span class="n">PRIx64</span> <span class="s">","</span>
                    <span class="s">" ram 0x%"</span> <span class="n">PRIx64</span> <span class="s">","</span>
                    <span class="s">" size 0x%"</span> <span class="n">PRIx64</span> <span class="s">","</span>
                    <span class="s">" flags 0x%x"</span><span class="p">,</span>
                    <span class="n">__func__</span><span class="p">,</span> <span class="n">mem</span><span class="p">.</span><span class="n">region</span><span class="p">.</span><span class="n">slot</span><span class="p">,</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">start_addr</span><span class="p">,</span>
                    <span class="p">(</span><span class="kt">uint64_t</span><span class="p">)</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">ram</span><span class="p">,</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">memory_size</span><span class="p">,</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">memory_size</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">new</span> <span class="o">&amp;&amp;</span>
        <span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">^</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">old_flags</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">KVM_MEM_READONLY</span><span class="p">)</span> <span class="p">{</span>
        <span class="cm">/* Set the slot size to 0 before setting the slot to the desired
         * value. This is needed based on KVM commit 75d61fbc. */</span>
        <span class="n">mem</span><span class="p">.</span><span class="n">region</span><span class="p">.</span><span class="n">memory_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">kvm_vm_ioctl</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">KVM_SET_USER_MEMORY_REGION</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mem</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">mem</span><span class="p">.</span><span class="n">region</span><span class="p">.</span><span class="n">memory_size</span> <span class="o">=</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">memory_size</span><span class="p">;</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">kvm_vm_ioctl</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">KVM_SET_USER_MEMORY_REGION</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mem</span><span class="p">);</span>
    <span class="n">slot</span><span class="o">-&gt;</span><span class="n">old_flags</span> <span class="o">=</span> <span class="n">mem</span><span class="p">.</span><span class="n">region</span><span class="p">.</span><span class="n">flags</span><span class="p">;</span>
<span class="n">err</span><span class="o">:</span>
    <span class="n">trace_kvm_set_user_memory</span><span class="p">(</span><span class="n">mem</span><span class="p">.</span><span class="n">region</span><span class="p">.</span><span class="n">slot</span><span class="p">,</span> <span class="n">mem</span><span class="p">.</span><span class="n">region</span><span class="p">.</span><span class="n">flags</span><span class="p">,</span>
                              <span class="n">mem</span><span class="p">.</span><span class="n">region</span><span class="p">.</span><span class="n">guest_phys_addr</span><span class="p">,</span> <span class="n">mem</span><span class="p">.</span><span class="n">region</span><span class="p">.</span><span class="n">memory_size</span><span class="p">,</span>
                              <span class="n">mem</span><span class="p">.</span><span class="n">region</span><span class="p">.</span><span class="n">userspace_addr</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">error_report</span><span class="p">(</span><span class="s">"%s: KVM_SET_USER_MEMORY_REGION failed, slot=%d,"</span>
                     <span class="s">" start=0x%"</span> <span class="n">PRIx64</span> <span class="s">", size=0x%"</span> <span class="n">PRIx64</span> <span class="s">","</span>
                     <span class="s">" flags=0x%"</span> <span class="n">PRIx32</span> <span class="s">","</span>
                     <span class="s">" private_fd=%"</span> <span class="n">PRId32</span> <span class="s">", private_offset=0x%"</span> <span class="n">PRIx64</span> <span class="s">": %s"</span><span class="p">,</span>
                     <span class="n">__func__</span><span class="p">,</span> <span class="n">mem</span><span class="p">.</span><span class="n">region</span><span class="p">.</span><span class="n">slot</span><span class="p">,</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">start_addr</span><span class="p">,</span>
                     <span class="p">(</span><span class="kt">uint64_t</span><span class="p">)</span><span class="n">mem</span><span class="p">.</span><span class="n">region</span><span class="p">.</span><span class="n">memory_size</span><span class="p">,</span> <span class="n">mem</span><span class="p">.</span><span class="n">region</span><span class="p">.</span><span class="n">flags</span><span class="p">,</span>
                     <span class="n">mem</span><span class="p">.</span><span class="n">private_fd</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint64_t</span><span class="p">)</span><span class="n">mem</span><span class="p">.</span><span class="n">private_offset</span><span class="p">,</span>
                     <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre><span class="cm">/* for KVM_SET_USER_MEMORY_REGION */</span>
<span class="k">struct</span> <span class="nc">kvm_userspace_memory_region</span> <span class="p">{</span>
        <span class="n">__u32</span> <span class="n">slot</span><span class="p">;</span>
        <span class="n">__u32</span> <span class="n">flags</span><span class="p">;</span>
        <span class="n">__u64</span> <span class="n">guest_phys_addr</span><span class="p">;</span>
        <span class="n">__u64</span> <span class="n">memory_size</span><span class="p">;</span> <span class="cm">/* bytes */</span>
        <span class="n">__u64</span> <span class="n">userspace_addr</span><span class="p">;</span> <span class="cm">/* start of the userspace allocated memory */</span>
<span class="p">};</span>
    
<span class="k">struct</span> <span class="nc">kvm_userspace_memory_region_ext</span> <span class="p">{</span>
        <span class="k">struct</span> <span class="nc">kvm_userspace_memory_region</span> <span class="n">region</span><span class="p">;</span>
        <span class="n">__u64</span> <span class="n">private_offset</span><span class="p">;</span>
        <span class="n">__u32</span> <span class="n">private_fd</span><span class="p">;</span>
        <span class="n">__u32</span> <span class="n">pad1</span><span class="p">;</span>
        <span class="n">__u64</span> <span class="n">pad2</span><span class="p">[</span><span class="mi">14</span><span class="p">];</span>
<span class="p">};</span>  
</pre></td></tr></tbody></table></code></div></div>

<p>KVM_SET_USER_MEMORY_REGION ioctl allows kvm to initialize memory set by the 
QEMU. It also generates the kvm_userspace_memory_region_ext type parameter to 
let kvm understand which memory region should be created and assigned for the 
guest VM.</p>

<h3 id="allocate-and-assign-memory-for-new-memory-region"><span class="me-2">Allocate and assign memory for new memory region</span><a href="#allocate-and-assign-memory-for-new-memory-region" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>After the QEMU and KVM initialization for root memory regions of system memory 
and IO, another memory region might need to be generated and registered as a 
sub-region of the other region. For example guest VM requires virtual memory. 
QEMU reserves MemoryRegion called RAM region and makes them available to the 
guest VM as needed.</p>

<p>The actual host memory region is represented as RAMBlock, and it is allocated 
by memory_region_init_ram function.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td><td class="rouge-code"><pre><span class="kt">void</span> <span class="nf">memory_region_init_ram</span><span class="p">(</span><span class="n">MemoryRegion</span> <span class="o">*</span><span class="n">mr</span><span class="p">,</span>
                            <span class="n">Object</span> <span class="o">*</span><span class="n">owner</span><span class="p">,</span>
                            <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
                            <span class="kt">uint64_t</span> <span class="n">size</span><span class="p">,</span>
                            <span class="n">Error</span> <span class="o">**</span><span class="n">errp</span><span class="p">)</span>
<span class="p">{</span>       
    <span class="n">DeviceState</span> <span class="o">*</span><span class="n">owner_dev</span><span class="p">;</span>
    <span class="n">Error</span> <span class="o">*</span><span class="n">err</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    
    <span class="n">memory_region_init_ram_nomigrate</span><span class="p">(</span><span class="n">mr</span><span class="p">,</span> <span class="n">owner</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">error_propagate</span><span class="p">(</span><span class="n">errp</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>       
    <span class="cm">/* This will assert if owner is neither NULL nor a DeviceState.
     * We only want the owner here for the purposes of defining a
     * unique name for migration. TODO: Ideally we should implement
     * a naming scheme for Objects which are not DeviceStates, in
     * which case we can relax this restriction.
     */</span>
    <span class="n">owner_dev</span> <span class="o">=</span> <span class="n">DEVICE</span><span class="p">(</span><span class="n">owner</span><span class="p">);</span>
    <span class="n">vmstate_register_ram</span><span class="p">(</span><span class="n">mr</span><span class="p">,</span> <span class="n">owner_dev</span><span class="p">);</span>
    <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>The MemoryRegion parameter is the newly allocated memory region that needs to be
initialized. Note that this function’s main role is an allocating memory space 
for current memory region. The memory region is a meta-data presenting the 
actual memory. The actual memory space assigned for this memory region is 
presented by the RAMBlock type member field <strong>ram_block</strong>.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre></td><td class="rouge-code"><pre><span class="kt">void</span> <span class="nf">memory_region_init_ram_nomigrate</span><span class="p">(</span><span class="n">MemoryRegion</span> <span class="o">*</span><span class="n">mr</span><span class="p">,</span>
                                      <span class="n">Object</span> <span class="o">*</span><span class="n">owner</span><span class="p">,</span>
                                      <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
                                      <span class="kt">uint64_t</span> <span class="n">size</span><span class="p">,</span>
                                      <span class="n">Error</span> <span class="o">**</span><span class="n">errp</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">memory_region_init_ram_flags_nomigrate</span><span class="p">(</span><span class="n">mr</span><span class="p">,</span> <span class="n">owner</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">errp</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">memory_region_init_ram_flags_nomigrate</span><span class="p">(</span><span class="n">MemoryRegion</span> <span class="o">*</span><span class="n">mr</span><span class="p">,</span>
                                            <span class="n">Object</span> <span class="o">*</span><span class="n">owner</span><span class="p">,</span>
                                            <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
                                            <span class="kt">uint64_t</span> <span class="n">size</span><span class="p">,</span>
                                            <span class="kt">uint32_t</span> <span class="n">ram_flags</span><span class="p">,</span>
                                            <span class="n">Error</span> <span class="o">**</span><span class="n">errp</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">Error</span> <span class="o">*</span><span class="n">err</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">memory_region_init</span><span class="p">(</span><span class="n">mr</span><span class="p">,</span> <span class="n">owner</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
    <span class="n">mr</span><span class="o">-&gt;</span><span class="n">ram</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="n">mr</span><span class="o">-&gt;</span><span class="n">terminates</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="n">mr</span><span class="o">-&gt;</span><span class="n">destructor</span> <span class="o">=</span> <span class="n">memory_region_destructor_ram</span><span class="p">;</span>
    <span class="n">mr</span><span class="o">-&gt;</span><span class="n">ram_block</span> <span class="o">=</span> <span class="n">qemu_ram_alloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">ram_flags</span><span class="p">,</span> <span class="n">mr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">mr</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">int128_zero</span><span class="p">();</span>
        <span class="n">object_unparent</span><span class="p">(</span><span class="n">OBJECT</span><span class="p">(</span><span class="n">mr</span><span class="p">));</span>
        <span class="n">error_propagate</span><span class="p">(</span><span class="n">errp</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>RAMBlock is allocated and assigned to the current memory region through the 
qemu_ram_alloc function. Note that the allocated memory is assigned to the 
ram_block member field of the current memory region. The memory is the part of 
the QEMU’s address space which is a HVA in terms of virtualization.</p>

<h2 id="render-flatview"><span class="me-2">Render flatview</span><a href="#render-flatview" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<p>To render the flatview, it is required to invoke flatviews_init, 
generate_memory_topology, and address_space_set_flatview. The flatviews_reset
function does invoke first two functions flatviews_init and 
generate_memory_topology. After the flatviews are reset, it invokes the last 
function, address_space_set_flatview, to update the QEMU and KVM data structures
corresponding to the new memory region addition. Recall that the last function 
further invokes address_space_update_topology_pass and region_add of the 
listener.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre></td><td class="rouge-code"><pre><span class="kt">void</span> <span class="nf">memory_region_transaction_commit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">AddressSpace</span> <span class="o">*</span><span class="n">as</span><span class="p">;</span>

    <span class="n">assert</span><span class="p">(</span><span class="n">memory_region_transaction_depth</span><span class="p">);</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">qemu_mutex_iothread_locked</span><span class="p">());</span>

    <span class="o">--</span><span class="n">memory_region_transaction_depth</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memory_region_transaction_depth</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">memory_region_update_pending</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">flatviews_reset</span><span class="p">();</span>

            <span class="n">MEMORY_LISTENER_CALL_GLOBAL</span><span class="p">(</span><span class="n">begin</span><span class="p">,</span> <span class="n">Forward</span><span class="p">);</span>

            <span class="n">QTAILQ_FOREACH</span><span class="p">(</span><span class="n">as</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">address_spaces</span><span class="p">,</span> <span class="n">address_spaces_link</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">address_space_set_flatview</span><span class="p">(</span><span class="n">as</span><span class="p">);</span>
                <span class="n">address_space_update_ioeventfds</span><span class="p">(</span><span class="n">as</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="n">memory_region_update_pending</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
            <span class="n">ioeventfd_update_pending</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
            <span class="n">MEMORY_LISTENER_CALL_GLOBAL</span><span class="p">(</span><span class="n">commit</span><span class="p">,</span> <span class="n">Forward</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">ioeventfd_update_pending</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">QTAILQ_FOREACH</span><span class="p">(</span><span class="n">as</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">address_spaces</span><span class="p">,</span> <span class="n">address_spaces_link</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">address_space_update_ioeventfds</span><span class="p">(</span><span class="n">as</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="n">ioeventfd_update_pending</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
        <span class="p">}</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td class="rouge-code"><pre><span class="k">static</span> <span class="kt">void</span> <span class="nf">flatviews_reset</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">AddressSpace</span> <span class="o">*</span><span class="n">as</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">flat_views</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">g_hash_table_unref</span><span class="p">(</span><span class="n">flat_views</span><span class="p">);</span>
        <span class="n">flat_views</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">flatviews_init</span><span class="p">();</span>

    <span class="cm">/* Render unique FVs */</span>
    <span class="n">QTAILQ_FOREACH</span><span class="p">(</span><span class="n">as</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">address_spaces</span><span class="p">,</span> <span class="n">address_spaces_link</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">MemoryRegion</span> <span class="o">*</span><span class="n">physmr</span> <span class="o">=</span> <span class="n">memory_region_get_flatview_root</span><span class="p">(</span><span class="n">as</span><span class="o">-&gt;</span><span class="n">root</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">g_hash_table_lookup</span><span class="p">(</span><span class="n">flat_views</span><span class="p">,</span> <span class="n">physmr</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">generate_memory_topology</span><span class="p">(</span><span class="n">physmr</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Note that this function reset the flat_views and generate the memory topology 
for existing address space. Note that generate_memory_topology function is 
called, when the memory topology for address space doesn’t exist.</p>

<p>XXX{Move below to up}
Create a series of MemoryRegions, which respectively represent the RAM, ROM and
other areas in the Guest. The relationship between MemoryRegions is maintained 
through alias or subregions, thereby further refining the definition of the 
region AddressSpace represents the physical address space of the Guest.</p>

<p>If the 
MemoryRegion in AddressSpace changes, the registered listener will be triggered,
expand the MemoryRegion tree to generate a one-dimensional FlatView, and compare
whether the FlatRange has changed. If it is, call the corresponding method to 
check the MemoryRegionSection, update the KVMSlot in QEMU, and fill in the 
kvm_userspace_memory_regionstructure at the same time, as ioctl()a parameter to
update the KVM in KVMkvm_memory_slot</p>

<p>[[]]
http://blog.vmsplice.net/2016/01/qemu-internals-how-guest-physical-ram.html</p>

<h2 id="register-kvm-memory-listener-to-addressspace"><span class="me-2">Register KVM memory listener to AddressSpace</span><a href="#register-kvm-memory-listener-to-addressspace" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<p>Adding actual memories to the address space is done through the registered 
listener. The registered KVM listener bridges the QEMU and KVM module so that 
its operation such as region_add and region_del talks to KVM module and register 
memory to the VMs managed by the QEMU. Note that KVM managed actual memories,
but the QEMU assigns the memory for the guest VM. When memory related events 
happen on the address space where the KVM listener is registered to, it delivers
the event to KVM module.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="k">static</span> <span class="kt">int</span> <span class="nf">kvm_init</span><span class="p">(</span><span class="n">MachineState</span> <span class="o">*</span><span class="n">ms</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">.....</span>
    <span class="n">kvm_state</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span>

    <span class="n">ret</span> <span class="o">=</span> <span class="n">kvm_arch_init</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
<span class="p">......</span>
    <span class="n">kvm_memory_listener_register</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">memory_listener</span><span class="p">,</span>
                                 <span class="o">&amp;</span><span class="n">address_space_memory</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">"kvm-memory"</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></div></div>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="k">typedef</span> <span class="k">struct</span> <span class="nc">KVMMemoryListener</span> <span class="p">{</span>
    <span class="n">MemoryListener</span> <span class="n">listener</span><span class="p">;</span>
    <span class="n">KVMSlot</span> <span class="o">*</span><span class="n">slots</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">as_id</span><span class="p">;</span>
<span class="p">}</span> <span class="n">KVMMemoryListener</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Note that memory_listener is KVMMemoryListener type variable which is member 
field of KVMState. Also struct MemoryListener in KVMMemoryListener provides 
callbacks functions required for updates to the physical memory map.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre></td><td class="rouge-code"><pre><span class="kt">void</span> <span class="nf">kvm_memory_listener_register</span><span class="p">(</span><span class="n">KVMState</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="n">KVMMemoryListener</span> <span class="o">*</span><span class="n">kml</span><span class="p">,</span>
                                  <span class="n">AddressSpace</span> <span class="o">*</span><span class="n">as</span><span class="p">,</span> <span class="kt">int</span> <span class="n">as_id</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>   
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
    
    <span class="n">kml</span><span class="o">-&gt;</span><span class="n">slots</span> <span class="o">=</span> <span class="n">g_new0</span><span class="p">(</span><span class="n">KVMSlot</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">nr_slots</span><span class="p">);</span>
    <span class="n">kml</span><span class="o">-&gt;</span><span class="n">as_id</span> <span class="o">=</span> <span class="n">as_id</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">nr_slots</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">kml</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">slot</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="n">kml</span><span class="o">-&gt;</span><span class="n">listener</span><span class="p">.</span><span class="n">region_add</span> <span class="o">=</span> <span class="n">kvm_region_add</span><span class="p">;</span>
    <span class="n">kml</span><span class="o">-&gt;</span><span class="n">listener</span><span class="p">.</span><span class="n">region_del</span> <span class="o">=</span> <span class="n">kvm_region_del</span><span class="p">;</span>
    <span class="n">kml</span><span class="o">-&gt;</span><span class="n">listener</span><span class="p">.</span><span class="n">log_start</span> <span class="o">=</span> <span class="n">kvm_log_start</span><span class="p">;</span>
    <span class="n">kml</span><span class="o">-&gt;</span><span class="n">listener</span><span class="p">.</span><span class="n">log_stop</span> <span class="o">=</span> <span class="n">kvm_log_stop</span><span class="p">;</span> 
    <span class="n">kml</span><span class="o">-&gt;</span><span class="n">listener</span><span class="p">.</span><span class="n">priority</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>  
    <span class="n">kml</span><span class="o">-&gt;</span><span class="n">listener</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">kvm_dirty_ring_size</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">kml</span><span class="o">-&gt;</span><span class="n">listener</span><span class="p">.</span><span class="n">log_sync_global</span> <span class="o">=</span> <span class="n">kvm_log_sync_global</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">kml</span><span class="o">-&gt;</span><span class="n">listener</span><span class="p">.</span><span class="n">log_sync</span> <span class="o">=</span> <span class="n">kvm_log_sync</span><span class="p">;</span>
        <span class="n">kml</span><span class="o">-&gt;</span><span class="n">listener</span><span class="p">.</span><span class="n">log_clear</span> <span class="o">=</span> <span class="n">kvm_log_clear</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">memory_listener_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kml</span><span class="o">-&gt;</span><span class="n">listener</span><span class="p">,</span> <span class="n">as</span><span class="p">);</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">nr_as</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">as</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">as</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">s</span><span class="o">-&gt;</span><span class="n">as</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">as</span> <span class="o">=</span> <span class="n">as</span><span class="p">;</span>
            <span class="n">s</span><span class="o">-&gt;</span><span class="n">as</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ml</span> <span class="o">=</span> <span class="n">kml</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>kvm_memory_listener_register function allocates the callback functions needed 
for updates to physical memory map. Note that it assigns kvm_region_{add, del} 
functions as callbacks.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre></td><td class="rouge-code"><pre><span class="kt">void</span> <span class="nf">memory_listener_register</span><span class="p">(</span><span class="n">MemoryListener</span> <span class="o">*</span><span class="n">listener</span><span class="p">,</span> <span class="n">AddressSpace</span> <span class="o">*</span><span class="n">as</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">MemoryListener</span> <span class="o">*</span><span class="n">other</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
        
    <span class="cm">/* Only one of them can be defined for a listener */</span>
    <span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">listener</span><span class="o">-&gt;</span><span class="n">log_sync</span> <span class="o">&amp;&amp;</span> <span class="n">listener</span><span class="o">-&gt;</span><span class="n">log_sync_global</span><span class="p">));</span>
            
    <span class="n">listener</span><span class="o">-&gt;</span><span class="n">address_space</span> <span class="o">=</span> <span class="n">as</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">QTAILQ_EMPTY</span><span class="p">(</span><span class="o">&amp;</span><span class="n">memory_listeners</span><span class="p">)</span>
        <span class="o">||</span> <span class="n">listener</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">&gt;=</span> <span class="n">QTAILQ_LAST</span><span class="p">(</span><span class="o">&amp;</span><span class="n">memory_listeners</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">priority</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">QTAILQ_INSERT_TAIL</span><span class="p">(</span><span class="o">&amp;</span><span class="n">memory_listeners</span><span class="p">,</span> <span class="n">listener</span><span class="p">,</span> <span class="n">link</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">QTAILQ_FOREACH</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">memory_listeners</span><span class="p">,</span> <span class="n">link</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">listener</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">&lt;</span> <span class="n">other</span><span class="o">-&gt;</span><span class="n">priority</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span> 
        <span class="p">}</span>
        <span class="n">QTAILQ_INSERT_BEFORE</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">listener</span><span class="p">,</span> <span class="n">link</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">QTAILQ_EMPTY</span><span class="p">(</span><span class="o">&amp;</span><span class="n">as</span><span class="o">-&gt;</span><span class="n">listeners</span><span class="p">)</span>
        <span class="o">||</span> <span class="n">listener</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">&gt;=</span> <span class="n">QTAILQ_LAST</span><span class="p">(</span><span class="o">&amp;</span><span class="n">as</span><span class="o">-&gt;</span><span class="n">listeners</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">priority</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">QTAILQ_INSERT_TAIL</span><span class="p">(</span><span class="o">&amp;</span><span class="n">as</span><span class="o">-&gt;</span><span class="n">listeners</span><span class="p">,</span> <span class="n">listener</span><span class="p">,</span> <span class="n">link_as</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">QTAILQ_FOREACH</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">as</span><span class="o">-&gt;</span><span class="n">listeners</span><span class="p">,</span> <span class="n">link_as</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">listener</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">&lt;</span> <span class="n">other</span><span class="o">-&gt;</span><span class="n">priority</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">QTAILQ_INSERT_BEFORE</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">listener</span><span class="p">,</span> <span class="n">link_as</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">listener_add_address_space</span><span class="p">(</span><span class="n">listener</span><span class="p">,</span> <span class="n">as</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre></td><td class="rouge-code"><pre><span class="k">static</span> <span class="kt">void</span> <span class="nf">listener_add_address_space</span><span class="p">(</span><span class="n">MemoryListener</span> <span class="o">*</span><span class="n">listener</span><span class="p">,</span>
                                       <span class="n">AddressSpace</span> <span class="o">*</span><span class="n">as</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">FlatView</span> <span class="o">*</span><span class="n">view</span><span class="p">;</span>
    <span class="n">FlatRange</span> <span class="o">*</span><span class="n">fr</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">listener</span><span class="o">-&gt;</span><span class="n">begin</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">listener</span><span class="o">-&gt;</span><span class="n">begin</span><span class="p">(</span><span class="n">listener</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">global_dirty_tracking</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">listener</span><span class="o">-&gt;</span><span class="n">log_global_start</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">listener</span><span class="o">-&gt;</span><span class="n">log_global_start</span><span class="p">(</span><span class="n">listener</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">view</span> <span class="o">=</span> <span class="n">address_space_get_flatview</span><span class="p">(</span><span class="n">as</span><span class="p">);</span>
    <span class="n">FOR_EACH_FLAT_RANGE</span><span class="p">(</span><span class="n">fr</span><span class="p">,</span> <span class="n">view</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">MemoryRegionSection</span> <span class="n">section</span> <span class="o">=</span> <span class="n">section_from_flat_range</span><span class="p">(</span><span class="n">fr</span><span class="p">,</span> <span class="n">view</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">listener</span><span class="o">-&gt;</span><span class="n">region_add</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">listener</span><span class="o">-&gt;</span><span class="n">region_add</span><span class="p">(</span><span class="n">listener</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">section</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">fr</span><span class="o">-&gt;</span><span class="n">dirty_log_mask</span> <span class="o">&amp;&amp;</span> <span class="n">listener</span><span class="o">-&gt;</span><span class="n">log_start</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">listener</span><span class="o">-&gt;</span><span class="n">log_start</span><span class="p">(</span><span class="n">listener</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">section</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">fr</span><span class="o">-&gt;</span><span class="n">dirty_log_mask</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">listener</span><span class="o">-&gt;</span><span class="n">commit</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">listener</span><span class="o">-&gt;</span><span class="n">commit</span><span class="p">(</span><span class="n">listener</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">flatview_unref</span><span class="p">(</span><span class="n">view</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Recall that we were adding listener to the address_space_memory during the kvm 
initialization (kvm_init). Therefore, the address_space_memory is empty at this 
moment, and it will not invoke the region_add function of the listener.</p>

<h3 id="flatview-as-a-medium-between-qemu-and-kvm"><span class="me-2">FlatView as a medium between QEMU and KVM</span><a href="#flatview-as-a-medium-between-qemu-and-kvm" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>The domain of AddressSpace root and its subtree together constitute the physical
address space of the Guest, but these are defined on the QEMU side. When passing
in KVM for setting, the complex tree structure is not conducive to the kernel’s
processing, so it needs to be converted into a “flat” address model, that is, a
data structure that starts from zero and only contains address information. This
is represented by FlatView in QEMU . Each AddressSpace has a corresponding 
FlatView pointer current_map, indicating its corresponding flat view.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="k">static</span> <span class="kt">void</span> <span class="nf">address_space_update_topology</span><span class="p">(</span><span class="n">AddressSpace</span> <span class="o">*</span><span class="n">as</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">MemoryRegion</span> <span class="o">*</span><span class="n">physmr</span> <span class="o">=</span> <span class="n">memory_region_get_flatview_root</span><span class="p">(</span><span class="n">as</span><span class="o">-&gt;</span><span class="n">root</span><span class="p">);</span>

    <span class="n">flatviews_init</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">g_hash_table_lookup</span><span class="p">(</span><span class="n">flat_views</span><span class="p">,</span> <span class="n">physmr</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">generate_memory_topology</span><span class="p">(</span><span class="n">physmr</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">address_space_set_flatview</span><span class="p">(</span><span class="n">as</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Recall that each AddressSpace has root memory region associated with it. For 
example, for address_space_memory has system_memory as its root memory region.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
</pre></td><td class="rouge-code"><pre><span class="k">static</span> <span class="n">MemoryRegion</span> <span class="o">*</span><span class="nf">memory_region_get_flatview_root</span><span class="p">(</span><span class="n">MemoryRegion</span> <span class="o">*</span><span class="n">mr</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">mr</span><span class="o">-&gt;</span><span class="n">enabled</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">mr</span><span class="o">-&gt;</span><span class="n">alias</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mr</span><span class="o">-&gt;</span><span class="n">alias_offset</span> <span class="o">&amp;&amp;</span> <span class="n">int128_ge</span><span class="p">(</span><span class="n">mr</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="n">mr</span><span class="o">-&gt;</span><span class="n">alias</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">))</span> <span class="p">{</span>
                <span class="cm">/* The alias is included in its entirety.  Use it as
                 * the "real" root, so that we can share more FlatViews.
                 */</span>
                <span class="n">mr</span> <span class="o">=</span> <span class="n">mr</span><span class="o">-&gt;</span><span class="n">alias</span><span class="p">;</span>
                <span class="k">continue</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mr</span><span class="o">-&gt;</span><span class="n">terminates</span><span class="p">)</span> <span class="p">{</span>
            <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">MemoryRegion</span> <span class="o">*</span><span class="n">child</span><span class="p">,</span> <span class="o">*</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
            <span class="n">QTAILQ_FOREACH</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mr</span><span class="o">-&gt;</span><span class="n">subregions</span><span class="p">,</span> <span class="n">subregions_link</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">child</span><span class="o">-&gt;</span><span class="n">enabled</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">found</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
                        <span class="k">break</span><span class="p">;</span>
                    <span class="p">}</span>
                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">child</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">&amp;&amp;</span> <span class="n">int128_ge</span><span class="p">(</span><span class="n">mr</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="n">child</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">))</span> <span class="p">{</span>
                        <span class="cm">/* A child is included in its entirety.  If it's the only
                         * enabled one, use it in the hope of finding an alias down the
                         * way. This will also let us share FlatViews.
                         */</span>
                        <span class="n">next</span> <span class="o">=</span> <span class="n">child</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">found</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">mr</span> <span class="o">=</span> <span class="n">next</span><span class="p">;</span>
                <span class="k">continue</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">mr</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

</pre></td></tr></tbody></table></code></div></div>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre></td><td class="rouge-code"><pre><span class="cm">/* Render a memory topology into a list of disjoint absolute ranges. */</span>
<span class="k">static</span> <span class="n">FlatView</span> <span class="o">*</span><span class="nf">generate_memory_topology</span><span class="p">(</span><span class="n">MemoryRegion</span> <span class="o">*</span><span class="n">mr</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
    <span class="n">FlatView</span> <span class="o">*</span><span class="n">view</span><span class="p">;</span>

    <span class="n">view</span> <span class="o">=</span> <span class="n">flatview_new</span><span class="p">(</span><span class="n">mr</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">mr</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">render_memory_region</span><span class="p">(</span><span class="n">view</span><span class="p">,</span> <span class="n">mr</span><span class="p">,</span> <span class="n">int128_zero</span><span class="p">(),</span>
                             <span class="n">addrrange_make</span><span class="p">(</span><span class="n">int128_zero</span><span class="p">(),</span> <span class="n">int128_2_64</span><span class="p">()),</span>
                             <span class="nb">false</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">flatview_simplify</span><span class="p">(</span><span class="n">view</span><span class="p">);</span>

    <span class="n">view</span><span class="o">-&gt;</span><span class="n">dispatch</span> <span class="o">=</span> <span class="n">address_space_dispatch_new</span><span class="p">(</span><span class="n">view</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">view</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">MemoryRegionSection</span> <span class="n">mrs</span> <span class="o">=</span>
            <span class="n">section_from_flat_range</span><span class="p">(</span><span class="o">&amp;</span><span class="n">view</span><span class="o">-&gt;</span><span class="n">ranges</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">view</span><span class="p">);</span>
        <span class="n">flatview_add_to_dispatch</span><span class="p">(</span><span class="n">view</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mrs</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">address_space_dispatch_compact</span><span class="p">(</span><span class="n">view</span><span class="o">-&gt;</span><span class="n">dispatch</span><span class="p">);</span>
    <span class="n">g_hash_table_replace</span><span class="p">(</span><span class="n">flat_views</span><span class="p">,</span> <span class="n">mr</span><span class="p">,</span> <span class="n">view</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">view</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
</pre></td><td class="rouge-code"><pre><span class="k">static</span> <span class="kt">void</span> <span class="nf">address_space_set_flatview</span><span class="p">(</span><span class="n">AddressSpace</span> <span class="o">*</span><span class="n">as</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">FlatView</span> <span class="o">*</span><span class="n">old_view</span> <span class="o">=</span> <span class="n">address_space_to_flatview</span><span class="p">(</span><span class="n">as</span><span class="p">);</span>
    <span class="n">MemoryRegion</span> <span class="o">*</span><span class="n">physmr</span> <span class="o">=</span> <span class="n">memory_region_get_flatview_root</span><span class="p">(</span><span class="n">as</span><span class="o">-&gt;</span><span class="n">root</span><span class="p">);</span>
    <span class="n">FlatView</span> <span class="o">*</span><span class="n">new_view</span> <span class="o">=</span> <span class="n">g_hash_table_lookup</span><span class="p">(</span><span class="n">flat_views</span><span class="p">,</span> <span class="n">physmr</span><span class="p">);</span>

    <span class="n">assert</span><span class="p">(</span><span class="n">new_view</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">old_view</span> <span class="o">==</span> <span class="n">new_view</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">old_view</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">flatview_ref</span><span class="p">(</span><span class="n">old_view</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">flatview_ref</span><span class="p">(</span><span class="n">new_view</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">QTAILQ_EMPTY</span><span class="p">(</span><span class="o">&amp;</span><span class="n">as</span><span class="o">-&gt;</span><span class="n">listeners</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">FlatView</span> <span class="n">tmpview</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">nr</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">},</span> <span class="o">*</span><span class="n">old_view2</span> <span class="o">=</span> <span class="n">old_view</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">old_view2</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">old_view2</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tmpview</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">address_space_update_topology_pass</span><span class="p">(</span><span class="n">as</span><span class="p">,</span> <span class="n">old_view2</span><span class="p">,</span> <span class="n">new_view</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
        <span class="n">address_space_update_topology_pass</span><span class="p">(</span><span class="n">as</span><span class="p">,</span> <span class="n">old_view2</span><span class="p">,</span> <span class="n">new_view</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="cm">/* Writes are protected by the BQL.  */</span>
    <span class="n">qatomic_rcu_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">as</span><span class="o">-&gt;</span><span class="n">current_map</span><span class="p">,</span> <span class="n">new_view</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">old_view</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">flatview_unref</span><span class="p">(</span><span class="n">old_view</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="cm">/* Note that all the old MemoryRegions are still alive up to this
     * point.  This relieves most MemoryListeners from the need to
     * ref/unref the MemoryRegions they get---unless they use them
     * outside the iothread mutex, in which case precise reference
     * counting is necessary.
     */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">old_view</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">flatview_unref</span><span class="p">(</span><span class="n">old_view</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Each AddressSpace has dedicated listener (please refer to [[]]), so it will 
invoke the address_space_update_topology_pass function.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="rouge-code"><pre><span class="k">static</span> <span class="kt">void</span> <span class="nf">address_space_update_topology_pass</span><span class="p">(</span><span class="n">AddressSpace</span> <span class="o">*</span><span class="n">as</span><span class="p">,</span>
                                               <span class="k">const</span> <span class="n">FlatView</span> <span class="o">*</span><span class="n">old_view</span><span class="p">,</span>
                                               <span class="k">const</span> <span class="n">FlatView</span> <span class="o">*</span><span class="n">new_view</span><span class="p">,</span>
                                               <span class="kt">bool</span> <span class="n">adding</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="n">iold</span><span class="p">,</span> <span class="n">inew</span><span class="p">;</span>
    <span class="n">FlatRange</span> <span class="o">*</span><span class="n">frold</span><span class="p">,</span> <span class="o">*</span><span class="n">frnew</span><span class="p">;</span>
<span class="p">......</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="cm">/* In new */</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">adding</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">MEMORY_LISTENER_UPDATE_REGION</span><span class="p">(</span><span class="n">frnew</span><span class="p">,</span> <span class="n">as</span><span class="p">,</span> <span class="n">Forward</span><span class="p">,</span> <span class="n">region_add</span><span class="p">);</span>
                <span class="n">flat_range_coalesced_io_add</span><span class="p">(</span><span class="n">frnew</span><span class="p">,</span> <span class="n">as</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="o">++</span><span class="n">inew</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre></td><td class="rouge-code"><pre><span class="cm">/* No need to ref/unref .mr, the FlatRange keeps it alive.  */</span>
<span class="cp">#define MEMORY_LISTENER_UPDATE_REGION(fr, as, dir, callback, _args...)  \
    do {                                                                \
        MemoryRegionSection mrs = section_from_flat_range(fr,           \
                address_space_to_flatview(as));                         \
        MEMORY_LISTENER_CALL(as, callback, dir, &amp;mrs, ##_args);         \
    } while(0)
</span>
<span class="cp">#define MEMORY_LISTENER_CALL(_as, _callback, _direction, _section, _args...) \
    do {                                                                \
        MemoryListener *_listener;                                      \
                                                                        \
        switch (_direction) {                                           \
        case Forward:                                                   \
            QTAILQ_FOREACH(_listener, &amp;(_as)-&gt;listeners, link_as) {     \
                if (_listener-&gt;_callback) {                             \
                    _listener-&gt;_callback(_listener, _section, ##_args); \
                }                                                       \
            }                                                           \
            break;                                                      \
        case Reverse:                                                   \
            QTAILQ_FOREACH_REVERSE(_listener, &amp;(_as)-&gt;listeners, link_as) { \
                if (_listener-&gt;_callback) {                             \
                    _listener-&gt;_callback(_listener, _section, ##_args); \
                }                                                       \
            }                                                           \
            break;                                                      \
        default:                                                        \
            abort();                                                    \
        }                                                               \
    } while (0)
</span></pre></td></tr></tbody></table></code></div></div>


  </div>

  <div class="post-tail-wrapper text-muted">
    <!-- categories -->
    
      <div class="post-meta mb-3">
        <i class="far fa-folder-open fa-fw me-1"></i>
        
          <a href="/categories/kvm/">KVM</a>,
          <a href="/categories/qemu/">QEMU</a>,
          <a href="/categories/intel-tdx/">Intel TDX</a>
      </div>
    

    <!-- tags -->
    

    <div
      class="
        post-tail-bottom
        d-flex justify-content-between align-items-center mt-5 pb-2
      "
    >
      <div class="license-wrapper">
        
          

          This post is licensed under 
        <a href="https://creativecommons.org/licenses/by/4.0/">
          CC BY 4.0
        </a>
         by the author.
        
      </div>

      <!-- Post sharing snippet -->

<div class="share-wrapper d-flex align-items-center">
  <span class="share-label text-muted">Share</span>
  <span class="share-icons">
    
    
    

    

      

      <a
        href="https://twitter.com/intent/tweet?text=QEMU%20Side%20Memory%20Management%20for%20VM%20with%20RAMBLOCK%20-%20Ruach&url=https%3A%2F%2Fruach.github.io%2Fposts%2FQEMU-KVM-ADDRESS-SPACE%2F"
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Twitter"
        target="_blank"
        rel="noopener"
        aria-label="Twitter"
      >
        <i class="fa-fw fa-brands fa-square-x-twitter"></i>
      </a>
    

      

      <a
        href="https://www.facebook.com/sharer/sharer.php?title=QEMU%20Side%20Memory%20Management%20for%20VM%20with%20RAMBLOCK%20-%20Ruach&u=https%3A%2F%2Fruach.github.io%2Fposts%2FQEMU-KVM-ADDRESS-SPACE%2F"
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Facebook"
        target="_blank"
        rel="noopener"
        aria-label="Facebook"
      >
        <i class="fa-fw fab fa-facebook-square"></i>
      </a>
    

      

      <a
        href="https://t.me/share/url?url=https%3A%2F%2Fruach.github.io%2Fposts%2FQEMU-KVM-ADDRESS-SPACE%2F&text=QEMU%20Side%20Memory%20Management%20for%20VM%20with%20RAMBLOCK%20-%20Ruach"
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Telegram"
        target="_blank"
        rel="noopener"
        aria-label="Telegram"
      >
        <i class="fa-fw fab fa-telegram"></i>
      </a>
    

      

      <a
        href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fruach.github.io%2Fposts%2FQEMU-KVM-ADDRESS-SPACE%2F"
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Linkedin"
        target="_blank"
        rel="noopener"
        aria-label="Linkedin"
      >
        <i class="fa-fw fab fa-linkedin"></i>
      </a>
    

    <button
      id="copy-link"
      aria-label="Copy link"
      class="btn small"
      data-bs-toggle="tooltip"
      data-bs-placement="top"
      title="Copy link"
      data-title-succeed="Link copied successfully!"
    >
      <i class="fa-fw fas fa-link pe-none fs-6"></i>
    </button>
  </span>
</div>

    </div>
    <!-- .post-tail-bottom -->
  </div>
  <!-- div.post-tail-wrapper -->
</article>


            
          </main>

          <!-- panel -->
          <aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 mb-5 text-muted">
            <div class="access">
              <!-- Get the last 5 posts from lastmod list. -->















              <!-- The trending tags list -->


















            </div>

            
              
              



  <section id="toc-wrapper" class="ps-0 pe-4">
    <h2 class="panel-heading ps-3 pt-2 mb-2">Contents</h2>
    <nav id="toc"></nav>
  </section>


            
          </aside>
        </div>

        <div class="row">
          <!-- tail -->
          <div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4">
            
              
              <!-- Recommend the other 3 posts according to the tags and categories of the current post. -->

<!-- The total size of related posts -->


<!-- An random integer that bigger than 0 -->


<!-- Equals to TAG_SCORE / {max_categories_hierarchy} -->














  

  

  

  

  

  

  

  

  

  

  

  

  

  
    
  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  











  <aside id="related-posts" aria-labelledby="related-label">
    <h3 class="mb-4" id="related-label">Further Reading</h3>
    <nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4">
      
        <article class="col">
          <a href="/posts/TDX-MODULE-LIFECYCLE-2/" class="post-preview card h-100">
            <div class="card-body">
              <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1679544000"
  data-df="ll"
  
>
  Mar 23, 2023
</time>

              <h4 class="pt-0 my-2">TDX Module Life Cycle Part 2</h4>
              <div class="text-muted">
                <p>
                  





                  In previous posts, I discussed the initialization of the TDX module using 
TDH_SYS_INIT SEAMCALL. As depicted in the image below, several additional 
configuration steps are necessary for the TDX m...
                </p>
              </div>
            </div>
          </a>
        </article>
      
        <article class="col">
          <a href="/posts/SPT-AND-MEMSLOT/" class="post-preview card h-100">
            <div class="card-body">
              <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1681099200"
  data-df="ll"
  
>
  Apr 10, 2023
</time>

              <h4 class="pt-0 my-2">Shadow Page Table (SPT) and MEMSLOT</h4>
              <div class="text-muted">
                <p>
                  





                  Shadow Page Table (SPT)
Before the introduction of TDP, shadow paging has been utilized to translate
GPA to HPA. The KVM module utilize a unified concept to abstract the 
structure managing this tr...
                </p>
              </div>
            </div>
          </a>
        </article>
      
        <article class="col">
          <a href="/posts/PAGEFAULT-HANDLING-KVM-TDX/" class="post-preview card h-100">
            <div class="card-body">
              <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1681531200"
  data-df="ll"
  
>
  Apr 15, 2023
</time>

              <h4 class="pt-0 my-2">KVM page-fault handling for TDX</h4>
              <div class="text-muted">
                <p>
                  





                  Basic idea to implement private page

  Because shared EPT is the same as the existing EPT, use the existing logic for
shared EPT.  On the other hand, secure EPT requires additional operations
inst...
                </p>
              </div>
            </div>
          </a>
        </article>
      
    </nav>
  </aside>
  <!-- #related-posts -->


            
              
              <!-- Navigation buttons at the bottom of the post. -->

<nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation">
  
  

  
    <a
      href="/posts/SPT-AND-MEMSLOT/"
      class="btn btn-outline-primary"
      aria-label="Older"
    >
      <p>Shadow Page Table (SPT) and MEMSLOT</p>
    </a>
  

  
    <a
      href="/posts/PAGEFAULT-HANDLING-KVM/"
      class="btn btn-outline-primary"
      aria-label="Newer"
    >
      <p>KVM page-fault handling</p>
    </a>
  
</nav>

            
              
              <!--  The comments switcher -->

  
  <!-- The Disqus lazy loading. -->

<div id="disqus_thread">
  <p class="text-center text-muted small">Comments powered by <a href="https://disqus.com/">Disqus</a>.</p>
</div>

<script type="text/javascript">
  var disqus_config = function () {
    this.page.url = 'https://ruach.github.io/posts/QEMU-KVM-ADDRESS-SPACE/';
    this.page.identifier = '/posts/QEMU-KVM-ADDRESS-SPACE/';
  };

  /* Lazy loading */
  var disqus_observer = new IntersectionObserver(
    function (entries) {
      if (entries[0].isIntersecting) {
        (function () {
          var d = document,
            s = d.createElement('script');
          s.src = 'https://ruach.disqus.com/embed.js';
          s.setAttribute('data-timestamp', +new Date());
          (d.head || d.body).appendChild(s);
        })();

        disqus_observer.disconnect();
      }
    },
    { threshold: [0] }
  );

  disqus_observer.observe(document.querySelector('#disqus_thread'));

  /* Auto switch theme */
  function reloadDisqus() {
    if (event.source === window && event.data && event.data.direction === ModeToggle.ID) {
      /* Disqus hasn't been loaded */
      if (typeof DISQUS === 'undefined') {
        return;
      }

      if (document.readyState == 'complete') {
        DISQUS.reset({ reload: true, config: disqus_config });
      }
    }
  }

  if (document.querySelector('.mode-toggle')) {
    window.addEventListener('message', reloadDisqus);
  }
</script>



            

            <!-- The Footer -->

<footer
  aria-label="Site Info"
  class="
    d-flex flex-column justify-content-center text-muted
    flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3
  "
>
  <p>
    ©
    <time>2024</time>
    <a href="https://ruach.github.io">Jaehyuk Lee</a>.
    
      <span
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author."
      >Some rights reserved.</span>
    
  </p>

  <p>Using the <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme for <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>
  </p>
</footer>

          </div>
        </div>

        <!-- The Search results -->

<div id="search-result-wrapper" class="d-flex justify-content-center unloaded">
  <div class="col-11 content">
    <div id="search-hints">
      <!-- The trending tags list -->


















    </div>
    <div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div>
  </div>
</div>

      </div>

      <aside aria-label="Scroll to Top">
        <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow">
          <i class="fas fa-angle-up"></i>
        </button>
      </aside>
    </div>

    <div id="mask"></div>

    
      <aside
  id="notification"
  class="toast"
  role="alert"
  aria-live="assertive"
  aria-atomic="true"
  data-bs-animation="true"
  data-bs-autohide="false"
>
  <div class="toast-header">
    <button
      type="button"
      class="btn-close ms-auto"
      data-bs-dismiss="toast"
      aria-label="Close"
    ></button>
  </div>
  <div class="toast-body text-center pt-0">
    <p class="px-2 mb-3">A new version of content is available.</p>
    <button type="button" class="btn btn-primary" aria-label="Update">
      Update
    </button>
  </div>
</aside>

    

    <!-- JavaScripts -->

    <!-- JS selector for site. -->

<!-- commons -->



<!-- layout specified -->


  

  
    <!-- image lazy-loading & popup & clipboard -->
    
  















  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  



  <script src="https://cdn.jsdelivr.net/combine/npm/jquery@3.7.1/dist/jquery.min.js,npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js,npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/magnific-popup@1.1.0/dist/jquery.magnific-popup.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.10/dayjs.min.js,npm/dayjs@1.11.10/locale/en.min.js,npm/dayjs@1.11.10/plugin/relativeTime.min.js,npm/dayjs@1.11.10/plugin/localizedFormat.min.js,npm/tocbot@4.21.2/dist/tocbot.min.js"></script>






<script defer src="/assets/js/dist/post.min.js"></script>






    

    <!--
  Jekyll Simple Search loader
  See: <https://github.com/christian-fei/Simple-Jekyll-Search>
-->





<script>
  /* Note: dependent library will be loaded in `js-selector.html` */
  SimpleJekyllSearch({
    searchInput: document.getElementById('search-input'),
    resultsContainer: document.getElementById('search-results'),
    json: '/assets/js/data/search.json',
    searchResultTemplate: '  <article class="px-1 px-sm-2 px-lg-4 px-xl-0">    <header>      <h2><a href="{url}">{title}</a></h2>      <div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1">        {categories}        {tags}      </div>    </header>    <p>{snippet}</p>  </article>',
    noResultsText: '<p class="mt-5"></p>',
    templateMiddleware: function(prop, value, template) {
      if (prop === 'categories') {
        if (value === '') {
          return `${value}`;
        } else {
          return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`;
        }
      }

      if (prop === 'tags') {
        if (value === '') {
          return `${value}`;
        } else {
          return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`;
        }
      }
    }
  });
</script>

  </body>
</html>

