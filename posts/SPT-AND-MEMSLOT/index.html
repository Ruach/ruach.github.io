<!doctype html>














<!-- `site.alt_lang` can specify a language different from the UI -->
<html lang="en" data-mode="light">
  <!-- The Head -->

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta
    name="viewport"
    content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover"
  >

  

  

  
    <!-- Begin Jekyll SEO tag v2.8.0 -->
<meta name="generator" content="Jekyll v4.3.2" />
<meta property="og:title" content="Shadow Page Table (SPT) and MEMSLOT" />
<meta property="og:locale" content="en" />
<meta name="description" content="Shadow Page Table (SPT) Before the introduction of TDP, shadow paging has been utilized to translate GPA to HPA. The KVM module utilize a unified concept to abstract the structure managing this translation (GPA-&gt;HPA), called Shadow Page Table (SPT). Although it reminds of shadow paging, the emulated page table based translation before the invention TDP, now it represents the table handling GPA-&gt;HPA translation regardless of the implementation behind. KVM utilizes the term Two Dimensional Paging (TDP) to distinguish EPT based translation (hardware) from shadow page table based translation (software-emulation). This terminology is quite confusing, but allow the TDP implementation to fit into the code base previously implemented for shadow paging. Each entry of SPT is called Shadow Page Table Entry (SPTE)." />
<meta property="og:description" content="Shadow Page Table (SPT) Before the introduction of TDP, shadow paging has been utilized to translate GPA to HPA. The KVM module utilize a unified concept to abstract the structure managing this translation (GPA-&gt;HPA), called Shadow Page Table (SPT). Although it reminds of shadow paging, the emulated page table based translation before the invention TDP, now it represents the table handling GPA-&gt;HPA translation regardless of the implementation behind. KVM utilizes the term Two Dimensional Paging (TDP) to distinguish EPT based translation (hardware) from shadow page table based translation (software-emulation). This terminology is quite confusing, but allow the TDP implementation to fit into the code base previously implemented for shadow paging. Each entry of SPT is called Shadow Page Table Entry (SPTE)." />
<link rel="canonical" href="https://ruach.github.io/posts/SPT-AND-MEMSLOT/" />
<meta property="og:url" content="https://ruach.github.io/posts/SPT-AND-MEMSLOT/" />
<meta property="og:site_name" content="Ruach" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2023-04-10T00:00:00-04:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Shadow Page Table (SPT) and MEMSLOT" />
<meta name="twitter:site" content="@ruach_lee" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2023-04-10T00:00:00-04:00","datePublished":"2023-04-10T00:00:00-04:00","description":"Shadow Page Table (SPT) Before the introduction of TDP, shadow paging has been utilized to translate GPA to HPA. The KVM module utilize a unified concept to abstract the structure managing this translation (GPA-&gt;HPA), called Shadow Page Table (SPT). Although it reminds of shadow paging, the emulated page table based translation before the invention TDP, now it represents the table handling GPA-&gt;HPA translation regardless of the implementation behind. KVM utilizes the term Two Dimensional Paging (TDP) to distinguish EPT based translation (hardware) from shadow page table based translation (software-emulation). This terminology is quite confusing, but allow the TDP implementation to fit into the code base previously implemented for shadow paging. Each entry of SPT is called Shadow Page Table Entry (SPTE).","headline":"Shadow Page Table (SPT) and MEMSLOT","mainEntityOfPage":{"@type":"WebPage","@id":"https://ruach.github.io/posts/SPT-AND-MEMSLOT/"},"url":"https://ruach.github.io/posts/SPT-AND-MEMSLOT/"}</script>
<!-- End Jekyll SEO tag -->

  

  <title>Shadow Page Table (SPT) and MEMSLOT | Ruach
  </title>

  <!--
  The Favicons for Web, Android, Microsoft, and iOS (iPhone and iPad) Apps
  Generated by: https://realfavicongenerator.net/
-->



<link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png">
<link rel="manifest" href="/assets/img/favicons/site.webmanifest">
<link rel="shortcut icon" href="/assets/img/favicons/favicon.ico">
<meta name="apple-mobile-web-app-title" content="Ruach">
<meta name="application-name" content="Ruach">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml">
<meta name="theme-color" content="#ffffff">


  
    
      <link rel="preconnect" href="https://fonts.googleapis.com" >
      <link rel="dns-prefetch" href="https://fonts.googleapis.com" >
    
      <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      <link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin>
    
      <link rel="preconnect" href="https://fonts.googleapis.com" >
      <link rel="dns-prefetch" href="https://fonts.googleapis.com" >
    
      <link rel="preconnect" href="https://cdn.jsdelivr.net" >
      <link rel="dns-prefetch" href="https://cdn.jsdelivr.net" >
    

    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap">
  

  <!-- GA -->
  

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.2/css/all.min.css">

  <link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css">

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.21.2/dist/tocbot.min.css">
  

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css">
  

  
    <!-- Manific Popup -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css">
  

  <!-- JavaScript -->

  

  <!-- A placeholder to allow defining custom metadata -->

</head>


  <body>
    <!-- The Side Bar -->

<aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end">
  <header class="profile-wrapper">
    <a href="/" id="avatar" class="rounded-circle">
      
        
        <img src="/assets/img/jaehyuk.png" width="112" height="112" alt="avatar" onerror="this.style.display='none'">
      
    </a>

    <h1 class="site-title">
      <a href="/">Ruach</a>
    </h1>
    <p class="site-subtitle fst-italic mb-0">Jaehyuk Lee</p>
  </header>
  <!-- .profile-wrapper -->

  <nav class="flex-column flex-grow-1 w-100 ps-0">
    <ul class="nav">
      <!-- home -->
      <li class="nav-item">
        <a href="/" class="nav-link">
          <i class="fa-fw fas fa-home"></i>
          <span>HOME</span>
        </a>
      </li>
      <!-- the real tabs -->
      
        <li class="nav-item">
          <a href="/categories/" class="nav-link">
            <i class="fa-fw fas fa-stream"></i>
            

            <span>CATEGORIES</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/archives/" class="nav-link">
            <i class="fa-fw fas fa-archive"></i>
            

            <span>ARCHIVES</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/Professional-Career/" class="nav-link">
            <i class="fa-fw fas fa-id-card"></i>
            

            <span>PROFESSIONAL CAREER</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/about/" class="nav-link">
            <i class="fa-fw fas fa-info-circle"></i>
            

            <span>ABOUT</span>
          </a>
        </li>
        <!-- .nav-item -->
      
    </ul>
  </nav>

  <div class="sidebar-bottom d-flex flex-wrap  align-items-center w-100">
    

    
      

      
        <a
          href="javascript:location.href = 'mailto:' + ['jaehyuk','gatech.edu'].join('@')"
          aria-label="email"
          

          

          

          
        >
          <i class="fas fa-envelope"></i>
        </a>
      
    
      

      
        <a
          href="https://www.linkedin.com/in/jaehyuk-lee-29b33b121/"
          aria-label="linkedin"
          

          
            target="_blank"
            
          

          

          
            rel="noopener noreferrer"
          
        >
          <i class="fab fa-linkedin"></i>
        </a>
      
    
      

      
        <a
          href="https://github.com/Ruach"
          aria-label="github"
          

          
            target="_blank"
            
          

          

          
            rel="noopener noreferrer"
          
        >
          <i class="fab fa-github"></i>
        </a>
      
    
      

      
        <a
          href="https://stackoverflow.com/users/4460514/ruach?tab=profile"
          aria-label="stack-overflow"
          

          
            target="_blank"
            
          

          

          
            rel="noopener noreferrer"
          
        >
          <i class="fab fa-stack-overflow"></i>
        </a>
      
    
  </div>
  <!-- .sidebar-bottom -->
</aside>
<!-- #sidebar -->


    <div id="main-wrapper" class="d-flex justify-content-center">
      <div class="container d-flex flex-column px-xxl-5">
        <!-- The Top Bar -->

<header id="topbar-wrapper" aria-label="Top Bar">
  <div
    id="topbar"
    class="d-flex align-items-center justify-content-between px-lg-3 h-100"
  >
    <nav id="breadcrumb" aria-label="Breadcrumb">
      

      
        
          
            <span>
              <a href="/">
                Home
              </a>
            </span>

          
        
          
        
          
            
              <span>Shadow Page Table (SPT) and MEMSLOT</span>
            

          
        
      
    </nav>
    <!-- endof #breadcrumb -->

    <button type="button" id="sidebar-trigger" class="btn btn-link">
      <i class="fas fa-bars fa-fw"></i>
    </button>

    <div id="topbar-title">
      Post
    </div>

    <button type="button" id="search-trigger" class="btn btn-link">
      <i class="fas fa-search fa-fw"></i>
    </button>

    <search class="align-items-center ms-3 ms-lg-0">
      <i class="fas fa-search fa-fw"></i>
      <input
        class="form-control"
        id="search-input"
        type="search"
        aria-label="search"
        autocomplete="off"
        placeholder="Search..."
      >
    </search>
    <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button>
  </div>
</header>


        <div class="row flex-grow-1">
          <main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4">
            
              <!-- Refactor the HTML structure -->



<!--
  In order to allow a wide table to scroll horizontally,
  we suround the markdown table with `<div class="table-wrapper">` and `</div>`
-->



<!--
  Fixed kramdown code highlight rendering:
  https://github.com/penibelst/jekyll-compress-html/issues/101
  https://github.com/penibelst/jekyll-compress-html/issues/71#issuecomment-188144901
-->



<!-- Change the icon of checkbox -->



<!-- Handle images -->





<!-- Add header for code snippets -->



<!-- Create heading anchors -->





  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    

    
  

  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    

    
  

  
  

  

  
  

  




<!-- return -->




<article class="px-1">
  <header>
    <h1 data-toc-skip>Shadow Page Table (SPT) and MEMSLOT</h1>

    <div class="post-meta text-muted">
      <!-- published date -->
      <span>
        Posted
        <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1681099200"
  data-df="ll"
  
    data-bs-toggle="tooltip" data-bs-placement="bottom"
  
>
  Apr 10, 2023
</time>

      </span>

      <!-- lastmod date -->
      

      

      <div class="d-flex justify-content-between">
        <!-- author(s) -->
        <span>
          

          By

          <em>
            
              <a href="https://ruach.github.io">Jaehyuk Lee</a>
            
          </em>
        </span>

        <!-- read time -->
        <!-- Calculate the post's reading time, and display the word count in tooltip -->



<!-- words per minute -->










<!-- return element -->
<span
  class="readtime"
  data-bs-toggle="tooltip"
  data-bs-placement="bottom"
  title="2138 words"
>
  <em>11 min</em> read</span>

      </div>
      <!-- .d-flex -->
    </div>
    <!-- .post-meta -->
  </header>

  <div class="content">
    <h2 id="shadow-page-table-spt"><span class="me-2">Shadow Page Table (SPT)</span><a href="#shadow-page-table-spt" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<p>Before the introduction of TDP, shadow paging has been utilized to translate
<strong>GPA to HPA</strong>. The KVM module utilize a unified concept to abstract the 
structure managing this translation (GPA-&gt;HPA), called <strong>Shadow Page Table (SPT)</strong>. 
Although it reminds of shadow paging, the emulated page table based 
translation before the invention TDP, now it represents the table handling 
GPA-&gt;HPA translation regardless of the implementation behind. KVM utilizes the
term Two Dimensional Paging (TDP) to distinguish EPT based translation 
(hardware) from shadow page table based translation (software-emulation). This
terminology is quite confusing, but allow the TDP implementation to fit into the
code base previously implemented for shadow paging. Each entry of SPT is called 
Shadow Page Table Entry (SPTE).</p>

<h3 id="struct-kvm_mmu_page"><span class="me-2">Struct kvm_mmu_page</span><a href="#struct-kvm_mmu_page" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>EPT consists of 4 different levels, the top level is Level-4 (PML4 Table), and
then Level-3 (PDPT), Level-2 (PDT), Level-1 (PT) in turn. Each page table page,
regardless of the levels, are represented by <strong>kvm_mmu_page</strong> in the KVM.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
</pre></td><td class="rouge-code"><pre><span class="k">struct</span> <span class="nc">kvm_mmu_page</span> <span class="p">{</span>
        <span class="k">struct</span> <span class="nc">list_head</span> <span class="n">link</span><span class="p">;</span>
        <span class="k">struct</span> <span class="nc">hlist_node</span> <span class="n">hash_link</span><span class="p">;</span>
        
        <span class="kt">bool</span> <span class="n">tdp_mmu_page</span><span class="p">;</span>
        <span class="kt">bool</span> <span class="n">unsync</span><span class="p">;</span>
        <span class="n">u8</span> <span class="n">mmu_valid_gen</span><span class="p">;</span>
        <span class="kt">bool</span> <span class="n">lpage_disallowed</span><span class="p">;</span> <span class="cm">/* Can't be replaced by an equiv large page */</span>

        <span class="cm">/*
         * The following two entries are used to key the shadow page in the
         * hash table.
         */</span>
        <span class="k">union</span> <span class="n">kvm_mmu_page_role</span> <span class="n">role</span><span class="p">;</span>
        <span class="n">gfn_t</span> <span class="n">gfn</span><span class="p">;</span>
        <span class="n">gfn_t</span> <span class="n">gfn_stolen_bits</span><span class="p">;</span>

        <span class="n">u64</span> <span class="o">*</span><span class="n">spt</span><span class="p">;</span>
        <span class="cm">/* hold the gfn of each spte inside spt */</span>
        <span class="n">gfn_t</span> <span class="o">*</span><span class="n">gfns</span><span class="p">;</span>
        <span class="cm">/* associated private shadow page, e.g. SEPT page */</span>
        <span class="kt">void</span> <span class="o">*</span><span class="n">private_sp</span><span class="p">;</span>
        <span class="cm">/* Currently serving as active root */</span>
        <span class="k">union</span> <span class="p">{</span>
                <span class="kt">int</span> <span class="n">root_count</span><span class="p">;</span>
                <span class="n">refcount_t</span> <span class="n">tdp_mmu_root_count</span><span class="p">;</span>
        <span class="p">};</span>
        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">unsync_children</span><span class="p">;</span>
        <span class="k">struct</span> <span class="nc">kvm_rmap_head</span> <span class="n">parent_ptes</span><span class="p">;</span> <span class="cm">/* rmap pointers to parent sptes */</span>
        <span class="n">DECLARE_BITMAP</span><span class="p">(</span><span class="n">unsync_child_bitmap</span><span class="p">,</span> <span class="mi">512</span><span class="p">);</span>

        <span class="k">struct</span> <span class="nc">list_head</span> <span class="n">lpage_disallowed_link</span><span class="p">;</span>

        <span class="cm">/* Number of writes since the last time traversal visited this page.  */</span>
        <span class="n">atomic_t</span> <span class="n">write_flooding_count</span><span class="p">;</span>

        <span class="cm">/* Used for freeing the page asynchronously if it is a TDP MMU page. */</span>
        <span class="k">struct</span> <span class="nc">rcu_head</span> <span class="n">rcu_head</span><span class="p">;</span>
<span class="p">};</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Main job of each level of EPT is storing physical address of next level EPT, and 
the spt member field is used for this purpose. However, kvm_mmu_page structure 
consists of lots of different member fields which are not ISA specific. These 
additional information describes SPT used for describing different EPT levels.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre></td><td class="rouge-code"><pre><span class="k">union</span> <span class="n">kvm_mmu_page_role</span> <span class="p">{</span>
        <span class="n">u32</span> <span class="n">word</span><span class="p">;</span>
        <span class="k">struct</span> <span class="p">{</span>
                <span class="kt">unsigned</span> <span class="n">level</span><span class="o">:</span><span class="mi">4</span><span class="p">;</span>
                <span class="kt">unsigned</span> <span class="n">gpte_is_8_bytes</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
                <span class="kt">unsigned</span> <span class="n">quadrant</span><span class="o">:</span><span class="mi">2</span><span class="p">;</span>
                <span class="kt">unsigned</span> <span class="n">direct</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
                <span class="kt">unsigned</span> <span class="n">access</span><span class="o">:</span><span class="mi">3</span><span class="p">;</span>
                <span class="kt">unsigned</span> <span class="n">invalid</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
                <span class="kt">unsigned</span> <span class="n">efer_nx</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
                <span class="kt">unsigned</span> <span class="n">cr0_wp</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
                <span class="kt">unsigned</span> <span class="n">smep_andnot_wp</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
                <span class="kt">unsigned</span> <span class="n">smap_andnot_wp</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
                <span class="kt">unsigned</span> <span class="n">ad_disabled</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
                <span class="kt">unsigned</span> <span class="n">guest_mode</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
                <span class="kt">unsigned</span> <span class="o">:</span><span class="mi">6</span><span class="p">;</span>

                <span class="cm">/*
                 * This is left at the top of the word so that
                 * kvm_memslots_for_spte_role can extract it with a
                 * simple shift.  While there is room, give it a whole
                 * byte so it is also faster to load it from memory.
                 */</span>
                <span class="kt">unsigned</span> <span class="n">smm</span><span class="o">:</span><span class="mi">8</span><span class="p">;</span>
        <span class="p">};</span>
<span class="p">};</span>
</pre></td></tr></tbody></table></code></div></div>
<p>kvm_mmu_page_role tracks the properties of a shadow page such as the level of 
page it belongs to.</p>

<h2 id="spt-initialization"><span class="me-2">SPT Initialization</span><a href="#spt-initialization" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<h3 id="spt-is-initialized-when-vcpu-first-enter-the-guest"><span class="me-2">SPT is initialized when VCPU first enter the guest</span><a href="#spt-is-initialized-when-vcpu-first-enter-the-guest" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre><span class="k">static</span> <span class="kt">int</span> <span class="nf">vcpu_enter_guest</span><span class="p">(</span><span class="k">struct</span> <span class="nc">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">......</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">kvm_mmu_reload</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">r</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">goto</span> <span class="n">cancel_injection</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">preempt_disable</span><span class="p">();</span>

        <span class="n">static_call</span><span class="p">(</span><span class="n">kvm_x86_prepare_guest_switch</span><span class="p">)(</span><span class="n">vcpu</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></div></div>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">kvm_mmu_reload</span><span class="p">(</span><span class="k">struct</span> <span class="nc">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>       
        <span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">mmu</span><span class="o">-&gt;</span><span class="n">root_hpa</span> <span class="o">!=</span> <span class="n">INVALID_PAGE</span><span class="p">))</span>
                <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

        <span class="k">return</span> <span class="n">kvm_mmu_load</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>kvm_mmu_reload function invokes kvm_mmu_load only when root_hpa was initialized 
as IVALID_PAGE, which means the SPT has not been actually initialized yet.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre></td><td class="rouge-code"><pre><span class="kt">int</span> <span class="nf">kvm_mmu_load</span><span class="p">(</span><span class="k">struct</span> <span class="nc">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

        <span class="n">r</span> <span class="o">=</span> <span class="n">mmu_topup_memory_caches</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="o">!</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">mmu</span><span class="o">-&gt;</span><span class="n">direct_map</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
                <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>       
        <span class="n">r</span> <span class="o">=</span> <span class="n">mmu_alloc_special_roots</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
                <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">mmu</span><span class="o">-&gt;</span><span class="n">direct_map</span><span class="p">)</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">mmu_alloc_direct_roots</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
        <span class="k">else</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">mmu_alloc_shadow_roots</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
                <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>    

        <span class="n">kvm_mmu_sync_roots</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
                                
        <span class="n">kvm_mmu_load_pgd</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
        <span class="n">static_call</span><span class="p">(</span><span class="n">kvm_x86_tlb_flush_current</span><span class="p">)(</span><span class="n">vcpu</span><span class="p">);</span>
<span class="nl">out:</span> 
        <span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>If MMU utilize the TDP, the <strong>direct_map</strong> field is initialized as true by the 
init_kvm_tdp_mmu function, and invokes mmu_alloc_direct_roots function.</p>

<h3 id="allocate-spt-root-page-table"><span class="me-2">Allocate SPT root page table</span><a href="#allocate-spt-root-page-table" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="k">static</span> <span class="kt">int</span> <span class="nf">mmu_alloc_direct_roots</span><span class="p">(</span><span class="k">struct</span> <span class="nc">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
<span class="mi">4059</span>         <span class="k">if</span> <span class="p">(</span><span class="n">is_tdp_mmu_enabled</span><span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">kvm</span><span class="p">))</span> <span class="p">{</span>
<span class="mi">4060</span>                 <span class="n">root</span> <span class="o">=</span> <span class="n">kvm_tdp_mmu_get_vcpu_root_hpa</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
<span class="mi">4061</span>                 <span class="n">mmu</span><span class="o">-&gt;</span><span class="n">root_hpa</span> <span class="o">=</span> <span class="n">root</span><span class="p">;</span>
<span class="mi">4062</span>         <span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">shadow_root_level</span> <span class="o">&gt;=</span> <span class="n">PT64_ROOT_4LEVEL</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">4063</span>                 <span class="k">if</span> <span class="p">(</span><span class="n">gfn_shared</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">VALID_PAGE</span><span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">mmu</span><span class="o">-&gt;</span><span class="n">private_root_hpa</span><span class="p">))</span> <span class="p">{</span>
<span class="mi">4064</span>                         <span class="n">root</span> <span class="o">=</span> <span class="n">mmu_alloc_root</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">shadow_root_level</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
<span class="mi">4065</span>                         <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">mmu</span><span class="o">-&gt;</span><span class="n">private_root_hpa</span> <span class="o">=</span> <span class="n">root</span><span class="p">;</span>
<span class="mi">4066</span>                 <span class="p">}</span>
<span class="mi">4067</span>                 <span class="n">root</span> <span class="o">=</span> <span class="n">mmu_alloc_root</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">gfn_shared</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">shadow_root_level</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
<span class="mi">4068</span>                 <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">mmu</span><span class="o">-&gt;</span><span class="n">root_hpa</span> <span class="o">=</span> <span class="n">root</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Note that root_hpa has been initialized as INVALID_PAGE, which makes the 
is_tdp_mmu_enabled function return false. Also we assume that current platform
supports 4 or 5 level page tables, so it will execute the first else if block. 
gfn_shared is the bit for distinguishing shared page table from private for 
Intel TDX. Because TDX requires two different page tables, one for shared and 
the other for private, it generates two page table through mmu_alloc_root. Note
that the generated root page is stored in different member fields of the mmu,
<strong>private_root_hpa and root_hpa</strong>. From now on, is_tdp_mmu_enabled will return 
true because all required fields are initialized.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="mi">4032</span> <span class="k">static</span> <span class="n">hpa_t</span> <span class="n">mmu_alloc_root</span><span class="p">(</span><span class="k">struct</span> <span class="nc">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">gfn_t</span> <span class="n">gfn</span><span class="p">,</span>
<span class="mi">4033</span>                             <span class="n">gfn_t</span> <span class="n">gfn_stolen_bits</span><span class="p">,</span> <span class="n">gva_t</span> <span class="n">gva</span><span class="p">,</span> <span class="n">u8</span> <span class="n">level</span><span class="p">,</span>
<span class="mi">4034</span>                             <span class="kt">bool</span> <span class="n">direct</span><span class="p">)</span>
<span class="mi">4035</span> <span class="p">{</span>
<span class="mi">4036</span>         <span class="k">struct</span> <span class="nc">kvm_mmu_page</span> <span class="o">*</span><span class="n">sp</span><span class="p">;</span>
<span class="mi">4037</span> 
<span class="mi">4038</span>         <span class="n">sp</span> <span class="o">=</span> <span class="n">__kvm_mmu_get_page</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">gfn</span><span class="p">,</span> <span class="n">gfn_stolen_bits</span><span class="p">,</span> <span class="n">gva</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">direct</span><span class="p">,</span>
<span class="mi">4039</span>                                 <span class="n">ACC_ALL</span><span class="p">);</span>
<span class="mi">4040</span>         <span class="o">++</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">root_count</span><span class="p">;</span>
<span class="mi">4041</span> 
<span class="mi">4042</span>         <span class="k">return</span> <span class="n">__pa</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">spt</span><span class="p">);</span>
<span class="mi">4043</span> <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Note that gfn field is set as zero. Also the root_count variable is increased,
which keep tracks of how many hardware registers (guest cr3 or pdptrs) are point
at this root page.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre><span class="mi">2475</span> <span class="k">static</span> <span class="k">struct</span> <span class="nc">kvm_mmu_page</span> <span class="o">*</span><span class="nf">__kvm_mmu_get_page</span><span class="p">(</span><span class="k">struct</span> <span class="nc">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span>
<span class="mi">2476</span>                                                <span class="n">gfn_t</span> <span class="n">gfn</span><span class="p">,</span>
<span class="mi">2477</span>                                                <span class="n">gfn_t</span> <span class="n">gfn_stolen_bits</span><span class="p">,</span>
<span class="mi">2478</span>                                                <span class="n">gva_t</span> <span class="n">gaddr</span><span class="p">,</span>
<span class="mi">2479</span>                                                <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">level</span><span class="p">,</span>
<span class="mi">2480</span>                                                <span class="kt">int</span> <span class="n">direct</span><span class="p">,</span>
<span class="mi">2481</span>                                                <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">access</span><span class="p">)</span>
<span class="mi">2482</span> <span class="p">{</span>
<span class="p">......</span>
<span class="mi">2559</span>         <span class="n">sp</span> <span class="o">=</span> <span class="n">kvm_mmu_alloc_page</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">direct</span><span class="p">,</span>
<span class="mi">2560</span>                                 <span class="n">is_private_gfn</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">gfn_stolen_bits</span><span class="p">));</span>
<span class="p">......</span>
<span class="mi">2577</span>         <span class="k">return</span> <span class="n">sp</span><span class="p">;</span>
<span class="mi">2578</span> <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="allocate-spt-page-table"><span class="me-2">Allocate SPT page table</span><a href="#allocate-spt-page-table" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>No matter what level it is, whether it is root or the lower level non-leaf SPTE,
the SPT table is a instance of kvm_mmu_page struct. Therefore, the 
kvm_mmu_alloc_page function generates new kvm_mmu_page object and sets up its 
member fields.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre></td><td class="rouge-code"><pre><span class="mi">2138</span> <span class="k">static</span> <span class="k">struct</span> <span class="nc">kvm_mmu_page</span> <span class="o">*</span><span class="n">kvm_mmu_alloc_page</span><span class="p">(</span><span class="k">struct</span> <span class="nc">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span>
<span class="mi">2139</span>                                                <span class="kt">int</span> <span class="n">direct</span><span class="p">,</span> <span class="kt">bool</span> <span class="k">private</span><span class="p">)</span>
<span class="mi">2140</span> <span class="p">{</span>
<span class="mi">2141</span>         <span class="k">struct</span> <span class="nc">kvm_mmu_page</span> <span class="o">*</span><span class="n">sp</span><span class="p">;</span>
<span class="mi">2142</span>         
<span class="mi">2143</span>         <span class="n">sp</span> <span class="o">=</span> <span class="n">kvm_mmu_memory_cache_alloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">mmu_page_header_cache</span><span class="p">);</span>
<span class="mi">2144</span>         <span class="n">sp</span><span class="o">-&gt;</span><span class="n">spt</span> <span class="o">=</span> <span class="n">kvm_mmu_memory_cache_alloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">mmu_shadow_page_cache</span><span class="p">);</span>
<span class="mi">2145</span>         <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">direct</span><span class="p">)</span> 
<span class="mi">2146</span>                 <span class="n">sp</span><span class="o">-&gt;</span><span class="n">gfns</span> <span class="o">=</span> <span class="n">kvm_mmu_memory_cache_alloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">mmu_gfn_array_cache</span><span class="p">);</span>
<span class="mi">2147</span>         <span class="n">set_page_private</span><span class="p">(</span><span class="n">virt_to_page</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">spt</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">sp</span><span class="p">);</span>
<span class="mi">2148</span>                         
<span class="mi">2149</span>         <span class="cm">/*
2150          * active_mmu_pages must be a FIFO list, as kvm_zap_obsolete_pages()
2151          * depends on valid pages being added to the head of the list.  See
2152          * comments in kvm_zap_obsolete_pages().
2153          */</span>
<span class="mi">2154</span>         <span class="n">sp</span><span class="o">-&gt;</span><span class="n">mmu_valid_gen</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">kvm</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">mmu_valid_gen</span><span class="p">;</span>
<span class="mi">2155</span>         <span class="k">if</span> <span class="p">(</span><span class="k">private</span><span class="p">)</span>
<span class="mi">2156</span>                 <span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">kvm</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">private_mmu_pages</span><span class="p">);</span>
<span class="mi">2157</span>         <span class="k">else</span>
<span class="mi">2158</span>                 <span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">kvm</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">active_mmu_pages</span><span class="p">);</span>
<span class="mi">2159</span>         <span class="n">kvm_mod_used_mmu_pages</span><span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">kvm</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">);</span>
<span class="mi">2160</span>         <span class="k">return</span> <span class="n">sp</span><span class="p">;</span>                           
<span class="mi">2161</span> <span class="p">}</span>   
</pre></td></tr></tbody></table></code></div></div>

<p>There are two important memory allocations, one for shadow page structure (sp),
and the other for shadow page table entries (sp-&gt;spt).</p>

<blockquote>
  <p>The page pointed to by spt will have its page-&gt;private pointing back at the 
shadow page structure</p>
</blockquote>

<p>After memories are allocated, the set_page_private macro makes the private field
of page(sp-&gt;spt) points to the shadow page structure, which is kvm_mmu_page *sp.
Therefore, when sp-&gt;spt can be accessible (as a result of EPT walking), the 
kvm_mmu_page pointing to that SPTE can be accessible through the private field.</p>

<p>Note that this is not relevant to shared/private concept of Intel TDX for SPT.
Also, the KVM maintains the list of SPT, kvm-&gt;arch.private_mmu_pages
and kvm-&gt;arch.active_mmu_pages for private and shared SPT. Based on the SPT type,
generated SPT will be stored in the different lists.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre></td><td class="rouge-code"><pre><span class="mi">2475</span> <span class="k">static</span> <span class="k">struct</span> <span class="nc">kvm_mmu_page</span> <span class="o">*</span><span class="n">__kvm_mmu_get_page</span><span class="p">(</span><span class="k">struct</span> <span class="nc">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span>      
<span class="mi">2476</span>                                                <span class="n">gfn_t</span> <span class="n">gfn</span><span class="p">,</span>                  
<span class="mi">2477</span>                                                <span class="n">gfn_t</span> <span class="n">gfn_stolen_bits</span><span class="p">,</span>      
<span class="mi">2478</span>                                                <span class="n">gva_t</span> <span class="n">gaddr</span><span class="p">,</span>                
<span class="mi">2479</span>                                                <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">level</span><span class="p">,</span>         
<span class="mi">2480</span>                                                <span class="kt">int</span> <span class="n">direct</span><span class="p">,</span>                 
<span class="mi">2481</span>                                                <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">access</span><span class="p">)</span>
<span class="p">......</span>
<span class="mi">2562</span>         <span class="n">sp</span><span class="o">-&gt;</span><span class="n">gfn</span> <span class="o">=</span> <span class="n">gfn</span><span class="p">;</span>                                                     
<span class="mi">2563</span>         <span class="n">sp</span><span class="o">-&gt;</span><span class="n">gfn_stolen_bits</span> <span class="o">=</span> <span class="n">gfn_stolen_bits</span><span class="p">;</span>                             
<span class="mi">2564</span>         <span class="n">sp</span><span class="o">-&gt;</span><span class="n">role</span> <span class="o">=</span> <span class="n">role</span><span class="p">;</span>                                                   
<span class="mi">2565</span>         <span class="nf">hlist_add_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">hash_link</span><span class="p">,</span> <span class="n">sp_list</span><span class="p">);</span>                           
<span class="mi">2566</span>         <span class="nf">if</span> <span class="p">(</span><span class="o">!</span><span class="n">direct</span><span class="p">)</span> <span class="p">{</span>                                                     
<span class="mi">2567</span>                 <span class="n">account_shadowed</span><span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">kvm</span><span class="p">,</span> <span class="n">sp</span><span class="p">);</span>                           
<span class="mi">2568</span>                 <span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">==</span> <span class="n">PG_LEVEL_4K</span> <span class="o">&amp;&amp;</span> <span class="n">rmap_write_protect</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">gfn</span><span class="p">))</span> 
<span class="mi">2569</span>                         <span class="n">kvm_flush_remote_tlbs_with_address</span><span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">kvm</span><span class="p">,</span> <span class="n">gfn</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="mi">2570</span>         <span class="p">}</span>                                                                  
<span class="mi">2571</span>         <span class="nf">trace_kvm_mmu_get_page</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>                                  
<span class="mi">2572</span> <span class="n">out</span><span class="o">:</span>                                                                       
<span class="mi">2573</span>         <span class="nf">kvm_mmu_commit_zap_page</span><span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">kvm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">invalid_list</span><span class="p">);</span>                 
<span class="mi">2574</span>                                                                            
<span class="mi">2575</span>         <span class="k">if</span> <span class="p">(</span><span class="n">collisions</span> <span class="o">&gt;</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">kvm</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">.</span><span class="n">max_mmu_page_hash_collisions</span><span class="p">)</span>     
<span class="mi">2576</span>                 <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">kvm</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">.</span><span class="n">max_mmu_page_hash_collisions</span> <span class="o">=</span> <span class="n">collisions</span><span class="p">;</span> 
<span class="mi">2577</span>         <span class="k">return</span> <span class="n">sp</span><span class="p">;</span>    
</pre></td></tr></tbody></table></code></div></div>
<p>The __kvm_mmu_get_page function initializes some member fields of the generated 
SPT, flush out some tlbs for synchronization, and return the generates spt. The
spt is returned further up to mmu_alloc_direct_roots function, and its physical 
address is stored to either root_hpa or private_root_hpa.</p>

<h3 id="vmcs-setting-for-spt"><span class="me-2">VMCS setting for SPT</span><a href="#vmcs-setting-for-spt" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">kvm_mmu_load_pgd</span><span class="p">(</span><span class="k">struct</span> <span class="nc">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>       
        <span class="n">u64</span> <span class="n">root_hpa</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">mmu</span><span class="o">-&gt;</span><span class="n">root_hpa</span><span class="p">;</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">VALID_PAGE</span><span class="p">(</span><span class="n">root_hpa</span><span class="p">))</span>
                <span class="k">return</span><span class="p">;</span>

        <span class="n">static_call</span><span class="p">(</span><span class="n">kvm_x86_load_mmu_pgd</span><span class="p">)(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">root_hpa</span><span class="p">,</span>
                                          <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">mmu</span><span class="o">-&gt;</span><span class="n">shadow_root_level</span><span class="p">);</span>
<span class="p">}</span>    
</pre></td></tr></tbody></table></code></div></div>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="k">static</span> <span class="kt">void</span> <span class="nf">vt_load_mmu_pgd</span><span class="p">(</span><span class="k">struct</span> <span class="nc">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">hpa_t</span> <span class="n">root_hpa</span><span class="p">,</span>
                            <span class="kt">int</span> <span class="n">pgd_level</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">is_td_vcpu</span><span class="p">(</span><span class="n">vcpu</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">tdx_load_mmu_pgd</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">root_hpa</span><span class="p">,</span> <span class="n">pgd_level</span><span class="p">);</span>

        <span class="n">vmx_load_mmu_pgd</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">root_hpa</span><span class="p">,</span> <span class="n">pgd_level</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre></td><td class="rouge-code"><pre><span class="k">static</span> <span class="kt">void</span> <span class="nf">vmx_load_mmu_pgd</span><span class="p">(</span><span class="k">struct</span> <span class="nc">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">hpa_t</span> <span class="n">root_hpa</span><span class="p">,</span>
                             <span class="kt">int</span> <span class="n">root_level</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">struct</span> <span class="nc">kvm</span> <span class="o">*</span><span class="n">kvm</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">kvm</span><span class="p">;</span>
        <span class="kt">bool</span> <span class="n">update_guest_cr3</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">guest_cr3</span><span class="p">;</span>
        <span class="n">u64</span> <span class="n">eptp</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">enable_ept</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">eptp</span> <span class="o">=</span> <span class="n">construct_eptp</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">root_hpa</span><span class="p">,</span> <span class="n">root_level</span><span class="p">);</span>
                <span class="n">vmcs_write64</span><span class="p">(</span><span class="n">EPT_POINTER</span><span class="p">,</span> <span class="n">eptp</span><span class="p">);</span>

                <span class="n">hv_track_root_tdp</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">root_hpa</span><span class="p">);</span>

                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">enable_unrestricted_guest</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">is_paging</span><span class="p">(</span><span class="n">vcpu</span><span class="p">))</span>
                        <span class="n">guest_cr3</span> <span class="o">=</span> <span class="n">to_kvm_vmx</span><span class="p">(</span><span class="n">kvm</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ept_identity_map_addr</span><span class="p">;</span>
                <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">VCPU_EXREG_CR3</span><span class="p">,</span> <span class="p">(</span><span class="n">ulong</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">regs_avail</span><span class="p">))</span>
                        <span class="n">guest_cr3</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">cr3</span><span class="p">;</span>
                <span class="k">else</span> <span class="cm">/* vmcs01.GUEST_CR3 is already up-to-date. */</span>
                        <span class="n">update_guest_cr3</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
                <span class="n">vmx_ept_load_pdptrs</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">guest_cr3</span> <span class="o">=</span> <span class="n">root_hpa</span> <span class="o">|</span> <span class="n">kvm_get_active_pcid</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">update_guest_cr3</span><span class="p">)</span>
                <span class="n">vmcs_writel</span><span class="p">(</span><span class="n">GUEST_CR3</span><span class="p">,</span> <span class="n">guest_cr3</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Through vmcx_write64 macro, it writes eptp pointer (spt root) to the EPTP field
of the VMCS structure associated with current VCPU. However, still the only root
SPT address has been set, and the content has not been filled out, which means 
the running VM will generates fault.</p>

<h2 id="hva-and-memslot"><span class="me-2">HVA and memslot</span><a href="#hva-and-memslot" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<p>Another important concept related with KVM and its memory management is HVA and
memslot which can be considered as a one level page table mapping <strong>GPA to HVA.</strong></p>

<blockquote>
  <p>Guest memory (gpa) is part of the user address space of the process that is
using kvm.  Userspace defines the translation between guest addresses and user
addresses (gpa-&gt;hva); note that two gpas may alias to the same hva, but not
vice versa.
These hvas may be backed using any method available to the host: anonymous
memory, file backed memory, and device memory.  Memory might be paged by the
host at any time.</p>
</blockquote>

<p>As described in the KVM MMU documentation, the VM instance utilize the memory 
provided by the user process that is using KVM. Therefore, the memory KVM gets 
are part of the donor’s user address space. However, the EPT page table 
translates the GPA to HPA not GPA to HVA. Therefore, the KVM should require 
correct mapping for EPT page tables based on GPA -&gt; HVA translation. For example,
when VMEXIT happens because the GPA is not mapped to any HPA (EPT violation),
then KVM walks the page table of the user process that is using KVM to retrieve
the HPA associated with HVA that is used for mapping GPA. After the page walks,
it sets up EPT page tables so that the GPA can be directly mapped to correct 
HPA which is mapped to GVA.</p>

<p>Therefore, the synchronization between EPT and user process table on host side 
is very important. To keep the synchronization, if previous HVA-&gt;HPA mapping
changes and remapped to another HPA, then <strong>KVM will get notified by the host 
kernel</strong> that the HVA has been unmapped. KVM will find and unmap the 
corresponding GPA (again via memslots) to HPA translations and modifies EPT to 
map GPA to new HPA remapped to HVA.</p>

<blockquote>
  <p>If there is no memslot, KVM will exit to userspace on the EPT violation,
with some information about what GPA the guest was accessing.  This is how
emulated MMIO is implemented, e.g. userspace intentionally doesn’t back a
GPA with a memslot so that it can trap guest accesses to said GPA for the
purpose of emulating a device.
https://lists.gnu.org/archive/html/qemu-devel/2020-10/msg03532.html</p>
</blockquote>

<h3 id="memslot-data-structures"><span class="me-2">Memslot data structures</span><a href="#memslot-data-structures" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="k">struct</span> <span class="nc">kvm_memslots</span> <span class="p">{</span>
        <span class="n">u64</span> <span class="n">generation</span><span class="p">;</span>
        <span class="cm">/* The mapping table from slot id to the index in memslots[]. */</span>
        <span class="kt">short</span> <span class="n">id_to_index</span><span class="p">[</span><span class="n">KVM_MEM_SLOTS_NUM</span><span class="p">];</span>
        <span class="n">atomic_t</span> <span class="n">last_used_slot</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">used_slots</span><span class="p">;</span>
        <span class="k">struct</span> <span class="nc">kvm_memory_slot</span> <span class="n">memslots</span><span class="p">[];</span>
<span class="p">};</span>
</pre></td></tr></tbody></table></code></div></div>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre><span class="k">struct</span> <span class="nc">kvm_memory_slot</span> <span class="p">{</span>
        <span class="k">struct</span> <span class="nc">hlist_node</span> <span class="n">id_node</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
        <span class="k">struct</span> <span class="nc">interval_tree_node</span> <span class="n">hva_node</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
        <span class="k">struct</span> <span class="nc">rb_node</span> <span class="n">gfn_node</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
        <span class="n">gfn_t</span> <span class="n">base_gfn</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">npages</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">dirty_bitmap</span><span class="p">;</span>
        <span class="k">struct</span> <span class="nc">kvm_arch_memory_slot</span> <span class="n">arch</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">userspace_addr</span><span class="p">;</span>
        <span class="n">u32</span> <span class="n">flags</span><span class="p">;</span>
        <span class="kt">short</span> <span class="n">id</span><span class="p">;</span>
        <span class="n">u16</span> <span class="n">as_id</span><span class="p">;</span>
        <span class="k">struct</span> <span class="nc">file</span> <span class="o">*</span><span class="n">private_file</span><span class="p">;</span>
        <span class="n">loff_t</span> <span class="n">private_offset</span><span class="p">;</span>
        <span class="k">struct</span> <span class="nc">memfile_notifier</span> <span class="n">notifier</span><span class="p">;</span>
        <span class="k">struct</span> <span class="nc">kvm</span> <span class="o">*</span><span class="n">kvm</span><span class="p">;</span>
<span class="p">};</span>
</pre></td></tr></tbody></table></code></div></div>


  </div>

  <div class="post-tail-wrapper text-muted">
    <!-- categories -->
    
      <div class="post-meta mb-3">
        <i class="far fa-folder-open fa-fw me-1"></i>
        
          <a href="/categories/confidential-computing/">Confidential Computing</a>,
          <a href="/categories/intel-tdx/">Intel TDX</a>,
          <a href="/categories/kvm/">KVM</a>,
          <a href="/categories/qemu/">QEMU</a>
      </div>
    

    <!-- tags -->
    

    <div
      class="
        post-tail-bottom
        d-flex justify-content-between align-items-center mt-5 pb-2
      "
    >
      <div class="license-wrapper">
        
          

          This post is licensed under 
        <a href="https://creativecommons.org/licenses/by/4.0/">
          CC BY 4.0
        </a>
         by the author.
        
      </div>

      <!-- Post sharing snippet -->

<div class="share-wrapper d-flex align-items-center">
  <span class="share-label text-muted">Share</span>
  <span class="share-icons">
    
    
    

    

      

      <a
        href="https://twitter.com/intent/tweet?text=Shadow%20Page%20Table%20(SPT)%20and%20MEMSLOT%20-%20Ruach&url=https%3A%2F%2Fruach.github.io%2Fposts%2FSPT-AND-MEMSLOT%2F"
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Twitter"
        target="_blank"
        rel="noopener"
        aria-label="Twitter"
      >
        <i class="fa-fw fa-brands fa-square-x-twitter"></i>
      </a>
    

      

      <a
        href="https://www.facebook.com/sharer/sharer.php?title=Shadow%20Page%20Table%20(SPT)%20and%20MEMSLOT%20-%20Ruach&u=https%3A%2F%2Fruach.github.io%2Fposts%2FSPT-AND-MEMSLOT%2F"
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Facebook"
        target="_blank"
        rel="noopener"
        aria-label="Facebook"
      >
        <i class="fa-fw fab fa-facebook-square"></i>
      </a>
    

      

      <a
        href="https://t.me/share/url?url=https%3A%2F%2Fruach.github.io%2Fposts%2FSPT-AND-MEMSLOT%2F&text=Shadow%20Page%20Table%20(SPT)%20and%20MEMSLOT%20-%20Ruach"
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Telegram"
        target="_blank"
        rel="noopener"
        aria-label="Telegram"
      >
        <i class="fa-fw fab fa-telegram"></i>
      </a>
    

      

      <a
        href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fruach.github.io%2Fposts%2FSPT-AND-MEMSLOT%2F"
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Linkedin"
        target="_blank"
        rel="noopener"
        aria-label="Linkedin"
      >
        <i class="fa-fw fab fa-linkedin"></i>
      </a>
    

    <button
      id="copy-link"
      aria-label="Copy link"
      class="btn small"
      data-bs-toggle="tooltip"
      data-bs-placement="top"
      title="Copy link"
      data-title-succeed="Link copied successfully!"
    >
      <i class="fa-fw fas fa-link pe-none fs-6"></i>
    </button>
  </span>
</div>

    </div>
    <!-- .post-tail-bottom -->
  </div>
  <!-- div.post-tail-wrapper -->
</article>


            
          </main>

          <!-- panel -->
          <aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 mb-5 text-muted">
            <div class="access">
              <!-- Get the last 5 posts from lastmod list. -->















              <!-- The trending tags list -->


















            </div>

            
              
              



  <section id="toc-wrapper" class="ps-0 pe-4">
    <h2 class="panel-heading ps-3 pt-2 mb-2">Contents</h2>
    <nav id="toc"></nav>
  </section>


            
          </aside>
        </div>

        <div class="row">
          <!-- tail -->
          <div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4">
            
              
              <!-- Recommend the other 3 posts according to the tags and categories of the current post. -->

<!-- The total size of related posts -->


<!-- An random integer that bigger than 0 -->


<!-- Equals to TAG_SCORE / {max_categories_hierarchy} -->














  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  
    
  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  











  <aside id="related-posts" aria-labelledby="related-label">
    <h3 class="mb-4" id="related-label">Further Reading</h3>
    <nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4">
      
        <article class="col">
          <a href="/posts/TDX-MODULE-LIFECYCLE-2/" class="post-preview card h-100">
            <div class="card-body">
              <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1679544000"
  data-df="ll"
  
>
  Mar 23, 2023
</time>

              <h4 class="pt-0 my-2">TDX Module Life Cycle Part 2</h4>
              <div class="text-muted">
                <p>
                  





                  In previous posts, I discussed the initialization of the TDX module using 
TDH_SYS_INIT SEAMCALL. As depicted in the image below, several additional 
configuration steps are necessary for the TDX m...
                </p>
              </div>
            </div>
          </a>
        </article>
      
        <article class="col">
          <a href="/posts/QEMU-KVM-ADDRESS-SPACE/" class="post-preview card h-100">
            <div class="card-body">
              <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1681185600"
  data-df="ll"
  
>
  Apr 11, 2023
</time>

              <h4 class="pt-0 my-2">QEMU Side Memory Management for VM with RAMBLOCK</h4>
              <div class="text-muted">
                <p>
                  





                  QEMU side memory management

  The MemoryRegion is the link between guest physical address space and the 
RAMBlocks containing the memory. Each MemoryRegion has the ram_addr_t offset 
of the RAMBlo...
                </p>
              </div>
            </div>
          </a>
        </article>
      
        <article class="col">
          <a href="/posts/PAGEFAULT-HANDLING-KVM-TDX/" class="post-preview card h-100">
            <div class="card-body">
              <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1681531200"
  data-df="ll"
  
>
  Apr 15, 2023
</time>

              <h4 class="pt-0 my-2">KVM page-fault handling for TDX</h4>
              <div class="text-muted">
                <p>
                  





                  Basic idea to implement private page

  Because shared EPT is the same as the existing EPT, use the existing logic for
shared EPT.  On the other hand, secure EPT requires additional operations
inst...
                </p>
              </div>
            </div>
          </a>
        </article>
      
    </nav>
  </aside>
  <!-- #related-posts -->


            
              
              <!-- Navigation buttons at the bottom of the post. -->

<nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation">
  
  

  
    <a
      href="/posts/TD-VM-LIFECYCLE-3/"
      class="btn btn-outline-primary"
      aria-label="Older"
    >
      <p>TD VM Life Cycle Part 3</p>
    </a>
  

  
    <a
      href="/posts/QEMU-KVM-ADDRESS-SPACE/"
      class="btn btn-outline-primary"
      aria-label="Newer"
    >
      <p>QEMU Side Memory Management for VM with RAMBLOCK</p>
    </a>
  
</nav>

            
              
              <!--  The comments switcher -->

  
  <!-- The Disqus lazy loading. -->

<div id="disqus_thread">
  <p class="text-center text-muted small">Comments powered by <a href="https://disqus.com/">Disqus</a>.</p>
</div>

<script type="text/javascript">
  var disqus_config = function () {
    this.page.url = 'https://ruach.github.io/posts/SPT-AND-MEMSLOT/';
    this.page.identifier = '/posts/SPT-AND-MEMSLOT/';
  };

  /* Lazy loading */
  var disqus_observer = new IntersectionObserver(
    function (entries) {
      if (entries[0].isIntersecting) {
        (function () {
          var d = document,
            s = d.createElement('script');
          s.src = 'https://ruach.disqus.com/embed.js';
          s.setAttribute('data-timestamp', +new Date());
          (d.head || d.body).appendChild(s);
        })();

        disqus_observer.disconnect();
      }
    },
    { threshold: [0] }
  );

  disqus_observer.observe(document.querySelector('#disqus_thread'));

  /* Auto switch theme */
  function reloadDisqus() {
    if (event.source === window && event.data && event.data.direction === ModeToggle.ID) {
      /* Disqus hasn't been loaded */
      if (typeof DISQUS === 'undefined') {
        return;
      }

      if (document.readyState == 'complete') {
        DISQUS.reset({ reload: true, config: disqus_config });
      }
    }
  }

  if (document.querySelector('.mode-toggle')) {
    window.addEventListener('message', reloadDisqus);
  }
</script>



            

            <!-- The Footer -->

<footer
  aria-label="Site Info"
  class="
    d-flex flex-column justify-content-center text-muted
    flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3
  "
>
  <p>
    ©
    <time>2024</time>
    <a href="https://ruach.github.io">Jaehyuk Lee</a>.
    
      <span
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author."
      >Some rights reserved.</span>
    
  </p>

  <p>Using the <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme for <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>
  </p>
</footer>

          </div>
        </div>

        <!-- The Search results -->

<div id="search-result-wrapper" class="d-flex justify-content-center unloaded">
  <div class="col-11 content">
    <div id="search-hints">
      <!-- The trending tags list -->


















    </div>
    <div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div>
  </div>
</div>

      </div>

      <aside aria-label="Scroll to Top">
        <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow">
          <i class="fas fa-angle-up"></i>
        </button>
      </aside>
    </div>

    <div id="mask"></div>

    
      <aside
  id="notification"
  class="toast"
  role="alert"
  aria-live="assertive"
  aria-atomic="true"
  data-bs-animation="true"
  data-bs-autohide="false"
>
  <div class="toast-header">
    <button
      type="button"
      class="btn-close ms-auto"
      data-bs-dismiss="toast"
      aria-label="Close"
    ></button>
  </div>
  <div class="toast-body text-center pt-0">
    <p class="px-2 mb-3">A new version of content is available.</p>
    <button type="button" class="btn btn-primary" aria-label="Update">
      Update
    </button>
  </div>
</aside>

    

    <!-- JavaScripts -->

    <!-- JS selector for site. -->

<!-- commons -->



<!-- layout specified -->


  

  
    <!-- image lazy-loading & popup & clipboard -->
    
  















  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  



  <script src="https://cdn.jsdelivr.net/combine/npm/jquery@3.7.1/dist/jquery.min.js,npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js,npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/magnific-popup@1.1.0/dist/jquery.magnific-popup.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.10/dayjs.min.js,npm/dayjs@1.11.10/locale/en.min.js,npm/dayjs@1.11.10/plugin/relativeTime.min.js,npm/dayjs@1.11.10/plugin/localizedFormat.min.js,npm/tocbot@4.21.2/dist/tocbot.min.js"></script>






<script defer src="/assets/js/dist/post.min.js"></script>






    

    <!--
  Jekyll Simple Search loader
  See: <https://github.com/christian-fei/Simple-Jekyll-Search>
-->





<script>
  /* Note: dependent library will be loaded in `js-selector.html` */
  SimpleJekyllSearch({
    searchInput: document.getElementById('search-input'),
    resultsContainer: document.getElementById('search-results'),
    json: '/assets/js/data/search.json',
    searchResultTemplate: '  <article class="px-1 px-sm-2 px-lg-4 px-xl-0">    <header>      <h2><a href="{url}">{title}</a></h2>      <div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1">        {categories}        {tags}      </div>    </header>    <p>{snippet}</p>  </article>',
    noResultsText: '<p class="mt-5"></p>',
    templateMiddleware: function(prop, value, template) {
      if (prop === 'categories') {
        if (value === '') {
          return `${value}`;
        } else {
          return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`;
        }
      }

      if (prop === 'tags') {
        if (value === '') {
          return `${value}`;
        } else {
          return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`;
        }
      }
    }
  });
</script>

  </body>
</html>

