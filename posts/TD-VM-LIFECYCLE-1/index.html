<!doctype html>














<!-- `site.alt_lang` can specify a language different from the UI -->
<html lang="en" data-mode="light">
  <!-- The Head -->

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta
    name="viewport"
    content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover"
  >

  

  

  
    <!-- Begin Jekyll SEO tag v2.8.0 -->
<meta name="generator" content="Jekyll v4.3.3" />
<meta property="og:title" content="TD VM Life Cycle Part 1" />
<meta property="og:locale" content="en" />
<meta name="description" content="Deep dive into TD-VM creation (TDH_MNG_CREATE SEAMCALL-TDH_MNG_INIT)" />
<meta property="og:description" content="Deep dive into TD-VM creation (TDH_MNG_CREATE SEAMCALL-TDH_MNG_INIT)" />
<link rel="canonical" href="https://ruach.github.io/posts/TD-VM-LIFECYCLE-1/" />
<meta property="og:url" content="https://ruach.github.io/posts/TD-VM-LIFECYCLE-1/" />
<meta property="og:site_name" content="Ruach" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2023-04-01T00:00:00-04:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="TD VM Life Cycle Part 1" />
<meta name="twitter:site" content="@ruach_lee" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2023-04-01T00:00:00-04:00","datePublished":"2023-04-01T00:00:00-04:00","description":"Deep dive into TD-VM creation (TDH_MNG_CREATE SEAMCALL-TDH_MNG_INIT)","headline":"TD VM Life Cycle Part 1","mainEntityOfPage":{"@type":"WebPage","@id":"https://ruach.github.io/posts/TD-VM-LIFECYCLE-1/"},"url":"https://ruach.github.io/posts/TD-VM-LIFECYCLE-1/"}</script>
<!-- End Jekyll SEO tag -->

  

  <title>TD VM Life Cycle Part 1 | Ruach
  </title>

  <!--
  The Favicons for Web, Android, Microsoft, and iOS (iPhone and iPad) Apps
  Generated by: https://realfavicongenerator.net/
-->



<link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png">
<link rel="manifest" href="/assets/img/favicons/site.webmanifest">
<link rel="shortcut icon" href="/assets/img/favicons/favicon.ico">
<meta name="apple-mobile-web-app-title" content="Ruach">
<meta name="application-name" content="Ruach">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml">
<meta name="theme-color" content="#ffffff">


  
    
      <link rel="preconnect" href="https://fonts.googleapis.com" >
      <link rel="dns-prefetch" href="https://fonts.googleapis.com" >
    
      <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      <link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin>
    
      <link rel="preconnect" href="https://fonts.googleapis.com" >
      <link rel="dns-prefetch" href="https://fonts.googleapis.com" >
    
      <link rel="preconnect" href="https://cdn.jsdelivr.net" >
      <link rel="dns-prefetch" href="https://cdn.jsdelivr.net" >
    

    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap">
  

  <!-- GA -->
  

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.2/css/all.min.css">

  <link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css">

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.21.2/dist/tocbot.min.css">
  

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css">
  

  
    <!-- Manific Popup -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css">
  

  <!-- JavaScript -->

  

  <!-- A placeholder to allow defining custom metadata -->

</head>


  <body>
    <!-- The Side Bar -->

<aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end">
  <header class="profile-wrapper">
    <a href="/" id="avatar" class="rounded-circle">
      
        
        <img src="/assets/img/jaehyuk.png" width="112" height="112" alt="avatar" onerror="this.style.display='none'">
      
    </a>

    <h1 class="site-title">
      <a href="/">Ruach</a>
    </h1>
    <p class="site-subtitle fst-italic mb-0">Jaehyuk Lee</p>
  </header>
  <!-- .profile-wrapper -->

  <nav class="flex-column flex-grow-1 w-100 ps-0">
    <ul class="nav">
      <!-- home -->
      <li class="nav-item">
        <a href="/" class="nav-link">
          <i class="fa-fw fas fa-home"></i>
          <span>HOME</span>
        </a>
      </li>
      <!-- the real tabs -->
      
        <li class="nav-item">
          <a href="/categories/" class="nav-link">
            <i class="fa-fw fas fa-stream"></i>
            

            <span>CATEGORIES</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/archives/" class="nav-link">
            <i class="fa-fw fas fa-archive"></i>
            

            <span>ARCHIVES</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/about/" class="nav-link">
            <i class="fa-fw fas fa-info-circle"></i>
            

            <span>ABOUT</span>
          </a>
        </li>
        <!-- .nav-item -->
      
    </ul>
  </nav>

  <div class="sidebar-bottom d-flex flex-wrap  align-items-center w-100">
    

    
      

      
        <a
          href="javascript:location.href = 'mailto:' + ['jaehyuk','gatech.edu'].join('@')"
          aria-label="email"
          

          

          

          
        >
          <i class="fas fa-envelope"></i>
        </a>
      
    
      

      
        <a
          href="https://www.linkedin.com/in/jaehyuk-lee-29b33b121/"
          aria-label="linkedin"
          

          
            target="_blank"
            
          

          

          
            rel="noopener noreferrer"
          
        >
          <i class="fab fa-linkedin"></i>
        </a>
      
    
      

      
        <a
          href="https://github.com/Ruach"
          aria-label="github"
          

          
            target="_blank"
            
          

          

          
            rel="noopener noreferrer"
          
        >
          <i class="fab fa-github"></i>
        </a>
      
    
      

      
        <a
          href="https://stackoverflow.com/users/4460514/ruach?tab=profile"
          aria-label="stack-overflow"
          

          
            target="_blank"
            
          

          

          
            rel="noopener noreferrer"
          
        >
          <i class="fab fa-stack-overflow"></i>
        </a>
      
    
  </div>
  <!-- .sidebar-bottom -->
</aside>
<!-- #sidebar -->


    <div id="main-wrapper" class="d-flex justify-content-center">
      <div class="container d-flex flex-column px-xxl-5">
        <!-- The Top Bar -->

<header id="topbar-wrapper" aria-label="Top Bar">
  <div
    id="topbar"
    class="d-flex align-items-center justify-content-between px-lg-3 h-100"
  >
    <nav id="breadcrumb" aria-label="Breadcrumb">
      

      
        
          
            <span>
              <a href="/">
                Home
              </a>
            </span>

          
        
          
        
          
            
              <span>TD VM Life Cycle Part 1</span>
            

          
        
      
    </nav>
    <!-- endof #breadcrumb -->

    <button type="button" id="sidebar-trigger" class="btn btn-link">
      <i class="fas fa-bars fa-fw"></i>
    </button>

    <div id="topbar-title">
      Post
    </div>

    <button type="button" id="search-trigger" class="btn btn-link">
      <i class="fas fa-search fa-fw"></i>
    </button>

    <search class="align-items-center ms-3 ms-lg-0">
      <i class="fas fa-search fa-fw"></i>
      <input
        class="form-control"
        id="search-input"
        type="search"
        aria-label="search"
        autocomplete="off"
        placeholder="Search..."
      >
    </search>
    <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button>
  </div>
</header>


        <div class="row flex-grow-1">
          <main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4">
            
              <!-- Refactor the HTML structure -->



<!--
  In order to allow a wide table to scroll horizontally,
  we suround the markdown table with `<div class="table-wrapper">` and `</div>`
-->



<!--
  Fixed kramdown code highlight rendering:
  https://github.com/penibelst/jekyll-compress-html/issues/101
  https://github.com/penibelst/jekyll-compress-html/issues/71#issuecomment-188144901
-->



<!-- Change the icon of checkbox -->



<!-- Handle images -->




  
  

  <!-- CDN URL -->
  

  <!-- Add image path -->
  

  
    
      
      
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      <!-- do not add shimmer by default -->
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  

  


<!-- Add header for code snippets -->



<!-- Create heading anchors -->





  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    

    
  

  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    

    
  

  
  

  

  
  

  




<!-- return -->




<article class="px-1">
  <header>
    <h1 data-toc-skip>TD VM Life Cycle Part 1</h1>

    <div class="post-meta text-muted">
      <!-- published date -->
      <span>
        Posted
        <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1680321600"
  data-df="ll"
  
    data-bs-toggle="tooltip" data-bs-placement="bottom"
  
>
  Apr  1, 2023
</time>

      </span>

      <!-- lastmod date -->
      

      

      <div class="d-flex justify-content-between">
        <!-- author(s) -->
        <span>
          

          By

          <em>
            
              <a href="https://ruach.github.io">Jaehyuk Lee</a>
            
          </em>
        </span>

        <!-- read time -->
        <!-- Calculate the post's reading time, and display the word count in tooltip -->



<!-- words per minute -->










<!-- return element -->
<span
  class="readtime"
  data-bs-toggle="tooltip"
  data-bs-placement="bottom"
  title="3307 words"
>
  <em>18 min</em> read</span>

      </div>
      <!-- .d-flex -->
    </div>
    <!-- .post-meta -->
  </header>

  <div class="content">
    <h1 id="deep-dive-into-td-vm-creation-tdh_mng_create-seamcall-tdh_mng_init">Deep dive into TD-VM creation (TDH_MNG_CREATE SEAMCALL-TDH_MNG_INIT)</h1>
<p><a href="/assets/img/TDX/TD_VM_INIT.png" class="popup img-link "><img src="/assets/img/TDX/TD_VM_INIT.png" alt="TDX Init" loading="lazy"></a></p>

<p>This article will follow the steps described in this figure. It is good to check
this figure when you want to check which part of the TD VM creation you are
dealing with. Before we delve into the details, lets first check new data 
structures required to generate and initialize the TD VM: <strong>TDR, TDCS</strong>.</p>

<h3 id="trust-domain-root-tdr"><span class="me-2">Trust Domain Root (TDR)</span><a href="#trust-domain-root-tdr" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<blockquote>
  <p>TDR is the root control structure of a guest TD. As designed, TDR is encrypted 
using the Intel TDX global private HKID. It holds a minimal set of state 
variables that enable guest TD control even during times when the TD’s private
HKID is not known, or when the TD’s key management state does not permit access
to memory encrypted using the TD’s private key. It is designed to be the first
TD page to be allocated and the last to be removed. Its physical address serves
as a <strong><em>unique identifier</em></strong> of the TD, as long as any TD page or control 
structure resides in memory</p>
</blockquote>

<p>The host VMM creates a new guest TD by TDH.MNG.CREATE SEAMCALL which initialize 
a TD Root(TDR) control structure. TDR is the memory page that can distinguish 
one TD VM from the others. Also, it is the most important page in TD VM creation 
because it is creating identity of TD VM instance.</p>

<h3 id="trust-domain-control-structure-tdcs"><span class="me-2">Trust Domain Control Structure (TDCS)</span><a href="#trust-domain-control-structure-tdcs" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>[[https://github.gatech.edu/sslab/tdx/blob/main/img/TD_CONTROL_STRUCTURE.png]]</p>
<blockquote>
  <p>TDCS is the main control structure of a guest TD. As designed, TDCS is 
encrypted using the guest TD’s ephemeral private key. TDCS is a multi-page 
logical structure composed of multiple TDCX physical pages. At a high level, 
TDCS holds the following information:</p>
  <ul>
    <li>EPTP: a pointer (HPA) to the TD’s <strong>secure EPT root page</strong> and EPT attributes.</li>
    <li>Fields related to TD <strong>measurement.</strong></li>
    <li>MSR bitmaps: limiting capabilities of all TD’s VCPUs.</li>
    <li>Fields controlling the TD operation as a whole (e.g., the number of VCPUs 
 currently running).</li>
    <li>Fields controlling the TD’s execution control (CPU features available to the 
 TD, etc.).</li>
    <li>A page filled with zeros: used in cases where the Intel TDX module needs a 
 read-only constant-0 page encrypted with the TD’s private key.</li>
  </ul>
</blockquote>

<p>Also, each TD VM requires the HKID to tag memory accesses and encrypt/decrypt 
private memory of the TD. Recall that the key should be within the private key 
range to not be exposed to the host VMM (refer to XXX)</p>

<h2 id="create-td-vm-kvm_create_vm-qemu---tdh_mng_create-tdx-module"><span class="me-2">Create TD VM (KVM_CREATE_VM (QEMU) -&gt; TDH_MNG_CREATE (TDX Module)</span><a href="#create-td-vm-kvm_create_vm-qemu---tdh_mng_create-tdx-module" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre><span class="k">static</span> <span class="k">struct</span> <span class="nc">kvm_x86_ops</span> <span class="n">vt_x86_ops</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">......</span>
        <span class="p">.</span><span class="n">vm_init</span> <span class="o">=</span> <span class="n">vt_vm_init</span><span class="p">,</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">kvm_arch_init_vm</span><span class="p">(</span><span class="k">struct</span> <span class="nc">kvm</span> <span class="o">*</span><span class="n">kvm</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">static_call</span><span class="p">(</span><span class="n">kvm_x86_is_vm_type_supported</span><span class="p">)(</span><span class="n">type</span><span class="p">))</span>
                <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
        <span class="p">......</span>
        <span class="k">return</span> <span class="n">static_call</span><span class="p">(</span><span class="n">kvm_x86_vm_init</span><span class="p">)(</span><span class="n">kvm</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>As part of the kvm_create_vm, the main function of creating all guest VM, the
kvm_arch_init_vm function is invoked to initiate generated KVM structure. This 
further invokes <strong>vt_vm_init</strong> assigned as vm_init operation of kvm_x86_ops.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre> <span class="mi">123</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">vt_vm_init</span><span class="p">(</span><span class="k">struct</span> <span class="nc">kvm</span> <span class="o">*</span><span class="n">kvm</span><span class="p">)</span>
 <span class="mi">124</span> <span class="p">{</span>
 <span class="mi">125</span>         <span class="k">if</span> <span class="p">(</span><span class="n">kvm</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">vm_type</span> <span class="o">==</span> <span class="n">KVM_X86_TDX_VM</span><span class="p">)</span>
 <span class="mi">126</span>                 <span class="k">return</span> <span class="n">tdx_vm_init</span><span class="p">(</span><span class="n">kvm</span><span class="p">);</span>
 <span class="mi">127</span> 
 <span class="mi">128</span>         <span class="k">return</span> <span class="nf">vmx_vm_init</span><span class="p">(</span><span class="n">kvm</span><span class="p">);</span>
 <span class="mi">129</span> <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>
<p>Based on the VM type, whether it is TD VM or vanilla VM, it invokes different 
initialization functions. Before the TD VM initialization through SEAMCALL 
(KVM_TDX_INIT_VM), KVM needs to prepare TDR and TDCS structures to instantiate
and initialize the TD.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre></td><td class="rouge-code"><pre><span class="k">static</span> <span class="kt">int</span> <span class="nf">tdx_vm_init</span><span class="p">(</span><span class="k">struct</span> <span class="nc">kvm</span> <span class="o">*</span><span class="n">kvm</span><span class="p">)</span>                                         
<span class="p">{</span>             
        <span class="cm">/* TODO: test 1GB support and remove tdp_max_page_level */</span>
        <span class="n">kvm</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">tdp_max_page_level</span> <span class="o">=</span> <span class="n">PG_LEVEL_2M</span><span class="p">;</span>

        <span class="cm">/* vCPUs can't be created until after KVM_TDX_INIT_VM. */</span>
        <span class="n">kvm</span><span class="o">-&gt;</span><span class="n">max_vcpus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> 

        <span class="n">kvm_tdx</span><span class="o">-&gt;</span><span class="n">hkid</span> <span class="o">=</span> <span class="n">tdx_keyid_alloc</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">kvm_tdx</span><span class="o">-&gt;</span><span class="n">hkid</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> 
                <span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
       <span class="n">kvm_tdx</span><span class="o">-&gt;</span><span class="n">misc_cg</span> <span class="o">=</span> <span class="n">get_current_misc_cg</span><span class="p">();</span>
       <span class="n">ret</span> <span class="o">=</span> <span class="n">misc_cg_try_charge</span><span class="p">(</span><span class="n">MISC_CG_RES_TDX</span><span class="p">,</span> <span class="n">kvm_tdx</span><span class="o">-&gt;</span><span class="n">misc_cg</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
       <span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
               <span class="k">goto</span> <span class="n">free_hkid</span><span class="p">;</span>

        <span class="n">ret</span> <span class="o">=</span> <span class="n">tdx_alloc_td_page</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kvm_tdx</span><span class="o">-&gt;</span><span class="n">tdr</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
                <span class="k">goto</span> <span class="n">free_hkid</span><span class="p">;</span>

        <span class="n">kvm_tdx</span><span class="o">-&gt;</span><span class="n">tdcs</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">tdx_caps</span><span class="p">.</span><span class="n">tdcs_nr_pages</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">kvm_tdx</span><span class="o">-&gt;</span><span class="n">tdcs</span><span class="p">),</span>
                                <span class="n">GFP_KERNEL_ACCOUNT</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">kvm_tdx</span><span class="o">-&gt;</span><span class="n">tdcs</span><span class="p">)</span>
                <span class="k">goto</span> <span class="n">free_tdr</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tdx_caps</span><span class="p">.</span><span class="n">tdcs_nr_pages</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="n">tdx_alloc_td_page</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kvm_tdx</span><span class="o">-&gt;</span><span class="n">tdcs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
                        <span class="k">goto</span> <span class="n">free_tdcs</span><span class="p">;</span>
        <span class="p">}</span>    

</pre></td></tr></tbody></table></code></div></div>
<p>KVM introduces the kvm_tdx structure to manage each TD instance. Although the
TDR and TDCS pages are filled out by the TDX Module, the physical pages used for
those two structures should be ready by the host KVM and passed to the TDX 
Module during the VM creation and initialization.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre>        <span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tdx_lock</span><span class="p">);</span>
        <span class="n">err</span> <span class="o">=</span> <span class="n">tdh_mng_create</span><span class="p">(</span><span class="n">kvm_tdx</span><span class="o">-&gt;</span><span class="n">tdr</span><span class="p">.</span><span class="n">pa</span><span class="p">,</span> <span class="n">kvm_tdx</span><span class="o">-&gt;</span><span class="n">hkid</span><span class="p">);</span>
        <span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tdx_lock</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="n">err</span><span class="p">))</span> <span class="p">{</span>
                <span class="n">pr_tdx_error</span><span class="p">(</span><span class="n">TDH_MNG_CREATE</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
                <span class="k">goto</span> <span class="n">free_tdcs</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">tdx_mark_td_page_added</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kvm_tdx</span><span class="o">-&gt;</span><span class="n">tdr</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></div></div>

<p>After the physical page allocations, it invokes TDH_MNG_CREATE SEAMCALL with 
passing physical address of TDR page and the HKID as its input.</p>

<h3 id="tdx-module-side"><span class="me-2">TDX Module side</span><a href="#tdx-module-side" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>Primary job of the TDX module for TDH_MNG_CREATE SEAMCALL is mapping the passed
TDR page as private and verifies that the passed key can be exclusively used for 
private memory of the TD VM. Let’s see how it maps the physical page passed from
the VMM, which is not secure, to the private page of the TD VM.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre></td><td class="rouge-code"><pre><span class="n">api_error_type</span> <span class="nf">tdh_mng_create</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">target_tdr_pa</span><span class="p">,</span> <span class="n">hkid_api_input_t</span> <span class="n">hkid_info</span><span class="p">)</span>
<span class="p">{</span>
    <span class="p">......</span>
    <span class="n">return_val</span> <span class="o">=</span> <span class="n">check_lock_and_map_explicit_tdr</span><span class="p">(</span><span class="n">tdr_pa</span><span class="p">,</span>
                                                 <span class="n">OPERAND_ID_RCX</span><span class="p">,</span>
                                                 <span class="n">TDX_RANGE_RW</span><span class="p">,</span>
                                                 <span class="n">TDX_LOCK_EXCLUSIVE</span><span class="p">,</span>
                                                 <span class="n">PT_NDA</span><span class="p">,</span>
                                                 <span class="o">&amp;</span><span class="n">tdr_pamt_block</span><span class="p">,</span>
                                                 <span class="o">&amp;</span><span class="n">tdr_pamt_entry_ptr</span><span class="p">,</span>
                                                 <span class="o">&amp;</span><span class="n">tdr_locked_flag</span><span class="p">,</span>
                                                 <span class="o">&amp;</span><span class="n">tdr_ptr</span><span class="p">);</span>
    <span class="p">......</span>
<span class="p">}</span>

<span class="n">api_error_type</span> <span class="nf">check_lock_and_map_explicit_tdr</span><span class="p">(</span>
        <span class="n">pa_t</span> <span class="n">tdr_hpa</span><span class="p">,</span>
        <span class="kt">uint64_t</span> <span class="n">operand_id</span><span class="p">,</span>
        <span class="n">mapping_type_t</span> <span class="n">mapping_type</span><span class="p">,</span>
        <span class="n">lock_type_t</span> <span class="n">lock_type</span><span class="p">,</span>
        <span class="n">page_type_t</span> <span class="n">expected_pt</span><span class="p">,</span>
        <span class="n">pamt_block_t</span><span class="o">*</span> <span class="n">pamt_block</span><span class="p">,</span>
        <span class="n">pamt_entry_t</span><span class="o">**</span> <span class="n">pamt_entry</span><span class="p">,</span>
        <span class="n">bool_t</span><span class="o">*</span> <span class="n">is_locked</span><span class="p">,</span>
        <span class="n">tdr_t</span><span class="o">**</span> <span class="n">tdr_p</span>
        <span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">check_lock_and_map_explicit_private_4k_hpa</span><span class="p">(</span><span class="n">tdr_hpa</span><span class="p">,</span> <span class="n">operand_id</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">mapping_type</span><span class="p">,</span>
            <span class="n">lock_type</span><span class="p">,</span> <span class="n">expected_pt</span><span class="p">,</span> <span class="n">pamt_block</span><span class="p">,</span> <span class="n">pamt_entry</span><span class="p">,</span> <span class="n">is_locked</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">**</span><span class="p">)</span><span class="n">tdr_p</span><span class="p">);</span>
<span class="p">}</span>   
</pre></td></tr></tbody></table></code></div></div>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
</pre></td><td class="rouge-code"><pre><span class="n">api_error_type</span> <span class="nf">check_lock_and_map_explicit_private_4k_hpa</span><span class="p">(</span>
        <span class="n">pa_t</span> <span class="n">hpa</span><span class="p">,</span>
        <span class="kt">uint64_t</span> <span class="n">operand_id</span><span class="p">,</span>
        <span class="n">tdr_t</span><span class="o">*</span> <span class="n">tdr_p</span><span class="p">,</span>
        <span class="n">mapping_type_t</span> <span class="n">mapping_type</span><span class="p">,</span>
        <span class="n">lock_type_t</span> <span class="n">lock_type</span><span class="p">,</span>
        <span class="n">page_type_t</span> <span class="n">expected_pt</span><span class="p">,</span>
        <span class="n">pamt_block_t</span><span class="o">*</span> <span class="n">pamt_block</span><span class="p">,</span>
        <span class="n">pamt_entry_t</span><span class="o">**</span> <span class="n">pamt_entry</span><span class="p">,</span>
        <span class="n">bool_t</span><span class="o">*</span> <span class="n">is_locked</span><span class="p">,</span>
        <span class="kt">void</span><span class="o">**</span>         <span class="n">la</span>
        <span class="p">)</span>
<span class="p">{</span>       
    <span class="n">api_error_type</span> <span class="n">errc</span><span class="p">;</span>
    <span class="n">page_size_t</span> <span class="n">leaf_size</span><span class="p">;</span>
        
    <span class="n">errc</span> <span class="o">=</span> <span class="n">check_and_lock_explicit_4k_private_hpa</span><span class="p">(</span> <span class="n">hpa</span><span class="p">,</span> <span class="n">operand_id</span><span class="p">,</span>
             <span class="n">lock_type</span><span class="p">,</span> <span class="n">expected_pt</span><span class="p">,</span> <span class="n">pamt_block</span><span class="p">,</span> <span class="n">pamt_entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">leaf_size</span><span class="p">,</span> <span class="n">is_locked</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">errc</span> <span class="o">!=</span> <span class="n">TDX_SUCCESS</span><span class="p">)</span>
    <span class="p">{</span>   
        <span class="k">return</span> <span class="n">errc</span><span class="p">;</span>
    <span class="p">}</span>   
    
    <span class="n">pa_t</span> <span class="n">hpa_with_hkid</span><span class="p">;</span>
    
    <span class="n">errc</span> <span class="o">=</span> <span class="n">check_and_assign_hkid_to_hpa</span><span class="p">(</span><span class="n">tdr_p</span><span class="p">,</span> <span class="n">hpa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hpa_with_hkid</span><span class="p">);</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">errc</span> <span class="o">!=</span> <span class="n">TDX_SUCCESS</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">TDX_ERROR</span><span class="p">(</span><span class="s">"check_and_assign_hkid_to_hpa failure</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="o">*</span><span class="n">is_locked</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
        <span class="n">pamt_unwalk</span><span class="p">(</span><span class="n">hpa</span><span class="p">,</span> <span class="o">*</span><span class="n">pamt_block</span><span class="p">,</span> <span class="o">*</span><span class="n">pamt_entry</span><span class="p">,</span> <span class="n">lock_type</span><span class="p">,</span> <span class="n">leaf_size</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">api_error_with_operand_id</span><span class="p">(</span><span class="n">errc</span><span class="p">,</span> <span class="n">operand_id</span><span class="p">);</span>
    <span class="p">}</span>


    <span class="o">*</span><span class="n">la</span> <span class="o">=</span> <span class="n">map_pa</span><span class="p">((</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">hpa_with_hkid</span><span class="p">.</span><span class="n">full_pa</span><span class="p">,</span> <span class="n">mapping_type</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">TDX_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>
<p>The main function for mapping TDR is check_lock_and_map_explicit_private_4k_hpa.
It consists of three parts, setting PAMT for the TDR page, assign HKID to the 
TDR hpa, and mapping the physical page. To map TDR hpa, TDX module utilizes the
global HKID of the TDX Module instead of the HKID of the target TD that owns TDR.
The key difference is the first part, setting PAMT. And the last part, mapping
physical page, we already covered [here.]</p>

<h3 id="retrieving-pamt-entry-mapped-to-tdr"><span class="me-2">Retrieving PAMT entry mapped to TDR</span><a href="#retrieving-pamt-entry-mapped-to-tdr" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
</pre></td><td class="rouge-code"><pre><span class="n">api_error_code_e</span> <span class="nf">non_shared_hpa_metadata_check_and_lock</span><span class="p">(</span>
        <span class="n">pa_t</span> <span class="n">hpa</span><span class="p">,</span>
        <span class="n">lock_type_t</span> <span class="n">lock_type</span><span class="p">,</span>
        <span class="n">page_type_t</span> <span class="n">expected_pt</span><span class="p">,</span>
        <span class="n">pamt_block_t</span><span class="o">*</span> <span class="n">pamt_block</span><span class="p">,</span>
        <span class="n">pamt_entry_t</span><span class="o">**</span> <span class="n">pamt_entry</span><span class="p">,</span>
        <span class="n">page_size_t</span><span class="o">*</span>   <span class="n">leaf_size</span><span class="p">,</span>
        <span class="n">bool_t</span> <span class="n">walk_to_leaf_size</span>
        <span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// 1) Check that the operand’s HPA is within a TDMR (Trust Domain Memory Range) which is covered by a PAMT.</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pamt_get_block</span><span class="p">(</span><span class="n">hpa</span><span class="p">,</span> <span class="n">pamt_block</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="n">TDX_ERROR</span><span class="p">(</span><span class="s">"pamt_get_block error hpa = 0x%llx</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">hpa</span><span class="p">.</span><span class="n">raw</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">TDX_OPERAND_ADDR_RANGE_ERROR</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">page_size_t</span> <span class="n">requested_leaf_size</span> <span class="o">=</span> <span class="o">*</span><span class="n">leaf_size</span><span class="p">;</span>

    <span class="c1">// 2) Find the PAMT entry for the page and verify that its metadata is as expected.</span>
    <span class="n">pamt_entry_t</span><span class="o">*</span> <span class="n">pamt_entry_lp</span> <span class="o">=</span> <span class="n">pamt_walk</span><span class="p">(</span><span class="n">hpa</span><span class="p">,</span> <span class="o">*</span><span class="n">pamt_block</span><span class="p">,</span> <span class="n">lock_type</span><span class="p">,</span> <span class="n">leaf_size</span><span class="p">,</span> <span class="n">walk_to_leaf_size</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pamt_entry_lp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">TDX_ERROR</span><span class="p">(</span><span class="s">"pamt_walk error</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">TDX_OPERAND_BUSY</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">walk_to_leaf_size</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">requested_leaf_size</span> <span class="o">!=</span> <span class="o">*</span><span class="n">leaf_size</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="n">TDX_ERROR</span><span class="p">(</span><span class="s">"PAMT entry level = %d , Expected level = %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="o">*</span><span class="n">leaf_size</span><span class="p">,</span> <span class="n">requested_leaf_size</span><span class="p">);</span>
        <span class="n">pamt_unwalk</span><span class="p">(</span><span class="n">hpa</span><span class="p">,</span> <span class="o">*</span><span class="n">pamt_block</span><span class="p">,</span> <span class="n">pamt_entry_lp</span><span class="p">,</span> <span class="n">lock_type</span><span class="p">,</span> <span class="o">*</span><span class="n">leaf_size</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">TDX_PAGE_METADATA_INCORRECT</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pamt_entry_lp</span><span class="o">-&gt;</span><span class="n">pt</span> <span class="o">!=</span> <span class="n">expected_pt</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">TDX_ERROR</span><span class="p">(</span><span class="s">"pamt_entry_lp-&gt;pt = %d , expected_pt = %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">pamt_entry_lp</span><span class="o">-&gt;</span><span class="n">pt</span><span class="p">,</span> <span class="n">expected_pt</span><span class="p">);</span>
        <span class="n">pamt_unwalk</span><span class="p">(</span><span class="n">hpa</span><span class="p">,</span> <span class="o">*</span><span class="n">pamt_block</span><span class="p">,</span> <span class="n">pamt_entry_lp</span><span class="p">,</span> <span class="n">lock_type</span><span class="p">,</span> <span class="o">*</span><span class="n">leaf_size</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">TDX_PAGE_METADATA_INCORRECT</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="o">*</span><span class="n">pamt_entry</span> <span class="o">=</span> <span class="n">pamt_entry_lp</span><span class="p">;</span>

    <span class="k">return</span> <span class="n">TDX_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Regarding setting PAMT, it should first check the physical address of the TDR is
within one of the initialized TDMR. If the check passes, the base addresses of 
the three different levels of PAMT will be retrieved from the TDMR that covers 
the TDR PA. The next step is walking the PAMT table and retrieve the PAMT entry
mapped with the TDR PA.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
</pre></td><td class="rouge-code"><pre><span class="n">pamt_entry_t</span><span class="o">*</span> <span class="nf">pamt_walk</span><span class="p">(</span><span class="n">pa_t</span> <span class="n">pa</span><span class="p">,</span> <span class="n">pamt_block_t</span> <span class="n">pamt_block</span><span class="p">,</span> <span class="n">lock_type_t</span> <span class="n">leaf_lock_type</span><span class="p">,</span>
                        <span class="n">page_size_t</span><span class="o">*</span> <span class="n">leaf_size</span><span class="p">,</span> <span class="n">bool_t</span> <span class="n">walk_to_leaf_size</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">pamt_entry_t</span><span class="o">*</span> <span class="n">pamt_1gb</span> <span class="o">=</span> <span class="n">map_pa_with_global_hkid</span><span class="p">(</span><span class="n">pamt_block</span><span class="p">.</span><span class="n">pamt_1gb_p</span><span class="p">,</span> <span class="n">TDX_RANGE_RW</span><span class="p">);</span>
    <span class="n">pamt_entry_t</span><span class="o">*</span> <span class="n">pamt_2mb</span> <span class="o">=</span> <span class="n">map_pa_with_global_hkid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pamt_block</span><span class="p">.</span><span class="n">pamt_2mb_p</span><span class="p">[</span><span class="n">pa</span><span class="p">.</span><span class="n">pamt_2m</span><span class="p">.</span><span class="n">idx</span><span class="p">],</span> <span class="n">TDX_RANGE_RW</span><span class="p">);</span>
    <span class="n">pamt_entry_t</span><span class="o">*</span> <span class="n">pamt_4kb</span> <span class="o">=</span> <span class="n">map_pa_with_global_hkid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pamt_block</span><span class="p">.</span><span class="n">pamt_4kb_p</span><span class="p">[</span><span class="n">pa</span><span class="p">.</span><span class="n">pamt_4k</span><span class="p">.</span><span class="n">idx</span><span class="p">],</span> <span class="n">TDX_RANGE_RW</span><span class="p">);</span>

    <span class="n">pamt_entry_t</span><span class="o">*</span> <span class="n">ret_entry_pp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">pamt_entry_t</span><span class="o">*</span> <span class="n">ret_entry_lp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="n">page_size_t</span> <span class="n">target_size</span> <span class="o">=</span> <span class="n">walk_to_leaf_size</span> <span class="o">?</span> <span class="o">*</span><span class="n">leaf_size</span> <span class="o">:</span> <span class="n">PT_4KB</span><span class="p">;</span>

    <span class="c1">// Acquire PAMT 1GB entry lock as shared</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">acquire_sharex_lock_sh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pamt_1gb</span><span class="o">-&gt;</span><span class="n">entry_lock</span><span class="p">)</span> <span class="o">!=</span> <span class="n">LOCK_RET_SUCCESS</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">goto</span> <span class="n">EXIT</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// Return pamt_1g entry if it is currently a leaf entry</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">pamt_1gb</span><span class="o">-&gt;</span><span class="n">pt</span> <span class="o">==</span> <span class="n">PT_REG</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">target_size</span> <span class="o">==</span> <span class="n">PT_1GB</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="c1">// Promote PAMT lock to exclusive if needed</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">leaf_lock_type</span> <span class="o">==</span> <span class="n">TDX_LOCK_EXCLUSIVE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">promote_sharex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pamt_1gb</span><span class="o">-&gt;</span><span class="n">entry_lock</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="k">goto</span> <span class="n">EXIT_FAILURE_RELEASE_ROOT</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="o">*</span><span class="n">leaf_size</span> <span class="o">=</span> <span class="n">PT_1GB</span><span class="p">;</span>
        <span class="n">ret_entry_pp</span> <span class="o">=</span> <span class="n">pamt_block</span><span class="p">.</span><span class="n">pamt_1gb_p</span><span class="p">;</span>

        <span class="k">goto</span> <span class="n">EXIT</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// Acquire PAMT 2MB entry lock as shared</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">acquire_sharex_lock_sh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pamt_2mb</span><span class="o">-&gt;</span><span class="n">entry_lock</span><span class="p">)</span> <span class="o">!=</span> <span class="n">LOCK_RET_SUCCESS</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">goto</span> <span class="n">EXIT_FAILURE_RELEASE_ROOT</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// Return pamt_2m entry if it is leaf</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">pamt_2mb</span><span class="o">-&gt;</span><span class="n">pt</span> <span class="o">==</span> <span class="n">PT_REG</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">target_size</span> <span class="o">==</span> <span class="n">PT_2MB</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="c1">// Promote PAMT lock to exclusive if needed</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">leaf_lock_type</span> <span class="o">==</span> <span class="n">TDX_LOCK_EXCLUSIVE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">promote_sharex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pamt_2mb</span><span class="o">-&gt;</span><span class="n">entry_lock</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="k">goto</span> <span class="n">EXIT_FAILURE_RELEASE_ALL</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="o">*</span><span class="n">leaf_size</span> <span class="o">=</span> <span class="n">PT_2MB</span><span class="p">;</span>
        <span class="n">ret_entry_pp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pamt_block</span><span class="p">.</span><span class="n">pamt_2mb_p</span><span class="p">[</span><span class="n">pa</span><span class="p">.</span><span class="n">pamt_2m</span><span class="p">.</span><span class="n">idx</span><span class="p">];</span>

        <span class="k">goto</span> <span class="n">EXIT</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// Acquire PAMT 4KB entry lock as shared/exclusive based on the lock flag</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">acquire_sharex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pamt_4kb</span><span class="o">-&gt;</span><span class="n">entry_lock</span><span class="p">,</span> <span class="n">leaf_lock_type</span><span class="p">)</span> <span class="o">!=</span> <span class="n">LOCK_RET_SUCCESS</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">goto</span> <span class="n">EXIT_FAILURE_RELEASE_ALL</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="o">*</span><span class="n">leaf_size</span> <span class="o">=</span> <span class="n">PT_4KB</span><span class="p">;</span>
    <span class="n">ret_entry_pp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pamt_block</span><span class="p">.</span><span class="n">pamt_4kb_p</span><span class="p">[</span><span class="n">pa</span><span class="p">.</span><span class="n">pamt_4k</span><span class="p">.</span><span class="n">idx</span><span class="p">];</span>

    <span class="k">goto</span> <span class="n">EXIT</span><span class="p">;</span>

<span class="n">EXIT_FAILURE_RELEASE_ALL</span><span class="o">:</span>
    <span class="c1">// Release PAMT 2MB shared lock</span>
    <span class="n">release_sharex_lock_sh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pamt_2mb</span><span class="o">-&gt;</span><span class="n">entry_lock</span><span class="p">);</span>
<span class="n">EXIT_FAILURE_RELEASE_ROOT</span><span class="o">:</span>
    <span class="c1">// Release PAMT 1GB shared lock</span>
    <span class="n">release_sharex_lock_sh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pamt_1gb</span><span class="o">-&gt;</span><span class="n">entry_lock</span><span class="p">);</span>

<span class="n">EXIT</span><span class="o">:</span>
    <span class="n">free_la</span><span class="p">(</span><span class="n">pamt_1gb</span><span class="p">);</span>
    <span class="n">free_la</span><span class="p">(</span><span class="n">pamt_2mb</span><span class="p">);</span>
    <span class="n">free_la</span><span class="p">(</span><span class="n">pamt_4kb</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">ret_entry_pp</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">ret_entry_lp</span> <span class="o">=</span> <span class="n">map_pa_with_global_hkid</span><span class="p">(</span><span class="n">ret_entry_pp</span><span class="p">,</span>
                <span class="p">(</span><span class="n">leaf_lock_type</span> <span class="o">==</span> <span class="n">TDX_LOCK_EXCLUSIVE</span><span class="p">)</span> <span class="o">?</span> <span class="n">TDX_RANGE_RW</span> <span class="o">:</span> <span class="n">TDX_RANGE_RO</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">ret_entry_lp</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>
<p>Based on the target page size, different level of PATM will be returned. Because
the TDR page is a single 4KB page, it does need to walk the PAMT table three 
times (1GB, 2MB, 4KB) and then return the leaf node. After finding the PAMT 
entry, its virtual address is mapped and returned.</p>

<h3 id="rest-of-the-tdh_mng_create-on-tdx-module"><span class="me-2">Rest of the TDH_MNG_CREATE on TDX Module</span><a href="#rest-of-the-tdh_mng_create-on-tdx-module" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="n">pi_error_type</span> <span class="n">tdh_mng_create</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">target_tdr_pa</span><span class="p">,</span> <span class="n">hkid_api_input_t</span> <span class="n">hkid_info</span><span class="p">)</span>
    <span class="p">......</span>
    <span class="c1">// Mark the HKID entry in the KOT as assigned</span>
    <span class="n">global_data</span><span class="o">-&gt;</span><span class="n">kot</span><span class="p">.</span><span class="n">entries</span><span class="p">[</span><span class="n">td_hkid</span><span class="p">].</span><span class="n">state</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span><span class="n">KOT_STATE_HKID_ASSIGNED</span><span class="p">;</span>

    <span class="c1">// Set HKID in the TKT entry</span>
    <span class="n">tdr_ptr</span><span class="o">-&gt;</span><span class="n">key_management_fields</span><span class="p">.</span><span class="n">hkid</span> <span class="o">=</span> <span class="n">td_hkid</span><span class="p">;</span>
    <span class="n">tdr_ptr</span><span class="o">-&gt;</span><span class="n">management_fields</span><span class="p">.</span><span class="n">lifecycle_state</span> <span class="o">=</span> <span class="n">TD_HKID_ASSIGNED</span><span class="p">;</span>

    <span class="c1">// Set the new TDR page PAMT fields</span>
    <span class="n">tdr_pamt_entry_ptr</span><span class="o">-&gt;</span><span class="n">pt</span> <span class="o">=</span> <span class="n">PT_TDR</span><span class="p">;</span>
    <span class="n">tdr_pamt_entry_ptr</span><span class="o">-&gt;</span><span class="n">owner</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Now the PAMT entry for the TDR is accessible, so it sets the PAMT for TDR (e.g.,
PT_TDR). Also, it checks whether the passed HKID is eligible for use of TD, for 
example, whether it belongs to the private HKID range. Also, it needs to check 
KOT to confirm that HKID can be exclusively used. If it is valid HKID, then the 
passed HKID is stored in the TDR.</p>

<h2 id="program-mktme-for-td-tdh_mng_key_config"><span class="me-2">Program MKTME for TD (TDH_MNG_KEY_CONFIG)</span><a href="#program-mktme-for-td-tdh_mng_key_config" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<p>To encrypt/decrypt the private pages of the TD, TDX Module should program the 
HKID and encryption key into the MKTME. Because MKTME exists per package, the 
TDH.MNG.KEY.CONFIG SEAMCALL should be invoked on each package. When the last 
package finished programming MKTME, the state of the TD is changed to 
UNINITIALIZED.</p>

<h2 id="add-tdcs-pages-for-td-tdh_mng_addcx"><span class="me-2">Add TDCS Pages for TD (TDH_MNG_ADDCX)</span><a href="#add-tdcs-pages-for-td-tdh_mng_addcx" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<p>After configuring the key, TDCX page should be added for the TD. Newly added
TDCX page is utilized for constructing TDCS. Recall that TDCS is a logical 
concept and consists of multiple physical TDCX pages. Also, when the TDCS pages
are mapped in the TDX module, it is accessible from the TDR of the specific VM.
It would be good to think of TDCS as a child of TDR. To add the TDCX pages, the
KVM host prepares physical page that can be mapped ad TDCX by the TDX Module. 
TDX module checks the validity of this physical page and maps with the <strong>HKID 
assigned for the target TD</strong>, not the global HKID of the TDX Module.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre>        <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tdx_caps</span><span class="p">.</span><span class="n">tdcs_nr_pages</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">err</span> <span class="o">=</span> <span class="n">tdh_mng_addcx</span><span class="p">(</span><span class="n">kvm_tdx</span><span class="o">-&gt;</span><span class="n">tdr</span><span class="p">.</span><span class="n">pa</span><span class="p">,</span> <span class="n">kvm_tdx</span><span class="o">-&gt;</span><span class="n">tdcs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pa</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="n">err</span><span class="p">))</span> <span class="p">{</span>
                        <span class="n">pr_tdx_error</span><span class="p">(</span><span class="n">TDH_MNG_ADDCX</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
                        <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
                        <span class="k">goto</span> <span class="n">teardown</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="n">tdx_mark_td_page_added</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kvm_tdx</span><span class="o">-&gt;</span><span class="n">tdcs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
        <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Also, the number of TDCX pages required for the TD is enumerated by the TDH.SYS.
INFO, which means multiple TDH_MNG_ADDCX SEAMCALL can be called to add TDCX 
pages.</p>

<h2 id="initialize-tdcs-tdh_mng_init"><span class="me-2">Initialize TDCS (TDH_MNG_INIT)</span><a href="#initialize-tdcs-tdh_mng_init" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<p>Previously we added TDCX pages to the TD, but note that TDCX has logically 
meaningful usage, Trust Domain Control Structure. To utilize the TDCX pages as 
TDCS, it should be initialized, and the TDH_MNG_INIT SEAMCALL does this job. 
This initialization includes set an EPML4 page in one of the previously added 
TDCX pages as the root page of the secure EPT (TDCS.EPTP).</p>

<h3 id="host-kvm-passes-td_params-to-tdx-module"><span class="me-2">Host KVM passes TD_PARAMS to TDX Module</span><a href="#host-kvm-passes-td_params-to-tdx-module" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td class="rouge-code"><pre><span class="k">struct</span> <span class="nc">td_params</span> <span class="p">{</span>
        <span class="n">u64</span> <span class="n">attributes</span><span class="p">;</span> 
        <span class="n">u64</span> <span class="n">xfam</span><span class="p">;</span>
        <span class="n">u32</span> <span class="n">max_vcpus</span><span class="p">;</span>
        <span class="n">u32</span> <span class="n">reserved0</span><span class="p">;</span>
        
        <span class="n">u64</span> <span class="n">eptp_controls</span><span class="p">;</span>
        <span class="n">u64</span> <span class="n">exec_controls</span><span class="p">;</span>
        <span class="n">u16</span> <span class="n">tsc_frequency</span><span class="p">;</span>
        <span class="n">u8</span>  <span class="n">reserved1</span><span class="p">[</span><span class="mi">38</span><span class="p">];</span>
        
        <span class="n">u64</span> <span class="n">mrconfigid</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
        <span class="n">u64</span> <span class="n">mrowner</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
        <span class="n">u64</span> <span class="n">mrownerconfig</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
        <span class="n">u64</span> <span class="n">reserved2</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
                
        <span class="k">union</span> <span class="p">{</span>         
                <span class="k">struct</span> <span class="nc">tdx_cpuid_value</span> <span class="n">cpuid_values</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
                <span class="n">u8</span> <span class="n">reserved3</span><span class="p">[</span><span class="mi">768</span><span class="p">];</span>
        <span class="p">};</span>      
<span class="p">}</span> <span class="n">__packed</span> <span class="nf">__aligned</span><span class="p">(</span><span class="mi">1024</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></div></div>

<blockquote>
  <p>TD_PARAMS is provided as an input to TDH.MNG.INIT, and some of its fields are 
included in the TD report. The format of this structure is valid for a specific
MAJOR_VERSION of the Intel TDX module, as reported by TDH.SYS.INFO</p>
</blockquote>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre></td><td class="rouge-code"><pre><span class="k">static</span> <span class="kt">int</span> <span class="nf">tdx_td_init</span><span class="p">(</span><span class="k">struct</span> <span class="nc">kvm</span> <span class="o">*</span><span class="n">kvm</span><span class="p">,</span> <span class="k">struct</span> <span class="nc">kvm_tdx_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
        <span class="p">......</span>
        <span class="n">td_params</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="nc">td_params</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">td_params</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
                <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">ret</span> <span class="o">=</span> <span class="n">setup_tdparams</span><span class="p">(</span><span class="n">kvm</span><span class="p">,</span> <span class="n">td_params</span><span class="p">,</span> <span class="n">init_vm</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
                <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

        <span class="n">err</span> <span class="o">=</span> <span class="n">tdh_mng_init</span><span class="p">(</span><span class="n">kvm_tdx</span><span class="o">-&gt;</span><span class="n">tdr</span><span class="p">.</span><span class="n">pa</span><span class="p">,</span> <span class="n">__pa</span><span class="p">(</span><span class="n">td_params</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">out</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="n">err</span><span class="p">))</span> <span class="p">{</span>
                <span class="n">pr_tdx_error</span><span class="p">(</span><span class="n">TDH_MNG_INIT</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">out</span><span class="p">);</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
                <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">kvm_tdx</span><span class="o">-&gt;</span><span class="n">tsc_offset</span> <span class="o">=</span> <span class="n">td_tdcs_exec_read64</span><span class="p">(</span><span class="n">kvm_tdx</span><span class="p">,</span> <span class="n">TD_TDCS_EXEC_TSC_OFFSET</span><span class="p">);</span>
        <span class="n">kvm_tdx</span><span class="o">-&gt;</span><span class="n">attributes</span> <span class="o">=</span> <span class="n">td_params</span><span class="o">-&gt;</span><span class="n">attributes</span><span class="p">;</span>
        <span class="n">kvm_tdx</span><span class="o">-&gt;</span><span class="n">xfam</span> <span class="o">=</span> <span class="n">td_params</span><span class="o">-&gt;</span><span class="n">xfam</span><span class="p">;</span>
        <span class="n">kvm_tdx</span><span class="o">-&gt;</span><span class="n">tsc_khz</span> <span class="o">=</span> <span class="n">TDX_TSC_25MHZ_TO_KHZ</span><span class="p">(</span><span class="n">td_params</span><span class="o">-&gt;</span><span class="n">tsc_frequency</span><span class="p">);</span>
	<span class="n">kvm</span><span class="o">-&gt;</span><span class="n">max_vcpus</span> <span class="o">=</span> <span class="n">td_params</span><span class="o">-&gt;</span><span class="n">max_vcpus</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">td_params</span><span class="o">-&gt;</span><span class="n">exec_controls</span> <span class="o">&amp;</span> <span class="n">TDX_EXEC_CONTROL_MAX_GPAW</span><span class="p">)</span>
                <span class="n">kvm</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">gfn_shared_mask</span> <span class="o">=</span> <span class="n">gpa_to_gfn</span><span class="p">(</span><span class="n">BIT_ULL</span><span class="p">(</span><span class="mi">51</span><span class="p">));</span>
        <span class="k">else</span>
                <span class="n">kvm</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">gfn_shared_mask</span> <span class="o">=</span> <span class="n">gpa_to_gfn</span><span class="p">(</span><span class="n">BIT_ULL</span><span class="p">(</span><span class="mi">47</span><span class="p">));</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>The main job of tdx_td_init function is invoking TDH.MNG.INIT SEAMCALL. For 
successful initialization of the TD VM, it requires TD_PARAMS which contains all
information such as measurement, tsc frequency, &amp;c. Most of the information to 
build TD_PARAMS are provided by the QEMU. Let’s take a look at how the TDX 
Module initializes the rest of the data structures.</p>

<h3 id="map-tdcs-pages-for-initialization"><span class="me-2">Map TDCS pages for initialization</span><a href="#map-tdcs-pages-for-initialization" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>To initializes the TDCS, the previously added TDCX pages should be accessible 
as the form of TDCS. Note that TDR maintains physical addresses of the TDCX.
map_implicit_tdcs function maps the TDCX pages and return the tdcs_t pointer. 
Note that it doesn’t map the 4th page because it is used for PASID usage.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre></td><td class="rouge-code"><pre><span class="k">typedef</span> <span class="k">struct</span> <span class="nc">ALIGN</span><span class="p">(</span><span class="n">TDX_PAGE_SIZE_IN_BYTES</span><span class="p">)</span> <span class="n">tdcs_s</span>
<span class="p">{</span>   
    <span class="cm">/**
     * TDCX First page - Management structures       
     */</span>
    <span class="n">tdcs_management_fields_t</span>               <span class="n">management_fields</span><span class="p">;</span>
    <span class="n">tdcs_execution_control_fields_t</span>        <span class="n">executions_ctl_fields</span><span class="p">;</span>
    <span class="cm">/**
     * Needs to be 128bit (16 byte) aligned for atomic cmpxchg
     */</span>
    <span class="n">tdcs_epoch_tracking_fields_t</span> <span class="n">ALIGN</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span> <span class="n">epoch_tracking</span><span class="p">;</span>
    <span class="n">tdcs_measurement_fields_t</span>              <span class="n">measurement_fields</span><span class="p">;</span>
    
    <span class="kt">uint64_t</span>                     <span class="n">notify_enables</span><span class="p">;</span> <span class="c1">// Enable guest notification of events</span>
    
    <span class="cm">/**
     * TDCX 2nd page - MSR Bitmaps
     */</span>
    <span class="kt">uint8_t</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">TDX_PAGE_SIZE_IN_BYTES</span><span class="p">)</span>                          <span class="n">MSR_BITMAPS</span><span class="p">[</span><span class="n">TDX_PAGE_SIZE_IN_BYTES</span><span class="p">];</span> <span class="cm">/**&lt; TD-scope RDMSR/WRMSR exit control bitmaps */</span>
    
    <span class="cm">/** 
     * TDCX 3rd page - Secure EPT Root Page
     */</span>
    <span class="kt">uint8_t</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">TDX_PAGE_SIZE_IN_BYTES</span><span class="p">)</span>                          <span class="n">sept_root_page</span><span class="p">[</span><span class="n">TDX_PAGE_SIZE_IN_BYTES</span><span class="p">];</span>
    
    <span class="cm">/**
     * TDCX 4th page - Zero Page
     */</span> 
    <span class="kt">uint8_t</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">TDX_PAGE_SIZE_IN_BYTES</span><span class="p">)</span>                          <span class="n">zero_page</span><span class="p">[</span><span class="n">TDX_PAGE_SIZE_IN_BYTES</span><span class="p">];</span>
<span class="p">}</span> <span class="n">tdcs_t</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></div></div>

<p>As shown in the above code, the TDCS consists of four TDCX pages and each field
is initialized during handling the TDH_MNG_INIT SEAMCALL.</p>

<h3 id="initialize-tdcs-fields"><span class="me-2">Initialize TDCS fields</span><a href="#initialize-tdcs-fields" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre>    <span class="cm">/** 
     *  Read the TD configuration input and set TDCS fields
     */</span>
    <span class="kt">uint16_t</span> <span class="n">virt_tsc_freq</span><span class="p">;</span>

    <span class="n">return_val</span> <span class="o">=</span> <span class="n">read_and_set_td_configurations</span><span class="p">(</span><span class="n">tdcs_ptr</span><span class="p">,</span>
                                                <span class="n">td_params_ptr</span><span class="p">,</span>
                                                <span class="n">MAX_PA</span><span class="p">,</span>
                                                <span class="n">tdr_ptr</span><span class="o">-&gt;</span><span class="n">management_fields</span><span class="p">.</span><span class="n">tdcx_pa</span><span class="p">[</span><span class="n">SEPT_ROOT_PAGE_INDEX</span><span class="p">],</span>
                                                <span class="o">&amp;</span><span class="n">virt_tsc_freq</span><span class="p">);</span>

</pre></td></tr></tbody></table></code></div></div>

<p>read_and_set_td_configurations configures most of the TDCS member fields, so 
it is hard to cover everything. Let’s focus on some important TDCS member fields
such as <strong>MSR bitmaps</strong>, <strong>TDCS measurement</strong>, and <strong>EPTP pointer</strong> controlling
guest TD’s GPA-&gt;HPA translation.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td><td class="rouge-code"><pre>    <span class="c1">// Read and verify EPTP_CONTROLS</span>
    <span class="n">target_eptp</span><span class="p">.</span><span class="n">raw</span> <span class="o">=</span> <span class="n">td_params_ptr</span><span class="o">-&gt;</span><span class="n">eptp_controls</span><span class="p">.</span><span class="n">raw</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">((</span><span class="n">target_eptp</span><span class="p">.</span><span class="n">fields</span><span class="p">.</span><span class="n">ept_ps_mt</span> <span class="o">!=</span> <span class="n">MT_WB</span><span class="p">)</span> <span class="o">||</span>
        <span class="p">(</span><span class="n">target_eptp</span><span class="p">.</span><span class="n">fields</span><span class="p">.</span><span class="n">ept_pwl</span> <span class="o">&lt;</span> <span class="n">LVL_PML4</span><span class="p">)</span> <span class="o">||</span>
        <span class="p">(</span><span class="n">target_eptp</span><span class="p">.</span><span class="n">fields</span><span class="p">.</span><span class="n">ept_pwl</span> <span class="o">&gt;</span> <span class="n">LVL_PML5</span><span class="p">)</span> <span class="o">||</span>
        <span class="p">(</span><span class="n">target_eptp</span><span class="p">.</span><span class="n">fields</span><span class="p">.</span><span class="n">enable_ad_bits</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
        <span class="p">(</span><span class="n">target_eptp</span><span class="p">.</span><span class="n">fields</span><span class="p">.</span><span class="n">enable_sss_control</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
        <span class="p">(</span><span class="n">target_eptp</span><span class="p">.</span><span class="n">fields</span><span class="p">.</span><span class="n">reserved_0</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
        <span class="p">(</span><span class="n">target_eptp</span><span class="p">.</span><span class="n">fields</span><span class="p">.</span><span class="n">base_pa</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
        <span class="p">(</span><span class="n">target_eptp</span><span class="p">.</span><span class="n">fields</span><span class="p">.</span><span class="n">reserved_1</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="n">return_val</span> <span class="o">=</span> <span class="n">api_error_with_operand_id</span><span class="p">(</span><span class="n">TDX_OPERAND_INVALID</span><span class="p">,</span> <span class="n">OPERAND_ID_EPTP_CONTROLS</span><span class="p">);</span>
        <span class="k">goto</span> <span class="n">EXIT</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="p">,,,,,,</span>
    <span class="cm">/** 
     *  The PA field of EPTP points to the Secure EPT root page in TDCS,
     *  which has already been initialized to 0 during TDADDCX
     */</span>
    <span class="n">target_eptp</span><span class="p">.</span><span class="n">fields</span><span class="p">.</span><span class="n">base_pa</span> <span class="o">=</span> <span class="n">sept_root_pa</span><span class="p">.</span><span class="n">page_4k_num</span><span class="p">;</span>
    
    <span class="n">tdcs_ptr</span><span class="o">-&gt;</span><span class="n">executions_ctl_fields</span><span class="p">.</span><span class="n">eptp</span><span class="p">.</span><span class="n">raw</span> <span class="o">=</span> <span class="n">target_eptp</span><span class="p">.</span><span class="n">raw</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></div></div>
<p>Based on the provided TD_PARAMS, it sets control bits of the EPTP first. After 
validating the control bits, it sets the EPTP root page table address, which is
the third TDCS page (tdcx_pa[SEPT_ROOT_PAGE_INDEX]). The populated EPTP info 
will be maintained in the first TDCS page, especially, executions_ctl_field.eptp.</p>

<h2 id="kvm_tdx_capabilities"><span class="me-2">KVM_TDX_CAPABILITIES</span><a href="#kvm_tdx_capabilities" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<p>Currently, KVM_TDX_CAPABILITIES is the only ioctl function supported through the
tdx device ioctl.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
</pre></td><td class="rouge-code"><pre><span class="kt">int</span> <span class="nf">tdx_dev_ioctl</span><span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">argp</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">struct</span> <span class="nc">kvm_tdx_capabilities</span> <span class="n">__user</span> <span class="o">*</span><span class="n">user_caps</span><span class="p">;</span>
        <span class="k">struct</span> <span class="nc">kvm_tdx_capabilities</span> <span class="n">caps</span><span class="p">;</span>
        <span class="k">struct</span> <span class="nc">kvm_tdx_cmd</span> <span class="n">cmd</span><span class="p">;</span>

        <span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="nc">kvm_tdx_cpuid_config</span><span class="p">)</span> <span class="o">!=</span>
                     <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="nc">tdx_cpuid_config</span><span class="p">));</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">)))</span>
                <span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">flags</span> <span class="o">||</span> <span class="n">cmd</span><span class="p">.</span><span class="n">error</span> <span class="o">||</span> <span class="n">cmd</span><span class="p">.</span><span class="n">unused</span><span class="p">)</span>
                <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
        <span class="cm">/*
         * Currently only KVM_TDX_CAPABILITIES is defined for system-scoped
         * mem_enc_ioctl().
         */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">id</span> <span class="o">!=</span> <span class="n">KVM_TDX_CAPABILITIES</span><span class="p">)</span>
                <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

        <span class="n">user_caps</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">cmd</span><span class="p">.</span><span class="n">data</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">caps</span><span class="p">,</span> <span class="n">user_caps</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">caps</span><span class="p">)))</span>
                <span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">caps</span><span class="p">.</span><span class="n">nr_cpuid_configs</span> <span class="o">&lt;</span> <span class="n">tdx_caps</span><span class="p">.</span><span class="n">nr_cpuid_configs</span><span class="p">)</span>
                <span class="k">return</span> <span class="o">-</span><span class="n">E2BIG</span><span class="p">;</span>

        <span class="n">caps</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="nc">kvm_tdx_capabilities</span><span class="p">)</span> <span class="p">{</span>
                <span class="p">.</span><span class="n">attrs_fixed0</span> <span class="o">=</span> <span class="n">tdx_caps</span><span class="p">.</span><span class="n">attrs_fixed0</span><span class="p">,</span>
                <span class="p">.</span><span class="n">attrs_fixed1</span> <span class="o">=</span> <span class="n">tdx_caps</span><span class="p">.</span><span class="n">attrs_fixed1</span><span class="p">,</span>
                <span class="p">.</span><span class="n">xfam_fixed0</span> <span class="o">=</span> <span class="n">tdx_caps</span><span class="p">.</span><span class="n">xfam_fixed0</span><span class="p">,</span>
                <span class="p">.</span><span class="n">xfam_fixed1</span> <span class="o">=</span> <span class="n">tdx_caps</span><span class="p">.</span><span class="n">xfam_fixed1</span><span class="p">,</span>
                <span class="p">.</span><span class="n">nr_cpuid_configs</span> <span class="o">=</span> <span class="n">tdx_caps</span><span class="p">.</span><span class="n">nr_cpuid_configs</span><span class="p">,</span>
                <span class="p">.</span><span class="n">padding</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="p">};</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">user_caps</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">caps</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">caps</span><span class="p">)))</span>
                <span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">user_caps</span><span class="o">-&gt;</span><span class="n">cpuid_configs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tdx_caps</span><span class="p">.</span><span class="n">cpuid_configs</span><span class="p">,</span>
                         <span class="n">tdx_caps</span><span class="p">.</span><span class="n">nr_cpuid_configs</span> <span class="o">*</span>
                         <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="nc">tdx_cpuid_config</span><span class="p">)))</span>
                <span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></td></tr></tbody></table></code></div></div>

<h3 id="kvm-retrieve-and-store-tdx-capabilities-information"><span class="me-2">KVM retrieve and store TDX capabilities information</span><a href="#kvm-retrieve-and-store-tdx-capabilities-information" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>To return the proper information about TDX, KVM module should have invoked 
TDCALL to tdx module and memorize all required information beforehand.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
</pre></td><td class="rouge-code"><pre><span class="cm">/* Capabilities of KVM + the TDX module. */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="nc">tdx_capabilities</span> <span class="n">tdx_caps</span><span class="p">;</span>

<span class="kt">int</span> <span class="n">__init</span> <span class="nf">tdx_module_setup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">const</span> <span class="k">struct</span> <span class="nc">tdsysinfo_struct</span> <span class="o">*</span><span class="n">tdsysinfo</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

        <span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">tdsysinfo</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1024</span><span class="p">);</span>
        <span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="n">TDX_MAX_NR_CPUID_CONFIGS</span> <span class="o">!=</span> <span class="mi">37</span><span class="p">);</span>

        <span class="n">ret</span> <span class="o">=</span> <span class="n">tdx_init</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">pr_info</span><span class="p">(</span><span class="s">"Failed to initialize TDX module.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
                <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">tdx_global_keyid</span> <span class="o">=</span> <span class="n">tdx_get_global_keyid</span><span class="p">();</span>

        <span class="n">tdsysinfo</span> <span class="o">=</span> <span class="n">tdx_get_sysinfo</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">tdsysinfo</span><span class="o">-&gt;</span><span class="n">num_cpuid_config</span> <span class="o">&gt;</span> <span class="n">TDX_MAX_NR_CPUID_CONFIGS</span><span class="p">)</span>
                <span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

        <span class="n">tdx_caps</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="nc">tdx_capabilities</span><span class="p">)</span> <span class="p">{</span>
                <span class="p">.</span><span class="n">tdcs_nr_pages</span> <span class="o">=</span> <span class="n">tdsysinfo</span><span class="o">-&gt;</span><span class="n">tdcs_base_size</span> <span class="o">/</span> <span class="n">PAGE_SIZE</span><span class="p">,</span>
                <span class="cm">/*
                 * TDVPS = TDVPR(4K page) + TDVPX(multiple 4K pages).
                 * -1 for TDVPR.
                 */</span>
                <span class="p">.</span><span class="n">tdvpx_nr_pages</span> <span class="o">=</span> <span class="n">tdsysinfo</span><span class="o">-&gt;</span><span class="n">tdvps_base_size</span> <span class="o">/</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                <span class="p">.</span><span class="n">attrs_fixed0</span> <span class="o">=</span> <span class="n">tdsysinfo</span><span class="o">-&gt;</span><span class="n">attributes_fixed0</span><span class="p">,</span>
                <span class="p">.</span><span class="n">attrs_fixed1</span> <span class="o">=</span> <span class="n">tdsysinfo</span><span class="o">-&gt;</span><span class="n">attributes_fixed1</span><span class="p">,</span>
                <span class="p">.</span><span class="n">xfam_fixed0</span> <span class="o">=</span>  <span class="n">tdsysinfo</span><span class="o">-&gt;</span><span class="n">xfam_fixed0</span><span class="p">,</span>
                <span class="p">.</span><span class="n">xfam_fixed1</span> <span class="o">=</span> <span class="n">tdsysinfo</span><span class="o">-&gt;</span><span class="n">xfam_fixed1</span><span class="p">,</span>
                <span class="p">.</span><span class="n">nr_cpuid_configs</span> <span class="o">=</span> <span class="n">tdsysinfo</span><span class="o">-&gt;</span><span class="n">num_cpuid_config</span><span class="p">,</span>
        <span class="p">};</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memcpy</span><span class="p">(</span><span class="n">tdx_caps</span><span class="p">.</span><span class="n">cpuid_configs</span><span class="p">,</span> <span class="n">tdsysinfo</span><span class="o">-&gt;</span><span class="n">cpuid_configs</span><span class="p">,</span>
                        <span class="n">tdsysinfo</span><span class="o">-&gt;</span><span class="n">num_cpuid_config</span> <span class="o">*</span>
                        <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="nc">tdx_cpuid_config</span><span class="p">)))</span>
                <span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="k">struct</span> <span class="nc">tdx_capabilities</span> <span class="p">{</span>
        <span class="n">u8</span> <span class="n">tdcs_nr_pages</span><span class="p">;</span>
        <span class="n">u8</span> <span class="n">tdvpx_nr_pages</span><span class="p">;</span>

        <span class="n">u64</span> <span class="n">attrs_fixed0</span><span class="p">;</span>
        <span class="n">u64</span> <span class="n">attrs_fixed1</span><span class="p">;</span>
        <span class="n">u64</span> <span class="n">xfam_fixed0</span><span class="p">;</span>
        <span class="n">u64</span> <span class="n">xfam_fixed1</span><span class="p">;</span>

        <span class="n">u32</span> <span class="n">nr_cpuid_configs</span><span class="p">;</span>
        <span class="k">struct</span> <span class="nc">tdx_cpuid_config</span> <span class="n">cpuid_configs</span><span class="p">[</span><span class="n">TDX_MAX_NR_CPUID_CONFIGS</span><span class="p">];</span>
<span class="p">};</span>

</pre></td></tr></tbody></table></code></div></div>

<p><strong>tdx_capabilities</strong> struct selectively contains the information provided through tdsysinfo.
tdsysinfo can be retrieved from the TDX module through the tdcall as shown in the below. 
Host KVM retrieves the tdsysinfo as a result of TDH_SYS_INFO SEAMCALL at the time 
of init_tdx_module.</p>


  </div>

  <div class="post-tail-wrapper text-muted">
    <!-- categories -->
    
      <div class="post-meta mb-3">
        <i class="far fa-folder-open fa-fw me-1"></i>
        
          <a href="/categories/confidential-computing/">Confidential Computing</a>,
          <a href="/categories/intel-tdx/">Intel TDX</a>
      </div>
    

    <!-- tags -->
    

    <div
      class="
        post-tail-bottom
        d-flex justify-content-between align-items-center mt-5 pb-2
      "
    >
      <div class="license-wrapper">
        
          

          This post is licensed under 
        <a href="https://creativecommons.org/licenses/by/4.0/">
          CC BY 4.0
        </a>
         by the author.
        
      </div>

      <!-- Post sharing snippet -->

<div class="share-wrapper d-flex align-items-center">
  <span class="share-label text-muted">Share</span>
  <span class="share-icons">
    
    
    

    

      

      <a
        href="https://twitter.com/intent/tweet?text=TD%20VM%20Life%20Cycle%20Part%201%20-%20Ruach&url=https%3A%2F%2Fruach.github.io%2Fposts%2FTD-VM-LIFECYCLE-1%2F"
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Twitter"
        target="_blank"
        rel="noopener"
        aria-label="Twitter"
      >
        <i class="fa-fw fa-brands fa-square-x-twitter"></i>
      </a>
    

      

      <a
        href="https://www.facebook.com/sharer/sharer.php?title=TD%20VM%20Life%20Cycle%20Part%201%20-%20Ruach&u=https%3A%2F%2Fruach.github.io%2Fposts%2FTD-VM-LIFECYCLE-1%2F"
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Facebook"
        target="_blank"
        rel="noopener"
        aria-label="Facebook"
      >
        <i class="fa-fw fab fa-facebook-square"></i>
      </a>
    

      

      <a
        href="https://t.me/share/url?url=https%3A%2F%2Fruach.github.io%2Fposts%2FTD-VM-LIFECYCLE-1%2F&text=TD%20VM%20Life%20Cycle%20Part%201%20-%20Ruach"
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Telegram"
        target="_blank"
        rel="noopener"
        aria-label="Telegram"
      >
        <i class="fa-fw fab fa-telegram"></i>
      </a>
    

      

      <a
        href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fruach.github.io%2Fposts%2FTD-VM-LIFECYCLE-1%2F"
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Linkedin"
        target="_blank"
        rel="noopener"
        aria-label="Linkedin"
      >
        <i class="fa-fw fab fa-linkedin"></i>
      </a>
    

    <button
      id="copy-link"
      aria-label="Copy link"
      class="btn small"
      data-bs-toggle="tooltip"
      data-bs-placement="top"
      title="Copy link"
      data-title-succeed="Link copied successfully!"
    >
      <i class="fa-fw fas fa-link pe-none fs-6"></i>
    </button>
  </span>
</div>

    </div>
    <!-- .post-tail-bottom -->
  </div>
  <!-- div.post-tail-wrapper -->
</article>


            
          </main>

          <!-- panel -->
          <aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 mb-5 text-muted">
            <div class="access">
              <!-- Get the last 5 posts from lastmod list. -->















              <!-- The trending tags list -->


















            </div>

            
              
              



  <section id="toc-wrapper" class="ps-0 pe-4">
    <h2 class="panel-heading ps-3 pt-2 mb-2">Contents</h2>
    <nav id="toc"></nav>
  </section>


            
          </aside>
        </div>

        <div class="row">
          <!-- tail -->
          <div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4">
            
              
              <!-- Recommend the other 3 posts according to the tags and categories of the current post. -->

<!-- The total size of related posts -->


<!-- An random integer that bigger than 0 -->


<!-- Equals to TAG_SCORE / {max_categories_hierarchy} -->














  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  
    
  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  











  <aside id="related-posts" aria-labelledby="related-label">
    <h3 class="mb-4" id="related-label">Further Reading</h3>
    <nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4">
      
        <article class="col">
          <a href="/posts/TDX-SEAMLDR/" class="post-preview card h-100">
            <div class="card-body">
              <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1678424400"
  data-df="ll"
  
>
  Mar 10, 2023
</time>

              <h4 class="pt-0 my-2">TDX Module Life Cycle Part 0 (SEAMLDR)</h4>
              <div class="text-muted">
                <p>
                  





                  New CPU privileges and software layer for Intel TDX
Secure Arbitration Mode (SEAM) is an extension of Virtual Machines Extension 
(VMX). It introduces new VMX root mode called SEAM root. The primar...
                </p>
              </div>
            </div>
          </a>
        </article>
      
        <article class="col">
          <a href="/posts/TDX-MODULE-LIFECYCLE-1/" class="post-preview card h-100">
            <div class="card-body">
              <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1679284800"
  data-df="ll"
  
>
  Mar 20, 2023
</time>

              <h4 class="pt-0 my-2">TDX Module Life Cycle Part 1</h4>
              <div class="text-muted">
                <p>
                  





                  Initialize TDX module
TDX module requires few initialization steps to start service as intermediary of
the TD and VMM. To this end, TDX module requires multiple SEAMCALLs to be 
invoked, as shown i...
                </p>
              </div>
            </div>
          </a>
        </article>
      
        <article class="col">
          <a href="/posts/TDX-MODULE-LIFECYCLE-2/" class="post-preview card h-100">
            <div class="card-body">
              <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1679544000"
  data-df="ll"
  
>
  Mar 23, 2023
</time>

              <h4 class="pt-0 my-2">TDX Module Life Cycle Part 2</h4>
              <div class="text-muted">
                <p>
                  





                  In previous posts, I discussed the initialization of the TDX module using 
TDH_SYS_INIT SEAMCALL. As depicted in the image below, several additional 
configuration steps are necessary for the TDX m...
                </p>
              </div>
            </div>
          </a>
        </article>
      
    </nav>
  </aside>
  <!-- #related-posts -->


            
              
              <!-- Navigation buttons at the bottom of the post. -->

<nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation">
  
  

  
    <a
      href="/posts/TDX-MODULE-LIFECYCLE-2/"
      class="btn btn-outline-primary"
      aria-label="Older"
    >
      <p>TDX Module Life Cycle Part 2</p>
    </a>
  

  
    <a
      href="/posts/TD-VM-LIFECYCLE-2/"
      class="btn btn-outline-primary"
      aria-label="Newer"
    >
      <p>TD VM Life Cycle Part 2</p>
    </a>
  
</nav>

            
              
              <!--  The comments switcher -->

  
  <!-- The Disqus lazy loading. -->

<div id="disqus_thread">
  <p class="text-center text-muted small">Comments powered by <a href="https://disqus.com/">Disqus</a>.</p>
</div>

<script type="text/javascript">
  var disqus_config = function () {
    this.page.url = 'https://ruach.github.io/posts/TD-VM-LIFECYCLE-1/';
    this.page.identifier = '/posts/TD-VM-LIFECYCLE-1/';
  };

  /* Lazy loading */
  var disqus_observer = new IntersectionObserver(
    function (entries) {
      if (entries[0].isIntersecting) {
        (function () {
          var d = document,
            s = d.createElement('script');
          s.src = 'https://ruach.disqus.com/embed.js';
          s.setAttribute('data-timestamp', +new Date());
          (d.head || d.body).appendChild(s);
        })();

        disqus_observer.disconnect();
      }
    },
    { threshold: [0] }
  );

  disqus_observer.observe(document.querySelector('#disqus_thread'));

  /* Auto switch theme */
  function reloadDisqus() {
    if (event.source === window && event.data && event.data.direction === ModeToggle.ID) {
      /* Disqus hasn't been loaded */
      if (typeof DISQUS === 'undefined') {
        return;
      }

      if (document.readyState == 'complete') {
        DISQUS.reset({ reload: true, config: disqus_config });
      }
    }
  }

  if (document.querySelector('.mode-toggle')) {
    window.addEventListener('message', reloadDisqus);
  }
</script>



            

            <!-- The Footer -->

<footer
  aria-label="Site Info"
  class="
    d-flex flex-column justify-content-center text-muted
    flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3
  "
>
  <p>
    ©
    <time>2024</time>
    <a href="https://ruach.github.io">Jaehyuk Lee</a>.
    
      <span
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author."
      >Some rights reserved.</span>
    
  </p>

  <p>Using the <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme for <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>
  </p>
</footer>

          </div>
        </div>

        <!-- The Search results -->

<div id="search-result-wrapper" class="d-flex justify-content-center unloaded">
  <div class="col-11 content">
    <div id="search-hints">
      <!-- The trending tags list -->


















    </div>
    <div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div>
  </div>
</div>

      </div>

      <aside aria-label="Scroll to Top">
        <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow">
          <i class="fas fa-angle-up"></i>
        </button>
      </aside>
    </div>

    <div id="mask"></div>

    
      <aside
  id="notification"
  class="toast"
  role="alert"
  aria-live="assertive"
  aria-atomic="true"
  data-bs-animation="true"
  data-bs-autohide="false"
>
  <div class="toast-header">
    <button
      type="button"
      class="btn-close ms-auto"
      data-bs-dismiss="toast"
      aria-label="Close"
    ></button>
  </div>
  <div class="toast-body text-center pt-0">
    <p class="px-2 mb-3">A new version of content is available.</p>
    <button type="button" class="btn btn-primary" aria-label="Update">
      Update
    </button>
  </div>
</aside>

    

    <!-- JavaScripts -->

    <!-- JS selector for site. -->

<!-- commons -->



<!-- layout specified -->


  

  
    <!-- image lazy-loading & popup & clipboard -->
    
  















  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  



  <script src="https://cdn.jsdelivr.net/combine/npm/jquery@3.7.1/dist/jquery.min.js,npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js,npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/magnific-popup@1.1.0/dist/jquery.magnific-popup.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.10/dayjs.min.js,npm/dayjs@1.11.10/locale/en.min.js,npm/dayjs@1.11.10/plugin/relativeTime.min.js,npm/dayjs@1.11.10/plugin/localizedFormat.min.js,npm/tocbot@4.21.2/dist/tocbot.min.js"></script>






<script defer src="/assets/js/dist/post.min.js"></script>






    

    <!--
  Jekyll Simple Search loader
  See: <https://github.com/christian-fei/Simple-Jekyll-Search>
-->





<script>
  /* Note: dependent library will be loaded in `js-selector.html` */
  SimpleJekyllSearch({
    searchInput: document.getElementById('search-input'),
    resultsContainer: document.getElementById('search-results'),
    json: '/assets/js/data/search.json',
    searchResultTemplate: '  <article class="px-1 px-sm-2 px-lg-4 px-xl-0">    <header>      <h2><a href="{url}">{title}</a></h2>      <div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1">        {categories}        {tags}      </div>    </header>    <p>{snippet}</p>  </article>',
    noResultsText: '<p class="mt-5"></p>',
    templateMiddleware: function(prop, value, template) {
      if (prop === 'categories') {
        if (value === '') {
          return `${value}`;
        } else {
          return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`;
        }
      }

      if (prop === 'tags') {
        if (value === '') {
          return `${value}`;
        } else {
          return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`;
        }
      }
    }
  });
</script>

  </body>
</html>

