<!doctype html>














<!-- `site.alt_lang` can specify a language different from the UI -->
<html lang="en" data-mode="light">
  <!-- The Head -->

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta
    name="viewport"
    content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover"
  >

  

  

  
    <!-- Begin Jekyll SEO tag v2.8.0 -->
<meta name="generator" content="Jekyll v4.3.3" />
<meta property="og:title" content="TD VM Life Cycle Part 2" />
<meta property="og:locale" content="en" />
<meta name="description" content="Deep dive into TD VCPU creation (TDH_VP_CREATE-TDH_VP_INIT) Instantiating TD VCPU After the VM has been initialized, note that it has not been finalized yet, it can generate VCPUs assigned to the generated TD instance. The logistics of TD VCPU generation consists of two parts mainly: generate VCPU (KVM_CREATE_VCPU) and initialize the generated VCPU as TDX VCPU (KVM_TDX_INIT_VCPU) through the SEAMCALL, TDH_VP_INIT." />
<meta property="og:description" content="Deep dive into TD VCPU creation (TDH_VP_CREATE-TDH_VP_INIT) Instantiating TD VCPU After the VM has been initialized, note that it has not been finalized yet, it can generate VCPUs assigned to the generated TD instance. The logistics of TD VCPU generation consists of two parts mainly: generate VCPU (KVM_CREATE_VCPU) and initialize the generated VCPU as TDX VCPU (KVM_TDX_INIT_VCPU) through the SEAMCALL, TDH_VP_INIT." />
<link rel="canonical" href="https://ruach.github.io/posts/TD-VM-LIFECYCLE-2/" />
<meta property="og:url" content="https://ruach.github.io/posts/TD-VM-LIFECYCLE-2/" />
<meta property="og:site_name" content="Ruach" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2023-04-03T00:00:00-04:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="TD VM Life Cycle Part 2" />
<meta name="twitter:site" content="@ruach_lee" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2023-04-03T00:00:00-04:00","datePublished":"2023-04-03T00:00:00-04:00","description":"Deep dive into TD VCPU creation (TDH_VP_CREATE-TDH_VP_INIT) Instantiating TD VCPU After the VM has been initialized, note that it has not been finalized yet, it can generate VCPUs assigned to the generated TD instance. The logistics of TD VCPU generation consists of two parts mainly: generate VCPU (KVM_CREATE_VCPU) and initialize the generated VCPU as TDX VCPU (KVM_TDX_INIT_VCPU) through the SEAMCALL, TDH_VP_INIT.","headline":"TD VM Life Cycle Part 2","mainEntityOfPage":{"@type":"WebPage","@id":"https://ruach.github.io/posts/TD-VM-LIFECYCLE-2/"},"url":"https://ruach.github.io/posts/TD-VM-LIFECYCLE-2/"}</script>
<!-- End Jekyll SEO tag -->

  

  <title>TD VM Life Cycle Part 2 | Ruach
  </title>

  <!--
  The Favicons for Web, Android, Microsoft, and iOS (iPhone and iPad) Apps
  Generated by: https://realfavicongenerator.net/
-->



<link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png">
<link rel="manifest" href="/assets/img/favicons/site.webmanifest">
<link rel="shortcut icon" href="/assets/img/favicons/favicon.ico">
<meta name="apple-mobile-web-app-title" content="Ruach">
<meta name="application-name" content="Ruach">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml">
<meta name="theme-color" content="#ffffff">


  
    
      <link rel="preconnect" href="https://fonts.googleapis.com" >
      <link rel="dns-prefetch" href="https://fonts.googleapis.com" >
    
      <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      <link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin>
    
      <link rel="preconnect" href="https://fonts.googleapis.com" >
      <link rel="dns-prefetch" href="https://fonts.googleapis.com" >
    
      <link rel="preconnect" href="https://cdn.jsdelivr.net" >
      <link rel="dns-prefetch" href="https://cdn.jsdelivr.net" >
    

    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap">
  

  <!-- GA -->
  

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.2/css/all.min.css">

  <link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css">

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.21.2/dist/tocbot.min.css">
  

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css">
  

  
    <!-- Manific Popup -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css">
  

  <!-- JavaScript -->

  

  <!-- A placeholder to allow defining custom metadata -->

</head>


  <body>
    <!-- The Side Bar -->

<aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end">
  <header class="profile-wrapper">
    <a href="/" id="avatar" class="rounded-circle">
      
        
        <img src="/assets/img/jaehyuk.png" width="112" height="112" alt="avatar" onerror="this.style.display='none'">
      
    </a>

    <h1 class="site-title">
      <a href="/">Ruach</a>
    </h1>
    <p class="site-subtitle fst-italic mb-0">Jaehyuk Lee</p>
  </header>
  <!-- .profile-wrapper -->

  <nav class="flex-column flex-grow-1 w-100 ps-0">
    <ul class="nav">
      <!-- home -->
      <li class="nav-item">
        <a href="/" class="nav-link">
          <i class="fa-fw fas fa-home"></i>
          <span>HOME</span>
        </a>
      </li>
      <!-- the real tabs -->
      
        <li class="nav-item">
          <a href="/categories/" class="nav-link">
            <i class="fa-fw fas fa-stream"></i>
            

            <span>CATEGORIES</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/archives/" class="nav-link">
            <i class="fa-fw fas fa-archive"></i>
            

            <span>ARCHIVES</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/about/" class="nav-link">
            <i class="fa-fw fas fa-info-circle"></i>
            

            <span>ABOUT</span>
          </a>
        </li>
        <!-- .nav-item -->
      
    </ul>
  </nav>

  <div class="sidebar-bottom d-flex flex-wrap  align-items-center w-100">
    

    
      

      
        <a
          href="javascript:location.href = 'mailto:' + ['jaehyuk','gatech.edu'].join('@')"
          aria-label="email"
          

          

          

          
        >
          <i class="fas fa-envelope"></i>
        </a>
      
    
      

      
        <a
          href="https://www.linkedin.com/in/jaehyuk-lee-29b33b121/"
          aria-label="linkedin"
          

          
            target="_blank"
            
          

          

          
            rel="noopener noreferrer"
          
        >
          <i class="fab fa-linkedin"></i>
        </a>
      
    
      

      
        <a
          href="https://github.com/Ruach"
          aria-label="github"
          

          
            target="_blank"
            
          

          

          
            rel="noopener noreferrer"
          
        >
          <i class="fab fa-github"></i>
        </a>
      
    
      

      
        <a
          href="https://stackoverflow.com/users/4460514/ruach?tab=profile"
          aria-label="stack-overflow"
          

          
            target="_blank"
            
          

          

          
            rel="noopener noreferrer"
          
        >
          <i class="fab fa-stack-overflow"></i>
        </a>
      
    
  </div>
  <!-- .sidebar-bottom -->
</aside>
<!-- #sidebar -->


    <div id="main-wrapper" class="d-flex justify-content-center">
      <div class="container d-flex flex-column px-xxl-5">
        <!-- The Top Bar -->

<header id="topbar-wrapper" aria-label="Top Bar">
  <div
    id="topbar"
    class="d-flex align-items-center justify-content-between px-lg-3 h-100"
  >
    <nav id="breadcrumb" aria-label="Breadcrumb">
      

      
        
          
            <span>
              <a href="/">
                Home
              </a>
            </span>

          
        
          
        
          
            
              <span>TD VM Life Cycle Part 2</span>
            

          
        
      
    </nav>
    <!-- endof #breadcrumb -->

    <button type="button" id="sidebar-trigger" class="btn btn-link">
      <i class="fas fa-bars fa-fw"></i>
    </button>

    <div id="topbar-title">
      Post
    </div>

    <button type="button" id="search-trigger" class="btn btn-link">
      <i class="fas fa-search fa-fw"></i>
    </button>

    <search class="align-items-center ms-3 ms-lg-0">
      <i class="fas fa-search fa-fw"></i>
      <input
        class="form-control"
        id="search-input"
        type="search"
        aria-label="search"
        autocomplete="off"
        placeholder="Search..."
      >
    </search>
    <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button>
  </div>
</header>


        <div class="row flex-grow-1">
          <main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4">
            
              <!-- Refactor the HTML structure -->



<!--
  In order to allow a wide table to scroll horizontally,
  we suround the markdown table with `<div class="table-wrapper">` and `</div>`
-->



<!--
  Fixed kramdown code highlight rendering:
  https://github.com/penibelst/jekyll-compress-html/issues/101
  https://github.com/penibelst/jekyll-compress-html/issues/71#issuecomment-188144901
-->



<!-- Change the icon of checkbox -->



<!-- Handle images -->




  
  

  <!-- CDN URL -->
  

  <!-- Add image path -->
  

  
    
      
      
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      <!-- do not add shimmer by default -->
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  

  


<!-- Add header for code snippets -->



<!-- Create heading anchors -->





  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    

    
  

  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    

    
  

  
  

  

  
  

  




<!-- return -->




<article class="px-1">
  <header>
    <h1 data-toc-skip>TD VM Life Cycle Part 2</h1>

    <div class="post-meta text-muted">
      <!-- published date -->
      <span>
        Posted
        <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1680494400"
  data-df="ll"
  
    data-bs-toggle="tooltip" data-bs-placement="bottom"
  
>
  Apr  3, 2023
</time>

      </span>

      <!-- lastmod date -->
      

      

      <div class="d-flex justify-content-between">
        <!-- author(s) -->
        <span>
          

          By

          <em>
            
              <a href="https://ruach.github.io">Jaehyuk Lee</a>
            
          </em>
        </span>

        <!-- read time -->
        <!-- Calculate the post's reading time, and display the word count in tooltip -->



<!-- words per minute -->










<!-- return element -->
<span
  class="readtime"
  data-bs-toggle="tooltip"
  data-bs-placement="bottom"
  title="3849 words"
>
  <em>21 min</em> read</span>

      </div>
      <!-- .d-flex -->
    </div>
    <!-- .post-meta -->
  </header>

  <div class="content">
    <h1 id="deep-dive-into-td-vcpu-creation-tdh_vp_create-tdh_vp_init">Deep dive into TD VCPU creation (TDH_VP_CREATE-TDH_VP_INIT)</h1>
<h2 id="instantiating-td-vcpu"><span class="me-2">Instantiating TD VCPU</span><a href="#instantiating-td-vcpu" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<p>After the VM has been initialized, note that it has not been finalized yet, it 
can generate VCPUs assigned to the generated TD instance. The logistics of TD 
VCPU generation consists of two parts mainly: generate VCPU (KVM_CREATE_VCPU) 
and initialize the generated VCPU as TDX VCPU (KVM_TDX_INIT_VCPU) through 
the SEAMCALL, TDH_VP_INIT.</p>

<h3 id="vcpu-creation-for-tdx"><span class="me-2">VCPU Creation for TDX</span><a href="#vcpu-creation-for-tdx" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>The first step is generating VCPU instance as we do for vanilla VM’s VCPU. It 
utilizes the same interface from QEMU side, KVM_CREATE_VCPU of the kvm_vm_ioctl.
kvm_vm_ioctl_create_vcpu is the main function handling the ioctl and invokes 
following functions to initialize the VCPU related features including MMU.
MMU initialization details are described in [here].</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre><span class="mi">10997</span> <span class="kt">int</span> <span class="nf">kvm_arch_vcpu_create</span><span class="p">(</span><span class="k">struct</span> <span class="nc">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">......</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">static_call</span><span class="p">(</span><span class="n">kvm_x86_vcpu_create</span><span class="p">)(</span><span class="n">vcpu</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
                <span class="k">goto</span> <span class="n">free_guest_fpu</span><span class="p">;</span>

        <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">arch_capabilities</span> <span class="o">=</span> <span class="n">kvm_get_arch_capabilities</span><span class="p">();</span>
        <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">msr_platform_info</span> <span class="o">=</span> <span class="n">MSR_PLATFORM_INFO_CPUID_FAULT</span><span class="p">;</span>
        <span class="n">kvm_xen_init_vcpu</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
        <span class="n">kvm_vcpu_mtrr_init</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
        <span class="n">vcpu_load</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
        <span class="n">kvm_set_tsc_khz</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">kvm</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">default_tsc_khz</span><span class="p">);</span>
        <span class="n">kvm_vcpu_reset</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
        <span class="n">kvm_init_mmu</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
        <span class="n">vcpu_put</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

</pre></td></tr></tbody></table></code></div></div>

<p>kvm_arch_vcpu_create is the architecture specific VCPU initialization function.</p>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="k">struct</span> <span class="nc">kvm_x86_ops</span> <span class="n">vt_x86_ops</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">.</span><span class="n">vcpu_create</span> <span class="o">=</span> <span class="n">vt_vcpu_create</span><span class="p">,</span>
</pre></td></tr></tbody></table></code></div></div>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="k">static</span> <span class="kt">int</span> <span class="nf">vt_vcpu_create</span><span class="p">(</span><span class="k">struct</span> <span class="nc">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">is_td_vcpu</span><span class="p">(</span><span class="n">vcpu</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">tdx_vcpu_create</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>

        <span class="k">return</span> <span class="n">vmx_vcpu_create</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>
<p>And the kvm_x86_vcpu_create function, actually the tdx_vcpu_create function 
generates the TD VM’s VCPU instances.</p>

<h3 id="trust-domain-virtual-processor-state-tdvps"><span class="me-2">Trust Domain Virtual Processor State (TDVPS)</span><a href="#trust-domain-virtual-processor-state-tdvps" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<blockquote>
  <p>Trust Domain Virtual Processor Root (TDVPR) is the 4KB root page of TDVPS. Its 
physical address serves as a <strong>unique identifier of the VCPU</strong> (as long as it 
resides in memory).</p>
</blockquote>

<p>As the TDR is the id of the TD VM, each TD VCPU requires associated TDX metadata
called <strong>Trust Domain Virtual Processor State (TDVPS)</strong>. For example, <strong>TD VCPU 
and TD VMCS</strong> structure are stored in the TDVPS as shown in the figure.</p>

<p><a href="/assets//img/TDX/TDVPS.png" class="popup img-link "><img src="/assets//img/TDX/TDVPS.png" alt="TDVPS" loading="lazy"></a></p>

<blockquote>
  <p>Trust Domain Virtual Processor eXtension (TDVPX) 4KB pages extend TDVPR to help
provide enough physical space for the logical TDVPS structure.</p>
</blockquote>

<p>TDX <strong>logically</strong> views the TDVPS as a consecutive memory region containing all 
VMX standard control structure such as TD VMCS and TD VCPU. Especially, TD VCPU 
Management fields manage the operation of the VCPU. However, <strong>physically</strong>, it 
consists of multiple physical pages represented as <strong>TDVPR root page and TDVPX 
child pages</strong>.</p>

<blockquote>
  <p>The required number of 4KB TDVPR/TDVPX pages in TDVPS is enumerated to the VMM
by the TDH.SYS.INFO function.</p>
</blockquote>

<h3 id="tdvps-management-in-tdx-module"><span class="me-2">TDVPS management in TDX Module</span><a href="#tdvps-management-in-tdx-module" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
</pre></td><td class="rouge-code"><pre><span class="k">typedef</span> <span class="k">struct</span> <span class="nc">tdvps_management_s</span>
<span class="p">{</span>
    <span class="kt">uint8_t</span>   <span class="n">state</span><span class="p">;</span> <span class="cm">/**&lt; The activity state of the VCPU */</span>
    <span class="cm">/**
     * A boolean flag, indicating whether the TD VCPU has been VMLAUNCH’ed
     * on this LP since it has last been associated with this VCPU. If TRUE,
     * VM entry should use VMRESUME. Else, VM entry should use VMLAUNCH.
     */</span>
    <span class="n">bool_t</span>    <span class="n">launched</span><span class="p">;</span>
    <span class="cm">/**
     * Sequential index of the VCPU in the parent TD. VCPU_INDEX indicates the order
     * of VCPU initialization (by TDHVPINIT), starting from 0, and is made available to
     * the TD via TDINFO. VCPU_INDEX is in the range 0 to (MAX_VCPUS_PER_TD - 1)
     */</span>
    <span class="kt">uint32_t</span>  <span class="n">vcpu_index</span><span class="p">;</span>
    <span class="kt">uint8_t</span>   <span class="n">num_tdvpx</span><span class="p">;</span> <span class="cm">/**&lt; A counter of the number of child TDVPX pages associated with this TDVPR */</span>

    <span class="kt">uint8_t</span>   <span class="n">reserved_0</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span> <span class="cm">/**&lt; Reserved for aligning the next field */</span>
    <span class="cm">/**
     * An array of (TDVPS_PAGES) physical address pointers to the TDVPX pages
     *
     * PA is without HKID bits
     * Page 0 is the PA of the TDVPR page
     * Pages 1,2,... are PAs of the TDVPX pages
    */</span>
    <span class="kt">uint64_t</span>  <span class="n">tdvps_pa</span><span class="p">[</span><span class="n">MAX_TDVPS_PAGES</span><span class="p">];</span>
    <span class="cm">/**
     * The (unique hardware-derived identifier) of the logical processor on which this VCPU
     * is currently associated (either by TDHVPENTER or by other VCPU-specific SEAMCALL flow).
     * A value of 0xffffffff (-1 in signed) indicates that VCPU is not associated with any LP.
     * Initialized by TDHVPINIT to the LP_ID on which it ran
     */</span>
    <span class="kt">uint32_t</span>  <span class="n">assoc_lpid</span><span class="p">;</span>
    <span class="cm">/**
     * The TD's ephemeral private HKID at the last time this VCPU was associated (either
     * by TDHVPENTER or by other VCPU-specific SEAMCALL flow) with an LP.
     * Initialized by TDHVPINIT to the current TD ephemeral private HKID.
     */</span>
    <span class="kt">uint32_t</span>  <span class="n">assoc_hkid</span><span class="p">;</span>
    <span class="cm">/**
     * The value of TDCS.TD_EPOCH, sampled at the time this VCPU entered TDX non-root mode
     */</span>
    <span class="kt">uint64_t</span>  <span class="n">vcpu_epoch</span><span class="p">;</span>

    <span class="n">bool_t</span>    <span class="n">cpuid_supervisor_ve</span><span class="p">;</span>
    <span class="n">bool_t</span>    <span class="n">cpuid_user_ve</span><span class="p">;</span>
    <span class="n">bool_t</span>    <span class="n">is_shared_eptp_valid</span><span class="p">;</span>

    <span class="kt">uint8_t</span>   <span class="n">reserved_1</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span> <span class="cm">/**&lt; Reserved for aligning the next field */</span>

    <span class="kt">uint64_t</span>  <span class="n">last_exit_tsc</span><span class="p">;</span>

    <span class="n">bool_t</span>    <span class="n">pend_nmi</span><span class="p">;</span>

    <span class="kt">uint8_t</span>   <span class="n">reserved_2</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span> <span class="cm">/**&lt; Reserved for aligning the next field */</span>

    <span class="kt">uint64_t</span>  <span class="n">xfam</span><span class="p">;</span>
    <span class="kt">uint8_t</span>   <span class="n">last_epf_gpa_list_idx</span><span class="p">;</span>
    <span class="kt">uint8_t</span>   <span class="n">possibly_epf_stepping</span><span class="p">;</span>

    <span class="kt">uint8_t</span>   <span class="n">reserved_3</span><span class="p">[</span><span class="mi">150</span><span class="p">];</span> <span class="cm">/**&lt; Reserved for aligning the next field */</span>

    <span class="kt">uint64_t</span>   <span class="n">last_epf_gpa_list</span><span class="p">[</span><span class="n">EPF_GPA_LIST_SIZE</span><span class="p">];</span>  <span class="c1">// Array of GPAs that caused EPF at this TD vCPU instruction</span>

    <span class="kt">uint8_t</span>   <span class="n">reserved_4</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span> <span class="cm">/**&lt; Reserved for aligning the next field */</span>
<span class="p">}</span> <span class="n">tdvps_management_t</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="allocating-tdvpr-page-and-tdvpx-pages"><span class="me-2">Allocating TDVPR page and TDVPX pages</span><a href="#allocating-tdvpr-page-and-tdvpx-pages" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>VMM should prepare TDVPR and TDVPX pages before it bounds the pages to the VCPU.
tdx_vcpu_create function allocate one TDVPR page and multiple TDVPX pages.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="rouge-code"><pre><span class="mi">634</span> <span class="kt">int</span> <span class="nf">tdx_vcpu_create</span><span class="p">(</span><span class="k">struct</span> <span class="nc">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="mi">635</span> <span class="p">{</span>
<span class="p">......</span>
<span class="mi">648</span>         <span class="n">ret</span> <span class="o">=</span> <span class="n">tdx_alloc_td_page</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tdx</span><span class="o">-&gt;</span><span class="n">tdvpr</span><span class="p">);</span>
<span class="mi">649</span>         <span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
<span class="mi">650</span>                 <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="mi">651</span> 
<span class="mi">652</span>         <span class="n">tdx</span><span class="o">-&gt;</span><span class="n">tdvpx</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">tdx_caps</span><span class="p">.</span><span class="n">tdvpx_nr_pages</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">tdx</span><span class="o">-&gt;</span><span class="n">tdvpx</span><span class="p">),</span>
<span class="mi">653</span>                         <span class="n">GFP_KERNEL_ACCOUNT</span><span class="p">);</span>
<span class="mi">654</span>         <span class="nf">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tdx</span><span class="o">-&gt;</span><span class="n">tdvpx</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">655</span>                 <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="mi">656</span>                 <span class="k">goto</span> <span class="n">free_tdvpr</span><span class="p">;</span>
<span class="mi">657</span>         <span class="p">}</span>
<span class="mi">658</span>         <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tdx_caps</span><span class="p">.</span><span class="n">tdvpx_nr_pages</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">659</span>                 <span class="n">ret</span> <span class="o">=</span> <span class="n">tdx_alloc_td_page</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tdx</span><span class="o">-&gt;</span><span class="n">tdvpx</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="mi">660</span>                 <span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
<span class="mi">661</span>                         <span class="k">goto</span> <span class="n">free_tdvpx</span><span class="p">;</span>
<span class="mi">662</span>         <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>To utilize the created VCPU, the TDX VM should have a <strong>TDVPR</strong> page bound to 
the VCPU assigned to the TD VM. Physical page for TDVPR is allocated when VCPU 
is created. Also note that it allocates multiple physical pages for TDVPX. The
generated TDVPR is used when registering the generated VCPU to specific TD VM 
through TDH_VP_CREATE, which adds a TDVPR page as a child of a TDR page. Also, 
TDH.VP.ADDCX adds a TDVPX page as a child of a given TDVPR (tdh_vp_addcx). We 
will cover when and how the TDVPX pages are initialized based on their semantics
as VMCS for example.</p>

<h3 id="create-vcpu-for-td-vm"><span class="me-2">Create VCPU for TD VM</span><a href="#create-vcpu-for-td-vm" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>Note that we haven’t generated any VCPU instance, but TDVPS page required for
generating TDX VPCU instance. Because the TD VCPU should be belong to one TD VM,
it requires TDR page to denote which TD VM will have the access for the newly 
generated TD VCPU. You will see that TDH_VP_CREATE SEAMCALL receive these two 
data structures to instantiate new VCPU for TDX.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="mi">11148</span> <span class="kt">void</span> <span class="nf">kvm_vcpu_reset</span><span class="p">(</span><span class="k">struct</span> <span class="nc">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">init_event</span><span class="p">)</span>
<span class="p">......</span>
<span class="mi">11230</span>         <span class="n">static_call</span><span class="p">(</span><span class="n">kvm_x86_vcpu_reset</span><span class="p">)(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">init_event</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></div></div>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre> <span class="mi">992</span> <span class="k">static</span> <span class="k">struct</span> <span class="nc">kvm_x86_ops</span> <span class="n">vt_x86_ops</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span>
<span class="p">......</span>
<span class="mi">1008</span>         <span class="p">.</span><span class="n">vcpu_reset</span> <span class="o">=</span> <span class="n">vt_vcpu_reset</span><span class="p">,</span>
</pre></td></tr></tbody></table></code></div></div>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre> <span class="mi">169</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">vt_vcpu_reset</span><span class="p">(</span><span class="k">struct</span> <span class="nc">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">init_event</span><span class="p">)</span>
 <span class="mi">170</span> <span class="p">{</span>
 <span class="mi">171</span>         <span class="k">if</span> <span class="p">(</span><span class="n">is_td_vcpu</span><span class="p">(</span><span class="n">vcpu</span><span class="p">))</span>
 <span class="mi">172</span>                 <span class="k">return</span> <span class="n">tdx_vcpu_reset</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">init_event</span><span class="p">);</span>
 <span class="mi">173</span> 
 <span class="mi">174</span>         <span class="k">return</span> <span class="nf">vmx_vcpu_reset</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">init_event</span><span class="p">);</span>
 <span class="mi">175</span> <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>If current kvm_vcpu indicates that it is VCPU for TD-VM, it invokes 
tdx_vcpu_reset function that calls TDH_VP_CREATE SEAMCALL.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="rouge-code"><pre> <span class="mi">825</span> <span class="kt">void</span> <span class="nf">tdx_vcpu_reset</span><span class="p">(</span><span class="k">struct</span> <span class="nc">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">init_event</span><span class="p">)</span>
 <span class="mi">826</span> <span class="p">{</span>
 <span class="p">......</span>
 <span class="mi">839</span>         <span class="n">err</span> <span class="o">=</span> <span class="n">tdh_vp_create</span><span class="p">(</span><span class="n">kvm_tdx</span><span class="o">-&gt;</span><span class="n">tdr</span><span class="p">.</span><span class="n">pa</span><span class="p">,</span> <span class="n">tdx</span><span class="o">-&gt;</span><span class="n">tdvpr</span><span class="p">.</span><span class="n">pa</span><span class="p">);</span>
 <span class="mi">840</span>         <span class="nf">if</span> <span class="p">(</span><span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="n">err</span><span class="p">))</span> <span class="p">{</span>
 <span class="mi">841</span>                 <span class="n">pr_tdx_error</span><span class="p">(</span><span class="n">TDH_VP_CREATE</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
 <span class="mi">842</span>                 <span class="k">goto</span> <span class="n">td_bugged</span><span class="p">;</span>
 <span class="mi">843</span>         <span class="p">}</span>
 <span class="mi">844</span>         <span class="nf">tdx_mark_td_page_added</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tdx</span><span class="o">-&gt;</span><span class="n">tdvpr</span><span class="p">);</span>
 <span class="mi">845</span> 
 <span class="mi">846</span>         <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tdx_caps</span><span class="p">.</span><span class="n">tdvpx_nr_pages</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
 <span class="mi">847</span>                 <span class="n">err</span> <span class="o">=</span> <span class="n">tdh_vp_addcx</span><span class="p">(</span><span class="n">tdx</span><span class="o">-&gt;</span><span class="n">tdvpr</span><span class="p">.</span><span class="n">pa</span><span class="p">,</span> <span class="n">tdx</span><span class="o">-&gt;</span><span class="n">tdvpx</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pa</span><span class="p">);</span>
 <span class="mi">848</span>                 <span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="n">err</span><span class="p">))</span> <span class="p">{</span>
 <span class="mi">849</span>                         <span class="n">pr_tdx_error</span><span class="p">(</span><span class="n">TDH_VP_ADDCX</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
 <span class="mi">850</span>                         <span class="k">goto</span> <span class="n">td_bugged</span><span class="p">;</span>
 <span class="mi">851</span>                 <span class="p">}</span>
 <span class="mi">852</span>                 <span class="nf">tdx_mark_td_page_added</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tdx</span><span class="o">-&gt;</span><span class="n">tdvpx</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
 <span class="mi">853</span>         <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>The TDH_VP_CREATE SEAMCALL creates the VCPU by registering TDVPR page as a child
of TDR. Note that TDR page is owned by the TDX module, so the TDX module should 
register the TDVPR page as its child. After the TDVPR page is added, because it
is a logical concept, additional TDVPX pages should be added in addition to the 
first TDVPR page by TDH_VP_ADDCX SEAMCALL.</p>

<h3 id="tdx_vp_create-tdx-module-side"><span class="me-2">TDX_VP_CREATE (TDX Module side)</span><a href="#tdx_vp_create-tdx-module-side" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>Because the TDVPR page address is passed from VMM, it needs to be converted into
private page of the TD VM. We already covered how this conversion is done by the
TDX module ([XXX]). After the private mapping is created, the TDVPR page should 
be initialized and registered as a child of TDR. Through this process, the TD
VCPU is created and bound to specific TD VM.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre></td><td class="rouge-code"><pre><span class="n">api_error_type</span> <span class="nf">tdh_vp_create</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">target_tdvpr_pa</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="n">target_tdr_pa</span><span class="p">)</span>
<span class="p">{</span>
    <span class="p">......</span>
    <span class="c1">// Check, lock and map the new TDVPR page</span>
    <span class="n">return_val</span> <span class="o">=</span> <span class="n">check_lock_and_map_explicit_private_4k_hpa</span><span class="p">(</span><span class="n">tdvpr_pa</span><span class="p">,</span>
                                                            <span class="n">OPERAND_ID_RCX</span><span class="p">,</span>
                                                            <span class="n">tdr_ptr</span><span class="p">,</span>
                                                            <span class="n">TDX_RANGE_RW</span><span class="p">,</span>
                                                            <span class="n">TDX_LOCK_EXCLUSIVE</span><span class="p">,</span>
                                                            <span class="n">PT_NDA</span><span class="p">,</span>
                                                            <span class="o">&amp;</span><span class="n">tdvpr_pamt_block</span><span class="p">,</span>
                                                            <span class="o">&amp;</span><span class="n">tdvpr_pamt_entry_ptr</span><span class="p">,</span>
                                                            <span class="o">&amp;</span><span class="n">tdvpr_locked_flag</span><span class="p">,</span>
                                                            <span class="p">(</span><span class="kt">void</span><span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">tdvps_ptr</span><span class="p">);</span>

    <span class="p">......</span>
    <span class="n">tdvps_ptr</span><span class="o">-&gt;</span><span class="n">management</span><span class="p">.</span><span class="n">assoc_lpid</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="n">tdvps_ptr</span><span class="o">-&gt;</span><span class="n">management</span><span class="p">.</span><span class="n">tdvps_pa</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">tdvpr_pa</span><span class="p">.</span><span class="n">raw</span><span class="p">;</span>

    <span class="c1">// Register the new TDVPR page in its owner TDR</span>
    <span class="n">_lock_xadd_64b</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">tdr_ptr</span><span class="o">-&gt;</span><span class="n">management_fields</span><span class="p">.</span><span class="n">chldcnt</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>

    <span class="c1">// Set the new TDVPR page PAMT fields</span>
    <span class="n">tdvpr_pamt_entry_ptr</span><span class="o">-&gt;</span><span class="n">pt</span> <span class="o">=</span> <span class="n">PT_TDVPR</span><span class="p">;</span>
    <span class="n">set_pamt_entry_owner</span><span class="p">(</span><span class="n">tdvpr_pamt_entry_ptr</span><span class="p">,</span> <span class="n">tdr_pa</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="tdh_vp_addcx-tdx-module-side"><span class="me-2">TDH_VP_ADDCX (TDX Module side)</span><a href="#tdh_vp_addcx-tdx-module-side" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>Physically the TDVPR page consists of multiple TDVPX pages, and the TDH_VP_ADDCX
adds the TDVPX page as the child of TDVPR. Note that this function receives the 
TDVPR and TDVPX page not the TDR page.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
</pre></td><td class="rouge-code"><pre><span class="n">api_error_type</span> <span class="nf">tdh_vp_addcx</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">target_tdvpx_pa</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="n">target_tdvpr_pa</span><span class="p">)</span>
<span class="p">{</span>
    <span class="p">......</span>
    <span class="c1">// Check and lock the parent TDVPR page</span>
    <span class="n">return_val</span> <span class="o">=</span> <span class="n">check_and_lock_explicit_4k_private_hpa</span><span class="p">(</span><span class="n">tdvpr_pa</span><span class="p">,</span>
                                                         <span class="n">OPERAND_ID_RDX</span><span class="p">,</span>
                                                         <span class="n">TDX_LOCK_EXCLUSIVE</span><span class="p">,</span>
                                                         <span class="n">PT_TDVPR</span><span class="p">,</span>
                                                         <span class="o">&amp;</span><span class="n">tdvpr_pamt_block</span><span class="p">,</span>
                                                         <span class="o">&amp;</span><span class="n">tdvpr_pamt_entry_ptr</span><span class="p">,</span>
                                                         <span class="o">&amp;</span><span class="n">page_leaf_size</span><span class="p">,</span>
                                                         <span class="o">&amp;</span><span class="n">tdvpr_locked_flag</span><span class="p">);</span>
    <span class="c1">// Get and lock the owner TDR page                   </span>
    <span class="n">tdr_pa</span> <span class="o">=</span> <span class="n">get_pamt_entry_owner</span><span class="p">(</span><span class="n">tdvpr_pamt_entry_ptr</span><span class="p">);</span> 
    <span class="n">return_val</span> <span class="o">=</span> <span class="n">lock_and_map_implicit_tdr</span><span class="p">(</span><span class="n">tdr_pa</span><span class="p">,</span>       
                                           <span class="n">OPERAND_ID_TDR</span><span class="p">,</span>
                                           <span class="n">TDX_RANGE_RW</span><span class="p">,</span> 
                                           <span class="n">TDX_LOCK_SHARED</span><span class="p">,</span>
                                           <span class="o">&amp;</span><span class="n">tdr_pamt_entry_ptr</span><span class="p">,</span>
                                           <span class="o">&amp;</span><span class="n">tdr_locked_flag</span><span class="p">,</span>
                                           <span class="o">&amp;</span><span class="n">tdr_ptr</span><span class="p">);</span>
    <span class="p">......</span>
    <span class="c1">// Map the TDVPS structure.  Note that only the 1st page (TDVPR) is</span>
    <span class="c1">// accessible at this point.</span>
    <span class="n">tdvps_ptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">tdvps_t</span><span class="o">*</span><span class="p">)</span><span class="n">map_pa</span><span class="p">((</span><span class="kt">void</span><span class="o">*</span><span class="p">)(</span><span class="n">set_hkid_to_pa</span><span class="p">(</span><span class="n">tdvpr_pa</span><span class="p">,</span> <span class="n">td_hkid</span><span class="p">).</span><span class="n">full_pa</span><span class="p">),</span> <span class="n">TDX_RANGE_RW</span><span class="p">);</span>

    <span class="p">......</span>
    <span class="c1">// Check, lock and map the new TDVPX page</span>
    <span class="n">return_val</span> <span class="o">=</span> <span class="n">check_lock_and_map_explicit_private_4k_hpa</span><span class="p">(</span><span class="n">tdvpx_pa</span><span class="p">,</span>
                                                            <span class="n">OPERAND_ID_RCX</span><span class="p">,</span>
                                                            <span class="n">tdr_ptr</span><span class="p">,</span>
                                                            <span class="n">TDX_RANGE_RW</span><span class="p">,</span>
                                                            <span class="n">TDX_LOCK_EXCLUSIVE</span><span class="p">,</span>
                                                            <span class="n">PT_NDA</span><span class="p">,</span>
                                                            <span class="o">&amp;</span><span class="n">tdvpx_pamt_block</span><span class="p">,</span>
                                                            <span class="o">&amp;</span><span class="n">tdvpx_pamt_entry_ptr</span><span class="p">,</span>
                                                            <span class="o">&amp;</span><span class="n">tdvpx_locked_flag</span><span class="p">,</span>
                                                            <span class="p">(</span><span class="kt">void</span><span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">tdvpx_ptr</span><span class="p">);</span>
    <span class="p">......</span>
    <span class="c1">// Clear the content of the TDVPX page using direct writes</span>
    <span class="n">zero_area_cacheline</span><span class="p">(</span><span class="n">tdvpx_ptr</span><span class="p">,</span> <span class="n">TDX_PAGE_SIZE_IN_BYTES</span><span class="p">);</span>

    <span class="c1">// Register the new TDVPX in its parent TDVPS structure</span>
    <span class="c1">// Note that tdvpx_pa[0] is the PA of TDVPR, so TDVPX</span>
    <span class="c1">// pages start from index 1</span>
    <span class="n">tdvpx_index_num</span><span class="o">++</span><span class="p">;</span>
    <span class="n">tdvps_ptr</span><span class="o">-&gt;</span><span class="n">management</span><span class="p">.</span><span class="n">num_tdvpx</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span><span class="n">tdvpx_index_num</span><span class="p">;</span>
    <span class="n">tdvps_ptr</span><span class="o">-&gt;</span><span class="n">management</span><span class="p">.</span><span class="n">tdvps_pa</span><span class="p">[</span><span class="n">tdvpx_index_num</span><span class="p">]</span> <span class="o">=</span> <span class="n">tdvpx_pa</span><span class="p">.</span><span class="n">raw</span><span class="p">;</span>

    <span class="c1">// Register the new TDVPX page in its owner TDR</span>
    <span class="n">_lock_xadd_64b</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">tdr_ptr</span><span class="o">-&gt;</span><span class="n">management_fields</span><span class="p">.</span><span class="n">chldcnt</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>

    <span class="c1">// Set the new TDVPX page PAMT fields</span>
    <span class="n">tdvpx_pamt_entry_ptr</span><span class="o">-&gt;</span><span class="n">pt</span> <span class="o">=</span> <span class="n">PT_TDVPX</span><span class="p">;</span>
    <span class="n">set_pamt_entry_owner</span><span class="p">(</span><span class="n">tdvpx_pamt_entry_ptr</span><span class="p">,</span> <span class="n">tdr_pa</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Because the TDVPR page has been initialized and registered as a private page for
the TD VM before in the TDH_VP_CREATE SEMCALL, its corresponding PAMT block will
be also retrieved as a result of the check_and_lock_explicit_4k_private_hpa func.
Because each PAMT entry memorize owner TD VM where the physical address mapped 
by the PAMT belongs to, it can easily retrieve its owner, the TDR. It also maps 
TDVPR and TDVPX, but because TDVPX is mapped to private page first time, mapping
is done by map_pa and check_lock_and_map_explicit_private_4k_hpa, respectively.
It updates the TDVPR and initialize TDVPX page. Note that still each TDVPX page
is not initialized. We will see how each TDVPX page will be initialized to carry
VCPU information.</p>

<h3 id="initialize-registered-vcpu-tdh_vp_init"><span class="me-2">Initialize registered VCPU (TDH_VP_INIT)</span><a href="#initialize-registered-vcpu-tdh_vp_init" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>After adding all VCPU related physical pages to the TD VM, it is ready for VCPU
initialization. When the TDX module finish initialization of VCPU of the TD VM, 
the status of the VM is changed to <strong>initialized</strong>.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre><span class="mi">2472</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">tdx_vcpu_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="nc">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">argp</span><span class="p">)</span>
<span class="p">......</span>
<span class="mi">2488</span>         <span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">metadata</span> <span class="o">||</span> <span class="n">cmd</span><span class="p">.</span><span class="n">id</span> <span class="o">!=</span> <span class="n">KVM_TDX_INIT_VCPU</span><span class="p">)</span>
<span class="mi">2489</span>                 <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="mi">2490</span> 
<span class="mi">2491</span>         <span class="n">err</span> <span class="o">=</span> <span class="n">tdh_vp_init</span><span class="p">(</span><span class="n">tdx</span><span class="o">-&gt;</span><span class="n">tdvpr</span><span class="p">.</span><span class="n">pa</span><span class="p">,</span> <span class="n">cmd</span><span class="p">.</span><span class="n">data</span><span class="p">);</span>
<span class="mi">2492</span>         <span class="k">if</span> <span class="p">(</span><span class="n">TDX_ERR</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">TDH_VP_INIT</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span>
<span class="mi">2493</span>                 <span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="mi">2494</span> 
<span class="mi">2495</span>         <span class="n">tdx</span><span class="o">-&gt;</span><span class="n">initialized</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="mi">2496</span> 
<span class="mi">2497</span>         <span class="nf">td_vmcs_write16</span><span class="p">(</span><span class="n">tdx</span><span class="p">,</span> <span class="n">POSTED_INTR_NV</span><span class="p">,</span> <span class="n">POSTED_INTR_VECTOR</span><span class="p">);</span>
<span class="mi">2498</span>         <span class="nf">td_vmcs_write64</span><span class="p">(</span><span class="n">tdx</span><span class="p">,</span> <span class="n">POSTED_INTR_DESC_ADDR</span><span class="p">,</span> <span class="n">__pa</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tdx</span><span class="o">-&gt;</span><span class="n">pi_desc</span><span class="p">));</span>
<span class="mi">2499</span>         <span class="nf">td_vmcs_setbit32</span><span class="p">(</span><span class="n">tdx</span><span class="p">,</span> <span class="n">PIN_BASED_VM_EXEC_CONTROL</span><span class="p">,</span> <span class="n">PIN_BASED_POSTED_INTR</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></div></div>
<p>It invokes tdh_vp_init function which invokes TDH_VP_INIT SEAMCALL. We can say 
that The VCPU initialization is equal to TDVPR page initialization. Let’s see 
how TDX Module initializes the TDVPR pages and related data structures used to 
manage TDVPS.</p>

<h3 id="initialize-tdvps-page"><span class="me-2">Initialize TDVPS page</span><a href="#initialize-tdvps-page" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre></td><td class="rouge-code"><pre><span class="k">typedef</span> <span class="k">enum</span>
<span class="p">{</span>   
    <span class="n">TDVPS_VE_INFO_PAGE_INDEX</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">TDVPS_VMCS_PAGE_INDEX</span>    <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">TDVPS_VAPIC_PAGE_INDEX</span>   <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
    <span class="n">MAX_TDVPS_PAGES</span>          <span class="o">=</span> <span class="mi">6</span>
<span class="p">}</span> <span class="n">tdvps_pages_e</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="nc">ALIGN</span><span class="p">(</span><span class="n">TDX_PAGE_SIZE_IN_BYTES</span><span class="p">)</span> <span class="n">tdvps_s</span>            
<span class="p">{</span>   
    <span class="n">tdvps_ve_info_t</span>                <span class="n">ve_info</span><span class="p">;</span>
    <span class="kt">uint8_t</span>                        <span class="n">reserved_0</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span> <span class="cm">/**&lt; Reserved for aligning the next field */</span>
    <span class="n">tdvps_management_t</span>             <span class="n">management</span><span class="p">;</span>
    <span class="n">tdvps_guest_state_t</span>            <span class="n">guest_state</span><span class="p">;</span>
    <span class="n">tdvps_guest_msr_state_t</span>        <span class="n">guest_msr_state</span><span class="p">;</span>
    
    <span class="kt">uint8_t</span>                        <span class="n">reserved_1</span><span class="p">[</span><span class="mi">2432</span><span class="p">];</span> <span class="cm">/**&lt; Reserved for aligning the next field */</span>
    
    <span class="n">tdvps_td_vmcs_t</span>                <span class="n">td_vmcs</span><span class="p">;</span>
    <span class="kt">uint8_t</span>                        <span class="n">reserved_2</span><span class="p">[</span><span class="n">TDX_PAGE_SIZE_IN_BYTES</span> <span class="o">-</span> <span class="n">SIZE_OF_TD_VMCS_IN_BYTES</span><span class="p">];</span> <span class="cm">/**&lt; Reserved for aligning the next field */</span>

    <span class="n">tdvps_vapic_t</span>                  <span class="n">vapic</span><span class="p">;</span>
    <span class="n">tdvps_guest_extension_state_t</span>  <span class="n">guest_extension_state</span><span class="p">;</span>
<span class="p">}</span> <span class="n">tdvps_t</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></div></div>

<p>TDVPS page can semantically be divided into 3 different pages as shown in the 
tdvps_pages_e: VE_INFO, VMCS, VAPIC page. Let’s see how TDX Module functions 
initialize those three pages as a part of TDH_VP_INIT SEAMCALL.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
</pre></td><td class="rouge-code"><pre><span class="n">api_error_type</span> <span class="nf">tdh_vp_init</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">target_tdvpr_pa</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="n">td_vcpu_rcx</span><span class="p">)</span>
<span class="p">{</span>
    <span class="p">......</span>
    <span class="c1">// Get the TD's ephemeral HKID</span>
    <span class="n">curr_hkid</span> <span class="o">=</span> <span class="n">tdr_ptr</span><span class="o">-&gt;</span><span class="n">key_management_fields</span><span class="p">.</span><span class="n">hkid</span><span class="p">;</span>

    <span class="c1">// Map the multi-page TDVPS structure</span>
    <span class="n">tdvps_ptr</span> <span class="o">=</span> <span class="n">map_tdvps</span><span class="p">(</span><span class="n">tdvpr_pa</span><span class="p">,</span> <span class="n">curr_hkid</span><span class="p">,</span> <span class="n">TDX_RANGE_RW</span><span class="p">);</span>
    <span class="p">......</span>

    <span class="cm">/**
     *  Initialize the TD VCPU GPRs.  Default GPR value is 0.
     *  Initialize the TD VCPU non-GPR register state in TDVPS:
     *  CRs, DRs, XCR0, IWK etc.
     */</span>
    <span class="n">init_vcpu_gprs_and_registers</span><span class="p">(</span><span class="n">tdvps_ptr</span><span class="p">,</span> <span class="n">tdcs_ptr</span><span class="p">,</span> <span class="n">init_rcx</span><span class="p">,</span> <span class="n">vcpu_index</span><span class="p">);</span>

    <span class="cm">/**
     *  Initialize the TD VCPU MSR state in TDVPS
     */</span>
    <span class="n">init_vcpu_msrs</span><span class="p">(</span><span class="n">tdvps_ptr</span><span class="p">);</span>

    <span class="cm">/**
     *  No need to explicitly initialize TD VCPU extended state pages.
     *  Since the pages are initialized to 0 on TDHVPCREATE/TDVPADDCX.
     */</span>

    <span class="c1">// Bit 63 of XCOMP_BV should be set to 1, to indicate compact format.</span>
    <span class="c1">// Otherwise XSAVES and XRSTORS won't work</span>
    <span class="n">tdvps_ptr</span><span class="o">-&gt;</span><span class="n">guest_extension_state</span><span class="p">.</span><span class="n">xbuf</span><span class="p">.</span><span class="n">xsave_header</span><span class="p">.</span><span class="n">xcomp_bv</span> <span class="o">=</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">63</span><span class="p">);</span>

    <span class="c1">// Initialize TDVPS.LBR_DEPTH to MAX_LBR_DEPTH supported on the core</span>
    <span class="k">if</span> <span class="p">(((</span><span class="n">ia32_xcr0_t</span><span class="p">)</span><span class="n">tdcs_ptr</span><span class="o">-&gt;</span><span class="n">executions_ctl_fields</span><span class="p">.</span><span class="n">xfam</span><span class="p">).</span><span class="n">lbr</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">tdvps_ptr</span><span class="o">-&gt;</span><span class="n">guest_msr_state</span><span class="p">.</span><span class="n">ia32_lbr_depth</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint64_t</span><span class="p">)</span><span class="n">get_global_data</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">max_lbr_depth</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="cm">/**
     *  No need to explicitly initialize VAPIC page.
     *  Since the pages are initialized to 0 on TDHVPCREATE/TDVPADDCX,
     *  VAPIC page is already 0.
     */</span>
</pre></td></tr></tbody></table></code></div></div>
<p>Note that it receives cmd.data which will be set as an initial RCX value of the
VCPU. This RCX value will be used when VBIOS initially starts from TD VM.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
</pre></td><td class="rouge-code"><pre>
<span class="n">_STATIC_INLINE_</span> <span class="kt">void</span> <span class="nf">init_vcpu_gprs_and_registers</span><span class="p">(</span><span class="n">tdvps_t</span> <span class="o">*</span> <span class="n">tdvps_ptr</span><span class="p">,</span> <span class="n">tdcs_t</span> <span class="o">*</span> <span class="n">tdcs_ptr</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="n">init_rcx</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">vcpu_index</span><span class="p">)</span>
<span class="p">{</span>
    <span class="cm">/**
     *  GPRs init
     */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">tdcs_ptr</span><span class="o">-&gt;</span><span class="n">executions_ctl_fields</span><span class="p">.</span><span class="n">gpaw</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">tdvps_ptr</span><span class="o">-&gt;</span><span class="n">guest_state</span><span class="p">.</span><span class="n">rbx</span> <span class="o">=</span> <span class="n">MAX_PA_FOR_GPAW</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="n">tdvps_ptr</span><span class="o">-&gt;</span><span class="n">guest_state</span><span class="p">.</span><span class="n">rbx</span> <span class="o">=</span> <span class="n">MAX_PA_FOR_GPA_NOT_WIDE</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">// Set RCX and R8 to the input parameter's value</span>
    <span class="n">tdvps_ptr</span><span class="o">-&gt;</span><span class="n">guest_state</span><span class="p">.</span><span class="n">rcx</span> <span class="o">=</span> <span class="n">init_rcx</span><span class="p">;</span>
    <span class="n">tdvps_ptr</span><span class="o">-&gt;</span><span class="n">guest_state</span><span class="p">.</span><span class="n">r8</span> <span class="o">=</span> <span class="n">init_rcx</span><span class="p">;</span>

    <span class="c1">// CPUID(1).EAX - returns Family/Model/Stepping in EAX - take the saved value by TDHSYSINIT</span>
    <span class="n">tdx_debug_assert</span><span class="p">(</span><span class="n">get_cpuid_lookup_entry</span><span class="p">(</span><span class="mh">0x1</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">MAX_NUM_CPUID_LOOKUP</span><span class="p">);</span>
    <span class="n">tdvps_ptr</span><span class="o">-&gt;</span><span class="n">guest_state</span><span class="p">.</span><span class="n">rdx</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint64_t</span><span class="p">)</span><span class="n">get_global_data</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">cpuid_values</span><span class="p">[</span><span class="n">get_cpuid_lookup_entry</span><span class="p">(</span><span class="mh">0x1</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">)].</span><span class="n">values</span><span class="p">.</span><span class="n">eax</span><span class="p">;</span>

    <span class="cm">/**
     *  Registers init
     */</span>
    <span class="n">tdvps_ptr</span><span class="o">-&gt;</span><span class="n">guest_state</span><span class="p">.</span><span class="n">xcr0</span> <span class="o">=</span> <span class="n">XCR0_RESET_STATE</span><span class="p">;</span>
    <span class="n">tdvps_ptr</span><span class="o">-&gt;</span><span class="n">guest_state</span><span class="p">.</span><span class="n">dr6</span> <span class="o">=</span> <span class="n">DR6_RESET_STATE</span><span class="p">;</span>


    <span class="c1">// Set RSI to the VCPU index</span>
    <span class="n">tdvps_ptr</span><span class="o">-&gt;</span><span class="n">guest_state</span><span class="p">.</span><span class="n">rsi</span> <span class="o">=</span> <span class="n">vcpu_index</span> <span class="o">&amp;</span> <span class="n">BITS</span><span class="p">(</span><span class="mi">31</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>

    <span class="cm">/**
     *  All other GPRs/Registers are set to 0 or
     *  that their INIT state is 0
     *  Doesn’t include values initialized in VMCS
     */</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="vmcs-initialization"><span class="me-2">VMCS initialization</span><a href="#vmcs-initialization" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>The most important page of the TDVPS is VMCS of the TD VCPU. It is literally 
identical with the VMCS for vanilla VM VCPU. Let’s see how the TDX Module sets
up VMCS structure for TD VCPU.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
</pre></td><td class="rouge-code"><pre>    <span class="n">vmcs_pa</span> <span class="o">=</span> <span class="n">set_hkid_to_pa</span><span class="p">((</span><span class="n">pa_t</span><span class="p">)</span><span class="n">tdvps_ptr</span><span class="o">-&gt;</span><span class="n">management</span><span class="p">.</span><span class="n">tdvps_pa</span><span class="p">[</span><span class="n">TDVPS_VMCS_PAGE_INDEX</span><span class="p">],</span> <span class="n">curr_hkid</span><span class="p">);</span>

    <span class="cm">/**
     *  Map the TD VMCS page.
     *
     *  @note This is the only place the VMCS page is directly accessed.
     */</span>
    <span class="n">vmcs_ptr</span> <span class="o">=</span> <span class="n">map_pa</span><span class="p">((</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">vmcs_pa</span><span class="p">.</span><span class="n">raw</span><span class="p">,</span> <span class="n">TDX_RANGE_RW</span><span class="p">);</span>
    <span class="n">vmcs_ptr</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">.</span><span class="n">vmcs_revision_identifier</span> <span class="o">=</span>
            <span class="n">get_global_data</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">plt_common_config</span><span class="p">.</span><span class="n">ia32_vmx_basic</span><span class="p">.</span><span class="n">vmcs_revision_id</span><span class="p">;</span>

    <span class="c1">// Clear the TD VMCS</span>
    <span class="n">ia32_vmclear</span><span class="p">((</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">vmcs_pa</span><span class="p">.</span><span class="n">raw</span><span class="p">);</span>

    <span class="cm">/**
     *  No need to explicitly initialize VE_INFO.
     *  Since the pages are initialized to 0 on TDHVPCREATE/TDVPADDCX,
     *  VE_INFO.VALID is already 0.
     */</span>

    <span class="c1">// Mark the VCPU as initialized and ready</span>
    <span class="n">tdvps_ptr</span><span class="o">-&gt;</span><span class="n">management</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">VCPU_READY_ASYNC</span><span class="p">;</span>

    <span class="cm">/**
     *  Save the host VMCS fields before going to TD VMCS context
     */</span>
    <span class="n">save_vmcs_host_fields</span><span class="p">(</span><span class="o">&amp;</span><span class="n">td_vmcs_host_values</span><span class="p">);</span>


    <span class="cm">/**
     *  Associate the VCPU - no checks required
     */</span>
    <span class="n">associate_vcpu_initial</span><span class="p">(</span><span class="n">tdvps_ptr</span><span class="p">,</span> <span class="n">tdcs_ptr</span><span class="p">,</span> <span class="n">tdr_ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">td_vmcs_host_values</span><span class="p">);</span>
    <span class="n">td_vmcs_loaded</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

    <span class="cm">/**
     *  Initialize the TD VMCS fields
     */</span>
    <span class="n">init_td_vmcs</span><span class="p">(</span><span class="n">tdcs_ptr</span><span class="p">,</span> <span class="n">tdvps_ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">td_vmcs_host_values</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Because TDX Module doesn’t manage the virtual mapping of all physical pages of 
the meta data of one TD VM, it should be mapped first and should retrieve a 
virtual address for TD VMCS page. The management structure maintain physical 
pages of the TDVPS pages. After the mapping is done, init_td_vmcs initializes 
VMCS for TD VCPU.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="rouge-code"><pre><span class="kt">void</span> <span class="nf">save_vmcs_host_fields</span><span class="p">(</span><span class="n">vmcs_host_values_t</span><span class="o">*</span> <span class="n">host_fields_ptr</span><span class="p">)</span>
<span class="p">{</span>   
    <span class="n">read_vmcs_field_info</span><span class="p">(</span><span class="n">VMX_HOST_CR0_ENCODE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">host_fields_ptr</span><span class="o">-&gt;</span><span class="n">CR0</span><span class="p">);</span>
    <span class="n">read_vmcs_field_info</span><span class="p">(</span><span class="n">VMX_HOST_CR3_ENCODE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">host_fields_ptr</span><span class="o">-&gt;</span><span class="n">CR3</span><span class="p">);</span>
    <span class="n">read_vmcs_field_info</span><span class="p">(</span><span class="n">VMX_HOST_CR4_ENCODE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">host_fields_ptr</span><span class="o">-&gt;</span><span class="n">CR4</span><span class="p">);</span>
    <span class="n">read_vmcs_field_info</span><span class="p">(</span><span class="n">VMX_HOST_CS_SELECTOR_ENCODE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">host_fields_ptr</span><span class="o">-&gt;</span><span class="n">CS</span><span class="p">);</span>
    <span class="n">read_vmcs_field_info</span><span class="p">(</span><span class="n">VMX_HOST_SS_SELECTOR_ENCODE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">host_fields_ptr</span><span class="o">-&gt;</span><span class="n">SS</span><span class="p">);</span>
    <span class="n">read_vmcs_field_info</span><span class="p">(</span><span class="n">VMX_HOST_FS_SELECTOR_ENCODE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">host_fields_ptr</span><span class="o">-&gt;</span><span class="n">FS</span><span class="p">);</span>
    <span class="n">read_vmcs_field_info</span><span class="p">(</span><span class="n">VMX_HOST_GS_SELECTOR_ENCODE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">host_fields_ptr</span><span class="o">-&gt;</span><span class="n">GS</span><span class="p">);</span>
    <span class="n">read_vmcs_field_info</span><span class="p">(</span><span class="n">VMX_HOST_TR_SELECTOR_ENCODE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">host_fields_ptr</span><span class="o">-&gt;</span><span class="n">TR</span><span class="p">);</span>
    <span class="n">read_vmcs_field_info</span><span class="p">(</span><span class="n">VMX_HOST_IA32_S_CET_ENCODE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">host_fields_ptr</span><span class="o">-&gt;</span><span class="n">IA32_S_CET</span><span class="p">);</span>
    <span class="n">read_vmcs_field_info</span><span class="p">(</span><span class="n">VMX_HOST_SSP_ENCODE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">host_fields_ptr</span><span class="o">-&gt;</span><span class="n">SSP</span><span class="p">);</span>
    <span class="n">read_vmcs_field_info</span><span class="p">(</span><span class="n">VMX_HOST_IA32_PAT_FULL_ENCODE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">host_fields_ptr</span><span class="o">-&gt;</span><span class="n">IA32_PAT</span><span class="p">);</span>
    <span class="n">read_vmcs_field_info</span><span class="p">(</span><span class="n">VMX_HOST_IA32_EFER_FULL_ENCODE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">host_fields_ptr</span><span class="o">-&gt;</span><span class="n">IA32_EFER</span><span class="p">);</span>
    <span class="n">read_vmcs_field_info</span><span class="p">(</span><span class="n">VMX_HOST_FS_BASE_ENCODE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">host_fields_ptr</span><span class="o">-&gt;</span><span class="n">FS_BASE</span><span class="p">);</span>
    <span class="n">read_vmcs_field_info</span><span class="p">(</span><span class="n">VMX_HOST_RSP_ENCODE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">host_fields_ptr</span><span class="o">-&gt;</span><span class="n">RSP</span><span class="p">);</span>
    <span class="n">read_vmcs_field_info</span><span class="p">(</span><span class="n">VMX_HOST_GS_BASE_ENCODE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">host_fields_ptr</span><span class="o">-&gt;</span><span class="n">GS_BASE</span><span class="p">);</span>
<span class="p">}</span>            
</pre></td></tr></tbody></table></code></div></div>

<p>VMCS needs to be configured for two interfaces, host to VM and VM to host. The 
all required information to control VM to host interface is maintained by the 
TDX Module. Recall that we are still in the VMX root operation while the TDX 
Module executes. Also, <strong>VMREAD</strong> instruction reads from the current VMCS when 
the processor runs as VMX root operation. If executed in VMX non-root operation, 
the instruction reads from the VMCS referenced by the VMCS link pointer field in
the current VMCS.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
</pre></td><td class="rouge-code"><pre><span class="kt">void</span> <span class="nf">associate_vcpu_initial</span><span class="p">(</span><span class="n">tdvps_t</span> <span class="o">*</span> <span class="n">tdvps_ptr</span><span class="p">,</span>
                            <span class="n">tdcs_t</span> <span class="o">*</span> <span class="n">tdcs_ptr</span><span class="p">,</span>
                            <span class="n">tdr_t</span> <span class="o">*</span> <span class="n">tdr_ptr</span><span class="p">,</span>
                            <span class="n">vmcs_host_values_t</span> <span class="o">*</span> <span class="n">host_values</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">uint32_t</span>         <span class="n">curr_lp_id</span> <span class="o">=</span> <span class="n">get_local_data</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">lp_info</span><span class="p">.</span><span class="n">lp_id</span><span class="p">;</span>
    <span class="kt">uint16_t</span>         <span class="n">curr_hkid</span><span class="p">;</span>
    <span class="n">pa_t</span>             <span class="n">vmcs_addr</span><span class="p">;</span>
    
    <span class="n">tdvps_ptr</span><span class="o">-&gt;</span><span class="n">management</span><span class="p">.</span><span class="n">assoc_lpid</span> <span class="o">=</span> <span class="n">curr_lp_id</span><span class="p">;</span>
    
        
    <span class="n">curr_hkid</span> <span class="o">=</span> <span class="n">tdr_ptr</span><span class="o">-&gt;</span><span class="n">key_management_fields</span><span class="p">.</span><span class="n">hkid</span><span class="p">;</span>
    
    <span class="c1">// Set the TD VMCS as the current VMCS</span>
    <span class="n">vmcs_addr</span> <span class="o">=</span> <span class="n">set_hkid_to_pa</span><span class="p">((</span><span class="n">pa_t</span><span class="p">)</span><span class="n">tdvps_ptr</span><span class="o">-&gt;</span><span class="n">management</span><span class="p">.</span><span class="n">tdvps_pa</span><span class="p">[</span><span class="n">TDVPS_VMCS_PAGE_INDEX</span><span class="p">],</span> <span class="n">curr_hkid</span><span class="p">);</span>
        
    <span class="n">ia32_vmptrld</span><span class="p">((</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">vmcs_addr</span><span class="p">.</span><span class="n">raw</span><span class="p">);</span>
    
    <span class="cm">/**
     *  Update multiple TD VMCS physical address fields with the new HKID.
     */</span> 
    <span class="n">init_guest_td_address_fields</span><span class="p">(</span><span class="n">tdr_ptr</span><span class="p">,</span> <span class="n">tdvps_ptr</span><span class="p">,</span> <span class="n">curr_hkid</span><span class="p">);</span>
    
    <span class="cm">/**
     *  Update the TD VMCS LP-dependent host state fields.
     *  Applicable fields are HOST_RSP, HOST_SSP and HOST_GS_BASE
     */</span> 
    <span class="n">ia32_vmwrite</span><span class="p">(</span><span class="n">host_values</span><span class="o">-&gt;</span><span class="n">RSP</span><span class="p">.</span><span class="n">encoding</span><span class="p">,</span> <span class="n">host_values</span><span class="o">-&gt;</span><span class="n">RSP</span><span class="p">.</span><span class="n">value</span><span class="p">);</span>
    <span class="n">ia32_vmwrite</span><span class="p">(</span><span class="n">host_values</span><span class="o">-&gt;</span><span class="n">SSP</span><span class="p">.</span><span class="n">encoding</span><span class="p">,</span> <span class="n">host_values</span><span class="o">-&gt;</span><span class="n">SSP</span><span class="p">.</span><span class="n">value</span><span class="p">);</span>
    <span class="n">ia32_vmwrite</span><span class="p">(</span><span class="n">host_values</span><span class="o">-&gt;</span><span class="n">GS_BASE</span><span class="p">.</span><span class="n">encoding</span><span class="p">,</span> <span class="n">host_values</span><span class="o">-&gt;</span><span class="n">GS_BASE</span><span class="p">.</span><span class="n">value</span><span class="p">);</span>

    <span class="c1">// Atomically increment the number of associated VCPUs</span>
    <span class="n">_lock_xadd_32b</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">tdcs_ptr</span><span class="o">-&gt;</span><span class="n">management_fields</span><span class="p">.</span><span class="n">num_assoc_vcpus</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>To initialize the TD VMCS of the target TD, the VMCS should be first loaded into
the processor. It retrieves the VMCS from the tdvps and run <strong>vmptrld</strong> inst to 
switch VCPU of TDX Module to VCPU of TD VM.</p>

<p>After switching the VCPU the most of the VCPU initialization is done by the func
init_td_vmcs. I will not cover the details, but previously stored host registers
SEAM VMCS will be written to TD VMCS’s host registers because VM EXIT from the 
TD should jump to the TDX Module. Also the initialization includes private EPTP.
Note that the EPTP address is stored in the TDCS (refer to <a href="/posts/TD-VM-LIFECYCLE-1/">part 1</a>). 
However, note that the entire EPTP has not been initialized, but the root.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="cp">#define VMX_GUEST_EPT_POINTER_FULL_ENCODE  0x201AULL
#define VMX_GUEST_EPT_POINTER_HIGH_ENCODE  0x201bULL
#define VMX_GUEST_SHARED_EPT_POINTER_FULL_ENCODE  0x203C
#define VMX_GUEST_SHARED_EPT_POINTER_HIGH_ENCODE  0x203D
</span></pre></td></tr></tbody></table></code></div></div>

<p>Also, note that there are two different types of EPTP for TD VM. For that VMCS 
needs to be updated to contain pointers of shared and private EPTP. The private 
EPTP should be protected from the non-TD software layers, so it should be 
initialized by the TDX Module and written to VMCS through TDH_VP_INIT. However,
the shared EPTP is provided by the Host VMM (see detail in <a href="/posts/TD-VM-LIFECYCLE-3/">part 3</a>), 
and it doesn’t need to be secure. The purpose of shared EPTP is for sharing data
with host VMM. Therefore, another SEAMCALL is used to write the VMCS located in t
he TDX memory (TDH.VP.WR).</p>

<h2 id="read-write-to-td-vmcs-from-host-vmm"><span class="me-2">Read Write to TD VMCS from Host VMM</span><a href="#read-write-to-td-vmcs-from-host-vmm" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<p>Based on the debugging mode or production mode, TDX allows the VMM to read/write
some pages belong to TD VM, for example, TDVPS and VMCS. For this, TDX provides 
two SEAMCALL: TDH.VP.RD and TDH.VP.WR. To utilize the two SEAMCALL, KVM defines
below macro functions.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
</pre></td><td class="rouge-code"><pre><span class="mi">199</span> <span class="err">#</span><span class="n">define</span> <span class="n">TDX_BUILD_TDVPS_ACCESSORS</span><span class="p">(</span><span class="n">bits</span><span class="p">,</span> <span class="n">uclass</span><span class="p">,</span> <span class="n">lclass</span><span class="p">)</span>                        \
<span class="mi">200</span> <span class="k">static</span> <span class="n">__always_inline</span> <span class="n">u</span><span class="err">##</span><span class="n">bits</span> <span class="n">td_</span><span class="err">##</span><span class="n">lclass</span><span class="err">##</span><span class="n">_read</span><span class="err">##</span><span class="n">bits</span><span class="p">(</span><span class="k">struct</span> <span class="nc">vcpu_tdx</span> <span class="o">*</span><span class="n">tdx</span><span class="p">,</span>  \
<span class="mi">201</span>                                                         <span class="n">u32</span> <span class="n">field</span><span class="p">)</span>             \
<span class="mi">202</span> <span class="p">{</span>                                                                              \
<span class="mi">203</span>         <span class="k">struct</span> <span class="nc">tdx_ex_ret</span> <span class="n">ex_ret</span><span class="p">;</span>                                              \
<span class="mi">204</span>         <span class="n">u64</span> <span class="n">err</span><span class="p">;</span>                                                               \
<span class="mi">205</span>                                                                                \
<span class="mi">206</span>         <span class="n">tdvps_</span><span class="err">##</span><span class="n">lclass</span><span class="err">##</span><span class="n">_check</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">bits</span><span class="p">);</span>                                   \
<span class="mi">207</span>         <span class="n">err</span> <span class="o">=</span> <span class="n">tdh_vp_rd</span><span class="p">(</span><span class="n">tdx</span><span class="o">-&gt;</span><span class="n">tdvpr</span><span class="p">.</span><span class="n">pa</span><span class="p">,</span> <span class="n">TDVPS_</span><span class="err">##</span><span class="n">uclass</span><span class="p">(</span><span class="n">field</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">ex_ret</span><span class="p">);</span>        \
<span class="mi">208</span>         <span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">err</span><span class="p">))</span> <span class="p">{</span>                                                   \
<span class="mi">209</span>                 <span class="n">pr_err</span><span class="p">(</span><span class="s">"TDH_VP_RD["</span><span class="err">#</span><span class="n">uclass</span><span class="s">".0x%x] failed: %s (0x%llx)</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>      \
<span class="mi">210</span>                        <span class="n">field</span><span class="p">,</span> <span class="n">tdx_seamcall_error_name</span><span class="p">(</span><span class="n">err</span><span class="p">),</span> <span class="n">err</span><span class="p">);</span>              \
<span class="mi">211</span>                 <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>                                                      \
<span class="mi">212</span>         <span class="p">}</span>                                                                      \
<span class="mi">213</span>         <span class="k">return</span> <span class="p">(</span><span class="n">u</span><span class="err">##</span><span class="n">bits</span><span class="p">)</span><span class="n">ex_ret</span><span class="p">.</span><span class="n">regs</span><span class="p">.</span><span class="n">r8</span><span class="p">;</span>                                        \
<span class="mi">214</span> <span class="p">}</span>                                                                              \
<span class="mi">215</span> <span class="k">static</span> <span class="n">__always_inline</span> <span class="kt">void</span> <span class="n">td_</span><span class="err">##</span><span class="n">lclass</span><span class="err">##</span><span class="n">_write</span><span class="err">##</span><span class="n">bits</span><span class="p">(</span><span class="k">struct</span> <span class="nc">vcpu_tdx</span> <span class="o">*</span><span class="n">tdx</span><span class="p">,</span>    \
<span class="mi">216</span>                                                       <span class="n">u32</span> <span class="n">field</span><span class="p">,</span> <span class="n">u</span><span class="err">##</span><span class="n">bits</span> <span class="n">val</span><span class="p">)</span>  \
<span class="mi">217</span> <span class="p">{</span>                                                                              \
<span class="mi">218</span>         <span class="k">struct</span> <span class="nc">tdx_ex_ret</span> <span class="n">ex_ret</span><span class="p">;</span>                                              \
<span class="mi">219</span>         <span class="n">u64</span> <span class="n">err</span><span class="p">;</span>                                                               \
<span class="mi">220</span>                                                                                \
<span class="mi">221</span>         <span class="n">tdvps_</span><span class="err">##</span><span class="n">lclass</span><span class="err">##</span><span class="n">_check</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">bits</span><span class="p">);</span>                                   \
<span class="mi">222</span>         <span class="n">err</span> <span class="o">=</span> <span class="n">tdh_vp_wr</span><span class="p">(</span><span class="n">tdx</span><span class="o">-&gt;</span><span class="n">tdvpr</span><span class="p">.</span><span class="n">pa</span><span class="p">,</span> <span class="n">TDVPS_</span><span class="err">##</span><span class="n">uclass</span><span class="p">(</span><span class="n">field</span><span class="p">),</span> <span class="n">val</span><span class="p">,</span>             \
<span class="mi">223</span>                       <span class="n">GENMASK_ULL</span><span class="p">(</span><span class="n">bits</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">ex_ret</span><span class="p">);</span>                      \
<span class="mi">224</span>         <span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>                                                     \
<span class="mi">225</span>                 <span class="n">pr_err</span><span class="p">(</span><span class="s">"TDH_VP_WR["</span><span class="err">#</span><span class="n">uclass</span><span class="s">".0x%x] = 0x%llx failed: %s (0x%llx)</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> \
<span class="mi">226</span>                        <span class="n">field</span><span class="p">,</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">val</span><span class="p">,</span> <span class="n">tdx_seamcall_error_name</span><span class="p">(</span><span class="n">err</span><span class="p">),</span> <span class="n">err</span><span class="p">);</span>    \
<span class="mi">227</span> <span class="p">}</span>                                                                              \
<span class="mi">228</span> <span class="k">static</span> <span class="n">__always_inline</span> <span class="kt">void</span> <span class="n">td_</span><span class="err">##</span><span class="n">lclass</span><span class="err">##</span><span class="n">_setbit</span><span class="err">##</span><span class="n">bits</span><span class="p">(</span><span class="k">struct</span> <span class="nc">vcpu_tdx</span> <span class="o">*</span><span class="n">tdx</span><span class="p">,</span>   \
<span class="mi">229</span>                                                        <span class="n">u32</span> <span class="n">field</span><span class="p">,</span> <span class="n">u64</span> <span class="n">bit</span><span class="p">)</span>     \
<span class="mi">230</span> <span class="p">{</span>                                                                              \
<span class="mi">231</span>         <span class="k">struct</span> <span class="nc">tdx_ex_ret</span> <span class="n">ex_ret</span><span class="p">;</span>                                              \
<span class="mi">232</span>         <span class="n">u64</span> <span class="n">err</span><span class="p">;</span>                                                               \
<span class="mi">233</span>                                                                                \
<span class="mi">234</span>         <span class="n">tdvps_</span><span class="err">##</span><span class="n">lclass</span><span class="err">##</span><span class="n">_check</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">bits</span><span class="p">);</span>                                   \
<span class="mi">235</span>         <span class="n">err</span> <span class="o">=</span> <span class="n">tdh_vp_wr</span><span class="p">(</span><span class="n">tdx</span><span class="o">-&gt;</span><span class="n">tdvpr</span><span class="p">.</span><span class="n">pa</span><span class="p">,</span> <span class="n">TDVPS_</span><span class="err">##</span><span class="n">uclass</span><span class="p">(</span><span class="n">field</span><span class="p">),</span> <span class="n">bit</span><span class="p">,</span> <span class="n">bit</span><span class="p">,</span>        \
<span class="mi">236</span>                         <span class="o">&amp;</span><span class="n">ex_ret</span><span class="p">);</span>                                              \
<span class="mi">237</span>         <span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>                                                     \
<span class="mi">238</span>                 <span class="n">pr_err</span><span class="p">(</span><span class="s">"TDH_VP_WR["</span><span class="err">#</span><span class="n">uclass</span><span class="s">".0x%x] |= 0x%llx failed: %s (0x%llx)</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> \
<span class="mi">239</span>                        <span class="n">field</span><span class="p">,</span> <span class="n">bit</span><span class="p">,</span> <span class="n">tdx_seamcall_error_name</span><span class="p">(</span><span class="n">err</span><span class="p">),</span> <span class="n">err</span><span class="p">);</span>         \
<span class="mi">240</span> <span class="p">}</span>                                                                              \
<span class="mi">241</span> <span class="k">static</span> <span class="n">__always_inline</span> <span class="kt">void</span> <span class="n">td_</span><span class="err">##</span><span class="n">lclass</span><span class="err">##</span><span class="n">_clearbit</span><span class="err">##</span><span class="n">bits</span><span class="p">(</span><span class="k">struct</span> <span class="nc">vcpu_tdx</span> <span class="o">*</span><span class="n">tdx</span><span class="p">,</span> \
<span class="mi">242</span>                                                          <span class="n">u32</span> <span class="n">field</span><span class="p">,</span> <span class="n">u64</span> <span class="n">bit</span><span class="p">)</span>   \
<span class="mi">243</span> <span class="p">{</span>                                                                              \
<span class="mi">244</span>         <span class="k">struct</span> <span class="nc">tdx_ex_ret</span> <span class="n">ex_ret</span><span class="p">;</span>                                              \
<span class="mi">245</span>         <span class="n">u64</span> <span class="n">err</span><span class="p">;</span>                                                               \
<span class="mi">246</span>                                                                                \
<span class="mi">247</span>         <span class="n">tdvps_</span><span class="err">##</span><span class="n">lclass</span><span class="err">##</span><span class="n">_check</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">bits</span><span class="p">);</span>                                   \
<span class="mi">248</span>         <span class="n">err</span> <span class="o">=</span> <span class="n">tdh_vp_wr</span><span class="p">(</span><span class="n">tdx</span><span class="o">-&gt;</span><span class="n">tdvpr</span><span class="p">.</span><span class="n">pa</span><span class="p">,</span> <span class="n">TDVPS_</span><span class="err">##</span><span class="n">uclass</span><span class="p">(</span><span class="n">field</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">bit</span><span class="p">,</span>          \
<span class="mi">249</span>                         <span class="o">&amp;</span><span class="n">ex_ret</span><span class="p">);</span>                                              \
<span class="mi">250</span>         <span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>                                                     \
<span class="mi">251</span>                 <span class="n">pr_err</span><span class="p">(</span><span class="s">"TDH_VP_WR["</span><span class="err">#</span><span class="n">uclass</span><span class="s">".0x%x] &amp;= ~0x%llx failed: %s (0x%llx)</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> \
<span class="mi">252</span>                        <span class="n">field</span><span class="p">,</span> <span class="n">bit</span><span class="p">,</span> <span class="n">tdx_seamcall_error_name</span><span class="p">(</span><span class="n">err</span><span class="p">),</span> <span class="n">err</span><span class="p">);</span>         \
<span class="mi">253</span> <span class="p">}</span>
<span class="mi">254</span>
<span class="mi">255</span> <span class="nf">TDX_BUILD_TDVPS_ACCESSORS</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="n">VMCS</span><span class="p">,</span> <span class="n">vmcs</span><span class="p">);</span>
<span class="mi">256</span> <span class="nf">TDX_BUILD_TDVPS_ACCESSORS</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">VMCS</span><span class="p">,</span> <span class="n">vmcs</span><span class="p">);</span>
<span class="mi">257</span> <span class="nf">TDX_BUILD_TDVPS_ACCESSORS</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="n">VMCS</span><span class="p">,</span> <span class="n">vmcs</span><span class="p">);</span>
<span class="mi">258</span> 
<span class="mi">259</span> <span class="nf">TDX_BUILD_TDVPS_ACCESSORS</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="n">APIC</span><span class="p">,</span> <span class="n">apic</span><span class="p">);</span>
<span class="mi">260</span> <span class="nf">TDX_BUILD_TDVPS_ACCESSORS</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="n">GPR</span><span class="p">,</span> <span class="n">gpr</span><span class="p">);</span>
<span class="mi">261</span> <span class="nf">TDX_BUILD_TDVPS_ACCESSORS</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="n">DR</span><span class="p">,</span> <span class="n">dr</span><span class="p">);</span>
<span class="mi">262</span> <span class="nf">TDX_BUILD_TDVPS_ACCESSORS</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="n">STATE</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
<span class="mi">263</span> <span class="nf">TDX_BUILD_TDVPS_ACCESSORS</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="n">STATE_NON_ARCH</span><span class="p">,</span> <span class="n">state_non_arch</span><span class="p">);</span>
<span class="mi">264</span> <span class="nf">TDX_BUILD_TDVPS_ACCESSORS</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="n">MSR</span><span class="p">,</span> <span class="n">msr</span><span class="p">);</span>
<span class="mi">265</span> <span class="nf">TDX_BUILD_TDVPS_ACCESSORS</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">MANAGEMENT</span><span class="p">,</span> <span class="n">management</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></div></div>

<p>The defined macro functions are also utilized by the vmread and vmwrite macro 
functions</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td class="rouge-code"><pre> <span class="mi">19</span> <span class="err">#</span><span class="n">define</span> <span class="nf">VT_BUILD_VMCS_HELPERS</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">bits</span><span class="p">,</span> <span class="n">tdbits</span><span class="p">)</span>                          \
 <span class="mi">20</span> <span class="k">static</span> <span class="n">__always_inline</span> <span class="n">type</span> <span class="n">vmread</span><span class="err">##</span><span class="n">bits</span><span class="p">(</span><span class="k">struct</span> <span class="nc">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span>            \
 <span class="mi">21</span>                                          <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">field</span><span class="p">)</span>              \
 <span class="mi">22</span> <span class="p">{</span>                                                                          \
 <span class="mi">23</span>         <span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">is_td_vcpu</span><span class="p">(</span><span class="n">vcpu</span><span class="p">)))</span> <span class="p">{</span>                                  \
 <span class="mi">24</span>                 <span class="k">if</span> <span class="p">(</span><span class="n">KVM_BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">is_debug_td</span><span class="p">(</span><span class="n">vcpu</span><span class="p">),</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">kvm</span><span class="p">))</span>             \
 <span class="mi">25</span>                         <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>                                          \
 <span class="mi">26</span>                 <span class="k">return</span> <span class="n">td_vmcs_read</span><span class="err">##</span><span class="n">tdbits</span><span class="p">(</span><span class="n">to_tdx</span><span class="p">(</span><span class="n">vcpu</span><span class="p">),</span> <span class="n">field</span><span class="p">);</span>          \
 <span class="mi">27</span>         <span class="p">}</span>                                                                  \
 <span class="mi">28</span>         <span class="k">return</span> <span class="n">vmcs_read</span><span class="err">##</span><span class="n">bits</span><span class="p">(</span><span class="n">field</span><span class="p">);</span>                                     \
 <span class="mi">29</span> <span class="p">}</span>                                                                          \
 <span class="mi">30</span> <span class="k">static</span> <span class="n">__always_inline</span> <span class="kt">void</span> <span class="n">vmwrite</span><span class="err">##</span><span class="n">bits</span><span class="p">(</span><span class="k">struct</span> <span class="nc">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span>           \
 <span class="mi">31</span>                                           <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">field</span><span class="p">,</span> <span class="n">type</span> <span class="n">value</span><span class="p">)</span> \
 <span class="mi">32</span> <span class="p">{</span>                                                                          \
 <span class="mi">33</span>         <span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">is_td_vcpu</span><span class="p">(</span><span class="n">vcpu</span><span class="p">)))</span> <span class="p">{</span>                                  \
 <span class="mi">34</span>                 <span class="k">if</span> <span class="p">(</span><span class="n">KVM_BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">is_debug_td</span><span class="p">(</span><span class="n">vcpu</span><span class="p">),</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">kvm</span><span class="p">))</span>             \
 <span class="mi">35</span>                         <span class="k">return</span><span class="p">;</span>                                            \
 <span class="mi">36</span>                 <span class="k">return</span> <span class="n">td_vmcs_write</span><span class="err">##</span><span class="n">tdbits</span><span class="p">(</span><span class="n">to_tdx</span><span class="p">(</span><span class="n">vcpu</span><span class="p">),</span> <span class="n">field</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>  \
 <span class="mi">37</span>         <span class="p">}</span>                                                                  \
 <span class="mi">38</span>         <span class="n">vmcs_write</span><span class="err">##</span><span class="n">bits</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>                                    \
 <span class="mi">39</span> <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>


  </div>

  <div class="post-tail-wrapper text-muted">
    <!-- categories -->
    
      <div class="post-meta mb-3">
        <i class="far fa-folder-open fa-fw me-1"></i>
        
          <a href="/categories/confidential-computing/">Confidential Computing</a>,
          <a href="/categories/intel-tdx/">Intel TDX</a>
      </div>
    

    <!-- tags -->
    

    <div
      class="
        post-tail-bottom
        d-flex justify-content-between align-items-center mt-5 pb-2
      "
    >
      <div class="license-wrapper">
        
          

          This post is licensed under 
        <a href="https://creativecommons.org/licenses/by/4.0/">
          CC BY 4.0
        </a>
         by the author.
        
      </div>

      <!-- Post sharing snippet -->

<div class="share-wrapper d-flex align-items-center">
  <span class="share-label text-muted">Share</span>
  <span class="share-icons">
    
    
    

    

      

      <a
        href="https://twitter.com/intent/tweet?text=TD%20VM%20Life%20Cycle%20Part%202%20-%20Ruach&url=https%3A%2F%2Fruach.github.io%2Fposts%2FTD-VM-LIFECYCLE-2%2F"
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Twitter"
        target="_blank"
        rel="noopener"
        aria-label="Twitter"
      >
        <i class="fa-fw fa-brands fa-square-x-twitter"></i>
      </a>
    

      

      <a
        href="https://www.facebook.com/sharer/sharer.php?title=TD%20VM%20Life%20Cycle%20Part%202%20-%20Ruach&u=https%3A%2F%2Fruach.github.io%2Fposts%2FTD-VM-LIFECYCLE-2%2F"
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Facebook"
        target="_blank"
        rel="noopener"
        aria-label="Facebook"
      >
        <i class="fa-fw fab fa-facebook-square"></i>
      </a>
    

      

      <a
        href="https://t.me/share/url?url=https%3A%2F%2Fruach.github.io%2Fposts%2FTD-VM-LIFECYCLE-2%2F&text=TD%20VM%20Life%20Cycle%20Part%202%20-%20Ruach"
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Telegram"
        target="_blank"
        rel="noopener"
        aria-label="Telegram"
      >
        <i class="fa-fw fab fa-telegram"></i>
      </a>
    

      

      <a
        href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fruach.github.io%2Fposts%2FTD-VM-LIFECYCLE-2%2F"
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Linkedin"
        target="_blank"
        rel="noopener"
        aria-label="Linkedin"
      >
        <i class="fa-fw fab fa-linkedin"></i>
      </a>
    

    <button
      id="copy-link"
      aria-label="Copy link"
      class="btn small"
      data-bs-toggle="tooltip"
      data-bs-placement="top"
      title="Copy link"
      data-title-succeed="Link copied successfully!"
    >
      <i class="fa-fw fas fa-link pe-none fs-6"></i>
    </button>
  </span>
</div>

    </div>
    <!-- .post-tail-bottom -->
  </div>
  <!-- div.post-tail-wrapper -->
</article>


            
          </main>

          <!-- panel -->
          <aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 mb-5 text-muted">
            <div class="access">
              <!-- Get the last 5 posts from lastmod list. -->















              <!-- The trending tags list -->


















            </div>

            
              
              



  <section id="toc-wrapper" class="ps-0 pe-4">
    <h2 class="panel-heading ps-3 pt-2 mb-2">Contents</h2>
    <nav id="toc"></nav>
  </section>


            
          </aside>
        </div>

        <div class="row">
          <!-- tail -->
          <div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4">
            
              
              <!-- Recommend the other 3 posts according to the tags and categories of the current post. -->

<!-- The total size of related posts -->


<!-- An random integer that bigger than 0 -->


<!-- Equals to TAG_SCORE / {max_categories_hierarchy} -->














  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  
    
  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  











  <aside id="related-posts" aria-labelledby="related-label">
    <h3 class="mb-4" id="related-label">Further Reading</h3>
    <nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4">
      
        <article class="col">
          <a href="/posts/TDX-SEAMLDR/" class="post-preview card h-100">
            <div class="card-body">
              <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1678424400"
  data-df="ll"
  
>
  Mar 10, 2023
</time>

              <h4 class="pt-0 my-2">TDX Module Life Cycle Part 0 (SEAMLDR)</h4>
              <div class="text-muted">
                <p>
                  





                  New CPU privileges and software layer for Intel TDX
Secure Arbitration Mode (SEAM) is an extension of Virtual Machines Extension 
(VMX). It introduces new VMX root mode called SEAM root. The primar...
                </p>
              </div>
            </div>
          </a>
        </article>
      
        <article class="col">
          <a href="/posts/TDX-MODULE-LIFECYCLE-1/" class="post-preview card h-100">
            <div class="card-body">
              <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1679284800"
  data-df="ll"
  
>
  Mar 20, 2023
</time>

              <h4 class="pt-0 my-2">TDX Module Life Cycle Part 1</h4>
              <div class="text-muted">
                <p>
                  





                  Initialize TDX module
TDX module requires few initialization steps to start service as intermediary of
the TD and VMM. To this end, TDX module requires multiple SEAMCALLs to be 
invoked, as shown i...
                </p>
              </div>
            </div>
          </a>
        </article>
      
        <article class="col">
          <a href="/posts/TDX-MODULE-LIFECYCLE-2/" class="post-preview card h-100">
            <div class="card-body">
              <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1679544000"
  data-df="ll"
  
>
  Mar 23, 2023
</time>

              <h4 class="pt-0 my-2">TDX Module Life Cycle Part 2</h4>
              <div class="text-muted">
                <p>
                  





                  In previous posts, I discussed the initialization of the TDX module using 
TDH_SYS_INIT SEAMCALL. As depicted in the image below, several additional 
configuration steps are necessary for the TDX m...
                </p>
              </div>
            </div>
          </a>
        </article>
      
    </nav>
  </aside>
  <!-- #related-posts -->


            
              
              <!-- Navigation buttons at the bottom of the post. -->

<nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation">
  
  

  
    <a
      href="/posts/TD-VM-LIFECYCLE-1/"
      class="btn btn-outline-primary"
      aria-label="Older"
    >
      <p>TD VM Life Cycle Part 1</p>
    </a>
  

  
    <a
      href="/posts/TD-VM-LIFECYCLE-3/"
      class="btn btn-outline-primary"
      aria-label="Newer"
    >
      <p>TD VM Life Cycle Part 3</p>
    </a>
  
</nav>

            
              
              <!--  The comments switcher -->

  
  <!-- The Disqus lazy loading. -->

<div id="disqus_thread">
  <p class="text-center text-muted small">Comments powered by <a href="https://disqus.com/">Disqus</a>.</p>
</div>

<script type="text/javascript">
  var disqus_config = function () {
    this.page.url = 'https://ruach.github.io/posts/TD-VM-LIFECYCLE-2/';
    this.page.identifier = '/posts/TD-VM-LIFECYCLE-2/';
  };

  /* Lazy loading */
  var disqus_observer = new IntersectionObserver(
    function (entries) {
      if (entries[0].isIntersecting) {
        (function () {
          var d = document,
            s = d.createElement('script');
          s.src = 'https://ruach.disqus.com/embed.js';
          s.setAttribute('data-timestamp', +new Date());
          (d.head || d.body).appendChild(s);
        })();

        disqus_observer.disconnect();
      }
    },
    { threshold: [0] }
  );

  disqus_observer.observe(document.querySelector('#disqus_thread'));

  /* Auto switch theme */
  function reloadDisqus() {
    if (event.source === window && event.data && event.data.direction === ModeToggle.ID) {
      /* Disqus hasn't been loaded */
      if (typeof DISQUS === 'undefined') {
        return;
      }

      if (document.readyState == 'complete') {
        DISQUS.reset({ reload: true, config: disqus_config });
      }
    }
  }

  if (document.querySelector('.mode-toggle')) {
    window.addEventListener('message', reloadDisqus);
  }
</script>



            

            <!-- The Footer -->

<footer
  aria-label="Site Info"
  class="
    d-flex flex-column justify-content-center text-muted
    flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3
  "
>
  <p>
    ©
    <time>2024</time>
    <a href="https://ruach.github.io">Jaehyuk Lee</a>.
    
      <span
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author."
      >Some rights reserved.</span>
    
  </p>

  <p>Using the <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme for <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>
  </p>
</footer>

          </div>
        </div>

        <!-- The Search results -->

<div id="search-result-wrapper" class="d-flex justify-content-center unloaded">
  <div class="col-11 content">
    <div id="search-hints">
      <!-- The trending tags list -->


















    </div>
    <div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div>
  </div>
</div>

      </div>

      <aside aria-label="Scroll to Top">
        <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow">
          <i class="fas fa-angle-up"></i>
        </button>
      </aside>
    </div>

    <div id="mask"></div>

    
      <aside
  id="notification"
  class="toast"
  role="alert"
  aria-live="assertive"
  aria-atomic="true"
  data-bs-animation="true"
  data-bs-autohide="false"
>
  <div class="toast-header">
    <button
      type="button"
      class="btn-close ms-auto"
      data-bs-dismiss="toast"
      aria-label="Close"
    ></button>
  </div>
  <div class="toast-body text-center pt-0">
    <p class="px-2 mb-3">A new version of content is available.</p>
    <button type="button" class="btn btn-primary" aria-label="Update">
      Update
    </button>
  </div>
</aside>

    

    <!-- JavaScripts -->

    <!-- JS selector for site. -->

<!-- commons -->



<!-- layout specified -->


  

  
    <!-- image lazy-loading & popup & clipboard -->
    
  















  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  



  <script src="https://cdn.jsdelivr.net/combine/npm/jquery@3.7.1/dist/jquery.min.js,npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js,npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/magnific-popup@1.1.0/dist/jquery.magnific-popup.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.10/dayjs.min.js,npm/dayjs@1.11.10/locale/en.min.js,npm/dayjs@1.11.10/plugin/relativeTime.min.js,npm/dayjs@1.11.10/plugin/localizedFormat.min.js,npm/tocbot@4.21.2/dist/tocbot.min.js"></script>






<script defer src="/assets/js/dist/post.min.js"></script>






    

    <!--
  Jekyll Simple Search loader
  See: <https://github.com/christian-fei/Simple-Jekyll-Search>
-->





<script>
  /* Note: dependent library will be loaded in `js-selector.html` */
  SimpleJekyllSearch({
    searchInput: document.getElementById('search-input'),
    resultsContainer: document.getElementById('search-results'),
    json: '/assets/js/data/search.json',
    searchResultTemplate: '  <article class="px-1 px-sm-2 px-lg-4 px-xl-0">    <header>      <h2><a href="{url}">{title}</a></h2>      <div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1">        {categories}        {tags}      </div>    </header>    <p>{snippet}</p>  </article>',
    noResultsText: '<p class="mt-5"></p>',
    templateMiddleware: function(prop, value, template) {
      if (prop === 'categories') {
        if (value === '') {
          return `${value}`;
        } else {
          return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`;
        }
      }

      if (prop === 'tags') {
        if (value === '') {
          return `${value}`;
        } else {
          return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`;
        }
      }
    }
  });
</script>

  </body>
</html>

