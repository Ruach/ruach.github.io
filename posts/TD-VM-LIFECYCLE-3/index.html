<!doctype html>














<!-- `site.alt_lang` can specify a language different from the UI -->
<html lang="en" data-mode="light">
  <!-- The Head -->

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta
    name="viewport"
    content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover"
  >

  

  

  
    <!-- Begin Jekyll SEO tag v2.8.0 -->
<meta name="generator" content="Jekyll v4.3.3" />
<meta property="og:title" content="TD VM Life Cycle Part 3" />
<meta property="og:locale" content="en" />
<meta name="description" content="TD Boot Memory Setup (TDH.MEM.SEPT.ADD-TDH.MR.EXTEND) In the previous postings, we built the meta data required for launching TD VM such as TDR, TDCS and VMCS of VCPU. However, to actually run code inside the TD, we need memory pages and its mappings. We will see how TDX Module builds up the Secure EPT for private memories and add initial set of TD private pages using TDH.MEM.SEPT.ADD and TDH.MEM.PAGE.ADD, respectively." />
<meta property="og:description" content="TD Boot Memory Setup (TDH.MEM.SEPT.ADD-TDH.MR.EXTEND) In the previous postings, we built the meta data required for launching TD VM such as TDR, TDCS and VMCS of VCPU. However, to actually run code inside the TD, we need memory pages and its mappings. We will see how TDX Module builds up the Secure EPT for private memories and add initial set of TD private pages using TDH.MEM.SEPT.ADD and TDH.MEM.PAGE.ADD, respectively." />
<link rel="canonical" href="https://ruach.github.io/posts/TD-VM-LIFECYCLE-3/" />
<meta property="og:url" content="https://ruach.github.io/posts/TD-VM-LIFECYCLE-3/" />
<meta property="og:site_name" content="Ruach" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2023-04-05T00:00:00-04:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="TD VM Life Cycle Part 3" />
<meta name="twitter:site" content="@ruach_lee" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2023-04-05T00:00:00-04:00","datePublished":"2023-04-05T00:00:00-04:00","description":"TD Boot Memory Setup (TDH.MEM.SEPT.ADD-TDH.MR.EXTEND) In the previous postings, we built the meta data required for launching TD VM such as TDR, TDCS and VMCS of VCPU. However, to actually run code inside the TD, we need memory pages and its mappings. We will see how TDX Module builds up the Secure EPT for private memories and add initial set of TD private pages using TDH.MEM.SEPT.ADD and TDH.MEM.PAGE.ADD, respectively.","headline":"TD VM Life Cycle Part 3","mainEntityOfPage":{"@type":"WebPage","@id":"https://ruach.github.io/posts/TD-VM-LIFECYCLE-3/"},"url":"https://ruach.github.io/posts/TD-VM-LIFECYCLE-3/"}</script>
<!-- End Jekyll SEO tag -->

  

  <title>TD VM Life Cycle Part 3 | Ruach
  </title>

  <!--
  The Favicons for Web, Android, Microsoft, and iOS (iPhone and iPad) Apps
  Generated by: https://realfavicongenerator.net/
-->



<link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png">
<link rel="manifest" href="/assets/img/favicons/site.webmanifest">
<link rel="shortcut icon" href="/assets/img/favicons/favicon.ico">
<meta name="apple-mobile-web-app-title" content="Ruach">
<meta name="application-name" content="Ruach">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml">
<meta name="theme-color" content="#ffffff">


  
    
      <link rel="preconnect" href="https://fonts.googleapis.com" >
      <link rel="dns-prefetch" href="https://fonts.googleapis.com" >
    
      <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      <link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin>
    
      <link rel="preconnect" href="https://fonts.googleapis.com" >
      <link rel="dns-prefetch" href="https://fonts.googleapis.com" >
    
      <link rel="preconnect" href="https://cdn.jsdelivr.net" >
      <link rel="dns-prefetch" href="https://cdn.jsdelivr.net" >
    

    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap">
  

  <!-- GA -->
  

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.2/css/all.min.css">

  <link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css">

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.21.2/dist/tocbot.min.css">
  

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css">
  

  
    <!-- Manific Popup -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css">
  

  <!-- JavaScript -->

  

  <!-- A placeholder to allow defining custom metadata -->

</head>


  <body>
    <!-- The Side Bar -->

<aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end">
  <header class="profile-wrapper">
    <a href="/" id="avatar" class="rounded-circle">
      
        
        <img src="/assets/img/jaehyuk.png" width="112" height="112" alt="avatar" onerror="this.style.display='none'">
      
    </a>

    <h1 class="site-title">
      <a href="/">Ruach</a>
    </h1>
    <p class="site-subtitle fst-italic mb-0">Jaehyuk Lee</p>
  </header>
  <!-- .profile-wrapper -->

  <nav class="flex-column flex-grow-1 w-100 ps-0">
    <ul class="nav">
      <!-- home -->
      <li class="nav-item">
        <a href="/" class="nav-link">
          <i class="fa-fw fas fa-home"></i>
          <span>HOME</span>
        </a>
      </li>
      <!-- the real tabs -->
      
        <li class="nav-item">
          <a href="/categories/" class="nav-link">
            <i class="fa-fw fas fa-stream"></i>
            

            <span>CATEGORIES</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/archives/" class="nav-link">
            <i class="fa-fw fas fa-archive"></i>
            

            <span>ARCHIVES</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/about/" class="nav-link">
            <i class="fa-fw fas fa-info-circle"></i>
            

            <span>ABOUT</span>
          </a>
        </li>
        <!-- .nav-item -->
      
    </ul>
  </nav>

  <div class="sidebar-bottom d-flex flex-wrap  align-items-center w-100">
    

    
      

      
        <a
          href="javascript:location.href = 'mailto:' + ['jaehyuk','gatech.edu'].join('@')"
          aria-label="email"
          

          

          

          
        >
          <i class="fas fa-envelope"></i>
        </a>
      
    
      

      
        <a
          href="https://www.linkedin.com/in/jaehyuk-lee-29b33b121/"
          aria-label="linkedin"
          

          
            target="_blank"
            
          

          

          
            rel="noopener noreferrer"
          
        >
          <i class="fab fa-linkedin"></i>
        </a>
      
    
      

      
        <a
          href="https://github.com/Ruach"
          aria-label="github"
          

          
            target="_blank"
            
          

          

          
            rel="noopener noreferrer"
          
        >
          <i class="fab fa-github"></i>
        </a>
      
    
      

      
        <a
          href="https://stackoverflow.com/users/4460514/ruach?tab=profile"
          aria-label="stack-overflow"
          

          
            target="_blank"
            
          

          

          
            rel="noopener noreferrer"
          
        >
          <i class="fab fa-stack-overflow"></i>
        </a>
      
    
  </div>
  <!-- .sidebar-bottom -->
</aside>
<!-- #sidebar -->


    <div id="main-wrapper" class="d-flex justify-content-center">
      <div class="container d-flex flex-column px-xxl-5">
        <!-- The Top Bar -->

<header id="topbar-wrapper" aria-label="Top Bar">
  <div
    id="topbar"
    class="d-flex align-items-center justify-content-between px-lg-3 h-100"
  >
    <nav id="breadcrumb" aria-label="Breadcrumb">
      

      
        
          
            <span>
              <a href="/">
                Home
              </a>
            </span>

          
        
          
        
          
            
              <span>TD VM Life Cycle Part 3</span>
            

          
        
      
    </nav>
    <!-- endof #breadcrumb -->

    <button type="button" id="sidebar-trigger" class="btn btn-link">
      <i class="fas fa-bars fa-fw"></i>
    </button>

    <div id="topbar-title">
      Post
    </div>

    <button type="button" id="search-trigger" class="btn btn-link">
      <i class="fas fa-search fa-fw"></i>
    </button>

    <search class="align-items-center ms-3 ms-lg-0">
      <i class="fas fa-search fa-fw"></i>
      <input
        class="form-control"
        id="search-input"
        type="search"
        aria-label="search"
        autocomplete="off"
        placeholder="Search..."
      >
    </search>
    <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button>
  </div>
</header>


        <div class="row flex-grow-1">
          <main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4">
            
              <!-- Refactor the HTML structure -->



<!--
  In order to allow a wide table to scroll horizontally,
  we suround the markdown table with `<div class="table-wrapper">` and `</div>`
-->



<!--
  Fixed kramdown code highlight rendering:
  https://github.com/penibelst/jekyll-compress-html/issues/101
  https://github.com/penibelst/jekyll-compress-html/issues/71#issuecomment-188144901
-->



<!-- Change the icon of checkbox -->



<!-- Handle images -->




  
  

  <!-- CDN URL -->
  

  <!-- Add image path -->
  

  
    
      
      
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      <!-- do not add shimmer by default -->
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      <!-- do not add shimmer by default -->
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  

  


<!-- Add header for code snippets -->



<!-- Create heading anchors -->





  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    

    
  

  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    

    
  

  
  

  

  
  

  




<!-- return -->




<article class="px-1">
  <header>
    <h1 data-toc-skip>TD VM Life Cycle Part 3</h1>

    <div class="post-meta text-muted">
      <!-- published date -->
      <span>
        Posted
        <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1680667200"
  data-df="ll"
  
    data-bs-toggle="tooltip" data-bs-placement="bottom"
  
>
  Apr  5, 2023
</time>

      </span>

      <!-- lastmod date -->
      

      

      <div class="d-flex justify-content-between">
        <!-- author(s) -->
        <span>
          

          By

          <em>
            
              <a href="https://ruach.github.io">Jaehyuk Lee</a>
            
          </em>
        </span>

        <!-- read time -->
        <!-- Calculate the post's reading time, and display the word count in tooltip -->



<!-- words per minute -->










<!-- return element -->
<span
  class="readtime"
  data-bs-toggle="tooltip"
  data-bs-placement="bottom"
  title="4152 words"
>
  <em>23 min</em> read</span>

      </div>
      <!-- .d-flex -->
    </div>
    <!-- .post-meta -->
  </header>

  <div class="content">
    <h2 id="td-boot-memory-setup-tdhmemseptadd-tdhmrextend"><span class="me-2">TD Boot Memory Setup (TDH.MEM.SEPT.ADD-TDH.MR.EXTEND)</span><a href="#td-boot-memory-setup-tdhmemseptadd-tdhmrextend" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<p>In the previous postings, we built the meta data required for launching TD VM 
such as TDR, TDCS and VMCS of VCPU. However, to actually run code inside the TD,
we need memory pages and its mappings. We will see how TDX Module builds up the 
Secure EPT for private memories and add initial set of TD private pages using 
TDH.MEM.SEPT.ADD and TDH.MEM.PAGE.ADD, respectively.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="mi">2439</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">tdx_vm_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="nc">kvm</span> <span class="o">*</span><span class="n">kvm</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">argp</span><span class="p">)</span>
<span class="mi">2440</span> <span class="p">{</span>
<span class="p">......</span>
<span class="mi">2453</span>         <span class="k">case</span> <span class="n">KVM_TDX_INIT_MEM_REGION</span><span class="p">:</span>
<span class="mi">2454</span>                 <span class="n">r</span> <span class="o">=</span> <span class="n">tdx_init_mem_region</span><span class="p">(</span><span class="n">kvm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tdx_cmd</span><span class="p">);</span>
<span class="mi">2455</span>                 <span class="k">break</span><span class="p">;</span>
<span class="mi">2456</span>         <span class="k">case</span> <span class="n">KVM_TDX_FINALIZE_VM</span><span class="p">:</span>
<span class="mi">2457</span>                 <span class="n">r</span> <span class="o">=</span> <span class="n">tdx_td_finalizemr</span><span class="p">(</span><span class="n">kvm</span><span class="p">);</span>
<span class="mi">2458</span>                 <span class="k">break</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="loading-tdvf-to-td-vm"><span class="me-2">Loading TDVF to TD VM</span><a href="#loading-tdvf-to-td-vm" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>Typically, initial pages of the TD VM contain Virtual BIOS code and data along 
with some clear pages for stacks and heap. Most of the guest TD code and data is
dynamically loaded at a later stage. Because the TDVF image is prepared by the 
user process (QEMU) and passed to the KVM, the KVM should interacts with QEMU
and TDX Module to successfully load the TDVF image to the TD VM.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="k">struct</span> <span class="nc">kvm_tdx_init_mem_region</span> <span class="p">{</span>
        <span class="n">__u64</span> <span class="n">source_addr</span><span class="p">;</span>
        <span class="n">__u64</span> <span class="n">gpa</span><span class="p">;</span>
        <span class="n">__u64</span> <span class="n">nr_pages</span><span class="p">;</span> 
<span class="p">};</span>    
</pre></td></tr></tbody></table></code></div></div>
<p><strong><em>QEMU SIDE CODE</em></strong></p>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre> <span class="mi">248</span>     <span class="nf">for_each_fw_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tdx</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span> <span class="p">{</span>                                   
 <span class="mi">249</span>         <span class="k">struct</span> <span class="nc">kvm_tdx_init_mem_region</span> <span class="n">mem_region</span> <span class="o">=</span> <span class="p">{</span>                      
 <span class="mi">250</span>             <span class="p">.</span><span class="n">source_addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u64</span><span class="p">)</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">mem_ptr</span><span class="p">,</span>                          
 <span class="mi">251</span>             <span class="p">.</span><span class="n">gpa</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">,</span>                                         
 <span class="mi">252</span>             <span class="p">.</span><span class="n">nr_pages</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">/</span> <span class="mi">4096</span><span class="p">,</span>
 <span class="mi">253</span>         <span class="p">};</span>
</pre></td></tr></tbody></table></code></div></div>

<p><strong><em>KVM SIDE CODE</em></strong></p>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="rouge-code"><pre><span class="k">static</span> <span class="kt">int</span> <span class="nf">tdx_init_mem_region</span><span class="p">(</span><span class="k">struct</span> <span class="nc">kvm</span> <span class="o">*</span><span class="n">kvm</span><span class="p">,</span> <span class="k">struct</span> <span class="nc">kvm_tdx_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">struct</span> <span class="nc">kvm_tdx</span> <span class="o">*</span><span class="n">kvm_tdx</span> <span class="o">=</span> <span class="n">to_kvm_tdx</span><span class="p">(</span><span class="n">kvm</span><span class="p">);</span>
        <span class="k">struct</span> <span class="nc">kvm_tdx_init_mem_region</span> <span class="n">region</span><span class="p">;</span>
        <span class="k">struct</span> <span class="nc">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">;</span>
        <span class="k">struct</span> <span class="nc">page</span> <span class="o">*</span><span class="n">page</span><span class="p">;</span>
        <span class="n">u64</span> <span class="n">error_code</span><span class="p">;</span>
        <span class="n">kvm_pfn_t</span> <span class="n">pfn</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

        <span class="cm">/* The BSP vCPU must be created before initializing memory regions. */</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kvm</span><span class="o">-&gt;</span><span class="n">online_vcpus</span><span class="p">))</span>
                <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">KVM_TDX_MEASURE_MEMORY_REGION</span><span class="p">)</span>
                <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">region</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">region</span><span class="p">)))</span>
                <span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
        <span class="p">......</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Before initializing and loading the VCPU MMU, it first copies region information
from the user. This is the address region passed from the user process utilizing
the KVM module. The <strong>source_addr</strong> is the QEMU’s user level address, containing 
each TDVF’s section code/data. And the <strong>gpa</strong> is the address of TDVF section
where each section code/data should be loaded to (GPA). Note that TDVF should be 
loaded into the designated physical address of the TD-VM so that it can start 
from there. The passed HVA is used to map TDVF to HPA mapped to the HVA.</p>

<p>Recall that memslot is generated for the GPA memory regions as a result of ioctl call to KVM
module from QEMU. Note that it only accepts TD private pages. When the TD-VM 
requires the shared page, it should invoke MapGPA to convert it.</p>

<h2 id="loading-shared-ept-and-initializing-mmu"><span class="me-2">Loading shared EPT and initializing MMU</span><a href="#loading-shared-ept-and-initializing-mmu" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<p>Before loading the TDVF to TD VM memory, the MMU of the VCPU should be set up.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre><span class="k">static</span> <span class="kt">int</span> <span class="nf">tdx_init_mem_region</span><span class="p">(</span><span class="k">struct</span> <span class="nc">kvm</span> <span class="o">*</span><span class="n">kvm</span><span class="p">,</span> <span class="k">struct</span> <span class="nc">kvm_tdx_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>        
<span class="p">{</span>     
        <span class="p">......</span>
        <span class="n">vcpu</span> <span class="o">=</span> <span class="n">kvm_get_vcpu</span><span class="p">(</span><span class="n">kvm</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_killable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">))</span>
                <span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>

        <span class="n">vcpu_load</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">srcu_read_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kvm</span><span class="o">-&gt;</span><span class="n">srcu</span><span class="p">);</span>

        <span class="n">kvm_mmu_reload</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></div></div>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="k">static</span> <span class="kt">void</span> <span class="nf">vt_vcpu_load</span><span class="p">(</span><span class="k">struct</span> <span class="nc">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cpu</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">is_td_vcpu</span><span class="p">(</span><span class="n">vcpu</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">tdx_vcpu_load</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>

        <span class="k">return</span> <span class="n">vmx_vcpu_load</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td class="rouge-code"><pre><span class="kt">void</span> <span class="nf">tdx_vcpu_load</span><span class="p">(</span><span class="k">struct</span> <span class="nc">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cpu</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">struct</span> <span class="nc">vcpu_tdx</span> <span class="o">*</span><span class="n">tdx</span> <span class="o">=</span> <span class="n">to_tdx</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>

        <span class="n">vmx_vcpu_pi_load</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">cpu</span> <span class="o">==</span> <span class="n">cpu</span><span class="p">)</span>
                <span class="k">return</span><span class="p">;</span>

        <span class="n">tdx_flush_vp_on_cpu</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>

        <span class="n">local_irq_disable</span><span class="p">();</span>
        <span class="cm">/*
         * Pairs with the smp_wmb() in tdx_disassociate_vp() to ensure
         * vcpu-&gt;cpu is read before tdx-&gt;cpu_list.
         */</span>
        <span class="n">smp_rmb</span><span class="p">();</span>

        <span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tdx</span><span class="o">-&gt;</span><span class="n">cpu_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">per_cpu</span><span class="p">(</span><span class="n">associated_tdvcpus</span><span class="p">,</span> <span class="n">cpu</span><span class="p">));</span>
        <span class="n">local_irq_enable</span><span class="p">();</span>
<span class="p">}</span>

</pre></td></tr></tbody></table></code></div></div>

<h3 id="reload-mmu-shared-ept-initialization"><span class="me-2">Reload MMU (Shared EPT initialization)</span><a href="#reload-mmu-shared-ept-initialization" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>The primary job of reloading MMU is initializing the SPT, especially when the 
root_hpa is set as INVALID_PAGE. Because the root_hpa was touched when the MMU 
is initialized, but the root of the SPT has not been initialized, so reload func
initializes the SPT for VM.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre></td><td class="rouge-code"><pre><span class="mi">5732</span> <span class="kt">int</span> <span class="n">kvm_mmu_load</span><span class="p">(</span><span class="k">struct</span> <span class="nc">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="mi">5733</span> <span class="p">{</span>
<span class="mi">5734</span>         <span class="kt">int</span> <span class="n">r</span><span class="p">;</span>
<span class="mi">5735</span> 
<span class="mi">5736</span>         <span class="n">r</span> <span class="o">=</span> <span class="n">mmu_topup_memory_caches</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="o">!</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">mmu</span><span class="o">-&gt;</span><span class="n">direct_map</span><span class="p">);</span>
<span class="mi">5737</span>         <span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
<span class="mi">5738</span>                 <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="mi">5739</span>         <span class="n">r</span> <span class="o">=</span> <span class="n">mmu_alloc_special_roots</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
<span class="mi">5740</span>         <span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>              
<span class="mi">5741</span>                 <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="mi">5742</span>         <span class="k">if</span> <span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">mmu</span><span class="o">-&gt;</span><span class="n">direct_map</span><span class="p">)</span>
<span class="mi">5743</span>                 <span class="n">r</span> <span class="o">=</span> <span class="n">mmu_alloc_direct_roots</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
<span class="mi">5744</span>         <span class="k">else</span>
<span class="mi">5745</span>                 <span class="n">r</span> <span class="o">=</span> <span class="n">mmu_alloc_shadow_roots</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span> 
<span class="mi">5746</span>         <span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
<span class="mi">5747</span>                 <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="mi">5748</span> 
<span class="mi">5749</span>         <span class="n">kvm_mmu_sync_roots</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
<span class="mi">5750</span> 
<span class="mi">5751</span>         <span class="n">kvm_mmu_load_pgd</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
<span class="mi">5752</span>         <span class="n">static_call</span><span class="p">(</span><span class="n">kvm_x86_tlb_flush_current</span><span class="p">)(</span><span class="n">vcpu</span><span class="p">);</span>
<span class="mi">5753</span> <span class="n">out</span><span class="o">:</span>   
<span class="mi">5754</span>         <span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="mi">5755</span> <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>As we covered before, about how the SPT is allocated, the mmu_alloc_direct_roots 
allocates the SPT for shared pages and private pages. Please refer to [[]] for 
details.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="mi">109</span> <span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">kvm_mmu_load_pgd</span><span class="p">(</span><span class="k">struct</span> <span class="nc">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="mi">110</span> <span class="p">{</span>        
<span class="mi">111</span>         <span class="n">u64</span> <span class="n">root_hpa</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">mmu</span><span class="o">-&gt;</span><span class="n">root_hpa</span><span class="p">;</span>
<span class="mi">112</span> 
<span class="mi">113</span>         <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">VALID_PAGE</span><span class="p">(</span><span class="n">root_hpa</span><span class="p">))</span>
<span class="mi">114</span>                 <span class="k">return</span><span class="p">;</span>
<span class="mi">115</span> 
<span class="mi">116</span>         <span class="n">static_call</span><span class="p">(</span><span class="n">kvm_x86_load_mmu_pgd</span><span class="p">)(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">root_hpa</span><span class="p">,</span>
<span class="mi">117</span>                                           <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">mmu</span><span class="o">-&gt;</span><span class="n">shadow_root_level</span><span class="p">);</span>
<span class="mi">118</span> <span class="p">}</span> 
</pre></td></tr></tbody></table></code></div></div>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre> <span class="mi">491</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">vt_load_mmu_pgd</span><span class="p">(</span><span class="k">struct</span> <span class="nc">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">hpa_t</span> <span class="n">root_hpa</span><span class="p">,</span>
 <span class="mi">492</span>                             <span class="kt">int</span> <span class="n">pgd_level</span><span class="p">)</span>
 <span class="mi">493</span> <span class="p">{</span>
 <span class="mi">494</span>         <span class="k">if</span> <span class="p">(</span><span class="n">is_td_vcpu</span><span class="p">(</span><span class="n">vcpu</span><span class="p">))</span>
 <span class="mi">495</span>                 <span class="k">return</span> <span class="n">tdx_load_mmu_pgd</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">root_hpa</span><span class="p">,</span> <span class="n">pgd_level</span><span class="p">);</span>
 <span class="mi">496</span> 
 <span class="mi">497</span>         <span class="nf">vmx_load_mmu_pgd</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">root_hpa</span><span class="p">,</span> <span class="n">pgd_level</span><span class="p">);</span>
 <span class="mi">498</span> <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="mi">1602</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">tdx_load_mmu_pgd</span><span class="p">(</span><span class="k">struct</span> <span class="nc">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">hpa_t</span> <span class="n">root_hpa</span><span class="p">,</span>
<span class="mi">1603</span>                              <span class="kt">int</span> <span class="n">pgd_level</span><span class="p">)</span>
<span class="mi">1604</span> <span class="p">{</span>
<span class="mi">1605</span>         <span class="n">td_vmcs_write64</span><span class="p">(</span><span class="n">to_tdx</span><span class="p">(</span><span class="n">vcpu</span><span class="p">),</span> <span class="n">SHARED_EPT_POINTER</span><span class="p">,</span> <span class="n">root_hpa</span> <span class="o">&amp;</span> <span class="n">PAGE_MASK</span><span class="p">);</span>
<span class="mi">1606</span> <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Because current VCPU belongs to the TD-VM, the SPT used for shared pages should 
be set to <strong>shared EPTP</strong>. For vanilla VM, only the EPT_POINTER exists. Because 
TD-VM also utilize the shared EPT, which is identical to EPT_POINTER in vanilla 
VM, it should be set up during the MMU-setup. Note that the private EPTP can be
set only through SEPT related SEAMCALLs.</p>

<h3 id="adding-page-to-td-vm"><span class="me-2">Adding page to TD VM</span><a href="#adding-page-to-td-vm" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>Because KVM MMU is initialized and the shared EPTP is correctly set to the VMCS 
of TD-VCPU, we can finally add some memories to the TD-VM. Let’s go back to the 
tdx_init_mem_region function.</p>

<p>Note that the tdvf binary is already loaded into the QEMU address space 
dedicated for the TD-VM, but to be utilized as private pages of the TD-VM, it 
should be added to the target TD-VM through the SEAMCALL.</p>

<h2 id="load-the-tdvf-images-into-td-memory"><span class="me-2">Load the TDVF images into TD memory</span><a href="#load-the-tdvf-images-into-td-memory" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
</pre></td><td class="rouge-code"><pre><span class="k">static</span> <span class="kt">int</span> <span class="nf">tdx_init_mem_region</span><span class="p">(</span><span class="k">struct</span> <span class="nc">kvm</span> <span class="o">*</span><span class="n">kvm</span><span class="p">,</span> <span class="k">struct</span> <span class="nc">kvm_tdx_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="nc">kvm_tdx</span> <span class="o">*</span><span class="n">kvm_tdx</span> <span class="o">=</span> <span class="n">to_kvm_tdx</span><span class="p">(</span><span class="n">kvm</span><span class="p">);</span>
    <span class="k">struct</span> <span class="nc">kvm_tdx_init_mem_region</span> <span class="n">region</span><span class="p">;</span>
    <span class="k">struct</span> <span class="nc">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">;</span>
    <span class="k">struct</span> <span class="nc">page</span> <span class="o">*</span><span class="n">page</span><span class="p">;</span>
    <span class="n">u64</span> <span class="n">error_code</span><span class="p">;</span>
    <span class="n">kvm_pfn_t</span> <span class="n">pfn</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">......</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">region</span><span class="p">.</span><span class="n">nr_pages</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span> <span class="p">{</span>
                    <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
                    <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>    

            <span class="k">if</span> <span class="p">(</span><span class="n">need_resched</span><span class="p">())</span>
                    <span class="n">cond_resched</span><span class="p">();</span>


            <span class="cm">/* Pin the source page. */</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="n">get_user_pages_fast</span><span class="p">(</span><span class="n">region</span><span class="p">.</span><span class="n">source_addr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">page</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> 
                    <span class="k">break</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span> 
                    <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
                    <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>    

            <span class="n">kvm_tdx</span><span class="o">-&gt;</span><span class="n">source_pa</span> <span class="o">=</span> <span class="n">pfn_to_hpa</span><span class="p">(</span><span class="n">page_to_pfn</span><span class="p">(</span><span class="n">page</span><span class="p">))</span> <span class="o">|</span>
                                 <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">KVM_TDX_MEASURE_MEMORY_REGION</span><span class="p">);</span>

            <span class="cm">/* TODO: large page support. */</span>
            <span class="n">error_code</span> <span class="o">=</span> <span class="n">TDX_SEPT_PFERR</span><span class="p">;</span>
            <span class="n">error_code</span> <span class="o">|=</span> <span class="p">(</span><span class="n">PG_LEVEL_4K</span> <span class="o">&lt;&lt;</span> <span class="n">PFERR_LEVEL_START_BIT</span><span class="p">)</span> <span class="o">&amp;</span>
                    <span class="n">PFERR_LEVEL_MASK</span><span class="p">;</span>
            <span class="n">pfn</span> <span class="o">=</span> <span class="n">kvm_mmu_map_tdp_page</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">region</span><span class="p">.</span><span class="n">gpa</span><span class="p">,</span> <span class="n">error_code</span><span class="p">,</span>
                                       <span class="n">PG_LEVEL_4K</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">is_error_noslot_pfn</span><span class="p">(</span><span class="n">pfn</span><span class="p">)</span> <span class="o">||</span> <span class="n">kvm</span><span class="o">-&gt;</span><span class="n">vm_bugged</span><span class="p">)</span>
                    <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
            <span class="k">else</span> 
                    <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> 

            <span class="n">put_page</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
                    <span class="k">break</span><span class="p">;</span>

            <span class="n">region</span><span class="p">.</span><span class="n">source_addr</span> <span class="o">+=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
            <span class="n">region</span><span class="p">.</span><span class="n">gpa</span> <span class="o">+=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
            <span class="n">region</span><span class="p">.</span><span class="n">nr_pages</span><span class="o">--</span><span class="p">;</span>
    <span class="p">}</span>    
</pre></td></tr></tbody></table></code></div></div>

<p>Because the passed memory region belongs to user process, it should be pinned 
by the KVM module first before being copied to TD-VM pages. Note that it invokes 
function get_user_pages_fast with <strong>region.source_addr which is the HVA</strong> of the
QEMU. Also the function assumes that all page table associated with user address
is mapped. Unless the page table has not been resolved yet to translate passed 
user space address to HPA, KVM just returns. After the pinning, each page should
be mapped through the kvm_mmu_map_tdp_page. Note that the pinned page’s physical
address is stored in kvm_tdx-&gt;source_pa. This page address will be used later to
copy the content from host page to TD VM page by __tdx_sept_set_private_spte.</p>

<h3 id="kvm_mmu_map_tdp_page"><span class="me-2">kvm_mmu_map_tdp_page</span><a href="#kvm_mmu_map_tdp_page" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>We now have pinned HVA and its physical address HPA. Also, we have target GPA
where the TDVF should be loaded into. Let’s load the memory!</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
</pre></td><td class="rouge-code"><pre><span class="n">kvm_pfn_t</span> <span class="nf">kvm_mmu_map_tdp_page</span><span class="p">(</span><span class="k">struct</span> <span class="nc">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">gpa_t</span> <span class="n">gpa</span><span class="p">,</span>
                               <span class="n">u32</span> <span class="n">error_code</span><span class="p">,</span> <span class="kt">int</span> <span class="n">max_level</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">int</span> <span class="n">r</span><span class="p">;</span>
        <span class="k">struct</span> <span class="nc">kvm_page_fault</span> <span class="n">fault</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="nc">kvm_page_fault</span><span class="p">)</span> <span class="p">{</span>
                <span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">gpa</span><span class="p">,</span>
                <span class="p">.</span><span class="n">error_code</span> <span class="o">=</span> <span class="n">error_code</span><span class="p">,</span>
                <span class="p">.</span><span class="n">exec</span> <span class="o">=</span> <span class="n">error_code</span> <span class="o">&amp;</span> <span class="n">PFERR_FETCH_MASK</span><span class="p">,</span>
                <span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">error_code</span> <span class="o">&amp;</span> <span class="n">PFERR_WRITE_MASK</span><span class="p">,</span>
                <span class="p">.</span><span class="n">present</span> <span class="o">=</span> <span class="n">error_code</span> <span class="o">&amp;</span> <span class="n">PFERR_PRESENT_MASK</span><span class="p">,</span>
                <span class="p">.</span><span class="n">rsvd</span> <span class="o">=</span> <span class="n">error_code</span> <span class="o">&amp;</span> <span class="n">PFERR_RSVD_MASK</span><span class="p">,</span>
                <span class="p">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">error_code</span> <span class="o">&amp;</span> <span class="n">PFERR_USER_MASK</span><span class="p">,</span>
                <span class="p">.</span><span class="n">prefetch</span> <span class="o">=</span> <span class="nb">false</span><span class="p">,</span>
                <span class="p">.</span><span class="n">is_tdp</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
                <span class="p">.</span><span class="n">nx_huge_page_workaround_enabled</span> <span class="o">=</span> <span class="n">is_nx_huge_page_enabled</span><span class="p">(),</span>
                <span class="p">.</span><span class="n">is_private</span> <span class="o">=</span> <span class="n">kvm_is_private_gpa</span><span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">kvm</span><span class="p">,</span> <span class="n">gpa</span><span class="p">),</span>
        <span class="p">};</span>      

        <span class="k">if</span> <span class="p">(</span><span class="n">mmu_topup_memory_caches</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="nb">false</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">KVM_PFN_ERR_FAULT</span><span class="p">;</span>

        <span class="cm">/*
         * Loop on the page fault path to handle the case where an mmu_notifier
         * invalidation triggers RET_PF_RETRY.  In the normal page fault path,
         * KVM needs to resume the guest in case the invalidation changed any
         * of the page fault properties, i.e. the gpa or error code.  For this
         * path, the gpa and error code are fixed by the caller, and the caller
         * expects failure if and only if the page fault can't be fixed.
         */</span>             
        <span class="k">do</span> <span class="p">{</span>    
                <span class="n">fault</span><span class="p">.</span><span class="n">max_level</span> <span class="o">=</span> <span class="n">max_level</span><span class="p">;</span>
                <span class="n">fault</span><span class="p">.</span><span class="n">req_level</span> <span class="o">=</span> <span class="n">PG_LEVEL_4K</span><span class="p">;</span>
                <span class="n">fault</span><span class="p">.</span><span class="n">goal_level</span> <span class="o">=</span> <span class="n">PG_LEVEL_4K</span><span class="p">;</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">direct_page_fault</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fault</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">r</span> <span class="o">==</span> <span class="n">RET_PF_RETRY</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">is_error_noslot_pfn</span><span class="p">(</span><span class="n">fault</span><span class="p">.</span><span class="n">pfn</span><span class="p">));</span>
        <span class="k">return</span> <span class="n">fault</span><span class="p">.</span><span class="n">pfn</span><span class="p">;</span>
<span class="p">}</span>               
</pre></td></tr></tbody></table></code></div></div>

<p>Although there is no page fault because we haven’t executed the VCPU yet in 
TD-VM side. However, it invokes the direct_page_fault function implementing the
page fault handling as if the EPT violation happens on the GPA that should be 
initialized. Therefore, direct_page_fault handles injected emulated page fault
and allocates all SPTE required for mapping target GPA to HPA. Also note that
the fault-in address is set as gpa which is the GPA of TD VM where the TDVF 
memory will be copied into later. After the injected page fault is resolved, the
TD VM can access the TDVF by the gpa through the generated mapping.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre><span class="k">static</span> <span class="kt">int</span> <span class="nf">direct_page_fault</span><span class="p">(</span><span class="k">struct</span> <span class="nc">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="k">struct</span> <span class="nc">kvm_page_fault</span> <span class="o">*</span><span class="n">fault</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">bool</span> <span class="n">is_tdp_mmu_fault</span> <span class="o">=</span> <span class="n">is_tdp_mmu</span><span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">mmu</span><span class="p">);</span>

        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mmu_seq</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

        <span class="n">fault</span><span class="o">-&gt;</span><span class="n">gfn</span> <span class="o">=</span> <span class="n">gpa_to_gfn</span><span class="p">(</span><span class="n">fault</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">kvm_gfn_shared_mask</span><span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">kvm</span><span class="p">);</span>
        <span class="n">fault</span><span class="o">-&gt;</span><span class="n">slot</span> <span class="o">=</span> <span class="n">kvm_vcpu_gfn_to_memslot</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">fault</span><span class="o">-&gt;</span><span class="n">gfn</span><span class="p">);</span>
        <span class="p">......</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">is_tdp_mmu_fault</span><span class="p">)</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">kvm_tdp_mmu_map</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">fault</span><span class="p">);</span>
        <span class="k">else</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">__direct_map</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">fault</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Based on the mmu configuration of vcpu, it invokes kvm_tdp_mmu_map or 
__direct_map function to handle the fault.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="k">static</span> <span class="kt">int</span> <span class="nf">__direct_map</span><span class="p">(</span><span class="k">struct</span> <span class="nc">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="k">struct</span> <span class="nc">kvm_page_fault</span> <span class="o">*</span><span class="n">fault</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">struct</span> <span class="nc">kvm_shadow_walk_iterator</span> <span class="n">it</span><span class="p">;</span>
        <span class="n">gfn_t</span> <span class="n">base_gfn</span> <span class="o">=</span> <span class="n">fault</span><span class="o">-&gt;</span><span class="n">gfn</span><span class="p">;</span>
        <span class="kt">bool</span> <span class="n">is_private</span> <span class="o">=</span> <span class="n">fault</span><span class="o">-&gt;</span><span class="n">is_private</span><span class="p">;</span>
        <span class="kt">bool</span> <span class="n">is_zapped_pte</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pte_access</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">......</span>
        <span class="n">__direct_populate_nonleaf</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">fault</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">it</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">base_gfn</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></div></div>

<p>To resolve this TDX page fault, we needs to handle two important things. The 
first is generating S-EPT mapping. The second is adding page to TD-VM.</p>

<p><a href="/assets/img/TDX//ADD_PRIVATE_PAGE.png" class="popup img-link "><img src="/assets/img/TDX//ADD_PRIVATE_PAGE.png" alt="PRIVATE_PAGE" loading="lazy"></a></p>

<h2 id="add-s-ept-for-private-page-translation-tdh_mem_sept_add"><span class="me-2">Add S-EPT for private page translation (TDH_MEM_SEPT_ADD)</span><a href="#add-s-ept-for-private-page-translation-tdh_mem_sept_add" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<p>To translate private page belong to TD-VM, it needs SPTE for non-leaf and leaf.
Whether it is non-leaf or not, for private pages, it needs to invoke SEAMCALL,
TDH_MEM_SEPT_ADD because SPTE for private pages are maintained by the TDX module.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
</pre></td><td class="rouge-code"><pre><span class="k">static</span> <span class="kt">void</span> <span class="nf">__direct_populate_nonleaf</span><span class="p">(</span><span class="k">struct</span> <span class="nc">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span>
                                <span class="k">struct</span> <span class="nc">kvm_page_fault</span> <span class="o">*</span><span class="n">fault</span><span class="p">,</span>
                                <span class="k">struct</span> <span class="nc">kvm_shadow_walk_iterator</span> <span class="o">*</span><span class="n">itp</span><span class="p">,</span>
                                <span class="n">gfn_t</span> <span class="o">*</span><span class="n">base_gfnp</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">bool</span> <span class="n">is_private</span> <span class="o">=</span> <span class="n">fault</span><span class="o">-&gt;</span><span class="n">is_private</span><span class="p">;</span>
        <span class="k">struct</span> <span class="nc">kvm_shadow_walk_iterator</span> <span class="n">it</span><span class="p">;</span>
        <span class="k">struct</span> <span class="nc">kvm_mmu_page</span> <span class="o">*</span><span class="n">sp</span><span class="p">;</span>
        <span class="n">gfn_t</span> <span class="n">base_gfn</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">kvm_gfn_shared_mask</span><span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">kvm</span><span class="p">))</span>
                <span class="n">fault</span><span class="o">-&gt;</span><span class="n">max_level</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span>
                        <span class="n">fault</span><span class="o">-&gt;</span><span class="n">max_level</span><span class="p">,</span>
                        <span class="n">max_level_of_valid_page_type</span><span class="p">(</span><span class="n">fault</span><span class="o">-&gt;</span><span class="n">gfn</span><span class="p">,</span> <span class="n">fault</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">));</span>
        <span class="cm">/*
         * Cannot map a private page to higher level if smaller level mapping
         * exists. It can be promoted to larger mapping later when all the
         * smaller mapping are there.
         */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">is_private</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">for_each_shadow_entry</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">fault</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">it</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">is_shadow_present_pte</span><span class="p">(</span><span class="o">*</span><span class="n">it</span><span class="p">.</span><span class="n">sptep</span><span class="p">))</span> <span class="p">{</span>
                                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_last_spte</span><span class="p">(</span><span class="o">*</span><span class="n">it</span><span class="p">.</span><span class="n">sptep</span><span class="p">,</span> <span class="n">it</span><span class="p">.</span><span class="n">level</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
                                        <span class="n">fault</span><span class="o">-&gt;</span><span class="n">max_level</span> <span class="o">&gt;=</span> <span class="n">it</span><span class="p">.</span><span class="n">level</span><span class="p">)</span>
                                        <span class="n">fault</span><span class="o">-&gt;</span><span class="n">max_level</span> <span class="o">=</span> <span class="n">it</span><span class="p">.</span><span class="n">level</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                                <span class="k">break</span><span class="p">;</span>
                        <span class="p">}</span>
                <span class="p">}</span>
        <span class="p">}</span>

        <span class="n">kvm_mmu_hugepage_adjust</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">fault</span><span class="p">);</span>

        <span class="n">trace_kvm_mmu_spte_requested</span><span class="p">(</span><span class="n">fault</span><span class="p">);</span>
        <span class="n">for_each_shadow_entry</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">fault</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">it</span><span class="p">)</span> <span class="p">{</span>
                <span class="cm">/*
                 * We cannot overwrite existing page tables with an NX
                 * large page, as the leaf could be executable.
                 */</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">fault</span><span class="o">-&gt;</span><span class="n">nx_huge_page_workaround_enabled</span><span class="p">)</span>
                        <span class="n">disallowed_hugepage_adjust</span><span class="p">(</span><span class="n">fault</span><span class="p">,</span> <span class="o">*</span><span class="n">it</span><span class="p">.</span><span class="n">sptep</span><span class="p">,</span> <span class="n">it</span><span class="p">.</span><span class="n">level</span><span class="p">);</span>

                <span class="n">base_gfn</span> <span class="o">=</span> <span class="n">fault</span><span class="o">-&gt;</span><span class="n">gfn</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">KVM_PAGES_PER_HPAGE</span><span class="p">(</span><span class="n">it</span><span class="p">.</span><span class="n">level</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">it</span><span class="p">.</span><span class="n">level</span> <span class="o">==</span> <span class="n">fault</span><span class="o">-&gt;</span><span class="n">goal_level</span><span class="p">)</span>
                        <span class="k">break</span><span class="p">;</span>

                <span class="n">drop_large_spte</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">it</span><span class="p">.</span><span class="n">sptep</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">is_shadow_present_pte</span><span class="p">(</span><span class="o">*</span><span class="n">it</span><span class="p">.</span><span class="n">sptep</span><span class="p">))</span>
                        <span class="k">continue</span><span class="p">;</span>

                <span class="n">sp</span> <span class="o">=</span> <span class="n">kvm_mmu_get_page</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">base_gfn</span><span class="p">,</span> <span class="n">it</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">it</span><span class="p">.</span><span class="n">level</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                                      <span class="nb">true</span><span class="p">,</span> <span class="n">ACC_ALL</span><span class="p">,</span> <span class="n">is_private</span><span class="p">);</span>

                <span class="n">link_shadow_page</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">it</span><span class="p">.</span><span class="n">sptep</span><span class="p">,</span> <span class="n">sp</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">fault</span><span class="o">-&gt;</span><span class="n">is_tdp</span> <span class="o">&amp;&amp;</span> <span class="n">fault</span><span class="o">-&gt;</span><span class="n">huge_page_disallowed</span> <span class="o">&amp;&amp;</span>
                    <span class="n">fault</span><span class="o">-&gt;</span><span class="n">req_level</span> <span class="o">&gt;=</span> <span class="n">it</span><span class="p">.</span><span class="n">level</span><span class="p">)</span>
                        <span class="n">account_huge_nx_page</span><span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">kvm</span><span class="p">,</span> <span class="n">sp</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">is_private</span><span class="p">)</span>
                        <span class="n">kvm_mmu_link_private_sp</span><span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">kvm</span><span class="p">,</span> <span class="n">sp</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="o">*</span><span class="n">itp</span> <span class="o">=</span> <span class="n">it</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">base_gfnp</span><span class="p">)</span>
                <span class="o">*</span><span class="n">base_gfnp</span> <span class="o">=</span> <span class="n">base_gfn</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="walking-shadow-page-tables"><span class="me-2">Walking shadow page tables</span><a href="#walking-shadow-page-tables" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>The main loop body of page table walking is done by for_each_shadow_entry macro.
Although the TDX Module manages S-EPT, the host VMM also maintains the mirror of
the S-EPT in host memory so that it can reduce the burden of TDX Module. For 
example, to add S-EPT for one physical page, VMM can ask the TDX Module to walk
the secure page table inside the TDX Module, but host VMM does walk the mirrored
S-EPT on behalf of the TDX Module and send request to the TDX Module for S-EPT
insertion through the SEAMCALL TDH_MEM_SEPT_ADD.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="cp">#define for_each_shadow_entry(_vcpu, _addr, _walker)            \
        for (shadow_walk_init(&amp;(_walker), _vcpu, _addr);        \
             shadow_walk_okay(&amp;(_walker));                      \
             shadow_walk_next(&amp;(_walker)))
</span></pre></td></tr></tbody></table></code></div></div>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="k">static</span> <span class="kt">void</span> <span class="nf">shadow_walk_init</span><span class="p">(</span><span class="k">struct</span> <span class="nc">kvm_shadow_walk_iterator</span> <span class="o">*</span><span class="n">iterator</span><span class="p">,</span>
                             <span class="k">struct</span> <span class="nc">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">u64</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
        <span class="n">hpa_t</span> <span class="n">root</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">tdp_enabled</span> <span class="o">&amp;&amp;</span> <span class="n">kvm_is_private_gpa</span><span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">kvm</span><span class="p">,</span> <span class="n">addr</span><span class="p">))</span>
                <span class="n">root</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">mmu</span><span class="o">-&gt;</span><span class="n">private_root_hpa</span><span class="p">;</span>
        <span class="k">else</span>
                <span class="n">root</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">mmu</span><span class="o">-&gt;</span><span class="n">root</span><span class="p">.</span><span class="n">hpa</span><span class="p">;</span>

        <span class="n">shadow_walk_init_using_root</span><span class="p">(</span><span class="n">iterator</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Based on whether the fault belongs to private or not, it selects different root
page table, private_root_hpa or root.hpa, respectively.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre></td><td class="rouge-code"><pre><span class="k">static</span> <span class="kt">void</span> <span class="nf">shadow_walk_init_using_root</span><span class="p">(</span><span class="k">struct</span> <span class="nc">kvm_shadow_walk_iterator</span> <span class="o">*</span><span class="n">iterator</span><span class="p">,</span>
                                        <span class="k">struct</span> <span class="nc">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">hpa_t</span> <span class="n">root</span><span class="p">,</span>
                                        <span class="n">u64</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
        <span class="n">iterator</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
        <span class="n">iterator</span><span class="o">-&gt;</span><span class="n">shadow_addr</span> <span class="o">=</span> <span class="n">root</span><span class="p">;</span>
        <span class="n">iterator</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">mmu</span><span class="o">-&gt;</span><span class="n">root_role</span><span class="p">.</span><span class="n">level</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">iterator</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">&gt;=</span> <span class="n">PT64_ROOT_4LEVEL</span> <span class="o">&amp;&amp;</span>
            <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">mmu</span><span class="o">-&gt;</span><span class="n">cpu_role</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">level</span> <span class="o">&lt;</span> <span class="n">PT64_ROOT_4LEVEL</span> <span class="o">&amp;&amp;</span>
            <span class="o">!</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">mmu</span><span class="o">-&gt;</span><span class="n">root_role</span><span class="p">.</span><span class="n">direct</span><span class="p">)</span>
                <span class="n">iterator</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">=</span> <span class="n">PT32E_ROOT_LEVEL</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">iterator</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">==</span> <span class="n">PT32E_ROOT_LEVEL</span><span class="p">)</span> <span class="p">{</span>
                <span class="cm">/*
                 * prev_root is currently only used for 64-bit hosts. So only
                 * the active root_hpa is valid here.
                 */</span>
                <span class="n">BUG_ON</span><span class="p">(</span><span class="n">root</span> <span class="o">!=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">mmu</span><span class="o">-&gt;</span><span class="n">root</span><span class="p">.</span><span class="n">hpa</span><span class="p">);</span>

                <span class="n">iterator</span><span class="o">-&gt;</span><span class="n">shadow_addr</span>
                        <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">mmu</span><span class="o">-&gt;</span><span class="n">pae_root</span><span class="p">[(</span><span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="mi">30</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">];</span>
                <span class="n">iterator</span><span class="o">-&gt;</span><span class="n">shadow_addr</span> <span class="o">&amp;=</span> <span class="n">PT64_BASE_ADDR_MASK</span><span class="p">;</span>
                <span class="o">--</span><span class="n">iterator</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iterator</span><span class="o">-&gt;</span><span class="n">shadow_addr</span><span class="p">)</span>
                        <span class="n">iterator</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>After setting up the root page table, it also initialize the iterator based 
on the MMU settings, and page fault address.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="k">static</span> <span class="kt">bool</span> <span class="nf">shadow_walk_okay</span><span class="p">(</span><span class="k">struct</span> <span class="nc">kvm_shadow_walk_iterator</span> <span class="o">*</span><span class="n">iterator</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">iterator</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">&lt;</span> <span class="n">PG_LEVEL_4K</span><span class="p">)</span>
                <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

        <span class="n">iterator</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="n">SHADOW_PT_INDEX</span><span class="p">(</span><span class="n">iterator</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">iterator</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">);</span>
        <span class="n">iterator</span><span class="o">-&gt;</span><span class="n">sptep</span> <span class="o">=</span> <span class="p">((</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span><span class="n">__va</span><span class="p">(</span><span class="n">iterator</span><span class="o">-&gt;</span><span class="n">shadow_addr</span><span class="p">))</span> <span class="o">+</span> <span class="n">iterator</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
        <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>
<p>After one iteration finishes, it checks if it can further go down, until leaf.
The addr field of the iterator points to the fault-in address. The index of the 
next level page table is calculated based on current level and fault-in addr.
Also, the sptep field points to the non-leaf spte or PTE of this level. Walking 
continues until the level of iterator reaches the leaf page table entry 
(PG_LEVEL_4K).</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre><span class="k">static</span> <span class="kt">void</span> <span class="nf">shadow_walk_next</span><span class="p">(</span><span class="k">struct</span> <span class="nc">kvm_shadow_walk_iterator</span> <span class="o">*</span><span class="n">iterator</span><span class="p">)</span>
<span class="p">{</span>
        <span class="n">__shadow_walk_next</span><span class="p">(</span><span class="n">iterator</span><span class="p">,</span> <span class="o">*</span><span class="n">iterator</span><span class="o">-&gt;</span><span class="n">sptep</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__shadow_walk_next</span><span class="p">(</span><span class="k">struct</span> <span class="nc">kvm_shadow_walk_iterator</span> <span class="o">*</span><span class="n">iterator</span><span class="p">,</span>
                               <span class="n">u64</span> <span class="n">spte</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_shadow_present_pte</span><span class="p">(</span><span class="n">spte</span><span class="p">)</span> <span class="o">||</span> <span class="n">is_last_spte</span><span class="p">(</span><span class="n">spte</span><span class="p">,</span> <span class="n">iterator</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">))</span> <span class="p">{</span>
                <span class="n">iterator</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">iterator</span><span class="o">-&gt;</span><span class="n">shadow_addr</span> <span class="o">=</span> <span class="n">spte</span> <span class="o">&amp;</span> <span class="n">PT64_BASE_ADDR_MASK</span><span class="p">;</span>
        <span class="o">--</span><span class="n">iterator</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>The <strong>shadow_addr</strong> member field of the iterator points to the root address of 
the next level page table or the leaf PTE.</p>

<h3 id="set-up-s-ept"><span class="me-2">Set-up S-EPT</span><a href="#set-up-s-ept" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>Before we add the S-EPT associated with the TDVF image, non-leaf S-EPT entries 
should be added into the TDX memories so that the mapping from the root to the 
leaf for the S-EPT will be populated. As a result private pages of the TD-VM can
be translated into the HPA smoothly without incurring any page faults.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre></td><td class="rouge-code"><pre>        <span class="n">for_each_shadow_entry</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">fault</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">it</span><span class="p">)</span> <span class="p">{</span>
                <span class="cm">/*
                 * We cannot overwrite existing page tables with an NX
                 * large page, as the leaf could be executable.
                 */</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">fault</span><span class="o">-&gt;</span><span class="n">nx_huge_page_workaround_enabled</span><span class="p">)</span>
                        <span class="n">disallowed_hugepage_adjust</span><span class="p">(</span><span class="n">fault</span><span class="p">,</span> <span class="o">*</span><span class="n">it</span><span class="p">.</span><span class="n">sptep</span><span class="p">,</span> <span class="n">it</span><span class="p">.</span><span class="n">level</span><span class="p">);</span>

                <span class="n">base_gfn</span> <span class="o">=</span> <span class="n">fault</span><span class="o">-&gt;</span><span class="n">gfn</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">KVM_PAGES_PER_HPAGE</span><span class="p">(</span><span class="n">it</span><span class="p">.</span><span class="n">level</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">it</span><span class="p">.</span><span class="n">level</span> <span class="o">==</span> <span class="n">fault</span><span class="o">-&gt;</span><span class="n">goal_level</span><span class="p">)</span>
                        <span class="k">break</span><span class="p">;</span>

                <span class="n">drop_large_spte</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">it</span><span class="p">.</span><span class="n">sptep</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">is_shadow_present_pte</span><span class="p">(</span><span class="o">*</span><span class="n">it</span><span class="p">.</span><span class="n">sptep</span><span class="p">))</span>
                        <span class="k">continue</span><span class="p">;</span>

                <span class="n">sp</span> <span class="o">=</span> <span class="n">kvm_mmu_get_page</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">base_gfn</span><span class="p">,</span> <span class="n">it</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">it</span><span class="p">.</span><span class="n">level</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                                      <span class="nb">true</span><span class="p">,</span> <span class="n">ACC_ALL</span><span class="p">,</span> <span class="n">is_private</span><span class="p">);</span>

                <span class="n">link_shadow_page</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">it</span><span class="p">.</span><span class="n">sptep</span><span class="p">,</span> <span class="n">sp</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">fault</span><span class="o">-&gt;</span><span class="n">is_tdp</span> <span class="o">&amp;&amp;</span> <span class="n">fault</span><span class="o">-&gt;</span><span class="n">huge_page_disallowed</span> <span class="o">&amp;&amp;</span>
                    <span class="n">fault</span><span class="o">-&gt;</span><span class="n">req_level</span> <span class="o">&gt;=</span> <span class="n">it</span><span class="p">.</span><span class="n">level</span><span class="p">)</span>
                        <span class="n">account_huge_nx_page</span><span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">kvm</span><span class="p">,</span> <span class="n">sp</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">is_private</span><span class="p">)</span>
                        <span class="n">kvm_mmu_link_private_sp</span><span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">kvm</span><span class="p">,</span> <span class="n">sp</span><span class="p">);</span>
        <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Above loop walks the private page table until the current level matches with the
level of fault-in page. While the sptep entry presents, it continues walking and
allocate one page when it does not present. kvm_mmu_get_page function allocates
new spte and link_shadow_page links the generated page to sptep of current level.
Detailed implementation is already covered in [[]]. Let’s see what difference 
has been introduced due to TDX.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre><span class="k">static</span> <span class="k">struct</span> <span class="nc">kvm_mmu_page</span> <span class="o">*</span><span class="nf">kvm_mmu_get_page</span><span class="p">(</span><span class="k">struct</span> <span class="nc">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span>
                                             <span class="n">gfn_t</span> <span class="n">gfn</span><span class="p">,</span>
                                             <span class="n">gva_t</span> <span class="n">gaddr</span><span class="p">,</span>
                                             <span class="kt">unsigned</span> <span class="n">level</span><span class="p">,</span>
                                             <span class="kt">int</span> <span class="n">direct</span><span class="p">,</span>
                                             <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">access</span><span class="p">,</span>
                                             <span class="kt">unsigned</span> <span class="kt">int</span> <span class="k">private</span><span class="p">)</span>
<span class="p">{</span>
        <span class="p">......</span>
	<span class="n">sp</span> <span class="o">=</span> <span class="n">kvm_mmu_alloc_page</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">direct</span><span class="p">,</span> <span class="k">private</span><span class="p">);</span>

        <span class="n">sp</span><span class="o">-&gt;</span><span class="n">gfn</span> <span class="o">=</span> <span class="n">gfn</span><span class="p">;</span> 
        <span class="n">sp</span><span class="o">-&gt;</span><span class="n">role</span> <span class="o">=</span> <span class="n">role</span><span class="p">;</span>                                 
        <span class="cm">/* kvm_mmu_alloc_private_sp() requires valid role. */</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">private</span><span class="p">)</span>
                <span class="n">kvm_mmu_alloc_private_sp</span><span class="p">(</span>
                        <span class="n">vcpu</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="n">level</span> <span class="o">==</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">mmu</span><span class="o">-&gt;</span><span class="n">root_role</span><span class="p">.</span><span class="n">level</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></div></div>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre><span class="cm">/* Valid sp-&gt;role.level is required. */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">kvm_mmu_alloc_private_sp</span><span class="p">(</span>
        <span class="k">struct</span> <span class="nc">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="k">struct</span> <span class="nc">kvm_mmu_page</span> <span class="o">*</span><span class="n">sp</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">is_root</span><span class="p">)</span>
<span class="p">{</span>                       
        <span class="k">if</span> <span class="p">(</span><span class="n">is_root</span><span class="p">)</span>
                <span class="n">sp</span><span class="o">-&gt;</span><span class="n">private_sp</span> <span class="o">=</span> <span class="n">KVM_MMU_PRIVATE_SP_ROOT</span><span class="p">;</span>
        <span class="k">else</span> 
                <span class="n">sp</span><span class="o">-&gt;</span><span class="n">private_sp</span> <span class="o">=</span> <span class="n">kvm_mmu_memory_cache_alloc</span><span class="p">(</span>
                        <span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">mmu_private_sp_cache</span><span class="p">);</span>
        <span class="cm">/*
         * Because mmu_private_sp_cache is topped up before staring kvm page
         * fault resolving, the allocation above shouldn't fail.
         */</span>
        <span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="o">!</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">private_sp</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>kvm_mmu_get_page allocates kvm_mmu_page. The spte page is allocated by the 
kvm_mmu_alloc_private_sp function if it is private page. One thing added for 
private SPTE is <strong>private_sp</strong> field of the kvm_mmu_mpage. To add new S-EPT, 
through the SEAMCALL, host KVM should provide memory page to TDX so that it can
use <strong>this page to fill out S-EPT</strong>. If this is not a root, 
kvm_mmu_memory_cache_alloc function allocates page for S-EPT.</p>

<p>After the SPTE page is allocated, link_shadow_page links allocated page in the 
<strong>host KVM side</strong>. Recall that KVM maintains a mirrored SPTE for private pages. 
However, we do need the S-EPT entry in the TDX side also so that the hardware 
based translation smoothly translate TD-VM private pages to the HPA during its 
execution. To this end, it additionally invokes the func kvm_mmu_link_private_sp
and add S-EPT page <strong>at TDX side</strong> through the TDH_MEM_SEPT_ADD.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre></td><td class="rouge-code"><pre><span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">kvm_mmu_link_private_sp</span><span class="p">(</span><span class="k">struct</span> <span class="nc">kvm</span> <span class="o">*</span><span class="n">kvm</span><span class="p">,</span>
                                        <span class="k">struct</span> <span class="nc">kvm_mmu_page</span> <span class="o">*</span><span class="n">sp</span><span class="p">)</span> 
<span class="p">{</span>                   
        <span class="cm">/* Link this sp to its parent spte.  + 1 for parent spte. */</span>
        <span class="k">return</span> <span class="n">static_call</span><span class="p">(</span><span class="n">kvm_x86_link_private_sp</span><span class="p">)(</span>
                <span class="n">kvm</span><span class="p">,</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">gfn</span><span class="p">,</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">role</span><span class="p">.</span><span class="n">level</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">private_sp</span><span class="p">);</span>
<span class="p">}</span>       


<span class="k">static</span> <span class="kt">int</span> <span class="nf">tdx_sept_link_private_sp</span><span class="p">(</span><span class="k">struct</span> <span class="nc">kvm</span> <span class="o">*</span><span class="n">kvm</span><span class="p">,</span> <span class="n">gfn_t</span> <span class="n">gfn</span><span class="p">,</span>
                                    <span class="k">enum</span> <span class="n">pg_level</span> <span class="n">level</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">sept_page</span><span class="p">)</span>
<span class="p">{</span>       
        <span class="kt">int</span> <span class="n">tdx_level</span> <span class="o">=</span> <span class="n">pg_level_to_tdx_sept_level</span><span class="p">(</span><span class="n">level</span><span class="p">);</span>
        <span class="k">struct</span> <span class="nc">kvm_tdx</span> <span class="o">*</span><span class="n">kvm_tdx</span> <span class="o">=</span> <span class="n">to_kvm_tdx</span><span class="p">(</span><span class="n">kvm</span><span class="p">);</span> 
        <span class="n">gpa_t</span> <span class="n">gpa</span> <span class="o">=</span> <span class="n">gfn_to_gpa</span><span class="p">(</span><span class="n">gfn</span><span class="p">);</span>
        <span class="n">hpa_t</span> <span class="n">hpa</span> <span class="o">=</span> <span class="n">__pa</span><span class="p">(</span><span class="n">sept_page</span><span class="p">);</span>
        <span class="k">struct</span> <span class="nc">tdx_module_output</span> <span class="n">out</span><span class="p">;</span>
        <span class="n">u64</span> <span class="n">err</span><span class="p">;</span>

        <span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kvm_tdx</span><span class="o">-&gt;</span><span class="n">seamcall_lock</span><span class="p">);</span>
        <span class="n">err</span> <span class="o">=</span> <span class="n">tdh_mem_sept_add</span><span class="p">(</span><span class="n">kvm_tdx</span><span class="o">-&gt;</span><span class="n">tdr</span><span class="p">.</span><span class="n">pa</span><span class="p">,</span> <span class="n">gpa</span><span class="p">,</span> <span class="n">tdx_level</span><span class="p">,</span> <span class="n">hpa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">out</span><span class="p">);</span>
        <span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kvm_tdx</span><span class="o">-&gt;</span><span class="n">seamcall_lock</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">KVM_BUG_ON</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">kvm</span><span class="p">))</span> <span class="p">{</span>
                <span class="n">pr_tdx_error</span><span class="p">(</span><span class="n">TDH_MEM_SEPT_ADD</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">out</span><span class="p">);</span>
                <span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
        <span class="p">}</span>                          

        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>       
</pre></td></tr></tbody></table></code></div></div>

<h2 id="add-private-pages-tdh_mem_page_add"><span class="me-2">Add private pages (TDH_MEM_PAGE_ADD)</span><a href="#add-private-pages-tdh_mem_page_add" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td><td class="rouge-code"><pre><span class="k">static</span> <span class="kt">int</span> <span class="nf">__direct_map</span><span class="p">(</span><span class="k">struct</span> <span class="nc">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="k">struct</span> <span class="nc">kvm_page_fault</span> <span class="o">*</span><span class="n">fault</span><span class="p">)</span>
<span class="p">{</span>                               
        <span class="k">struct</span> <span class="nc">kvm_shadow_walk_iterator</span> <span class="n">it</span><span class="p">;</span>                                     
        <span class="n">gfn_t</span> <span class="n">base_gfn</span> <span class="o">=</span> <span class="n">fault</span><span class="o">-&gt;</span><span class="n">gfn</span><span class="p">;</span>                                            
        <span class="kt">bool</span> <span class="n">is_private</span> <span class="o">=</span> <span class="n">fault</span><span class="o">-&gt;</span><span class="n">is_private</span><span class="p">;</span>                                    
        <span class="kt">bool</span> <span class="n">is_zapped_pte</span><span class="p">;</span>                                                     
        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pte_access</span><span class="p">;</span>                                                
        <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>         
        <span class="p">......</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_private</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">mmu</span><span class="o">-&gt;</span><span class="n">no_prefetch</span><span class="p">)</span>
                        <span class="n">direct_pte_prefetch</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">it</span><span class="p">.</span><span class="n">sptep</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="o">!</span><span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">RET_PF_FIXED</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">is_zapped_pte</span><span class="p">)</span>
                        <span class="n">static_call</span><span class="p">(</span><span class="n">kvm_x86_unzap_private_spte</span><span class="p">)(</span>
                                <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">kvm</span><span class="p">,</span> <span class="n">base_gfn</span><span class="p">,</span> <span class="n">it</span><span class="p">.</span><span class="n">level</span><span class="p">);</span>
                <span class="k">else</span>
                        <span class="n">static_call</span><span class="p">(</span><span class="n">kvm_x86_set_private_spte</span><span class="p">)(</span>
                                <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">kvm</span><span class="p">,</span> <span class="n">base_gfn</span><span class="p">,</span> <span class="n">it</span><span class="p">.</span><span class="n">level</span><span class="p">,</span> <span class="n">fault</span><span class="o">-&gt;</span><span class="n">pfn</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>
<p>After resolving S-EPT mappings, it returns to the __direct_map and invokes 
kvm_x86_set_private_spte function to covert host VMM pages containing TDVF into
private memory of the TD VM.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
</pre></td><td class="rouge-code"><pre><span class="k">static</span> <span class="kt">void</span> <span class="nf">__tdx_sept_set_private_spte</span><span class="p">(</span><span class="k">struct</span> <span class="nc">kvm</span> <span class="o">*</span><span class="n">kvm</span><span class="p">,</span> <span class="n">gfn_t</span> <span class="n">gfn</span><span class="p">,</span>
                                        <span class="k">enum</span> <span class="n">pg_level</span> <span class="n">level</span><span class="p">,</span> <span class="n">kvm_pfn_t</span> <span class="n">pfn</span><span class="p">)</span>
<span class="p">{</span>       
        <span class="kt">int</span> <span class="n">tdx_level</span> <span class="o">=</span> <span class="n">pg_level_to_tdx_sept_level</span><span class="p">(</span><span class="n">level</span><span class="p">);</span>
        <span class="k">struct</span> <span class="nc">kvm_tdx</span> <span class="o">*</span><span class="n">kvm_tdx</span> <span class="o">=</span> <span class="n">to_kvm_tdx</span><span class="p">(</span><span class="n">kvm</span><span class="p">);</span>
        <span class="n">hpa_t</span> <span class="n">hpa</span> <span class="o">=</span> <span class="n">pfn_to_hpa</span><span class="p">(</span><span class="n">pfn</span><span class="p">);</span>
        <span class="n">gpa_t</span> <span class="n">gpa</span> <span class="o">=</span> <span class="n">gfn_to_gpa</span><span class="p">(</span><span class="n">gfn</span><span class="p">);</span>
        <span class="k">struct</span> <span class="nc">tdx_module_output</span> <span class="n">out</span><span class="p">;</span>
        <span class="n">hpa_t</span> <span class="n">source_pa</span><span class="p">;</span>
        <span class="n">u64</span> <span class="n">err</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="n">is_error_noslot_pfn</span><span class="p">(</span><span class="n">pfn</span><span class="p">)</span> <span class="o">||</span> <span class="n">kvm_is_reserved_pfn</span><span class="p">(</span><span class="n">pfn</span><span class="p">)))</span>
                <span class="k">return</span><span class="p">;</span>
        
        <span class="cm">/* Only support 4KB and 2MB pages */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">KVM_BUG_ON</span><span class="p">(</span><span class="n">level</span> <span class="o">&gt;</span> <span class="n">PG_LEVEL_2M</span><span class="p">,</span> <span class="n">kvm</span><span class="p">))</span>
                <span class="k">return</span><span class="p">;</span>
                
        <span class="cm">/* To prevent page migration, do nothing on mmu notifier. */</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">KVM_PAGES_PER_HPAGE</span><span class="p">(</span><span class="n">level</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
                <span class="n">get_page</span><span class="p">(</span><span class="n">pfn_to_page</span><span class="p">(</span><span class="n">pfn</span> <span class="o">+</span> <span class="n">i</span><span class="p">));</span>
                
        <span class="cm">/* Build-time faults are induced and handled via TDH_MEM_PAGE_ADD. */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">is_td_finalized</span><span class="p">(</span><span class="n">kvm_tdx</span><span class="p">)))</span> <span class="p">{</span>
                <span class="cm">/*
                 * For now only 4K and 2M pages are tested by KVM MMU.
                 * TODO: support/test 1G large page.
                 */</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">KVM_BUG_ON</span><span class="p">(</span><span class="n">level</span> <span class="o">&gt;</span> <span class="n">PG_LEVEL_2M</span><span class="p">,</span> <span class="n">kvm</span><span class="p">))</span>
                        <span class="k">return</span><span class="p">;</span>

                <span class="n">err</span> <span class="o">=</span> <span class="n">tdh_mem_page_aug</span><span class="p">(</span><span class="n">kvm_tdx</span><span class="o">-&gt;</span><span class="n">tdr</span><span class="p">.</span><span class="n">pa</span><span class="p">,</span> <span class="n">gpa</span><span class="p">,</span> <span class="n">tdx_level</span><span class="p">,</span> <span class="n">hpa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">out</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">KVM_BUG_ON</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">kvm</span><span class="p">))</span> <span class="p">{</span>
                        <span class="n">pr_tdx_error</span><span class="p">(</span><span class="n">TDH_MEM_PAGE_AUG</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">out</span><span class="p">);</span>
                        <span class="n">tdx_unpin</span><span class="p">(</span><span class="n">kvm</span><span class="p">,</span> <span class="n">gfn</span><span class="p">,</span> <span class="n">pfn</span><span class="p">,</span> <span class="n">level</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="cm">/* KVM_INIT_MEM_REGION, tdx_init_mem_region(), supports only 4K page. */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">KVM_BUG_ON</span><span class="p">(</span><span class="n">level</span> <span class="o">!=</span> <span class="n">PG_LEVEL_4K</span><span class="p">,</span> <span class="n">kvm</span><span class="p">))</span>
                <span class="k">return</span><span class="p">;</span>

        <span class="cm">/*
         * In case of TDP MMU, fault handler can run concurrently.  Note
         * 'source_pa' is a TD scope variable, meaning if there are multiple
         * threads reaching here with all needing to access 'source_pa', it
         * will break.  However fortunately this won't happen, because below
         * TDH_MEM_PAGE_ADD code path is only used when VM is being created
         * before it is running, using KVM_TDX_INIT_MEM_REGION ioctl (which
         * always uses vcpu 0's page table and protected by vcpu-&gt;mutex).
         */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">KVM_BUG_ON</span><span class="p">(</span><span class="n">kvm_tdx</span><span class="o">-&gt;</span><span class="n">source_pa</span> <span class="o">==</span> <span class="n">INVALID_PAGE</span><span class="p">,</span> <span class="n">kvm</span><span class="p">))</span> <span class="p">{</span>
                <span class="n">tdx_unpin</span><span class="p">(</span><span class="n">kvm</span><span class="p">,</span> <span class="n">gfn</span><span class="p">,</span> <span class="n">pfn</span><span class="p">,</span> <span class="n">level</span><span class="p">);</span>
                <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">source_pa</span> <span class="o">=</span> <span class="n">kvm_tdx</span><span class="o">-&gt;</span><span class="n">source_pa</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">KVM_TDX_MEASURE_MEMORY_REGION</span><span class="p">;</span>

        <span class="n">err</span> <span class="o">=</span> <span class="n">tdh_mem_page_add</span><span class="p">(</span><span class="n">kvm_tdx</span><span class="o">-&gt;</span><span class="n">tdr</span><span class="p">.</span><span class="n">pa</span><span class="p">,</span> <span class="n">gpa</span><span class="p">,</span> <span class="n">tdx_level</span><span class="p">,</span> <span class="n">hpa</span><span class="p">,</span> <span class="n">source_pa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">out</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">KVM_BUG_ON</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">kvm</span><span class="p">))</span> <span class="p">{</span>
                <span class="n">pr_tdx_error</span><span class="p">(</span><span class="n">TDH_MEM_PAGE_ADD</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">out</span><span class="p">);</span>
                <span class="n">tdx_unpin</span><span class="p">(</span><span class="n">kvm</span><span class="p">,</span> <span class="n">gfn</span><span class="p">,</span> <span class="n">pfn</span><span class="p">,</span> <span class="n">level</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">((</span><span class="n">kvm_tdx</span><span class="o">-&gt;</span><span class="n">source_pa</span> <span class="o">&amp;</span> <span class="n">KVM_TDX_MEASURE_MEMORY_REGION</span><span class="p">))</span>
                <span class="n">tdx_measure_page</span><span class="p">(</span><span class="n">kvm_tdx</span><span class="p">,</span> <span class="n">gpa</span><span class="p">,</span> <span class="n">KVM_HPAGE_SIZE</span><span class="p">(</span><span class="n">level</span><span class="p">));</span>

        <span class="n">kvm_tdx</span><span class="o">-&gt;</span><span class="n">source_pa</span> <span class="o">=</span> <span class="n">INVALID_PAGE</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>If the target TD-VM has been already finalized, the page can only be inserted 
as the TDH_MEM_PAGE_AUG SEAMCALL, but if not, TDH_MEM_PAGE_ADD SEAMCALL allows 
it to have new private page.</p>

<p><a href="/assets/img/TDX//TDH_MEM_PAGE_ADD.png" class="popup img-link "><img src="/assets/img/TDX//TDH_MEM_PAGE_ADD.png" alt="MEM_PAGE_ADD" loading="lazy"></a></p>

<p>This SEAMCALL requires four important information about the addresses to add new
page to the TD VM. The first is the EPT mapping information which we already
have as a result of TDH_MEM_SEPT_ADD. The second is HPA of the TDR page. The 
third one is HPA of the target page to be added to the TD VM. And the last one 
is the address of the source page containing data/code. Note that the source_pa
points to the QEMU page containing TDVF image. gpa is the EPT mapping address 
inside the TDX Module. Recall that the main loop for S-EPT updates base_gfn to 
the updates S-EPT entry. hpa is the destination page that will be added to the 
TD VM.</p>

<h2 id="kvm_tdx_finaliaze_vm"><span class="me-2">KVM_TDX_FINALIAZE_VM</span><a href="#kvm_tdx_finaliaze_vm" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<p>After the initial set of pages is added and extended, the VMM can finalize the 
TD measurement using the TDH.MR.FINALIZE SEAMCALL. After this SEAMCALL returns 
successfully, its measurement cannot be modified anymore (except the run-time
measurement registers). Also, the TD VCPUs can enter to the TD VM through the 
TDH.VP.ENTER.</p>

<h2 id="misc"><span class="me-2">Misc</span><a href="#misc" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<h3 id="static_call"><span class="me-2">static_call</span><a href="#static_call" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p><strong>arch/x86/kvm/x86.c</strong></p>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>  <span class="mi">131</span> <span class="err">#</span><span class="n">define</span> <span class="nf">KVM_X86_OP</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>                                             \
  <span class="mi">132</span>         <span class="n">DEFINE_STATIC_CALL_NULL</span><span class="p">(</span><span class="n">kvm_x86_</span><span class="err">##</span><span class="n">func</span><span class="p">,</span>                      \
  <span class="mi">133</span>                                 <span class="o">*</span><span class="p">(((</span><span class="k">struct</span> <span class="nc">kvm_x86_ops</span> <span class="o">*</span><span class="p">)</span><span class="mi">0</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">));</span>
  <span class="mi">134</span> <span class="err">#</span><span class="n">define</span> <span class="n">KVM_X86_OP_NULL</span> <span class="n">KVM_X86_OP</span>
  <span class="mi">135</span> <span class="err">#</span><span class="n">include</span> <span class="o">&lt;</span><span class="k">asm</span><span class="o">/</span><span class="n">kvm</span><span class="o">-</span><span class="n">x86</span><span class="o">-</span><span class="n">ops</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>
</pre></td></tr></tbody></table></code></div></div>

<p><strong>asm/kvm-x86-ops.h</strong></p>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="cm">/*
 * KVM_X86_OP() and KVM_X86_OP_NULL() are used to help generate
 * "static_call()"s. They are also intended for use when defining
 * the vmx/svm kvm_x86_ops. KVM_X86_OP() can be used for those
 * functions that follow the [svm|vmx]_func_name convention.
 * KVM_X86_OP_NULL() can leave a NULL definition for the
 * case where there is no definition or a function name that
 * doesn't match the typical naming convention is supplied.
 */</span>
<span class="n">KVM_X86_OP_NULL</span><span class="p">(</span><span class="n">hardware_enable</span><span class="p">)</span>
<span class="n">KVM_X86_OP_NULL</span><span class="p">(</span><span class="n">hardware_disable</span><span class="p">)</span>
<span class="n">KVM_X86_OP_NULL</span><span class="p">(</span><span class="n">hardware_unsetup</span><span class="p">)</span>
<span class="n">KVM_X86_OP_NULL</span><span class="p">(</span><span class="n">cpu_has_accelerated_tpr</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="kvm_intel_tdx_seam_backdoor"><span class="me-2">KVM_INTEL_TDX_SEAM_BACKDOOR</span><a href="#kvm_intel_tdx_seam_backdoor" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<blockquote>
  <p>This kernel config enables Trusted Domain Extensions backdoor interface for development.
Backdoor interface provides raw interface to call TDX SEAM module for user land. This is 
only for development so that KVM doesn’t guarantee any integrity like cache coherency. 
To enable this feature, also pass tdx_seam_backdoor to the command line.</p>
</blockquote>

<p>https://lwn.net/Articles/827925/</p>
<blockquote>
  <p>SEV currently needs to pin guest memory as it doesn’t support migrating
encrypted pages.  Introduce a framework in KVM’s MMU to support pinning
pages on demand without requiring additional memory allocations, and with
(somewhat hazy) line of sight toward supporting more advanced features for
encrypted guest memory, e.g. host page migration.
The idea is to use a software available bit in the SPTE to track that a
page has been pinned.  The decision to pin a page and the actual pinning
managment is handled by vendor code via kvm_x86_ops hooks.</p>
</blockquote>

<p>Introduce a helper to directly (pun intended) fault-in a TDP page
without having to go through the full page fault path.  This allows
TDX to get the resulting pfn and also allows the RET_PF_* enums to
stay in mmu.c where they belong.</p>


  </div>

  <div class="post-tail-wrapper text-muted">
    <!-- categories -->
    
      <div class="post-meta mb-3">
        <i class="far fa-folder-open fa-fw me-1"></i>
        
          <a href="/categories/confidential-computing/">Confidential Computing</a>,
          <a href="/categories/intel-tdx/">Intel TDX</a>
      </div>
    

    <!-- tags -->
    

    <div
      class="
        post-tail-bottom
        d-flex justify-content-between align-items-center mt-5 pb-2
      "
    >
      <div class="license-wrapper">
        
          

          This post is licensed under 
        <a href="https://creativecommons.org/licenses/by/4.0/">
          CC BY 4.0
        </a>
         by the author.
        
      </div>

      <!-- Post sharing snippet -->

<div class="share-wrapper d-flex align-items-center">
  <span class="share-label text-muted">Share</span>
  <span class="share-icons">
    
    
    

    

      

      <a
        href="https://twitter.com/intent/tweet?text=TD%20VM%20Life%20Cycle%20Part%203%20-%20Ruach&url=https%3A%2F%2Fruach.github.io%2Fposts%2FTD-VM-LIFECYCLE-3%2F"
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Twitter"
        target="_blank"
        rel="noopener"
        aria-label="Twitter"
      >
        <i class="fa-fw fa-brands fa-square-x-twitter"></i>
      </a>
    

      

      <a
        href="https://www.facebook.com/sharer/sharer.php?title=TD%20VM%20Life%20Cycle%20Part%203%20-%20Ruach&u=https%3A%2F%2Fruach.github.io%2Fposts%2FTD-VM-LIFECYCLE-3%2F"
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Facebook"
        target="_blank"
        rel="noopener"
        aria-label="Facebook"
      >
        <i class="fa-fw fab fa-facebook-square"></i>
      </a>
    

      

      <a
        href="https://t.me/share/url?url=https%3A%2F%2Fruach.github.io%2Fposts%2FTD-VM-LIFECYCLE-3%2F&text=TD%20VM%20Life%20Cycle%20Part%203%20-%20Ruach"
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Telegram"
        target="_blank"
        rel="noopener"
        aria-label="Telegram"
      >
        <i class="fa-fw fab fa-telegram"></i>
      </a>
    

      

      <a
        href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fruach.github.io%2Fposts%2FTD-VM-LIFECYCLE-3%2F"
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Linkedin"
        target="_blank"
        rel="noopener"
        aria-label="Linkedin"
      >
        <i class="fa-fw fab fa-linkedin"></i>
      </a>
    

    <button
      id="copy-link"
      aria-label="Copy link"
      class="btn small"
      data-bs-toggle="tooltip"
      data-bs-placement="top"
      title="Copy link"
      data-title-succeed="Link copied successfully!"
    >
      <i class="fa-fw fas fa-link pe-none fs-6"></i>
    </button>
  </span>
</div>

    </div>
    <!-- .post-tail-bottom -->
  </div>
  <!-- div.post-tail-wrapper -->
</article>


            
          </main>

          <!-- panel -->
          <aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 mb-5 text-muted">
            <div class="access">
              <!-- Get the last 5 posts from lastmod list. -->















              <!-- The trending tags list -->


















            </div>

            
              
              



  <section id="toc-wrapper" class="ps-0 pe-4">
    <h2 class="panel-heading ps-3 pt-2 mb-2">Contents</h2>
    <nav id="toc"></nav>
  </section>


            
          </aside>
        </div>

        <div class="row">
          <!-- tail -->
          <div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4">
            
              
              <!-- Recommend the other 3 posts according to the tags and categories of the current post. -->

<!-- The total size of related posts -->


<!-- An random integer that bigger than 0 -->


<!-- Equals to TAG_SCORE / {max_categories_hierarchy} -->














  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  
    
  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  











  <aside id="related-posts" aria-labelledby="related-label">
    <h3 class="mb-4" id="related-label">Further Reading</h3>
    <nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4">
      
        <article class="col">
          <a href="/posts/TDX-SEAMLDR/" class="post-preview card h-100">
            <div class="card-body">
              <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1678424400"
  data-df="ll"
  
>
  Mar 10, 2023
</time>

              <h4 class="pt-0 my-2">TDX Module Life Cycle Part 0 (SEAMLDR)</h4>
              <div class="text-muted">
                <p>
                  





                  New CPU privileges and software layer for Intel TDX
Secure Arbitration Mode (SEAM) is an extension of Virtual Machines Extension 
(VMX). It introduces new VMX root mode called SEAM root. The primar...
                </p>
              </div>
            </div>
          </a>
        </article>
      
        <article class="col">
          <a href="/posts/TDX-MODULE-LIFECYCLE-1/" class="post-preview card h-100">
            <div class="card-body">
              <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1679284800"
  data-df="ll"
  
>
  Mar 20, 2023
</time>

              <h4 class="pt-0 my-2">TDX Module Life Cycle Part 1</h4>
              <div class="text-muted">
                <p>
                  





                  Initialize TDX module
TDX module requires few initialization steps to start service as intermediary of
the TD and VMM. To this end, TDX module requires multiple SEAMCALLs to be 
invoked, as shown i...
                </p>
              </div>
            </div>
          </a>
        </article>
      
        <article class="col">
          <a href="/posts/TDX-MODULE-LIFECYCLE-2/" class="post-preview card h-100">
            <div class="card-body">
              <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1679544000"
  data-df="ll"
  
>
  Mar 23, 2023
</time>

              <h4 class="pt-0 my-2">TDX Module Life Cycle Part 2</h4>
              <div class="text-muted">
                <p>
                  





                  In previous posts, I discussed the initialization of the TDX module using 
TDH_SYS_INIT SEAMCALL. As depicted in the image below, several additional 
configuration steps are necessary for the TDX m...
                </p>
              </div>
            </div>
          </a>
        </article>
      
    </nav>
  </aside>
  <!-- #related-posts -->


            
              
              <!-- Navigation buttons at the bottom of the post. -->

<nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation">
  
  

  
    <a
      href="/posts/TD-VM-LIFECYCLE-2/"
      class="btn btn-outline-primary"
      aria-label="Older"
    >
      <p>TD VM Life Cycle Part 2</p>
    </a>
  

  
    <a
      href="/posts/SPT-AND-MEMSLOT/"
      class="btn btn-outline-primary"
      aria-label="Newer"
    >
      <p>Shadow Page Table (SPT) and MEMSLOT</p>
    </a>
  
</nav>

            
              
              <!--  The comments switcher -->

  
  <!-- The Disqus lazy loading. -->

<div id="disqus_thread">
  <p class="text-center text-muted small">Comments powered by <a href="https://disqus.com/">Disqus</a>.</p>
</div>

<script type="text/javascript">
  var disqus_config = function () {
    this.page.url = 'https://ruach.github.io/posts/TD-VM-LIFECYCLE-3/';
    this.page.identifier = '/posts/TD-VM-LIFECYCLE-3/';
  };

  /* Lazy loading */
  var disqus_observer = new IntersectionObserver(
    function (entries) {
      if (entries[0].isIntersecting) {
        (function () {
          var d = document,
            s = d.createElement('script');
          s.src = 'https://ruach.disqus.com/embed.js';
          s.setAttribute('data-timestamp', +new Date());
          (d.head || d.body).appendChild(s);
        })();

        disqus_observer.disconnect();
      }
    },
    { threshold: [0] }
  );

  disqus_observer.observe(document.querySelector('#disqus_thread'));

  /* Auto switch theme */
  function reloadDisqus() {
    if (event.source === window && event.data && event.data.direction === ModeToggle.ID) {
      /* Disqus hasn't been loaded */
      if (typeof DISQUS === 'undefined') {
        return;
      }

      if (document.readyState == 'complete') {
        DISQUS.reset({ reload: true, config: disqus_config });
      }
    }
  }

  if (document.querySelector('.mode-toggle')) {
    window.addEventListener('message', reloadDisqus);
  }
</script>



            

            <!-- The Footer -->

<footer
  aria-label="Site Info"
  class="
    d-flex flex-column justify-content-center text-muted
    flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3
  "
>
  <p>
    ©
    <time>2024</time>
    <a href="https://ruach.github.io">Jaehyuk Lee</a>.
    
      <span
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author."
      >Some rights reserved.</span>
    
  </p>

  <p>Using the <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme for <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>
  </p>
</footer>

          </div>
        </div>

        <!-- The Search results -->

<div id="search-result-wrapper" class="d-flex justify-content-center unloaded">
  <div class="col-11 content">
    <div id="search-hints">
      <!-- The trending tags list -->


















    </div>
    <div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div>
  </div>
</div>

      </div>

      <aside aria-label="Scroll to Top">
        <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow">
          <i class="fas fa-angle-up"></i>
        </button>
      </aside>
    </div>

    <div id="mask"></div>

    
      <aside
  id="notification"
  class="toast"
  role="alert"
  aria-live="assertive"
  aria-atomic="true"
  data-bs-animation="true"
  data-bs-autohide="false"
>
  <div class="toast-header">
    <button
      type="button"
      class="btn-close ms-auto"
      data-bs-dismiss="toast"
      aria-label="Close"
    ></button>
  </div>
  <div class="toast-body text-center pt-0">
    <p class="px-2 mb-3">A new version of content is available.</p>
    <button type="button" class="btn btn-primary" aria-label="Update">
      Update
    </button>
  </div>
</aside>

    

    <!-- JavaScripts -->

    <!-- JS selector for site. -->

<!-- commons -->



<!-- layout specified -->


  

  
    <!-- image lazy-loading & popup & clipboard -->
    
  















  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  



  <script src="https://cdn.jsdelivr.net/combine/npm/jquery@3.7.1/dist/jquery.min.js,npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js,npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/magnific-popup@1.1.0/dist/jquery.magnific-popup.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.10/dayjs.min.js,npm/dayjs@1.11.10/locale/en.min.js,npm/dayjs@1.11.10/plugin/relativeTime.min.js,npm/dayjs@1.11.10/plugin/localizedFormat.min.js,npm/tocbot@4.21.2/dist/tocbot.min.js"></script>






<script defer src="/assets/js/dist/post.min.js"></script>






    

    <!--
  Jekyll Simple Search loader
  See: <https://github.com/christian-fei/Simple-Jekyll-Search>
-->





<script>
  /* Note: dependent library will be loaded in `js-selector.html` */
  SimpleJekyllSearch({
    searchInput: document.getElementById('search-input'),
    resultsContainer: document.getElementById('search-results'),
    json: '/assets/js/data/search.json',
    searchResultTemplate: '  <article class="px-1 px-sm-2 px-lg-4 px-xl-0">    <header>      <h2><a href="{url}">{title}</a></h2>      <div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1">        {categories}        {tags}      </div>    </header>    <p>{snippet}</p>  </article>',
    noResultsText: '<p class="mt-5"></p>',
    templateMiddleware: function(prop, value, template) {
      if (prop === 'categories') {
        if (value === '') {
          return `${value}`;
        } else {
          return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`;
        }
      }

      if (prop === 'tags') {
        if (value === '') {
          return `${value}`;
        } else {
          return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`;
        }
      }
    }
  });
</script>

  </body>
</html>

