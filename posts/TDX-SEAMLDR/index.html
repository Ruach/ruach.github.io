<!doctype html>














<!-- `site.alt_lang` can specify a language different from the UI -->
<html lang="en" data-mode="light">
  <!-- The Head -->

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta
    name="viewport"
    content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover"
  >

  

  

  
    <!-- Begin Jekyll SEO tag v2.8.0 -->
<meta name="generator" content="Jekyll v4.3.2" />
<meta property="og:title" content="TDX Module Life Cycle Part 0 (SEAMLDR)" />
<meta property="og:locale" content="en" />
<meta name="description" content="New CPU privileges and software layer for Intel TDX Secure Arbitration Mode (SEAM) is an extension of Virtual Machines Extension (VMX). It introduces new VMX root mode called SEAM root. The primary goal of this new root mode is to host a CPU-attested module, called TDX module, to create Trust Domains (TD), which is the secure VM instance protected from other system components including host VMM." />
<meta property="og:description" content="New CPU privileges and software layer for Intel TDX Secure Arbitration Mode (SEAM) is an extension of Virtual Machines Extension (VMX). It introduces new VMX root mode called SEAM root. The primary goal of this new root mode is to host a CPU-attested module, called TDX module, to create Trust Domains (TD), which is the secure VM instance protected from other system components including host VMM." />
<link rel="canonical" href="https://ruach.github.io/posts/TDX-SEAMLDR/" />
<meta property="og:url" content="https://ruach.github.io/posts/TDX-SEAMLDR/" />
<meta property="og:site_name" content="Ruach" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2023-03-10T00:00:00-05:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="TDX Module Life Cycle Part 0 (SEAMLDR)" />
<meta name="twitter:site" content="@ruach_lee" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2023-03-10T00:00:00-05:00","datePublished":"2023-03-10T00:00:00-05:00","description":"New CPU privileges and software layer for Intel TDX Secure Arbitration Mode (SEAM) is an extension of Virtual Machines Extension (VMX). It introduces new VMX root mode called SEAM root. The primary goal of this new root mode is to host a CPU-attested module, called TDX module, to create Trust Domains (TD), which is the secure VM instance protected from other system components including host VMM.","headline":"TDX Module Life Cycle Part 0 (SEAMLDR)","mainEntityOfPage":{"@type":"WebPage","@id":"https://ruach.github.io/posts/TDX-SEAMLDR/"},"url":"https://ruach.github.io/posts/TDX-SEAMLDR/"}</script>
<!-- End Jekyll SEO tag -->

  

  <title>TDX Module Life Cycle Part 0 (SEAMLDR) | Ruach
  </title>

  <!--
  The Favicons for Web, Android, Microsoft, and iOS (iPhone and iPad) Apps
  Generated by: https://realfavicongenerator.net/
-->



<link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png">
<link rel="manifest" href="/assets/img/favicons/site.webmanifest">
<link rel="shortcut icon" href="/assets/img/favicons/favicon.ico">
<meta name="apple-mobile-web-app-title" content="Ruach">
<meta name="application-name" content="Ruach">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml">
<meta name="theme-color" content="#ffffff">


  
    
      <link rel="preconnect" href="https://fonts.googleapis.com" >
      <link rel="dns-prefetch" href="https://fonts.googleapis.com" >
    
      <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      <link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin>
    
      <link rel="preconnect" href="https://fonts.googleapis.com" >
      <link rel="dns-prefetch" href="https://fonts.googleapis.com" >
    
      <link rel="preconnect" href="https://cdn.jsdelivr.net" >
      <link rel="dns-prefetch" href="https://cdn.jsdelivr.net" >
    

    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap">
  

  <!-- GA -->
  

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.2/css/all.min.css">

  <link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css">

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.21.2/dist/tocbot.min.css">
  

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css">
  

  
    <!-- Manific Popup -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css">
  

  <!-- JavaScript -->

  

  <!-- A placeholder to allow defining custom metadata -->

</head>


  <body>
    <!-- The Side Bar -->

<aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end">
  <header class="profile-wrapper">
    <a href="/" id="avatar" class="rounded-circle">
      
        
        <img src="/assets/img/jaehyuk.png" width="112" height="112" alt="avatar" onerror="this.style.display='none'">
      
    </a>

    <h1 class="site-title">
      <a href="/">Ruach</a>
    </h1>
    <p class="site-subtitle fst-italic mb-0">Jaehyuk Lee</p>
  </header>
  <!-- .profile-wrapper -->

  <nav class="flex-column flex-grow-1 w-100 ps-0">
    <ul class="nav">
      <!-- home -->
      <li class="nav-item">
        <a href="/" class="nav-link">
          <i class="fa-fw fas fa-home"></i>
          <span>HOME</span>
        </a>
      </li>
      <!-- the real tabs -->
      
        <li class="nav-item">
          <a href="/categories/" class="nav-link">
            <i class="fa-fw fas fa-stream"></i>
            

            <span>CATEGORIES</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/archives/" class="nav-link">
            <i class="fa-fw fas fa-archive"></i>
            

            <span>ARCHIVES</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/Professional-Career/" class="nav-link">
            <i class="fa-fw fas fa-id-card"></i>
            

            <span>PROFESSIONAL CAREER</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/about/" class="nav-link">
            <i class="fa-fw fas fa-info-circle"></i>
            

            <span>ABOUT</span>
          </a>
        </li>
        <!-- .nav-item -->
      
    </ul>
  </nav>

  <div class="sidebar-bottom d-flex flex-wrap  align-items-center w-100">
    

    
      

      
        <a
          href="javascript:location.href = 'mailto:' + ['jaehyuk','gatech.edu'].join('@')"
          aria-label="email"
          

          

          

          
        >
          <i class="fas fa-envelope"></i>
        </a>
      
    
      

      
        <a
          href="https://www.linkedin.com/in/jaehyuk-lee-29b33b121/"
          aria-label="linkedin"
          

          
            target="_blank"
            
          

          

          
            rel="noopener noreferrer"
          
        >
          <i class="fab fa-linkedin"></i>
        </a>
      
    
      

      
        <a
          href="https://github.com/Ruach"
          aria-label="github"
          

          
            target="_blank"
            
          

          

          
            rel="noopener noreferrer"
          
        >
          <i class="fab fa-github"></i>
        </a>
      
    
      

      
        <a
          href="https://stackoverflow.com/users/4460514/ruach?tab=profile"
          aria-label="stack-overflow"
          

          
            target="_blank"
            
          

          

          
            rel="noopener noreferrer"
          
        >
          <i class="fab fa-stack-overflow"></i>
        </a>
      
    
  </div>
  <!-- .sidebar-bottom -->
</aside>
<!-- #sidebar -->


    <div id="main-wrapper" class="d-flex justify-content-center">
      <div class="container d-flex flex-column px-xxl-5">
        <!-- The Top Bar -->

<header id="topbar-wrapper" aria-label="Top Bar">
  <div
    id="topbar"
    class="d-flex align-items-center justify-content-between px-lg-3 h-100"
  >
    <nav id="breadcrumb" aria-label="Breadcrumb">
      

      
        
          
            <span>
              <a href="/">
                Home
              </a>
            </span>

          
        
          
        
          
            
              <span>TDX Module Life Cycle Part 0 (SEAMLDR)</span>
            

          
        
      
    </nav>
    <!-- endof #breadcrumb -->

    <button type="button" id="sidebar-trigger" class="btn btn-link">
      <i class="fas fa-bars fa-fw"></i>
    </button>

    <div id="topbar-title">
      Post
    </div>

    <button type="button" id="search-trigger" class="btn btn-link">
      <i class="fas fa-search fa-fw"></i>
    </button>

    <search class="align-items-center ms-3 ms-lg-0">
      <i class="fas fa-search fa-fw"></i>
      <input
        class="form-control"
        id="search-input"
        type="search"
        aria-label="search"
        autocomplete="off"
        placeholder="Search..."
      >
    </search>
    <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button>
  </div>
</header>


        <div class="row flex-grow-1">
          <main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4">
            
              <!-- Refactor the HTML structure -->



<!--
  In order to allow a wide table to scroll horizontally,
  we suround the markdown table with `<div class="table-wrapper">` and `</div>`
-->



<!--
  Fixed kramdown code highlight rendering:
  https://github.com/penibelst/jekyll-compress-html/issues/101
  https://github.com/penibelst/jekyll-compress-html/issues/71#issuecomment-188144901
-->



<!-- Change the icon of checkbox -->



<!-- Handle images -->




  
  

  <!-- CDN URL -->
  

  <!-- Add image path -->
  

  
    
      
      
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      <!-- do not add shimmer by default -->
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      <!-- do not add shimmer by default -->
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  

  


<!-- Add header for code snippets -->



<!-- Create heading anchors -->





  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    

    
  

  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    

    
  

  
  

  

  
  

  




<!-- return -->




<article class="px-1">
  <header>
    <h1 data-toc-skip>TDX Module Life Cycle Part 0 (SEAMLDR)</h1>

    <div class="post-meta text-muted">
      <!-- published date -->
      <span>
        Posted
        <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1678424400"
  data-df="ll"
  
    data-bs-toggle="tooltip" data-bs-placement="bottom"
  
>
  Mar 10, 2023
</time>

      </span>

      <!-- lastmod date -->
      

      

      <div class="d-flex justify-content-between">
        <!-- author(s) -->
        <span>
          

          By

          <em>
            
              <a href="https://ruach.github.io">Jaehyuk Lee</a>
            
          </em>
        </span>

        <!-- read time -->
        <!-- Calculate the post's reading time, and display the word count in tooltip -->



<!-- words per minute -->










<!-- return element -->
<span
  class="readtime"
  data-bs-toggle="tooltip"
  data-bs-placement="bottom"
  title="6131 words"
>
  <em>34 min</em> read</span>

      </div>
      <!-- .d-flex -->
    </div>
    <!-- .post-meta -->
  </header>

  <div class="content">
    <h1 id="new-cpu-privileges-and-software-layer-for-intel-tdx">New CPU privileges and software layer for Intel TDX</h1>
<p>Secure Arbitration Mode (SEAM) is an extension of Virtual Machines Extension 
(VMX). It introduces new VMX root mode called SEAM root. The primary goal of 
this new root mode is to host a CPU-attested module, called TDX module, to 
create Trust Domains (TD), which is the secure VM instance protected from other
system components including host VMM.</p>

<p>Software that executes in <strong>SEAM root mode</strong>, defined by SEAM range registers 
(SEAMRR). The SEAM range is partitioned into two sub-ranges: MODULE_RANGE and 
P_SEAMLDR_RANGE. Therefore, only the p_seamldr and TDX module can run as SEAM
root mode.</p>

<p>Virtual machines launched/resumed from SEAM VMX root operation are TDs, and VMs
launched/resumed from legacy VMX root operation are legacy VMs. When processor
runs TD, it runs in another newly introduced CPU mode, <strong>SEAM VMX non root.</strong></p>

<p>The NP-SEAMLDR ACM helps with the initialization of the SEAM range, establishes
the P-SEAMLDR range, sets up the SEAM transfer VMCS structure for transfers to 
the Intel P-SEAMLDR module, and loads the <strong>embedded</strong> Intel P-SEAMLDR module’s 
image into the P_SEAMLDR_RANGE. Therefore, loading NP-SEAMLDR on the platform 
will automatically load the P_SEAMLDR too.</p>

<p>Because P_SEAMLDR is installed in the SEAMRR range, CPU needs to enter VMX SEAM
root mode through SEAMCALL to execute P_SEAMLDR for loading TDX Module. The TDX
module is loaded to the MODULE_RANGE by the P_SEAMLDR and provides functions to
build and manages TD-VMs.</p>

<p><a href="/assets/img/TDX//SEAMLDR.png" class="popup img-link "><img src="/assets/img/TDX//SEAMLDR.png" alt="SEAMLDR" loading="lazy"></a></p>

<h1 id="np-seamldr">NP-Seamldr</h1>
<p>NP-Seamldr is provided as an authenticated code module (AC). The primary goal is
loading P-Seamldr to the SEAMRR range.</p>

<h3 id="authenticated-code-modules-acms"><span class="me-2">Authenticated Code Modules (ACMs)</span><a href="#authenticated-code-modules-acms" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>Intel TDX utilize feature of <a href="https://en.wikipedia.org/wiki/Trusted_Execution_Technology">Intel TXT</a> to securely load the NP-SEAMLDR
and P-SEAMLDR to the memory, which guarantees only <strong>Intel signed Intel TDX 
loaders</strong> can be loaded into the memory. 
Specifically, ACM is a module digitally signed by the Intel that contain code to
be run before the traditional x86 CPU reset vector. The ACMs can be invoked 
through the GETSEC instruction, too.</p>

<h3 id="things-to-be-done-by-np-seamldr"><span class="me-2">Things to be done by NP-Seamldr</span><a href="#things-to-be-done-by-np-seamldr" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>The NP-SEAMLDR ACM is designed to follow the steps below to load or update the
Intel P-SEAMLDR module into the Persistent SEAMLDR range in SEAMRR:</p>
<ol>
  <li>Perform basic checks on current state of platform.</li>
  <li><strong>Initialize the entire SEAM memory range.</strong></li>
  <li><strong>Install the embedded P-SEAMLDR module in the P-SEAMLDR memory range.</strong></li>
  <li>Set up data and stack regions for the Intel P-SEAMLDR module.</li>
  <li><em>*Set up a single SEAM transfer VMCS</em></li>
  <li>Update the load status of the Intel P-SEAMLDR module.</li>
  <li>Exit to OS using the GETSEC[EXITAC] instruction</li>
</ol>

<p><a href="/assets/img/TDX//SEAMCALL_ENTER.png" class="popup img-link "><img src="/assets/img/TDX//SEAMCALL_ENTER.png" alt="SEAMCALL_ENTER" loading="lazy"></a></p>

<h3 id="vmcs-as-a-gateway-connecting-vmm--seam"><span class="me-2">VMCS as a gateway connecting VMM &amp; SEAM</span><a href="#vmcs-as-a-gateway-connecting-vmm--seam" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>VMCS has been used for entering and exiting the VM from host VMM. However, Intel
TDX repurposes the VMCS so that it can be utilized during CPU mode changes 
between VMM to SEAM. In software perspective, VMCS bridges host VMM and Intel 
TDX module. Also, it bridges the VMM and P-SEAMLDR. To this end, Intel TDX 
introduces SEAMCALL and SEAMRET instructions and make the processor utilize the
VMCS embedded in TDX module and P-SEAMLDR during the mode switch.</p>

<p>Because host VMM to P-SEAMLDR and TDX module interface utilize the SEAMCALL and 
SEAMRET instructions, the MSB of the rax register is used to determines where 
the SEAMCALL and SEAMRET exit and return to (1 for P-seamldr, 0 for TDX module).
Also, the transition from the VMX Root to SEAM VMX Root is presented as an <strong>VM 
exit \&amp; enter</strong>. Following the original semantic of VMX Root operation, when the 
VM exit or enter happens it jumps to the predetermined code location specified 
in the VMCS. TDX cannot believe the VMM layer so SEAMCALL switches to the VMCS 
residing in the SEAMRR range where the VMM cannot access. As a result, the 
SEAMCALL can jump to the pre-programmed locations securely. The location of the
VMCS used by the SEAMCALL and SEAMRET instructions are fixed by the TDX 
specification. VMCS for P-SEAMLDR and TDX module are initialized by 
the NP-SEAMLDR and P-SEAMLDR, respectively following the spec.</p>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">VMCS_FOR_TDX</span> <span class="o">=</span> <span class="n">IA32_SEAMRR_PHYS_BASE</span> <span class="o">+</span> <span class="mi">4096</span> <span class="o">+</span> <span class="n">CPUID</span><span class="p">.</span><span class="n">B</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="n">EDX</span> <span class="p">[</span><span class="mi">31</span><span class="o">:</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">4096</span><span class="p">.</span>
</pre></td></tr></tbody></table></code></div></div>

<p>For example, the location of the VMCS for TDX module is determined based on
which logical processor the seamcall instruction is invoked on.</p>

<p>The OS can launch the SEAMLDR ACM using the GETSEC[ENTERACCS] instruction if the
SEAMRR range enable bit(bit 11) of the IA32_SEAMRR_PHYS_MASK MSR is 1.</p>

<h2 id="deep-dive-into-np-seamldr"><span class="me-2">Deep dive into NP-SEAMLDR</span><a href="#deep-dive-into-np-seamldr" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre></td><td class="rouge-code"><pre><span class="kt">void</span> <span class="nf">ProjectAcmEntryPoint</span><span class="p">()</span>
<span class="p">{</span>   
    <span class="n">PT_CTX</span> <span class="n">PtCtx</span><span class="p">;</span>
    
    <span class="n">Init64bitComArea</span><span class="p">();</span>

    <span class="n">SeamldrCom64Data</span><span class="p">.</span><span class="n">OriginalCR4</span> <span class="o">=</span> <span class="n">OriginalCR4</span><span class="p">;</span>
    <span class="n">SeamldrCom64Data</span><span class="p">.</span><span class="n">HeaderStart</span> <span class="o">=</span> <span class="p">(</span><span class="n">UINT64</span><span class="p">)</span><span class="o">&amp;</span><span class="n">HeaderStart</span><span class="p">;</span>
    <span class="n">SeamldrCom64Data</span><span class="p">.</span><span class="n">PseamldrOffset</span> <span class="o">=</span> <span class="p">(</span><span class="n">UINT64</span><span class="p">)</span><span class="o">&amp;</span><span class="n">PSeamldrAsm</span><span class="p">;</span>
    <span class="n">SeamldrCom64Data</span><span class="p">.</span><span class="n">PseamldrSize</span> <span class="o">=</span> <span class="n">PSeamldrSizeAsm</span><span class="p">;</span>
    <span class="n">SeamldrCom64Data</span><span class="p">.</span><span class="n">PseamldrConstsOffset</span> <span class="o">=</span> <span class="p">(</span><span class="n">UINT64</span><span class="p">)</span><span class="o">&amp;</span><span class="n">PSeamldrConstAsm</span><span class="p">;</span>
    <span class="n">SeamldrCom64Data</span><span class="p">.</span><span class="n">OriginalES</span> <span class="o">=</span> <span class="n">OriginalES</span> <span class="o">&amp;</span> <span class="mh">0x0FF8</span><span class="p">;</span>
    <span class="n">SeamldrCom64Data</span><span class="p">.</span><span class="n">OriginalFS</span> <span class="o">=</span> <span class="n">OriginalFS</span> <span class="o">&amp;</span> <span class="mh">0x0FF8</span><span class="p">;</span>
    <span class="n">SeamldrCom64Data</span><span class="p">.</span><span class="n">OriginalGS</span> <span class="o">=</span> <span class="n">OriginalGS</span> <span class="o">&amp;</span> <span class="mh">0x0FF8</span><span class="p">;</span>
    <span class="n">SeamldrCom64Data</span><span class="p">.</span><span class="n">OriginalSS</span> <span class="o">=</span> <span class="n">OriginalSS</span> <span class="o">&amp;</span> <span class="mh">0x0FF8</span><span class="p">;</span>
    <span class="n">SeamldrCom64Data</span><span class="p">.</span><span class="n">OriginalECX</span> <span class="o">=</span> <span class="n">OriginalECX</span> <span class="o">&amp;</span> <span class="mh">0x0FF8</span><span class="p">;</span>

    <span class="n">MemFill</span><span class="p">((</span><span class="n">UINT8</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">SeamldrPagingTable</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SEAMLDR_PAGING_TABLE_T</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
    
    <span class="n">EstablishSeamldrPaging</span><span class="p">(</span><span class="o">&amp;</span><span class="n">SeamldrCom64Data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">PtCtx</span><span class="p">);</span>

    <span class="n">SeamldrCom64Data</span><span class="p">.</span><span class="n">PtCtxPtr</span> <span class="o">=</span> <span class="p">(</span><span class="n">UINT64</span><span class="p">)</span><span class="o">&amp;</span><span class="n">PtCtx</span><span class="p">;</span> 
    
    <span class="n">SeamldrThunk64</span><span class="p">();</span>
    
    <span class="c1">// No return to here</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>
<p>The most first function is the ProjectAcmEntryPoint. Before this function some 
assembly code sets up the stack and others to run C code.</p>

<h3 id="initializing-paging"><span class="me-2">Initializing Paging</span><a href="#initializing-paging" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>The first thing that needs to be done before running main program is enabling 
paging.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="rouge-code"><pre><span class="c1">// ;---------------------------------------------------------------------------- -</span>
<span class="c1">// ; Input tables are sorted like that from the base :</span>
<span class="c1">// ; 0x0 - PML5 base - entry at index 0 points to PML4 base</span>
<span class="c1">// ; 0x1000 - PML4 base - entry at index 0 points to PDPT base</span>
<span class="c1">// ; 0x2000 - PDPT base - entries at indices 0 - 3 point to the 4 PD tables - which can cover the whole low 4 GB space</span>
<span class="c1">// ; 0x3000 - PD table 0</span>
<span class="c1">// ; 0x4000 - PD table 1</span>
<span class="c1">// ; 0x5000 - PD table 2</span>
<span class="c1">// ; 0x6000 - PD table 3</span>
<span class="c1">// ; 0x7000 - PT table 0 - used for 1 to 1 mapping of the ACM</span>
<span class="c1">// ; 0x8000 - PT table 1 - used for 1 to 1 mapping of the ACM</span>
<span class="c1">// ; 0x9000 - PT table 2 - used for all other 4K mappings in the system. (not necessary 1 to 1)</span>
<span class="c1">// ;---------------------------------------------------------------------------- -</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="n">IA32E_PAGING_TABLE_T</span> <span class="n">Pml5</span><span class="p">;</span>
    <span class="n">IA32E_PAGING_TABLE_T</span> <span class="n">Pml4</span><span class="p">;</span>
    <span class="n">IA32E_PAGING_TABLE_T</span> <span class="n">Pdpt</span><span class="p">;</span>
    <span class="n">IA32E_PAGING_TABLE_T</span> <span class="n">Pd</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span> 
    <span class="n">IA32E_PAGING_TABLE_T</span> <span class="n">Pt</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
<span class="p">}</span> <span class="n">SEAMLDR_PAGING_TABLE_T</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></div></div>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
</pre></td><td class="rouge-code"><pre><span class="kr">__declspec</span><span class="p">(</span><span class="n">align</span><span class="p">(</span><span class="mi">4096</span><span class="p">))</span> <span class="n">SEAMLDR_PAGING_TABLE_T</span> <span class="n">SeamldrPagingTable</span><span class="p">;</span>

<span class="n">PT_CTX</span><span class="o">*</span> <span class="nf">EstablishSeamldrPaging</span><span class="p">(</span><span class="n">SEAMLDR_COM64_DATA</span> <span class="o">*</span><span class="n">pCom64</span><span class="p">,</span> <span class="n">IN</span> <span class="n">OUT</span> <span class="n">PT_CTX</span> <span class="o">*</span> <span class="n">PtCtx</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">COM_DATA</span><span class="o">*</span> <span class="n">PE2BIN_Com_Data</span> <span class="o">=</span> <span class="p">(</span><span class="n">COM_DATA</span><span class="o">*</span><span class="p">)((</span><span class="n">UINT32</span><span class="p">)</span><span class="n">AcmEntryPoint</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">COM_DATA</span><span class="p">));</span>
    <span class="c1">// We will use index 0 for PML5 and PML4 because we aren't going to map linear addresses above 4GB</span>
    <span class="n">MapPagingStructure</span><span class="p">(</span><span class="o">&amp;</span><span class="n">SeamldrPagingTable</span><span class="p">.</span><span class="n">Pml5</span><span class="p">.</span><span class="n">PT</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">SeamldrPagingTable</span><span class="p">.</span><span class="n">Pml4</span><span class="p">);</span>
    <span class="n">MapPagingStructure</span><span class="p">(</span><span class="o">&amp;</span><span class="n">SeamldrPagingTable</span><span class="p">.</span><span class="n">Pml4</span><span class="p">.</span><span class="n">PT</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">SeamldrPagingTable</span><span class="p">.</span><span class="n">Pdpt</span><span class="p">);</span>

    <span class="c1">// First indexes 0-3 in PDPT covers the whole lower 4 GB (each PD table cover 512 entries of 2MB, there are 4 PD tables)</span>
    <span class="n">MapPagingStructure</span><span class="p">(</span><span class="o">&amp;</span><span class="n">SeamldrPagingTable</span><span class="p">.</span><span class="n">Pdpt</span><span class="p">.</span><span class="n">PT</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">SeamldrPagingTable</span><span class="p">.</span><span class="n">Pd</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
    <span class="n">MapPagingStructure</span><span class="p">(</span><span class="o">&amp;</span><span class="n">SeamldrPagingTable</span><span class="p">.</span><span class="n">Pdpt</span><span class="p">.</span><span class="n">PT</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">SeamldrPagingTable</span><span class="p">.</span><span class="n">Pd</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
    <span class="n">MapPagingStructure</span><span class="p">(</span><span class="o">&amp;</span><span class="n">SeamldrPagingTable</span><span class="p">.</span><span class="n">Pdpt</span><span class="p">.</span><span class="n">PT</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">SeamldrPagingTable</span><span class="p">.</span><span class="n">Pd</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
    <span class="n">MapPagingStructure</span><span class="p">(</span><span class="o">&amp;</span><span class="n">SeamldrPagingTable</span><span class="p">.</span><span class="n">Pdpt</span><span class="p">.</span><span class="n">PT</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">SeamldrPagingTable</span><span class="p">.</span><span class="n">Pd</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>

    <span class="c1">// We will fill the entries in PD tables later, at this point they are empty and don't map anything</span>

    <span class="c1">// Now we need to establish 1-to-1 paging for the SEAMLDR ACM address space</span>
    <span class="c1">// We need to map data/stack pages with XD (execute disabled) bit, and code pages as read-only</span>
    <span class="c1">// The structure of the ACM is as follows (from low addresses to high):</span>
    <span class="c1">// 32-bit data and stack</span>
    <span class="c1">// 32-bit code</span>
    <span class="c1">// 64-bit data</span>
    <span class="c1">// 64-bit code</span>
    <span class="c1">// These offsets are stored in COM_DATA</span>

    <span class="c1">// Only bits 30:31 are relevant for low 4GB</span>
    <span class="n">UINT32</span> <span class="n">PdptIdx</span> <span class="o">=</span> <span class="p">((</span><span class="n">AcmBase</span> <span class="o">&gt;&gt;</span> <span class="mi">30</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">);</span>
    <span class="c1">// Mask the 9 index bits</span>
    <span class="n">UINT32</span> <span class="n">PdIdx</span> <span class="o">=</span> <span class="p">((</span><span class="n">AcmBase</span> <span class="o">&gt;&gt;</span> <span class="mi">21</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1FF</span><span class="p">);</span>

    <span class="n">IA32E_PAGING_TABLE_T</span><span class="o">*</span> <span class="n">Pd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">SeamldrPagingTable</span><span class="p">.</span><span class="n">Pd</span><span class="p">[</span><span class="n">PdptIdx</span><span class="p">];</span>

    <span class="n">MapPagingStructure</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Pd</span><span class="o">-&gt;</span><span class="n">PT</span><span class="p">[</span><span class="n">PdIdx</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">SeamldrPagingTable</span><span class="p">.</span><span class="n">Pt</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

    <span class="n">UINT32</span> <span class="n">PtIdx</span> <span class="o">=</span> <span class="p">((</span><span class="n">AcmBase</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1FF</span><span class="p">);</span>
    <span class="n">UINT32</span> <span class="n">LastPtIdx</span> <span class="o">=</span> <span class="n">PtIdx</span> <span class="o">+</span> <span class="p">(</span><span class="n">rounded</span><span class="p">(</span><span class="n">AcmSize</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">)</span> <span class="o">/</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
    <span class="n">UINT64</span> <span class="n">CurrentAcmPageToMap</span> <span class="o">=</span> <span class="n">AcmBase</span><span class="p">;</span>

    <span class="n">IA32E_PAGING_TABLE_T</span><span class="o">*</span> <span class="n">Pt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">SeamldrPagingTable</span><span class="p">.</span><span class="n">Pt</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

    <span class="c1">// Map the ACM 4K pages until the last index in the PT table (must be 1:1 mapping)</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">UINT32</span> <span class="n">i</span> <span class="o">=</span> <span class="n">PtIdx</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">((</span><span class="n">LastPtIdx</span> <span class="o">&lt;</span> <span class="mi">512</span><span class="p">)</span> <span class="o">?</span> <span class="n">LastPtIdx</span> <span class="o">:</span> <span class="mi">512</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">IsCodeAcmPage</span><span class="p">(</span><span class="n">PE2BIN_Com_Data</span><span class="p">,</span> <span class="n">CurrentAcmPageToMap</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="n">Map4KPage</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Pt</span><span class="o">-&gt;</span><span class="n">PT</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">CurrentAcmPageToMap</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">,</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">TRUE</span><span class="p">);</span> <span class="c1">// Not-writable, WB memtype, Executable</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="n">Map4KPage</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Pt</span><span class="o">-&gt;</span><span class="n">PT</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">CurrentAcmPageToMap</span><span class="p">,</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">);</span> <span class="c1">// Writable, WB memtype, Non-executable</span>
        <span class="p">}</span>
        <span class="n">CurrentAcmPageToMap</span> <span class="o">+=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">LastPtIdx</span> <span class="o">&gt;</span> <span class="mi">512</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// In case when the Acm mapping spans over two page tables, we need to map the PtTable1 in the PD</span>
        <span class="c1">// However there's also a possibility that we were on our last slot in the current PD, so we need to switch to the next one</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">PdIdx</span> <span class="o">==</span> <span class="mi">511</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// We won't span over the 4GB boundary in Acm, so it's ok to just +1 the PDPT index</span>
            <span class="n">PdptIdx</span> <span class="o">=</span> <span class="n">PdptIdx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
            <span class="n">Pd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">SeamldrPagingTable</span><span class="p">.</span><span class="n">Pd</span><span class="p">[</span><span class="n">PdptIdx</span><span class="p">];</span>
            <span class="n">PdIdx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="n">PdIdx</span> <span class="o">=</span> <span class="n">PdIdx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">MapPagingStructure</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Pd</span><span class="o">-&gt;</span><span class="n">PT</span><span class="p">[</span><span class="n">PdIdx</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">SeamldrPagingTable</span><span class="p">.</span><span class="n">Pt</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

        <span class="n">Pt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">SeamldrPagingTable</span><span class="p">.</span><span class="n">Pt</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

        <span class="n">PtIdx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">LastPtIdx</span> <span class="o">=</span> <span class="n">LastPtIdx</span> <span class="o">-</span> <span class="mi">512</span><span class="p">;</span>

        <span class="c1">// Map the rest of the ACM 4K pages</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">UINT32</span> <span class="n">i</span> <span class="o">=</span> <span class="n">PtIdx</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">LastPtIdx</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">IsCodeAcmPage</span><span class="p">(</span><span class="n">PE2BIN_Com_Data</span><span class="p">,</span> <span class="n">CurrentAcmPageToMap</span><span class="p">))</span>
            <span class="p">{</span>
                <span class="n">Map4KPage</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Pt</span><span class="o">-&gt;</span><span class="n">PT</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">CurrentAcmPageToMap</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">,</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">TRUE</span><span class="p">);</span> <span class="c1">// Not-writable, WB memtype, Executable</span>
            <span class="p">}</span>
            <span class="k">else</span>
            <span class="p">{</span>
                <span class="n">Map4KPage</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Pt</span><span class="o">-&gt;</span><span class="n">PT</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">CurrentAcmPageToMap</span><span class="p">,</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">);</span> <span class="c1">// Writable, WB memtype, Non-executable</span>
            <span class="p">}</span>
            <span class="n">CurrentAcmPageToMap</span> <span class="o">+=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// One of the unused PD table will be used for rest of the 4K mappings in the system (not necessary 1 to 1)</span>
    <span class="n">PdptIdx</span> <span class="o">=</span> <span class="p">(</span><span class="n">PdptIdx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">4</span><span class="p">;</span>
    <span class="n">Pd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">SeamldrPagingTable</span><span class="p">.</span><span class="n">Pd</span><span class="p">[</span><span class="n">PdptIdx</span><span class="p">];</span>

    <span class="c1">// We will use only the first index in the unused PD table for the PT Table 2</span>
    <span class="c1">// And we won't touch the rest of the indexes, to prevent confusion</span>
    <span class="n">MapPagingStructure</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Pd</span><span class="o">-&gt;</span><span class="n">PT</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">SeamldrPagingTable</span><span class="p">.</span><span class="n">Pt</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>

    <span class="c1">// Virtual base is calculated as follows:</span>
    <span class="c1">// PML5 and PML4 index is 0. PDPT index as chosen. PD index 0, PT index is 0</span>
    <span class="n">PtCtx</span><span class="o">-&gt;</span><span class="n">VirtualBaseFor4KMappings</span> <span class="o">=</span> <span class="p">(</span><span class="n">PdptIdx</span> <span class="o">&lt;&lt;</span> <span class="mi">30</span><span class="p">);</span>
    <span class="n">PtCtx</span><span class="o">-&gt;</span><span class="n">PtBaseFor4KMappings</span> <span class="o">=</span> <span class="p">(</span><span class="n">UINT64</span><span class="p">)</span><span class="o">&amp;</span><span class="n">SeamldrPagingTable</span><span class="p">.</span><span class="n">Pt</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
    <span class="n">PtCtx</span><span class="o">-&gt;</span><span class="n">NextFreePtIdx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="c1">// The last (third or fourth) unused PD table will be used for 2MB mapping in the system (not necessary 1 to 1)</span>
    <span class="c1">// This table will cover 512 * 2MB space, which 1GB, which should be enough to map the entire SEAMRR</span>
    <span class="n">PdptIdx</span> <span class="o">=</span> <span class="p">(</span><span class="n">PdptIdx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">4</span><span class="p">;</span>

    <span class="c1">// Virtual base is calculated as follows:</span>
    <span class="c1">// PML5 and PML4 index is 0. PDPT index as chosen. PD index 0</span>
    <span class="n">PtCtx</span><span class="o">-&gt;</span><span class="n">VirtualBaseFor2MBMappings</span> <span class="o">=</span> <span class="p">(</span><span class="n">PdptIdx</span> <span class="o">&lt;&lt;</span> <span class="mi">30</span><span class="p">);</span>
    <span class="n">PtCtx</span><span class="o">-&gt;</span><span class="n">PdBaseFor2MBMappings</span> <span class="o">=</span> <span class="p">(</span><span class="n">UINT64</span><span class="p">)</span><span class="o">&amp;</span><span class="n">SeamldrPagingTable</span><span class="p">.</span><span class="n">Pd</span><span class="p">[</span><span class="n">PdptIdx</span><span class="p">];</span>
    <span class="n">PtCtx</span><span class="o">-&gt;</span><span class="n">NextFreePdIdx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="c1">// Prior to enabling paging, the SEAMLDR should configure the IA32_PAT MSR with its reset default value 0x0007040600070406 (i.e.PAT0 = WB, PAT7 = UC).</span>
    <span class="n">writeMsr</span><span class="p">(</span><span class="n">MSR_IA32_PAT</span><span class="p">,</span> <span class="mh">0x00070406UL</span><span class="p">,</span> <span class="mh">0x00070406UL</span><span class="p">);</span>

    <span class="c1">// Load CR3 with the PML4/5 base - the SEAMLDR will run with either 4-level or 5-level paging, depending on the original level of the OS</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">SeamldrCom64Data</span><span class="p">.</span><span class="n">OriginalCR4</span> <span class="o">&amp;</span> <span class="n">CR4_LA57</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">__writecr3</span><span class="p">(</span><span class="o">&amp;</span><span class="n">SeamldrPagingTable</span><span class="p">.</span><span class="n">Pml5</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="n">__writecr3</span><span class="p">(</span><span class="o">&amp;</span><span class="n">SeamldrPagingTable</span><span class="p">.</span><span class="n">Pml4</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// Set EFER.LME to re-enable ia32-e</span>
    <span class="n">UINT32</span> <span class="n">RDX</span><span class="p">,</span> <span class="n">RAX</span><span class="p">;</span>
    <span class="n">readMsr</span><span class="p">(</span><span class="n">IA32_EFER_MSR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">RDX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">RAX</span><span class="p">);</span>
    <span class="n">RAX</span> <span class="o">|=</span> <span class="p">(</span><span class="n">LME</span> <span class="o">|</span> <span class="n">N_IA32_EFER_NXE</span><span class="p">);</span>
    <span class="n">writeMsr</span><span class="p">(</span><span class="n">IA32_EFER_MSR</span><span class="p">,</span> <span class="n">RDX</span><span class="p">,</span> <span class="n">RAX</span><span class="p">);</span>

    <span class="c1">// Enable paging</span>
    <span class="n">__writecr0</span><span class="p">(</span><span class="n">__readcr0</span><span class="p">()</span> <span class="o">|</span> <span class="n">CR0_PG</span> <span class="o">|</span> <span class="n">CR0_WP</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">PtCtx</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>The NP-seamldr is very simple program to load the seamldr to the SEAMRR memory 
range. To this end, it first need to be able to execute the main program of the 
NP-seamldr and needs page table mappings. Because the main body of NP-seamldr is
already loaded into physical address range [AcmBase, AcmBase+AcmSize], it only
needs page table mappings for those region for execution. 
However, during the NP-seamldr execution, it needs to map data already placed in
the physical memories, it needs additional page table entries, 4K and 2M sized
pages. Because it initializes very limited number of page tables, the virtual 
addresses covered by those page tables can only be used, which means the further
physical addresses will always be mapped to specific virtual addresses.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
</pre></td><td class="rouge-code"><pre><span class="n">UINT64</span> <span class="nf">MapPhysicalRange</span><span class="p">(</span><span class="n">PT_CTX</span> <span class="o">*</span><span class="n">pctx</span><span class="p">,</span> <span class="n">UINT64</span> <span class="n">Addr</span><span class="p">,</span> <span class="n">UINT64</span> <span class="n">size</span><span class="p">,</span> <span class="n">PAGE_ACCESS_TYPE</span> <span class="n">IsWritable</span><span class="p">,</span> <span class="n">PAGE_SIZE</span> <span class="n">PageMappingSize</span><span class="p">,</span> <span class="n">PAGE_CACHING_TYPE</span> <span class="n">IsWBMemtype</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">UINT32</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">UINT32</span> <span class="n">PagesToMap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">UINT64</span> <span class="n">Base</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">UINT64</span> <span class="n">VirtualAddr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">UINT64</span> <span class="n">OffsetInPage</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">PageMappingSize</span> <span class="o">==</span> <span class="n">PAGE_2M</span><span class="p">)</span> <span class="p">{</span>

        <span class="n">Base</span> <span class="o">=</span> <span class="n">Addr</span> <span class="o">&amp;</span> <span class="n">_2MB_MASK</span><span class="p">;</span>
        <span class="n">OffsetInPage</span> <span class="o">=</span> <span class="n">Addr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">_2MB</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
        <span class="n">PagesToMap</span> <span class="o">=</span> <span class="n">rounded</span><span class="p">((</span><span class="n">OffsetInPage</span> <span class="o">+</span> <span class="n">size</span><span class="p">),</span> <span class="n">_2MB</span><span class="p">)</span> <span class="o">/</span> <span class="n">_2MB</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">pctx</span><span class="o">-&gt;</span><span class="n">NextFreePdIdx</span> <span class="o">+</span> <span class="n">PagesToMap</span> <span class="o">&gt;</span> <span class="mi">512</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">ComSerialOut</span><span class="p">(</span><span class="s">"No free 2MB entries left to map the range"</span><span class="p">);</span>
            <span class="k">return</span> <span class="n">BAD_MAPPING</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">IA32E_PAGING_TABLE_T</span><span class="o">*</span> <span class="n">Pd</span> <span class="o">=</span> <span class="p">(</span><span class="n">IA32E_PAGING_TABLE_T</span><span class="o">*</span><span class="p">)</span><span class="n">pctx</span><span class="o">-&gt;</span><span class="n">PdBaseFor2MBMappings</span><span class="p">;</span>

        <span class="n">VirtualAddr</span> <span class="o">=</span> <span class="n">pctx</span><span class="o">-&gt;</span><span class="n">VirtualBaseFor2MBMappings</span> <span class="o">+</span> <span class="p">(</span><span class="n">pctx</span><span class="o">-&gt;</span><span class="n">NextFreePdIdx</span> <span class="o">*</span> <span class="n">_2MB</span><span class="p">)</span> <span class="o">+</span> <span class="n">OffsetInPage</span><span class="p">;</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PagesToMap</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">pctx</span><span class="o">-&gt;</span><span class="n">NextFreePdIdx</span><span class="o">++</span><span class="p">,</span> <span class="n">Base</span> <span class="o">+=</span> <span class="n">_2MB</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">Map2MBPage</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Pd</span><span class="o">-&gt;</span><span class="n">PT</span><span class="p">[</span><span class="n">pctx</span><span class="o">-&gt;</span><span class="n">NextFreePdIdx</span><span class="p">],</span> <span class="n">Base</span><span class="p">,</span> <span class="n">IsWritable</span><span class="p">,</span> <span class="n">IsWBMemtype</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>

        <span class="n">Base</span> <span class="o">=</span> <span class="n">Addr</span> <span class="o">&amp;</span> <span class="n">_4KB_MASK</span><span class="p">;</span>
        <span class="n">OffsetInPage</span> <span class="o">=</span> <span class="n">Addr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">_4KB</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
        <span class="n">PagesToMap</span> <span class="o">=</span> <span class="n">rounded</span><span class="p">((</span><span class="n">OffsetInPage</span> <span class="o">+</span> <span class="n">size</span><span class="p">),</span> <span class="n">_4KB</span><span class="p">)</span> <span class="o">/</span> <span class="n">_4KB</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">pctx</span><span class="o">-&gt;</span><span class="n">NextFreePtIdx</span> <span class="o">+</span> <span class="n">PagesToMap</span> <span class="o">&gt;</span> <span class="mi">512</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">ComSerialOut</span><span class="p">(</span><span class="s">"No free 4KB entries left to map the range"</span><span class="p">);</span>
            <span class="k">return</span> <span class="n">BAD_MAPPING</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">IA32E_PAGING_TABLE_T</span><span class="o">*</span> <span class="n">Pt</span> <span class="o">=</span> <span class="p">(</span><span class="n">IA32E_PAGING_TABLE_T</span><span class="o">*</span><span class="p">)</span><span class="n">pctx</span><span class="o">-&gt;</span><span class="n">PtBaseFor4KMappings</span><span class="p">;</span>

        <span class="n">VirtualAddr</span> <span class="o">=</span> <span class="n">pctx</span><span class="o">-&gt;</span><span class="n">VirtualBaseFor4KMappings</span> <span class="o">+</span> <span class="p">(</span><span class="n">pctx</span><span class="o">-&gt;</span><span class="n">NextFreePtIdx</span> <span class="o">*</span> <span class="n">_4KB</span><span class="p">)</span> <span class="o">+</span> <span class="n">OffsetInPage</span><span class="p">;</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PagesToMap</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">pctx</span><span class="o">-&gt;</span><span class="n">NextFreePtIdx</span><span class="o">++</span><span class="p">,</span> <span class="n">Base</span> <span class="o">+=</span> <span class="n">_4KB</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">Map4KPage</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Pt</span><span class="o">-&gt;</span><span class="n">PT</span><span class="p">[</span><span class="n">pctx</span><span class="o">-&gt;</span><span class="n">NextFreePtIdx</span><span class="p">],</span> <span class="n">Base</span><span class="p">,</span> <span class="n">IsWritable</span><span class="p">,</span> <span class="n">IsWBMemtype</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">VirtualAddr</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Note that PtBaseFor4KMappings and VirtualBaseFor2MBMappings are used depending 
on the page size used for mapping. These two variables are set to point to 4K
and 2M page table, respectively, during the page table initialization.</p>

<h3 id="jump-to-the-main-function"><span class="me-2">Jump to the main function</span><a href="#jump-to-the-main-function" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre></td><td class="rouge-code"><pre><span class="n">SeamldrThunk64</span> <span class="n">PROC</span> <span class="n">NEAR</span>  
        <span class="p">;</span>
        <span class="p">;</span> <span class="n">System</span> <span class="n">in</span> <span class="n">compatibility</span> <span class="n">mode</span>
        <span class="p">;</span>
        <span class="n">mov</span>     <span class="n">ecx</span><span class="p">,</span> <span class="n">ACM_CODE64_SELECTOR</span> <span class="p">;</span><span class="n">ACM64_CODE</span>
        <span class="n">push</span>    <span class="n">ecx</span>                     <span class="p">;</span> <span class="n">push</span> <span class="n">ecx</span> <span class="o">-</span> <span class="n">in</span> <span class="mi">32</span> <span class="n">bit</span> <span class="n">mode</span>

        <span class="n">mov</span>     <span class="n">ecx</span><span class="p">,</span> <span class="n">OFFSET</span> <span class="n">LongMode</span>
        <span class="n">push</span>    <span class="n">ecx</span>                     <span class="p">;</span> <span class="n">push</span> <span class="n">ecx</span> <span class="o">-</span> <span class="n">in</span> <span class="mi">32</span> <span class="n">bit</span> <span class="n">mode</span>
        <span class="n">retf</span>                            <span class="p">;</span> <span class="n">will</span> <span class="n">jump</span> <span class="n">to</span> <span class="n">LongMode</span> <span class="n">label</span> <span class="n">below</span>
        <span class="p">;</span>
        <span class="p">;</span> <span class="n">Long</span> <span class="n">mode</span><span class="p">.</span>
        <span class="p">;</span>
<span class="n">LongMode</span><span class="o">:</span>
        <span class="n">db</span>      <span class="mx">48h</span><span class="p">,</span> <span class="mi">0</span><span class="n">B8h</span>
        <span class="n">dq</span>      <span class="mi">0</span><span class="n">FFFFFFFFh</span>              <span class="p">;</span> <span class="n">mov</span>   <span class="n">rax</span><span class="p">,</span> <span class="mo">00000000</span><span class="n">FFFFFFFFh</span>
        <span class="n">db</span>      <span class="mx">48h</span><span class="p">,</span> <span class="mx">21h</span><span class="p">,</span> <span class="mi">0</span><span class="n">C4h</span>          <span class="p">;</span> <span class="n">and</span>   <span class="n">rsp</span><span class="p">,</span> <span class="n">rax</span>
        <span class="p">;</span>
        <span class="p">;</span> <span class="n">Call</span> <span class="mi">64</span><span class="o">-</span><span class="n">bit</span> <span class="n">entry</span> <span class="n">point</span>
        <span class="p">;</span>
        <span class="n">mov</span>     <span class="n">esi</span><span class="p">,</span> <span class="n">OFFSET</span> <span class="n">AcmEntryPoint</span>
        <span class="n">db</span>      <span class="mx">48h</span><span class="p">,</span> <span class="mx">21h</span><span class="p">,</span> <span class="mi">0</span><span class="n">C6h</span>          <span class="p">;</span> <span class="n">and</span>   <span class="n">rsi</span><span class="p">,</span> <span class="n">rax</span>

        <span class="n">mov</span>     <span class="n">ebx</span><span class="p">,</span> <span class="n">cs</span><span class="o">:</span><span class="p">[</span><span class="n">esi</span> <span class="o">-</span> <span class="n">SIZEOF</span> <span class="n">COM_DATA</span><span class="p">].</span><span class="n">COM_DATA</span><span class="p">.</span><span class="n">Code64Entry</span>
        <span class="n">db</span>      <span class="mx">48h</span><span class="p">,</span> <span class="mx">21h</span><span class="p">,</span> <span class="mi">0</span><span class="n">C3h</span>          <span class="p">;</span> <span class="n">and</span>   <span class="n">rbx</span><span class="p">,</span> <span class="n">rax</span>

        <span class="n">mov</span>     <span class="n">ecx</span><span class="p">,</span> <span class="n">OFFSET</span> <span class="n">SeamldrCom64Data</span>
        <span class="n">db</span>      <span class="mx">48h</span><span class="p">,</span> <span class="mx">21h</span><span class="p">,</span> <span class="mi">0</span><span class="n">C1h</span>          <span class="p">;</span> <span class="n">and</span>   <span class="n">rcx</span><span class="p">,</span> <span class="n">rax</span>

        <span class="n">call</span>    <span class="n">ebx</span>                     <span class="p">;</span> <span class="n">call</span> <span class="n">rbx</span>   


</pre></td></tr></tbody></table></code></div></div>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre></td><td class="rouge-code"><pre><span class="n">Entry64</span> <span class="n">PROC</span> <span class="n">FRAME</span>
        <span class="n">START_FRAME</span>
        <span class="n">MAKE_LOCAL</span>   <span class="n">pCom64data</span><span class="o">:</span><span class="n">QWORD</span>
        <span class="n">MAKE_LOCAL</span>   <span class="n">pIdt64</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">:</span><span class="n">QWORD</span>
        <span class="n">END_FRAME</span>

        <span class="p">;</span>
        <span class="p">;</span> <span class="n">Save</span> <span class="n">entry</span> <span class="n">parameter</span>
        <span class="p">;</span>
        <span class="n">mov</span>     <span class="n">pCom64data</span><span class="p">,</span> <span class="n">rcx</span>

        <span class="n">mov</span>     <span class="n">rcx</span><span class="p">,</span> <span class="n">pCom64data</span>
        <span class="p">;</span> <span class="n">backup</span> <span class="n">registers</span>
        <span class="n">mov</span>     <span class="n">QWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">rcx</span><span class="p">].</span><span class="n">SEAMLDR_COM64_DATA</span><span class="p">.</span><span class="n">OriginalR8</span><span class="p">,</span> <span class="n">r8</span>
        <span class="n">mov</span>     <span class="n">QWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">rcx</span><span class="p">].</span><span class="n">SEAMLDR_COM64_DATA</span><span class="p">.</span><span class="n">OriginalR9</span><span class="p">,</span> <span class="n">r9</span>
        <span class="n">mov</span>     <span class="n">QWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">rcx</span><span class="p">].</span><span class="n">SEAMLDR_COM64_DATA</span><span class="p">.</span><span class="n">OriginalR10</span><span class="p">,</span> <span class="n">r10</span>
        <span class="n">mov</span>     <span class="n">QWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">rcx</span><span class="p">].</span><span class="n">SEAMLDR_COM64_DATA</span><span class="p">.</span><span class="n">OriginalR11</span><span class="p">,</span> <span class="n">r11</span>
        <span class="n">mov</span>     <span class="n">QWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">rcx</span><span class="p">].</span><span class="n">SEAMLDR_COM64_DATA</span><span class="p">.</span><span class="n">OriginalR12</span><span class="p">,</span> <span class="n">r12</span>

        <span class="p">;</span> <span class="n">zero</span> <span class="n">non</span><span class="o">-</span><span class="n">input</span> <span class="n">registers</span>
        <span class="n">mov</span>     <span class="n">r13</span><span class="p">,</span> <span class="mi">0</span>
        <span class="n">mov</span>     <span class="n">r14</span><span class="p">,</span> <span class="mi">0</span>
        <span class="n">mov</span>     <span class="n">r15</span><span class="p">,</span> <span class="mi">0</span>

        <span class="p">;</span> <span class="n">Align</span> <span class="n">the</span> <span class="n">stack</span> <span class="n">pointer</span> <span class="n">to</span> <span class="mi">16</span><span class="o">-</span><span class="n">byte</span> <span class="n">before</span> <span class="n">running</span> <span class="n">the</span> <span class="n">main</span> <span class="mi">64</span><span class="o">-</span><span class="n">bit</span> <span class="n">code</span> <span class="o">-</span> <span class="n">required</span> <span class="n">from</span> <span class="n">proper</span> <span class="n">crypto</span> <span class="n">usage</span>
        <span class="n">and</span>     <span class="n">rsp</span><span class="p">,</span> <span class="mi">0</span><span class="n">fffffff0h</span>
        <span class="n">sub</span>     <span class="n">rsp</span><span class="p">,</span> <span class="mx">20h</span>

        <span class="n">call</span>    <span class="n">Target64</span>

        <span class="p">;;</span> <span class="n">SEAMLDR64</span> <span class="n">finished</span> <span class="n">running</span> <span class="n">here</span><span class="p">.</span>
        <span class="p">;;</span> <span class="n">Exit</span> <span class="n">procedure</span><span class="o">:</span>

        <span class="n">mov</span>     <span class="n">rcx</span><span class="p">,</span> <span class="n">pCom64data</span>
</pre></td></tr></tbody></table></code></div></div>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td class="rouge-code"><pre><span class="c1">//-----------------------------------------------------------------------------</span>
<span class="c1">// ACM - PE2BIN communication area</span>
<span class="c1">//-----------------------------------------------------------------------------</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="nc">_COM_DATA</span> <span class="p">{</span>
    <span class="n">UINT32</span> <span class="n">Data64Start</span><span class="p">;</span>                   <span class="c1">// Offset of 64-bit data start (and Code32End)</span>
    <span class="n">UINT32</span> <span class="n">Code64Start</span><span class="p">;</span>                   <span class="c1">// Offset of 64-bit code start</span>
    <span class="n">UINT32</span> <span class="n">Code64End</span><span class="p">;</span>                     <span class="c1">// Offset of 64-bit code end</span>
    <span class="n">UINT32</span> <span class="n">Code64Entry</span><span class="p">;</span>                   <span class="c1">// Offset of 64-bit code entry point</span>
    <span class="n">UINT32</span> <span class="n">StkStart</span><span class="p">;</span>                      <span class="c1">// Offset of stack start</span>
    <span class="n">UINT32</span> <span class="n">Code32Start</span><span class="p">;</span>                   <span class="c1">// Offset of code segment start.</span>
<span class="p">}</span> <span class="n">COM_DATA</span><span class="p">;</span>


    <span class="n">COM_DATA</span> <span class="o">&lt;</span> \
            <span class="n">OFFSET</span> <span class="n">HeaderStart</span><span class="p">,</span> \
            <span class="n">OFFSET</span> <span class="n">HeaderStart</span><span class="p">,</span> \
            <span class="n">OFFSET</span> <span class="n">HeaderStart</span><span class="p">,</span> \
            <span class="n">OFFSET</span> <span class="n">HeaderStart</span><span class="p">,</span> \
            <span class="n">OFFSET</span> <span class="n">stackStart</span><span class="p">,</span>  \
            <span class="n">OFFSET</span> <span class="n">HeaderStart</span> \
            <span class="o">&gt;</span>
</pre></td></tr></tbody></table></code></div></div>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre></td><td class="rouge-code"><pre><span class="kt">void</span> <span class="nf">Target64</span> <span class="p">(</span><span class="n">SEAMLDR_COM64_DATA</span> <span class="o">*</span><span class="n">pCom64</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">UINT64</span> <span class="n">canonicity_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">__security_init_cookie</span><span class="p">();</span>
    <span class="n">pCom64</span><span class="o">-&gt;</span><span class="n">NewIDTR</span><span class="p">.</span><span class="n">Limit</span> <span class="o">=</span> <span class="n">pCom64</span><span class="o">-&gt;</span><span class="n">OriginalIDTRLimit</span><span class="p">;</span>
    <span class="n">pCom64</span><span class="o">-&gt;</span><span class="n">NewIDTR</span><span class="p">.</span><span class="n">Base</span> <span class="o">=</span> <span class="n">pCom64</span><span class="o">-&gt;</span><span class="n">OriginalR12</span><span class="p">;</span>
    <span class="o">*</span><span class="p">(</span><span class="n">UINT64</span> <span class="o">*</span><span class="p">)(</span><span class="n">pCom64</span><span class="o">-&gt;</span><span class="n">OriginalGdtr</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">pCom64</span><span class="o">-&gt;</span><span class="n">OriginalR9</span><span class="p">;</span>
    <span class="n">pCom64</span><span class="o">-&gt;</span><span class="n">ResumeRip</span>   <span class="o">=</span> <span class="n">pCom64</span><span class="o">-&gt;</span><span class="n">OriginalR10</span><span class="p">;</span>
    <span class="n">pCom64</span><span class="o">-&gt;</span><span class="n">OriginalCR3</span> <span class="o">=</span> <span class="n">pCom64</span><span class="o">-&gt;</span><span class="n">OriginalR11</span><span class="p">;</span>
    
    <span class="n">PT_CTX</span><span class="o">*</span> <span class="n">PtCtx</span> <span class="o">=</span> <span class="p">(</span><span class="n">PT_CTX</span><span class="o">*</span><span class="p">)</span><span class="n">pCom64</span><span class="o">-&gt;</span><span class="n">PtCtxPtr</span><span class="p">;</span>
    
    <span class="n">CloseTPMLocality</span><span class="p">(</span><span class="n">PtCtx</span><span class="p">);</span>
    <span class="n">canonicity_mask</span> <span class="o">=</span> <span class="p">((</span><span class="n">pCom64</span><span class="o">-&gt;</span><span class="n">OriginalCR4</span> <span class="o">&amp;</span> <span class="n">CR4_LA57</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">CANONICITY_MASK_5LP</span> <span class="o">:</span> <span class="n">CANONICITY_MASK_4LP</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(((</span><span class="n">pCom64</span><span class="o">-&gt;</span><span class="n">ResumeRip</span> <span class="o">&amp;</span> <span class="n">canonicity_mask</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">pCom64</span><span class="o">-&gt;</span><span class="n">ResumeRip</span> <span class="o">&amp;</span> <span class="n">canonicity_mask</span><span class="p">)</span> <span class="o">!=</span> <span class="n">canonicity_mask</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">_ud2</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="n">SeamldrAcm</span><span class="p">(</span><span class="n">pCom64</span><span class="p">,</span> <span class="n">PtCtx</span><span class="p">);</span>
    <span class="n">ReopenTPMLocality</span><span class="p">(</span><span class="n">PtCtx</span><span class="p">);</span>
    <span class="o">*</span><span class="p">(</span><span class="n">UINT16</span><span class="o">*</span><span class="p">)</span><span class="n">pCom64</span><span class="o">-&gt;</span><span class="n">NewGdtr</span> <span class="o">=</span> <span class="mh">0xFFF</span><span class="p">;</span>
    <span class="o">*</span><span class="p">(</span><span class="n">UINT64</span><span class="o">*</span><span class="p">)(</span><span class="n">pCom64</span><span class="o">-&gt;</span><span class="n">NewGdtr</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">UINT64</span><span class="p">)</span><span class="n">TempGdt</span><span class="p">;</span>
    <span class="o">*</span><span class="p">(</span><span class="n">UINT64</span><span class="o">*</span><span class="p">)(</span><span class="n">TempGdt</span> <span class="o">+</span> <span class="n">pCom64</span><span class="o">-&gt;</span><span class="n">OriginalES</span><span class="p">)</span> <span class="o">=</span> <span class="n">GdtBasePtr</span><span class="p">.</span><span class="n">AcmDataDescriptor</span><span class="p">.</span><span class="n">Raw</span><span class="p">;</span>
    <span class="o">*</span><span class="p">(</span><span class="n">UINT64</span><span class="o">*</span><span class="p">)(</span><span class="n">TempGdt</span> <span class="o">+</span> <span class="n">pCom64</span><span class="o">-&gt;</span><span class="n">OriginalFS</span><span class="p">)</span> <span class="o">=</span> <span class="n">GdtBasePtr</span><span class="p">.</span><span class="n">AcmDataDescriptor</span><span class="p">.</span><span class="n">Raw</span><span class="p">;</span>
    <span class="o">*</span><span class="p">(</span><span class="n">UINT64</span><span class="o">*</span><span class="p">)(</span><span class="n">TempGdt</span> <span class="o">+</span> <span class="n">pCom64</span><span class="o">-&gt;</span><span class="n">OriginalGS</span><span class="p">)</span> <span class="o">=</span> <span class="n">GdtBasePtr</span><span class="p">.</span><span class="n">AcmDataDescriptor</span><span class="p">.</span><span class="n">Raw</span><span class="p">;</span>
    <span class="o">*</span><span class="p">(</span><span class="n">UINT64</span><span class="o">*</span><span class="p">)(</span><span class="n">TempGdt</span> <span class="o">+</span> <span class="n">pCom64</span><span class="o">-&gt;</span><span class="n">OriginalSS</span><span class="p">)</span> <span class="o">=</span> <span class="n">GdtBasePtr</span><span class="p">.</span><span class="n">AcmDataDescriptor</span><span class="p">.</span><span class="n">Raw</span><span class="p">;</span>
    <span class="o">*</span><span class="p">(</span><span class="n">UINT64</span><span class="o">*</span><span class="p">)(</span><span class="n">TempGdt</span> <span class="o">+</span> <span class="n">pCom64</span><span class="o">-&gt;</span><span class="n">OriginalECX</span><span class="p">)</span> <span class="o">=</span> <span class="n">GdtBasePtr</span><span class="p">.</span><span class="n">AcmCode64Descriptor</span><span class="p">.</span><span class="n">Raw</span><span class="p">;</span>
<span class="p">}</span>

</pre></td></tr></tbody></table></code></div></div>

<h3 id="seamldracm"><span class="me-2">SeamldrAcm</span><a href="#seamldracm" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
</pre></td><td class="rouge-code"><pre><span class="kt">void</span> <span class="nf">SeamldrAcm</span><span class="p">(</span><span class="n">SEAMLDR_COM64_DATA</span> <span class="o">*</span><span class="n">pCom64</span><span class="p">,</span> <span class="n">PT_CTX</span><span class="o">*</span> <span class="n">PtCtx</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">......</span>
    <span class="n">SeamrrBaseMsr</span><span class="p">.</span><span class="n">raw</span> <span class="o">=</span> <span class="n">readMsr64</span><span class="p">(</span><span class="n">MSR_IA32_SEAMRR_BASE</span><span class="p">);</span>
    <span class="n">SeamrrMaskMsr</span><span class="p">.</span><span class="n">raw</span> <span class="o">=</span> <span class="n">readMsr64</span><span class="p">(</span><span class="n">MSR_IA32_SEAMRR_MASK</span><span class="p">);</span>
    <span class="p">......</span>
    <span class="n">SeamldrData</span><span class="p">.</span><span class="n">TdxPrivateKidMask</span> <span class="o">=</span> <span class="n">KidBitMask</span> <span class="o">&lt;&lt;</span> <span class="p">((</span><span class="n">UINT64</span><span class="p">)</span><span class="n">GetMaxPhyAddr</span><span class="p">()</span> <span class="o">-</span> <span class="n">NumTdxPrivateBits</span><span class="p">);</span>

    <span class="n">SeamldrData</span><span class="p">.</span><span class="n">SeamrrBase</span> <span class="o">=</span> <span class="p">(</span><span class="n">SeamrrBaseMsr</span><span class="p">.</span><span class="n">raw</span> <span class="o">&amp;</span> <span class="n">B_SEAMRR_BASE</span><span class="p">);</span>
    <span class="n">SeamldrData</span><span class="p">.</span><span class="n">SeamrrSize</span> <span class="o">=</span> <span class="o">~</span><span class="p">(</span><span class="n">shiftLeft64</span><span class="p">(</span><span class="n">SeamrrMaskMsr</span><span class="p">.</span><span class="n">mask</span><span class="p">,</span> <span class="n">N_SEAMRR_MASK_MASK</span><span class="p">)</span> <span class="o">|</span> <span class="n">SeamldrData</span><span class="p">.</span><span class="n">TdxPrivateKidMask</span> <span class="o">|</span> <span class="p">(</span><span class="o">~</span><span class="n">SeamldrData</span><span class="p">.</span><span class="n">MaximumSupportMemAddress</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">......</span>
    <span class="c1">// Map the SysInfoTable as a single 4KB page with UC memtype</span>
    <span class="n">SeamldrData</span><span class="p">.</span><span class="n">PSysInfoTable</span> <span class="o">=</span> <span class="p">(</span><span class="n">P_SYS_INFO_TABLE_t</span><span class="o">*</span><span class="p">)</span><span class="n">MapPhysicalRange</span><span class="p">(</span><span class="n">PtCtx</span><span class="p">,</span> <span class="n">SeamldrData</span><span class="p">.</span><span class="n">SeamrrBase</span> <span class="o">+</span> <span class="n">SeamldrData</span><span class="p">.</span><span class="n">SeamrrSize</span> <span class="o">-</span> <span class="n">PAGE4K</span><span class="p">,</span> <span class="n">PAGE4K</span><span class="p">,</span> <span class="n">PAGE_WRITABLE</span><span class="p">,</span> <span class="n">PAGE_4K</span><span class="p">,</span> <span class="n">PAGE_UC_MEMTYPE</span><span class="p">);</span>

    <span class="n">PRINT_HEX_VAL</span><span class="p">(</span><span class="s">"SeamldrData.SysInfoTable-&gt;PSeamldrRange.Size: 0x"</span><span class="p">,</span> <span class="n">SeamldrData</span><span class="p">.</span><span class="n">PSysInfoTable</span><span class="o">-&gt;</span><span class="n">PSeamldrRange</span><span class="p">.</span><span class="n">Size</span><span class="p">);</span>
    <span class="n">PRINT_HEX_VAL</span><span class="p">(</span><span class="s">"SeamldrData.PSeamldrConsts-&gt;CCodeRgnSize: 0x"</span><span class="p">,</span> <span class="n">SeamldrData</span><span class="p">.</span><span class="n">PSeamldrConsts</span><span class="o">-&gt;</span><span class="n">CCodeRgnSize</span><span class="p">);</span>
    <span class="n">PRINT_HEX_VAL</span><span class="p">(</span><span class="s">"SeamldrData.PSeamldrConsts-&gt;CDataStackSize: 0x"</span><span class="p">,</span> <span class="n">SeamldrData</span><span class="p">.</span><span class="n">PSeamldrConsts</span><span class="o">-&gt;</span><span class="n">CDataStackSize</span><span class="p">);</span>
    <span class="n">PRINT_HEX_VAL</span><span class="p">(</span><span class="s">"SeamldrData.PSeamldrConsts-&gt;CDataRgnSize: 0x"</span><span class="p">,</span> <span class="n">SeamldrData</span><span class="p">.</span><span class="n">PSeamldrConsts</span><span class="o">-&gt;</span><span class="n">CDataRgnSize</span><span class="p">);</span>
    <span class="p">......</span>
    <span class="n">SeamldrData</span><span class="p">.</span><span class="n">AslrRand</span> <span class="o">=</span> <span class="p">(((</span><span class="n">UINT64</span><span class="p">)(</span><span class="n">Rrrr</span> <span class="o">&amp;</span> <span class="n">ASLR_MASK</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">);</span>
    <span class="p">......</span>
    <span class="n">Status</span> <span class="o">=</span> <span class="n">LoadModuleCode</span><span class="p">((</span><span class="n">UINT8</span><span class="o">*</span><span class="p">)</span> <span class="n">pCom64</span><span class="o">-&gt;</span><span class="n">PseamldrOffset</span><span class="p">,</span> <span class="n">pCom64</span><span class="o">-&gt;</span><span class="n">PseamldrSize</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">Status</span> <span class="o">!=</span> <span class="n">NP_SEAMLDR_PARAMS_STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ComSerialOut</span><span class="p">(</span><span class="s">"Loading P-Seamldr code failed</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="k">goto</span> <span class="n">EXIT</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="n">InitPseamldrPtCtx</span><span class="p">(</span><span class="o">&amp;</span><span class="n">SeamrrPtCtx</span><span class="p">,</span> <span class="n">SeamldrData</span><span class="p">.</span><span class="n">SeamrrVa</span><span class="p">,</span> <span class="n">SeamldrData</span><span class="p">.</span><span class="n">SeamrrBase</span><span class="p">,</span> <span class="n">SeamldrData</span><span class="p">.</span><span class="n">SeamrrSize</span><span class="p">,</span> <span class="n">SeamldrData</span><span class="p">.</span><span class="n">PSysInfoTable</span><span class="o">-&gt;</span><span class="n">PSeamldrRange</span><span class="p">.</span><span class="n">Base</span><span class="p">,</span> <span class="n">CPagingStructSize</span><span class="p">);</span>

    <span class="n">Status</span> <span class="o">=</span> <span class="n">RelocateImage</span><span class="p">(</span><span class="n">SeamldrData</span><span class="p">.</span><span class="n">SeamrrVaLimit</span> <span class="o">-</span> <span class="p">(</span><span class="n">SeamldrData</span><span class="p">.</span><span class="n">PSeamldrConsts</span><span class="o">-&gt;</span><span class="n">CCodeRgnSize</span> <span class="o">+</span> <span class="n">C_P_SYS_INFO_TABLE_SIZE</span><span class="p">),</span> <span class="n">C_CODE_RGN_BASE</span> <span class="o">|</span> <span class="n">SeamldrData</span><span class="p">.</span><span class="n">AslrRand</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">Status</span> <span class="o">!=</span> <span class="n">NP_SEAMLDR_PARAMS_STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ComSerialOut</span><span class="p">(</span><span class="s">"Failed to relocate P-Seamldr</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="k">goto</span> <span class="n">EXIT</span><span class="p">;</span>
    <span class="p">};</span>  
    
    <span class="n">Status</span> <span class="o">=</span> <span class="n">MapModulePages</span><span class="p">(</span><span class="o">&amp;</span><span class="n">SeamrrPtCtx</span><span class="p">,</span> <span class="n">pCom64</span><span class="o">-&gt;</span><span class="n">PseamldrSize</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">Status</span> <span class="o">!=</span> <span class="n">NP_SEAMLDR_PARAMS_STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ComSerialOut</span><span class="p">(</span><span class="s">"Failed to map module pages</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="k">goto</span> <span class="n">EXIT</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="n">ComSerialOut</span><span class="p">(</span><span class="s">"Setup stacks</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="n">Status</span> <span class="o">=</span> <span class="n">SetupStacks</span><span class="p">(</span><span class="o">&amp;</span><span class="n">SeamrrPtCtx</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">Status</span> <span class="o">!=</span> <span class="n">NP_SEAMLDR_PARAMS_STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ComSerialOut</span><span class="p">(</span><span class="s">"Failed to setup stacks</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="k">goto</span> <span class="n">EXIT</span><span class="p">;</span>
    <span class="p">};</span>  
    <span class="n">ComSerialOut</span><span class="p">(</span><span class="s">"Setup keyhole</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="c1">//    DEBUG ((EFI_D_INFO, ("Setup keyhole\n"));</span>
    <span class="n">Status</span> <span class="o">=</span> <span class="n">SetupKeyholeMapping</span><span class="p">(</span><span class="o">&amp;</span><span class="n">SeamrrPtCtx</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">Status</span> <span class="o">!=</span> <span class="n">NP_SEAMLDR_PARAMS_STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ComSerialOut</span><span class="p">(</span><span class="s">"Failed to setup keyholes</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="k">goto</span> <span class="n">EXIT</span><span class="p">;</span>
    <span class="p">};</span>
    
    <span class="n">ComSerialOut</span><span class="p">(</span><span class="s">"Setup Data Region</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="n">Status</span> <span class="o">=</span> <span class="n">SetupDataRegion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">SeamrrPtCtx</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">Status</span> <span class="o">!=</span> <span class="n">NP_SEAMLDR_PARAMS_STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ComSerialOut</span><span class="p">(</span><span class="s">"Failed to setup data region</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="k">goto</span> <span class="n">EXIT</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="c1">// map system information tables</span>
    <span class="n">ComSerialOut</span><span class="p">(</span><span class="s">"Map SysInfoTable</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="n">Status</span> <span class="o">=</span> <span class="n">MapSysInfoTables</span><span class="p">(</span><span class="o">&amp;</span><span class="n">SeamrrPtCtx</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">Status</span> <span class="o">!=</span> <span class="n">NP_SEAMLDR_PARAMS_STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">goto</span> <span class="n">EXIT</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">ComSerialOut</span><span class="p">(</span><span class="s">"Setup Module Region</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="n">Status</span> <span class="o">=</span> <span class="n">MapModuleRegion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">SeamrrPtCtx</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">Status</span> <span class="o">!=</span> <span class="n">NP_SEAMLDR_PARAMS_STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ComSerialOut</span><span class="p">(</span><span class="s">"Failed to map Module Region!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="k">goto</span> <span class="n">EXIT</span><span class="p">;</span>
    <span class="p">}</span>


    <span class="n">ComSerialOut</span><span class="p">(</span><span class="s">"Setup PSysinfo table</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="n">SetupSysInfoTable</span><span class="p">();</span>

    <span class="n">ComSerialOut</span><span class="p">(</span><span class="s">"Setup VMCS</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="n">SetupVmcs</span><span class="p">(</span><span class="n">SeamrrPtCtx</span><span class="p">.</span><span class="n">PtBaseAddrPa</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="loading-p-seamldr"><span class="me-2">Loading P-SEAMLDR</span><a href="#loading-p-seamldr" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre><span class="n">SEAMRR_PT_CTX</span><span class="o">*</span> <span class="nf">InitPseamldrPtCtx</span><span class="p">(</span><span class="n">OUT</span> <span class="n">SEAMRR_PT_CTX</span><span class="o">*</span> <span class="n">SeamrrPtCtx</span><span class="p">,</span> <span class="n">UINT64</span> <span class="n">SeamRrVa</span><span class="p">,</span> <span class="n">UINT64</span> <span class="n">SeamRrBase</span><span class="p">,</span> <span class="n">UINT64</span> <span class="n">SeamRrSize</span><span class="p">,</span> <span class="n">UINT64</span> <span class="n">PSeamldrRangeBase</span><span class="p">,</span> <span class="n">UINT64</span> <span class="n">PagingStructSize</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">ComSerialOut</span><span class="p">(</span><span class="s">"InitSeamrrPtCtx</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="n">PRINT_HEX_VAL</span><span class="p">(</span><span class="s">"SeamRrBase: 0x"</span><span class="p">,</span> <span class="n">SeamRrBase</span><span class="p">);</span>
    <span class="n">PRINT_HEX_VAL</span><span class="p">(</span><span class="s">"SeamRrSize: 0x"</span><span class="p">,</span> <span class="n">SeamRrSize</span><span class="p">);</span>

    <span class="n">SeamrrPtCtx</span><span class="o">-&gt;</span><span class="n">PtBaseAddrLa</span> <span class="o">=</span> <span class="n">SeamRrVa</span> <span class="o">+</span> <span class="p">(</span><span class="n">PSeamldrRangeBase</span> <span class="o">-</span> <span class="n">SeamRrBase</span><span class="p">)</span> <span class="o">+</span> <span class="n">_8KB</span><span class="p">;</span>
    <span class="n">SeamrrPtCtx</span><span class="o">-&gt;</span><span class="n">PtBaseAddrPa</span> <span class="o">=</span> <span class="n">SeamRrBase</span> <span class="o">+</span> <span class="p">(</span><span class="n">PSeamldrRangeBase</span> <span class="o">-</span> <span class="n">SeamRrBase</span><span class="p">)</span> <span class="o">+</span> <span class="n">_8KB</span><span class="p">;</span>

    <span class="n">SeamrrPtCtx</span><span class="o">-&gt;</span><span class="n">PtAllocatorPa</span> <span class="o">=</span> <span class="n">SeamrrPtCtx</span><span class="o">-&gt;</span><span class="n">PtBaseAddrPa</span> <span class="o">+</span> <span class="n">_4KB</span><span class="p">;</span>
    <span class="n">SeamrrPtCtx</span><span class="o">-&gt;</span><span class="n">NumPageLevels</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>

    <span class="n">SeamrrPtCtx</span><span class="o">-&gt;</span><span class="n">VPDelta</span> <span class="o">=</span> <span class="n">SeamRrVa</span> <span class="o">-</span> <span class="n">SeamRrBase</span><span class="p">;</span>

    <span class="n">SeamrrPtCtx</span><span class="o">-&gt;</span><span class="n">PagingStructSize</span> <span class="o">=</span> <span class="n">PagingStructSize</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="setup-pagetable-and-memory-region-for-p-seamldr"><span class="me-2">Setup pagetable and memory region for P-SEAMLDR</span><a href="#setup-pagetable-and-memory-region-for-p-seamldr" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>Until now, we have used the MapPhysicalRange function to map the physical pages
to the virtual addresses which can be accessible inside the NP-SEAMLDR. For this 
we have set the page tables for NP-SEAMLDR. However, the page tables and mapped
virtual address should not be shared between the NP and P SEAMLDR. Also, because
SEAMCALL interface utilize the VM exit interface to enter P-SEAMLDR, instead of 
making the P-SEAMLDR revisit all the step we did go through in the NP-SEAMLDR,
NP-SEAMLDR can prepare page tables and memory regions during its initialization.
Following the below equation, the root page table address is determined.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">SeamrrPtCtx</span><span class="o">-&gt;</span><span class="n">PtBaseAddrPa</span> <span class="o">=</span> <span class="n">SeamRrBase</span> <span class="o">+</span> <span class="p">(</span><span class="n">PSeamldrRangeBase</span> <span class="o">-</span> <span class="n">SeamRrBase</span><span class="p">)</span> <span class="o">+</span> <span class="n">_8KB</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Also, the NP-SEAMLDR prepared some memory regions for P-SEAMLDR such as stack, 
keyhole, data region, &amp;c. Because those memory regions are should be accessible 
by the P-SEAMLDR, not by NP-SEAMLDR, it is useless to generate mapping for the 
NP-SEAMLDR. Therefore, it populates mapping for those regions P-SEAMLDR’s page
table using MapPage function. It walks the P-SEAMLDR’s page table and allocate
mapping for the passed virtual addresses. With this efforts, the P-SEAMLDR can 
accesses it code and data regions without going through all initial steps such 
as page table initialization. Also, the P-SEAMLDR’s binary is mapped using the 
same function, MapPage.</p>

<h3 id="setup-sysinfo-table-for-p-seamldr"><span class="me-2">Setup SysInfo table for P-SEAMLDR</span><a href="#setup-sysinfo-table-for-p-seamldr" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre><span class="kt">void</span> <span class="nf">SetupSysInfoTable</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">SeamldrData</span><span class="p">.</span><span class="n">PSysInfoTable</span><span class="o">-&gt;</span><span class="n">CodeRgn</span><span class="p">.</span><span class="n">Base</span> <span class="o">=</span> <span class="n">C_CODE_RGN_BASE</span> <span class="o">|</span> <span class="n">SeamldrData</span><span class="p">.</span><span class="n">AslrRand</span><span class="p">;</span>
    <span class="n">SeamldrData</span><span class="p">.</span><span class="n">PSysInfoTable</span><span class="o">-&gt;</span><span class="n">CodeRgn</span><span class="p">.</span><span class="n">Size</span> <span class="o">=</span> <span class="n">SeamldrData</span><span class="p">.</span><span class="n">PSeamldrConsts</span><span class="o">-&gt;</span><span class="n">CCodeRgnSize</span><span class="p">;</span>
    <span class="n">SeamldrData</span><span class="p">.</span><span class="n">PSysInfoTable</span><span class="o">-&gt;</span><span class="n">DataRgn</span><span class="p">.</span><span class="n">Base</span> <span class="o">=</span> <span class="n">C_DATA_RGN_BASE</span> <span class="o">|</span> <span class="n">SeamldrData</span><span class="p">.</span><span class="n">AslrRand</span><span class="p">;</span>
    <span class="n">SeamldrData</span><span class="p">.</span><span class="n">PSysInfoTable</span><span class="o">-&gt;</span><span class="n">DataRgn</span><span class="p">.</span><span class="n">Size</span> <span class="o">=</span> <span class="n">SeamldrData</span><span class="p">.</span><span class="n">PSeamldrConsts</span><span class="o">-&gt;</span><span class="n">CDataRgnSize</span><span class="p">;</span>
    <span class="n">SeamldrData</span><span class="p">.</span><span class="n">PSysInfoTable</span><span class="o">-&gt;</span><span class="n">StackRgn</span><span class="p">.</span><span class="n">Base</span> <span class="o">=</span> <span class="n">C_STACK_RGN_BASE</span> <span class="o">|</span> <span class="n">SeamldrData</span><span class="p">.</span><span class="n">AslrRand</span><span class="p">;</span>
    <span class="n">SeamldrData</span><span class="p">.</span><span class="n">PSysInfoTable</span><span class="o">-&gt;</span><span class="n">StackRgn</span><span class="p">.</span><span class="n">Size</span> <span class="o">=</span> <span class="n">SeamldrData</span><span class="p">.</span><span class="n">PSeamldrConsts</span><span class="o">-&gt;</span><span class="n">CDataStackSize</span> <span class="o">+</span> <span class="n">P_SEAMLDR_SHADOW_STACK_SIZE</span><span class="p">;</span>
    <span class="n">SeamldrData</span><span class="p">.</span><span class="n">PSysInfoTable</span><span class="o">-&gt;</span><span class="n">KeyholeRgn</span><span class="p">.</span><span class="n">Base</span> <span class="o">=</span> <span class="n">C_KEYHOLE_RGN_BASE</span> <span class="o">|</span> <span class="n">SeamldrData</span><span class="p">.</span><span class="n">AslrRand</span><span class="p">;</span>
    <span class="n">SeamldrData</span><span class="p">.</span><span class="n">PSysInfoTable</span><span class="o">-&gt;</span><span class="n">KeyholeRgn</span><span class="p">.</span><span class="n">Size</span> <span class="o">=</span> <span class="n">SeamldrData</span><span class="p">.</span><span class="n">PSeamldrConsts</span><span class="o">-&gt;</span><span class="n">CKeyholeRgnSize</span><span class="p">;</span>
    <span class="n">SeamldrData</span><span class="p">.</span><span class="n">PSysInfoTable</span><span class="o">-&gt;</span><span class="n">KeyholeEditRgn</span><span class="p">.</span><span class="n">Base</span> <span class="o">=</span> <span class="n">C_KEYHOLE_EDIT_REGION_BASE</span> <span class="o">|</span> <span class="n">SeamldrData</span><span class="p">.</span><span class="n">AslrRand</span><span class="p">;</span>
    <span class="n">SeamldrData</span><span class="p">.</span><span class="n">PSysInfoTable</span><span class="o">-&gt;</span><span class="n">KeyholeEditRgn</span><span class="p">.</span><span class="n">Size</span> <span class="o">=</span> <span class="n">SeamldrData</span><span class="p">.</span><span class="n">PSeamldrConsts</span><span class="o">-&gt;</span><span class="n">CKeyholeEditRgnSize</span><span class="p">;</span>
    <span class="n">SeamldrData</span><span class="p">.</span><span class="n">PSysInfoTable</span><span class="o">-&gt;</span><span class="n">ModuleRgnBase</span> <span class="o">=</span> <span class="n">C_MODULE_RGN_BASE</span> <span class="o">|</span> <span class="n">SeamldrData</span><span class="p">.</span><span class="n">AslrRand</span><span class="p">;</span>
    <span class="n">SeamldrData</span><span class="p">.</span><span class="n">PSysInfoTable</span><span class="o">-&gt;</span><span class="n">AcmX2ApicId</span> <span class="o">=</span> <span class="n">GetX2ApicId</span><span class="p">();</span>
    <span class="n">SeamldrData</span><span class="p">.</span><span class="n">PSysInfoTable</span><span class="o">-&gt;</span><span class="n">AcmX2ApicIdValid</span> <span class="o">=</span> <span class="n">SYS_INFO_TABLE_X2APICID_VALID</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>
<p>The PSysInfoTable is used by the P-SEAMLDR. To pass the table to P-SEAMLDR, 
later during setting up the VMCS for P-SEAMLDR, the address of the table is 
pointed to by the host FSBASE.</p>

<h3 id="setup-vmcs-for-p-seamldr"><span class="me-2">Setup VMCS for P-SEAMLDR</span><a href="#setup-vmcs-for-p-seamldr" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
</pre></td><td class="rouge-code"><pre><span class="kt">void</span> <span class="nf">SetupVmcs</span><span class="p">(</span><span class="n">UINT64</span> <span class="n">SeamPtBaseAddr</span><span class="p">)</span> <span class="p">{</span>

    <span class="n">UINT64</span> <span class="n">VmcsBaseVa</span> <span class="o">=</span> <span class="n">SeamldrData</span><span class="p">.</span><span class="n">SeamrrVa</span> <span class="o">+</span> <span class="p">(</span><span class="n">SeamldrData</span><span class="p">.</span><span class="n">PSysInfoTable</span><span class="o">-&gt;</span><span class="n">PSeamldrRange</span><span class="p">.</span><span class="n">Base</span> <span class="o">-</span> <span class="n">SeamldrData</span><span class="p">.</span><span class="n">SeamrrBase</span><span class="p">)</span> <span class="o">+</span> <span class="n">_4KB</span><span class="p">;</span>
    <span class="n">VmxBasicMsr_u</span> <span class="n">VmxBasic</span><span class="p">;</span>
    <span class="n">UINT32</span> <span class="n">PinbasedCtls</span><span class="p">;</span>
    <span class="n">UINT32</span> <span class="n">ProcbasedCtls</span><span class="p">;</span>
    <span class="n">UINT32</span> <span class="n">ExitCtls</span><span class="p">;</span>
    <span class="n">UINT32</span> <span class="n">EntryCtls</span><span class="p">;</span>
    <span class="n">UINT64</span> <span class="n">Cr0Fixed0</span><span class="p">,</span> <span class="n">Cr0Fixed1</span><span class="p">,</span> <span class="n">Cr0MustBe1</span><span class="p">;</span>
    <span class="n">UINT64</span> <span class="n">Cr4Fixed0</span><span class="p">,</span> <span class="n">Cr4Fixed1</span><span class="p">,</span> <span class="n">Cr4MustBe1</span><span class="p">;</span>

    <span class="n">VmxBasic</span><span class="p">.</span><span class="n">raw</span> <span class="o">=</span> <span class="n">readMsr64</span><span class="p">(</span><span class="n">IA32_VMX_BASIC_MSR_INDEX</span><span class="p">);</span>

    <span class="n">PinbasedCtls</span> <span class="o">=</span> <span class="p">(</span><span class="n">UINT32</span><span class="p">)(</span><span class="n">readMsr64</span><span class="p">(</span><span class="n">IA32_VMX_TRUE_PINBASED_CTLS_MSR_INDEX</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MAX_DWORD</span><span class="p">);</span>
    <span class="n">ProcbasedCtls</span> <span class="o">=</span> <span class="p">(</span><span class="n">UINT32</span><span class="p">)(</span><span class="n">readMsr64</span><span class="p">(</span><span class="n">IA32_VMX_TRUE_PROCBASED_CTLS_MSR_INDEX</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MAX_DWORD</span><span class="p">);</span>
    <span class="n">ExitCtls</span> <span class="o">=</span> <span class="p">(</span><span class="n">UINT32</span><span class="p">)(</span><span class="n">readMsr64</span><span class="p">(</span><span class="n">IA32_VMX_TRUE_EXIT_CTLS_MSR_ADDR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MAX_DWORD</span><span class="p">);</span>
    <span class="n">EntryCtls</span> <span class="o">=</span> <span class="p">(</span><span class="n">UINT32</span><span class="p">)(</span><span class="n">readMsr64</span><span class="p">(</span><span class="n">IA32_VMX_TRUE_ENTRY_CTLS_MSR_ADDR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MAX_DWORD</span><span class="p">);</span>

    <span class="n">Cr0Fixed0</span> <span class="o">=</span> <span class="n">readMsr64</span><span class="p">(</span><span class="n">IA32_VMX_CR0_FIXED0_MSR_INDEX</span><span class="p">);</span>
    <span class="n">Cr0Fixed1</span> <span class="o">=</span> <span class="n">readMsr64</span><span class="p">(</span><span class="n">IA32_VMX_CR0_FIXED1_MSR_INDEX</span><span class="p">);</span>
    <span class="n">Cr0MustBe1</span> <span class="o">=</span> <span class="n">Cr0Fixed1</span> <span class="o">&amp;</span> <span class="n">Cr0Fixed0</span><span class="p">;</span>
    <span class="n">Cr4Fixed0</span> <span class="o">=</span> <span class="n">readMsr64</span><span class="p">(</span><span class="n">IA32_VMX_CR4_FIXED0_MSR_INDEX</span><span class="p">);</span>
    <span class="n">Cr4Fixed1</span> <span class="o">=</span> <span class="n">readMsr64</span><span class="p">(</span><span class="n">IA32_VMX_CR4_FIXED1_MSR_INDEX</span><span class="p">);</span>
    <span class="n">Cr4MustBe1</span> <span class="o">=</span> <span class="n">Cr4Fixed1</span> <span class="o">&amp;</span> <span class="n">Cr4Fixed0</span><span class="p">;</span>

    <span class="n">Wr_Guest_RIP</span><span class="p">(</span><span class="n">VmcsBaseVa</span><span class="p">,</span> <span class="n">NON_CANONICAL_RIP</span><span class="p">);</span>
    <span class="n">Wr_Host_CR0</span><span class="p">(</span><span class="n">VmcsBaseVa</span><span class="p">,</span> <span class="n">CR0_PE</span> <span class="o">|</span> <span class="n">CR0_ET</span> <span class="o">|</span> <span class="n">CR0_NE</span> <span class="o">|</span> <span class="n">CR0_WP</span> <span class="o">|</span> <span class="n">CR0_PG</span> <span class="o">|</span> <span class="n">Cr0MustBe1</span><span class="p">);</span>
    <span class="n">Wr_Host_CR3</span><span class="p">(</span><span class="n">VmcsBaseVa</span><span class="p">,</span> <span class="n">SeamPtBaseAddr</span><span class="p">);</span>
    <span class="n">Wr_Host_CR4</span><span class="p">(</span><span class="n">VmcsBaseVa</span><span class="p">,</span> <span class="n">CR4_DE</span> <span class="o">|</span> <span class="n">CR4_PAE</span> <span class="o">|</span> <span class="n">CR4_PGE</span> <span class="o">|</span> <span class="n">CR4_OSFXSR</span> <span class="o">|</span> <span class="n">CR4_OSXMMEXCPT</span> <span class="o">|</span> <span class="n">CR4_VMXE</span> <span class="o">|</span> <span class="n">CR4_FSGSBASE</span> <span class="o">|</span> <span class="n">CR4_OSXSAVE</span> <span class="o">|</span> <span class="n">CR4_SMEP</span> <span class="o">|</span> <span class="n">CR4_SMAP</span> <span class="o">|</span> <span class="n">CR4_CET</span> <span class="o">|</span> <span class="n">Cr4MustBe1</span><span class="p">);</span>
    <span class="n">Wr_Host_CS_Selector</span><span class="p">(</span><span class="n">VmcsBaseVa</span><span class="p">,</span> <span class="mi">8U</span><span class="p">);</span>
    <span class="n">Wr_Host_SS_Selector</span><span class="p">(</span><span class="n">VmcsBaseVa</span><span class="p">,</span> <span class="mh">0x10U</span><span class="p">);</span>
    <span class="n">Wr_Host_FS_Selector</span><span class="p">(</span><span class="n">VmcsBaseVa</span><span class="p">,</span> <span class="mh">0x18U</span><span class="p">);</span>
    <span class="n">Wr_Host_GS_Selector</span><span class="p">(</span><span class="n">VmcsBaseVa</span><span class="p">,</span> <span class="mh">0x18U</span><span class="p">);</span>
    <span class="n">Wr_Host_TR_Selector</span><span class="p">(</span><span class="n">VmcsBaseVa</span><span class="p">,</span> <span class="mh">0x20U</span><span class="p">);</span>
    <span class="n">Wr_Host_IA32_PAT</span><span class="p">(</span><span class="n">VmcsBaseVa</span><span class="p">,</span> <span class="mh">0x0006060606060606ULL</span><span class="p">);</span>
    <span class="n">Wr_Host_IA32_S_Cet</span><span class="p">(</span><span class="n">VmcsBaseVa</span><span class="p">,</span> <span class="n">IA32_CR_S_CET_SH_STK_EN_MASK</span> <span class="o">|</span> <span class="n">IA32_CR_S_CET_ENDBR_EN_MASK</span> <span class="o">|</span> <span class="n">IA32_CR_S_CET_NO_TRACK_EN_MASK</span><span class="p">);</span>
    <span class="n">Wr_Host_IA32_EFER</span><span class="p">(</span><span class="n">VmcsBaseVa</span><span class="p">,</span> <span class="n">N_IA32_EFER_LMA</span> <span class="o">|</span> <span class="n">LME</span> <span class="o">|</span> <span class="n">N_IA32_EFER_NXE</span><span class="p">);</span>

    <span class="n">ExitCtls</span> <span class="o">|=</span> <span class="p">(</span><span class="n">VM_EXIT_CTRL_SAVE_DEBUG_CTRL</span> <span class="o">|</span> <span class="n">VM_EXIT_CTRL_HOST_ADDR_SPACE_SIZE</span> <span class="o">|</span> <span class="n">VM_EXIT_CTRL_SAVE_IA32_PAT</span> <span class="o">|</span> <span class="n">VM_EXIT_CTRL_LOAD_IA32_PAT</span> <span class="o">|</span> \
                 <span class="n">VM_EXIT_CTRL_SAVE_IA32_EFER</span> <span class="o">|</span> <span class="n">VM_EXIT_CTRL_LOAD_IA32_EFER</span> <span class="o">|</span> <span class="n">VM_EXIT_CTRL_CONCEAL_VMX_FROM_PT</span> <span class="o">|</span> <span class="n">VM_EXIT_CTRL_CLEAR_IA32_RTIT_CTL</span> <span class="o">|</span> \
                 <span class="n">VM_EXIT_CTRL_CLEAR_LBR_CTL</span> <span class="o">|</span> <span class="n">VM_EXIT_CTRL_LOAD_CET_HOST_STATE</span> <span class="o">|</span> <span class="n">VM_EXIT_SAVE_IA32_PERF_GLOBAL_CTRL</span> <span class="o">|</span> <span class="n">VM_EXIT_LOAD_IA32_PERF_GLOBAL_CTRL</span><span class="p">);</span>

    <span class="n">ExitCtls</span> <span class="o">&amp;=</span> <span class="p">((</span><span class="n">readMsr64</span><span class="p">(</span><span class="n">IA32_VMX_TRUE_EXIT_CTLS_MSR_ADDR</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MAX_DWORD</span><span class="p">);</span>

    <span class="n">Wr_VM_Exit_Control</span><span class="p">(</span><span class="n">VmcsBaseVa</span><span class="p">,</span> <span class="n">ExitCtls</span><span class="p">);</span>

    <span class="n">EntryCtls</span> <span class="o">|=</span> <span class="p">(</span><span class="n">VM_ENTRY_CTRL_LOAD_DEBUG_CTRL</span> <span class="o">|</span> <span class="n">VM_ENTRY_CTRL_LOAD_IA32_PERF_GLOBAL_CTRL</span> <span class="o">|</span> <span class="n">VM_ENTRY_CTRL_LOAD_IA32_PAT</span> <span class="o">|</span> <span class="n">VM_ENTRY_CTRL_LOAD_IA32_EFER</span> <span class="o">|</span> \
                  <span class="n">VM_ENTRY_CTRL_CONCEAL_VMX_FROM_PT</span> <span class="o">|</span> <span class="n">VM_ENTRY_CTRL_LOAD_UINV</span> <span class="o">|</span> <span class="n">VM_ENTRY_CTRL_LOAD_IA32_PKRS</span> <span class="o">|</span> \
                  <span class="n">VM_ENTRY_CTRL_LOAD_IA32_RTIT_CTL</span> <span class="o">|</span> <span class="n">VM_ENTRY_CTRL_LOAD_GUEST_CET_STATE</span> <span class="o">|</span> <span class="n">VM_ENTRY_CTRL_LOAD_LBR_CTL</span><span class="p">);</span>

    <span class="n">EntryCtls</span> <span class="o">&amp;=</span> <span class="p">((</span><span class="n">readMsr64</span><span class="p">(</span><span class="n">IA32_VMX_TRUE_ENTRY_CTLS_MSR_ADDR</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MAX_DWORD</span><span class="p">);</span>

    <span class="n">Wr_VM_Entry_Control</span><span class="p">(</span><span class="n">VmcsBaseVa</span><span class="p">,</span> <span class="n">EntryCtls</span><span class="p">);</span>

    <span class="n">Wr_VM_Execution_Control_Pin_Based</span><span class="p">(</span><span class="n">VmcsBaseVa</span><span class="p">,</span> <span class="n">PinbasedCtls</span><span class="p">);</span>
    <span class="n">Wr_VM_Execution_Control_Proc_Based</span><span class="p">(</span><span class="n">VmcsBaseVa</span><span class="p">,</span> <span class="n">ProcbasedCtls</span><span class="p">);</span>
   
    <span class="n">Wr_Host_RIP</span><span class="p">(</span><span class="n">VmcsBaseVa</span><span class="p">,</span> <span class="p">(</span><span class="n">C_CODE_RGN_BASE</span> <span class="o">|</span> <span class="n">SeamldrData</span><span class="p">.</span><span class="n">AslrRand</span><span class="p">)</span> <span class="o">+</span> <span class="n">SeamldrData</span><span class="p">.</span><span class="n">PSeamldrConsts</span><span class="o">-&gt;</span><span class="n">CEntryPointOffset</span><span class="p">);</span>
    <span class="n">Wr_Host_FS_Base</span><span class="p">(</span><span class="n">VmcsBaseVa</span><span class="p">,</span> <span class="n">C_SYS_INFO_TABLE_BASE</span> <span class="o">|</span> <span class="n">SeamldrData</span><span class="p">.</span><span class="n">AslrRand</span><span class="p">);</span>

    <span class="n">UINT64</span> <span class="n">HostRSP</span> <span class="o">=</span> <span class="p">(</span><span class="n">C_STACK_RGN_BASE</span> <span class="o">|</span> <span class="n">SeamldrData</span><span class="p">.</span><span class="n">AslrRand</span><span class="p">)</span> <span class="o">+</span> <span class="n">SeamldrData</span><span class="p">.</span><span class="n">PSeamldrConsts</span><span class="o">-&gt;</span><span class="n">CDataStackSize</span> <span class="o">-</span> <span class="mi">8</span><span class="p">;</span>
    <span class="n">UINT64</span> <span class="n">HostSSP</span> <span class="o">=</span> <span class="p">(</span><span class="n">C_STACK_RGN_BASE</span> <span class="o">|</span> <span class="n">SeamldrData</span><span class="p">.</span><span class="n">AslrRand</span><span class="p">)</span> <span class="o">+</span> <span class="n">SeamldrData</span><span class="p">.</span><span class="n">PSeamldrConsts</span><span class="o">-&gt;</span><span class="n">CDataStackSize</span> <span class="o">+</span> <span class="n">P_SEAMLDR_SHADOW_STACK_SIZE</span> <span class="o">-</span> <span class="mi">8</span><span class="p">;</span>
    <span class="n">UINT64</span> <span class="n">HostGSBase</span> <span class="o">=</span> <span class="p">(</span><span class="n">C_DATA_RGN_BASE</span> <span class="o">|</span> <span class="n">SeamldrData</span><span class="p">.</span><span class="n">AslrRand</span><span class="p">);</span>

    <span class="n">Wr_Host_RSP</span><span class="p">(</span><span class="n">VmcsBaseVa</span><span class="p">,</span> <span class="n">HostRSP</span><span class="p">);</span>
    <span class="n">Wr_Host_SSP</span><span class="p">(</span><span class="n">VmcsBaseVa</span><span class="p">,</span> <span class="n">HostSSP</span><span class="p">);</span>
    <span class="n">Wr_Host_GS_Base</span><span class="p">(</span><span class="n">VmcsBaseVa</span><span class="p">,</span> <span class="n">HostGSBase</span><span class="p">);</span>
    <span class="n">Wr_VMCS_Revision_ID</span><span class="p">(</span><span class="n">VmcsBaseVa</span><span class="p">,</span> <span class="p">(</span><span class="n">UINT32</span><span class="p">)</span><span class="n">VmxBasic</span><span class="p">.</span><span class="n">RevisionIdentifier</span> <span class="o">&amp;</span> <span class="mh">0x7FFFFFFF</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></div></div>
<p><strong>The guest state area</strong> is the processor state that is loaded upon VM entry and 
stored on VM exit. <strong>The host state area</strong> is the processor state that is loaded
from the corresponding VMCS components on every VM exit. Regardless of the 
SEAMCALL instructions destination, whether it is P-SEAMLDR or TDX module, it 
implements <strong>VM exit</strong> semantic to enter SEAM mode from legacy VMX. Therefore, 
the host state area is used to set VCPU when the SEAMCALL is invoked. As shown 
in the code above, only the RIP has been set for the guest (for NP-SEAMLDR). 
Also, note that the virtual address mapping of PSysInfoTable for P-SEAMLDR has 
been populated by the MapSysInfoTables function so that P-SEAMLDR can access the 
table through virtual address.</p>

<h1 id="p-seamldr">P-SEAMLDR</h1>
<blockquote>
  <p>The Intel P-SEAMLDR module aims to provide interfaces to the VMM, invoked using 
the SEAMCALL instruction, to gain information about Intel TDX, install Intel TDX
modules, and shutdown itself. The installation interface is designed to follow 
the steps below to load or update an Intel TDX module into the MODULE_RANGE:</p>
</blockquote>

<ol>
  <li>Verify input parameters, including the TDX module’s signature structure
(SEAM_SIGSTRUCT).</li>
  <li><strong>Load the Intel TDX module image</strong> into the MODULE_RANGE, measure it and 
verify the measurement matches with the signature structure.</li>
  <li><strong>Set up data regions, stack regions, and page tables for all logical 
processors.</strong></li>
  <li><strong>Set up SEAM transfer VMCSs</strong> for all logical processors. These VMCSs are 
used by SEAMCALL instructions when an Intel TDX module’s API is called, and by the 
SEAMRET instruction when the Intel TDX module API returns.</li>
  <li>Record the Intel TDX module identity into CPU measurement registers and 
update its load status.</li>
  <li>Return to VMM using the SEAMRET instruction</li>
</ol>

<h3 id="handoff-information-from-np-seamldr-to-p-seamldr"><span class="me-2">Handoff information from NP-SEAMLDR to P-SEAMLDR</span><a href="#handoff-information-from-np-seamldr-to-p-seamldr" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>To setup memory region and other configurations for P-SEAMLDR, it requires 
trusted source for hardware reported information.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre></td><td class="rouge-code"><pre><span class="k">typedef</span> <span class="k">struct</span> <span class="nc">PACKED</span> <span class="n">p_sysinfo_table_s</span>
<span class="p">{</span>
    <span class="c1">// Fields populated by MCHECK</span>
    <span class="kt">uint64_t</span> <span class="n">version</span><span class="p">;</span>               <span class="cm">/**&lt; Structure Version – Set to 0 */</span>
    <span class="kt">uint32_t</span> <span class="n">tot_num_lps</span><span class="p">;</span>           <span class="cm">/**&lt; Total number of logical processors in platform */</span>
    <span class="kt">uint32_t</span> <span class="n">tot_num_sockets</span><span class="p">;</span>       <span class="cm">/**&lt; Total number of sockets in platform */</span>
    <span class="n">fms_info_t</span> <span class="n">socket_cpuid_table</span><span class="p">[</span><span class="n">MAX_PKGS</span><span class="p">];</span> <span class="cm">/**&lt; List of CPUID.leaf_1.EAX values from all sockets */</span>
    <span class="kt">uint64_t</span> <span class="n">p_seamldr_range_base</span><span class="p">;</span>  <span class="cm">/**&lt; Physical base address of P_SEAMLDR_RANGE */</span>
    <span class="kt">uint64_t</span> <span class="n">p_seamldr_range_size</span><span class="p">;</span>  <span class="cm">/**&lt; Size of P_SEAMLDR_RANGE, in bytes */</span>
    <span class="kt">uint8_t</span> <span class="n">skip_smrr2_check</span><span class="p">;</span>       <span class="cm">/**&lt; When set, indicates that the TDX module should not check SMRR2. */</span>
    <span class="kt">uint8_t</span> <span class="n">tdx_ac</span><span class="p">;</span>                 <span class="cm">/**&lt; When set, indicates that TDX memory is protected by Access Control only (no memory integrity). */</span>
    <span class="kt">uint8_t</span> <span class="n">reserved_0</span><span class="p">[</span><span class="mi">62</span><span class="p">];</span>         <span class="cm">/**&lt; Reserved */</span>
    <span class="n">cmr_info_entry_t</span> <span class="n">cmr_data</span><span class="p">[</span><span class="n">MAX_CMR</span><span class="p">];</span> <span class="cm">/**&lt; CMR info (base and size) */</span>
    <span class="kt">uint8_t</span> <span class="n">reserved_1</span><span class="p">[</span><span class="mi">1408</span><span class="p">];</span>       <span class="cm">/**&lt; Reserved */</span>
        
    <span class="c1">// Fields populated by NP-SEAMLDR</span>
    <span class="kt">uint64_t</span> <span class="n">np_seamldr_mutex</span><span class="p">;</span>      <span class="cm">/**&lt; Mutex used by NP_SEAMLDR to ensure that it’s running on a single package at a time. */</span>
    <span class="kt">uint64_t</span> <span class="n">code_rgn_base</span><span class="p">;</span>         <span class="cm">/**&lt; Base address of Code region */</span>
    <span class="kt">uint64_t</span> <span class="n">code_rgn_size</span><span class="p">;</span>         <span class="cm">/**&lt; Size of code region in bytes */</span>
    <span class="kt">uint64_t</span> <span class="n">data_rgn_base</span><span class="p">;</span>         <span class="cm">/**&lt; Base address of Data region */</span>
    <span class="kt">uint64_t</span> <span class="n">data_rgn_size</span><span class="p">;</span>         <span class="cm">/**&lt; Size of data region in bytes */</span>
    <span class="kt">uint64_t</span> <span class="n">stack_rgn_base</span><span class="p">;</span>        <span class="cm">/**&lt; Base address of stack region */</span>
    <span class="kt">uint64_t</span> <span class="n">stack_rgn_size</span><span class="p">;</span>        <span class="cm">/**&lt; Size of Stack Region in bytes */</span>
    <span class="kt">uint64_t</span> <span class="n">keyhole_rgn_base</span><span class="p">;</span>      <span class="cm">/**&lt; Base address of Keyhole region */</span>
    <span class="kt">uint64_t</span> <span class="n">keyhole_rgn_size</span><span class="p">;</span>      <span class="cm">/**&lt; Size of the Keyhole region in bytes */</span>
    <span class="kt">uint64_t</span> <span class="n">keyhole_edit_rgn_base</span><span class="p">;</span> <span class="cm">/**&lt; Keyhole Edit Region Base */</span>
    <span class="kt">uint64_t</span> <span class="n">keyhole_edit_rgn_size</span><span class="p">;</span> <span class="cm">/**&lt; Size of Keyhole Edit Region in bytes */</span>
    <span class="kt">uint64_t</span> <span class="n">module_region_base</span><span class="p">;</span>    <span class="cm">/**&lt; Linear base address of SEAM range. */</span>
    <span class="kt">uint32_t</span> <span class="n">acm_x2apicid</span><span class="p">;</span>          <span class="cm">/**&lt; The X2APICID of the LP in which the last call to the “shutdown” API should be done (a.k.a. ACM_X2APICID). */</span>
    <span class="kt">uint32_t</span> <span class="n">acm_x2apicid_valid</span><span class="p">;</span>    <span class="cm">/**&lt; Whether the ACM_X2APICID field is valid. Must be 1. */</span>
    <span class="kt">uint8_t</span> <span class="n">reserved_2</span><span class="p">[</span><span class="mi">1944</span><span class="p">];</span>       <span class="cm">/**&lt; Reserved */</span>
<span class="p">}</span> <span class="n">p_sysinfo_table_t</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></div></div>

<p>This data structure is heavily accessed by the P-SEAMLDR because it provides 
very important information about memory regions of the P-SEAMLDR populated by 
the NP-SEAMLDR.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="kt">void</span> <span class="nf">pseamldr_dispatcher</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>   
    <span class="c1">// Must be first thing to do before accessing data or sysinfo table</span>
    <span class="n">pseamldr_data_t</span><span class="o">*</span> <span class="n">pseamldr_data</span> <span class="o">=</span> <span class="n">init_data_fast_ref_ptrs</span><span class="p">();</span>
    <span class="p">......</span>
</pre></td></tr></tbody></table></code></div></div>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="c1">// Must be first thing to do before accessing data or sysinfo table</span>
<span class="n">_STATIC_INLINE_</span> <span class="n">pseamldr_data_t</span><span class="o">*</span> <span class="nf">init_data_fast_ref_ptrs</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>                    
    <span class="n">pseamldr_data_t</span><span class="o">*</span> <span class="n">local_data</span> <span class="o">=</span> <span class="n">calculate_local_data</span><span class="p">();</span>

    <span class="n">IF_RARE</span> <span class="p">(</span><span class="o">!</span><span class="n">local_data</span><span class="o">-&gt;</span><span class="n">seamldr_data_fast_ref_ptr</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">local_data</span><span class="o">-&gt;</span><span class="n">seamldr_data_fast_ref_ptr</span> <span class="o">=</span> <span class="n">local_data</span><span class="p">;</span>
        <span class="n">local_data</span><span class="o">-&gt;</span><span class="n">psysinfo_fast_ref_ptr</span> <span class="o">=</span> <span class="n">calculate_sysinfo_table</span><span class="p">();</span>
    <span class="p">}</span>
    
    <span class="k">return</span> <span class="n">local_data</span><span class="p">;</span>
<span class="p">}</span>   
</pre></td></tr></tbody></table></code></div></div>

<p>To easily access this table, all SEAMCALL instruction targeting P-SEAMLDR 
invokes pseamldr_dispatcher, which calls init_data_fast_ref_ptrs.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre></td><td class="rouge-code"><pre><span class="c1">// In SEAM PSEAMLDR module, GSBASE holds a pointer to the local data of current thread</span>
<span class="c1">// We are reading GSBASE by loading effective address of 0 with GS prefix</span>
<span class="n">_STATIC_INLINE_</span> <span class="n">pseamldr_data_t</span><span class="o">*</span> <span class="nf">calculate_local_data</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">void</span><span class="o">*</span> <span class="n">local_data_addr</span><span class="p">;</span>
    <span class="n">_ASM_VOLATILE_</span> <span class="p">(</span><span class="s">"rdgsbase %0"</span>
                     <span class="o">:</span><span class="s">"=r"</span><span class="p">(</span><span class="n">local_data_addr</span><span class="p">)</span>
                     <span class="o">:</span>
                     <span class="o">:</span><span class="s">"cc"</span><span class="p">);</span>
    
    <span class="k">return</span> <span class="p">(</span><span class="n">pseamldr_data_t</span><span class="o">*</span><span class="p">)</span><span class="n">local_data_addr</span><span class="p">;</span>
<span class="p">}</span> 

<span class="c1">// In SEAM PSEAMLDR module, FSBASE holds a pointer to the SYSINFO table</span>
<span class="c1">// We are reading FSBASE by loading effective address of 0 with FS prefix</span>
<span class="n">_STATIC_INLINE_</span> <span class="n">p_sysinfo_table_t</span><span class="o">*</span> <span class="nf">calculate_sysinfo_table</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>   
    <span class="kt">void</span><span class="o">*</span> <span class="n">sysinfo_table_addr</span><span class="p">;</span>
    <span class="n">_ASM_VOLATILE_</span> <span class="p">(</span><span class="s">"rdfsbase %0"</span>
                     <span class="o">:</span><span class="s">"=r"</span><span class="p">(</span><span class="n">sysinfo_table_addr</span><span class="p">)</span>
                     <span class="o">:</span>
                     <span class="o">:</span><span class="s">"cc"</span><span class="p">);</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">p_sysinfo_table_t</span><span class="o">*</span><span class="p">)</span><span class="n">sysinfo_table_addr</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>
<p>PSysInfoTable is located at the last 4KB page of P-SEAMLDR range and populated
by MCHECK and NP-SEAMLDR. However, its corresponding virtual address pointed to
by the FSBASE is already populated in the P-SEAMLDR page table by the NP-SEAMLDR. 
Therefore, the table address can be directly accessible from the P-SEAMLDR side
with virtual address.</p>

<h3 id="overview-of-p-seamldr-install"><span class="me-2">Overview of P-SEAMLDR Install</span><a href="#overview-of-p-seamldr-install" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>SEAMCALL_SEAMLDR_INSTALL leaf function of the SEAMCALL invokes the P-SEAMLDR and 
calls the seamldr_install function inside the P-SEAMLDR. Primary role of this 
function could be summarized as four:</p>
<ol>
  <li>Validates the <strong>VMM passed</strong> parameter, seamldr_params and sigstruct.</li>
  <li>Initialize page table and set memory region and SYSINFO table for TDX module.</li>
  <li>Load and verify TDX module.</li>
  <li>Setup VMCS for TDX Module.</li>
</ol>

<h3 id="keyhole-and-page-table-for-p-seamldr"><span class="me-2">Keyhole and Page Table for P-SEAMLDR</span><a href="#keyhole-and-page-table-for-p-seamldr" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>map_pa_with_memtype ??? What is it.. Cannot understand how the P-SEAMLDR 
maps physical page for itself.</p>

<h2 id="setup-page-table-and-other-regions-for-tdx-module"><span class="me-2">Setup page table and other regions for TDX module</span><a href="#setup-page-table-and-other-regions-for-tdx-module" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<p>Recall that the purpose of the P-SEAMLDR is loading the TDX module, which
includes setting up memory regions and page tables for the module. Before it
populates mappings for memory regions for TDX module, it should configure the 
essential information such as base address and size for each memory region.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>    <span class="c1">// ******************* Memory initialization *******************</span>
    <span class="n">return_value</span> <span class="o">=</span> <span class="n">initialize_memory_constants</span><span class="p">(</span><span class="n">pseamldr_data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">seamldr_params</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pseamldr_data</span><span class="o">-&gt;</span><span class="n">seam_sigstruct_snapshot</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mem_consts</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></div></div>

<p>This function sets up base addresses and size of various memory regions of the 
TDX module based on the all information the P-SEAMLDR have such as sysinfo table
from the NP-SEAMLDR and seamldr_params from host VMM. Also, it checks that the 
TDX memory region is enough to load the TDX module passed from the VMM.</p>

<h3 id="memory-map-for-tdx-module"><span class="me-2">Memory map for TDX module</span><a href="#memory-map-for-tdx-module" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>The next step is populating memory mappings for TDX module, not for P-SEAMLDR.
Because all memory regions set inside the initialize_memory_constants function 
reside inside the TDX module’s memory, P-SEAMLDR should set up page tables of 
the TDX module not for itself. Note that We have all information in  mem_consts.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre> <span class="c1">// Memory map</span>
    <span class="n">return_value</span> <span class="o">=</span> <span class="n">seam_module_memory_map</span><span class="p">(</span><span class="n">pseamldr_data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mem_consts</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></div></div>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
</pre></td><td class="rouge-code"><pre><span class="n">api_error_type</span> <span class="nf">seam_module_memory_map</span><span class="p">(</span><span class="n">pseamldr_data_t</span><span class="o">*</span> <span class="n">pseamldr_data</span><span class="p">,</span> <span class="n">memory_constants_t</span><span class="o">*</span> <span class="n">mem_consts</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">mem_consts</span><span class="o">-&gt;</span><span class="n">pml4_physbase</span> <span class="o">=</span> <span class="n">mem_consts</span><span class="o">-&gt;</span><span class="n">stack_region_physbase</span> <span class="o">-</span> <span class="n">_4KB</span><span class="p">;</span>
    <span class="n">mem_consts</span><span class="o">-&gt;</span><span class="n">current_pt_physbase</span> <span class="o">=</span> <span class="n">mem_consts</span><span class="o">-&gt;</span><span class="n">pml4_physbase</span> <span class="o">-</span> <span class="n">_4KB</span><span class="p">;</span>

    <span class="c1">// Map code range</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">map_regular_range</span><span class="p">(</span><span class="n">mem_consts</span><span class="p">,</span> <span class="n">mem_consts</span><span class="o">-&gt;</span><span class="n">code_region_physbase</span><span class="p">,</span> <span class="n">mem_consts</span><span class="o">-&gt;</span><span class="n">code_region_linbase</span><span class="p">,</span>
                           <span class="n">mem_consts</span><span class="o">-&gt;</span><span class="n">code_region_size</span><span class="p">,</span> <span class="n">SEAM_CODE_RANGE_ATTRIBUTES</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="n">TDX_ERROR</span><span class="p">(</span><span class="s">"Code range mapping failure</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">PSEAMLDR_ENOMEM</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// Map data range</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">map_regular_range</span><span class="p">(</span><span class="n">mem_consts</span><span class="p">,</span> <span class="n">mem_consts</span><span class="o">-&gt;</span><span class="n">data_region_physbase</span><span class="p">,</span> <span class="n">mem_consts</span><span class="o">-&gt;</span><span class="n">data_region_linbase</span><span class="p">,</span>
                           <span class="n">mem_consts</span><span class="o">-&gt;</span><span class="n">data_region_size</span><span class="p">,</span> <span class="n">SEAM_DATA_RANGE_ATTRIBUTES</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="n">TDX_ERROR</span><span class="p">(</span><span class="s">"Data range mapping failure</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">PSEAMLDR_ENOMEM</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// Data and shadow stack ranges per LP</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mem_consts</span><span class="o">-&gt;</span><span class="n">num_addressable_lps</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">uint64_t</span> <span class="n">stack_pa_start</span> <span class="o">=</span> <span class="n">mem_consts</span><span class="o">-&gt;</span><span class="n">stack_region_physbase</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">mem_consts</span><span class="o">-&gt;</span><span class="n">lp_stack_size</span><span class="p">;</span>
        <span class="kt">uint64_t</span> <span class="n">stack_la_start</span> <span class="o">=</span> <span class="n">mem_consts</span><span class="o">-&gt;</span><span class="n">stack_region_linbase</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">mem_consts</span><span class="o">-&gt;</span><span class="n">lp_stack_size</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">map_regular_range</span><span class="p">(</span><span class="n">mem_consts</span><span class="p">,</span> <span class="n">stack_pa_start</span><span class="p">,</span> <span class="n">stack_la_start</span><span class="p">,</span>
                               <span class="n">mem_consts</span><span class="o">-&gt;</span><span class="n">data_stack_size</span><span class="p">,</span> <span class="n">SEAM_DATA_STACK_RANGE_ATTRIBUTES</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="n">TDX_ERROR</span><span class="p">(</span><span class="s">"Data stack range mapping failure</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
            <span class="k">return</span> <span class="n">PSEAMLDR_ENOMEM</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">map_regular_range</span><span class="p">(</span><span class="n">mem_consts</span><span class="p">,</span>
                               <span class="n">stack_pa_start</span> <span class="o">+</span> <span class="n">mem_consts</span><span class="o">-&gt;</span><span class="n">data_stack_size</span><span class="p">,</span>
                               <span class="n">stack_la_start</span> <span class="o">+</span> <span class="n">mem_consts</span><span class="o">-&gt;</span><span class="n">data_stack_size</span><span class="p">,</span>
                               <span class="n">mem_consts</span><span class="o">-&gt;</span><span class="n">shadow_stack_size</span><span class="p">,</span> <span class="n">SEAM_SHADOW_STACK_RANGE_ATTRIBUTES</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="n">TDX_ERROR</span><span class="p">(</span><span class="s">"Shadow stack range mapping failure</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
            <span class="k">return</span> <span class="n">PSEAMLDR_ENOMEM</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// Sysinfo page</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">map_regular_range</span><span class="p">(</span><span class="n">mem_consts</span><span class="p">,</span> <span class="n">pseamldr_data</span><span class="o">-&gt;</span><span class="n">system_info</span><span class="p">.</span><span class="n">seamrr_base</span><span class="p">,</span> <span class="n">mem_consts</span><span class="o">-&gt;</span><span class="n">sysinfo_table_linbase</span><span class="p">,</span>
                           <span class="n">_4KB</span><span class="p">,</span> <span class="n">SEAM_SYSINFO_RANGE_ATTRIBUTES</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="n">TDX_ERROR</span><span class="p">(</span><span class="s">"Sysinfo table mapping failure</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">PSEAMLDR_ENOMEM</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// Keyhole + keyhole edit pages</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">map_keyhole_range</span><span class="p">(</span><span class="n">mem_consts</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="n">TDX_ERROR</span><span class="p">(</span><span class="s">"Keyholes mapping failure</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="n">FATAL_ERROR</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">PSEAMLDR_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>When it comes to the memory mapping function that maps physical addresses, it is
easy to find two different functions map_pa and map_seam_range_page. However, 
they populate mapping on two different page table. map_pa is used for P-SEAMLDR 
and the other is used for TDX module. Note that pml4_physbase is the base page
table for the TDX module, which is the one page before the stack region of the
TDX module. Through the map_regular_range, which invokes the map_seam_range_page,
it generates mapping in the TDX module’s page table where the pml4_physbase is 
the root of the page table.</p>

<h2 id="load-and-verify-tdx-module"><span class="me-2">Load and Verify TDX Module</span><a href="#load-and-verify-tdx-module" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>    <span class="c1">// Image load and verify</span>
    <span class="n">return_value</span> <span class="o">=</span> <span class="n">seam_module_load_and_verify</span><span class="p">(</span><span class="n">pseamldr_data</span><span class="p">,</span> <span class="n">p_sysinfo_table</span><span class="p">,</span>
                             <span class="o">&amp;</span><span class="n">seamldr_params</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pseamldr_data</span><span class="o">-&gt;</span><span class="n">seam_sigstruct_snapshot</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></div></div>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre></td><td class="rouge-code"><pre><span class="k">static</span> <span class="n">api_error_type</span> <span class="nf">seam_module_load_and_verify</span><span class="p">(</span><span class="n">pseamldr_data_t</span><span class="o">*</span> <span class="n">pseamldr_data</span><span class="p">,</span> <span class="n">p_sysinfo_table_t</span><span class="o">*</span> <span class="n">p_sysinfo_table</span><span class="p">,</span>
                                                  <span class="n">seamldr_params_t</span><span class="o">*</span> <span class="n">seamldr_params</span><span class="p">,</span> <span class="n">seam_sigstruct_t</span><span class="o">*</span> <span class="n">seam_sigstruct</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">uint64_t</span> <span class="n">code_region_start_la</span><span class="p">;</span>

    <span class="n">code_region_start_la</span> <span class="o">=</span> <span class="n">p_sysinfo_table</span><span class="o">-&gt;</span><span class="n">module_region_base</span> <span class="o">+</span> <span class="n">pseamldr_data</span><span class="o">-&gt;</span><span class="n">system_info</span><span class="p">.</span><span class="n">seamrr_size</span>
                           <span class="o">-</span> <span class="n">p_sysinfo_table</span><span class="o">-&gt;</span><span class="n">p_seamldr_range_size</span> <span class="o">-</span> <span class="n">SEAMRR_MODULE_CODE_REGION_SIZE</span><span class="p">;</span>

    <span class="c1">// Copy and measure SEAM module image pages to the last 2M of the SEAM range</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">uint64_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">seamldr_params</span><span class="o">-&gt;</span><span class="n">num_module_pages</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">void</span><span class="o">*</span> <span class="n">src_page_la</span> <span class="o">=</span> <span class="n">map_pa</span><span class="p">((</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">seamldr_params</span><span class="o">-&gt;</span><span class="n">mod_pages_pa_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">TDX_RANGE_RO</span><span class="p">);</span>
        <span class="kt">void</span><span class="o">*</span> <span class="n">dst_page_la</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)(</span><span class="n">code_region_start_la</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="n">SEAM_MODULE_PAGE_SIZE</span><span class="p">));</span>
        <span class="n">pseamldr_memcpy</span><span class="p">(</span><span class="n">dst_page_la</span><span class="p">,</span> <span class="n">SEAM_MODULE_PAGE_SIZE</span><span class="p">,</span> <span class="n">src_page_la</span><span class="p">,</span> <span class="n">SEAM_MODULE_PAGE_SIZE</span><span class="p">);</span>
        <span class="n">free_la</span><span class="p">(</span><span class="n">src_page_la</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// Measure the image (in SEAM range) using SHA-384.</span>
    <span class="c1">// If the result is not equal to TMP_SIGSTRUCT.SEAMHASH then set ERROR_CODE = EBADHASH.</span>
    <span class="kt">uint32_t</span> <span class="n">module_size</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)(</span><span class="n">seamldr_params</span><span class="o">-&gt;</span><span class="n">num_module_pages</span> <span class="o">*</span> <span class="n">SEAM_MODULE_PAGE_SIZE</span><span class="p">);</span>
    <span class="n">IF_RARE</span> <span class="p">(</span><span class="o">!</span><span class="n">compute_and_verify_hash</span><span class="p">((</span><span class="k">const</span> <span class="kt">uint8_t</span><span class="o">*</span><span class="p">)</span><span class="n">code_region_start_la</span><span class="p">,</span> <span class="n">module_size</span><span class="p">,</span> <span class="n">seam_sigstruct</span><span class="o">-&gt;</span><span class="n">seamhash</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="n">TDX_ERROR</span><span class="p">(</span><span class="s">"Incorrect SEAM module hash!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">PSEAMLDR_EBADHASH</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">PSEAMLDR_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

</pre></td></tr></tbody></table></code></div></div>

<p>It also measures the has value of the TDX module and reject loading when the 
hash does not match with the pre-calculated value stored in the sigstruct for 
TDX module.</p>

<h3 id="update-memory-map-after-loading"><span class="me-2">Update memory map after loading</span><a href="#update-memory-map-after-loading" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="rouge-code"><pre><span class="k">static</span> <span class="kt">void</span> <span class="nf">setup_system_information</span><span class="p">(</span><span class="n">p_sysinfo_table_t</span><span class="o">*</span> <span class="n">p_sysinfo_table</span><span class="p">,</span> <span class="n">memory_constants_t</span><span class="o">*</span> <span class="n">mem_consts</span><span class="p">)</span>
<span class="p">{</span>   
    <span class="c1">// Copy MCHECK information from P_SYS_INFO_TABLE to SYS_INFO_TABLE</span>
    <span class="n">sysinfo_table_t</span><span class="o">*</span> <span class="n">sysinfo_table</span> <span class="o">=</span> <span class="p">(</span><span class="n">sysinfo_table_t</span><span class="o">*</span><span class="p">)</span><span class="n">p_sysinfo_table</span><span class="o">-&gt;</span><span class="n">module_region_base</span><span class="p">;</span>
    
    <span class="n">pseamldr_memcpy</span><span class="p">(</span><span class="n">sysinfo_table</span><span class="p">,</span> <span class="n">SYSINFO_TABLE_MCHECK_DATA_SIZE</span><span class="p">,</span> <span class="n">p_sysinfo_table</span><span class="p">,</span> <span class="n">SYSINFO_TABLE_MCHECK_DATA_SIZE</span><span class="p">);</span>
    
    <span class="n">sysinfo_table</span><span class="o">-&gt;</span><span class="n">code_rgn_base</span> <span class="o">=</span> <span class="n">mem_consts</span><span class="o">-&gt;</span><span class="n">code_region_linbase</span><span class="p">;</span>
    <span class="n">sysinfo_table</span><span class="o">-&gt;</span><span class="n">code_rgn_size</span> <span class="o">=</span> <span class="n">mem_consts</span><span class="o">-&gt;</span><span class="n">code_region_size</span><span class="p">;</span>
    <span class="n">sysinfo_table</span><span class="o">-&gt;</span><span class="n">data_rgn_base</span> <span class="o">=</span> <span class="n">mem_consts</span><span class="o">-&gt;</span><span class="n">data_region_linbase</span><span class="p">;</span>
    <span class="n">sysinfo_table</span><span class="o">-&gt;</span><span class="n">data_rgn_size</span> <span class="o">=</span> <span class="n">mem_consts</span><span class="o">-&gt;</span><span class="n">data_region_size</span><span class="p">;</span>
    <span class="n">sysinfo_table</span><span class="o">-&gt;</span><span class="n">stack_rgn_base</span> <span class="o">=</span> <span class="n">mem_consts</span><span class="o">-&gt;</span><span class="n">stack_region_linbase</span><span class="p">;</span>
    <span class="n">sysinfo_table</span><span class="o">-&gt;</span><span class="n">stack_rgn_size</span> <span class="o">=</span> <span class="n">mem_consts</span><span class="o">-&gt;</span><span class="n">stack_region_size</span><span class="p">;</span>
    <span class="n">sysinfo_table</span><span class="o">-&gt;</span><span class="n">keyhole_rgn_base</span> <span class="o">=</span> <span class="n">mem_consts</span><span class="o">-&gt;</span><span class="n">keyhole_region_linbase</span><span class="p">;</span>
    <span class="n">sysinfo_table</span><span class="o">-&gt;</span><span class="n">keyhole_rgn_size</span> <span class="o">=</span> <span class="n">mem_consts</span><span class="o">-&gt;</span><span class="n">keyhole_region_size</span><span class="p">;</span>
    <span class="n">sysinfo_table</span><span class="o">-&gt;</span><span class="n">keyhole_edit_rgn_base</span> <span class="o">=</span> <span class="n">mem_consts</span><span class="o">-&gt;</span><span class="n">keyedit_region_linbase</span><span class="p">;</span>
    <span class="n">sysinfo_table</span><span class="o">-&gt;</span><span class="n">keyhole_edit_rgn_size</span> <span class="o">=</span> <span class="n">mem_consts</span><span class="o">-&gt;</span><span class="n">keyedit_region_size</span><span class="p">;</span>
    <span class="n">sysinfo_table</span><span class="o">-&gt;</span><span class="n">num_stack_pages</span> <span class="o">=</span> <span class="p">(</span><span class="n">mem_consts</span><span class="o">-&gt;</span><span class="n">data_stack_size</span> <span class="o">/</span> <span class="n">_4KB</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">sysinfo_table</span><span class="o">-&gt;</span><span class="n">num_tls_pages</span> <span class="o">=</span> <span class="p">(</span><span class="n">mem_consts</span><span class="o">-&gt;</span><span class="n">local_data_size</span> <span class="o">/</span> <span class="n">_4KB</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>   
</pre></td></tr></tbody></table></code></div></div>

<p>After the TDX module has been loaded to the memory, the memory map in the 
sysinfo table should be updated because the sysinfo table is also passed to the 
TDX module as P-SEAMLDR received it from NP-SEAMLDR. This table is accessible 
by the TDX module through FSBASE.</p>

<h2 id="setup-vmcs-for-tdx-module"><span class="me-2">Setup VMCS for TDX Module</span><a href="#setup-vmcs-for-tdx-module" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<p>One of its important role is
setting the VMCS structure associated with seam loader (refer to setup_seam_vmcs).</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>    <span class="c1">// SEAM VMCS setup</span>
    <span class="n">setup_seam_vmcs</span><span class="p">(</span><span class="n">p_sysinfo_table</span><span class="o">-&gt;</span><span class="n">module_region_base</span> <span class="o">+</span> <span class="n">_4KB</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mem_consts</span><span class="p">,</span> <span class="n">pseamldr_data</span><span class="o">-&gt;</span><span class="n">seam_sigstruct_snapshot</span><span class="p">.</span><span class="n">rip_offset</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></div></div>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
</pre></td><td class="rouge-code"><pre><span class="kt">void</span> <span class="nf">setup_seam_vmcs</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">vmcs_la_base</span><span class="p">,</span> <span class="n">memory_constants_t</span><span class="o">*</span> <span class="n">mem_consts</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="n">rip_offset</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">ia32_vmx_basic_t</span> <span class="n">vmx_basic</span><span class="p">;</span>
    <span class="kt">uint32_t</span> <span class="n">pinbased_ctls</span><span class="p">,</span> <span class="n">procbased_ctls</span><span class="p">,</span> <span class="n">exit_ctls</span><span class="p">,</span> <span class="n">entry_ctls</span><span class="p">;</span>
    <span class="kt">uint64_t</span> <span class="n">cr0_fixed0</span><span class="p">,</span> <span class="n">cr0_fixed1</span><span class="p">,</span> <span class="n">cr0_mustbe1</span><span class="p">;</span>
    <span class="kt">uint64_t</span> <span class="n">cr4_fixed0</span><span class="p">,</span> <span class="n">cr4_fixed1</span><span class="p">,</span> <span class="n">cr4_mustbe1</span><span class="p">;</span>

    <span class="n">vmx_basic</span><span class="p">.</span><span class="n">raw</span> <span class="o">=</span> <span class="n">ia32_rdmsr</span><span class="p">(</span><span class="n">IA32_VMX_BASIC_MSR_ADDR</span><span class="p">);</span>

    <span class="n">pinbased_ctls</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)(</span><span class="n">ia32_rdmsr</span><span class="p">(</span><span class="n">IA32_VMX_TRUE_PINBASED_CTLS_MSR_ADDR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BIT_MASK_32BITS</span><span class="p">);</span>
    <span class="n">procbased_ctls</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)(</span><span class="n">ia32_rdmsr</span><span class="p">(</span><span class="n">IA32_VMX_TRUE_PROCBASED_CTLS_MSR_ADDR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BIT_MASK_32BITS</span><span class="p">);</span>
    <span class="n">exit_ctls</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)(</span><span class="n">ia32_rdmsr</span><span class="p">(</span><span class="n">IA32_VMX_TRUE_EXIT_CTLS_MSR_ADDR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BIT_MASK_32BITS</span><span class="p">);</span>
    <span class="n">entry_ctls</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)(</span><span class="n">ia32_rdmsr</span><span class="p">(</span><span class="n">IA32_VMX_TRUE_ENTRY_CTLS_MSR_ADDR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BIT_MASK_32BITS</span><span class="p">);</span>

    <span class="n">cr0_fixed0</span> <span class="o">=</span> <span class="n">ia32_rdmsr</span><span class="p">(</span><span class="n">IA32_VMX_CR0_FIXED0_MSR_ADDR</span><span class="p">);</span>
    <span class="n">cr0_fixed1</span> <span class="o">=</span> <span class="n">ia32_rdmsr</span><span class="p">(</span><span class="n">IA32_VMX_CR0_FIXED1_MSR_ADDR</span><span class="p">);</span>
    <span class="n">cr0_mustbe1</span> <span class="o">=</span> <span class="n">cr0_fixed1</span> <span class="o">&amp;</span> <span class="n">cr0_fixed0</span><span class="p">;</span>
    <span class="n">cr4_fixed0</span> <span class="o">=</span> <span class="n">ia32_rdmsr</span><span class="p">(</span><span class="n">IA32_VMX_CR4_FIXED0_MSR_ADDR</span><span class="p">);</span>
    <span class="n">cr4_fixed1</span> <span class="o">=</span> <span class="n">ia32_rdmsr</span><span class="p">(</span><span class="n">IA32_VMX_CR4_FIXED1_MSR_ADDR</span><span class="p">);</span>
    <span class="n">cr4_mustbe1</span> <span class="o">=</span> <span class="n">cr4_fixed1</span> <span class="o">&amp;</span> <span class="n">cr4_fixed0</span><span class="p">;</span>

    <span class="n">wr_guest_rip</span><span class="p">(</span><span class="n">vmcs_la_base</span><span class="p">,</span> <span class="n">SEAM_VMCS_NON_CANONICAL_RIP</span><span class="p">);</span>
    <span class="n">wr_host_cr0</span><span class="p">(</span><span class="n">vmcs_la_base</span><span class="p">,</span> <span class="n">SEAM_VMCS_CR0_BITS</span> <span class="o">|</span> <span class="n">cr0_mustbe1</span><span class="p">);</span>
    <span class="n">wr_gost_cr3</span><span class="p">(</span><span class="n">vmcs_la_base</span><span class="p">,</span> <span class="n">mem_consts</span><span class="o">-&gt;</span><span class="n">pml4_physbase</span><span class="p">);</span>
    <span class="n">wr_host_cr4</span><span class="p">(</span><span class="n">vmcs_la_base</span><span class="p">,</span> <span class="n">SEAM_VMCS_CR4_BITS</span> <span class="o">|</span> <span class="n">cr4_mustbe1</span><span class="p">);</span>
    <span class="n">wr_host_cs_selector</span><span class="p">(</span><span class="n">vmcs_la_base</span><span class="p">,</span> <span class="n">SEAM_VMCS_CS_SELECTOR</span><span class="p">);</span>
    <span class="n">wr_host_ss_selector</span><span class="p">(</span><span class="n">vmcs_la_base</span><span class="p">,</span> <span class="n">SEAM_VMCS_SS_SELECTOR</span><span class="p">);</span>
    <span class="n">wr_host_fs_selector</span><span class="p">(</span><span class="n">vmcs_la_base</span><span class="p">,</span> <span class="n">SEAM_VMCS_FS_SELECTOR</span><span class="p">);</span>
    <span class="n">wr_host_gs_selector</span><span class="p">(</span><span class="n">vmcs_la_base</span><span class="p">,</span> <span class="n">SEAM_VMCS_GS_SELECTOR</span><span class="p">);</span>
    <span class="n">wr_host_tr_selector</span><span class="p">(</span><span class="n">vmcs_la_base</span><span class="p">,</span> <span class="n">SEAM_VMCS_TR_SELECTOR</span><span class="p">);</span>
    <span class="n">wr_host_ia32_pat</span><span class="p">(</span><span class="n">vmcs_la_base</span><span class="p">,</span> <span class="n">SEAM_VMCS_PAT_MSR_VALUE</span><span class="p">);</span>
    <span class="n">wr_host_ia32_s_cet</span><span class="p">(</span><span class="n">vmcs_la_base</span><span class="p">,</span> <span class="n">SEAM_VMCS_S_CET_MSR_VALUE</span><span class="p">);</span>
    <span class="n">wr_host_ia32_efer</span><span class="p">(</span><span class="n">vmcs_la_base</span><span class="p">,</span> <span class="n">SEAM_VMCS_EFER_MSR_VALUE</span><span class="p">);</span>

    <span class="n">exit_ctls</span> <span class="o">|=</span> <span class="n">SEAM_VMCS_EXIT_CTLS_VALUE</span><span class="p">;</span>
    <span class="n">exit_ctls</span> <span class="o">&amp;=</span> <span class="p">((</span><span class="n">ia32_rdmsr</span><span class="p">(</span><span class="n">IA32_VMX_TRUE_EXIT_CTLS_MSR_ADDR</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BIT_MASK_32BITS</span><span class="p">);</span>

    <span class="n">wr_vm_exit_control</span><span class="p">(</span><span class="n">vmcs_la_base</span><span class="p">,</span> <span class="n">exit_ctls</span><span class="p">);</span>

    <span class="n">entry_ctls</span> <span class="o">|=</span> <span class="n">SEAM_VMCS_ENTRY_CTLS_VALUE</span><span class="p">;</span>

    <span class="n">entry_ctls</span> <span class="o">&amp;=</span> <span class="p">((</span><span class="n">ia32_rdmsr</span><span class="p">(</span><span class="n">IA32_VMX_TRUE_ENTRY_CTLS_MSR_ADDR</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BIT_MASK_32BITS</span><span class="p">);</span>

    <span class="n">wr_vm_entry_control</span><span class="p">(</span><span class="n">vmcs_la_base</span><span class="p">,</span> <span class="n">entry_ctls</span><span class="p">);</span>

    <span class="n">wr_vm_execution_control_pin_based</span><span class="p">(</span><span class="n">vmcs_la_base</span><span class="p">,</span> <span class="n">pinbased_ctls</span><span class="p">);</span>
    <span class="n">wr_vm_execution_control_proc_based</span><span class="p">(</span><span class="n">vmcs_la_base</span><span class="p">,</span> <span class="n">procbased_ctls</span><span class="p">);</span>

    <span class="n">wr_host_rip</span><span class="p">(</span><span class="n">vmcs_la_base</span><span class="p">,</span> <span class="n">mem_consts</span><span class="o">-&gt;</span><span class="n">code_region_linbase</span> <span class="o">+</span> <span class="n">rip_offset</span><span class="p">);</span>
    <span class="n">wr_host_fs_base</span><span class="p">(</span><span class="n">vmcs_la_base</span><span class="p">,</span> <span class="n">mem_consts</span><span class="o">-&gt;</span><span class="n">sysinfo_table_linbase</span><span class="p">);</span>

    <span class="kt">uint64_t</span> <span class="n">host_rsp_first_lp</span> <span class="o">=</span> <span class="n">mem_consts</span><span class="o">-&gt;</span><span class="n">stack_region_linbase</span> <span class="o">+</span> <span class="n">mem_consts</span><span class="o">-&gt;</span><span class="n">data_stack_size</span> <span class="o">-</span> <span class="mi">8</span><span class="p">;</span>
    <span class="kt">uint64_t</span> <span class="n">host_ssp_first_lp</span> <span class="o">=</span> <span class="n">mem_consts</span><span class="o">-&gt;</span><span class="n">stack_region_linbase</span> <span class="o">+</span> <span class="n">mem_consts</span><span class="o">-&gt;</span><span class="n">lp_stack_size</span> <span class="o">-</span> <span class="mi">8</span><span class="p">;</span>
    <span class="kt">uint64_t</span> <span class="n">host_gsbase_first_lp</span> <span class="o">=</span> <span class="n">mem_consts</span><span class="o">-&gt;</span><span class="n">data_region_linbase</span><span class="p">;</span>

    <span class="n">wr_host_rsp</span><span class="p">(</span><span class="n">vmcs_la_base</span><span class="p">,</span> <span class="n">host_rsp_first_lp</span><span class="p">);</span>
    <span class="n">wr_host_ssp</span><span class="p">(</span><span class="n">vmcs_la_base</span><span class="p">,</span> <span class="n">host_ssp_first_lp</span><span class="p">);</span>
    <span class="n">wr_host_gs_base</span><span class="p">(</span><span class="n">vmcs_la_base</span><span class="p">,</span> <span class="n">host_gsbase_first_lp</span><span class="p">);</span>
    <span class="n">wr_vmcs_revision_id</span><span class="p">(</span><span class="n">vmcs_la_base</span><span class="p">,</span> <span class="n">vmx_basic</span><span class="p">.</span><span class="n">vmcs_revision_id</span><span class="p">);</span>

    <span class="kt">uint64_t</span> <span class="n">vmcs_size</span> <span class="o">=</span> <span class="n">vmx_basic</span><span class="p">.</span><span class="n">vmcs_region_size</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="kt">uint64_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mem_consts</span><span class="o">-&gt;</span><span class="n">num_addressable_lps</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">uint64_t</span> <span class="n">current_vmcs_la</span> <span class="o">=</span> <span class="n">vmcs_la_base</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="n">PAGE_SIZE_IN_BYTES</span><span class="p">);</span>
        <span class="n">pseamldr_memcpy</span><span class="p">((</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">current_vmcs_la</span><span class="p">,</span> <span class="n">vmcs_size</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">vmcs_la_base</span><span class="p">,</span> <span class="n">vmcs_size</span><span class="p">);</span>
        <span class="n">wr_host_rsp</span><span class="p">(</span><span class="n">current_vmcs_la</span><span class="p">,</span> <span class="n">host_rsp_first_lp</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="n">mem_consts</span><span class="o">-&gt;</span><span class="n">lp_stack_size</span><span class="p">));</span>
        <span class="n">wr_host_ssp</span><span class="p">(</span><span class="n">current_vmcs_la</span><span class="p">,</span> <span class="n">host_ssp_first_lp</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="n">mem_consts</span><span class="o">-&gt;</span><span class="n">lp_stack_size</span><span class="p">));</span>
        <span class="n">wr_host_gs_base</span><span class="p">(</span><span class="n">current_vmcs_la</span><span class="p">,</span> <span class="n">host_gsbase_first_lp</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span><span class="o">*</span> <span class="n">mem_consts</span><span class="o">-&gt;</span><span class="n">local_data_size</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>The VMCS for TDX module has been set in very similar context as with VMCS for 
P-SEAMLDR. FSBASE and GSBASE are used to pass information from the P-SEAMLDR to
TDX module and the root page table, pml4_physbase, is set as the CR3 of the host,
which is the TDX module. Also all the required mapping to run the TDX module are
ready so the CPU can run the TDX module code and access data right after it 
jumps to the TDX module through SEAMCALL. One major difference of VMCS for TDX
module compared with the VMCS for P-SEAMLDR is that it requires VMCS <strong>per 
logical processor</strong>. Therefore, the last for loop above code sets up different 
memory area per core.</p>


  </div>

  <div class="post-tail-wrapper text-muted">
    <!-- categories -->
    
      <div class="post-meta mb-3">
        <i class="far fa-folder-open fa-fw me-1"></i>
        
          <a href="/categories/confidential-computing/">Confidential Computing</a>,
          <a href="/categories/intel-tdx/">Intel TDX</a>
      </div>
    

    <!-- tags -->
    

    <div
      class="
        post-tail-bottom
        d-flex justify-content-between align-items-center mt-5 pb-2
      "
    >
      <div class="license-wrapper">
        
          

          This post is licensed under 
        <a href="https://creativecommons.org/licenses/by/4.0/">
          CC BY 4.0
        </a>
         by the author.
        
      </div>

      <!-- Post sharing snippet -->

<div class="share-wrapper d-flex align-items-center">
  <span class="share-label text-muted">Share</span>
  <span class="share-icons">
    
    
    

    

      

      <a
        href="https://twitter.com/intent/tweet?text=TDX%20Module%20Life%20Cycle%20Part%200%20(SEAMLDR)%20-%20Ruach&url=https%3A%2F%2Fruach.github.io%2Fposts%2FTDX-SEAMLDR%2F"
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Twitter"
        target="_blank"
        rel="noopener"
        aria-label="Twitter"
      >
        <i class="fa-fw fa-brands fa-square-x-twitter"></i>
      </a>
    

      

      <a
        href="https://www.facebook.com/sharer/sharer.php?title=TDX%20Module%20Life%20Cycle%20Part%200%20(SEAMLDR)%20-%20Ruach&u=https%3A%2F%2Fruach.github.io%2Fposts%2FTDX-SEAMLDR%2F"
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Facebook"
        target="_blank"
        rel="noopener"
        aria-label="Facebook"
      >
        <i class="fa-fw fab fa-facebook-square"></i>
      </a>
    

      

      <a
        href="https://t.me/share/url?url=https%3A%2F%2Fruach.github.io%2Fposts%2FTDX-SEAMLDR%2F&text=TDX%20Module%20Life%20Cycle%20Part%200%20(SEAMLDR)%20-%20Ruach"
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Telegram"
        target="_blank"
        rel="noopener"
        aria-label="Telegram"
      >
        <i class="fa-fw fab fa-telegram"></i>
      </a>
    

      

      <a
        href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fruach.github.io%2Fposts%2FTDX-SEAMLDR%2F"
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Linkedin"
        target="_blank"
        rel="noopener"
        aria-label="Linkedin"
      >
        <i class="fa-fw fab fa-linkedin"></i>
      </a>
    

    <button
      id="copy-link"
      aria-label="Copy link"
      class="btn small"
      data-bs-toggle="tooltip"
      data-bs-placement="top"
      title="Copy link"
      data-title-succeed="Link copied successfully!"
    >
      <i class="fa-fw fas fa-link pe-none fs-6"></i>
    </button>
  </span>
</div>

    </div>
    <!-- .post-tail-bottom -->
  </div>
  <!-- div.post-tail-wrapper -->
</article>


            
          </main>

          <!-- panel -->
          <aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 mb-5 text-muted">
            <div class="access">
              <!-- Get the last 5 posts from lastmod list. -->















              <!-- The trending tags list -->


















            </div>

            
              
              



  <section id="toc-wrapper" class="ps-0 pe-4">
    <h2 class="panel-heading ps-3 pt-2 mb-2">Contents</h2>
    <nav id="toc"></nav>
  </section>


            
          </aside>
        </div>

        <div class="row">
          <!-- tail -->
          <div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4">
            
              
              <!-- Recommend the other 3 posts according to the tags and categories of the current post. -->

<!-- The total size of related posts -->


<!-- An random integer that bigger than 0 -->


<!-- Equals to TAG_SCORE / {max_categories_hierarchy} -->














  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  
    
  

  

  

  

  

  











  <aside id="related-posts" aria-labelledby="related-label">
    <h3 class="mb-4" id="related-label">Further Reading</h3>
    <nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4">
      
        <article class="col">
          <a href="/posts/TDX-MODULE-LIFECYCLE-1/" class="post-preview card h-100">
            <div class="card-body">
              <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1679284800"
  data-df="ll"
  
>
  Mar 20, 2023
</time>

              <h4 class="pt-0 my-2">TDX Module Life Cycle Part 1</h4>
              <div class="text-muted">
                <p>
                  





                  Initialize TDX module
TDX module requires few initialization steps to start service as intermediary of
the TD and VMM. To this end, TDX module requires multiple SEAMCALLs to be 
invoked, as shown i...
                </p>
              </div>
            </div>
          </a>
        </article>
      
        <article class="col">
          <a href="/posts/TDX-MODULE-LIFECYCLE-2/" class="post-preview card h-100">
            <div class="card-body">
              <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1679544000"
  data-df="ll"
  
>
  Mar 23, 2023
</time>

              <h4 class="pt-0 my-2">TDX Module Life Cycle Part 2</h4>
              <div class="text-muted">
                <p>
                  





                  In previous posts, I discussed the initialization of the TDX module using 
TDH_SYS_INIT SEAMCALL. As depicted in the image below, several additional 
configuration steps are necessary for the TDX m...
                </p>
              </div>
            </div>
          </a>
        </article>
      
        <article class="col">
          <a href="/posts/TD-VM-LIFECYCLE-1/" class="post-preview card h-100">
            <div class="card-body">
              <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1680321600"
  data-df="ll"
  
>
  Apr  1, 2023
</time>

              <h4 class="pt-0 my-2">TD VM Life Cycle Part 1</h4>
              <div class="text-muted">
                <p>
                  





                  Deep dive into TD-VM creation (TDH_MNG_CREATE SEAMCALL-TDH_MNG_INIT)


This article will follow the steps described in this figure. It is good to check
this figure when you want to check which part...
                </p>
              </div>
            </div>
          </a>
        </article>
      
    </nav>
  </aside>
  <!-- #related-posts -->


            
              
              <!-- Navigation buttons at the bottom of the post. -->

<nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation">
  
  

  
    <a
      href="/posts/gem5-interrupt-handling-o3/"
      class="btn btn-outline-primary"
      aria-label="Older"
    >
      <p>Gem5 Interrupt Handling O3</p>
    </a>
  

  
    <a
      href="/posts/TDX-MODULE-LIFECYCLE-1/"
      class="btn btn-outline-primary"
      aria-label="Newer"
    >
      <p>TDX Module Life Cycle Part 1</p>
    </a>
  
</nav>

            
              
              <!--  The comments switcher -->

  
  <!-- The Disqus lazy loading. -->

<div id="disqus_thread">
  <p class="text-center text-muted small">Comments powered by <a href="https://disqus.com/">Disqus</a>.</p>
</div>

<script type="text/javascript">
  var disqus_config = function () {
    this.page.url = 'https://ruach.github.io/posts/TDX-SEAMLDR/';
    this.page.identifier = '/posts/TDX-SEAMLDR/';
  };

  /* Lazy loading */
  var disqus_observer = new IntersectionObserver(
    function (entries) {
      if (entries[0].isIntersecting) {
        (function () {
          var d = document,
            s = d.createElement('script');
          s.src = 'https://ruach.disqus.com/embed.js';
          s.setAttribute('data-timestamp', +new Date());
          (d.head || d.body).appendChild(s);
        })();

        disqus_observer.disconnect();
      }
    },
    { threshold: [0] }
  );

  disqus_observer.observe(document.querySelector('#disqus_thread'));

  /* Auto switch theme */
  function reloadDisqus() {
    if (event.source === window && event.data && event.data.direction === ModeToggle.ID) {
      /* Disqus hasn't been loaded */
      if (typeof DISQUS === 'undefined') {
        return;
      }

      if (document.readyState == 'complete') {
        DISQUS.reset({ reload: true, config: disqus_config });
      }
    }
  }

  if (document.querySelector('.mode-toggle')) {
    window.addEventListener('message', reloadDisqus);
  }
</script>



            

            <!-- The Footer -->

<footer
  aria-label="Site Info"
  class="
    d-flex flex-column justify-content-center text-muted
    flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3
  "
>
  <p>
    ©
    <time>2024</time>
    <a href="https://ruach.github.io">Jaehyuk Lee</a>.
    
      <span
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author."
      >Some rights reserved.</span>
    
  </p>

  <p>Using the <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme for <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>
  </p>
</footer>

          </div>
        </div>

        <!-- The Search results -->

<div id="search-result-wrapper" class="d-flex justify-content-center unloaded">
  <div class="col-11 content">
    <div id="search-hints">
      <!-- The trending tags list -->


















    </div>
    <div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div>
  </div>
</div>

      </div>

      <aside aria-label="Scroll to Top">
        <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow">
          <i class="fas fa-angle-up"></i>
        </button>
      </aside>
    </div>

    <div id="mask"></div>

    
      <aside
  id="notification"
  class="toast"
  role="alert"
  aria-live="assertive"
  aria-atomic="true"
  data-bs-animation="true"
  data-bs-autohide="false"
>
  <div class="toast-header">
    <button
      type="button"
      class="btn-close ms-auto"
      data-bs-dismiss="toast"
      aria-label="Close"
    ></button>
  </div>
  <div class="toast-body text-center pt-0">
    <p class="px-2 mb-3">A new version of content is available.</p>
    <button type="button" class="btn btn-primary" aria-label="Update">
      Update
    </button>
  </div>
</aside>

    

    <!-- JavaScripts -->

    <!-- JS selector for site. -->

<!-- commons -->



<!-- layout specified -->


  

  
    <!-- image lazy-loading & popup & clipboard -->
    
  















  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  



  <script src="https://cdn.jsdelivr.net/combine/npm/jquery@3.7.1/dist/jquery.min.js,npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js,npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/magnific-popup@1.1.0/dist/jquery.magnific-popup.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.10/dayjs.min.js,npm/dayjs@1.11.10/locale/en.min.js,npm/dayjs@1.11.10/plugin/relativeTime.min.js,npm/dayjs@1.11.10/plugin/localizedFormat.min.js,npm/tocbot@4.21.2/dist/tocbot.min.js"></script>






<script defer src="/assets/js/dist/post.min.js"></script>






    

    <!--
  Jekyll Simple Search loader
  See: <https://github.com/christian-fei/Simple-Jekyll-Search>
-->





<script>
  /* Note: dependent library will be loaded in `js-selector.html` */
  SimpleJekyllSearch({
    searchInput: document.getElementById('search-input'),
    resultsContainer: document.getElementById('search-results'),
    json: '/assets/js/data/search.json',
    searchResultTemplate: '  <article class="px-1 px-sm-2 px-lg-4 px-xl-0">    <header>      <h2><a href="{url}">{title}</a></h2>      <div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1">        {categories}        {tags}      </div>    </header>    <p>{snippet}</p>  </article>',
    noResultsText: '<p class="mt-5"></p>',
    templateMiddleware: function(prop, value, template) {
      if (prop === 'categories') {
        if (value === '') {
          return `${value}`;
        } else {
          return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`;
        }
      }

      if (prop === 'tags') {
        if (value === '') {
          return `${value}`;
        } else {
          return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`;
        }
      }
    }
  });
</script>

  </body>
</html>

