<!doctype html>














<!-- `site.alt_lang` can specify a language different from the UI -->
<html lang="en" data-mode="light">
  <!-- The Head -->

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta
    name="viewport"
    content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover"
  >

  

  

  
    <!-- Begin Jekyll SEO tag v2.8.0 -->
<meta name="generator" content="Jekyll v4.3.2" />
<meta property="og:title" content="Gem5 Event Loop" />
<meta property="og:locale" content="en" />
<meta name="description" content="I covered how GEM5 configures the hardware parameters through the python script. Also, in this posting I explained details how python can instantiate the CPP classes that actually simulate hardware components. Similar to this, actual simulation loop is implemented in CPP, but the simulation is started from the python script." />
<meta property="og:description" content="I covered how GEM5 configures the hardware parameters through the python script. Also, in this posting I explained details how python can instantiate the CPP classes that actually simulate hardware components. Similar to this, actual simulation loop is implemented in CPP, but the simulation is started from the python script." />
<link rel="canonical" href="https://ruach.github.io/posts/gem5-event-loop/" />
<meta property="og:url" content="https://ruach.github.io/posts/gem5-event-loop/" />
<meta property="og:site_name" content="Ruach" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-05-20T00:00:00-04:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Gem5 Event Loop" />
<meta name="twitter:site" content="@ruach_lee" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2020-05-20T00:00:00-04:00","datePublished":"2020-05-20T00:00:00-04:00","description":"I covered how GEM5 configures the hardware parameters through the python script. Also, in this posting I explained details how python can instantiate the CPP classes that actually simulate hardware components. Similar to this, actual simulation loop is implemented in CPP, but the simulation is started from the python script.","headline":"Gem5 Event Loop","mainEntityOfPage":{"@type":"WebPage","@id":"https://ruach.github.io/posts/gem5-event-loop/"},"url":"https://ruach.github.io/posts/gem5-event-loop/"}</script>
<!-- End Jekyll SEO tag -->

  

  <title>Gem5 Event Loop | Ruach
  </title>

  <!--
  The Favicons for Web, Android, Microsoft, and iOS (iPhone and iPad) Apps
  Generated by: https://realfavicongenerator.net/
-->



<link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png">
<link rel="manifest" href="/assets/img/favicons/site.webmanifest">
<link rel="shortcut icon" href="/assets/img/favicons/favicon.ico">
<meta name="apple-mobile-web-app-title" content="Ruach">
<meta name="application-name" content="Ruach">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml">
<meta name="theme-color" content="#ffffff">


  
    
      <link rel="preconnect" href="https://fonts.googleapis.com" >
      <link rel="dns-prefetch" href="https://fonts.googleapis.com" >
    
      <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      <link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin>
    
      <link rel="preconnect" href="https://fonts.googleapis.com" >
      <link rel="dns-prefetch" href="https://fonts.googleapis.com" >
    
      <link rel="preconnect" href="https://cdn.jsdelivr.net" >
      <link rel="dns-prefetch" href="https://cdn.jsdelivr.net" >
    

    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap">
  

  <!-- GA -->
  

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.2/css/all.min.css">

  <link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css">

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.21.2/dist/tocbot.min.css">
  

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css">
  

  
    <!-- Manific Popup -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css">
  

  <!-- JavaScript -->

  

  <!-- A placeholder to allow defining custom metadata -->

</head>


  <body>
    <!-- The Side Bar -->

<aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end">
  <header class="profile-wrapper">
    <a href="/" id="avatar" class="rounded-circle">
      
        
        <img src="/assets/img/jaehyuk.png" width="112" height="112" alt="avatar" onerror="this.style.display='none'">
      
    </a>

    <h1 class="site-title">
      <a href="/">Ruach</a>
    </h1>
    <p class="site-subtitle fst-italic mb-0">Jaehyuk Lee</p>
  </header>
  <!-- .profile-wrapper -->

  <nav class="flex-column flex-grow-1 w-100 ps-0">
    <ul class="nav">
      <!-- home -->
      <li class="nav-item">
        <a href="/" class="nav-link">
          <i class="fa-fw fas fa-home"></i>
          <span>HOME</span>
        </a>
      </li>
      <!-- the real tabs -->
      
        <li class="nav-item">
          <a href="/categories/" class="nav-link">
            <i class="fa-fw fas fa-stream"></i>
            

            <span>CATEGORIES</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/tags/" class="nav-link">
            <i class="fa-fw fas fa-tags"></i>
            

            <span>TAGS</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/archives/" class="nav-link">
            <i class="fa-fw fas fa-archive"></i>
            

            <span>ARCHIVES</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/about/" class="nav-link">
            <i class="fa-fw fas fa-info-circle"></i>
            

            <span>ABOUT</span>
          </a>
        </li>
        <!-- .nav-item -->
      
    </ul>
  </nav>

  <div class="sidebar-bottom d-flex flex-wrap  align-items-center w-100">
    

    
      

      
        <a
          href="javascript:location.href = 'mailto:' + ['jaehyuk','gatech.edu'].join('@')"
          aria-label="email"
          

          

          

          
        >
          <i class="fas fa-envelope"></i>
        </a>
      
    
      

      
        <a
          href="https://www.linkedin.com/in/jaehyuk-lee-29b33b121/"
          aria-label="linkedin"
          

          
            target="_blank"
            
          

          

          
            rel="noopener noreferrer"
          
        >
          <i class="fab fa-linkedin"></i>
        </a>
      
    
      

      
        <a
          href="https://github.com/Ruach"
          aria-label="github"
          

          
            target="_blank"
            
          

          

          
            rel="noopener noreferrer"
          
        >
          <i class="fab fa-github"></i>
        </a>
      
    
      

      
        <a
          href="https://stackoverflow.com/users/4460514/ruach?tab=profile"
          aria-label="stack-overflow"
          

          
            target="_blank"
            
          

          

          
            rel="noopener noreferrer"
          
        >
          <i class="fab fa-stack-overflow"></i>
        </a>
      
    
  </div>
  <!-- .sidebar-bottom -->
</aside>
<!-- #sidebar -->


    <div id="main-wrapper" class="d-flex justify-content-center">
      <div class="container d-flex flex-column px-xxl-5">
        <!-- The Top Bar -->

<header id="topbar-wrapper" aria-label="Top Bar">
  <div
    id="topbar"
    class="d-flex align-items-center justify-content-between px-lg-3 h-100"
  >
    <nav id="breadcrumb" aria-label="Breadcrumb">
      

      
        
          
            <span>
              <a href="/">
                Home
              </a>
            </span>

          
        
          
        
          
            
              <span>Gem5 Event Loop</span>
            

          
        
      
    </nav>
    <!-- endof #breadcrumb -->

    <button type="button" id="sidebar-trigger" class="btn btn-link">
      <i class="fas fa-bars fa-fw"></i>
    </button>

    <div id="topbar-title">
      Post
    </div>

    <button type="button" id="search-trigger" class="btn btn-link">
      <i class="fas fa-search fa-fw"></i>
    </button>

    <search class="align-items-center ms-3 ms-lg-0">
      <i class="fas fa-search fa-fw"></i>
      <input
        class="form-control"
        id="search-input"
        type="search"
        aria-label="search"
        autocomplete="off"
        placeholder="Search..."
      >
    </search>
    <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button>
  </div>
</header>


        <div class="row flex-grow-1">
          <main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4">
            
              <!-- Refactor the HTML structure -->



<!--
  In order to allow a wide table to scroll horizontally,
  we suround the markdown table with `<div class="table-wrapper">` and `</div>`
-->



<!--
  Fixed kramdown code highlight rendering:
  https://github.com/penibelst/jekyll-compress-html/issues/101
  https://github.com/penibelst/jekyll-compress-html/issues/71#issuecomment-188144901
-->



<!-- Change the icon of checkbox -->



<!-- Handle images -->





<!-- Add header for code snippets -->



<!-- Create heading anchors -->





  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    

    
  

  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    

    
  

  
  

  

  
  

  




<!-- return -->




<article class="px-1">
  <header>
    <h1 data-toc-skip>Gem5 Event Loop</h1>

    <div class="post-meta text-muted">
      <!-- published date -->
      <span>
        Posted
        <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1589947200"
  data-df="ll"
  
    data-bs-toggle="tooltip" data-bs-placement="bottom"
  
>
  May 20, 2020
</time>

      </span>

      <!-- lastmod date -->
      

      

      <div class="d-flex justify-content-between">
        <!-- author(s) -->
        <span>
          

          By

          <em>
            
              <a href="https://ruach.github.io">Jaehyuk Lee</a>
            
          </em>
        </span>

        <!-- read time -->
        <!-- Calculate the post's reading time, and display the word count in tooltip -->



<!-- words per minute -->










<!-- return element -->
<span
  class="readtime"
  data-bs-toggle="tooltip"
  data-bs-placement="bottom"
  title="4904 words"
>
  <em>27 min</em> read</span>

      </div>
      <!-- .d-flex -->
    </div>
    <!-- .post-meta -->
  </header>

  <div class="content">
    <p>I covered how GEM5 configures the hardware parameters through the python script.
Also, in <a href="">this posting</a> I explained details how python can instantiate the 
CPP classes that actually simulate hardware components. Similar to this, actual
simulation loop is implemented in CPP, but the simulation is started from the 
python script.</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="n">m5</span><span class="p">.</span><span class="nf">instantiate</span><span class="p">()</span>
<span class="n">exit_event</span> <span class="o">=</span> <span class="n">m5</span><span class="p">.</span><span class="nf">simulate</span><span class="p">()</span>
</pre></td></tr></tbody></table></code></div></div>

<p>After instantiating the platform, it invokes ‘simulate’ function from m5 module
to initiate simulation. Since actual simulation will be handled by the CPP, 
Let’s see how this python code will transfer execution control to the CPP 
implementation.</p>

<h2 id="overview-of-simulation-loop"><span class="me-2">Overview of simulation loop</span><a href="#overview-of-simulation-loop" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre></td><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">simulate</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">need_startup</span>
        
    <span class="k">if</span> <span class="n">need_startup</span><span class="p">:</span>
        <span class="n">root</span> <span class="o">=</span> <span class="n">objects</span><span class="p">.</span><span class="n">Root</span><span class="p">.</span><span class="nf">getInstance</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">root</span><span class="p">.</span><span class="nf">descendants</span><span class="p">():</span> <span class="n">obj</span><span class="p">.</span><span class="nf">startup</span><span class="p">()</span>
        <span class="n">need_startup</span> <span class="o">=</span> <span class="bp">False</span>
        
        <span class="c1"># Python exit handlers happen in reverse order.
</span>        <span class="c1"># We want to dump stats last.
</span>        <span class="n">atexit</span><span class="p">.</span><span class="nf">register</span><span class="p">(</span><span class="n">stats</span><span class="p">.</span><span class="n">dump</span><span class="p">)</span>
    
        <span class="c1"># register our C++ exit callback function with Python
</span>        <span class="n">atexit</span><span class="p">.</span><span class="nf">register</span><span class="p">(</span><span class="n">_m5</span><span class="p">.</span><span class="n">core</span><span class="p">.</span><span class="n">doExitCleanup</span><span class="p">)</span>
    
        <span class="c1"># Reset to put the stats in a consistent state.
</span>        <span class="n">stats</span><span class="p">.</span><span class="nf">reset</span><span class="p">()</span>
        
    <span class="k">if</span> <span class="n">_drain_manager</span><span class="p">.</span><span class="nf">isDrained</span><span class="p">():</span>
        <span class="n">_drain_manager</span><span class="p">.</span><span class="nf">resume</span><span class="p">()</span>
            
    <span class="c1"># We flush stdout and stderr before and after the simulation to ensure the
</span>    <span class="c1"># output arrive in order.
</span>    <span class="n">sys</span><span class="p">.</span><span class="n">stdout</span><span class="p">.</span><span class="nf">flush</span><span class="p">()</span>
    <span class="n">sys</span><span class="p">.</span><span class="n">stderr</span><span class="p">.</span><span class="nf">flush</span><span class="p">()</span>
    <span class="n">sim_out</span> <span class="o">=</span> <span class="n">_m5</span><span class="p">.</span><span class="n">event</span><span class="p">.</span><span class="nf">simulate</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">sys</span><span class="p">.</span><span class="n">stdout</span><span class="p">.</span><span class="nf">flush</span><span class="p">()</span>
    <span class="n">sys</span><span class="p">.</span><span class="n">stderr</span><span class="p">.</span><span class="nf">flush</span><span class="p">()</span>
</pre></td></tr></tbody></table></code></div></div>

<p>The simulate function invokes startup function from all SimObjects instantiated
by the python script, if it needs startup. After some initialization, it invokes
CPP simulate function through ‘_m5.event’ module. Remind that some CPP functions
related with simulation are exported to python through pybind in the very first
part of GEM5 execution. This is time to say good bye to python! From now on, 99%
of simulation code will be CPP! Be prepared to jumping into real hardware 
simulation logic!</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
</pre></td><td class="rouge-code"><pre><span class="c1">//gem5/src/sim/simulate.cc</span>

<span class="n">GlobalSimLoopExitEvent</span> <span class="o">*</span>
<span class="nf">simulate</span><span class="p">(</span><span class="n">Tick</span> <span class="n">num_cycles</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// The first time simulate() is called from the Python code, we need to</span>
    <span class="c1">// create a thread for each of event queues referenced by the</span>
    <span class="c1">// instantiated sim objects.</span>
    <span class="k">static</span> <span class="kt">bool</span> <span class="n">threads_initialized</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="k">static</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="kr">thread</span> <span class="o">*&gt;</span> <span class="n">threads</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">threads_initialized</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">threadBarrier</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Barrier</span><span class="p">(</span><span class="n">numMainEventQueues</span><span class="p">);</span>

        <span class="c1">// the main thread (the one we're currently running on)</span>
        <span class="c1">// handles queue 0, so we only need to allocate new threads</span>
        <span class="c1">// for queues 1..N-1.  We'll call these the "subordinate" threads.</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">numMainEventQueues</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">threads</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="k">new</span> <span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="p">(</span><span class="n">thread_loop</span><span class="p">,</span> <span class="n">mainEventQueue</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
        <span class="p">}</span>

        <span class="n">threads_initialized</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
        <span class="n">simulate_limit_event</span> <span class="o">=</span>
            <span class="k">new</span> <span class="nf">GlobalSimLoopExitEvent</span><span class="p">(</span><span class="n">mainEventQueue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">getCurTick</span><span class="p">(),</span>
                                       <span class="s">"simulate() limit reached"</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">inform</span><span class="p">(</span><span class="s">"Entering event queue @ %d.  Starting simulation...</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">curTick</span><span class="p">());</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">num_cycles</span> <span class="o">&lt;</span> <span class="n">MaxTick</span> <span class="o">-</span> <span class="n">curTick</span><span class="p">())</span>
        <span class="n">num_cycles</span> <span class="o">=</span> <span class="n">curTick</span><span class="p">()</span> <span class="o">+</span> <span class="n">num_cycles</span><span class="p">;</span>
    <span class="k">else</span> <span class="c1">// counter would roll over or be set to MaxTick anyhow</span>
        <span class="n">num_cycles</span> <span class="o">=</span> <span class="n">MaxTick</span><span class="p">;</span>

    <span class="n">simulate_limit_event</span><span class="o">-&gt;</span><span class="n">reschedule</span><span class="p">(</span><span class="n">num_cycles</span><span class="p">);</span>

    <span class="n">GlobalSyncEvent</span> <span class="o">*</span><span class="n">quantum_event</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">numMainEventQueues</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">simQuantum</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">fatal</span><span class="p">(</span><span class="s">"Quantum for multi-eventq simulation not specified"</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="n">quantum_event</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">GlobalSyncEvent</span><span class="p">(</span><span class="n">curTick</span><span class="p">()</span> <span class="o">+</span> <span class="n">simQuantum</span><span class="p">,</span> <span class="n">simQuantum</span><span class="p">,</span>
                            <span class="n">EventBase</span><span class="o">::</span><span class="n">Progress_Event_Pri</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

        <span class="n">inParallelMode</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// all subordinate (created) threads should be waiting on the</span>
    <span class="c1">// barrier; the arrival of the main thread here will satisfy the</span>
    <span class="c1">// barrier, and all threads will enter doSimLoop in parallel</span>
    <span class="n">threadBarrier</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">();</span>
    <span class="n">Event</span> <span class="o">*</span><span class="n">local_event</span> <span class="o">=</span> <span class="n">doSimLoop</span><span class="p">(</span><span class="n">mainEventQueue</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">local_event</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>

    <span class="n">inParallelMode</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

    <span class="c1">// locate the global exit event and return it to Python</span>
    <span class="n">BaseGlobalEvent</span> <span class="o">*</span><span class="n">global_event</span> <span class="o">=</span> <span class="n">local_event</span><span class="o">-&gt;</span><span class="n">globalEvent</span><span class="p">();</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">global_event</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>

    <span class="n">GlobalSimLoopExitEvent</span> <span class="o">*</span><span class="n">global_exit_event</span> <span class="o">=</span>
        <span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="n">GlobalSimLoopExitEvent</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">global_event</span><span class="p">);</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">global_exit_event</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>

    <span class="c1">//! Delete the simulation quantum event.</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">quantum_event</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">quantum_event</span><span class="o">-&gt;</span><span class="n">deschedule</span><span class="p">();</span>
        <span class="k">delete</span> <span class="n">quantum_event</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">global_exit_event</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>After going through some initialization related with threads, it invokes the 
main simulation loop ‘doSimLoop’.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
</pre></td><td class="rouge-code"><pre><span class="c1">//gem5/src/sim/simulate.cc</span>

<span class="n">Event</span> <span class="o">*</span>
<span class="nf">doSimLoop</span><span class="p">(</span><span class="n">EventQueue</span> <span class="o">*</span><span class="n">eventq</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// set the per thread current eventq pointer</span>
    <span class="n">curEventQueue</span><span class="p">(</span><span class="n">eventq</span><span class="p">);</span>
    <span class="n">eventq</span><span class="o">-&gt;</span><span class="n">handleAsyncInsertions</span><span class="p">();</span>

    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// there should always be at least one event (the SimLoopExitEvent</span>
        <span class="c1">// we just scheduled) in the queue</span>
        <span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">eventq</span><span class="o">-&gt;</span><span class="n">empty</span><span class="p">());</span>
        <span class="n">assert</span><span class="p">(</span><span class="n">curTick</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">eventq</span><span class="o">-&gt;</span><span class="n">nextTick</span><span class="p">()</span> <span class="o">&amp;&amp;</span>
               <span class="s">"event scheduled in the past"</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">async_event</span> <span class="o">&amp;&amp;</span> <span class="n">testAndClearAsyncEvent</span><span class="p">())</span> <span class="p">{</span>
            <span class="c1">// Take the event queue lock in case any of the service</span>
            <span class="c1">// routines want to schedule new events.</span>
            <span class="n">std</span><span class="o">::</span><span class="n">lock_guard</span><span class="o">&lt;</span><span class="n">EventQueue</span><span class="o">&gt;</span> <span class="n">lock</span><span class="p">(</span><span class="o">*</span><span class="n">eventq</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">async_statdump</span> <span class="o">||</span> <span class="n">async_statreset</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">Stats</span><span class="o">::</span><span class="n">schedStatEvent</span><span class="p">(</span><span class="n">async_statdump</span><span class="p">,</span> <span class="n">async_statreset</span><span class="p">);</span>
                <span class="n">async_statdump</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
                <span class="n">async_statreset</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">async_io</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">async_io</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
                <span class="n">pollQueue</span><span class="p">.</span><span class="n">service</span><span class="p">();</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">async_exit</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">async_exit</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
                <span class="n">exitSimLoop</span><span class="p">(</span><span class="s">"user interrupt received"</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">async_exception</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">async_exception</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
                <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="n">Event</span> <span class="o">*</span><span class="n">exit_event</span> <span class="o">=</span> <span class="n">eventq</span><span class="o">-&gt;</span><span class="n">serviceOne</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">exit_event</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">exit_event</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// not reached... only exit is return on SimLoopExitEvent</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>The central simulation sequence in GEM5 is the “doSimLoop.” This loop persists
until it encounters an “exit_event” that signals the end of the simulation. In 
the event of program termination due to an unhandled fault, GEM5 schedules the 
“exit_event,” prompting the “doSimLoop” to conclude. Most of the cases, it will
not face the exit_event and process events through the <strong>serviceOne</strong> function 
of the EventQueue.</p>

<h2 id="eventqueue-managing-all-events"><span class="me-2">EventQueue: managing all Events</span><a href="#eventqueue-managing-all-events" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<p>EventQueue manages several functions to manage generated Events, such as 
inserting and deleting the Event object from the queue. The main simulation loop
utilize this Queue to simulate hardware events.</p>

<blockquote>
  <p>EventQueue class is defined as friend class of Event class so it can access 
private and protected members of the Event objects managed by the queue.</p>
</blockquote>

<h3 id="serviceone-handle-scheduled-event"><span class="me-2">serviceOne: handle scheduled event</span><a href="#serviceone-handle-scheduled-event" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>Before deviling into the details of event, to grab the idea about how GEM5 
utilize this event for simulation, it would be helpful to go over below function.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
</pre></td><td class="rouge-code"><pre><span class="mi">203</span> <span class="n">Event</span> <span class="o">*</span>
<span class="mi">204</span> <span class="n">EventQueue</span><span class="o">::</span><span class="n">serviceOne</span><span class="p">()</span>
<span class="mi">205</span> <span class="p">{</span>
<span class="mi">206</span>     <span class="n">std</span><span class="o">::</span><span class="n">lock_guard</span><span class="o">&lt;</span><span class="n">EventQueue</span><span class="o">&gt;</span> <span class="n">lock</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">);</span>
<span class="mi">207</span>     <span class="n">Event</span> <span class="o">*</span><span class="n">event</span> <span class="o">=</span> <span class="n">head</span><span class="p">;</span>
<span class="mi">208</span>     <span class="n">Event</span> <span class="o">*</span><span class="n">next</span> <span class="o">=</span> <span class="n">head</span><span class="o">-&gt;</span><span class="n">nextInBin</span><span class="p">;</span>
<span class="mi">209</span>     <span class="n">event</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">clear</span><span class="p">(</span><span class="n">Event</span><span class="o">::</span><span class="n">Scheduled</span><span class="p">);</span>
<span class="mi">210</span> 
<span class="mi">211</span>     <span class="k">if</span> <span class="p">(</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">212</span>         <span class="c1">// update the next bin pointer since it could be stale</span>
<span class="mi">213</span>         <span class="n">next</span><span class="o">-&gt;</span><span class="n">nextBin</span> <span class="o">=</span> <span class="n">head</span><span class="o">-&gt;</span><span class="n">nextBin</span><span class="p">;</span>
<span class="mi">214</span> 
<span class="mi">215</span>         <span class="c1">// pop the stack</span>
<span class="mi">216</span>         <span class="n">head</span> <span class="o">=</span> <span class="n">next</span><span class="p">;</span>
<span class="mi">217</span>     <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="mi">218</span>         <span class="c1">// this was the only element on the 'in bin' list, so get rid of</span>
<span class="mi">219</span>         <span class="c1">// the 'in bin' list and point to the next bin list</span>
<span class="mi">220</span>         <span class="n">head</span> <span class="o">=</span> <span class="n">head</span><span class="o">-&gt;</span><span class="n">nextBin</span><span class="p">;</span>
<span class="mi">221</span>     <span class="p">}</span>
<span class="mi">222</span> 
<span class="mi">223</span>     <span class="c1">// handle action</span>
<span class="mi">224</span>     <span class="nf">if</span> <span class="p">(</span><span class="o">!</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">squashed</span><span class="p">())</span> <span class="p">{</span>
<span class="mi">225</span>         <span class="c1">// forward current cycle to the time when this event occurs.</span>
<span class="mi">226</span>         <span class="n">setCurTick</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">when</span><span class="p">());</span>
<span class="mi">227</span> 
<span class="mi">228</span>         <span class="n">event</span><span class="o">-&gt;</span><span class="n">process</span><span class="p">();</span>
<span class="mi">229</span>         <span class="k">if</span> <span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">isExitEvent</span><span class="p">())</span> <span class="p">{</span>
<span class="mi">230</span>             <span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">isSet</span><span class="p">(</span><span class="n">Event</span><span class="o">::</span><span class="n">Managed</span><span class="p">)</span> <span class="o">||</span>
<span class="mi">231</span>                    <span class="o">!</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">isSet</span><span class="p">(</span><span class="n">Event</span><span class="o">::</span><span class="n">IsMainQueue</span><span class="p">));</span> <span class="c1">// would be silly</span>
<span class="mi">232</span>             <span class="k">return</span> <span class="n">event</span><span class="p">;</span>
<span class="mi">233</span>         <span class="p">}</span>
<span class="mi">234</span>     <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="mi">235</span>         <span class="n">event</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">clear</span><span class="p">(</span><span class="n">Event</span><span class="o">::</span><span class="n">Squashed</span><span class="p">);</span>
<span class="mi">236</span>     <span class="p">}</span>
<span class="mi">237</span> 
<span class="mi">238</span>     <span class="n">event</span><span class="o">-&gt;</span><span class="n">release</span><span class="p">();</span>
<span class="mi">239</span> 
<span class="mi">240</span>     <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="mi">241</span> <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>The “serviceOne” function is responsible for processing events scheduled by 
simulated hardware components. Unless an event is marked as squashed, it proceeds
to execute the task associated with that event by invoking the event’s 
<strong>process</strong> function. The process function describe the hardware logic that needs
to be simulated.</p>

<h3 id="other-operations-of-eventqueue"><span class="me-2">Other operations of EventQueue</span><a href="#other-operations-of-eventqueue" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>The most important method of the EventQueue is <strong>serviceOne</strong> function. Because
it actually executes the hardware simulation logic.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre></td><td class="rouge-code"><pre> <span class="mi">41</span> <span class="kr">inline</span> <span class="kt">void</span>
 <span class="mi">42</span> <span class="n">EventQueue</span><span class="o">::</span><span class="n">schedule</span><span class="p">(</span><span class="n">Event</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span> <span class="n">Tick</span> <span class="n">when</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">global</span><span class="p">)</span>
 <span class="mi">43</span> <span class="p">{</span>
 <span class="mi">44</span>     <span class="n">assert</span><span class="p">(</span><span class="n">when</span> <span class="o">&gt;=</span> <span class="n">getCurTick</span><span class="p">());</span>
 <span class="mi">45</span>     <span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">scheduled</span><span class="p">());</span>
 <span class="mi">46</span>     <span class="n">assert</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">initialized</span><span class="p">());</span>
 <span class="mi">47</span> 
 <span class="mi">48</span>     <span class="n">event</span><span class="o">-&gt;</span><span class="n">setWhen</span><span class="p">(</span><span class="n">when</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
 <span class="mi">49</span> 
 <span class="mi">50</span>     <span class="c1">// The check below is to make sure of two things</span>
 <span class="mi">51</span>     <span class="c1">// a. a thread schedules local events on other queues through the asyncq</span>
 <span class="mi">52</span>     <span class="c1">// b. a thread schedules global events on the asyncq, whether or not</span>
 <span class="mi">53</span>     <span class="c1">//    this event belongs to this eventq. This is required to maintain</span>
 <span class="mi">54</span>     <span class="c1">//    a total order amongst the global events. See global_event.{cc,hh}</span>
 <span class="mi">55</span>     <span class="c1">//    for more explanation.</span>
 <span class="mi">56</span>     <span class="k">if</span> <span class="p">(</span><span class="n">inParallelMode</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="k">this</span> <span class="o">!=</span> <span class="n">curEventQueue</span><span class="p">()</span> <span class="o">||</span> <span class="n">global</span><span class="p">))</span> <span class="p">{</span>
 <span class="mi">57</span>         <span class="n">asyncInsert</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
 <span class="mi">58</span>     <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
 <span class="mi">59</span>         <span class="n">insert</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
 <span class="mi">60</span>     <span class="p">}</span>
 <span class="mi">61</span>     <span class="n">event</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="n">Event</span><span class="o">::</span><span class="n">Scheduled</span><span class="p">);</span>
 <span class="mi">62</span>     <span class="n">event</span><span class="o">-&gt;</span><span class="n">acquire</span><span class="p">();</span>
 <span class="mi">63</span> 
 <span class="mi">64</span>     <span class="nf">if</span> <span class="p">(</span><span class="n">DTRACE</span><span class="p">(</span><span class="n">Event</span><span class="p">))</span>
 <span class="mi">65</span>         <span class="n">event</span><span class="o">-&gt;</span><span class="n">trace</span><span class="p">(</span><span class="s">"scheduled"</span><span class="p">);</span>
 <span class="mi">66</span> <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>To add a new event to the queue, rather than using the queue’s insert function 
directly, it is required to use the ‘schedule’ function. The ‘schedule’ function
is responsible for setting critical fields like ‘_when’ and the event’s flags 
(e.g., Event::Scheduled) during the insertion process. Additionally, it triggers
the ‘insert’ function to effectively place the new item into the queue.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td><td class="rouge-code"><pre><span class="mi">117</span> <span class="kt">void</span>
<span class="mi">118</span> <span class="n">EventQueue</span><span class="o">::</span><span class="n">insert</span><span class="p">(</span><span class="n">Event</span> <span class="o">*</span><span class="n">event</span><span class="p">)</span>
<span class="mi">119</span> <span class="p">{</span>
<span class="mi">120</span>     <span class="c1">// Deal with the head case</span>
<span class="mi">121</span>     <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">head</span> <span class="o">||</span> <span class="o">*</span><span class="n">event</span> <span class="o">&lt;=</span> <span class="o">*</span><span class="n">head</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">122</span>         <span class="n">head</span> <span class="o">=</span> <span class="n">Event</span><span class="o">::</span><span class="n">insertBefore</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">head</span><span class="p">);</span>
<span class="mi">123</span>         <span class="k">return</span><span class="p">;</span>
<span class="mi">124</span>     <span class="p">}</span>
<span class="mi">125</span> 
<span class="mi">126</span>     <span class="c1">// Figure out either which 'in bin' list we are on, or where a new list</span>
<span class="mi">127</span>     <span class="c1">// needs to be inserted</span>
<span class="mi">128</span>     <span class="n">Event</span> <span class="o">*</span><span class="n">prev</span> <span class="o">=</span> <span class="n">head</span><span class="p">;</span>
<span class="mi">129</span>     <span class="n">Event</span> <span class="o">*</span><span class="n">curr</span> <span class="o">=</span> <span class="n">head</span><span class="o">-&gt;</span><span class="n">nextBin</span><span class="p">;</span>
<span class="mi">130</span>     <span class="nf">while</span> <span class="p">(</span><span class="n">curr</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">curr</span> <span class="o">&lt;</span> <span class="o">*</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">131</span>         <span class="n">prev</span> <span class="o">=</span> <span class="n">curr</span><span class="p">;</span>
<span class="mi">132</span>         <span class="n">curr</span> <span class="o">=</span> <span class="n">curr</span><span class="o">-&gt;</span><span class="n">nextBin</span><span class="p">;</span>
<span class="mi">133</span>     <span class="p">}</span>
<span class="mi">134</span> 
<span class="mi">135</span>     <span class="c1">// Note: this operation may render all nextBin pointers on the</span>
<span class="mi">136</span>     <span class="c1">// prev 'in bin' list stale (except for the top one)</span>
<span class="mi">137</span>     <span class="n">prev</span><span class="o">-&gt;</span><span class="n">nextBin</span> <span class="o">=</span> <span class="n">Event</span><span class="o">::</span><span class="n">insertBefore</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">curr</span><span class="p">);</span>
<span class="mi">138</span> <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>An interesting aspect to observe in the ‘insert’ function is how it arranges the
insertion of a new item in a specific order. Given that the EventQueue manages
various events with distinct priorities scheduled at varying times, the sequence
in which Events are organized within the queue plays a vital role in emulating 
events in cycle-accurate manner. To define the order, it needs a metric to 
compare two Event objects.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
</pre></td><td class="rouge-code"><pre><span class="mi">415</span> <span class="kr">inline</span> <span class="kt">bool</span>
<span class="mi">416</span> <span class="k">operator</span><span class="o">&lt;</span><span class="p">(</span><span class="k">const</span> <span class="n">Event</span> <span class="o">&amp;</span><span class="n">l</span><span class="p">,</span> <span class="k">const</span> <span class="n">Event</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">)</span>
<span class="mi">417</span> <span class="p">{</span>
<span class="mi">418</span>     <span class="k">return</span> <span class="n">l</span><span class="p">.</span><span class="n">when</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">r</span><span class="p">.</span><span class="n">when</span><span class="p">()</span> <span class="o">||</span>
<span class="mi">419</span>         <span class="p">(</span><span class="n">l</span><span class="p">.</span><span class="n">when</span><span class="p">()</span> <span class="o">==</span> <span class="n">r</span><span class="p">.</span><span class="n">when</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">l</span><span class="p">.</span><span class="n">priority</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">r</span><span class="p">.</span><span class="n">priority</span><span class="p">());</span>
<span class="mi">420</span> <span class="p">}</span>
<span class="mi">421</span> 
<span class="mi">422</span> <span class="kr">inline</span> <span class="kt">bool</span>
<span class="mi">423</span> <span class="k">operator</span><span class="o">&gt;</span><span class="p">(</span><span class="k">const</span> <span class="n">Event</span> <span class="o">&amp;</span><span class="n">l</span><span class="p">,</span> <span class="k">const</span> <span class="n">Event</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">)</span>
<span class="mi">424</span> <span class="p">{</span>
<span class="mi">425</span>     <span class="k">return</span> <span class="n">l</span><span class="p">.</span><span class="n">when</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">r</span><span class="p">.</span><span class="n">when</span><span class="p">()</span> <span class="o">||</span>
<span class="mi">426</span>         <span class="p">(</span><span class="n">l</span><span class="p">.</span><span class="n">when</span><span class="p">()</span> <span class="o">==</span> <span class="n">r</span><span class="p">.</span><span class="n">when</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">l</span><span class="p">.</span><span class="n">priority</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">r</span><span class="p">.</span><span class="n">priority</span><span class="p">());</span>
<span class="mi">427</span> <span class="p">}</span>
<span class="mi">428</span> 
<span class="mi">429</span> <span class="kr">inline</span> <span class="kt">bool</span>
<span class="mi">430</span> <span class="k">operator</span><span class="o">&lt;=</span><span class="p">(</span><span class="k">const</span> <span class="n">Event</span> <span class="o">&amp;</span><span class="n">l</span><span class="p">,</span> <span class="k">const</span> <span class="n">Event</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">)</span>
<span class="mi">431</span> <span class="p">{</span>
<span class="mi">432</span>     <span class="k">return</span> <span class="n">l</span><span class="p">.</span><span class="n">when</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">r</span><span class="p">.</span><span class="n">when</span><span class="p">()</span> <span class="o">||</span>
<span class="mi">433</span>         <span class="p">(</span><span class="n">l</span><span class="p">.</span><span class="n">when</span><span class="p">()</span> <span class="o">==</span> <span class="n">r</span><span class="p">.</span><span class="n">when</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">l</span><span class="p">.</span><span class="n">priority</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">r</span><span class="p">.</span><span class="n">priority</span><span class="p">());</span>
<span class="mi">434</span> <span class="p">}</span>
<span class="mi">435</span> <span class="kr">inline</span> <span class="kt">bool</span>
<span class="mi">436</span> <span class="k">operator</span><span class="o">&gt;=</span><span class="p">(</span><span class="k">const</span> <span class="n">Event</span> <span class="o">&amp;</span><span class="n">l</span><span class="p">,</span> <span class="k">const</span> <span class="n">Event</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">)</span>
<span class="mi">437</span> <span class="p">{</span>
<span class="mi">438</span>     <span class="k">return</span> <span class="n">l</span><span class="p">.</span><span class="n">when</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">r</span><span class="p">.</span><span class="n">when</span><span class="p">()</span> <span class="o">||</span>
<span class="mi">439</span>         <span class="p">(</span><span class="n">l</span><span class="p">.</span><span class="n">when</span><span class="p">()</span> <span class="o">==</span> <span class="n">r</span><span class="p">.</span><span class="n">when</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">l</span><span class="p">.</span><span class="n">priority</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="n">r</span><span class="p">.</span><span class="n">priority</span><span class="p">());</span>
<span class="mi">440</span> <span class="p">}</span>
<span class="mi">441</span> 
<span class="mi">442</span> <span class="kr">inline</span> <span class="kt">bool</span>
<span class="mi">443</span> <span class="k">operator</span><span class="o">==</span><span class="p">(</span><span class="k">const</span> <span class="n">Event</span> <span class="o">&amp;</span><span class="n">l</span><span class="p">,</span> <span class="k">const</span> <span class="n">Event</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">)</span>
<span class="mi">444</span> <span class="p">{</span>
<span class="mi">445</span>     <span class="k">return</span> <span class="n">l</span><span class="p">.</span><span class="n">when</span><span class="p">()</span> <span class="o">==</span> <span class="n">r</span><span class="p">.</span><span class="n">when</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">l</span><span class="p">.</span><span class="n">priority</span><span class="p">()</span> <span class="o">==</span> <span class="n">r</span><span class="p">.</span><span class="n">priority</span><span class="p">();</span>
<span class="mi">446</span> <span class="p">}</span>
<span class="mi">447</span> 
<span class="mi">448</span> <span class="kr">inline</span> <span class="kt">bool</span>
<span class="mi">449</span> <span class="k">operator</span><span class="o">!=</span><span class="p">(</span><span class="k">const</span> <span class="n">Event</span> <span class="o">&amp;</span><span class="n">l</span><span class="p">,</span> <span class="k">const</span> <span class="n">Event</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">)</span>
<span class="mi">450</span> <span class="p">{</span>
<span class="mi">451</span>     <span class="k">return</span> <span class="n">l</span><span class="p">.</span><span class="n">when</span><span class="p">()</span> <span class="o">!=</span> <span class="n">r</span><span class="p">.</span><span class="n">when</span><span class="p">()</span> <span class="o">||</span> <span class="n">l</span><span class="p">.</span><span class="n">priority</span><span class="p">()</span> <span class="o">!=</span> <span class="n">r</span><span class="p">.</span><span class="n">priority</span><span class="p">();</span>
<span class="mi">452</span> <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>
<p>As depicted in the code above, operator overloading offers a mechanism for 
comparing Event objects. This comparison involves assessing the timing of two 
distinct events, indicating when these events are scheduled to occur. Additionally,
it evaluates the priority of events in cases where two events are scheduled to 
be executed during the same cycle.</p>

<h2 id="event-the-basic-unit-of-execution-on-gem5-simulation"><span class="me-2">Event: the basic unit of execution on GEM5 simulation</span><a href="#event-the-basic-unit-of-execution-on-gem5-simulation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<p>As a cycle-level simulator, GEM5 simulates hardware logic for each cycle. To
enable the execution of specific logic at precise points in the cycle, it should
be able to know which hardware component needs to be simulated at which cycle. 
To this end, GEM5 asks each hardware component to generate event that describes
which event should be simulated at which specific cycle. The generated events 
are managed by the EventQueue where the main simulation loop fetches the event 
from and execute simulation logic.</p>

<h3 id="event-class"><span class="me-2">Event class</span><a href="#event-class" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>The Event class defines fundamental operations necessary for the execution of 
GEM5 events, crucial for simulating architecture. Each hardware component can 
communicate with simulation loop through the Event.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
</pre></td><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">Event</span> <span class="o">:</span> <span class="k">public</span> <span class="n">EventBase</span><span class="p">,</span> <span class="k">public</span> <span class="n">Serializable</span>
<span class="p">{</span>
    <span class="k">friend</span> <span class="k">class</span> <span class="nc">EventQueue</span><span class="p">;</span>

  <span class="nl">private:</span>
    <span class="c1">// The event queue is now a linked list of linked lists.  The</span>
    <span class="c1">// 'nextBin' pointer is to find the bin, where a bin is defined as</span>
    <span class="c1">// when+priority.  All events in the same bin will be stored in a</span>
    <span class="c1">// second linked list (a stack) maintained by the 'nextInBin'</span>
    <span class="c1">// pointer.  The list will be accessed in LIFO order.  The end</span>
    <span class="c1">// result is that the insert/removal in 'nextBin' is</span>
    <span class="c1">// linear/constant, and the lookup/removal in 'nextInBin' is</span>
    <span class="c1">// constant/constant.  Hopefully this is a significant improvement</span>
    <span class="c1">// over the current fully linear insertion.</span>
    <span class="n">Event</span> <span class="o">*</span><span class="n">nextBin</span><span class="p">;</span>
    <span class="n">Event</span> <span class="o">*</span><span class="n">nextInBin</span><span class="p">;</span>

    <span class="k">static</span> <span class="n">Event</span> <span class="o">*</span><span class="n">insertBefore</span><span class="p">(</span><span class="n">Event</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span> <span class="n">Event</span> <span class="o">*</span><span class="n">curr</span><span class="p">);</span>
    <span class="k">static</span> <span class="n">Event</span> <span class="o">*</span><span class="n">removeItem</span><span class="p">(</span><span class="n">Event</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span> <span class="n">Event</span> <span class="o">*</span><span class="n">last</span><span class="p">);</span>

    <span class="n">Tick</span> <span class="n">_when</span><span class="p">;</span>         <span class="c1">//!&lt; timestamp when event should be processed</span>
    <span class="n">Priority</span> <span class="n">_priority</span><span class="p">;</span> <span class="c1">//!&lt; event priority</span>
    <span class="n">Flags</span> <span class="n">flags</span><span class="p">;</span>
    <span class="p">.....</span>

  <span class="nl">public:</span>

    <span class="cm">/*
     * Event constructor
     * @param queue that the event gets scheduled on
     */</span>
    <span class="n">Event</span><span class="p">(</span><span class="n">Priority</span> <span class="n">p</span> <span class="o">=</span> <span class="n">Default_Pri</span><span class="p">,</span> <span class="n">Flags</span> <span class="n">f</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="o">:</span> <span class="n">nextBin</span><span class="p">(</span><span class="nb">nullptr</span><span class="p">),</span> <span class="n">nextInBin</span><span class="p">(</span><span class="nb">nullptr</span><span class="p">),</span> <span class="n">_when</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">_priority</span><span class="p">(</span><span class="n">p</span><span class="p">),</span>
          <span class="n">flags</span><span class="p">(</span><span class="n">Initialized</span> <span class="o">|</span> <span class="n">f</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">assert</span><span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="n">noneSet</span><span class="p">(</span><span class="o">~</span><span class="n">PublicWrite</span><span class="p">));</span>
<span class="cp">#ifndef NDEBUG
</span>        <span class="n">instance</span> <span class="o">=</span> <span class="o">++</span><span class="n">instanceCounter</span><span class="p">;</span>
        <span class="n">queue</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="cp">#endif
#ifdef EVENTQ_DEBUG
</span>        <span class="n">whenCreated</span> <span class="o">=</span> <span class="n">curTick</span><span class="p">();</span>
        <span class="n">whenScheduled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif
</span>    <span class="p">}</span>

    <span class="k">virtual</span> <span class="o">~</span><span class="n">Event</span><span class="p">();</span>
    <span class="c1">/// describing the event class.</span>
    <span class="k">virtual</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">description</span><span class="p">()</span> <span class="k">const</span><span class="p">;</span>

    <span class="c1">/// Dump the current event data</span>
    <span class="kt">void</span> <span class="n">dump</span><span class="p">()</span> <span class="k">const</span><span class="p">;</span>

  <span class="k">public</span><span class="o">:</span>
    <span class="k">virtual</span> <span class="kt">void</span> <span class="n">process</span><span class="p">()</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="c1">/// Determine if the current event is scheduled</span>
    <span class="kt">bool</span> <span class="nf">scheduled</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">flags</span><span class="p">.</span><span class="n">isSet</span><span class="p">(</span><span class="n">Scheduled</span><span class="p">);</span> <span class="p">}</span>

    <span class="c1">/// Squash the current event</span>
    <span class="kt">void</span> <span class="nf">squash</span><span class="p">()</span> <span class="p">{</span> <span class="n">flags</span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="n">Squashed</span><span class="p">);</span> <span class="p">}</span>

    <span class="c1">/// Check whether the event is squashed</span>
    <span class="kt">bool</span> <span class="nf">squashed</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">flags</span><span class="p">.</span><span class="n">isSet</span><span class="p">(</span><span class="n">Squashed</span><span class="p">);</span> <span class="p">}</span>

    <span class="c1">/// See if this is a SimExitEvent (without resorting to RTTI)</span>
    <span class="kt">bool</span> <span class="nf">isExitEvent</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">flags</span><span class="p">.</span><span class="n">isSet</span><span class="p">(</span><span class="n">IsExitEvent</span><span class="p">);</span> <span class="p">}</span>

    <span class="c1">/// Check whether this event will auto-delete</span>
    <span class="kt">bool</span> <span class="nf">isManaged</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">flags</span><span class="p">.</span><span class="n">isSet</span><span class="p">(</span><span class="n">Managed</span><span class="p">);</span> <span class="p">}</span>
    <span class="kt">bool</span> <span class="nf">isAutoDelete</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">isManaged</span><span class="p">();</span> <span class="p">}</span>

    <span class="c1">/// Get the time that the event is scheduled</span>
    <span class="n">Tick</span> <span class="n">when</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">_when</span><span class="p">;</span> <span class="p">}</span>

    <span class="c1">/// Get the event priority</span>
    <span class="n">Priority</span> <span class="n">priority</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">_priority</span><span class="p">;</span> <span class="p">}</span>

    <span class="c1">//! If this is part of a GlobalEvent, return the pointer to the</span>
    <span class="c1">//! Global Event.  By default, there is no GlobalEvent, so return</span>
    <span class="c1">//! NULL.  (Overridden in GlobalEvent::BarrierEvent.)</span>
    <span class="k">virtual</span> <span class="n">BaseGlobalEvent</span> <span class="o">*</span><span class="nf">globalEvent</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span> <span class="p">}</span>

    <span class="kt">void</span> <span class="n">serialize</span><span class="p">(</span><span class="n">CheckpointOut</span> <span class="o">&amp;</span><span class="n">cp</span><span class="p">)</span> <span class="k">const</span> <span class="k">override</span><span class="p">;</span>
    <span class="kt">void</span> <span class="n">unserialize</span><span class="p">(</span><span class="n">CheckpointIn</span> <span class="o">&amp;</span><span class="n">cp</span><span class="p">)</span> <span class="k">override</span><span class="p">;</span>
<span class="p">};</span>
</pre></td></tr></tbody></table></code></div></div>
<p>When an event object is chosen from the queue, the main execution loop calls the
<strong>process</strong> member function of that class. It’s important to highlight that the 
process function is declared as virtual, allowing child classes inheriting from 
the Event class to supply the necessary operations to simulate specific events. 
Additionally, the Event class has a member field named <strong>_when</strong>, which 
specifies the precise clock cycle at which the event should be simulated.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
</pre></td><td class="rouge-code"><pre> <span class="mi">93</span> <span class="k">class</span> <span class="nc">EventBase</span>
 <span class="mi">94</span> <span class="p">{</span>
 <span class="mi">95</span>   <span class="k">protected</span><span class="o">:</span>
 <span class="mi">96</span>     <span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">FlagsType</span><span class="p">;</span>
 <span class="mi">97</span>     <span class="k">typedef</span> <span class="o">::</span><span class="n">Flags</span><span class="o">&lt;</span><span class="n">FlagsType</span><span class="o">&gt;</span> <span class="n">Flags</span><span class="p">;</span>
 <span class="mi">98</span> 
 <span class="mi">99</span>     <span class="k">static</span> <span class="k">const</span> <span class="n">FlagsType</span> <span class="n">PublicRead</span>    <span class="o">=</span> <span class="mh">0x003f</span><span class="p">;</span> <span class="c1">// public readable flags</span>
<span class="mi">100</span>     <span class="k">static</span> <span class="k">const</span> <span class="n">FlagsType</span> <span class="n">PublicWrite</span>   <span class="o">=</span> <span class="mh">0x001d</span><span class="p">;</span> <span class="c1">// public writable flags</span>
<span class="mi">101</span>     <span class="k">static</span> <span class="k">const</span> <span class="n">FlagsType</span> <span class="n">Squashed</span>      <span class="o">=</span> <span class="mh">0x0001</span><span class="p">;</span> <span class="c1">// has been squashed</span>
<span class="mi">102</span>     <span class="k">static</span> <span class="k">const</span> <span class="n">FlagsType</span> <span class="n">Scheduled</span>     <span class="o">=</span> <span class="mh">0x0002</span><span class="p">;</span> <span class="c1">// has been scheduled</span>
<span class="mi">103</span>     <span class="k">static</span> <span class="k">const</span> <span class="n">FlagsType</span> <span class="n">Managed</span>       <span class="o">=</span> <span class="mh">0x0004</span><span class="p">;</span> <span class="c1">// Use life cycle manager</span>
<span class="mi">104</span>     <span class="k">static</span> <span class="k">const</span> <span class="n">FlagsType</span> <span class="n">AutoDelete</span>    <span class="o">=</span> <span class="n">Managed</span><span class="p">;</span> <span class="c1">// delete after dispatch</span>
<span class="mi">105</span>     <span class="cm">/**
106      * This used to be AutoSerialize. This value can't be reused
107      * without changing the checkpoint version since the flag field
108      * gets serialized.
109      */</span>
<span class="mi">110</span>     <span class="k">static</span> <span class="k">const</span> <span class="n">FlagsType</span> <span class="n">Reserved0</span>     <span class="o">=</span> <span class="mh">0x0008</span><span class="p">;</span>
<span class="mi">111</span>     <span class="k">static</span> <span class="k">const</span> <span class="n">FlagsType</span> <span class="n">IsExitEvent</span>   <span class="o">=</span> <span class="mh">0x0010</span><span class="p">;</span> <span class="c1">// special exit event</span>
<span class="mi">112</span>     <span class="k">static</span> <span class="k">const</span> <span class="n">FlagsType</span> <span class="n">IsMainQueue</span>   <span class="o">=</span> <span class="mh">0x0020</span><span class="p">;</span> <span class="c1">// on main event queue</span>
<span class="mi">113</span>     <span class="k">static</span> <span class="k">const</span> <span class="n">FlagsType</span> <span class="n">Initialized</span>   <span class="o">=</span> <span class="mh">0x7a40</span><span class="p">;</span> <span class="c1">// somewhat random bits</span>
<span class="mi">114</span>     <span class="k">static</span> <span class="k">const</span> <span class="n">FlagsType</span> <span class="n">InitMask</span>      <span class="o">=</span> <span class="mh">0xffc0</span><span class="p">;</span> <span class="c1">// mask for init bits</span>
<span class="mi">115</span> 
<span class="mi">116</span>   <span class="k">public</span><span class="o">:</span>
<span class="mi">117</span>     <span class="k">typedef</span> <span class="kt">int8_t</span> <span class="n">Priority</span><span class="p">;</span>
<span class="mi">118</span> 
<span class="mi">119</span>     <span class="c1">/// Event priorities, to provide tie-breakers for events scheduled</span>
<span class="mi">120</span>     <span class="c1">/// at the same cycle.  Most events are scheduled at the default</span>
<span class="mi">121</span>     <span class="c1">/// priority; these values are used to control events that need to</span>
<span class="mi">122</span>     <span class="c1">/// be ordered within a cycle.</span>
<span class="mi">123</span> 
<span class="mi">124</span>     <span class="c1">/// Minimum priority</span>
<span class="mi">125</span>     <span class="k">static</span> <span class="k">const</span> <span class="n">Priority</span> <span class="n">Minimum_Pri</span> <span class="o">=</span>          <span class="n">SCHAR_MIN</span><span class="p">;</span>
<span class="mi">126</span> 
<span class="mi">127</span>     <span class="c1">/// If we enable tracing on a particular cycle, do that as the</span>
<span class="mi">128</span>     <span class="c1">/// very first thing so we don't miss any of the events on</span>
<span class="mi">129</span>     <span class="c1">/// that cycle (even if we enter the debugger).</span>
<span class="mi">130</span>     <span class="k">static</span> <span class="k">const</span> <span class="n">Priority</span> <span class="n">Debug_Enable_Pri</span> <span class="o">=</span>          <span class="o">-</span><span class="mi">101</span><span class="p">;</span>
<span class="mi">131</span> 
<span class="mi">132</span>     <span class="c1">/// Breakpoints should happen before anything else (except</span>
<span class="mi">133</span>     <span class="c1">/// enabling trace output), so we don't miss any action when</span>
<span class="mi">134</span>     <span class="c1">/// debugging.</span>
<span class="mi">135</span>     <span class="k">static</span> <span class="k">const</span> <span class="n">Priority</span> <span class="n">Debug_Break_Pri</span> <span class="o">=</span>           <span class="o">-</span><span class="mi">100</span><span class="p">;</span>
<span class="mi">137</span>     <span class="c1">/// CPU switches schedule the new CPU's tick event for the</span>
<span class="mi">138</span>     <span class="c1">/// same cycle (after unscheduling the old CPU's tick event).</span>
<span class="mi">139</span>     <span class="c1">/// The switch needs to come before any tick events to make</span>
<span class="mi">140</span>     <span class="c1">/// sure we don't tick both CPUs in the same cycle.</span>
<span class="mi">141</span>     <span class="k">static</span> <span class="k">const</span> <span class="n">Priority</span> <span class="n">CPU_Switch_Pri</span> <span class="o">=</span>             <span class="o">-</span><span class="mi">31</span><span class="p">;</span>
<span class="mi">142</span> 
<span class="mi">143</span>     <span class="c1">/// For some reason "delayed" inter-cluster writebacks are</span>
<span class="mi">144</span>     <span class="c1">/// scheduled before regular writebacks (which have default</span>
<span class="mi">145</span>     <span class="c1">/// priority).  Steve?</span>
<span class="mi">146</span>     <span class="k">static</span> <span class="k">const</span> <span class="n">Priority</span> <span class="n">Delayed_Writeback_Pri</span> <span class="o">=</span>       <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="mi">147</span> 
<span class="mi">148</span>     <span class="c1">/// Default is zero for historical reasons.</span>
<span class="mi">149</span>     <span class="k">static</span> <span class="k">const</span> <span class="n">Priority</span> <span class="n">Default_Pri</span> <span class="o">=</span>                  <span class="mi">0</span><span class="p">;</span>
<span class="mi">150</span> 
<span class="mi">151</span>     <span class="c1">/// DVFS update event leads to stats dump therefore given a lower priority</span>
<span class="mi">152</span>     <span class="c1">/// to ensure all relevant states have been updated</span>
<span class="mi">153</span>     <span class="k">static</span> <span class="k">const</span> <span class="n">Priority</span> <span class="n">DVFS_Update_Pri</span> <span class="o">=</span>             <span class="mi">31</span><span class="p">;</span>
<span class="mi">154</span> 
<span class="mi">155</span>     <span class="c1">/// Serailization needs to occur before tick events also, so</span>
<span class="mi">156</span>     <span class="c1">/// that a serialize/unserialize is identical to an on-line</span>
<span class="mi">157</span>     <span class="c1">/// CPU switch.</span>
<span class="mi">158</span>     <span class="k">static</span> <span class="k">const</span> <span class="n">Priority</span> <span class="n">Serialize_Pri</span> <span class="o">=</span>               <span class="mi">32</span><span class="p">;</span>
<span class="mi">159</span> 
<span class="mi">160</span>     <span class="c1">/// CPU ticks must come after other associated CPU events</span>
<span class="mi">161</span>     <span class="c1">/// (such as writebacks).</span>
<span class="mi">162</span>     <span class="k">static</span> <span class="k">const</span> <span class="n">Priority</span> <span class="n">CPU_Tick_Pri</span> <span class="o">=</span>                <span class="mi">50</span><span class="p">;</span>
<span class="mi">163</span> 
<span class="mi">164</span>     <span class="c1">/// If we want to exit a thread in a CPU, it comes after CPU_Tick_Pri</span>
<span class="mi">165</span>     <span class="k">static</span> <span class="k">const</span> <span class="n">Priority</span> <span class="n">CPU_Exit_Pri</span> <span class="o">=</span>                <span class="mi">64</span><span class="p">;</span>
<span class="mi">166</span> 
<span class="mi">167</span>     <span class="c1">/// Statistics events (dump, reset, etc.) come after</span>
<span class="mi">168</span>     <span class="c1">/// everything else, but before exit.</span>
<span class="mi">169</span>     <span class="k">static</span> <span class="k">const</span> <span class="n">Priority</span> <span class="n">Stat_Event_Pri</span> <span class="o">=</span>              <span class="mi">90</span><span class="p">;</span>
<span class="mi">170</span> 
<span class="mi">171</span>     <span class="c1">/// Progress events come at the end.</span>
<span class="mi">172</span>     <span class="k">static</span> <span class="k">const</span> <span class="n">Priority</span> <span class="n">Progress_Event_Pri</span> <span class="o">=</span>          <span class="mi">95</span><span class="p">;</span>
<span class="mi">173</span> 
<span class="mi">174</span>     <span class="c1">/// If we want to exit on this cycle, it's the very last thing</span>
<span class="mi">175</span>     <span class="c1">/// we do.</span>
<span class="mi">176</span>     <span class="k">static</span> <span class="k">const</span> <span class="n">Priority</span> <span class="n">Sim_Exit_Pri</span> <span class="o">=</span>               <span class="mi">100</span><span class="p">;</span>
<span class="mi">177</span> 
<span class="mi">178</span>     <span class="c1">/// Maximum priority</span>
<span class="mi">179</span>     <span class="k">static</span> <span class="k">const</span> <span class="n">Priority</span> <span class="n">Maximum_Pri</span> <span class="o">=</span>          <span class="n">SCHAR_MAX</span><span class="p">;</span>
<span class="mi">180</span> <span class="p">};</span>
</pre></td></tr></tbody></table></code></div></div>

<p>The EventBase class can be utilized for setting event priorities in GEM5. 
As GEM5 comprehensively simulates each system tick, multiple events can occur 
simultaneously in the same cycle. In such cases, the order of event processing 
depends on the event type and is influencedby the priority assigned to each event.</p>

<h3 id="how-hardware-component-generates-event"><span class="me-2">How hardware component generates event?</span><a href="#how-hardware-component-generates-event" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>I explained that through the event each hardware component can communicate with
main simulation loop, especially providing the logic and time (clock cycle) 
specifying when the simulation should be processed. Then how each hardware 
component generates the event? 
Primarily, the Event class can be employed in two distinct manners. The first 
approach is creating a new class that inherits from the Event class and 
implementing the process method. This approach is particularly valuable when the
Event function needs additional arguments to run the <strong>process</strong>. However, for 
simpler functions that don’t mandate the creation of an additional class, GEM5
provides the pre-defined class, EventFunctionWrapper.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre></td><td class="rouge-code"><pre><span class="mi">819</span> <span class="k">class</span> <span class="nc">EventFunctionWrapper</span> <span class="o">:</span> <span class="k">public</span> <span class="n">Event</span>
<span class="mi">820</span> <span class="p">{</span>
<span class="mi">821</span>   <span class="k">private</span><span class="o">:</span>
<span class="mi">822</span>       <span class="n">std</span><span class="o">::</span><span class="n">function</span><span class="o">&lt;</span><span class="kt">void</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">callback</span><span class="p">;</span>
<span class="mi">823</span>       <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">_name</span><span class="p">;</span>
<span class="mi">824</span> 
<span class="mi">825</span>   <span class="k">public</span><span class="o">:</span>
<span class="mi">826</span>     <span class="n">EventFunctionWrapper</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">function</span><span class="o">&lt;</span><span class="kt">void</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">callback</span><span class="p">,</span>
<span class="mi">827</span>                          <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="o">&amp;</span><span class="n">name</span><span class="p">,</span>
<span class="mi">828</span>                          <span class="kt">bool</span> <span class="n">del</span> <span class="o">=</span> <span class="nb">false</span><span class="p">,</span>
<span class="mi">829</span>                          <span class="n">Priority</span> <span class="n">p</span> <span class="o">=</span> <span class="n">Default_Pri</span><span class="p">)</span>
<span class="mi">830</span>         <span class="o">:</span> <span class="n">Event</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="n">callback</span><span class="p">(</span><span class="n">callback</span><span class="p">),</span> <span class="n">_name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
<span class="mi">831</span>     <span class="p">{</span>
<span class="mi">832</span>         <span class="k">if</span> <span class="p">(</span><span class="n">del</span><span class="p">)</span>
<span class="mi">833</span>             <span class="n">setFlags</span><span class="p">(</span><span class="n">AutoDelete</span><span class="p">);</span>
<span class="mi">834</span>     <span class="p">}</span>
<span class="mi">835</span> 
<span class="mi">836</span>     <span class="kt">void</span> <span class="nf">process</span><span class="p">()</span> <span class="p">{</span> <span class="n">callback</span><span class="p">();</span> <span class="p">}</span>
<span class="mi">837</span> 
<span class="mi">838</span>     <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span>
<span class="mi">839</span>     <span class="n">name</span><span class="p">()</span> <span class="k">const</span>
<span class="mi">840</span>     <span class="p">{</span>
<span class="mi">841</span>         <span class="k">return</span> <span class="n">_name</span> <span class="o">+</span> <span class="s">".wrapped_function_event"</span><span class="p">;</span>
<span class="mi">842</span>     <span class="p">}</span>
<span class="mi">843</span> 
<span class="mi">844</span>     <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">description</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="s">"EventFunctionWrapped"</span><span class="p">;</span> <span class="p">}</span>
<span class="mi">845</span> <span class="p">};</span>
</pre></td></tr></tbody></table></code></div></div>
<p>As depicted above, when a callback function is passed to the constructor of the
EventFunctionWrapper, it will be executed when the event is chosen by the 
emulation loop. It’s essential to note that the process function in this class 
simply invokes the provided callback.</p>

<h3 id="how-to-schedule-generated-event"><span class="me-2">How to schedule generated event?</span><a href="#how-to-schedule-generated-event" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>We’ve seen that the generated event can be inserted to the queue through the 
schedule function of the queue. Then it would be reasonable to think that each
CPP classes simulating hardware component should have the access to the queue 
to schedule the event. However, you won’t locate a mention of the queue in the 
class; instead, you’ll discover that it simply calls the schedule() function.
Embarrassingly, there is no definition for schedule function in the class! Yes 
it is inherited from another class!</p>

<p>Similar to that all python classes representing hardware components are 
inherited from SimObject python class, all hardware component classes in CPP 
should be a child of SimObject</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">SimObject</span> <span class="o">:</span> <span class="k">public</span> <span class="n">EventManager</span><span class="p">,</span> <span class="k">public</span> <span class="n">Serializable</span><span class="p">,</span> <span class="k">public</span> <span class="n">Drainable</span><span class="p">,</span>
                  <span class="k">public</span> <span class="n">Stats</span><span class="o">::</span><span class="n">Group</span>
</pre></td></tr></tbody></table></code></div></div>

<p>However, still you won’t find the schedule member function in the SimObject 
class. Based on its declaration, we can understand that it inherits several 
other classses. Because schedule function register the Event to the EventQueue,
it should be Event related with class that manages Event, EventManager.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
</pre></td><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">EventManager</span>
<span class="p">{</span> 
  <span class="nl">protected:</span>
    <span class="cm">/** A pointer to this object's event queue */</span>
    <span class="n">EventQueue</span> <span class="o">*</span><span class="n">eventq</span><span class="p">;</span>
  
  <span class="nl">public:</span>
    <span class="n">EventManager</span><span class="p">(</span><span class="n">EventManager</span> <span class="o">&amp;</span><span class="n">em</span><span class="p">)</span> <span class="o">:</span> <span class="n">eventq</span><span class="p">(</span><span class="n">em</span><span class="p">.</span><span class="n">eventq</span><span class="p">)</span> <span class="p">{}</span>
    <span class="n">EventManager</span><span class="p">(</span><span class="n">EventManager</span> <span class="o">*</span><span class="n">em</span><span class="p">)</span> <span class="o">:</span> <span class="n">eventq</span><span class="p">(</span><span class="n">em</span><span class="o">-&gt;</span><span class="n">eventq</span><span class="p">)</span> <span class="p">{}</span>
    <span class="n">EventManager</span><span class="p">(</span><span class="n">EventQueue</span> <span class="o">*</span><span class="n">eq</span><span class="p">)</span> <span class="o">:</span> <span class="n">eventq</span><span class="p">(</span><span class="n">eq</span><span class="p">)</span> <span class="p">{}</span>
    
    <span class="n">EventQueue</span> <span class="o">*</span> 
    <span class="n">eventQueue</span><span class="p">()</span> <span class="k">const</span>
    <span class="p">{</span>   
        <span class="k">return</span> <span class="n">eventq</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="kt">void</span>
    <span class="nf">schedule</span><span class="p">(</span><span class="n">Event</span> <span class="o">&amp;</span><span class="n">event</span><span class="p">,</span> <span class="n">Tick</span> <span class="n">when</span><span class="p">)</span>
    <span class="p">{</span>   
        <span class="n">eventq</span><span class="o">-&gt;</span><span class="n">schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">event</span><span class="p">,</span> <span class="n">when</span><span class="p">);</span>
    <span class="p">}</span>
    
    <span class="kt">void</span>
    <span class="nf">deschedule</span><span class="p">(</span><span class="n">Event</span> <span class="o">&amp;</span><span class="n">event</span><span class="p">)</span>
    <span class="p">{</span>   
        <span class="n">eventq</span><span class="o">-&gt;</span><span class="n">deschedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">event</span><span class="p">);</span>
    <span class="p">}</span>
    
    <span class="kt">void</span>
    <span class="nf">reschedule</span><span class="p">(</span><span class="n">Event</span> <span class="o">&amp;</span><span class="n">event</span><span class="p">,</span> <span class="n">Tick</span> <span class="n">when</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">always</span> <span class="o">=</span> <span class="nb">false</span><span class="p">)</span>
    <span class="p">{</span>   
        <span class="n">eventq</span><span class="o">-&gt;</span><span class="n">reschedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">event</span><span class="p">,</span> <span class="n">when</span><span class="p">,</span> <span class="n">always</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="p">......</span>
    <span class="kt">void</span> <span class="nf">setCurTick</span><span class="p">(</span><span class="n">Tick</span> <span class="n">newVal</span><span class="p">)</span> <span class="p">{</span> <span class="n">eventq</span><span class="o">-&gt;</span><span class="n">setCurTick</span><span class="p">(</span><span class="n">newVal</span><span class="p">);</span> <span class="p">}</span>
<span class="p">};</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Yes! EventManager defines the schedule function, and it schedules an Event object
to the EventQueue managed by the EventManager. Wait! Because it is a wrapper 
class of EventQueue to help any classes inheriting SimObject utilize the queue
(e.g., scheduling event) it should have access to the EventQueue. When you look
at the constructor of the EventManager, it needs a pointer to EventQueue! When
the pointer is passed to the constructor, it will be set as member field eventq,
and member functions of EventManager will utilize this EventQueue.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre><span class="n">SimObject</span><span class="o">::</span><span class="n">SimObject</span><span class="p">(</span><span class="k">const</span> <span class="n">Params</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
    <span class="o">:</span> <span class="n">EventManager</span><span class="p">(</span><span class="n">getEventQueue</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">eventq_index</span><span class="p">)),</span>
      <span class="n">Stats</span><span class="o">::</span><span class="n">Group</span><span class="p">(</span><span class="nb">nullptr</span><span class="p">),</span>
      <span class="n">_params</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef DEBUG
</span>    <span class="n">doDebugBreak</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="cp">#endif
</span>    <span class="n">simObjectList</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
    <span class="n">probeManager</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ProbeManager</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>As shown in constructor of SimObject, it initializes the EventManager with 
return value from getEventQueue function, which is the EventQueue pointer.</p>

<h3 id="generating-eventqueue"><span class="me-2">Generating EventQueue</span><a href="#generating-eventqueue" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>As GEM5 can have multiple mainEventQueue, EventQueue objects should be generated 
at runtime as much as it needs. The new EventQueue generation and its retrieval 
can be handled both by the ‘getEventQueue’ function</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre><span class="n">EventQueue</span> <span class="o">*</span>
<span class="nf">getEventQueue</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">numMainEventQueues</span> <span class="o">&lt;=</span> <span class="n">index</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">numMainEventQueues</span><span class="o">++</span><span class="p">;</span>
        <span class="n">mainEventQueue</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span>
            <span class="k">new</span> <span class="n">EventQueue</span><span class="p">(</span><span class="n">csprintf</span><span class="p">(</span><span class="s">"MainEventQueue-%d"</span><span class="p">,</span> <span class="n">index</span><span class="p">)));</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">mainEventQueue</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>
<p>If existing number of mainEventQueue is smaller than the index, it generates 
new EventQueue. If not it will just return the indexed EventQueue. Okay everything
looks good except one thing. Who set the eventq_index value? You might already 
noticed that it is from Param which is used to reference automatically generated
CPP struct from the python class. Based on this, you can know that this parameter
is set by python beforehand.</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">SimObject</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="c1"># Specify metaclass.  Any class inheriting from SimObject will
</span>    <span class="c1"># get this metaclass.
</span>    <span class="nb">type</span> <span class="o">=</span> <span class="sh">'</span><span class="s">SimObject</span><span class="sh">'</span>
    <span class="n">abstract</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="n">cxx_header</span> <span class="o">=</span> <span class="sh">"</span><span class="s">sim/sim_object.hh</span><span class="sh">"</span>
    <span class="n">cxx_extra_bases</span> <span class="o">=</span> <span class="p">[</span> <span class="sh">"</span><span class="s">Drainable</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">Serializable</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">Stats::Group</span><span class="sh">"</span> <span class="p">]</span>
    <span class="n">eventq_index</span> <span class="o">=</span> <span class="n">Param</span><span class="p">.</span><span class="nc">UInt32</span><span class="p">(</span><span class="n">Parent</span><span class="p">.</span><span class="n">eventq_index</span><span class="p">,</span> <span class="sh">"</span><span class="s">Event Queue Index</span><span class="sh">"</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Root</span><span class="p">(</span><span class="n">SimObject</span><span class="p">):</span>
	<span class="p">..</span><span class="bp">...</span>
    <span class="c1"># By default, root sim object and hence all other sim objects schedule
</span>    <span class="c1"># event on the eventq with index 0.
</span>    <span class="n">eventq_index</span> <span class="o">=</span> <span class="mi">0</span>
</pre></td></tr></tbody></table></code></div></div>

<p>By default, it is set as zero and make all SimObjects utilize the first eventq
unless it is specified.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>    <span class="n">Event</span> <span class="o">*</span><span class="n">local_event</span> <span class="o">=</span> <span class="n">doSimLoop</span><span class="p">(</span><span class="n">mainEventQueue</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Also, when you look at the invocation of doSimLoop, mainEventQueue[0] is passed 
as its paramter, which makes the simulation loop and all SimObjects presenting
hardware components can communicate through the mainEventQueue[0].</p>

<h2 id="event-scheduling-in-action"><span class="me-2">Event scheduling in action</span><a href="#event-scheduling-in-action" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<p>Now all CPP classes inheriting SimObject can utilize schedule function to 
schedule any events to the queue so that GEM5 simulation loop (doSimLoop) can 
fetches the event and simulate hardware logic at designated clock cycle. Let’s 
take a look at the FullO3CPU class simulating O3 CPU pipeline as an example !</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre><span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">Impl</span><span class="p">&gt;</span>
<span class="k">class</span> <span class="nc">FullO3CPU</span> <span class="o">:</span> <span class="k">public</span> <span class="n">BaseO3CPU</span>
<span class="p">{</span> 
    <span class="p">......</span>
    <span class="n">EventFunctionWrapper</span> <span class="n">tickEvent</span><span class="p">;</span>
    <span class="p">......</span>
<span class="p">}</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">Impl</span><span class="p">&gt;</span>
<span class="n">FullO3CPU</span><span class="o">&lt;</span><span class="n">Impl</span><span class="o">&gt;::</span><span class="n">FullO3CPU</span><span class="p">(</span><span class="n">DerivO3CPUParams</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
    <span class="o">:</span> <span class="n">BaseO3CPU</span><span class="p">(</span><span class="n">params</span><span class="p">),</span>
      <span class="n">itb</span><span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">itb</span><span class="p">),</span>
      <span class="n">dtb</span><span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">dtb</span><span class="p">),</span>
      <span class="n">tickEvent</span><span class="p">([</span><span class="k">this</span><span class="p">]{</span> <span class="n">tick</span><span class="p">();</span> <span class="p">},</span> <span class="s">"FullO3CPU tick"</span><span class="p">,</span>
      <span class="p">......</span>
</pre></td></tr></tbody></table></code></div></div>

<p>The constructor of the FullO3CPU class creates an instance of the tickEvent, 
which is an EventFunctionWrapper with lambda function calling tick function. 
This implies that when the tickEvent is scheduled and retrieved from the 
EventQueue, it will execute the tick() function.</p>

<h3 id="tick-tick-tick"><span class="me-2">Tick! Tick! Tick!</span><a href="#tick-tick-tick" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
</pre></td><td class="rouge-code"><pre><span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">Impl</span><span class="p">&gt;</span>
<span class="kt">void</span>
<span class="n">FullO3CPU</span><span class="o">&lt;</span><span class="n">Impl</span><span class="o">&gt;::</span><span class="n">tick</span><span class="p">()</span>
<span class="p">{</span>   
    <span class="n">DPRINTF</span><span class="p">(</span><span class="n">O3CPU</span><span class="p">,</span> <span class="s">"</span><span class="se">\n\n</span><span class="s">FullO3CPU: Ticking main, FullO3CPU.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">switchedOut</span><span class="p">());</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">drainState</span><span class="p">()</span> <span class="o">!=</span> <span class="n">DrainState</span><span class="o">::</span><span class="n">Drained</span><span class="p">);</span>
    
    <span class="o">++</span><span class="n">numCycles</span><span class="p">;</span>
    <span class="n">updateCycleCounters</span><span class="p">(</span><span class="n">BaseCPU</span><span class="o">::</span><span class="n">CPU_STATE_ON</span><span class="p">);</span>

    
    <span class="c1">//Tick each of the stages</span>
    <span class="n">fetch</span><span class="p">.</span><span class="n">tick</span><span class="p">();</span>
    
    <span class="n">decode</span><span class="p">.</span><span class="n">tick</span><span class="p">();</span>
    
    <span class="n">rename</span><span class="p">.</span><span class="n">tick</span><span class="p">();</span>
    
    <span class="n">iew</span><span class="p">.</span><span class="n">tick</span><span class="p">();</span>
    
    <span class="n">commit</span><span class="p">.</span><span class="n">tick</span><span class="p">();</span>
    
    <span class="c1">// Now advance the time buffers</span>
    <span class="n">timeBuffer</span><span class="p">.</span><span class="n">advance</span><span class="p">();</span>
    
    <span class="n">fetchQueue</span><span class="p">.</span><span class="n">advance</span><span class="p">();</span>
    <span class="n">decodeQueue</span><span class="p">.</span><span class="n">advance</span><span class="p">();</span>
    <span class="n">renameQueue</span><span class="p">.</span><span class="n">advance</span><span class="p">();</span>
    <span class="n">iewQueue</span><span class="p">.</span><span class="n">advance</span><span class="p">();</span>
    
    <span class="n">activityRec</span><span class="p">.</span><span class="n">advance</span><span class="p">();</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">removeInstsThisCycle</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">cleanUpRemovedInsts</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tickEvent</span><span class="p">.</span><span class="n">scheduled</span><span class="p">())</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">_status</span> <span class="o">==</span> <span class="n">SwitchedOut</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">DPRINTF</span><span class="p">(</span><span class="n">O3CPU</span><span class="p">,</span> <span class="s">"Switched out!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
            <span class="c1">// increment stat</span>
            <span class="n">lastRunningCycle</span> <span class="o">=</span> <span class="n">curCycle</span><span class="p">();</span>
        <span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="o">!</span><span class="n">activityRec</span><span class="p">.</span><span class="n">active</span><span class="p">()</span> <span class="o">||</span> <span class="n">_status</span> <span class="o">==</span> <span class="n">Idle</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">DPRINTF</span><span class="p">(</span><span class="n">O3CPU</span><span class="p">,</span> <span class="s">"Idle!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
            <span class="n">lastRunningCycle</span> <span class="o">=</span> <span class="n">curCycle</span><span class="p">();</span>
            <span class="n">timesIdled</span><span class="o">++</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">schedule</span><span class="p">(</span><span class="n">tickEvent</span><span class="p">,</span> <span class="n">clockEdge</span><span class="p">(</span><span class="n">Cycles</span><span class="p">(</span><span class="mi">1</span><span class="p">)));</span>
            <span class="n">DPRINTF</span><span class="p">(</span><span class="n">O3CPU</span><span class="p">,</span> <span class="s">"Scheduling next tick!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">FullSystem</span><span class="p">)</span>
        <span class="n">updateThreadPriority</span><span class="p">();</span>

    <span class="n">tryDrain</span><span class="p">();</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>I will not cover the details of the tick function of O3 in this posting, but it 
simulate pipeline stage of O3 processor such as fetch, decode, rename, iew, and 
commit in the tick function. When the Event is fetched from the EventQueue 
in the serviceOne function, the Scheduled flag of the Event will be unset.
Since the tick function should be invoked at every clock cycle (to push the 
pipe line), another event should be rescheduled to be occurred at next clock 
cycle. Therefore, the tick function simulating the O3CPU will be invoked at 
every clock cycle and simulate the entire processor pipeline!</p>

<h3 id="initial-activation"><span class="me-2">Initial activation</span><a href="#initial-activation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>To start the CPU, initial tick event should be scheduled. I will not cover the 
details here, but if you are interested in it pleas take carefully look at the 
below functions !</p>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre><span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">Impl</span><span class="p">&gt;</span>
<span class="kt">void</span>
<span class="n">O3ThreadContext</span><span class="o">&lt;</span><span class="n">Impl</span><span class="o">&gt;::</span><span class="n">activate</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">DPRINTF</span><span class="p">(</span><span class="n">O3CPU</span><span class="p">,</span> <span class="s">"Calling activate on Thread Context %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
            <span class="n">threadId</span><span class="p">());</span>

    <span class="k">if</span> <span class="p">(</span><span class="kr">thread</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">()</span> <span class="o">==</span> <span class="n">ThreadContext</span><span class="o">::</span><span class="n">Active</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span>

    <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">lastActivate</span> <span class="o">=</span> <span class="n">curTick</span><span class="p">();</span>
    <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">setStatus</span><span class="p">(</span><span class="n">ThreadContext</span><span class="o">::</span><span class="n">Active</span><span class="p">);</span>

    <span class="c1">// status() == Suspended</span>
    <span class="n">cpu</span><span class="o">-&gt;</span><span class="n">activateContext</span><span class="p">(</span><span class="kr">thread</span><span class="o">-&gt;</span><span class="n">threadId</span><span class="p">());</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="rouge-code"><pre><span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">Impl</span><span class="p">&gt;</span>
<span class="kt">void</span>
<span class="n">FullO3CPU</span><span class="o">&lt;</span><span class="n">Impl</span><span class="o">&gt;::</span><span class="n">activateContext</span><span class="p">(</span><span class="n">ThreadID</span> <span class="n">tid</span><span class="p">)</span> 
<span class="p">{</span>
    <span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">switchedOut</span><span class="p">());</span>

    <span class="c1">// Needs to set each stage to running as well.</span>
    <span class="n">activateThread</span><span class="p">(</span><span class="n">tid</span><span class="p">);</span>

    <span class="c1">// We don't want to wake the CPU if it is drained. In that case,</span>
    <span class="c1">// we just want to flag the thread as active and schedule the tick</span>
    <span class="c1">// event from drainResume() instead.</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">drainState</span><span class="p">()</span> <span class="o">==</span> <span class="n">DrainState</span><span class="o">::</span><span class="n">Drained</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span>

    <span class="c1">// If we are time 0 or if the last activation time is in the past,</span>
    <span class="c1">// schedule the next tick and wake up the fetch unit</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">lastActivatedCycle</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">lastActivatedCycle</span> <span class="o">&lt;</span> <span class="n">curTick</span><span class="p">())</span> <span class="p">{</span>
        <span class="n">scheduleTickEvent</span><span class="p">(</span><span class="n">Cycles</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
    <span class="p">......</span>
</pre></td></tr></tbody></table></code></div></div>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">Impl</span><span class="p">&gt;</span>
<span class="k">class</span> <span class="nc">FullO3CPU</span> <span class="o">:</span> <span class="k">public</span> <span class="n">BaseO3CPU</span>
<span class="p">{</span> 
    <span class="p">......</span>
    <span class="kt">void</span> <span class="n">scheduleTickEvent</span><span class="p">(</span><span class="n">Cycles</span> <span class="n">delay</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">tickEvent</span><span class="p">.</span><span class="n">squashed</span><span class="p">())</span>
            <span class="n">reschedule</span><span class="p">(</span><span class="n">tickEvent</span><span class="p">,</span> <span class="n">clockEdge</span><span class="p">(</span><span class="n">delay</span><span class="p">));</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tickEvent</span><span class="p">.</span><span class="n">scheduled</span><span class="p">())</span>
            <span class="n">schedule</span><span class="p">(</span><span class="n">tickEvent</span><span class="p">,</span> <span class="n">clockEdge</span><span class="p">(</span><span class="n">delay</span><span class="p">));</span>
    <span class="p">}</span>

</pre></td></tr></tbody></table></code></div></div>

  </div>

  <div class="post-tail-wrapper text-muted">
    <!-- categories -->
    
      <div class="post-meta mb-3">
        <i class="far fa-folder-open fa-fw me-1"></i>
        
          <a href="/categories/gem5/">GEM5</a>
      </div>
    

    <!-- tags -->
    

    <div
      class="
        post-tail-bottom
        d-flex justify-content-between align-items-center mt-5 pb-2
      "
    >
      <div class="license-wrapper">
        
          

          This post is licensed under 
        <a href="https://creativecommons.org/licenses/by/4.0/">
          CC BY 4.0
        </a>
         by the author.
        
      </div>

      <!-- Post sharing snippet -->

<div class="share-wrapper d-flex align-items-center">
  <span class="share-label text-muted">Share</span>
  <span class="share-icons">
    
    
    

    

      

      <a
        href="https://twitter.com/intent/tweet?text=Gem5%20Event%20Loop%20-%20Ruach&url=https%3A%2F%2Fruach.github.io%2Fposts%2Fgem5-event-loop%2F"
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Twitter"
        target="_blank"
        rel="noopener"
        aria-label="Twitter"
      >
        <i class="fa-fw fa-brands fa-square-x-twitter"></i>
      </a>
    

      

      <a
        href="https://www.facebook.com/sharer/sharer.php?title=Gem5%20Event%20Loop%20-%20Ruach&u=https%3A%2F%2Fruach.github.io%2Fposts%2Fgem5-event-loop%2F"
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Facebook"
        target="_blank"
        rel="noopener"
        aria-label="Facebook"
      >
        <i class="fa-fw fab fa-facebook-square"></i>
      </a>
    

      

      <a
        href="https://t.me/share/url?url=https%3A%2F%2Fruach.github.io%2Fposts%2Fgem5-event-loop%2F&text=Gem5%20Event%20Loop%20-%20Ruach"
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Telegram"
        target="_blank"
        rel="noopener"
        aria-label="Telegram"
      >
        <i class="fa-fw fab fa-telegram"></i>
      </a>
    

      

      <a
        href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fruach.github.io%2Fposts%2Fgem5-event-loop%2F"
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Linkedin"
        target="_blank"
        rel="noopener"
        aria-label="Linkedin"
      >
        <i class="fa-fw fab fa-linkedin"></i>
      </a>
    

    <button
      id="copy-link"
      aria-label="Copy link"
      class="btn small"
      data-bs-toggle="tooltip"
      data-bs-placement="top"
      title="Copy link"
      data-title-succeed="Link copied successfully!"
    >
      <i class="fa-fw fas fa-link pe-none fs-6"></i>
    </button>
  </span>
</div>

    </div>
    <!-- .post-tail-bottom -->
  </div>
  <!-- div.post-tail-wrapper -->
</article>


            
          </main>

          <!-- panel -->
          <aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 mb-5 text-muted">
            <div class="access">
              <!-- Get the last 5 posts from lastmod list. -->















              <!-- The trending tags list -->


















            </div>

            
              
              



  <section id="toc-wrapper" class="ps-0 pe-4">
    <h2 class="panel-heading ps-3 pt-2 mb-2">Contents</h2>
    <nav id="toc"></nav>
  </section>


            
          </aside>
        </div>

        <div class="row">
          <!-- tail -->
          <div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4">
            
              
              <!-- Recommend the other 3 posts according to the tags and categories of the current post. -->

<!-- The total size of related posts -->


<!-- An random integer that bigger than 0 -->


<!-- Equals to TAG_SCORE / {max_categories_hierarchy} -->














  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  
    










  <aside id="related-posts" aria-labelledby="related-label">
    <h3 class="mb-4" id="related-label">Further Reading</h3>
    <nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4">
      
        <article class="col">
          <a href="/posts/gem5-macroop-to-microop/" class="post-preview card h-100">
            <div class="card-body">
              <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1590984000"
  data-df="ll"
  
>
  Jun  1, 2020
</time>

              <h4 class="pt-0 my-2">Gem5 Macroop To Microop</h4>
              <div class="text-muted">
                <p>
                  





                  Macroop and Microop in Computer Architecture


  Macroop (Macro-operation):
    
      A macroop is a high-level instruction or operation that is part of the
instruction set architecture (ISA) of a...
                </p>
              </div>
            </div>
          </a>
        </article>
      
        <article class="col">
          <a href="/posts/O3-CPU-GEM5/" class="post-preview card h-100">
            <div class="card-body">
              <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1622001600"
  data-df="ll"
  
>
  May 26, 2021
</time>

              <h4 class="pt-0 my-2">O3 Cpu Gem5</h4>
              <div class="text-muted">
                <p>
                  





                  Python derives O3CPU through DerivO3CPU class
To understand particular processor in the GEM5, 
it is easy to start from the script that instantiate the processor. 
We can easily find that lots of G...
                </p>
              </div>
            </div>
          </a>
        </article>
      
        <article class="col">
          <a href="/posts/O3-CPU-Fetch/" class="post-preview card h-100">
            <div class="card-body">
              <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1622088000"
  data-df="ll"
  
>
  May 27, 2021
</time>

              <h4 class="pt-0 my-2">O3 Cpu Fetch</h4>
              <div class="text-muted">
                <p>
                  





                  Fetch
1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67...
                </p>
              </div>
            </div>
          </a>
        </article>
      
    </nav>
  </aside>
  <!-- #related-posts -->


            
              
              <!-- Navigation buttons at the bottom of the post. -->

<nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation">
  
  

  
    <a
      href="/posts/gem5-simobject/"
      class="btn btn-outline-primary"
      aria-label="Older"
    >
      <p>GEM5, from entry point to simulation loop</p>
    </a>
  

  
    <a
      href="/posts/gem5-macroop-to-microop/"
      class="btn btn-outline-primary"
      aria-label="Newer"
    >
      <p>Gem5 Macroop To Microop</p>
    </a>
  
</nav>

            
              
              <!--  The comments switcher -->

  
  <!-- The Disqus lazy loading. -->

<div id="disqus_thread">
  <p class="text-center text-muted small">Comments powered by <a href="https://disqus.com/">Disqus</a>.</p>
</div>

<script type="text/javascript">
  var disqus_config = function () {
    this.page.url = 'https://ruach.github.io/posts/gem5-event-loop/';
    this.page.identifier = '/posts/gem5-event-loop/';
  };

  /* Lazy loading */
  var disqus_observer = new IntersectionObserver(
    function (entries) {
      if (entries[0].isIntersecting) {
        (function () {
          var d = document,
            s = d.createElement('script');
          s.src = 'https://ruach.disqus.com/embed.js';
          s.setAttribute('data-timestamp', +new Date());
          (d.head || d.body).appendChild(s);
        })();

        disqus_observer.disconnect();
      }
    },
    { threshold: [0] }
  );

  disqus_observer.observe(document.querySelector('#disqus_thread'));

  /* Auto switch theme */
  function reloadDisqus() {
    if (event.source === window && event.data && event.data.direction === ModeToggle.ID) {
      /* Disqus hasn't been loaded */
      if (typeof DISQUS === 'undefined') {
        return;
      }

      if (document.readyState == 'complete') {
        DISQUS.reset({ reload: true, config: disqus_config });
      }
    }
  }

  if (document.querySelector('.mode-toggle')) {
    window.addEventListener('message', reloadDisqus);
  }
</script>



            

            <!-- The Footer -->

<footer
  aria-label="Site Info"
  class="
    d-flex flex-column justify-content-center text-muted
    flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3
  "
>
  <p>
    ©
    <time>2024</time>
    <a href="https://ruach.github.io">Jaehyuk Lee</a>.
    
      <span
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author."
      >Some rights reserved.</span>
    
  </p>

  <p>Using the <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme for <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>
  </p>
</footer>

          </div>
        </div>

        <!-- The Search results -->

<div id="search-result-wrapper" class="d-flex justify-content-center unloaded">
  <div class="col-11 content">
    <div id="search-hints">
      <!-- The trending tags list -->


















    </div>
    <div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div>
  </div>
</div>

      </div>

      <aside aria-label="Scroll to Top">
        <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow">
          <i class="fas fa-angle-up"></i>
        </button>
      </aside>
    </div>

    <div id="mask"></div>

    
      <aside
  id="notification"
  class="toast"
  role="alert"
  aria-live="assertive"
  aria-atomic="true"
  data-bs-animation="true"
  data-bs-autohide="false"
>
  <div class="toast-header">
    <button
      type="button"
      class="btn-close ms-auto"
      data-bs-dismiss="toast"
      aria-label="Close"
    ></button>
  </div>
  <div class="toast-body text-center pt-0">
    <p class="px-2 mb-3">A new version of content is available.</p>
    <button type="button" class="btn btn-primary" aria-label="Update">
      Update
    </button>
  </div>
</aside>

    

    <!-- JavaScripts -->

    <!-- JS selector for site. -->

<!-- commons -->



<!-- layout specified -->


  

  
    <!-- image lazy-loading & popup & clipboard -->
    
  















  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  



  <script src="https://cdn.jsdelivr.net/combine/npm/jquery@3.7.1/dist/jquery.min.js,npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js,npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/magnific-popup@1.1.0/dist/jquery.magnific-popup.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.10/dayjs.min.js,npm/dayjs@1.11.10/locale/en.min.js,npm/dayjs@1.11.10/plugin/relativeTime.min.js,npm/dayjs@1.11.10/plugin/localizedFormat.min.js,npm/tocbot@4.21.2/dist/tocbot.min.js"></script>






<script defer src="/assets/js/dist/post.min.js"></script>






    

    <!--
  Jekyll Simple Search loader
  See: <https://github.com/christian-fei/Simple-Jekyll-Search>
-->





<script>
  /* Note: dependent library will be loaded in `js-selector.html` */
  SimpleJekyllSearch({
    searchInput: document.getElementById('search-input'),
    resultsContainer: document.getElementById('search-results'),
    json: '/assets/js/data/search.json',
    searchResultTemplate: '  <article class="px-1 px-sm-2 px-lg-4 px-xl-0">    <header>      <h2><a href="{url}">{title}</a></h2>      <div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1">        {categories}        {tags}      </div>    </header>    <p>{snippet}</p>  </article>',
    noResultsText: '<p class="mt-5"></p>',
    templateMiddleware: function(prop, value, template) {
      if (prop === 'categories') {
        if (value === '') {
          return `${value}`;
        } else {
          return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`;
        }
      }

      if (prop === 'tags') {
        if (value === '') {
          return `${value}`;
        } else {
          return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`;
        }
      }
    }
  });
</script>

  </body>
</html>

