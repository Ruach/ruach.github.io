<!doctype html>














<!-- `site.alt_lang` can specify a language different from the UI -->
<html lang="en" data-mode="light">
  <!-- The Head -->

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta
    name="viewport"
    content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover"
  >

  

  

  
    <!-- Begin Jekyll SEO tag v2.8.0 -->
<meta name="generator" content="Jekyll v4.3.2" />
<meta property="og:title" content="Gem5 Macroop To Microop" />
<meta property="og:locale" content="en" />
<meta name="description" content="Macroop and Microop in Computer Architecture" />
<meta property="og:description" content="Macroop and Microop in Computer Architecture" />
<link rel="canonical" href="https://ruach.github.io/posts/gem5-macroop-to-microop/" />
<meta property="og:url" content="https://ruach.github.io/posts/gem5-macroop-to-microop/" />
<meta property="og:site_name" content="Ruach" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-06-01T00:00:00-04:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Gem5 Macroop To Microop" />
<meta name="twitter:site" content="@ruach_lee" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2020-06-01T00:00:00-04:00","datePublished":"2020-06-01T00:00:00-04:00","description":"Macroop and Microop in Computer Architecture","headline":"Gem5 Macroop To Microop","mainEntityOfPage":{"@type":"WebPage","@id":"https://ruach.github.io/posts/gem5-macroop-to-microop/"},"url":"https://ruach.github.io/posts/gem5-macroop-to-microop/"}</script>
<!-- End Jekyll SEO tag -->

  

  <title>Gem5 Macroop To Microop | Ruach
  </title>

  <!--
  The Favicons for Web, Android, Microsoft, and iOS (iPhone and iPad) Apps
  Generated by: https://realfavicongenerator.net/
-->



<link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png">
<link rel="manifest" href="/assets/img/favicons/site.webmanifest">
<link rel="shortcut icon" href="/assets/img/favicons/favicon.ico">
<meta name="apple-mobile-web-app-title" content="Ruach">
<meta name="application-name" content="Ruach">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml">
<meta name="theme-color" content="#ffffff">


  
    
      <link rel="preconnect" href="https://fonts.googleapis.com" >
      <link rel="dns-prefetch" href="https://fonts.googleapis.com" >
    
      <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      <link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin>
    
      <link rel="preconnect" href="https://fonts.googleapis.com" >
      <link rel="dns-prefetch" href="https://fonts.googleapis.com" >
    
      <link rel="preconnect" href="https://cdn.jsdelivr.net" >
      <link rel="dns-prefetch" href="https://cdn.jsdelivr.net" >
    

    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap">
  

  <!-- GA -->
  

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.2/css/all.min.css">

  <link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css">

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.21.2/dist/tocbot.min.css">
  

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css">
  

  
    <!-- Manific Popup -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css">
  

  <!-- JavaScript -->

  

  <!-- A placeholder to allow defining custom metadata -->

</head>


  <body>
    <!-- The Side Bar -->

<aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end">
  <header class="profile-wrapper">
    <a href="/" id="avatar" class="rounded-circle">
      
        
        <img src="/assets/img/jaehyuk.png" width="112" height="112" alt="avatar" onerror="this.style.display='none'">
      
    </a>

    <h1 class="site-title">
      <a href="/">Ruach</a>
    </h1>
    <p class="site-subtitle fst-italic mb-0">Jaehyuk Lee</p>
  </header>
  <!-- .profile-wrapper -->

  <nav class="flex-column flex-grow-1 w-100 ps-0">
    <ul class="nav">
      <!-- home -->
      <li class="nav-item">
        <a href="/" class="nav-link">
          <i class="fa-fw fas fa-home"></i>
          <span>HOME</span>
        </a>
      </li>
      <!-- the real tabs -->
      
        <li class="nav-item">
          <a href="/categories/" class="nav-link">
            <i class="fa-fw fas fa-stream"></i>
            

            <span>CATEGORIES</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/tags/" class="nav-link">
            <i class="fa-fw fas fa-tags"></i>
            

            <span>TAGS</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/archives/" class="nav-link">
            <i class="fa-fw fas fa-archive"></i>
            

            <span>ARCHIVES</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/about/" class="nav-link">
            <i class="fa-fw fas fa-info-circle"></i>
            

            <span>ABOUT</span>
          </a>
        </li>
        <!-- .nav-item -->
      
    </ul>
  </nav>

  <div class="sidebar-bottom d-flex flex-wrap  align-items-center w-100">
    

    
      

      
        <a
          href="javascript:location.href = 'mailto:' + ['jaehyuk','gatech.edu'].join('@')"
          aria-label="email"
          

          

          

          
        >
          <i class="fas fa-envelope"></i>
        </a>
      
    
      

      
        <a
          href="https://www.linkedin.com/in/jaehyuk-lee-29b33b121/"
          aria-label="linkedin"
          

          
            target="_blank"
            
          

          

          
            rel="noopener noreferrer"
          
        >
          <i class="fab fa-linkedin"></i>
        </a>
      
    
      

      
        <a
          href="https://github.com/Ruach"
          aria-label="github"
          

          
            target="_blank"
            
          

          

          
            rel="noopener noreferrer"
          
        >
          <i class="fab fa-github"></i>
        </a>
      
    
      

      
        <a
          href="https://stackoverflow.com/users/4460514/ruach?tab=profile"
          aria-label="stack-overflow"
          

          
            target="_blank"
            
          

          

          
            rel="noopener noreferrer"
          
        >
          <i class="fab fa-stack-overflow"></i>
        </a>
      
    
  </div>
  <!-- .sidebar-bottom -->
</aside>
<!-- #sidebar -->


    <div id="main-wrapper" class="d-flex justify-content-center">
      <div class="container d-flex flex-column px-xxl-5">
        <!-- The Top Bar -->

<header id="topbar-wrapper" aria-label="Top Bar">
  <div
    id="topbar"
    class="d-flex align-items-center justify-content-between px-lg-3 h-100"
  >
    <nav id="breadcrumb" aria-label="Breadcrumb">
      

      
        
          
            <span>
              <a href="/">
                Home
              </a>
            </span>

          
        
          
        
          
            
              <span>Gem5 Macroop To Microop</span>
            

          
        
      
    </nav>
    <!-- endof #breadcrumb -->

    <button type="button" id="sidebar-trigger" class="btn btn-link">
      <i class="fas fa-bars fa-fw"></i>
    </button>

    <div id="topbar-title">
      Post
    </div>

    <button type="button" id="search-trigger" class="btn btn-link">
      <i class="fas fa-search fa-fw"></i>
    </button>

    <search class="align-items-center ms-3 ms-lg-0">
      <i class="fas fa-search fa-fw"></i>
      <input
        class="form-control"
        id="search-input"
        type="search"
        aria-label="search"
        autocomplete="off"
        placeholder="Search..."
      >
    </search>
    <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button>
  </div>
</header>


        <div class="row flex-grow-1">
          <main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4">
            
              <!-- Refactor the HTML structure -->



<!--
  In order to allow a wide table to scroll horizontally,
  we suround the markdown table with `<div class="table-wrapper">` and `</div>`
-->



<!--
  Fixed kramdown code highlight rendering:
  https://github.com/penibelst/jekyll-compress-html/issues/101
  https://github.com/penibelst/jekyll-compress-html/issues/71#issuecomment-188144901
-->



<!-- Change the icon of checkbox -->



<!-- Handle images -->





<!-- Add header for code snippets -->



<!-- Create heading anchors -->





  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    

    
  

  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    

    
  

  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    

    
  

  
  

  




<!-- return -->




<article class="px-1">
  <header>
    <h1 data-toc-skip>Gem5 Macroop To Microop</h1>

    <div class="post-meta text-muted">
      <!-- published date -->
      <span>
        Posted
        <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1590984000"
  data-df="ll"
  
    data-bs-toggle="tooltip" data-bs-placement="bottom"
  
>
  Jun  1, 2020
</time>

      </span>

      <!-- lastmod date -->
      

      

      <div class="d-flex justify-content-between">
        <!-- author(s) -->
        <span>
          

          By

          <em>
            
              <a href="https://ruach.github.io">Jaehyuk Lee</a>
            
          </em>
        </span>

        <!-- read time -->
        <!-- Calculate the post's reading time, and display the word count in tooltip -->



<!-- words per minute -->










<!-- return element -->
<span
  class="readtime"
  data-bs-toggle="tooltip"
  data-bs-placement="bottom"
  title="8321 words"
>
  <em>46 min</em> read</span>

      </div>
      <!-- .d-flex -->
    </div>
    <!-- .post-meta -->
  </header>

  <div class="content">
    <h2 id="macroop-and-microop-in-computer-architecture"><span class="me-2">Macroop and Microop in Computer Architecture</span><a href="#macroop-and-microop-in-computer-architecture" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<ol>
  <li><strong>Macroop (Macro-operation):</strong>
    <ul>
      <li>A macroop is a high-level instruction or operation that is part of the
instruction set architecture (ISA) of a processor. It represents a single
operation that a program wants to perform, such as adding two numbers or
loading a value from memory.</li>
      <li>Macroops are what programmers typically interact with when writing code, as 
they correspond to the instructions in the assembly language or machine
code.</li>
    </ul>
  </li>
  <li><strong>Microop (Micro-operation or μop):</strong>
    <ul>
      <li>A microop is a low-level operation that a processor’s control unit
decomposes a macroop into during the execution phase. It is a fundamental 
operation that the processor can execute directly.</li>
      <li>Processors often use micro-operations internally to break down complex
macroops into simpler, more manageable tasks. These tasks are then executed 
in the processor’s pipeline.</li>
    </ul>
  </li>
</ol>

<p>In summary, the execution of a program involves the translation of macroops
(high-level instructions in the ISA) into a sequence of microops (low-level
operations) that the processor can execute efficiently. This translation allows 
for more parallel and optimized execution within the processor’s pipeline.</p>

<h3 id="mov-macroop-implementation-in-gem5"><span class="me-2">Mov macroop implementation in GEM5</span><a href="#mov-macroop-implementation-in-gem5" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>As an illustration of defining each macroop based on microops, let’s see the
how Mov instruction in the X86 architecture can be implemented with microops.</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre><span class="c1"># gem5/src/arch/x86/isa/insts/general_purpose/data_transfer/move.py
</span>
<span class="n">microcode</span> <span class="o">=</span> <span class="sh">'''</span><span class="s">

#
# Regular moves
#

def macroop MOV_R_MI {
    limm t1, imm, dataSize=asz
    ld reg, seg, [1, t0, t1]
};

def macroop MOV_MI_R {
    limm t1, imm, dataSize=asz
    st reg, seg, [1, t0, t1]
};
</span></pre></td></tr></tbody></table></code></div></div>

<p>As depicted in the provided code, every macrooperation (macroop) is composed of
several microoperations (microops). Consequently, the processor transforms the 
macroop into a series of microops and proceeds to execute these microops rather
than the original macroop. You may wonder about the process by which these
macroop definitions are parsed and interpreted as the microoperations, allowing 
the processor to execute them within the pipeline. I will give you the details 
in this posting!</p>

<h2 id="gem5-domain-specific-language-dsl-and-python-lex-yacc-ply"><span class="me-2">GEM5 Domain Specific Language (DSL) and Python-Lex-Yacc (PLY)</span><a href="#gem5-domain-specific-language-dsl-and-python-lex-yacc-ply" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<p>You may notice a resemblance between the code that defines the macroop semantics 
and Python syntax; nevertheless, it’s crucial to clarify that the code is not 
written in Python. GEM5 utilizes Domain-Specific Languages (DSL) to implement 
ISA including macroops and microops. As it is not a Python, it can be directly
interpreted as it is, and PLY generates lexer and parser to interpret the ISA
defined with GEM5. Therefore,  it is highly recommended to read 
<a href="https://www.dabeaz.com/ply/ply.html">this tutorial about PLY</a> before continuing reading this posting.</p>

<p>Based on the predefined rules, GEM5 converts the macroops and microops
implemented in the predefined DSL into corresponding python classes. As similar
to how GEM5 generates CPP implementations for Params required for instantiating
the hardware module in CPP, the goal of the parsing ISA is generating CPP 
implementations that can be utilized during simulation, for example to decode 
instruction and execute them in the processor pipeline.</p>

<h3 id="parsing-instruction-set-architecture-isa"><span class="me-2">Parsing Instruction Set Architecture (ISA)</span><a href="#parsing-instruction-set-architecture-isa" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>Since GEM5 utilize SCons, it generates Actions and Builders to process input 
and generate output files as a result. Since the expected result of the parsing
ISA of the target architecture is CPP implementations of the target ISA, the 
SConscript initiates the parsing before compiling the CPP code base. Let’s see
how the SConscript initiates the parsing.</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
</pre></td><td class="rouge-code"><pre><span class="c1">#gem5/src/arch/SConscript
</span><span class="n">parser_py</span> <span class="o">=</span> <span class="nc">File</span><span class="p">(</span><span class="sh">'</span><span class="s">isa_parser.py</span><span class="sh">'</span><span class="p">)</span>
<span class="n">micro_asm_py</span> <span class="o">=</span> <span class="nc">File</span><span class="p">(</span><span class="sh">'</span><span class="s">micro_asm.py</span><span class="sh">'</span><span class="p">)</span>

<span class="kn">import</span> <span class="n">ply</span>

<span class="k">def</span> <span class="nf">run_parser</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">env</span><span class="p">):</span>
    <span class="c1"># Add the current directory to the system path so we can import files.
</span>    <span class="n">sys</span><span class="p">.</span><span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span> <span class="n">parser_py</span><span class="p">.</span><span class="nb">dir</span><span class="p">.</span><span class="n">abspath</span> <span class="p">]</span>
    <span class="kn">import</span> <span class="n">isa_parser</span>

    <span class="n">parser</span> <span class="o">=</span> <span class="n">isa_parser</span><span class="p">.</span><span class="nc">ISAParser</span><span class="p">(</span><span class="n">target</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nb">dir</span><span class="p">.</span><span class="n">abspath</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">parse_isa_desc</span><span class="p">(</span><span class="n">source</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">abspath</span><span class="p">)</span>

<span class="n">desc_action</span> <span class="o">=</span> <span class="nc">MakeAction</span><span class="p">(</span><span class="n">run_parser</span><span class="p">,</span> <span class="nc">Transform</span><span class="p">(</span><span class="sh">"</span><span class="s">ISA DESC</span><span class="sh">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

<span class="n">IsaDescBuilder</span> <span class="o">=</span> <span class="nc">Builder</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="n">desc_action</span><span class="p">)</span>

<span class="p">...</span><span class="bp">...</span>

<span class="k">def</span> <span class="nf">ISADesc</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">decoder_splits</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">exec_splits</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">generated_dir</span> <span class="o">=</span> <span class="nc">File</span><span class="p">(</span><span class="n">desc</span><span class="p">).</span><span class="nb">dir</span><span class="p">.</span><span class="nf">up</span><span class="p">().</span><span class="nc">Dir</span><span class="p">(</span><span class="sh">'</span><span class="s">generated</span><span class="sh">'</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">gen_file</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">generated_dir</span><span class="p">.</span><span class="nc">File</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="n">gen</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">def</span> <span class="nf">add_gen</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
        <span class="n">gen</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">gen_file</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>

    <span class="c1"># Tell scons about the various files the ISA parser will generate.
</span>    <span class="nf">add_gen</span><span class="p">(</span><span class="sh">'</span><span class="s">decoder-g.cc.inc</span><span class="sh">'</span><span class="p">)</span>
    <span class="nf">add_gen</span><span class="p">(</span><span class="sh">'</span><span class="s">decoder-ns.cc.inc</span><span class="sh">'</span><span class="p">)</span>
    <span class="nf">add_gen</span><span class="p">(</span><span class="sh">'</span><span class="s">decode-method.cc.inc</span><span class="sh">'</span><span class="p">)</span>

    <span class="nf">add_gen</span><span class="p">(</span><span class="sh">'</span><span class="s">decoder.hh</span><span class="sh">'</span><span class="p">)</span>
    <span class="nf">add_gen</span><span class="p">(</span><span class="sh">'</span><span class="s">decoder-g.hh.inc</span><span class="sh">'</span><span class="p">)</span>
    <span class="nf">add_gen</span><span class="p">(</span><span class="sh">'</span><span class="s">decoder-ns.hh.inc</span><span class="sh">'</span><span class="p">)</span>

    <span class="nf">add_gen</span><span class="p">(</span><span class="sh">'</span><span class="s">exec-g.cc.inc</span><span class="sh">'</span><span class="p">)</span>
    <span class="nf">add_gen</span><span class="p">(</span><span class="sh">'</span><span class="s">exec-ns.cc.inc</span><span class="sh">'</span><span class="p">)</span>

    <span class="nf">add_gen</span><span class="p">(</span><span class="sh">'</span><span class="s">max_inst_regs.hh</span><span class="sh">'</span><span class="p">)</span>


    <span class="c1"># These generated files are also top level sources.
</span>    <span class="k">def</span> <span class="nf">source_gen</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
        <span class="nf">add_gen</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="nc">Source</span><span class="p">(</span><span class="nf">gen_file</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>

    <span class="nf">source_gen</span><span class="p">(</span><span class="sh">'</span><span class="s">decoder.cc</span><span class="sh">'</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">decoder_splits</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="nf">source_gen</span><span class="p">(</span><span class="sh">'</span><span class="s">inst-constrs.cc</span><span class="sh">'</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">decoder_splits</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="nf">source_gen</span><span class="p">(</span><span class="sh">'</span><span class="s">inst-constrs-%d.cc</span><span class="sh">'</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">exec_splits</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="nf">source_gen</span><span class="p">(</span><span class="sh">'</span><span class="s">generic_cpu_exec.cc</span><span class="sh">'</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">exec_splits</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="nf">source_gen</span><span class="p">(</span><span class="sh">'</span><span class="s">generic_cpu_exec_%d.cc</span><span class="sh">'</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>

    <span class="c1"># Actually create the builder.
</span>    <span class="n">sources</span> <span class="o">=</span> <span class="p">[</span><span class="n">desc</span><span class="p">,</span> <span class="n">parser_py</span><span class="p">,</span> <span class="n">micro_asm_py</span><span class="p">]</span>
    <span class="nc">IsaDescBuilder</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">gen</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">sources</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">gen</span>
</pre></td></tr></tbody></table></code></div></div>

<p><strong>run_parser</strong> function is responsible for initiating the parsing for the target 
architecture. It is invoked when the IsaDescBuilder is called. The ISADescBuilder 
is created through the ISADesc function. In the context of a specific architecture,
the developer’s responsibility is simply to call the ISADesc method in the local 
SConscript defined within the target architecture directory. The SConscript for
each architecture supplies details about the input ISA files that should be 
parsed. This information, in the form of a “desc” string, is then utilized by 
passing it to the ISADesc function.</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="c1">#gem5/src/arch/x86/SConscript
</span>
    <span class="c1"># Add in files generated by the ISA description.
</span>    <span class="n">isa_desc_files</span> <span class="o">=</span> <span class="nc">ISADesc</span><span class="p">(</span><span class="sh">'</span><span class="s">isa/main.isa</span><span class="sh">'</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">isa_desc_files</span><span class="p">:</span>
        <span class="c1"># Add in python file dependencies that won't be caught otherwise
</span>        <span class="k">for</span> <span class="n">pyfile</span> <span class="ow">in</span> <span class="n">python_files</span><span class="p">:</span>
            <span class="n">env</span><span class="p">.</span><span class="nc">Depends</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="sh">"</span><span class="s">isa/insts/%s</span><span class="sh">"</span> <span class="o">%</span> <span class="n">pyfile</span><span class="p">)</span>

</pre></td></tr></tbody></table></code></div></div>

<p>When you look at the SConscript of the X86 architecture, you will find that it 
passes <strong>isa/main.isa</strong> file to ISADesc function. The file ending with isa files 
are usually used to define ISA of the target architecture. In this example, the 
main.isa file is utilized to include all isa files that need a parsing.</p>

<p>Additionally, observe that the <strong>isa_parser.py and micro_asm.py</strong> files are 
provided to the ISADescrBuilder. These files contain essential functions and 
classes for utilizing PLY and initializing the parsing process. As depicted in 
the run_parser function, it generates <strong>ISAParser</strong> python class object that 
actually handles ISA parsing utilizing the PLY. Note that this class is defined
in the isa_parser.py file. Also <strong>parse_isa_desc</strong> is invoked through the
ISAParser to initiate the parsing.</p>

<h4 id="isaparser-isa_parserpy"><span class="me-2">ISAParser (isa_parser.py)</span><a href="#isaparser-isa_parserpy" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4>
<p>The ISAParser class is the most important python class that has two crucial roles
in parsing ISA files. It defines necessary rules for lexer and parser such as 
regular expression for tokenziation and context free grammars for parsing. Since
GEM5 utilizes PLY, the rules should be defined following the PLY’s syntax. For 
example, context free grammar required for parsing can be defined as a python 
method that starts with <strong>p_</strong>.
Since the ISAParser and its method to parse the ISA files are utilized 
irrespective of the target architecture, it implies that all architectures 
utilize the same GEM5 DSL to define their respective ISAs. The GEM5 DSL is 
sufficiently adaptable to support the implementation of ISAs for diverse 
architectures, including x86, arm, power, mips, and sparc. As a result, there is
generally no need to introduce additional rules for parsing most of the time.</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
</pre></td><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">ISAParser</span><span class="p">(</span><span class="n">Grammar</span><span class="p">):</span>
    <span class="c1"># For Lexer
</span>    <span class="c1"># Regular expressions for token matching
</span>    <span class="n">t_LPAREN</span>           <span class="o">=</span> <span class="sa">r</span><span class="sh">'</span><span class="s">\(</span><span class="sh">'</span>
    <span class="n">t_RPAREN</span>           <span class="o">=</span> <span class="sa">r</span><span class="sh">'</span><span class="s">\)</span><span class="sh">'</span>
    <span class="n">t_LBRACKET</span>         <span class="o">=</span> <span class="sa">r</span><span class="sh">'</span><span class="s">\[</span><span class="sh">'</span>
    <span class="n">t_RBRACKET</span>         <span class="o">=</span> <span class="sa">r</span><span class="sh">'</span><span class="s">\]</span><span class="sh">'</span>
    <span class="n">t_LBRACE</span>           <span class="o">=</span> <span class="sa">r</span><span class="sh">'</span><span class="s">\{</span><span class="sh">'</span>
    <span class="n">t_RBRACE</span>           <span class="o">=</span> <span class="sa">r</span><span class="sh">'</span><span class="s">\}</span><span class="sh">'</span>
    <span class="n">t_LESS</span>             <span class="o">=</span> <span class="sa">r</span><span class="sh">'</span><span class="s">\&lt;</span><span class="sh">'</span>
    <span class="n">t_GREATER</span>          <span class="o">=</span> <span class="sa">r</span><span class="sh">'</span><span class="s">\&gt;</span><span class="sh">'</span>
    <span class="n">t_EQUALS</span>           <span class="o">=</span> <span class="sa">r</span><span class="sh">'</span><span class="s">=</span><span class="sh">'</span>
    <span class="n">t_COMMA</span>            <span class="o">=</span> <span class="sa">r</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span>
    <span class="n">t_SEMI</span>             <span class="o">=</span> <span class="sa">r</span><span class="sh">'</span><span class="s">;</span><span class="sh">'</span>
    <span class="n">t_DOT</span>              <span class="o">=</span> <span class="sa">r</span><span class="sh">'</span><span class="s">\.</span><span class="sh">'</span>
    <span class="n">t_COLON</span>            <span class="o">=</span> <span class="sa">r</span><span class="sh">'</span><span class="s">:</span><span class="sh">'</span>
    <span class="n">t_DBLCOLON</span>         <span class="o">=</span> <span class="sa">r</span><span class="sh">'</span><span class="s">::</span><span class="sh">'</span>
    <span class="n">t_ASTERISK</span>         <span class="o">=</span> <span class="sa">r</span><span class="sh">'</span><span class="s">\*</span><span class="sh">'</span>
    <span class="p">...</span><span class="bp">...</span>

    <span class="c1"># For Parser
</span>    <span class="k">def</span> <span class="nf">p_specification</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="sh">'</span><span class="s">specification : opt_defs_and_outputs top_level_decode_block</span><span class="sh">'</span>

        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">splits</span><span class="p">.</span><span class="nf">keys</span><span class="p">():</span>
            <span class="n">f</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="sh">'</span><span class="se">\n</span><span class="s">#endif</span><span class="se">\n</span><span class="sh">'</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">files</span><span class="p">.</span><span class="nf">values</span><span class="p">():</span> <span class="c1"># close ALL the files;
</span>            <span class="n">f</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span> <span class="c1"># not doing so can cause compilation to fail
</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">write_top_level_files</span><span class="p">()</span>

        <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="p">...</span><span class="bp">...</span>

</pre></td></tr></tbody></table></code></div></div>

<p>Furthermore, the ISAParser class is utilized to instantiate the lexer and parser.
However, you might wonder where is the parser and lexer instance generated from
PLY because there is no relevant attributes defined in the ISAParser class. Note
that it isinherited from Grammar class! Also, this class is closely related with
the parse_isa_desc function of the ISAParser.</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
</pre></td><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">Grammar</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">attr</span> <span class="o">==</span> <span class="sh">'</span><span class="s">lexers</span><span class="sh">'</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">lexers</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">lexers</span>
        
        <span class="k">if</span> <span class="n">attr</span> <span class="o">==</span> <span class="sh">'</span><span class="s">lex_kwargs</span><span class="sh">'</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">setupLexerFactory</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">lex_kwargs</span>
        
        <span class="k">if</span> <span class="n">attr</span> <span class="o">==</span> <span class="sh">'</span><span class="s">yacc_kwargs</span><span class="sh">'</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">setupParserFactory</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">yacc_kwargs</span>
        
        <span class="k">if</span> <span class="n">attr</span> <span class="o">==</span> <span class="sh">'</span><span class="s">lex</span><span class="sh">'</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">lex</span> <span class="o">=</span> <span class="n">ply</span><span class="p">.</span><span class="n">lex</span><span class="p">.</span><span class="nf">lex</span><span class="p">(</span><span class="n">module</span><span class="o">=</span><span class="n">self</span><span class="p">,</span> <span class="o">**</span><span class="n">self</span><span class="p">.</span><span class="n">lex_kwargs</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">lex</span>
        
        <span class="k">if</span> <span class="n">attr</span> <span class="o">==</span> <span class="sh">'</span><span class="s">yacc</span><span class="sh">'</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">yacc</span> <span class="o">=</span> <span class="n">ply</span><span class="p">.</span><span class="n">yacc</span><span class="p">.</span><span class="nf">yacc</span><span class="p">(</span><span class="n">module</span><span class="o">=</span><span class="n">self</span><span class="p">,</span> <span class="o">**</span><span class="n">self</span><span class="p">.</span><span class="n">yacc_kwargs</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">yacc</span>
        
        <span class="k">if</span> <span class="n">attr</span> <span class="o">==</span> <span class="sh">'</span><span class="s">current_lexer</span><span class="sh">'</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="n">lexers</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">None</span>
            <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">lexers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">attr</span> <span class="o">==</span> <span class="sh">'</span><span class="s">current_source</span><span class="sh">'</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="n">lexers</span><span class="p">:</span>
                <span class="k">return</span> <span class="sh">'</span><span class="s">&lt;none&gt;</span><span class="sh">'</span>
            <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">lexers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">attr</span> <span class="o">==</span> <span class="sh">'</span><span class="s">current_line</span><span class="sh">'</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="n">lexers</span><span class="p">:</span>
                <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">current_lexer</span><span class="p">.</span><span class="n">lineno</span>

    <span class="k">def</span> <span class="nf">parse_string</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="sh">'</span><span class="s">&lt;string&gt;</span><span class="sh">'</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">tracking</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">string_types</span><span class="p">):</span>
            <span class="k">raise</span> <span class="nc">AttributeError</span><span class="p">(</span>
                <span class="sh">"</span><span class="s">argument must be a string, was </span><span class="sh">'</span><span class="s">%s</span><span class="sh">'"</span> <span class="o">%</span> <span class="nf">type</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>

        <span class="n">lexer</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">lex</span><span class="p">.</span><span class="nf">clone</span><span class="p">()</span>
        <span class="n">lexer</span><span class="p">.</span><span class="nf">input</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">lexers</span><span class="p">.</span><span class="nf">append</span><span class="p">((</span><span class="n">lexer</span><span class="p">,</span> <span class="n">source</span><span class="p">))</span>

        <span class="n">lrtab</span> <span class="o">=</span> <span class="n">ply</span><span class="p">.</span><span class="n">yacc</span><span class="p">.</span><span class="nc">LRTable</span><span class="p">()</span>
        <span class="n">lrtab</span><span class="p">.</span><span class="n">lr_productions</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">yacc</span><span class="p">.</span><span class="n">productions</span>
        <span class="n">lrtab</span><span class="p">.</span><span class="n">lr_action</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">yacc</span><span class="p">.</span><span class="n">action</span>
        <span class="n">lrtab</span><span class="p">.</span><span class="n">lr_goto</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">yacc</span><span class="p">.</span><span class="n">goto</span>

        <span class="n">parser</span> <span class="o">=</span> <span class="n">ply</span><span class="p">.</span><span class="n">yacc</span><span class="p">.</span><span class="nc">LRParser</span><span class="p">(</span><span class="n">lrtab</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">yacc</span><span class="p">.</span><span class="n">errorfunc</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">parser</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">lexer</span><span class="o">=</span><span class="n">lexer</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">,</span> <span class="n">tracking</span><span class="o">=</span><span class="n">tracking</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">lexers</span><span class="p">.</span><span class="nf">pop</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">result</span>

</pre></td></tr></tbody></table></code></div></div>
<p>Actually, the Grammer class provides <strong>parse_string</strong> method that parser the 
passed ISA files utilizing PLY Lexer, Yacc, and Parser. As depicted in the code,
the parse_string accesses lex and yacc attribute of the Grammar class. As these
attributes are not statically defined in the class, it is generated at runtime
when they are accessed through the ‘<strong>getattr</strong>’ function. After generating the 
lexer and parser, parser function of the generated parser will parser the ISA
files and return the result.</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre></td><td class="rouge-code"><pre>    <span class="k">def</span> <span class="nf">_parse_isa_desc</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">isa_desc_file</span><span class="p">):</span>
        <span class="sh">'''</span><span class="s">Read in and parse the ISA description.</span><span class="sh">'''</span>
            
        <span class="k">if</span> <span class="n">isa_desc_file</span> <span class="ow">in</span> <span class="n">ISAParser</span><span class="p">.</span><span class="n">AlreadyGenerated</span><span class="p">:</span>
            <span class="k">return</span>
        
        <span class="c1"># grab the last three path components of isa_desc_file
</span>        <span class="n">self</span><span class="p">.</span><span class="n">filename</span> <span class="o">=</span> <span class="sh">'</span><span class="s">/</span><span class="sh">'</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">isa_desc_file</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">'</span><span class="s">/</span><span class="sh">'</span><span class="p">)[</span><span class="o">-</span><span class="mi">3</span><span class="p">:])</span>

        <span class="c1"># Read file and (recursively) all included files into a string.
</span>        <span class="c1"># PLY requires that the input be in a single string so we have to
</span>        <span class="c1"># do this up front.
</span>        <span class="n">isa_desc</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">read_and_flatten</span><span class="p">(</span><span class="n">isa_desc_file</span><span class="p">)</span>
        
        <span class="c1"># Initialize lineno tracker
</span>        <span class="n">self</span><span class="p">.</span><span class="n">lex</span><span class="p">.</span><span class="n">lineno</span> <span class="o">=</span> <span class="nc">LineTracker</span><span class="p">(</span><span class="n">isa_desc_file</span><span class="p">)</span>
        
        <span class="c1"># Parse.
</span>        <span class="n">self</span><span class="p">.</span><span class="nf">parse_string</span><span class="p">(</span><span class="n">isa_desc</span><span class="p">)</span>
        
        <span class="n">ISAParser</span><span class="p">.</span><span class="n">AlreadyGenerated</span><span class="p">[</span><span class="n">isa_desc_file</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
        
    <span class="k">def</span> <span class="nf">parse_isa_desc</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">_parse_isa_desc</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">ISAParserError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nf">print</span><span class="p">(</span><span class="nf">backtrace</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">fileNameStack</span><span class="p">))</span>
            <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">At %s:</span><span class="sh">"</span> <span class="o">%</span> <span class="n">e</span><span class="p">.</span><span class="n">lineno</span><span class="p">)</span>
            <span class="nf">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> 
            <span class="n">sys</span><span class="p">.</span><span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Going back to run_parser function, it invokes the parse_isa_desc function of the
Parser python class. It further invokes the parser_string function from the 
Grammar class and starts parsing ISA files!</p>

<h4 id="microassembler-micro_asmpy-"><span class="me-2">MicroAssembler (micro_asm.py) <a name="microassembler"></a></span><a href="#microassembler-micro_asmpy-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4>
<p>Although the rules defined in the ISAParser class is generally sufficient to 
define ISA of one architecture, it might not be sufficient for specific
architecture such as X86 that utilizes microops to define the macroop syntax. 
Since utilizing macroop and microop at the same time to define ISA is not common,
for example only X86 architecture utilize both, in defining ISA, GEM5 provides 
another class called <strong>MicroAssembler</strong> and appropriate rules to parse the GEM5
DSL used for defining macroops and microops.</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre><span class="c1">#gem5/src/arch/micro_asm.py
</span>
<span class="k">class</span> <span class="nc">MicroAssembler</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="err">(</span><span class="nf">self</span><span class="p">,</span> <span class="n">macro_type</span><span class="p">,</span> <span class="n">microops</span><span class="p">,</span>
        <span class="n">rom</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">rom_macroop_type</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">lexer</span> <span class="o">=</span> <span class="n">lex</span><span class="p">.</span><span class="nf">lex</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">parser</span> <span class="o">=</span> <span class="n">yacc</span><span class="p">.</span><span class="nf">yacc</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="n">macro_type</span> <span class="o">=</span> <span class="n">macro_type</span>
        <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="n">macroops</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="n">microops</span> <span class="o">=</span> <span class="n">microops</span>
        <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="n">rom</span> <span class="o">=</span> <span class="n">rom</span>
        <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="n">rom_macroop_type</span> <span class="o">=</span> <span class="n">rom_macroop_type</span>
        <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="n">symbols</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">symbols</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="n">symbols</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Similar to ISAParser class, it generates PLY lexer and parser  when the 
MicroAssembler object is instantiated. However, compared to ISAParser that only
requires the path for the output directory for the object instantiating, 
MicroAssembler class  requires additional information associated with the 
macroop and microops. I will explain the why they are necessary and how this 
information will be utilized in marcoop parsing soon</p>

<h3 id="cfg-for-isa-parsing"><span class="me-2">CFG for ISA Parsing</span><a href="#cfg-for-isa-parsing" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>Before explaining how macroop is parsed, I will go over few crucial rules that 
are necessary for parsing ISA files in most of the time. To understand how GEM5
parses ISA files, the rules defined in the ISAParser python class is crucial. It 
also defines rules for tokenization fur lexer, but will not cover the details 
about lexer in this posting.</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
</pre></td><td class="rouge-code"><pre><span class="c1">#gem5/src/arch/isa_parser.py
</span>
   <span class="k">def</span> <span class="nf">p_specification</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
       <span class="sh">'</span><span class="s">specification : opt_defs_and_outputs top_level_decode_block</span><span class="sh">'</span>

       <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">splits</span><span class="p">.</span><span class="nf">iterkeys</span><span class="p">():</span>
           <span class="n">f</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="sh">'</span><span class="se">\n</span><span class="s">#endif</span><span class="se">\n</span><span class="sh">'</span><span class="p">)</span>

       <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">files</span><span class="p">.</span><span class="nf">itervalues</span><span class="p">():</span> <span class="c1"># close ALL the files;
</span>           <span class="n">f</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span> <span class="c1"># not doing so can cause compilation to fail
</span>
       <span class="n">self</span><span class="p">.</span><span class="nf">write_top_level_files</span><span class="p">()</span>

       <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>

   <span class="c1"># 'opt_defs_and_outputs' is a possibly empty sequence of def and/or
</span>   <span class="c1"># output statements. Its productions do the hard work of eventually
</span>   <span class="c1"># instantiating a GenCode, which are generally emitted (written to disk)
</span>   <span class="c1"># as soon as possible, except for the decode_block, which has to be
</span>   <span class="c1"># accumulated into one large function of nested switch/case blocks.
</span>   <span class="k">def</span> <span class="nf">p_opt_defs_and_outputs_0</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
       <span class="sh">'</span><span class="s">opt_defs_and_outputs : empty</span><span class="sh">'</span>

   <span class="k">def</span> <span class="nf">p_opt_defs_and_outputs_1</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
       <span class="sh">'</span><span class="s">opt_defs_and_outputs : defs_and_outputs</span><span class="sh">'</span>

   <span class="k">def</span> <span class="nf">p_defs_and_outputs_0</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
       <span class="sh">'</span><span class="s">defs_and_outputs : def_or_output</span><span class="sh">'</span>

   <span class="k">def</span> <span class="nf">p_defs_and_outputs_1</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
       <span class="sh">'</span><span class="s">defs_and_outputs : defs_and_outputs def_or_output</span><span class="sh">'</span>

   <span class="c1"># The list of possible definition/output statements.
</span>   <span class="c1"># They are all processed as they are seen.
</span>   <span class="k">def</span> <span class="nf">p_def_or_output</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
       <span class="sh">'''</span><span class="s">def_or_output : name_decl
                        | def_format
                        | def_bitfield
                        | def_bitfield_struct
                        | def_template
                        | def_operand_types
                        | def_operands
                        | output
                        | global_let
                        | split</span><span class="sh">'''</span>
</pre></td></tr></tbody></table></code></div></div>

<p>The top rule is the <strong>specification</strong>. It means that content in the all isa files
can be interpreted as specification which can comprise of <em>opt_defs_and_outputs</em> 
and <em>top_level_decode_block</em>. We will mainly take a look at ‘opt_defs_and_outputs’
because it can be further parsed down into macroop and microop blocks. As depicted
in its grammar, it can be further parsed down to another defs_and_outputs and 
another def_or_output block. The <em>def_or_output_block</em> is the block that we will
specifically take a look at in detail in few sections.</p>

<h4 id="let---"><span class="me-2">let {{ … }};</span><a href="#let---" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4>
<p>The <em>def_or_output_blocks</em> can be further narrowed down into multiple different 
blocks, but the most important blocks related with defining macroops are starting 
with <strong>let</strong>.</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
</pre></td><td class="rouge-code"><pre>    <span class="k">def</span> <span class="nf">p_global_let</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="sh">'</span><span class="s">global_let : LET CODELIT SEMI</span><span class="sh">'</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">updateExportContext</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">exportContext</span><span class="p">[</span><span class="sh">"</span><span class="s">header_output</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sh">''</span>
        <span class="n">self</span><span class="p">.</span><span class="n">exportContext</span><span class="p">[</span><span class="sh">"</span><span class="s">decoder_output</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sh">''</span>
        <span class="n">self</span><span class="p">.</span><span class="n">exportContext</span><span class="p">[</span><span class="sh">"</span><span class="s">exec_output</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sh">''</span>
        <span class="n">self</span><span class="p">.</span><span class="n">exportContext</span><span class="p">[</span><span class="sh">"</span><span class="s">decode_block</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sh">''</span>
        <span class="n">self</span><span class="p">.</span><span class="n">exportContext</span><span class="p">[</span><span class="sh">"</span><span class="s">split</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">make_split</span><span class="p">()</span>
        <span class="n">split_setup</span> <span class="o">=</span> <span class="sh">'''</span><span class="s">
def wrap(func):
    def split(sec):
        globals()[sec + </span><span class="sh">'</span><span class="s">_output</span><span class="sh">'</span><span class="s">] += func(sec)
    return split
split = wrap(split)
del wrap
</span><span class="sh">'''</span>                      
        <span class="c1"># This tricky setup (immediately above) allows us to just write
</span>        <span class="c1"># (e.g.) "split('exec')" in the Python code and the split #ifdef's
</span>        <span class="c1"># will automatically be added to the exec_output variable. The inner
</span>        <span class="c1"># Python execution environment doesn't know about the split points,
</span>        <span class="c1"># so we carefully inject and wrap a closure that can retrieve the
</span>        <span class="c1"># next split's #define from the parser and add it to the current
</span>        <span class="c1"># emission-in-progress.
</span>        <span class="k">try</span><span class="p">:</span>
            <span class="nf">exec</span><span class="p">(</span><span class="n">split_setup</span><span class="o">+</span><span class="nf">fixPythonIndentation</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="n">self</span><span class="p">.</span><span class="n">exportContext</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="n">traceback</span><span class="p">.</span><span class="nf">print_exc</span><span class="p">(</span><span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="p">.</span><span class="n">stdout</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                <span class="k">raise</span>
            <span class="nf">error</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="nf">lineno</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="sh">'</span><span class="s">In global let block: %s</span><span class="sh">'</span> <span class="o">%</span> <span class="n">exc</span><span class="p">)</span>
        <span class="nc">GenCode</span><span class="p">(</span><span class="n">self</span><span class="p">,</span>
                <span class="n">header_output</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">exportContext</span><span class="p">[</span><span class="sh">"</span><span class="s">header_output</span><span class="sh">"</span><span class="p">],</span>
                <span class="n">decoder_output</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">exportContext</span><span class="p">[</span><span class="sh">"</span><span class="s">decoder_output</span><span class="sh">"</span><span class="p">],</span>
                <span class="n">exec_output</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">exportContext</span><span class="p">[</span><span class="sh">"</span><span class="s">exec_output</span><span class="sh">"</span><span class="p">],</span>
                <span class="n">decode_block</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">exportContext</span><span class="p">[</span><span class="sh">"</span><span class="s">decode_block</span><span class="sh">"</span><span class="p">]).</span><span class="nf">emit</span><span class="p">()</span>
</pre></td></tr></tbody></table></code></div></div>

<p>When the parser comes across tokens composed of the “let “ block, it 
triggers the <strong>p_global_let</strong> function. The “let” block plays two vital roles in 
parsing ISA files. Initially, it executes Python code literal to declare the 
Python-based classes necessary for parsing. Subsequently, for generating CPP 
implementations of the ISA, it calls the GenCode function.</p>

<h4 id="gencode-generating-cpp-implementation-for-isa"><span class="me-2">GenCode: Generating CPP implementation for ISA</span><a href="#gencode-generating-cpp-implementation-for-isa" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4>
<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">GenCode</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="c1"># Constructor.
</span>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">parser</span><span class="p">,</span>
                 <span class="n">header_output</span> <span class="o">=</span> <span class="sh">''</span><span class="p">,</span> <span class="n">decoder_output</span> <span class="o">=</span> <span class="sh">''</span><span class="p">,</span> <span class="n">exec_output</span> <span class="o">=</span> <span class="sh">''</span><span class="p">,</span>
                 <span class="n">decode_block</span> <span class="o">=</span> <span class="sh">''</span><span class="p">,</span> <span class="n">has_decode_default</span> <span class="o">=</span> <span class="bp">False</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">parser</span> <span class="o">=</span> <span class="n">parser</span>
        <span class="n">self</span><span class="p">.</span><span class="n">header_output</span> <span class="o">=</span> <span class="n">header_output</span>
        <span class="n">self</span><span class="p">.</span><span class="n">decoder_output</span> <span class="o">=</span> <span class="n">decoder_output</span>
        <span class="n">self</span><span class="p">.</span><span class="n">exec_output</span> <span class="o">=</span> <span class="n">exec_output</span>
        <span class="n">self</span><span class="p">.</span><span class="n">decode_block</span> <span class="o">=</span> <span class="n">decode_block</span>
        <span class="n">self</span><span class="p">.</span><span class="n">has_decode_default</span> <span class="o">=</span> <span class="n">has_decode_default</span>

    <span class="c1"># Write these code chunks out to the filesystem.  They will be properly
</span>    <span class="c1"># interwoven by the write_top_level_files().
</span>    <span class="k">def</span> <span class="nf">emit</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">header_output</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="nf">get_file</span><span class="p">(</span><span class="sh">'</span><span class="s">header</span><span class="sh">'</span><span class="p">).</span><span class="nf">write</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">header_output</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">decoder_output</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="nf">get_file</span><span class="p">(</span><span class="sh">'</span><span class="s">decoder</span><span class="sh">'</span><span class="p">).</span><span class="nf">write</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">decoder_output</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">exec_output</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="nf">get_file</span><span class="p">(</span><span class="sh">'</span><span class="s">exec</span><span class="sh">'</span><span class="p">).</span><span class="nf">write</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">exec_output</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">decode_block</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="nf">get_file</span><span class="p">(</span><span class="sh">'</span><span class="s">decode_block</span><span class="sh">'</span><span class="p">).</span><span class="nf">write</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">decode_block</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></div></div>

<p>During each iteration of the let block, <strong>header_output</strong>, <strong>decoder_output</strong>, 
<strong>exec_output</strong>, and <strong>decode_block</strong> are initially set to empty values before 
the let block is executed. The let block then fills these attributes as necessary. 
Additionally, the content stored in each attribute is generated through the 
execution of the let block, such as parsing the macroop. The GenCode class’s emit 
function write these automatically generated CPP implementations into files. 
We will see how decoder_output can be generated after parsing the macroop in 
<a href="#translating-parsed-macroop">the later section</a>.</p>

<h2 id="parsing-x86-macroops"><span class="me-2">Parsing X86 Macroops</span><a href="#parsing-x86-macroops" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<p>In this section, I will go over how GEM5 parses macroop definitions of X86 
architecture. Regardless of the target architecture, the ISA parsing is initiated
by the same GEM5 provided function <strong>parse_isa_desc</strong> of the ISAParser class. 
Since most of the target architecture defines its ISA with multiple isa files, 
all list of the isa files that needs parsing will be usually specified in one 
isa file called main.isa.</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="c1">#gem5/src/arch/x86/isa/main.isa
</span>
<span class="c1">##include "includes.isa"
</span>
<span class="n">namespace</span> <span class="n">X86ISA</span><span class="p">;</span>

<span class="c1">##include "operands.isa"
##include "bitfields.isa"
##include "outputblock.isa"
##include "formats/formats.isa"
##include "microasm.isa"
</span><span class="p">...</span><span class="bp">...</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Upon opening the x86 architecture’s main.isa file, you’ll notice the inclusion 
of the microasm.isa file. This might cause confusion for readers anticipating 
isa files associated with macroops. Yet, considering that the X86 macroop is 
composed of one or more microops, assembling the microops to generate macroops 
becomes logical when you recall this relationship.</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="rouge-code"><pre><span class="c1">#gem5/src/arch/x86/isa/microasm.isa
</span>
<span class="n">let</span> <span class="p">{</span>
    <span class="kn">import</span> <span class="n">sys</span>
    <span class="n">sys</span><span class="p">.</span><span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">src/arch/x86/isa/</span><span class="sh">"</span><span class="p">]</span>
    <span class="kn">from</span> <span class="n">insts</span> <span class="kn">import</span> <span class="n">microcode</span>
    <span class="c1"># print microcode
</span>    <span class="kn">from</span> <span class="n">micro_asm</span> <span class="kn">import</span> <span class="n">MicroAssembler</span><span class="p">,</span> <span class="n">Rom_Macroop</span>
    <span class="n">mainRom</span> <span class="o">=</span> <span class="nc">X86MicrocodeRom</span><span class="p">(</span><span class="sh">'</span><span class="s">main ROM</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">assembler</span> <span class="o">=</span> <span class="nc">MicroAssembler</span><span class="p">(</span><span class="n">X86Macroop</span><span class="p">,</span> <span class="n">microopClasses</span><span class="p">,</span> <span class="n">mainRom</span><span class="p">,</span> <span class="n">Rom_Macroop</span><span class="p">)</span>
    <span class="p">...</span><span class="bp">...</span>
    <span class="n">assembler</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="sh">"</span><span class="s">fsw</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">readFpReg</span><span class="p">(</span><span class="sh">"</span><span class="s">FSW</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">assembler</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="sh">"</span><span class="s">fcw</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">readFpReg</span><span class="p">(</span><span class="sh">"</span><span class="s">FCW</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">assembler</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="sh">"</span><span class="s">ftw</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">readFpReg</span><span class="p">(</span><span class="sh">"</span><span class="s">FTW</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="n">macroopDict</span> <span class="o">=</span> <span class="n">assembler</span><span class="p">.</span><span class="nf">assemble</span><span class="p">(</span><span class="n">microcode</span><span class="p">)</span>
    
    <span class="n">decoder_output</span> <span class="o">+=</span> <span class="n">mainRom</span><span class="p">.</span><span class="nf">getDefinition</span><span class="p">()</span>
    <span class="n">header_output</span> <span class="o">+=</span> <span class="n">mainRom</span><span class="p">.</span><span class="nf">getDeclaration</span><span class="p">()</span>

</pre></td></tr></tbody></table></code></div></div>

<p>As depicted in the let block, it first instantiates the MicroAssembler object.
<a href="#microassembler">MicroAssembler class</a> is responsible for parsing X86 macroops.
Parsing a single macroop yields a Python class object that embodies the parsed 
macroop. Therefore, it requires the presence of Python class definitions capable 
of representing a single macroop, specifically, the X86Macroop Python class. 
Furthermore, given that a macroop comprises of multiple microops, details about 
the microops defined in the target architecture must be passed to the 
MicroAssembler, specifically, the microopClasses Python dictionary.</p>

<h3 id="x86macroop-"><span class="me-2">X86Macroop <a name="x86macroop"></a></span><a href="#x86macroop-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>The primary objective in creating an <strong>X86Macroop</strong> instance for a parsed macro
operation is to provide information about the parsed macroop. The macroop parsing
plays a role in collecting all relevant information about the macroop, including 
its microops. It is noteworthy that the X86Macroop Python class provides a method 
named ‘add_microop.’ Also, the goal of the parsing the macroop is to generate a 
CPP implementation for that macroop, enabling execution by the processor pipeline. 
Therefore, the X86Macroop class provides several relevant functions generating 
CPP Implementations based on the collected information. I’ll soon elaborate on 
how this class proves beneficial in the automated generation of CPP 
implementations for macroops.</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
</pre></td><td class="rouge-code"><pre><span class="c1">#gem5/src/arch/x86/isa/macroop.isa
</span><span class="k">class</span> <span class="nc">X86Macroop</span><span class="p">(</span><span class="n">Combinational_Macroop</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">add_microop</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">mnemonic</span><span class="p">,</span> <span class="n">microop</span><span class="p">):</span>
        <span class="n">microop</span><span class="p">.</span><span class="n">mnemonic</span> <span class="o">=</span> <span class="n">mnemonic</span>
        <span class="n">microop</span><span class="p">.</span><span class="n">micropc</span> <span class="o">=</span> <span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">microops</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">microops</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">microop</span><span class="p">)</span>

    <span class="p">...</span><span class="bp">...</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">(</span><span class="n">X86Macroop</span><span class="p">,</span> <span class="n">self</span><span class="p">).</span><span class="nf">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">directives</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">adjust_env</span><span class="sh">"</span> <span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">setAdjustEnv</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">adjust_imm</span><span class="sh">"</span> <span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">adjustImm</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">adjust_disp</span><span class="sh">"</span> <span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">adjustDisp</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">serialize_before</span><span class="sh">"</span> <span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">serializeBefore</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">serialize_after</span><span class="sh">"</span> <span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">serializeAfter</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">function_call</span><span class="sh">"</span> <span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">function_call</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">function_return</span><span class="sh">"</span> <span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">function_return</span>
        <span class="p">}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">declared</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">self</span><span class="p">.</span><span class="n">adjust_env</span> <span class="o">=</span> <span class="sh">""</span>
        <span class="n">self</span><span class="p">.</span><span class="n">init_env</span> <span class="o">=</span> <span class="sh">""</span>
        <span class="n">self</span><span class="p">.</span><span class="n">adjust_imm</span> <span class="o">=</span> <span class="sh">'''</span><span class="s">
            uint64_t adjustedImm = IMMEDIATE;
            //This is to pacify gcc in case the immediate isn</span><span class="sh">'</span><span class="s">t used.
            adjustedImm = adjustedImm;
        </span><span class="sh">'''</span>
        <span class="n">self</span><span class="p">.</span><span class="n">adjust_disp</span> <span class="o">=</span> <span class="sh">'''</span><span class="s">
            uint64_t adjustedDisp = DISPLACEMENT;
            //This is to pacify gcc in case the displacement isn</span><span class="sh">'</span><span class="s">t used.
            adjustedDisp = adjustedDisp;
        </span><span class="sh">'''</span>
        <span class="n">self</span><span class="p">.</span><span class="n">serialize_before</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">self</span><span class="p">.</span><span class="n">serialize_after</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">self</span><span class="p">.</span><span class="n">function_call</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">self</span><span class="p">.</span><span class="n">function_return</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">getAllocator</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">env</span><span class="p">):</span>
        <span class="k">return</span> <span class="sh">"</span><span class="s">new X86Macroop::%s(machInst, %s)</span><span class="sh">"</span> <span class="o">%</span> \
                <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">env</span><span class="p">.</span><span class="nf">getAllocator</span><span class="p">())</span>
    <span class="k">def</span> <span class="nf">getMnemonic</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">mnemonic</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="nf">lower</span><span class="p">()</span>
        <span class="n">mnemonic</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">match</span><span class="p">(</span><span class="sa">r</span><span class="sh">'</span><span class="s">[^_]*</span><span class="sh">'</span><span class="p">,</span> <span class="n">mnemonic</span><span class="p">).</span><span class="nf">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mnemonic</span>
    <span class="k">def</span> <span class="nf">getDeclaration</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="c1">#FIXME This first parameter should be the mnemonic. I need to
</span>        <span class="c1">#write some code which pulls that out
</span>        <span class="n">declareLabels</span> <span class="o">=</span> <span class="sh">""</span>
        <span class="nf">for </span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">microop</span><span class="p">)</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">labels</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="n">declareLabels</span> <span class="o">+=</span> <span class="sh">"</span><span class="s">const static uint64_t label_%s = %d;</span><span class="se">\n</span><span class="sh">"</span> \
                              <span class="o">%</span> <span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">microop</span><span class="p">.</span><span class="n">micropc</span><span class="p">)</span>
        <span class="n">iop</span> <span class="o">=</span> <span class="nc">InstObjParams</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="nf">getMnemonic</span><span class="p">(),</span> <span class="n">self</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">Macroop</span><span class="sh">"</span><span class="p">,</span>
                <span class="p">{</span><span class="sh">"</span><span class="s">code</span><span class="sh">"</span> <span class="p">:</span> <span class="sh">""</span><span class="p">,</span>
                 <span class="sh">"</span><span class="s">declareLabels</span><span class="sh">"</span> <span class="p">:</span> <span class="n">declareLabels</span>
                <span class="p">})</span>
        <span class="k">return</span> <span class="n">MacroDeclare</span><span class="p">.</span><span class="nf">subst</span><span class="p">(</span><span class="n">iop</span><span class="p">);</span>
    <span class="k">def</span> <span class="nf">getDefinition</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">env</span><span class="p">):</span>
        <span class="c1">#FIXME This first parameter should be the mnemonic. I need to
</span>        <span class="c1">#write some code which pulls that out
</span>        <span class="n">numMicroops</span> <span class="o">=</span> <span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">microops</span><span class="p">)</span>
        <span class="n">allocMicroops</span> <span class="o">=</span> <span class="sh">''</span>
        <span class="n">micropc</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">microops</span><span class="p">:</span>
            <span class="n">flags</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">IsMicroop</span><span class="sh">"</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">micropc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">flags</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sh">"</span><span class="s">IsFirstMicroop</span><span class="sh">"</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">serialize_before</span><span class="p">:</span>
                    <span class="n">flags</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sh">"</span><span class="s">IsSerializing</span><span class="sh">"</span><span class="p">)</span>
                    <span class="n">flags</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sh">"</span><span class="s">IsSerializeBefore</span><span class="sh">"</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">micropc</span> <span class="o">==</span> <span class="n">numMicroops</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">flags</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sh">"</span><span class="s">IsLastMicroop</span><span class="sh">"</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">serialize_after</span><span class="p">:</span>
                    <span class="n">flags</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sh">"</span><span class="s">IsSerializing</span><span class="sh">"</span><span class="p">)</span>
                    <span class="n">flags</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sh">"</span><span class="s">IsSerializeAfter</span><span class="sh">"</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">function_call</span><span class="p">:</span>
                    <span class="n">flags</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sh">"</span><span class="s">IsCall</span><span class="sh">"</span><span class="p">)</span>
                    <span class="n">flags</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sh">"</span><span class="s">IsUncondControl</span><span class="sh">"</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">function_return</span><span class="p">:</span>
                    <span class="n">flags</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sh">"</span><span class="s">IsReturn</span><span class="sh">"</span><span class="p">)</span>
                    <span class="n">flags</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sh">"</span><span class="s">IsUncondControl</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">flags</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sh">"</span><span class="s">IsDelayedCommit</span><span class="sh">"</span><span class="p">)</span>

            <span class="n">allocMicroops</span> <span class="o">+=</span> \
                <span class="sh">"</span><span class="s">microops[%d] = %s;</span><span class="se">\n</span><span class="sh">"</span> <span class="o">%</span> \
                <span class="p">(</span><span class="n">micropc</span><span class="p">,</span> <span class="n">op</span><span class="p">.</span><span class="nf">getAllocator</span><span class="p">(</span><span class="n">flags</span><span class="p">))</span>
            <span class="n">micropc</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">env</span><span class="p">.</span><span class="n">useStackSize</span><span class="p">:</span>
            <span class="n">useStackSize</span> <span class="o">=</span> <span class="sh">"</span><span class="s">true</span><span class="sh">"</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">useStackSize</span> <span class="o">=</span> <span class="sh">"</span><span class="s">false</span><span class="sh">"</span>
        <span class="k">if</span> <span class="n">env</span><span class="p">.</span><span class="n">memoryInst</span><span class="p">:</span>
            <span class="n">memoryInst</span> <span class="o">=</span> <span class="sh">"</span><span class="s">true</span><span class="sh">"</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">memoryInst</span> <span class="o">=</span> <span class="sh">"</span><span class="s">false</span><span class="sh">"</span>
        <span class="n">regSize</span> <span class="o">=</span> <span class="sh">'''</span><span class="s">(%s || (env.base == INTREG_RSP &amp;&amp; %s) ?
                     env.stackSize :
                     env.dataSize)</span><span class="sh">'''</span> <span class="o">%</span> <span class="p">(</span><span class="n">useStackSize</span><span class="p">,</span> <span class="n">memoryInst</span><span class="p">)</span>
        <span class="n">iop</span> <span class="o">=</span> <span class="nc">InstObjParams</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="nf">getMnemonic</span><span class="p">(),</span> <span class="n">self</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">Macroop</span><span class="sh">"</span><span class="p">,</span>
                            <span class="p">{</span><span class="sh">"</span><span class="s">code</span><span class="sh">"</span> <span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">num_microops</span><span class="sh">"</span> <span class="p">:</span> <span class="n">numMicroops</span><span class="p">,</span>
                             <span class="sh">"</span><span class="s">alloc_microops</span><span class="sh">"</span> <span class="p">:</span> <span class="n">allocMicroops</span><span class="p">,</span>
                             <span class="sh">"</span><span class="s">adjust_env</span><span class="sh">"</span> <span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">adjust_env</span><span class="p">,</span>
                             <span class="sh">"</span><span class="s">adjust_imm</span><span class="sh">"</span> <span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">adjust_imm</span><span class="p">,</span>
                             <span class="sh">"</span><span class="s">adjust_disp</span><span class="sh">"</span> <span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">adjust_disp</span><span class="p">,</span>
                             <span class="sh">"</span><span class="s">disassembly</span><span class="sh">"</span> <span class="p">:</span> <span class="n">env</span><span class="p">.</span><span class="n">disassembly</span><span class="p">,</span>
                             <span class="sh">"</span><span class="s">regSize</span><span class="sh">"</span> <span class="p">:</span> <span class="n">regSize</span><span class="p">,</span>
                             <span class="sh">"</span><span class="s">init_env</span><span class="sh">"</span> <span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">initEnv</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">MacroConstructor</span><span class="p">.</span><span class="nf">subst</span><span class="p">(</span><span class="n">iop</span><span class="p">)</span> <span class="o">+</span> \
               <span class="n">MacroDisassembly</span><span class="p">.</span><span class="nf">subst</span><span class="p">(</span><span class="n">iop</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="microopclasses-"><span class="me-2">microopClasses <a name="microopDict"></a></span><a href="#microopclasses-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>As one macroop can comprise multiple microops, the process of parsing a macroop 
is intricately connected to parsing the microops that make up the macroop. 
Consequently, the parser needs to be aware of the microops present in the target
architecture. This underscores the importance of passing the <strong>microopClasses</strong> 
Python dictionary to the MicroAssembler.</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="c1">#src/arch/x86/isa/microops/base.isa
</span>
<span class="n">let</span> <span class="p">{</span>
    <span class="c1"># This will be populated with mappings between microop mnemonics and
</span>    <span class="c1"># the classes that represent them.
</span>    <span class="n">microopClasses</span> <span class="o">=</span> <span class="p">{}</span>
<span class="p">};</span>
</pre></td></tr></tbody></table></code></div></div>

<p>This Python dictionary containing pairs of microop mnemonic strings and their
corresponding class definitions. It’s crucial to highlight that each microop 
operation is expressed as a distinct Python class. The microopClasses dictionary, 
once provided, will be assigned to the ‘microops’ attribute of the MicroAssembler.
Then how this dictionary is generated?</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="c1">#gem5/src/arch/x86/isa/microops/limop.isa
</span>
<span class="n">let</span> <span class="p">{</span>
    <span class="k">class</span> <span class="nc">LimmOp</span><span class="p">(</span><span class="n">X86Microop</span><span class="p">):</span>
    <span class="p">...</span><span class="bp">...</span>
    <span class="n">microopClasses</span><span class="p">[</span><span class="sh">"</span><span class="s">limm</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">LimmOp</span>                                             
</pre></td></tr></tbody></table></code></div></div>

<p>As depicted in the code, every isa file defines the classes that can be employed 
to represent a microop. Additionally, it generates an entry to the microopClasses 
dictionary, linking the string identifier of the microop to the corresponding 
class that represents the microop. In the above example, generated dictionary 
in the microopClasses associates string “limm” to class “LimOp”.</p>

<h3 id="assemble-function-and-microcode"><span class="me-2">assemble function and microcode</span><a href="#assemble-function-and-microcode" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>Parsing the actual macroop and generating X86Macroop objects for each macroop is 
accomplished by calling the assemble function of the MicroAssembler class.</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">MicroAssembler</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="p">...</span><span class="bp">...</span>
    <span class="k">def</span> <span class="nf">assemble</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">asm</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">asm</span><span class="p">,</span> <span class="n">lexer</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">lexer</span><span class="p">)</span>
        <span class="n">macroops</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="n">macroops</span>
        <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="n">macroops</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">return</span> <span class="n">macroops</span>
</pre></td></tr></tbody></table></code></div></div>

<p>As illustrated in the code, it parses the macroop definitions written in GEM5 DSL
and retrieves the macroops. The macroops returned are Python objects, each being 
an instance of X86Macroop.</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="c1">#gem5/src/arch/x86/isa/microasm.isa                                             
</span>                                                                                
<span class="n">let</span> <span class="p">{</span>                                                                           
    <span class="p">...</span><span class="bp">...</span>
    <span class="n">macroopDict</span> <span class="o">=</span> <span class="n">assembler</span><span class="p">.</span><span class="nf">assemble</span><span class="p">(</span><span class="n">microcode</span><span class="p">)</span>                                 
</pre></td></tr></tbody></table></code></div></div>

<p>It’s important to highlight that the assemble function also receives <em>microcode</em>. 
Despite the potentially confusing name, it’s essential to clarify that ‘microcode’
refers to an extensive concatenated Python string containing all <strong>macroop</strong>
definitions in GEM5 DSL syntax. These microcode strings are aggregated from 
individual Python files found in the ‘isa/insts’ directory, where a
rchitecture-specific macroops are defined.</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre><span class="c1"># src/arch/x86/isa/inst/general_purpose/data_transfer/move.py
</span>
<span class="n">microcode</span> <span class="o">=</span> <span class="sh">'''</span><span class="s">

#
# Regular moves
#

def macroop MOV_R_MI {
    limm t1, imm, dataSize=asz
    ld reg, seg, [1, t0, t1]
};

def macroop MOV_MI_R {
    limm t1, imm, dataSize=asz
    st reg, seg, [1, t0, t1]
};
</span></pre></td></tr></tbody></table></code></div></div>

<p>As specified in the code, a microcode string is defined for each macroop mnemonic,
encapsulating the macroop definitions implemented in GEM5 DSL. Given that these 
microcode strings are spread across individual ISA files for each macroop, it is
necessary to gather all the microcode strings from multiple ISA files.</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre><span class="c1">#gem5/src/arch/x86/isa/insts/general_purpose/data_transfer/__init__.py
</span>
<span class="n">categories</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">conditional_move</span><span class="sh">"</span><span class="p">,</span>
              <span class="sh">"</span><span class="s">move</span><span class="sh">"</span><span class="p">,</span>
              <span class="sh">"</span><span class="s">stack_operations</span><span class="sh">"</span><span class="p">,</span>
              <span class="sh">"</span><span class="s">xchg</span><span class="sh">"</span><span class="p">]</span>

<span class="n">microcode</span> <span class="o">=</span> <span class="sh">""</span>
<span class="k">for</span> <span class="n">category</span> <span class="ow">in</span> <span class="n">categories</span><span class="p">:</span>
    <span class="k">exec</span> <span class="sh">"</span><span class="s">import %s as cat</span><span class="sh">"</span> <span class="o">%</span> <span class="n">category</span>
    <span class="n">microcode</span> <span class="o">+=</span> <span class="n">cat</span><span class="p">.</span><span class="n">microcode</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Every ISA file defining the macrooperations for the x86 architecture is located 
under the ‘src/arch/x86/isa/insts/’ directory, categorized based on the 
instruction type. The ‘<strong>init</strong>.py’ file in each category directory collects the 
microcode string from Python files located in that directory. As depicted in the 
code, it specifies the Python files defining the macroop and imports the listed
Python files to import microcode string. These strings are concatanated into the 
microcode string. Consequently, the microcode will have all macroop definitions
implemented in GEM5 DSL.</p>

<h3 id="context-free-grammar-for-def-macroop"><span class="me-2">Context-free grammar for def macroop</span><a href="#context-free-grammar-for-def-macroop" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="c1"># gem5/src/arch/x86/isa/insts/general_purpose/data_transfer/move.py             
</span>                                                                                
<span class="n">microcode</span> <span class="o">=</span> <span class="sh">'''</span><span class="s">                                                                 
def macroop MOV_R_MI {                                                          
    limm t1, imm, dataSize=asz                                                  
    ld reg, seg, [1, t0, t1]                                                    
};    
</span></pre></td></tr></tbody></table></code></div></div>

<p>Upon opening any Python file that defines a macroop, you’ll readily observe that 
each macroop definition begins with <strong>def macroop</strong>. Like the previously 
encountered <strong>let</strong> block in ISA parsing, this structure is a component of the 
GEM5 DSL syntax associated with macroop definition. Therefore, corresponding 
CFG should be provided to parse the def macrop block.</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="c1">#gem5/src/arch/micro_asm.py
</span>
<span class="c1"># Defines a macroop that is combinationally generated
</span><span class="k">def</span> <span class="nf">p_macroop_def_1</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
    <span class="sh">'</span><span class="s">macroop_def : DEF MACROOP ID block SEMI</span><span class="sh">'</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">curop</span> <span class="o">=</span> <span class="n">t</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="nf">macro_type</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
    <span class="k">except</span> <span class="nb">TypeError</span><span class="p">:</span>
        <span class="nf">print_error</span><span class="p">(</span><span class="sh">"</span><span class="s">Error creating macroop object.</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">raise</span>
    <span class="k">for</span> <span class="n">statement</span> <span class="ow">in</span> <span class="n">t</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">statements</span><span class="p">:</span>
        <span class="nf">handle_statement</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">parser</span><span class="p">,</span> <span class="n">curop</span><span class="p">,</span> <span class="n">statement</span><span class="p">)</span>
    <span class="n">t</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="n">macroops</span><span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span> <span class="o">=</span> <span class="n">curop</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Upon encountering the <strong>def macroop</strong> block during microcode parsing, it invokes 
one of the <strong>p_macroop_def_X</strong> functions depending on the format of the macroop 
block, determined by the tokens within the <strong>def</strong> block. Given that the macroop 
block can assume various formats, the corresponding CFG precisely matching the 
macroop block is invoked. In the specific case we’re examining, which is the 
<strong>def macroop MOV_R_MI</strong> block, the <strong>p_macroop_def_1</strong> function will be called.</p>

<p>At line 7, it’s noticeable that <strong>t[3]</strong>, representing the mnemonic of the 
currently parsed macroop, is passed to invoke <strong>macro_type</strong>. It’s important to
note that the macrop_type attribute of the <a href="#microassembler">MicroAssembler class</a>
has been set as the <strong>X86Macroop</strong> Python class object. Consequently, 
<strong>t.parser.macro_type(t[3])</strong> translates to <strong>X86Macroop(MOV_R_MI)</strong>, leading to
the invocation of the constructor call for the <a href="#x86macroop">X86Macroop object</a>. 
This implies that whenever a <strong>def macroop</strong> block is encountered during parsing, 
it transforms the <strong>def</strong> block into an instance of the X86Macroop Python object.</p>

<h3 id="block-token-microops-consisting-of-macroop"><span class="me-2">Block token: microops consisting of macroop</span><a href="#block-token-microops-consisting-of-macroop" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>You may remember that a single X86Macroop object can encapsulate all the details 
about a specific macroop operation, including its constituent microops. However,
immediately after populating the macroop instance, it lacks information about the
microops composing the current macroop class instance.</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">Block</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">statements</span> <span class="o">=</span> <span class="p">[]</span>

<span class="p">...</span><span class="bp">...</span>
<span class="c1"># A block of statements
</span><span class="k">def</span> <span class="nf">p_block</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
    <span class="sh">'</span><span class="s">block : LBRACE statements RBRACE</span><span class="sh">'</span>
    <span class="n">block</span> <span class="o">=</span> <span class="nc">Block</span><span class="p">()</span>
    <span class="n">block</span><span class="p">.</span><span class="n">statements</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">block</span>
</pre></td></tr></tbody></table></code></div></div>

<p>As outlined in the rule for block <strong>p_block</strong>, the parser proceeds to parse the
subsequent statements within the <strong>def macroop</strong> block and translates each microop
operations into the corresponding microop classes. Referring back to the earlier
definition of a macroop, it becomes clear that the ‘block’ token represents a 
collection of multiple lines of microops, forming a single macroop. In detail,
when the parser encounters the ‘block’ token, it instantiates the ‘block’ class
object and subsequently adds the parsed statements (microops in string) to the
<strong>statement</strong> field of the block instance.</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre></td><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">p_statements_0</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
    <span class="sh">'</span><span class="s">statements : statement</span><span class="sh">'</span>
    <span class="k">if</span> <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
        <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">def</span> <span class="nf">p_statements_1</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
    <span class="sh">'</span><span class="s">statements : statements statement</span><span class="sh">'</span>
    <span class="k">if</span> <span class="n">t</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
        <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">append</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">p_statement</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
    <span class="sh">'</span><span class="s">statement : content_of_statement end_of_statement</span><span class="sh">'</span>
    <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

<span class="c1"># A statement can be a microop or an assembler directive
</span><span class="k">def</span> <span class="nf">p_content_of_statement_0</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
    <span class="sh">'''</span><span class="s">content_of_statement : microop
                            | directive</span><span class="sh">'''</span>
    <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

<span class="c1"># Ignore empty statements
</span><span class="k">def</span> <span class="nf">p_content_of_statement_1</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
    <span class="sh">'</span><span class="s">content_of_statement : </span><span class="sh">'</span>
    <span class="k">pass</span>

<span class="c1"># Statements are ended by newlines or a semi colon
</span><span class="k">def</span> <span class="nf">p_end_of_statement</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
    <span class="sh">'''</span><span class="s">end_of_statement : NEWLINE
                        | SEMI</span><span class="sh">'''</span>
    <span class="k">pass</span>
</pre></td></tr></tbody></table></code></div></div>

<p>The statement is a string that comprises one or more microoperations. Therefore, 
each microop within the statement needs further parsing, necessitating another
CFG for parsing rules. As depicted in the code, the statements can be further
analyzed as either microop or directives.</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre></td><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">Statement</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">is_microop</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">self</span><span class="p">.</span><span class="n">is_directive</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">self</span><span class="p">.</span><span class="n">params</span> <span class="o">=</span> <span class="sh">""</span>

<span class="k">class</span> <span class="nc">Microop</span><span class="p">(</span><span class="n">Statement</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">(</span><span class="n">Microop</span><span class="p">,</span> <span class="n">self</span><span class="p">).</span><span class="nf">__init__</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">mnemonic</span> <span class="o">=</span> <span class="sh">""</span>
        <span class="n">self</span><span class="p">.</span><span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">self</span><span class="p">.</span><span class="n">is_microop</span> <span class="o">=</span> <span class="bp">True</span>

<span class="c1"># Different flavors of microop to avoid shift/reduce errors
</span><span class="k">def</span> <span class="nf">p_microop_0</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
    <span class="sh">'</span><span class="s">microop : labels ID</span><span class="sh">'</span>
    <span class="n">microop</span> <span class="o">=</span> <span class="nc">Microop</span><span class="p">()</span>
    <span class="n">microop</span><span class="p">.</span><span class="n">labels</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">microop</span><span class="p">.</span><span class="n">mnemonic</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">microop</span>


<span class="k">def</span> <span class="nf">p_microop_3</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
    <span class="sh">'</span><span class="s">microop : ID PARAMS</span><span class="sh">'</span>
    <span class="n">microop</span> <span class="o">=</span> <span class="nc">Microop</span><span class="p">()</span>
    <span class="n">microop</span><span class="p">.</span><span class="n">mnemonic</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">microop</span><span class="p">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">microop</span>
</pre></td></tr></tbody></table></code></div></div>

<p>GEM5 establishes diverse grammar rules for parsing microops in different formats.
For instance, the ‘limm t1, imm, dataSize=asz’ microop, which is part of the 
MOV_R_MI macroop, conforms to the ‘p_microop_3 grammar rule’. When the parser 
comes across a ‘microop’ statement containing a microop ID (mnemonic) and PARAMS 
(parameters of the microop), it generates a ‘Microop’ instance. Subsequently, 
the parser assigns the parsed mnemonic and parameters to their respective fields 
within the ‘Microop’ object.</p>

<p>In the context of PLY, t[0] is used to assign the result of the parsing rule. In 
this case, t[0] = microop means that the parsed result of the ‘microop’ rule is 
set to the Microop instance created (microop). Therefore, the parsing result of 
the microop will be stored in the statements attribute of the block. Moreover, 
by tracing the call stack of the parsing rules, you can discover its utilization 
within the p_macroop_def_1 rule. Let’s take a closer look!</p>

<h3 id="handle_statements--handling-microops"><span class="me-2">handle_statements- handling microops</span><a href="#handle_statements--handling-microops" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>Just like the macroop is converted into a ‘X86Macroop’ Python object, its microop, 
which is stored in the statements attribute of the block, needs to undergo 
transformation into its respective Python classes.</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">p_macroop_def_1</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>                                                         
    <span class="sh">'</span><span class="s">macroop_def : DEF MACROOP ID block SEMI</span><span class="sh">'</span>                                   
    <span class="p">..</span><span class="bp">...</span>
    <span class="k">for</span> <span class="n">statement</span> <span class="ow">in</span> <span class="n">t</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">statements</span><span class="p">:</span>                                           
        <span class="nf">handle_statement</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">parser</span><span class="p">,</span> <span class="n">curop</span><span class="p">,</span> <span class="n">statement</span><span class="p">)</span>    
</pre></td></tr></tbody></table></code></div></div>

<p>Within the macroop parsing function, it iterates through each statement, where 
in this context, statements refer to the microops comprising the macroop. The 
‘handle_statement’ function is then called for each statement. It’s important to 
highlight that this function requires both the ‘curop,’ which represents the 
currently parsed ‘X86Macroop’ object, and the ‘statement,’ which represents an 
individual microop.</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre></td><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">handle_statement</span><span class="p">(</span><span class="n">parser</span><span class="p">,</span> <span class="n">container</span><span class="p">,</span> <span class="n">statement</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">statement</span><span class="p">.</span><span class="n">is_microop</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">statement</span><span class="p">.</span><span class="n">mnemonic</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">parser</span><span class="p">.</span><span class="n">microops</span><span class="p">.</span><span class="nf">keys</span><span class="p">():</span>
            <span class="k">raise</span> <span class="nb">Exception</span><span class="p">,</span> <span class="sh">"</span><span class="s">Unrecognized mnemonic: %s</span><span class="sh">"</span> <span class="o">%</span> <span class="n">statement</span><span class="p">.</span><span class="n">mnemonic</span>
        <span class="n">parser</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="sh">"</span><span class="s">__microopClassFromInsideTheAssembler</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">parser</span><span class="p">.</span><span class="n">microops</span><span class="p">[</span><span class="n">statement</span><span class="p">.</span><span class="n">mnemonic</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">microop</span> <span class="o">=</span> <span class="nf">eval</span><span class="p">(</span><span class="sh">'</span><span class="s">__microopClassFromInsideTheAssembler(%s)</span><span class="sh">'</span> <span class="o">%</span>
                    <span class="n">statement</span><span class="p">.</span><span class="n">params</span><span class="p">,</span> <span class="p">{},</span> <span class="n">parser</span><span class="p">.</span><span class="n">symbols</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nf">print_error</span><span class="p">(</span><span class="sh">"</span><span class="s">Error creating microop object with mnemonic %s.</span><span class="sh">"</span> <span class="o">%</span> \
                    <span class="n">statement</span><span class="p">.</span><span class="n">mnemonic</span><span class="p">)</span>
            <span class="k">raise</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">statement</span><span class="p">.</span><span class="n">labels</span><span class="p">:</span>
                <span class="n">container</span><span class="p">.</span><span class="n">labels</span><span class="p">[</span><span class="n">label</span><span class="p">.</span><span class="n">text</span><span class="p">]</span> <span class="o">=</span> <span class="n">microop</span>
                <span class="k">if</span> <span class="n">label</span><span class="p">.</span><span class="n">is_extern</span><span class="p">:</span>
                    <span class="n">container</span><span class="p">.</span><span class="n">externs</span><span class="p">[</span><span class="n">label</span><span class="p">.</span><span class="n">text</span><span class="p">]</span> <span class="o">=</span> <span class="n">microop</span>
            <span class="n">container</span><span class="p">.</span><span class="nf">add_microop</span><span class="p">(</span><span class="n">statement</span><span class="p">.</span><span class="n">mnemonic</span><span class="p">,</span> <span class="n">microop</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nf">print_error</span><span class="p">(</span><span class="sh">"</span><span class="s">Error adding microop.</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">raise</span>
    <span class="k">elif</span> <span class="n">statement</span><span class="p">.</span><span class="n">is_directive</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">statement</span><span class="p">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">container</span><span class="p">.</span><span class="n">directives</span><span class="p">.</span><span class="nf">keys</span><span class="p">():</span>
            <span class="k">raise</span> <span class="nb">Exception</span><span class="p">,</span> <span class="sh">"</span><span class="s">Unrecognized directive: %s</span><span class="sh">"</span> <span class="o">%</span> <span class="n">statement</span><span class="p">.</span><span class="n">name</span>
        <span class="n">parser</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="sh">"</span><span class="s">__directiveFunctionFromInsideTheAssembler</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">container</span><span class="p">.</span><span class="n">directives</span><span class="p">[</span><span class="n">statement</span><span class="p">.</span><span class="n">name</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="nf">eval</span><span class="p">(</span><span class="sh">'</span><span class="s">__directiveFunctionFromInsideTheAssembler(%s)</span><span class="sh">'</span> <span class="o">%</span>
                    <span class="n">statement</span><span class="p">.</span><span class="n">params</span><span class="p">,</span> <span class="p">{},</span> <span class="n">parser</span><span class="p">.</span><span class="n">symbols</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nf">print_error</span><span class="p">(</span><span class="sh">"</span><span class="s">Error executing directive.</span><span class="sh">"</span><span class="p">)</span>
            <span class="nf">print</span><span class="p">(</span><span class="n">container</span><span class="p">.</span><span class="n">directives</span><span class="p">)</span>
            <span class="k">raise</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nb">Exception</span><span class="p">,</span> <span class="sh">"</span><span class="s">Didn</span><span class="sh">'</span><span class="s">t recognize the type of statement</span><span class="sh">"</span><span class="p">,</span> <span class="n">statement</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Every statement can be categorized as either a ‘microop’ or a ‘directive,’ and
the processing of each statement is contingent upon its type. As illustrated in
the code, the <a href="#microopDict">microop dictionary</a> is employed to look up the Python
class linked to the current microop mnemonic. X86 architecture defines microops 
using the GEM5 DSL, and it is parsed into python corredponding python classses
matching with each microop. I will go over how these microops are implemented 
in GEM5 DSL in the next posting. Anyway, the class retrieved from this dictionary 
is then stored in the symbols attribute of the parser. It’s crucial to emphasize 
that the parsed microop’s mnemonic field (i.e., ‘statement.mnemonic’) is utilized 
to identify the corresponding reference to the microop class.</p>

<p>The <em>eval</em> statement is employed to create an instance of the microop class. This 
involves utilizing the previously obtained microop class and passing the 
‘statement.params’ as an argument to the ‘eval’ function. The argument encompasses
all microop operands that follow a microop mnemonic. For instance, in the ‘MOV_R_MI’
macroop definition, the ‘limm’ microop needs operands ‘t1, imm, dataSize=asz’.</p>

<p>Before executing the ‘eval’ function, the microop’s operands are initially 
formatted as a string. However, since eval utilizes ‘parser.symbols’ as its 
<strong>local mapping dictionary</strong>, these string operands undergo transformation into 
code statements comprehensible by the microop classes. For example, the initial
operand ‘t1’ is translated into ‘InstRegIndex(NUM_INTREGS+1)’ as a result of the 
‘eval.’ Subsequently, these translated operands are supplied to the constructor 
of the corresponding microop class based on the microop’s mnemonic. If you are 
curious about how this translation can happen please refer to <a href="#appendix">appendix</a></p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">handle_statement</span><span class="p">(</span><span class="n">parser</span><span class="p">,</span> <span class="n">container</span><span class="p">,</span> <span class="n">statement</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">statement</span><span class="p">.</span><span class="n">is_microop</span><span class="p">:</span>
        <span class="p">...</span><span class="bp">...</span>
        <span class="k">try</span><span class="p">:</span> 
            <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">statement</span><span class="p">.</span><span class="n">labels</span><span class="p">:</span>
                <span class="n">container</span><span class="p">.</span><span class="n">labels</span><span class="p">[</span><span class="n">label</span><span class="p">.</span><span class="n">text</span><span class="p">]</span> <span class="o">=</span> <span class="n">microop</span>
                <span class="k">if</span> <span class="n">label</span><span class="p">.</span><span class="n">is_extern</span><span class="p">:</span>
                    <span class="n">container</span><span class="p">.</span><span class="n">externs</span><span class="p">[</span><span class="n">label</span><span class="p">.</span><span class="n">text</span><span class="p">]</span> <span class="o">=</span> <span class="n">microop</span>
            <span class="n">container</span><span class="p">.</span><span class="nf">add_microop</span><span class="p">(</span><span class="n">statement</span><span class="p">.</span><span class="n">mnemonic</span><span class="p">,</span> <span class="n">microop</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nf">print_error</span><span class="p">(</span><span class="sh">"</span><span class="s">Error adding microop.</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">raise</span>
</pre></td></tr></tbody></table></code></div></div>
<p>The handle_statement function creates Python class objects for parsed microops, 
comprising the macroop. These objects should be incorporated into the Python 
object of the corresponding macroop. In the provided code, the container refers
to the Python object of the macroop, which is an instance of X86Macroop.
After the successful parsing of a macroop, the corresponding macroop container 
is saved in the ‘parser.macroops’ dictionary. It will be returned to the assemble 
function and stored in the ‘macroopDict’ attribute.</p>

<h2 id="translating-parsed-macroop-into-c-class-"><span class="me-2">Translating parsed macroop into C++ class <a name="translating-parsed-macroop"></a></span><a href="#translating-parsed-macroop-into-c-class-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<blockquote class="prompt-info">
  <p>The parsed macroops and its microops are instantiated as Python objects, not 
C++ class instances.</p>
</blockquote>

<p>The parsing outcome produces a Python dictionary containing all the macroop, 
each represented as X86Macroop objects. Additionally, the microops within each 
macroop are instances of Python classes stored within the respective macroop 
object. It is crucial to emphasize that GEM5 necessitates C++ classes to simulate
both macroops and microops, rather than Python objects. Therefore, GEM5 should 
generate CPP implmentations based on the parsed information! Let’s delve into 
how the automatic translation of Python objects into C++ classes can be achieved,
using the ‘MOV_R_MI’ class as an illustrative example.</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
</pre></td><td class="rouge-code"><pre><span class="c1">#gem5/build/X86/arch/x86/generated/decoder-ns.cc.inc
</span>
<span class="o">//</span> <span class="n">Inst</span><span class="p">::</span><span class="nc">MOV</span><span class="p">([</span><span class="sh">'</span><span class="s">rAb</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">Ob</span><span class="sh">'</span><span class="p">],{})</span>

        <span class="n">X86Macroop</span><span class="p">::</span><span class="n">MOV_R_MI</span><span class="p">::</span><span class="nc">MOV_R_MI</span><span class="p">(</span>
                <span class="n">ExtMachInst</span> <span class="n">machInst</span><span class="p">,</span> <span class="n">EmulEnv</span> <span class="n">_env</span><span class="p">)</span>
            <span class="p">:</span> <span class="nc">Macroop</span><span class="p">(</span><span class="sh">"</span><span class="s">mov</span><span class="sh">"</span><span class="p">,</span> <span class="n">machInst</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">_env</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="p">;</span>

                <span class="n">uint64_t</span> <span class="n">adjustedImm</span> <span class="o">=</span> <span class="n">IMMEDIATE</span><span class="p">;</span>
                <span class="o">//</span><span class="n">This</span> <span class="ow">is</span> <span class="n">to</span> <span class="n">pacify</span> <span class="n">gcc</span> <span class="ow">in</span> <span class="n">case</span> <span class="n">the</span> <span class="n">immediate</span> <span class="n">isn</span><span class="sh">'</span><span class="s">t used.
                adjustedImm = adjustedImm;
            ;

                uint64_t adjustedDisp = DISPLACEMENT;
                //This is to pacify gcc in case the displacement isn</span><span class="sh">'</span><span class="n">t</span> <span class="n">used</span><span class="p">.</span>
                <span class="n">adjustedDisp</span> <span class="o">=</span> <span class="n">adjustedDisp</span><span class="p">;</span>
            <span class="p">;</span>
            <span class="n">env</span><span class="p">.</span><span class="nf">setSeg</span><span class="p">(</span><span class="n">machInst</span><span class="p">);</span>
<span class="p">;</span>

        <span class="n">_numSrcRegs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">_numDestRegs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">_numFPDestRegs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">_numVecDestRegs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">_numVecElemDestRegs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">_numVecPredDestRegs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">_numIntDestRegs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">_numCCDestRegs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;;</span>
            <span class="n">const</span> <span class="n">char</span> <span class="o">*</span><span class="n">macrocodeBlock</span> <span class="o">=</span> <span class="sh">"</span><span class="s">MOV_R_MI</span><span class="sh">"</span><span class="p">;</span>
            <span class="o">//</span><span class="n">alloc_microops</span> <span class="ow">is</span> <span class="n">the</span> <span class="n">code</span> <span class="n">that</span> <span class="n">sets</span> <span class="n">up</span> <span class="n">the</span> <span class="n">microops</span>
            <span class="o">//</span><span class="n">array</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">parent</span> <span class="n">class</span><span class="p">.</span>
            <span class="n">microops</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
                <span class="p">(</span><span class="n">env</span><span class="p">.</span><span class="n">addressSize</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span> <span class="err">?</span>
                    <span class="p">(</span><span class="n">StaticInstPtr</span><span class="p">)(</span><span class="n">new</span> <span class="nc">LimmBig</span><span class="p">(</span><span class="n">machInst</span><span class="p">,</span>
                        <span class="n">macrocodeBlock</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="n">ULL</span> <span class="o">&lt;&lt;</span> <span class="n">StaticInst</span><span class="p">::</span><span class="n">IsMicroop</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span><span class="n">ULL</span> <span class="o">&lt;&lt;</span> <span class="n">StaticInst</span><span class="p">::</span><span class="n">IsFirstMicroop</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span><span class="n">ULL</span> <span class="o">&lt;&lt;</span> <span class="n">StaticInst</span><span class="p">::</span><span class="n">IsDelayedCommit</span><span class="p">),</span> <span class="nc">InstRegIndex</span><span class="p">(</span><span class="n">NUM_INTREGS</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">adjustedImm</span><span class="p">,</span>
                        <span class="n">env</span><span class="p">.</span><span class="n">addressSize</span><span class="p">))</span> <span class="p">:</span>
                    <span class="p">(</span><span class="n">StaticInstPtr</span><span class="p">)(</span><span class="n">new</span> <span class="nc">Limm</span><span class="p">(</span><span class="n">machInst</span><span class="p">,</span>
                        <span class="n">macrocodeBlock</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="n">ULL</span> <span class="o">&lt;&lt;</span> <span class="n">StaticInst</span><span class="p">::</span><span class="n">IsMicroop</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span><span class="n">ULL</span> <span class="o">&lt;&lt;</span> <span class="n">StaticInst</span><span class="p">::</span><span class="n">IsFirstMicroop</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span><span class="n">ULL</span> <span class="o">&lt;&lt;</span> <span class="n">StaticInst</span><span class="p">::</span><span class="n">IsDelayedCommit</span><span class="p">),</span> <span class="nc">InstRegIndex</span><span class="p">(</span><span class="n">NUM_INTREGS</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">adjustedImm</span><span class="p">,</span>
                        <span class="n">env</span><span class="p">.</span><span class="n">addressSize</span><span class="p">))</span>
            <span class="p">;</span>
<span class="n">microops</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
                <span class="p">(</span><span class="n">env</span><span class="p">.</span><span class="n">dataSize</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span> <span class="err">?</span>
                    <span class="p">(</span><span class="n">StaticInstPtr</span><span class="p">)(</span><span class="n">new</span> <span class="nc">LdBig</span><span class="p">(</span><span class="n">machInst</span><span class="p">,</span>
                        <span class="n">macrocodeBlock</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="n">ULL</span> <span class="o">&lt;&lt;</span> <span class="n">StaticInst</span><span class="p">::</span><span class="n">IsMicroop</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span><span class="n">ULL</span> <span class="o">&lt;&lt;</span> <span class="n">StaticInst</span><span class="p">::</span><span class="n">IsLastMicroop</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="nc">InstRegIndex</span><span class="p">(</span><span class="n">NUM_INTREGS</span><span class="o">+</span><span class="mi">0</span><span class="p">),</span>
                        <span class="nc">InstRegIndex</span><span class="p">(</span><span class="n">NUM_INTREGS</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="nc">InstRegIndex</span><span class="p">(</span><span class="n">env</span><span class="p">.</span><span class="n">seg</span><span class="p">),</span> <span class="nc">InstRegIndex</span><span class="p">(</span><span class="n">env</span><span class="p">.</span><span class="n">reg</span><span class="p">),</span>
                        <span class="n">env</span><span class="p">.</span><span class="n">dataSize</span><span class="p">,</span> <span class="n">env</span><span class="p">.</span><span class="n">addressSize</span><span class="p">,</span> <span class="mi">0</span> <span class="o">|</span> <span class="p">(</span><span class="n">machInst</span><span class="p">.</span><span class="n">legacy</span><span class="p">.</span><span class="n">addr</span> <span class="err">?</span> <span class="p">(</span><span class="n">AddrSizeFlagBit</span> <span class="o">&lt;&lt;</span> <span class="n">FlagShift</span><span class="p">)</span> <span class="p">:</span> <span class="mi">0</span><span class="p">)))</span> <span class="p">:</span>
                    <span class="p">(</span><span class="n">StaticInstPtr</span><span class="p">)(</span><span class="n">new</span> <span class="nc">Ld</span><span class="p">(</span><span class="n">machInst</span><span class="p">,</span>
                        <span class="n">macrocodeBlock</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="n">ULL</span> <span class="o">&lt;&lt;</span> <span class="n">StaticInst</span><span class="p">::</span><span class="n">IsMicroop</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span><span class="n">ULL</span> <span class="o">&lt;&lt;</span> <span class="n">StaticInst</span><span class="p">::</span><span class="n">IsLastMicroop</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="nc">InstRegIndex</span><span class="p">(</span><span class="n">NUM_INTREGS</span><span class="o">+</span><span class="mi">0</span><span class="p">),</span>
                        <span class="nc">InstRegIndex</span><span class="p">(</span><span class="n">NUM_INTREGS</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="nc">InstRegIndex</span><span class="p">(</span><span class="n">env</span><span class="p">.</span><span class="n">seg</span><span class="p">),</span> <span class="nc">InstRegIndex</span><span class="p">(</span><span class="n">env</span><span class="p">.</span><span class="n">reg</span><span class="p">),</span>
                        <span class="n">env</span><span class="p">.</span><span class="n">dataSize</span><span class="p">,</span> <span class="n">env</span><span class="p">.</span><span class="n">addressSize</span><span class="p">,</span> <span class="mi">0</span> <span class="o">|</span> <span class="p">(</span><span class="n">machInst</span><span class="p">.</span><span class="n">legacy</span><span class="p">.</span><span class="n">addr</span> <span class="err">?</span> <span class="p">(</span><span class="n">AddrSizeFlagBit</span> <span class="o">&lt;&lt;</span> <span class="n">FlagShift</span><span class="p">)</span> <span class="p">:</span> <span class="mi">0</span><span class="p">)))</span>
            <span class="p">;</span>
<span class="p">;</span>
        <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>The class above is generated automatically. Given that we already possess 
Python-based macroop containers defining the ‘MOV_R_MI’ macroop, it follows 
logically that the resulting C++ class is derived from the corresponding Python
class. Since all parsed macroop objects are accessible from the ‘macroopDict,’ 
it would be natural to investigate where the ‘macroopDict’ is employed to 
comprehend the translation process.</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td class="rouge-code"><pre><span class="c1">#gem5/src/arch/x86/isa/macroop.isa
</span>
<span class="n">let</span> <span class="p">{</span>
    <span class="n">doModRMString</span> <span class="o">=</span> <span class="sh">"</span><span class="s">env.doModRM(machInst);</span><span class="se">\n</span><span class="sh">"</span>
    <span class="n">noModRMString</span> <span class="o">=</span> <span class="sh">"</span><span class="s">env.setSeg(machInst);</span><span class="se">\n</span><span class="sh">"</span>
    <span class="k">def</span> <span class="nf">genMacroop</span><span class="p">(</span><span class="n">Name</span><span class="p">,</span> <span class="n">env</span><span class="p">):</span>
        <span class="n">blocks</span> <span class="o">=</span> <span class="nc">OutputBlocks</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">Name</span> <span class="ow">in</span> <span class="n">macroopDict</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nb">Exception</span><span class="p">,</span> <span class="sh">"</span><span class="s">Unrecognized instruction: %s</span><span class="sh">"</span> <span class="o">%</span> <span class="n">Name</span>
        <span class="n">macroop</span> <span class="o">=</span> <span class="n">macroopDict</span><span class="p">[</span><span class="n">Name</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">macroop</span><span class="p">.</span><span class="n">declared</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">env</span><span class="p">.</span><span class="n">doModRM</span><span class="p">:</span>
                <span class="n">macroop</span><span class="p">.</span><span class="n">initEnv</span> <span class="o">=</span> <span class="n">doModRMString</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">macroop</span><span class="p">.</span><span class="n">initEnv</span> <span class="o">=</span> <span class="n">noModRMString</span>
            <span class="n">blocks</span><span class="p">.</span><span class="n">header_output</span> <span class="o">=</span> <span class="n">macroop</span><span class="p">.</span><span class="nf">getDeclaration</span><span class="p">()</span>
            <span class="n">blocks</span><span class="p">.</span><span class="n">decoder_output</span> <span class="o">=</span> <span class="n">macroop</span><span class="p">.</span><span class="nf">getDefinition</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
            <span class="n">macroop</span><span class="p">.</span><span class="n">declared</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">blocks</span><span class="p">.</span><span class="n">decode_block</span> <span class="o">=</span> <span class="sh">"</span><span class="s">return %s;</span><span class="se">\n</span><span class="sh">"</span> <span class="o">%</span> <span class="n">macroop</span><span class="p">.</span><span class="nf">getAllocator</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">blocks</span>
<span class="p">};</span>
</pre></td></tr></tbody></table></code></div></div>
<p>As illustrated in the provided code, the ‘genMacroop’ function retrieves the
macroop object associated with the name of a particular macroop. Subsequently, 
it invokes the ‘getDeclaration,’ ‘getDefinition,’ and ‘getAllocator’ functions 
of the obtained macroop object. It is important to note that the object obtained 
in this process is an instance of the ‘X86Macroop’ Python class, specifically 
linked to the ‘MOV_R_MI’ macroop.</p>

<h3 id="getdefinition-generating-c-class-definition-for-macroop"><span class="me-2">getDefinition: generating C++ class definition for macroop</span><a href="#getdefinition-generating-c-class-definition-for-macroop" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
</pre></td><td class="rouge-code"><pre><span class="c1">#gem5/src/arch/x86/isa/macroop.isa
</span>    <span class="k">class</span> <span class="nc">X86Macroop</span><span class="p">(</span><span class="n">Combinational_Macroop</span><span class="p">):</span>
        <span class="p">...</span><span class="bp">...</span>
        <span class="k">def</span> <span class="nf">getDefinition</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">env</span><span class="p">):</span>
            <span class="n">numMicroops</span> <span class="o">=</span> <span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">microops</span><span class="p">)</span>
            <span class="n">allocMicroops</span> <span class="o">=</span> <span class="sh">''</span>
            <span class="n">micropc</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">microops</span><span class="p">:</span>
                <span class="n">flags</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">IsMicroop</span><span class="sh">"</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">micropc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">flags</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sh">"</span><span class="s">IsFirstMicroop</span><span class="sh">"</span><span class="p">)</span>
            
                    <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">serialize_before</span><span class="p">:</span>
                        <span class="n">flags</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sh">"</span><span class="s">IsSerializing</span><span class="sh">"</span><span class="p">)</span>
                        <span class="n">flags</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sh">"</span><span class="s">IsSerializeBefore</span><span class="sh">"</span><span class="p">)</span>
                    
                <span class="k">if</span> <span class="n">micropc</span> <span class="o">==</span> <span class="n">numMicroops</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">flags</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sh">"</span><span class="s">IsLastMicroop</span><span class="sh">"</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">serialize_after</span><span class="p">:</span>
                        <span class="n">flags</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sh">"</span><span class="s">IsSerializing</span><span class="sh">"</span><span class="p">)</span>
                        <span class="n">flags</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sh">"</span><span class="s">IsSerializeAfter</span><span class="sh">"</span><span class="p">)</span>
    
                    <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">function_call</span><span class="p">:</span>
                        <span class="n">flags</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sh">"</span><span class="s">IsCall</span><span class="sh">"</span><span class="p">)</span>
                        <span class="n">flags</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sh">"</span><span class="s">IsUncondControl</span><span class="sh">"</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">function_return</span><span class="p">:</span>
                        <span class="n">flags</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sh">"</span><span class="s">IsReturn</span><span class="sh">"</span><span class="p">)</span>
                        <span class="n">flags</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sh">"</span><span class="s">IsUncondControl</span><span class="sh">"</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">control_direct</span><span class="p">:</span>
                        <span class="n">flags</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sh">"</span><span class="s">IsDirectControl</span><span class="sh">"</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">control_indirect</span><span class="p">:</span>
                        <span class="n">flags</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sh">"</span><span class="s">IsIndirectControl</span><span class="sh">"</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">flags</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sh">"</span><span class="s">IsDelayedCommit</span><span class="sh">"</span><span class="p">)</span>
        
                <span class="n">allocMicroops</span> <span class="o">+=</span> \
                    <span class="sh">"</span><span class="s">microops[%d] = %s;</span><span class="se">\n</span><span class="sh">"</span> <span class="o">%</span> \
                    <span class="p">(</span><span class="n">micropc</span><span class="p">,</span> <span class="n">op</span><span class="p">.</span><span class="nf">getAllocator</span><span class="p">(</span><span class="n">flags</span><span class="p">))</span>
                <span class="n">micropc</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">env</span><span class="p">.</span><span class="n">useStackSize</span><span class="p">:</span>
                <span class="n">useStackSize</span> <span class="o">=</span> <span class="sh">"</span><span class="s">true</span><span class="sh">"</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">useStackSize</span> <span class="o">=</span> <span class="sh">"</span><span class="s">false</span><span class="sh">"</span>
            <span class="k">if</span> <span class="n">env</span><span class="p">.</span><span class="n">memoryInst</span><span class="p">:</span>
                <span class="n">memoryInst</span> <span class="o">=</span> <span class="sh">"</span><span class="s">true</span><span class="sh">"</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">memoryInst</span> <span class="o">=</span> <span class="sh">"</span><span class="s">false</span><span class="sh">"</span>
            <span class="n">regSize</span> <span class="o">=</span> <span class="sh">'''</span><span class="s">(%s || (env.base == INTREG_RSP &amp;&amp; %s) ?
                         env.stackSize :
                         env.dataSize)</span><span class="sh">'''</span> <span class="o">%</span> <span class="p">(</span><span class="n">useStackSize</span><span class="p">,</span> <span class="n">memoryInst</span><span class="p">)</span>
            <span class="n">iop</span> <span class="o">=</span> <span class="nc">InstObjParams</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="nf">getMnemonic</span><span class="p">(),</span> <span class="n">self</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">Macroop</span><span class="sh">"</span><span class="p">,</span>
                                <span class="p">{</span><span class="sh">"</span><span class="s">code</span><span class="sh">"</span> <span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">num_microops</span><span class="sh">"</span> <span class="p">:</span> <span class="n">numMicroops</span><span class="p">,</span>
                                 <span class="sh">"</span><span class="s">alloc_microops</span><span class="sh">"</span> <span class="p">:</span> <span class="n">allocMicroops</span><span class="p">,</span>
                                 <span class="sh">"</span><span class="s">adjust_env</span><span class="sh">"</span> <span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">adjust_env</span><span class="p">,</span>
                                 <span class="sh">"</span><span class="s">adjust_imm</span><span class="sh">"</span> <span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">adjust_imm</span><span class="p">,</span>
                                 <span class="sh">"</span><span class="s">adjust_disp</span><span class="sh">"</span> <span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">adjust_disp</span><span class="p">,</span>
                                 <span class="sh">"</span><span class="s">disassembly</span><span class="sh">"</span> <span class="p">:</span> <span class="n">env</span><span class="p">.</span><span class="n">disassembly</span><span class="p">,</span>
                                 <span class="sh">"</span><span class="s">regSize</span><span class="sh">"</span> <span class="p">:</span> <span class="n">regSize</span><span class="p">,</span>
                                 <span class="sh">"</span><span class="s">init_env</span><span class="sh">"</span> <span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">initEnv</span><span class="p">})</span>
            <span class="k">return</span> <span class="n">MacroConstructor</span><span class="p">.</span><span class="nf">subst</span><span class="p">(</span><span class="n">iop</span><span class="p">)</span> <span class="o">+</span> \
                   <span class="n">MacroDisassembly</span><span class="p">.</span><span class="nf">subst</span><span class="p">(</span><span class="n">iop</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></div></div>

<p>The primary objective of the getDefinition function is to produce the CPP class
implementation for the macroop. In the context of X86, the semantics of a macroop 
are defined by the microops that compose it. Consequently, it is essential for 
the macroop’s constructor to properly initialize its microops consisting of the 
macroop.</p>

<blockquote class="prompt-info">
  <p>The Python classes representing microops, which together form a macroop, are
stored in the self.microops attribute of the X86Macroop object</p>
</blockquote>

<p>Considering that a macroop can comprise multiple microops, it is imperative to 
iterate through each Python microop class separately to generate the instantiation 
code for the corresponding C++ microop classes. It’s important to highlight that
in the provided code, the variable <em>op</em> represents each Python class object of a 
microop constituting the macroop.</p>

<p>Just as each macroop can be translated into a CPP class, all microops are similarly
transformed into CPP. Consequently, to instantiate CPP class objects for the 
<strong>microops</strong> constituting the current macroop, it is necessary to determine which
CPP class of the microops should be instantiated. The code responsible for creating
an instance of each microop CPP class is retrieved from the <em>getAllocator</em> method 
of each Python microop class. The resulting code, which instantiates the microops,
is stored in the <em>allocMicroops</em> variable.</p>

<h4 id="getallocator-retrieve-microop-class-instantiation-code"><span class="me-2">getAllocator: retrieve microop class instantiation code</span><a href="#getallocator-retrieve-microop-class-instantiation-code" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4>
<p>The <em>getAllocator</em> function, within the microop Python class, is responsible for
generating C++ statements that create instances of C++ microop class objects. 
In our specific case, where our interest lies in the Limm microcode of the 
MOV_R_MI macroop, we will delve into how the <em>getAllocator</em> function of the 
<em>LimmOp</em> class is responsible for generating the corresponding C++ code.</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td class="rouge-code"><pre><span class="c1">#gem5/src/arch/x86/isa/microops/limmop.isa
</span>
<span class="mi">106</span>     <span class="k">class</span> <span class="nc">LimmOp</span><span class="p">(</span><span class="n">X86Microop</span><span class="p">):</span>
<span class="bp">...</span>
<span class="mi">116</span>         <span class="k">def</span> <span class="nf">getAllocator</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">microFlags</span><span class="p">):</span>
<span class="mi">117</span>             <span class="n">allocString</span> <span class="o">=</span> <span class="sh">'''</span><span class="s">
118                 (%(dataSize)s &gt;= 4) ?
119                     (StaticInstPtr)(new %(class_name)sBig(machInst,
120                         macrocodeBlock, %(flags)s, %(dest)s, %(imm)s,
121                         %(dataSize)s)) :
122                     (StaticInstPtr)(new %(class_name)s(machInst,
123                         macrocodeBlock, %(flags)s, %(dest)s, %(imm)s,
124                         %(dataSize)s))
125             </span><span class="sh">'''</span>
<span class="mi">126</span>             <span class="n">allocator</span> <span class="o">=</span> <span class="n">allocString</span> <span class="o">%</span> <span class="p">{</span>
<span class="mi">127</span>                 <span class="sh">"</span><span class="s">class_name</span><span class="sh">"</span> <span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">className</span><span class="p">,</span>
<span class="mi">128</span>                 <span class="sh">"</span><span class="s">mnemonic</span><span class="sh">"</span> <span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">mnemonic</span><span class="p">,</span>
<span class="mi">129</span>                 <span class="sh">"</span><span class="s">flags</span><span class="sh">"</span> <span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="nf">microFlagsText</span><span class="p">(</span><span class="n">microFlags</span><span class="p">),</span>
<span class="mi">130</span>                 <span class="sh">"</span><span class="s">dest</span><span class="sh">"</span> <span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">dest</span><span class="p">,</span> <span class="sh">"</span><span class="s">imm</span><span class="sh">"</span> <span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">imm</span><span class="p">,</span>
<span class="mi">131</span>                 <span class="sh">"</span><span class="s">dataSize</span><span class="sh">"</span> <span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">dataSize</span><span class="p">}</span>
<span class="mi">132</span>             <span class="k">return</span> <span class="n">allocator</span>
</pre></td></tr></tbody></table></code></div></div>

<p>The <em>getAllocator</em> function within the LimmOp Python class is responsible for
generating a Python docstring called <em>allocString</em>, which includes C++ formatted
code for instantiating microop objects. It’s important to note that the string 
contains format specifiers that need to be replaced with the appropriate values 
of the microop. The majority of the substituted content is derived from the 
attributes of the Python microop class.</p>

<p>When an instance of the LimmOp Python class is created, microop-specific operands
like ‘dest’ and ‘imm’ are passed to the constructor of the LimmOp Python class. 
Recall how ‘eval’ translates the microop’s operands and creates the associated 
Python object. For instance, the <em>className</em> is set as ‘Limm’. It indicates that 
there should be a corresponding ‘Limm’ C++ class that can be instantiated. The
‘Limm’ C++ class is also automatically generated by GEM5.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td class="rouge-code"><pre><span class="c1">//gem5/build/X86/arch/x86/generated/decoder-ns.hh.inc</span>

    <span class="k">class</span> <span class="nc">Limm</span> <span class="o">:</span> <span class="k">public</span> <span class="n">X86ISA</span><span class="o">::</span><span class="n">X86MicroopBase</span>
    <span class="p">{</span>
      <span class="nl">protected:</span>
        <span class="k">const</span> <span class="n">RegIndex</span> <span class="n">dest</span><span class="p">;</span>
        <span class="k">const</span> <span class="kt">uint64_t</span> <span class="n">imm</span><span class="p">;</span>
        <span class="k">const</span> <span class="kt">uint8_t</span> <span class="n">dataSize</span><span class="p">;</span>
        <span class="n">RegIndex</span> <span class="n">foldOBit</span><span class="p">;</span>

        <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">generateDisassembly</span><span class="p">(</span><span class="n">Addr</span> <span class="n">pc</span><span class="p">,</span>
            <span class="k">const</span> <span class="n">SymbolTable</span> <span class="o">*</span><span class="n">symtab</span><span class="p">)</span> <span class="k">const</span><span class="p">;</span>

      <span class="nl">public:</span>
        <span class="n">Limm</span><span class="p">(</span><span class="n">ExtMachInst</span> <span class="n">_machInst</span><span class="p">,</span>
                <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">instMnem</span><span class="p">,</span>
                <span class="kt">uint64_t</span> <span class="n">setFlags</span><span class="p">,</span> <span class="n">InstRegIndex</span> <span class="n">_dest</span><span class="p">,</span>
                <span class="kt">uint64_t</span> <span class="n">_imm</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">_dataSize</span><span class="p">);</span>

        <span class="n">Fault</span> <span class="n">execute</span><span class="p">(</span><span class="n">ExecContext</span> <span class="o">*</span><span class="p">,</span> <span class="n">Trace</span><span class="o">::</span><span class="n">InstRecord</span> <span class="o">*</span><span class="p">)</span> <span class="k">const</span><span class="p">;</span>
    <span class="p">};</span>
</pre></td></tr></tbody></table></code></div></div>
<p>For further details about microop, please wait for next posting!</p>

<h4 id="finalize-macroop-class-definition-with-template-substitution"><span class="me-2">Finalize Macroop class definition with template substitution</span><a href="#finalize-macroop-class-definition-with-template-substitution" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4>
<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
</pre></td><td class="rouge-code"><pre><span class="c1">#gem5/src/arch/x86/isa/macroop.isa                                              
</span>
<span class="k">def</span> <span class="nf">template</span> <span class="n">MacroConstructor</span> <span class="p">{</span>
        <span class="n">X86Macroop</span><span class="p">::</span><span class="o">%</span><span class="p">(</span><span class="n">class_name</span><span class="p">)</span><span class="n">s</span><span class="p">::</span><span class="o">%</span><span class="p">(</span><span class="n">class_name</span><span class="p">)</span><span class="nf">s</span><span class="p">(</span>
                <span class="n">ExtMachInst</span> <span class="n">machInst</span><span class="p">,</span> <span class="n">EmulEnv</span> <span class="n">_env</span><span class="p">)</span>
            <span class="p">:</span> <span class="o">%</span><span class="p">(</span><span class="n">base_class</span><span class="p">)</span><span class="nf">s</span><span class="p">(</span><span class="sh">"</span><span class="s">%(mnemonic)s</span><span class="sh">"</span><span class="p">,</span> <span class="n">machInst</span><span class="p">,</span> <span class="o">%</span><span class="p">(</span><span class="n">num_microops</span><span class="p">)</span><span class="n">s</span><span class="p">,</span> <span class="n">_env</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="o">%</span><span class="p">(</span><span class="n">adjust_env</span><span class="p">)</span><span class="n">s</span><span class="p">;</span>
            <span class="o">%</span><span class="p">(</span><span class="n">adjust_imm</span><span class="p">)</span><span class="n">s</span><span class="p">;</span>
            <span class="o">%</span><span class="p">(</span><span class="n">adjust_disp</span><span class="p">)</span><span class="n">s</span><span class="p">;</span>
            <span class="o">%</span><span class="p">(</span><span class="n">init_env</span><span class="p">)</span><span class="n">s</span><span class="p">;</span>
            <span class="o">%</span><span class="p">(</span><span class="n">constructor</span><span class="p">)</span><span class="n">s</span><span class="p">;</span>
            <span class="n">const</span> <span class="n">char</span> <span class="o">*</span><span class="n">macrocodeBlock</span> <span class="o">=</span> <span class="sh">"</span><span class="s">%(class_name)s</span><span class="sh">"</span><span class="p">;</span>
            <span class="o">//</span><span class="n">alloc_microops</span> <span class="ow">is</span> <span class="n">the</span> <span class="n">code</span> <span class="n">that</span> <span class="n">sets</span> <span class="n">up</span> <span class="n">the</span> <span class="n">microops</span>
            <span class="o">//</span><span class="n">array</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">parent</span> <span class="n">class</span><span class="p">.</span>
            <span class="o">%</span><span class="p">(</span><span class="n">alloc_microops</span><span class="p">)</span><span class="n">s</span><span class="p">;</span>
        <span class="p">}</span>       
<span class="p">};</span>         

<span class="k">def</span> <span class="nf">template</span> <span class="n">MacroDisassembly</span> <span class="p">{</span>
    <span class="n">std</span><span class="p">::</span><span class="n">string</span>
    <span class="n">X86Macroop</span><span class="p">::</span><span class="o">%</span><span class="p">(</span><span class="n">class_name</span><span class="p">)</span><span class="n">s</span><span class="p">::</span><span class="nf">generateDisassembly</span><span class="p">(</span>
            <span class="n">Addr</span> <span class="n">pc</span><span class="p">,</span> <span class="n">const</span> <span class="n">Loader</span><span class="p">::</span><span class="n">SymbolTable</span> <span class="o">*</span><span class="n">symtab</span><span class="p">)</span> <span class="n">const</span>
    <span class="p">{</span>
        <span class="n">std</span><span class="p">::</span><span class="n">stringstream</span> <span class="n">out</span><span class="p">;</span>
        <span class="n">out</span> <span class="o">&lt;&lt;</span> <span class="n">mnemonic</span> <span class="o">&lt;&lt;</span> <span class="sh">"</span><span class="se">\t</span><span class="sh">"</span><span class="p">;</span>

        <span class="nb">int</span> <span class="n">regSize</span> <span class="o">=</span> <span class="o">%</span><span class="p">(</span><span class="n">regSize</span><span class="p">)</span><span class="n">s</span><span class="p">;</span>
        <span class="o">%</span><span class="p">(</span><span class="n">disassembly</span><span class="p">)</span><span class="n">s</span>
        <span class="o">//</span> <span class="n">Shut</span> <span class="n">up</span> <span class="n">gcc</span><span class="p">.</span>
        <span class="n">regSize</span> <span class="o">=</span> <span class="n">regSize</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">out</span><span class="p">.</span><span class="nf">str</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">};</span>


    <span class="k">class</span> <span class="nc">X86Macroop</span><span class="p">(</span><span class="n">Combinational_Macroop</span><span class="p">):</span> 
            <span class="n">iop</span> <span class="o">=</span> <span class="nc">InstObjParams</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="nf">getMnemonic</span><span class="p">(),</span> <span class="n">self</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">Macroop</span><span class="sh">"</span><span class="p">,</span>       
                                <span class="p">{</span><span class="sh">"</span><span class="s">code</span><span class="sh">"</span> <span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">num_microops</span><span class="sh">"</span> <span class="p">:</span> <span class="n">numMicroops</span><span class="p">,</span>     
                                 <span class="sh">"</span><span class="s">alloc_microops</span><span class="sh">"</span> <span class="p">:</span> <span class="n">allocMicroops</span><span class="p">,</span>              
                                 <span class="sh">"</span><span class="s">adjust_env</span><span class="sh">"</span> <span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">adjust_env</span><span class="p">,</span>                
                                 <span class="sh">"</span><span class="s">adjust_imm</span><span class="sh">"</span> <span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">adjust_imm</span><span class="p">,</span>                
                                 <span class="sh">"</span><span class="s">adjust_disp</span><span class="sh">"</span> <span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">adjust_disp</span><span class="p">,</span>              
                                 <span class="sh">"</span><span class="s">disassembly</span><span class="sh">"</span> <span class="p">:</span> <span class="n">env</span><span class="p">.</span><span class="n">disassembly</span><span class="p">,</span>               
                                 <span class="sh">"</span><span class="s">regSize</span><span class="sh">"</span> <span class="p">:</span> <span class="n">regSize</span><span class="p">,</span>                           
                                 <span class="sh">"</span><span class="s">init_env</span><span class="sh">"</span> <span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">initEnv</span><span class="p">})</span>                    
            <span class="k">return</span> <span class="n">MacroConstructor</span><span class="p">.</span><span class="nf">subst</span><span class="p">(</span><span class="n">iop</span><span class="p">)</span> <span class="o">+</span> \                              
                   <span class="n">MacroDisassembly</span><span class="p">.</span><span class="nf">subst</span><span class="p">(</span><span class="n">iop</span><span class="p">);</span>         
</pre></td></tr></tbody></table></code></div></div>

<p>I haven’t covered the <strong>def template block</strong> yet, but when you look at the 
automatically generated macroop class definitions in CPP, it will have similar 
code skeleton presented in <strong>MacroConstructor</strong>. It is used for generating CPP 
class for macroop! Based on the passed parameter InstObjParams, it substitutes
the template and generate the CPP code! It’s worth noting that the placeholder 
%(alloc_microops)s gets substituted with the constructor code for the microop 
classes that were generated by the previous getAllocator method. The 
MacroDisassembly template is used to automatically introduce member function
<em>generateDisassembly</em> to automatically generated macroop class. 
If you are interested in def template block, please bear with me I will explain 
the details of the def template in the next post.</p>

<h2 id="appendix"><span class="me-2">Appendix</span><a href="#appendix" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<h4 id="symbols-of-parser"><span class="me-2">Symbols of parser</span><a href="#symbols-of-parser" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4>
<p>When discussing the translation of microop’s operands, I didn’t delve into the 
details of how this translation takes place. As mentioned earlier, 
‘parser.symbols’ serves as a dictionary that associates particular strings with
corresponding code statements. The string argument of the microop comprises 
operands like ‘rax,’ ‘rbx,’ ‘t1,’ ‘t2,’ and so on. However, these operands must
be converted into the appropriate code statements for register references, such
as ‘InstRegIndex(NUM_INTREGS+1).’ The mapping between one register to code 
referencing it is defined within the ‘parser.symbols’ dictionary.</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
</pre></td><td class="rouge-code"><pre><span class="c1">#gem5/src/arch/x86/isa/microasm.isa
</span>
 <span class="mi">61</span>     <span class="k">def</span> <span class="nf">regIdx</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
 <span class="mi">62</span>         <span class="k">return</span> <span class="sh">"</span><span class="s">InstRegIndex(%s)</span><span class="sh">"</span> <span class="o">%</span> <span class="n">idx</span>
 <span class="mi">63</span>
 <span class="mi">64</span>     <span class="n">assembler</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="sh">"</span><span class="s">regIdx</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">regIdx</span>
 <span class="mi">65</span>
 <span class="mi">66</span>     <span class="c1"># Add in symbols for the microcode registers
</span> <span class="mi">67</span>     <span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">16</span><span class="p">):</span>
 <span class="mi">68</span>         <span class="n">assembler</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="sh">"</span><span class="s">t%d</span><span class="sh">"</span> <span class="o">%</span> <span class="n">num</span><span class="p">]</span> <span class="o">=</span> <span class="nf">regIdx</span><span class="p">(</span><span class="sh">"</span><span class="s">NUM_INTREGS+%d</span><span class="sh">"</span> <span class="o">%</span> <span class="n">num</span><span class="p">)</span>
 <span class="mi">69</span>     <span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span>
 <span class="mi">70</span>         <span class="n">assembler</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="sh">"</span><span class="s">ufp%d</span><span class="sh">"</span> <span class="o">%</span> <span class="n">num</span><span class="p">]</span> <span class="o">=</span> \
 <span class="mi">71</span>             <span class="nf">regIdx</span><span class="p">(</span><span class="sh">"</span><span class="s">FLOATREG_MICROFP(%d)</span><span class="sh">"</span> <span class="o">%</span> <span class="n">num</span><span class="p">)</span>
 <span class="mi">72</span>     <span class="c1"># Add in symbols for the segment descriptor registers
</span> <span class="mi">73</span>     <span class="k">for</span> <span class="n">letter</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">C</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">D</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">E</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">F</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">G</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">H</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">S</span><span class="sh">"</span><span class="p">):</span>
 <span class="mi">74</span>         <span class="n">assembler</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="sh">"</span><span class="s">%ss</span><span class="sh">"</span> <span class="o">%</span> <span class="n">letter</span><span class="p">.</span><span class="nf">lower</span><span class="p">()]</span> <span class="o">=</span> \
 <span class="mi">75</span>             <span class="nf">regIdx</span><span class="p">(</span><span class="sh">"</span><span class="s">SEGMENT_REG_%sS</span><span class="sh">"</span> <span class="o">%</span> <span class="n">letter</span><span class="p">)</span>
 <span class="mi">76</span>
 <span class="mi">77</span>     <span class="c1"># Add in symbols for the various checks of segment selectors.
</span> <span class="mi">78</span>     <span class="k">for</span> <span class="n">check</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">NoCheck</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">CSCheck</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">CallGateCheck</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">IntGateCheck</span><span class="sh">"</span><span class="p">,</span>
 <span class="mi">79</span>                   <span class="sh">"</span><span class="s">SoftIntGateCheck</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">SSCheck</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">IretCheck</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">IntCSCheck</span><span class="sh">"</span><span class="p">,</span>
 <span class="mi">80</span>                   <span class="sh">"</span><span class="s">TRCheck</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">TSSCheck</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">InGDTCheck</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">LDTCheck</span><span class="sh">"</span><span class="p">):</span>
 <span class="mi">81</span>         <span class="n">assembler</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="n">check</span><span class="p">]</span> <span class="o">=</span> <span class="sh">"</span><span class="s">Seg%s</span><span class="sh">"</span> <span class="o">%</span> <span class="n">check</span>
 <span class="mi">82</span>
 <span class="mi">83</span>     <span class="k">for</span> <span class="n">reg</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">TR</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">IDTR</span><span class="sh">"</span><span class="p">):</span>
 <span class="mi">84</span>         <span class="n">assembler</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="n">reg</span><span class="p">.</span><span class="nf">lower</span><span class="p">()]</span> <span class="o">=</span> <span class="nf">regIdx</span><span class="p">(</span><span class="sh">"</span><span class="s">SYS_SEGMENT_REG_%s</span><span class="sh">"</span> <span class="o">%</span> <span class="n">reg</span><span class="p">)</span>
 <span class="mi">85</span>
 <span class="mi">86</span>     <span class="k">for</span> <span class="n">reg</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">TSL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">TSG</span><span class="sh">"</span><span class="p">):</span>
 <span class="mi">87</span>         <span class="n">assembler</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="n">reg</span><span class="p">.</span><span class="nf">lower</span><span class="p">()]</span> <span class="o">=</span> <span class="nf">regIdx</span><span class="p">(</span><span class="sh">"</span><span class="s">SEGMENT_REG_%s</span><span class="sh">"</span> <span class="o">%</span> <span class="n">reg</span><span class="p">)</span>
 <span class="mi">88</span>
 <span class="mi">89</span>     <span class="c1"># Miscellaneous symbols
</span> <span class="mi">90</span>     <span class="n">symbols</span> <span class="o">=</span> <span class="p">{</span>
 <span class="mi">91</span>         <span class="sh">"</span><span class="s">reg</span><span class="sh">"</span> <span class="p">:</span> <span class="nf">regIdx</span><span class="p">(</span><span class="sh">"</span><span class="s">env.reg</span><span class="sh">"</span><span class="p">),</span>
 <span class="mi">92</span>         <span class="sh">"</span><span class="s">xmml</span><span class="sh">"</span> <span class="p">:</span> <span class="nf">regIdx</span><span class="p">(</span><span class="sh">"</span><span class="s">FLOATREG_XMM_LOW(env.reg)</span><span class="sh">"</span><span class="p">),</span>
 <span class="mi">93</span>         <span class="sh">"</span><span class="s">xmmh</span><span class="sh">"</span> <span class="p">:</span> <span class="nf">regIdx</span><span class="p">(</span><span class="sh">"</span><span class="s">FLOATREG_XMM_HIGH(env.reg)</span><span class="sh">"</span><span class="p">),</span>
 <span class="mi">94</span>         <span class="sh">"</span><span class="s">regm</span><span class="sh">"</span> <span class="p">:</span> <span class="nf">regIdx</span><span class="p">(</span><span class="sh">"</span><span class="s">env.regm</span><span class="sh">"</span><span class="p">),</span>
 <span class="mi">95</span>         <span class="sh">"</span><span class="s">xmmlm</span><span class="sh">"</span> <span class="p">:</span> <span class="nf">regIdx</span><span class="p">(</span><span class="sh">"</span><span class="s">FLOATREG_XMM_LOW(env.regm)</span><span class="sh">"</span><span class="p">),</span>
 <span class="mi">96</span>         <span class="sh">"</span><span class="s">xmmhm</span><span class="sh">"</span> <span class="p">:</span> <span class="nf">regIdx</span><span class="p">(</span><span class="sh">"</span><span class="s">FLOATREG_XMM_HIGH(env.regm)</span><span class="sh">"</span><span class="p">),</span>
 <span class="mi">97</span>         <span class="sh">"</span><span class="s">mmx</span><span class="sh">"</span> <span class="p">:</span> <span class="nf">regIdx</span><span class="p">(</span><span class="sh">"</span><span class="s">FLOATREG_MMX(env.reg)</span><span class="sh">"</span><span class="p">),</span>
 <span class="mi">98</span>         <span class="sh">"</span><span class="s">mmxm</span><span class="sh">"</span> <span class="p">:</span> <span class="nf">regIdx</span><span class="p">(</span><span class="sh">"</span><span class="s">FLOATREG_MMX(env.regm)</span><span class="sh">"</span><span class="p">),</span>
 <span class="mi">99</span>         <span class="sh">"</span><span class="s">imm</span><span class="sh">"</span> <span class="p">:</span> <span class="sh">"</span><span class="s">adjustedImm</span><span class="sh">"</span><span class="p">,</span>
<span class="mi">100</span>         <span class="sh">"</span><span class="s">disp</span><span class="sh">"</span> <span class="p">:</span> <span class="sh">"</span><span class="s">adjustedDisp</span><span class="sh">"</span><span class="p">,</span>
<span class="mi">101</span>         <span class="sh">"</span><span class="s">seg</span><span class="sh">"</span> <span class="p">:</span> <span class="nf">regIdx</span><span class="p">(</span><span class="sh">"</span><span class="s">env.seg</span><span class="sh">"</span><span class="p">),</span>
<span class="mi">102</span>         <span class="sh">"</span><span class="s">scale</span><span class="sh">"</span> <span class="p">:</span> <span class="sh">"</span><span class="s">env.scale</span><span class="sh">"</span><span class="p">,</span>
<span class="mi">103</span>         <span class="sh">"</span><span class="s">index</span><span class="sh">"</span> <span class="p">:</span> <span class="nf">regIdx</span><span class="p">(</span><span class="sh">"</span><span class="s">env.index</span><span class="sh">"</span><span class="p">),</span>
<span class="mi">104</span>         <span class="sh">"</span><span class="s">base</span><span class="sh">"</span> <span class="p">:</span> <span class="nf">regIdx</span><span class="p">(</span><span class="sh">"</span><span class="s">env.base</span><span class="sh">"</span><span class="p">),</span>
<span class="mi">105</span>         <span class="sh">"</span><span class="s">dsz</span><span class="sh">"</span> <span class="p">:</span> <span class="sh">"</span><span class="s">env.dataSize</span><span class="sh">"</span><span class="p">,</span>
<span class="mi">106</span>         <span class="sh">"</span><span class="s">asz</span><span class="sh">"</span> <span class="p">:</span> <span class="sh">"</span><span class="s">env.addressSize</span><span class="sh">"</span><span class="p">,</span>
<span class="mi">107</span>         <span class="sh">"</span><span class="s">ssz</span><span class="sh">"</span> <span class="p">:</span> <span class="sh">"</span><span class="s">env.stackSize</span><span class="sh">"</span>
<span class="mi">108</span>     <span class="p">}</span>
<span class="mi">109</span>     <span class="n">assembler</span><span class="p">.</span><span class="n">symbols</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">symbols</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></div></div>

<p>As we examine the provided code snippet, which is a component of the symbol 
update process, we can observe that different register is mapped to different 
code that can reference that specific register. These symbols play a crucial 
role in converting strings into actual reference code.</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre></td><td class="rouge-code"><pre><span class="c1">#gem5/src/arch/x86/isa/microops/limop.isa
</span>
<span class="mi">105</span> <span class="n">let</span> <span class="p">{</span>
<span class="mi">106</span>     <span class="k">class</span> <span class="nc">LimmOp</span><span class="p">(</span><span class="n">X86Microop</span><span class="p">):</span>
<span class="mi">107</span>         <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">imm</span><span class="p">,</span> <span class="n">dataSize</span><span class="o">=</span><span class="sh">"</span><span class="s">env.dataSize</span><span class="sh">"</span><span class="p">):</span>
<span class="mi">108</span>             <span class="n">self</span><span class="p">.</span><span class="n">className</span> <span class="o">=</span> <span class="sh">"</span><span class="s">Limm</span><span class="sh">"</span>
<span class="mi">109</span>             <span class="n">self</span><span class="p">.</span><span class="n">mnemonic</span> <span class="o">=</span> <span class="sh">"</span><span class="s">limm</span><span class="sh">"</span>
<span class="mi">110</span>             <span class="n">self</span><span class="p">.</span><span class="n">dest</span> <span class="o">=</span> <span class="n">dest</span>
<span class="mi">111</span>             <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">imm</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">long</span><span class="p">)):</span>
<span class="mi">112</span>                 <span class="n">imm</span> <span class="o">=</span> <span class="sh">"</span><span class="s">ULL(%d)</span><span class="sh">"</span> <span class="o">%</span> <span class="n">imm</span>
<span class="mi">113</span>             <span class="n">self</span><span class="p">.</span><span class="n">imm</span> <span class="o">=</span> <span class="n">imm</span>
<span class="mi">114</span>             <span class="n">self</span><span class="p">.</span><span class="n">dataSize</span> <span class="o">=</span> <span class="n">dataSize</span>
<span class="mi">115</span>
<span class="mi">116</span>         <span class="k">def</span> <span class="nf">getAllocator</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">microFlags</span><span class="p">):</span>
<span class="mi">117</span>             <span class="n">allocString</span> <span class="o">=</span> <span class="sh">'''</span><span class="s">
118                 (%(dataSize)s &gt;= 4) ?
119                     (StaticInstPtr)(new %(class_name)sBig(machInst,
120                         macrocodeBlock, %(flags)s, %(dest)s, %(imm)s,
121                         %(dataSize)s)) :
122                     (StaticInstPtr)(new %(class_name)s(machInst,
123                         macrocodeBlock, %(flags)s, %(dest)s, %(imm)s,
124                         %(dataSize)s))
125             </span><span class="sh">'''</span>
<span class="mi">126</span>             <span class="n">allocator</span> <span class="o">=</span> <span class="n">allocString</span> <span class="o">%</span> <span class="p">{</span>
<span class="mi">127</span>                 <span class="sh">"</span><span class="s">class_name</span><span class="sh">"</span> <span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">className</span><span class="p">,</span>
<span class="mi">128</span>                 <span class="sh">"</span><span class="s">mnemonic</span><span class="sh">"</span> <span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">mnemonic</span><span class="p">,</span>
<span class="mi">129</span>                 <span class="sh">"</span><span class="s">flags</span><span class="sh">"</span> <span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="nf">microFlagsText</span><span class="p">(</span><span class="n">microFlags</span><span class="p">),</span>
<span class="mi">130</span>                 <span class="sh">"</span><span class="s">dest</span><span class="sh">"</span> <span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">dest</span><span class="p">,</span> <span class="sh">"</span><span class="s">imm</span><span class="sh">"</span> <span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">imm</span><span class="p">,</span>
<span class="mi">131</span>                 <span class="sh">"</span><span class="s">dataSize</span><span class="sh">"</span> <span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">dataSize</span><span class="p">}</span>
<span class="mi">132</span>             <span class="k">return</span> <span class="n">allocator</span>
<span class="mi">133</span>
<span class="mi">134</span>     <span class="n">microopClasses</span><span class="p">[</span><span class="sh">"</span><span class="s">limm</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">LimmOp</span>
</pre></td></tr></tbody></table></code></div></div>

<p>It’s worth noting that the ‘LimmOp’ Python class requires three operands, and
the actual microcode of ‘MOV_R_MI’ provides these three operands when utilizing
the ‘limm’ microop. As a result of the ‘eval’ function, the operands of the 
‘limm’ microop are translated into a format that GEM5 can comprehend and are 
then passed to the ‘<strong>init</strong>’ definition of the ‘LimmOp’ class.</p>

<p>The ‘LimmOp’ class object, which corresponds to the ‘limm’ microop operation 
used to implement the ‘MOV_R_MI’ macroop, is instantiated. This ‘LimmOp’ class 
object is subsequently stored within the ‘X86Macroop’ object of the ‘MOV_R_MI’ 
instruction, accomplished through the ‘add_microop’ definition of ‘X86Macroop.’</p>

<h3 id="what-class-object-is-used-for-microop-class-generation"><span class="me-2">What class object is used for microop class generation?</span><a href="#what-class-object-is-used-for-microop-class-generation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>It might be anticipated that the parsed microop instructions would be 
instantiated from a class with the same name as the microop mnemonic (microop 
opcode), like ‘Ld.’ However, upon closer examination, it becomes evident that 
a more general class is associated with the group of microops, and it doesn’t 
precisely match the microop mnemonic. For example, in the case of the ‘ld’ 
microop, the associated template class used is ‘LoadOp’ instead of ‘Ld’.
Similarly, for the ‘limm’ microop instruction, an ‘LimmOp’ class will represent
this microop. The explanation for this behavior can be found in the ‘let’ block.</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre></td><td class="rouge-code"><pre><span class="c1">#gem5/src/arch/x86/isa/microops/limop.isa
</span>
<span class="n">let</span> <span class="p">{</span>
    <span class="k">class</span> <span class="nc">LimmOp</span><span class="p">(</span><span class="n">X86Microop</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">imm</span><span class="p">,</span> <span class="n">dataSize</span><span class="o">=</span><span class="sh">"</span><span class="s">env.dataSize</span><span class="sh">"</span><span class="p">):</span>
            <span class="n">self</span><span class="p">.</span><span class="n">className</span> <span class="o">=</span> <span class="sh">"</span><span class="s">Limm</span><span class="sh">"</span>
            <span class="n">self</span><span class="p">.</span><span class="n">mnemonic</span> <span class="o">=</span> <span class="sh">"</span><span class="s">limm</span><span class="sh">"</span>
            <span class="n">self</span><span class="p">.</span><span class="n">dest</span> <span class="o">=</span> <span class="n">dest</span>
            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">imm</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">long</span><span class="p">)):</span>
                <span class="n">imm</span> <span class="o">=</span> <span class="sh">"</span><span class="s">ULL(%d)</span><span class="sh">"</span> <span class="o">%</span> <span class="n">imm</span>
            <span class="n">self</span><span class="p">.</span><span class="n">imm</span> <span class="o">=</span> <span class="n">imm</span>
            <span class="n">self</span><span class="p">.</span><span class="n">dataSize</span> <span class="o">=</span> <span class="n">dataSize</span>

        <span class="k">def</span> <span class="nf">getAllocator</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">microFlags</span><span class="p">):</span>
            <span class="n">allocString</span> <span class="o">=</span> <span class="sh">'''</span><span class="s">
                (%(dataSize)s &gt;= 4) ?
                    (StaticInstPtr)(new %(class_name)sBig(machInst,
                        macrocodeBlock, %(flags)s, %(dest)s, %(imm)s,
                        %(dataSize)s)) :
                    (StaticInstPtr)(new %(class_name)s(machInst,
                        macrocodeBlock, %(flags)s, %(dest)s, %(imm)s,
                        %(dataSize)s))
            </span><span class="sh">'''</span>
            <span class="n">allocator</span> <span class="o">=</span> <span class="n">allocString</span> <span class="o">%</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">class_name</span><span class="sh">"</span> <span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">className</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">mnemonic</span><span class="sh">"</span> <span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">mnemonic</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">flags</span><span class="sh">"</span> <span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="nf">microFlagsText</span><span class="p">(</span><span class="n">microFlags</span><span class="p">),</span>
                <span class="sh">"</span><span class="s">dest</span><span class="sh">"</span> <span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">dest</span><span class="p">,</span> <span class="sh">"</span><span class="s">imm</span><span class="sh">"</span> <span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">imm</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">dataSize</span><span class="sh">"</span> <span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">dataSize</span><span class="p">}</span>
            <span class="k">return</span> <span class="n">allocator</span>

    <span class="n">microopClasses</span><span class="p">[</span><span class="sh">"</span><span class="s">limm</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">LimmOp</span>
    <span class="p">...</span><span class="bp">...</span>
</pre></td></tr></tbody></table></code></div></div>

<p>A key takeaway from the ‘let’ block above is that it associates the class
‘LimmOp’ with its corresponding mnemonic (‘limm’) within the Python dictionary 
called ‘microopClasses’. Consequently, when the dictionary is queried using a
microop’s mnemonic, such as ‘limm,’ it will return the related Python class, 
‘LimmOp.’</p>


  </div>

  <div class="post-tail-wrapper text-muted">
    <!-- categories -->
    
      <div class="post-meta mb-3">
        <i class="far fa-folder-open fa-fw me-1"></i>
        
          <a href="/categories/gem5/">GEM5</a>,
          <a href="/categories/macroop/">Macroop</a>,
          <a href="/categories/microops/">Microops</a>,
          <a href="/categories/ply/">PLY</a>
      </div>
    

    <!-- tags -->
    

    <div
      class="
        post-tail-bottom
        d-flex justify-content-between align-items-center mt-5 pb-2
      "
    >
      <div class="license-wrapper">
        
          

          This post is licensed under 
        <a href="https://creativecommons.org/licenses/by/4.0/">
          CC BY 4.0
        </a>
         by the author.
        
      </div>

      <!-- Post sharing snippet -->

<div class="share-wrapper d-flex align-items-center">
  <span class="share-label text-muted">Share</span>
  <span class="share-icons">
    
    
    

    

      

      <a
        href="https://twitter.com/intent/tweet?text=Gem5%20Macroop%20To%20Microop%20-%20Ruach&url=https%3A%2F%2Fruach.github.io%2Fposts%2Fgem5-macroop-to-microop%2F"
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Twitter"
        target="_blank"
        rel="noopener"
        aria-label="Twitter"
      >
        <i class="fa-fw fa-brands fa-square-x-twitter"></i>
      </a>
    

      

      <a
        href="https://www.facebook.com/sharer/sharer.php?title=Gem5%20Macroop%20To%20Microop%20-%20Ruach&u=https%3A%2F%2Fruach.github.io%2Fposts%2Fgem5-macroop-to-microop%2F"
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Facebook"
        target="_blank"
        rel="noopener"
        aria-label="Facebook"
      >
        <i class="fa-fw fab fa-facebook-square"></i>
      </a>
    

      

      <a
        href="https://t.me/share/url?url=https%3A%2F%2Fruach.github.io%2Fposts%2Fgem5-macroop-to-microop%2F&text=Gem5%20Macroop%20To%20Microop%20-%20Ruach"
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Telegram"
        target="_blank"
        rel="noopener"
        aria-label="Telegram"
      >
        <i class="fa-fw fab fa-telegram"></i>
      </a>
    

      

      <a
        href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fruach.github.io%2Fposts%2Fgem5-macroop-to-microop%2F"
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Linkedin"
        target="_blank"
        rel="noopener"
        aria-label="Linkedin"
      >
        <i class="fa-fw fab fa-linkedin"></i>
      </a>
    

    <button
      id="copy-link"
      aria-label="Copy link"
      class="btn small"
      data-bs-toggle="tooltip"
      data-bs-placement="top"
      title="Copy link"
      data-title-succeed="Link copied successfully!"
    >
      <i class="fa-fw fas fa-link pe-none fs-6"></i>
    </button>
  </span>
</div>

    </div>
    <!-- .post-tail-bottom -->
  </div>
  <!-- div.post-tail-wrapper -->
</article>


            
          </main>

          <!-- panel -->
          <aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 mb-5 text-muted">
            <div class="access">
              <!-- Get the last 5 posts from lastmod list. -->















              <!-- The trending tags list -->


















            </div>

            
              
              



  <section id="toc-wrapper" class="ps-0 pe-4">
    <h2 class="panel-heading ps-3 pt-2 mb-2">Contents</h2>
    <nav id="toc"></nav>
  </section>


            
          </aside>
        </div>

        <div class="row">
          <!-- tail -->
          <div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4">
            
              
              <!-- Recommend the other 3 posts according to the tags and categories of the current post. -->

<!-- The total size of related posts -->


<!-- An random integer that bigger than 0 -->


<!-- Equals to TAG_SCORE / {max_categories_hierarchy} -->














  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  
    
  

  

  

  

  

  

  

  

  

  

  

  











  <aside id="related-posts" aria-labelledby="related-label">
    <h3 class="mb-4" id="related-label">Further Reading</h3>
    <nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4">
      
        <article class="col">
          <a href="/posts/gem5-memaccess/" class="post-preview card h-100">
            <div class="card-body">
              <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1591329600"
  data-df="ll"
  
>
  Jun  5, 2020
</time>

              <h4 class="pt-0 my-2">Gem5 Memaccess</h4>
              <div class="text-muted">
                <p>
                  





                  In my previous post, I discussed the automatic generation of C++ classes for 
macroops and microops using various GEM5 tools, including a Python-based parser 
and string-based template substitution...
                </p>
              </div>
            </div>
          </a>
        </article>
      
        <article class="col">
          <a href="/posts/gem5-event-loop/" class="post-preview card h-100">
            <div class="card-body">
              <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1589947200"
  data-df="ll"
  
>
  May 20, 2020
</time>

              <h4 class="pt-0 my-2">Gem5 Event Loop</h4>
              <div class="text-muted">
                <p>
                  





                  I covered how GEM5 configures the hardware parameters through the python script.
Also, in this posting I explained details how python can instantiate the 
CPP classes that actually simulate hardwar...
                </p>
              </div>
            </div>
          </a>
        </article>
      
        <article class="col">
          <a href="/posts/O3-CPU-GEM5/" class="post-preview card h-100">
            <div class="card-body">
              <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1622001600"
  data-df="ll"
  
>
  May 26, 2021
</time>

              <h4 class="pt-0 my-2">O3 Cpu Gem5</h4>
              <div class="text-muted">
                <p>
                  





                  Python derives O3CPU through DerivO3CPU class
To understand particular processor in the GEM5, 
it is easy to start from the script that instantiate the processor. 
We can easily find that lots of G...
                </p>
              </div>
            </div>
          </a>
        </article>
      
    </nav>
  </aside>
  <!-- #related-posts -->


            
              
              <!-- Navigation buttons at the bottom of the post. -->

<nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation">
  
  

  
    <a
      href="/posts/gem5-event-loop/"
      class="btn btn-outline-primary"
      aria-label="Older"
    >
      <p>Gem5 Event Loop</p>
    </a>
  

  
    <a
      href="/posts/template-generating-microop/"
      class="btn btn-outline-primary"
      aria-label="Newer"
    >
      <p>Template Generating Microop</p>
    </a>
  
</nav>

            
              
              <!--  The comments switcher -->

  
  <!-- The Disqus lazy loading. -->

<div id="disqus_thread">
  <p class="text-center text-muted small">Comments powered by <a href="https://disqus.com/">Disqus</a>.</p>
</div>

<script type="text/javascript">
  var disqus_config = function () {
    this.page.url = 'https://ruach.github.io/posts/gem5-macroop-to-microop/';
    this.page.identifier = '/posts/gem5-macroop-to-microop/';
  };

  /* Lazy loading */
  var disqus_observer = new IntersectionObserver(
    function (entries) {
      if (entries[0].isIntersecting) {
        (function () {
          var d = document,
            s = d.createElement('script');
          s.src = 'https://ruach.disqus.com/embed.js';
          s.setAttribute('data-timestamp', +new Date());
          (d.head || d.body).appendChild(s);
        })();

        disqus_observer.disconnect();
      }
    },
    { threshold: [0] }
  );

  disqus_observer.observe(document.querySelector('#disqus_thread'));

  /* Auto switch theme */
  function reloadDisqus() {
    if (event.source === window && event.data && event.data.direction === ModeToggle.ID) {
      /* Disqus hasn't been loaded */
      if (typeof DISQUS === 'undefined') {
        return;
      }

      if (document.readyState == 'complete') {
        DISQUS.reset({ reload: true, config: disqus_config });
      }
    }
  }

  if (document.querySelector('.mode-toggle')) {
    window.addEventListener('message', reloadDisqus);
  }
</script>



            

            <!-- The Footer -->

<footer
  aria-label="Site Info"
  class="
    d-flex flex-column justify-content-center text-muted
    flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3
  "
>
  <p>
    ©
    <time>2024</time>
    <a href="https://ruach.github.io">Jaehyuk Lee</a>.
    
      <span
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author."
      >Some rights reserved.</span>
    
  </p>

  <p>Using the <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme for <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>
  </p>
</footer>

          </div>
        </div>

        <!-- The Search results -->

<div id="search-result-wrapper" class="d-flex justify-content-center unloaded">
  <div class="col-11 content">
    <div id="search-hints">
      <!-- The trending tags list -->


















    </div>
    <div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div>
  </div>
</div>

      </div>

      <aside aria-label="Scroll to Top">
        <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow">
          <i class="fas fa-angle-up"></i>
        </button>
      </aside>
    </div>

    <div id="mask"></div>

    
      <aside
  id="notification"
  class="toast"
  role="alert"
  aria-live="assertive"
  aria-atomic="true"
  data-bs-animation="true"
  data-bs-autohide="false"
>
  <div class="toast-header">
    <button
      type="button"
      class="btn-close ms-auto"
      data-bs-dismiss="toast"
      aria-label="Close"
    ></button>
  </div>
  <div class="toast-body text-center pt-0">
    <p class="px-2 mb-3">A new version of content is available.</p>
    <button type="button" class="btn btn-primary" aria-label="Update">
      Update
    </button>
  </div>
</aside>

    

    <!-- JavaScripts -->

    <!-- JS selector for site. -->

<!-- commons -->



<!-- layout specified -->


  

  
    <!-- image lazy-loading & popup & clipboard -->
    
  















  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  



  <script src="https://cdn.jsdelivr.net/combine/npm/jquery@3.7.1/dist/jquery.min.js,npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js,npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/magnific-popup@1.1.0/dist/jquery.magnific-popup.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.10/dayjs.min.js,npm/dayjs@1.11.10/locale/en.min.js,npm/dayjs@1.11.10/plugin/relativeTime.min.js,npm/dayjs@1.11.10/plugin/localizedFormat.min.js,npm/tocbot@4.21.2/dist/tocbot.min.js"></script>






<script defer src="/assets/js/dist/post.min.js"></script>






    

    <!--
  Jekyll Simple Search loader
  See: <https://github.com/christian-fei/Simple-Jekyll-Search>
-->





<script>
  /* Note: dependent library will be loaded in `js-selector.html` */
  SimpleJekyllSearch({
    searchInput: document.getElementById('search-input'),
    resultsContainer: document.getElementById('search-results'),
    json: '/assets/js/data/search.json',
    searchResultTemplate: '  <article class="px-1 px-sm-2 px-lg-4 px-xl-0">    <header>      <h2><a href="{url}">{title}</a></h2>      <div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1">        {categories}        {tags}      </div>    </header>    <p>{snippet}</p>  </article>',
    noResultsText: '<p class="mt-5"></p>',
    templateMiddleware: function(prop, value, template) {
      if (prop === 'categories') {
        if (value === '') {
          return `${value}`;
        } else {
          return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`;
        }
      }

      if (prop === 'tags') {
        if (value === '') {
          return `${value}`;
        } else {
          return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`;
        }
      }
    }
  });
</script>

  </body>
</html>

