<!doctype html>














<!-- `site.alt_lang` can specify a language different from the UI -->
<html lang="en" data-mode="light">
  <!-- The Head -->

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta
    name="viewport"
    content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover"
  >

  

  

  
    <!-- Begin Jekyll SEO tag v2.8.0 -->
<meta name="generator" content="Jekyll v4.3.2" />
<meta property="og:title" content="Gem5 Macroop To Microop" />
<meta property="og:locale" content="en" />
<meta name="description" content="Let’s begin by examining the translation of macroops into microops by first focusing on the well-known ‘mov’ instructions in the x86 architecture." />
<meta property="og:description" content="Let’s begin by examining the translation of macroops into microops by first focusing on the well-known ‘mov’ instructions in the x86 architecture." />
<link rel="canonical" href="http://localhost:4000/posts/gem5-macroop-to-microop/" />
<meta property="og:url" content="http://localhost:4000/posts/gem5-macroop-to-microop/" />
<meta property="og:site_name" content="Ruach" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-06-01T00:00:00-04:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Gem5 Macroop To Microop" />
<meta name="twitter:site" content="@ruach_lee" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2020-06-01T00:00:00-04:00","datePublished":"2020-06-01T00:00:00-04:00","description":"Let’s begin by examining the translation of macroops into microops by first focusing on the well-known ‘mov’ instructions in the x86 architecture.","headline":"Gem5 Macroop To Microop","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/posts/gem5-macroop-to-microop/"},"url":"http://localhost:4000/posts/gem5-macroop-to-microop/"}</script>
<!-- End Jekyll SEO tag -->

  

  <title>Gem5 Macroop To Microop | Ruach
  </title>

  <!--
  The Favicons for Web, Android, Microsoft, and iOS (iPhone and iPad) Apps
  Generated by: https://realfavicongenerator.net/
-->



<link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png">
<link rel="manifest" href="/assets/img/favicons/site.webmanifest">
<link rel="shortcut icon" href="/assets/img/favicons/favicon.ico">
<meta name="apple-mobile-web-app-title" content="Ruach">
<meta name="application-name" content="Ruach">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml">
<meta name="theme-color" content="#ffffff">


  
    
      <link rel="preconnect" href="https://fonts.googleapis.com" >
      <link rel="dns-prefetch" href="https://fonts.googleapis.com" >
    
      <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      <link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin>
    
      <link rel="preconnect" href="https://fonts.googleapis.com" >
      <link rel="dns-prefetch" href="https://fonts.googleapis.com" >
    
      <link rel="preconnect" href="https://cdn.jsdelivr.net" >
      <link rel="dns-prefetch" href="https://cdn.jsdelivr.net" >
    

    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap">
  

  <!-- GA -->
  

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.2/css/all.min.css">

  <link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css">

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.21.2/dist/tocbot.min.css">
  

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css">
  

  
    <!-- Manific Popup -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css">
  

  <!-- JavaScript -->

  

  <!-- A placeholder to allow defining custom metadata -->

</head>


  <body>
    <!-- The Side Bar -->

<aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end">
  <header class="profile-wrapper">
    <a href="/" id="avatar" class="rounded-circle">
      
        
        <img src="/assets/img/jaehyuk.png" width="112" height="112" alt="avatar" onerror="this.style.display='none'">
      
    </a>

    <h1 class="site-title">
      <a href="/">Ruach</a>
    </h1>
    <p class="site-subtitle fst-italic mb-0">Security Researcher at Gatech</p>
  </header>
  <!-- .profile-wrapper -->

  <nav class="flex-column flex-grow-1 w-100 ps-0">
    <ul class="nav">
      <!-- home -->
      <li class="nav-item">
        <a href="/" class="nav-link">
          <i class="fa-fw fas fa-home"></i>
          <span>HOME</span>
        </a>
      </li>
      <!-- the real tabs -->
      
        <li class="nav-item">
          <a href="/categories/" class="nav-link">
            <i class="fa-fw fas fa-stream"></i>
            

            <span>CATEGORIES</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/tags/" class="nav-link">
            <i class="fa-fw fas fa-tags"></i>
            

            <span>TAGS</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/archives/" class="nav-link">
            <i class="fa-fw fas fa-archive"></i>
            

            <span>ARCHIVES</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/about/" class="nav-link">
            <i class="fa-fw fas fa-info-circle"></i>
            

            <span>ABOUT</span>
          </a>
        </li>
        <!-- .nav-item -->
      
    </ul>
  </nav>

  <div class="sidebar-bottom d-flex flex-wrap  align-items-center w-100">
    

    
      

      
        <a
          href="javascript:location.href = 'mailto:' + ['jaehyuk','gatech.edu'].join('@')"
          aria-label="email"
          

          

          

          
        >
          <i class="fas fa-envelope"></i>
        </a>
      
    
      

      
        <a
          href="https://www.linkedin.com/in/jaehyuk-lee-29b33b121/"
          aria-label="linkedin"
          

          
            target="_blank"
            
          

          

          
            rel="noopener noreferrer"
          
        >
          <i class="fab fa-linkedin"></i>
        </a>
      
    
      

      
        <a
          href="https://github.com/Ruach"
          aria-label="github"
          

          
            target="_blank"
            
          

          

          
            rel="noopener noreferrer"
          
        >
          <i class="fab fa-github"></i>
        </a>
      
    
      

      
        <a
          href="https://stackoverflow.com/users/4460514/ruach?tab=profile"
          aria-label="stack-overflow"
          

          
            target="_blank"
            
          

          

          
            rel="noopener noreferrer"
          
        >
          <i class="fab fa-stack-overflow"></i>
        </a>
      
    
  </div>
  <!-- .sidebar-bottom -->
</aside>
<!-- #sidebar -->


    <div id="main-wrapper" class="d-flex justify-content-center">
      <div class="container d-flex flex-column px-xxl-5">
        <!-- The Top Bar -->

<header id="topbar-wrapper" aria-label="Top Bar">
  <div
    id="topbar"
    class="d-flex align-items-center justify-content-between px-lg-3 h-100"
  >
    <nav id="breadcrumb" aria-label="Breadcrumb">
      

      
        
          
            <span>
              <a href="/">
                Home
              </a>
            </span>

          
        
          
        
          
            
              <span>Gem5 Macroop To Microop</span>
            

          
        
      
    </nav>
    <!-- endof #breadcrumb -->

    <button type="button" id="sidebar-trigger" class="btn btn-link">
      <i class="fas fa-bars fa-fw"></i>
    </button>

    <div id="topbar-title">
      Post
    </div>

    <button type="button" id="search-trigger" class="btn btn-link">
      <i class="fas fa-search fa-fw"></i>
    </button>

    <search class="align-items-center ms-3 ms-lg-0">
      <i class="fas fa-search fa-fw"></i>
      <input
        class="form-control"
        id="search-input"
        type="search"
        aria-label="search"
        autocomplete="off"
        placeholder="Search..."
      >
    </search>
    <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button>
  </div>
</header>


        <div class="row flex-grow-1">
          <main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4">
            
              <!-- Refactor the HTML structure -->



<!--
  In order to allow a wide table to scroll horizontally,
  we suround the markdown table with `<div class="table-wrapper">` and `</div>`
-->



<!--
  Fixed kramdown code highlight rendering:
  https://github.com/penibelst/jekyll-compress-html/issues/101
  https://github.com/penibelst/jekyll-compress-html/issues/71#issuecomment-188144901
-->



<!-- Change the icon of checkbox -->



<!-- Handle images -->





<!-- Add header for code snippets -->



<!-- Create heading anchors -->





  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    

    
  

  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    

    
  

  
  

  

  
  

  




<!-- return -->




<article class="px-1">
  <header>
    <h1 data-toc-skip>Gem5 Macroop To Microop</h1>

    <div class="post-meta text-muted">
      <!-- published date -->
      <span>
        Posted
        <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1590984000"
  data-df="ll"
  
    data-bs-toggle="tooltip" data-bs-placement="bottom"
  
>
  Jun  1, 2020
</time>

      </span>

      <!-- lastmod date -->
      

      

      <div class="d-flex justify-content-between">
        <!-- author(s) -->
        <span>
          

          By

          <em>
            
              <a href="https://ruach.github.io">Jaehyuk Lee</a>
            
          </em>
        </span>

        <!-- read time -->
        <!-- Calculate the post's reading time, and display the word count in tooltip -->



<!-- words per minute -->










<!-- return element -->
<span
  class="readtime"
  data-bs-toggle="tooltip"
  data-bs-placement="bottom"
  title="6815 words"
>
  <em>37 min</em> read</span>

      </div>
      <!-- .d-flex -->
    </div>
    <!-- .post-meta -->
  </header>

  <div class="content">
    <p>Let’s begin by examining the translation of macroops into microops by first 
focusing on the well-known ‘mov’ instructions in the x86 architecture.</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="rouge-code"><pre><span class="n">gem5</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">arch</span><span class="o">/</span><span class="n">x86</span><span class="o">/</span><span class="n">isa</span><span class="o">/</span><span class="n">insts</span><span class="o">/</span><span class="n">general_purpose</span><span class="o">/</span><span class="n">data_transfer</span><span class="o">/</span><span class="n">move</span><span class="p">.</span><span class="n">py</span>

 <span class="mi">38</span> <span class="n">microcode</span> <span class="o">=</span> <span class="sh">'''</span><span class="s">
 39
 40 #
 41 # Regular moves
 42 #
 43
 44 def macroop MOV_R_MI {
 45     limm t1, imm, dataSize=asz
 46     ld reg, seg, [1, t0, t1]
 47 };
 48
 49 def macroop MOV_MI_R {
 50     limm t1, imm, dataSize=asz
 51     st reg, seg, [1, t0, t1]
 52 };

</span></pre></td></tr></tbody></table></code></div></div>
<p>Since x86 offers various formats of ‘mov’ instructions depending on their 
operands, GEM5 incorporates multiple macroops for the ‘mov’ mnemonic. As depicted
in the provided code snippet, two distinct macroops are defined for the ‘mov’ 
instruction, each composed of different microops. In this posting, I will 
explore the process of parsing macroops and converting them into microop 
invocations. Before delving into the details, it’s essential to grasp some
fundamental tools necessary for parsing GEM5 macroops.</p>

<h3 id="python-lex-yaccply-for-macroop-parsing"><span class="me-2">Python-Lex-Yacc(PLY) for macroop parsing</span><a href="#python-lex-yaccply-for-macroop-parsing" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>GEM5 employs domain-specific languages (DSL) built upon the Python framework to 
create architecture-independent grammars for defining both macroops and microops.
When you define an ISA for a specific architecture using the predefined DSL, 
GEM5 automatically translates your ISA specification into C++ classes.
This translation process relies on the MicroAssembler Python class provided by 
GEM5. The MicroAssembler class uses lexer and parser classes offered by the 
Python-Lex-Yacc (PLY) package. To facilitate these lexer and parser, you need to
provide tokens, a context-free grammar, and an input file for parsing the GEM5 
DSL. We will delve into how these components are defined and supplied.</p>

<h3 id="microassembler-class-"><span class="me-2">MicroAssembler Class <a name="microassembler"></a></span><a href="#microassembler-class-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre><span class="n">gem5</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">arch</span><span class="o">/</span><span class="n">micro_asm</span><span class="p">.</span><span class="n">py</span>

<span class="mi">484</span> <span class="k">class</span> <span class="nc">MicroAssembler</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="mi">485</span>
<span class="mi">486</span>     <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">macro_type</span><span class="p">,</span> <span class="n">microops</span><span class="p">,</span>
<span class="mi">487</span>         <span class="n">rom</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">rom_macroop_type</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
<span class="mi">488</span>         <span class="n">self</span><span class="p">.</span><span class="n">lexer</span> <span class="o">=</span> <span class="n">lex</span><span class="p">.</span><span class="nf">lex</span><span class="p">()</span>
<span class="mi">489</span>         <span class="n">self</span><span class="p">.</span><span class="n">parser</span> <span class="o">=</span> <span class="n">yacc</span><span class="p">.</span><span class="nf">yacc</span><span class="p">()</span>
<span class="mi">490</span>         <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="n">macro_type</span> <span class="o">=</span> <span class="n">macro_type</span>
<span class="mi">491</span>         <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="n">macroops</span> <span class="o">=</span> <span class="p">{}</span>
<span class="mi">492</span>         <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="n">microops</span> <span class="o">=</span> <span class="n">microops</span>
<span class="mi">493</span>         <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="n">rom</span> <span class="o">=</span> <span class="n">rom</span>
<span class="mi">494</span>         <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="n">rom_macroop_type</span> <span class="o">=</span> <span class="n">rom_macroop_type</span>
<span class="mi">495</span>         <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="n">symbols</span> <span class="o">=</span> <span class="p">{}</span>
<span class="mi">496</span>         <span class="n">self</span><span class="p">.</span><span class="n">symbols</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="n">symbols</span>

</pre></td></tr></tbody></table></code></div></div>
<p>The MicroAssembler class contains the essential information necessary for 
parsing a specific ISA. Given that GEM5 supports emulation for various 
architectures, it requires a versatile interface capable of conveying 
architecture-specific details. The MicroAssembler Python class in GEM5 
encompasses not only instances of parser and lexer but also 
architecture-specific metadata crucial for comprehending specific ISAs, 
including Macroops, Microops, and ROM code. Since our focus is on the x86 ISA, 
let’s examine the MicroAssembler instance tailored for the X86 architecture.</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre><span class="n">gem5</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">arch</span><span class="o">/</span><span class="n">x86</span><span class="o">/</span><span class="n">isa</span><span class="o">/</span><span class="n">microasm</span><span class="p">.</span><span class="n">isa</span>

 <span class="mi">52</span> <span class="n">let</span> <span class="p">{{</span>
 <span class="mi">53</span>     <span class="kn">import</span> <span class="n">sys</span>
 <span class="mi">54</span>     <span class="n">sys</span><span class="p">.</span><span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">src/arch/x86/isa/</span><span class="sh">"</span><span class="p">]</span>
 <span class="mi">55</span>     <span class="kn">from</span> <span class="n">insts</span> <span class="kn">import</span> <span class="n">microcode</span>
 <span class="mi">56</span>     <span class="c1"># print microcode
</span> <span class="mi">57</span>     <span class="kn">from</span> <span class="n">micro_asm</span> <span class="kn">import</span> <span class="n">MicroAssembler</span><span class="p">,</span> <span class="n">Rom_Macroop</span>
 <span class="mi">58</span>     <span class="n">mainRom</span> <span class="o">=</span> <span class="nc">X86MicrocodeRom</span><span class="p">(</span><span class="sh">'</span><span class="s">main ROM</span><span class="sh">'</span><span class="p">)</span>
 <span class="mi">59</span>     <span class="n">assembler</span> <span class="o">=</span> <span class="nc">MicroAssembler</span><span class="p">(</span><span class="n">X86Macroop</span><span class="p">,</span> <span class="n">microopClasses</span><span class="p">,</span> <span class="n">mainRom</span><span class="p">,</span> <span class="n">Rom_Macroop</span><span class="p">)</span>

</pre></td></tr></tbody></table></code></div></div>
<p>As demonstrated in line 59, the <strong>MicroAssembler</strong> object for X86 is created, 
incorporating architecture-specific metadata for the x86 ISA, which includes 
elements such as X86Macroop, microopClasses, mainRom, and Rom_Macroop. The 
X86Macroop and microopClasses play a pivotal role in the translation of macroops
into microops, particularly when working in conjunction with yacc.
Let’s now explore the details of the information offered by these classes and 
how each component can be assembled to construct a MicroAssembler instance.</p>

<h3 id="x86macroop-class-"><span class="me-2">X86Macroop Class <a name="x86macroop"></a></span><a href="#x86macroop-class-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
</pre></td><td class="rouge-code"><pre><span class="n">gem5</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">arch</span><span class="o">/</span><span class="n">x86</span><span class="o">/</span><span class="n">isa</span><span class="o">/</span><span class="n">macroop</span><span class="p">.</span><span class="n">isa</span>

<span class="mi">136</span>     <span class="k">class</span> <span class="nc">X86Macroop</span><span class="p">(</span><span class="n">Combinational_Macroop</span><span class="p">):</span>
<span class="mi">137</span>         <span class="k">def</span> <span class="nf">add_microop</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">mnemonic</span><span class="p">,</span> <span class="n">microop</span><span class="p">):</span>
<span class="mi">138</span>             <span class="n">microop</span><span class="p">.</span><span class="n">mnemonic</span> <span class="o">=</span> <span class="n">mnemonic</span>
<span class="mi">139</span>             <span class="n">microop</span><span class="p">.</span><span class="n">micropc</span> <span class="o">=</span> <span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">microops</span><span class="p">)</span>
<span class="mi">140</span>             <span class="n">self</span><span class="p">.</span><span class="n">microops</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">microop</span><span class="p">)</span>
<span class="mi">141</span>         <span class="k">def</span> <span class="nf">setAdjustEnv</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
<span class="mi">142</span>             <span class="n">self</span><span class="p">.</span><span class="n">adjust_env</span> <span class="o">=</span> <span class="n">val</span>
<span class="mi">143</span>         <span class="k">def</span> <span class="nf">adjustImm</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
<span class="mi">144</span>             <span class="n">self</span><span class="p">.</span><span class="n">adjust_imm</span> <span class="o">+=</span> <span class="n">val</span>
<span class="mi">145</span>         <span class="k">def</span> <span class="nf">adjustDisp</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
<span class="mi">146</span>             <span class="n">self</span><span class="p">.</span><span class="n">adjust_disp</span> <span class="o">+=</span> <span class="n">val</span>
<span class="mi">147</span>         <span class="k">def</span> <span class="nf">serializeBefore</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
<span class="mi">148</span>             <span class="n">self</span><span class="p">.</span><span class="n">serialize_before</span> <span class="o">=</span> <span class="bp">True</span>
<span class="mi">149</span>         <span class="k">def</span> <span class="nf">serializeAfter</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
<span class="mi">150</span>             <span class="n">self</span><span class="p">.</span><span class="n">serialize_after</span> <span class="o">=</span> <span class="bp">True</span>
<span class="mi">151</span>
<span class="mi">152</span>         <span class="k">def</span> <span class="nf">function_call</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
<span class="mi">153</span>             <span class="n">self</span><span class="p">.</span><span class="n">function_call</span> <span class="o">=</span> <span class="bp">True</span>
<span class="mi">154</span>         <span class="k">def</span> <span class="nf">function_return</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
<span class="mi">155</span>             <span class="n">self</span><span class="p">.</span><span class="n">function_return</span> <span class="o">=</span> <span class="bp">True</span>
<span class="mi">156</span>
<span class="mi">157</span>         <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
<span class="mi">158</span>             <span class="nf">super</span><span class="p">(</span><span class="n">X86Macroop</span><span class="p">,</span> <span class="n">self</span><span class="p">).</span><span class="nf">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
<span class="mi">159</span>             <span class="n">self</span><span class="p">.</span><span class="n">directives</span> <span class="o">=</span> <span class="p">{</span>
<span class="mi">160</span>                 <span class="sh">"</span><span class="s">adjust_env</span><span class="sh">"</span> <span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">setAdjustEnv</span><span class="p">,</span>
<span class="mi">161</span>                 <span class="sh">"</span><span class="s">adjust_imm</span><span class="sh">"</span> <span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">adjustImm</span><span class="p">,</span>
<span class="mi">162</span>                 <span class="sh">"</span><span class="s">adjust_disp</span><span class="sh">"</span> <span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">adjustDisp</span><span class="p">,</span>
<span class="mi">163</span>                 <span class="sh">"</span><span class="s">serialize_before</span><span class="sh">"</span> <span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">serializeBefore</span><span class="p">,</span>
<span class="mi">164</span>                 <span class="sh">"</span><span class="s">serialize_after</span><span class="sh">"</span> <span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">serializeAfter</span><span class="p">,</span>
<span class="mi">165</span>                 <span class="sh">"</span><span class="s">function_call</span><span class="sh">"</span> <span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">function_call</span><span class="p">,</span>
<span class="mi">166</span>                 <span class="sh">"</span><span class="s">function_return</span><span class="sh">"</span> <span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">function_return</span>
<span class="mi">167</span>             <span class="p">}</span>
<span class="mi">168</span>             <span class="n">self</span><span class="p">.</span><span class="n">declared</span> <span class="o">=</span> <span class="bp">False</span>
<span class="mi">169</span>             <span class="n">self</span><span class="p">.</span><span class="n">adjust_env</span> <span class="o">=</span> <span class="sh">""</span>
<span class="mi">170</span>             <span class="n">self</span><span class="p">.</span><span class="n">init_env</span> <span class="o">=</span> <span class="sh">""</span>
<span class="mi">171</span>             <span class="n">self</span><span class="p">.</span><span class="n">adjust_imm</span> <span class="o">=</span> <span class="sh">'''</span><span class="s">
172                 uint64_t adjustedImm = IMMEDIATE;
173                 //This is to pacify gcc in case the immediate isn</span><span class="sh">'</span><span class="s">t used.
174                 adjustedImm = adjustedImm;
175             </span><span class="sh">'''</span>
<span class="mi">176</span>             <span class="n">self</span><span class="p">.</span><span class="n">adjust_disp</span> <span class="o">=</span> <span class="sh">'''</span><span class="s">
177                 uint64_t adjustedDisp = DISPLACEMENT;
178                 //This is to pacify gcc in case the displacement isn</span><span class="sh">'</span><span class="s">t used.
179                 adjustedDisp = adjustedDisp;
180             </span><span class="sh">'''</span>
<span class="mi">181</span>             <span class="n">self</span><span class="p">.</span><span class="n">serialize_before</span> <span class="o">=</span> <span class="bp">False</span>
<span class="mi">182</span>             <span class="n">self</span><span class="p">.</span><span class="n">serialize_after</span> <span class="o">=</span> <span class="bp">False</span>
<span class="mi">183</span>             <span class="n">self</span><span class="p">.</span><span class="n">function_call</span> <span class="o">=</span> <span class="bp">False</span>
<span class="mi">184</span>             <span class="n">self</span><span class="p">.</span><span class="n">function_return</span> <span class="o">=</span> <span class="bp">False</span>
<span class="mi">185</span> 
<span class="mi">186</span>         <span class="k">def</span> <span class="nf">getAllocator</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">env</span><span class="p">):</span>
<span class="mi">187</span>             <span class="k">return</span> <span class="sh">"</span><span class="s">new X86Macroop::%s(machInst, %s)</span><span class="sh">"</span> <span class="o">%</span> \
<span class="mi">188</span>                     <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">env</span><span class="p">.</span><span class="nf">getAllocator</span><span class="p">())</span>
<span class="mi">189</span>         <span class="k">def</span> <span class="nf">getMnemonic</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
<span class="mi">190</span>             <span class="n">mnemonic</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="nf">lower</span><span class="p">()</span>
<span class="mi">191</span>             <span class="n">mnemonic</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">match</span><span class="p">(</span><span class="sa">r</span><span class="sh">'</span><span class="s">[^_]*</span><span class="sh">'</span><span class="p">,</span> <span class="n">mnemonic</span><span class="p">).</span><span class="nf">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="mi">192</span>             <span class="k">return</span> <span class="n">mnemonic</span>
<span class="mi">193</span>         <span class="k">def</span> <span class="nf">getDeclaration</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
<span class="mi">194</span>             <span class="c1">#FIXME This first parameter should be the mnemonic. I need to
</span><span class="mi">195</span>             <span class="c1">#write some code which pulls that out
</span><span class="mi">196</span>             <span class="n">declareLabels</span> <span class="o">=</span> <span class="sh">""</span>
<span class="mi">197</span>             <span class="nf">for </span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">microop</span><span class="p">)</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">labels</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
<span class="mi">198</span>                 <span class="n">declareLabels</span> <span class="o">+=</span> <span class="sh">"</span><span class="s">const static uint64_t label_%s = %d;</span><span class="se">\n</span><span class="sh">"</span> \
<span class="mi">199</span>                                   <span class="o">%</span> <span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">microop</span><span class="p">.</span><span class="n">micropc</span><span class="p">)</span>
<span class="mi">200</span>             <span class="n">iop</span> <span class="o">=</span> <span class="nc">InstObjParams</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="nf">getMnemonic</span><span class="p">(),</span> <span class="n">self</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">Macroop</span><span class="sh">"</span><span class="p">,</span>
<span class="mi">201</span>                     <span class="p">{</span><span class="sh">"</span><span class="s">code</span><span class="sh">"</span> <span class="p">:</span> <span class="sh">""</span><span class="p">,</span>
<span class="mi">202</span>                      <span class="sh">"</span><span class="s">declareLabels</span><span class="sh">"</span> <span class="p">:</span> <span class="n">declareLabels</span>
<span class="mi">203</span>                     <span class="p">})</span>
<span class="mi">204</span>             <span class="k">return</span> <span class="n">MacroDeclare</span><span class="p">.</span><span class="nf">subst</span><span class="p">(</span><span class="n">iop</span><span class="p">);</span>
<span class="mi">205</span>         <span class="k">def</span> <span class="nf">getDefinition</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">env</span><span class="p">):</span>
<span class="mi">206</span>             <span class="c1">#FIXME This first parameter should be the mnemonic. I need to
</span><span class="mi">207</span>             <span class="c1">#write some code which pulls that out
</span><span class="mi">208</span>             <span class="n">numMicroops</span> <span class="o">=</span> <span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">microops</span><span class="p">)</span>
<span class="mi">209</span>             <span class="n">allocMicroops</span> <span class="o">=</span> <span class="sh">''</span>
<span class="mi">210</span>             <span class="n">micropc</span> <span class="o">=</span> <span class="mi">0</span>
<span class="mi">211</span>             <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">microops</span><span class="p">:</span>
<span class="mi">212</span>                 <span class="n">flags</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">IsMicroop</span><span class="sh">"</span><span class="p">]</span>
<span class="mi">213</span>                 <span class="k">if</span> <span class="n">micropc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<span class="mi">214</span>                     <span class="n">flags</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sh">"</span><span class="s">IsFirstMicroop</span><span class="sh">"</span><span class="p">)</span>
<span class="mi">215</span> 
<span class="mi">216</span>                     <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">serialize_before</span><span class="p">:</span>
<span class="mi">217</span>                         <span class="n">flags</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sh">"</span><span class="s">IsSerializing</span><span class="sh">"</span><span class="p">)</span>
<span class="mi">218</span>                         <span class="n">flags</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sh">"</span><span class="s">IsSerializeBefore</span><span class="sh">"</span><span class="p">)</span>
<span class="mi">219</span> 
<span class="mi">220</span>                 <span class="k">if</span> <span class="n">micropc</span> <span class="o">==</span> <span class="n">numMicroops</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
<span class="mi">221</span>                     <span class="n">flags</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sh">"</span><span class="s">IsLastMicroop</span><span class="sh">"</span><span class="p">)</span>
<span class="mi">222</span> 
<span class="mi">223</span>                     <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">serialize_after</span><span class="p">:</span>
<span class="mi">224</span>                         <span class="n">flags</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sh">"</span><span class="s">IsSerializing</span><span class="sh">"</span><span class="p">)</span>
<span class="mi">225</span>                         <span class="n">flags</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sh">"</span><span class="s">IsSerializeAfter</span><span class="sh">"</span><span class="p">)</span>
<span class="mi">226</span> 
<span class="mi">227</span>                     <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">function_call</span><span class="p">:</span>
<span class="mi">228</span>                         <span class="n">flags</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sh">"</span><span class="s">IsCall</span><span class="sh">"</span><span class="p">)</span>
<span class="mi">229</span>                         <span class="n">flags</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sh">"</span><span class="s">IsUncondControl</span><span class="sh">"</span><span class="p">)</span>
<span class="mi">230</span>                     <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">function_return</span><span class="p">:</span>
<span class="mi">231</span>                         <span class="n">flags</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sh">"</span><span class="s">IsReturn</span><span class="sh">"</span><span class="p">)</span>
<span class="mi">232</span>                         <span class="n">flags</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sh">"</span><span class="s">IsUncondControl</span><span class="sh">"</span><span class="p">)</span>
<span class="mi">233</span>                 <span class="k">else</span><span class="p">:</span>
<span class="mi">234</span>                     <span class="n">flags</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sh">"</span><span class="s">IsDelayedCommit</span><span class="sh">"</span><span class="p">)</span>
<span class="mi">235</span> 
<span class="mi">236</span>                 <span class="n">allocMicroops</span> <span class="o">+=</span> \
<span class="mi">237</span>                     <span class="sh">"</span><span class="s">microops[%d] = %s;</span><span class="se">\n</span><span class="sh">"</span> <span class="o">%</span> \
<span class="mi">238</span>                     <span class="p">(</span><span class="n">micropc</span><span class="p">,</span> <span class="n">op</span><span class="p">.</span><span class="nf">getAllocator</span><span class="p">(</span><span class="n">flags</span><span class="p">))</span>
<span class="mi">239</span>                 <span class="n">micropc</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="mi">240</span>             <span class="k">if</span> <span class="n">env</span><span class="p">.</span><span class="n">useStackSize</span><span class="p">:</span>
<span class="mi">241</span>                 <span class="n">useStackSize</span> <span class="o">=</span> <span class="sh">"</span><span class="s">true</span><span class="sh">"</span>
<span class="mi">242</span>             <span class="k">else</span><span class="p">:</span>
<span class="mi">243</span>                 <span class="n">useStackSize</span> <span class="o">=</span> <span class="sh">"</span><span class="s">false</span><span class="sh">"</span>
<span class="mi">244</span>             <span class="k">if</span> <span class="n">env</span><span class="p">.</span><span class="n">memoryInst</span><span class="p">:</span>
<span class="mi">245</span>                 <span class="n">memoryInst</span> <span class="o">=</span> <span class="sh">"</span><span class="s">true</span><span class="sh">"</span>
<span class="mi">246</span>             <span class="k">else</span><span class="p">:</span>
<span class="mi">247</span>                 <span class="n">memoryInst</span> <span class="o">=</span> <span class="sh">"</span><span class="s">false</span><span class="sh">"</span>
<span class="mi">248</span>             <span class="n">regSize</span> <span class="o">=</span> <span class="sh">'''</span><span class="s">(%s || (env.base == INTREG_RSP &amp;&amp; %s) ?
249                          env.stackSize :
250                          env.dataSize)</span><span class="sh">'''</span> <span class="o">%</span> <span class="p">(</span><span class="n">useStackSize</span><span class="p">,</span> <span class="n">memoryInst</span><span class="p">)</span>
<span class="mi">251</span>             <span class="n">iop</span> <span class="o">=</span> <span class="nc">InstObjParams</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="nf">getMnemonic</span><span class="p">(),</span> <span class="n">self</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">Macroop</span><span class="sh">"</span><span class="p">,</span>
<span class="mi">252</span>                                 <span class="p">{</span><span class="sh">"</span><span class="s">code</span><span class="sh">"</span> <span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">num_microops</span><span class="sh">"</span> <span class="p">:</span> <span class="n">numMicroops</span><span class="p">,</span>
<span class="mi">253</span>                                  <span class="sh">"</span><span class="s">alloc_microops</span><span class="sh">"</span> <span class="p">:</span> <span class="n">allocMicroops</span><span class="p">,</span>
<span class="mi">254</span>                                  <span class="sh">"</span><span class="s">adjust_env</span><span class="sh">"</span> <span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">adjust_env</span><span class="p">,</span>
<span class="mi">255</span>                                  <span class="sh">"</span><span class="s">adjust_imm</span><span class="sh">"</span> <span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">adjust_imm</span><span class="p">,</span>
<span class="mi">256</span>                                  <span class="sh">"</span><span class="s">adjust_disp</span><span class="sh">"</span> <span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">adjust_disp</span><span class="p">,</span>
<span class="mi">257</span>                                  <span class="sh">"</span><span class="s">disassembly</span><span class="sh">"</span> <span class="p">:</span> <span class="n">env</span><span class="p">.</span><span class="n">disassembly</span><span class="p">,</span>
<span class="mi">258</span>                                  <span class="sh">"</span><span class="s">regSize</span><span class="sh">"</span> <span class="p">:</span> <span class="n">regSize</span><span class="p">,</span>
<span class="mi">259</span>                                  <span class="sh">"</span><span class="s">init_env</span><span class="sh">"</span> <span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">initEnv</span><span class="p">})</span>
<span class="mi">260</span>             <span class="k">return</span> <span class="n">MacroConstructor</span><span class="p">.</span><span class="nf">subst</span><span class="p">(</span><span class="n">iop</span><span class="p">)</span> <span class="o">+</span> \
<span class="mi">261</span>                    <span class="n">MacroDisassembly</span><span class="p">.</span><span class="nf">subst</span><span class="p">(</span><span class="n">iop</span><span class="p">);</span>

</pre></td></tr></tbody></table></code></div></div>

<p>The class definition might seem lengthy, but it essentially serves as an 
abstract representation of a single X86Macroop mnemonic. For instance, if you 
define your custom ‘mov’ instruction as ‘CUST_MOV,’ an X86Macroop class instance
for ‘CUST_MOV’ will be automatically generated to represent that macroop. 
Crucially, it’s worth highlighting that this class includes a method called 
‘add_microop.’ Since X86 architecture macroops typically comprise multiple 
microops, the MicroAssembler can use this method to incorporate microop objects 
into the respective macroop object.</p>

<h3 id="microopclasses-"><span class="me-2">microopClasses <a name="microopDict"></a></span><a href="#microopclasses-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>In X86 archiecture, one macroop can consist of multiple microops. Therefore, to 
parse the macroop, parser should be aware of which microops exist in that 
architecture. That’s the reason why it is passed to the MicroAssembler.</p>
<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="n">src</span><span class="o">/</span><span class="n">arch</span><span class="o">/</span><span class="n">x86</span><span class="o">/</span><span class="n">isa</span><span class="o">/</span><span class="n">microops</span><span class="o">/</span><span class="n">base</span><span class="p">.</span><span class="n">isa</span>

<span class="n">let</span> <span class="p">{{</span>
    <span class="c1"># This will be populated with mappings between microop mnemonics and
</span>    <span class="c1"># the classes that represent them.
</span>    <span class="n">microopClasses</span> <span class="o">=</span> <span class="p">{}</span>
<span class="p">}};</span>

</pre></td></tr></tbody></table></code></div></div>
<p>microopClasses is a Python dictionary that comprises pairs of microop mnemonic 
strings along with their associated class definitions. It’s important to 
emphasize that each microop operation is itself represented as a class. 
The provided microopClasses dictionary will be assigned to the ‘microops’ member
field of the MicroAssembler. We’ll soon explore how the GEM5 parser will populate
this dictionary.</p>

<h1 id="parse-macroops-with-python-yacc">Parse macroops with python yacc</h1>
<p>Now that you might grasp the need for architecture-specific classes defining 
both macroop operations and the corresponding microops dictionary. It’s time to
delve into how the MicroAssembler class effectively employs these classes to 
parse macroops within a specific architecture.</p>

<p><em>gem5/src/arch/micro_asm.py</em></p>
<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="rouge-code"><pre><span class="mi">489</span> <span class="k">class</span> <span class="nc">MicroAssembler</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="mi">490</span>
<span class="mi">491</span>     <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">macro_type</span><span class="p">,</span> <span class="n">microops</span><span class="p">,</span>
<span class="mi">492</span>             <span class="n">rom</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">rom_macroop_type</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
<span class="mi">493</span>         <span class="n">self</span><span class="p">.</span><span class="n">lexer</span> <span class="o">=</span> <span class="n">lex</span><span class="p">.</span><span class="nf">lex</span><span class="p">()</span>
<span class="mi">494</span>         <span class="n">self</span><span class="p">.</span><span class="n">parser</span> <span class="o">=</span> <span class="n">yacc</span><span class="p">.</span><span class="nf">yacc</span><span class="p">()</span>
<span class="mi">495</span>         <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="n">macro_type</span> <span class="o">=</span> <span class="n">macro_type</span>
<span class="mi">496</span>         <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="n">macroops</span> <span class="o">=</span> <span class="p">{}</span>
<span class="mi">497</span>         <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="n">microops</span> <span class="o">=</span> <span class="n">microops</span>
<span class="mi">498</span>         <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="n">rom</span> <span class="o">=</span> <span class="n">rom</span>
<span class="mi">499</span>         <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="n">rom_macroop_type</span> <span class="o">=</span> <span class="n">rom_macroop_type</span>
<span class="mi">500</span>         <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="n">symbols</span> <span class="o">=</span> <span class="p">{}</span>
<span class="mi">501</span>         <span class="n">self</span><span class="p">.</span><span class="n">symbols</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="n">symbols</span>
<span class="mi">502</span>
<span class="mi">503</span>     <span class="k">def</span> <span class="nf">assemble</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">asm</span><span class="p">):</span>
<span class="mi">504</span>         <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">asm</span><span class="p">,</span> <span class="n">lexer</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">lexer</span><span class="p">)</span>
<span class="mi">505</span>         <span class="n">macroops</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="n">macroops</span>
<span class="mi">506</span>         <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="n">macroops</span> <span class="o">=</span> <span class="p">{}</span>
<span class="mi">507</span>         <span class="k">return</span> <span class="n">macroops</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Upon revisiting the MicroAssembler class, we find a single function definition 
called assemble. This function processes assembly code using the yacc parser and 
produce macroops as its output.</p>

<h2 id="python-yacc"><span class="me-2">Python Yacc</span><a href="#python-yacc" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<p>To comprehend how GEM5 leverages Yacc for assembly parsing, we need to grasp the 
essential components of the Yacc parser and the metadata required for parsing,
which includes lexer definitions, grammar rules, and the input to be parsed.</p>

<h3 id="what-to-parse-microcode-implementation-of-macroops"><span class="me-2">What to parse? microcode implementation of macroops</span><a href="#what-to-parse-microcode-implementation-of-macroops" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>What is the asm input of the assemble function?</p>

<p>*gem5/src/arch/x86/isa/microasm.isa</p>
<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre>
<span class="mi">222</span>     <span class="n">macroopdict</span> <span class="o">=</span> <span class="n">assembler</span><span class="p">.</span><span class="nf">assemble</span><span class="p">(</span><span class="n">microcode</span><span class="p">)</span>
<span class="mi">223</span>
<span class="mi">224</span>     <span class="n">decoder_output</span> <span class="o">+=</span> <span class="n">mainrom</span><span class="p">.</span><span class="nf">getdefinition</span><span class="p">()</span>
<span class="mi">225</span>     <span class="n">header_output</span> <span class="o">+=</span> <span class="n">mainrom</span><span class="p">.</span><span class="nf">getdeclaration</span><span class="p">()</span>
<span class="mi">226</span> <span class="p">}};</span>

</pre></td></tr></tbody></table></code></div></div>

<p>When we examine the location where the ‘assemble’ function is called, it becomes 
apparent that the ‘asm’ represents a microcode. Despite its potentially 
misleading name, it’s important to clarify that ‘microcode’ is a long 
concatenated string object of all macroops in that specific architecture. Each
macroop string in the ‘microcode’ represents one instruction. These microcode 
strings are gathered from individual ISA files found in the ‘isa/insts’
directory, where all the architecture specific macroops are defined.</p>

<p><em>src/arch/x86/isa/inst/general_purpose/data_transfer/move.py</em></p>
<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre><span class="n">microcode</span> <span class="o">=</span> <span class="sh">'''</span><span class="s">

#
# Regular moves
#

def macroop MOV_R_MI {
    limm t1, imm, dataSize=asz
    ld reg, seg, [1, t0, t1]
};

def macroop MOV_MI_R {
    limm t1, imm, dataSize=asz
    st reg, seg, [1, t0, t1]
};
</span></pre></td></tr></tbody></table></code></div></div>

<p>As indicated in the code, each ISA file defines a string for each macroop, 
describing how a specific macroop is composed of microops.</p>

<p><em>gem5/src/arch/x86/isa/insts/general_purpose/data_transfer/<strong>init</strong>.py</em></p>
<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre> <span class="mi">38</span> <span class="n">categories</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">conditional_move</span><span class="sh">"</span><span class="p">,</span>
 <span class="mi">39</span>               <span class="sh">"</span><span class="s">move</span><span class="sh">"</span><span class="p">,</span>
 <span class="mi">40</span>               <span class="sh">"</span><span class="s">stack_operations</span><span class="sh">"</span><span class="p">,</span>
 <span class="mi">41</span>               <span class="sh">"</span><span class="s">xchg</span><span class="sh">"</span><span class="p">]</span>
 <span class="mi">42</span>
 <span class="mi">43</span> <span class="n">microcode</span> <span class="o">=</span> <span class="sh">""</span>
 <span class="mi">44</span> <span class="k">for</span> <span class="n">category</span> <span class="ow">in</span> <span class="n">categories</span><span class="p">:</span>
 <span class="mi">45</span>     <span class="k">exec</span> <span class="sh">"</span><span class="s">import %s as cat</span><span class="sh">"</span> <span class="o">%</span> <span class="n">category</span>
 <span class="mi">46</span>     <span class="n">microcode</span> <span class="o">+=</span> <span class="n">cat</span><span class="p">.</span><span class="n">microcode</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Within each instruction category, the ‘<strong>init</strong>.py’ file in the corresponding
directory iterates through each ISA file, gathering architecture-specific 
macroops defined as strings. Since different directories define different 
types of instruction (macroop) defined in that architecture, the generated 
microcode string used by the assembler represents entirety of macroops.</p>

<h3 id="lexer-definition-for-tokenization"><span class="me-2">Lexer definition for tokenization</span><a href="#lexer-definition-for-tokenization" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>It’s important to keep in mind that GEM5 utilizes DSL to define macroops. While
these macroops are implemented with Python-like semantics, they don’t conform to
actual Python syntax. Consequently, to convert this Python-like syntax into code 
that a compiler, in GEM5’s case C++ statements, can comprehend, the lexer must
be able to recognize the language-specific keywords defined within the DSL.</p>

<p>To illustrate, just as the def keyword in standard Python syntax translates to a 
function definition, the lexer should be capable of recognizing <strong>macroop</strong> as 
another keyword whenever it encounters def macroop block. In this context, this 
definition of a keyword is referred to as a “token.” All the lexer definitions 
necessary for parsing the microcode of macroops are specified in 
‘gem5/src/arch/micro_asm.py.’ The syntax for the Python lexer can be found in
<a href="https://www.dabeaz.com/ply/ply.html#ply_nn0">here</a>.</p>

<h3 id="context-free-grammar-for-x86-macroop"><span class="me-2">Context-free grammar for X86 macroop</span><a href="#context-free-grammar-for-x86-macroop" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre> <span class="mi">38</span> <span class="n">microcode</span> <span class="o">=</span> <span class="sh">'''</span><span class="s">
 39
 40 #
 41 # Regular moves
 42 #
 43
 44 def macroop MOV_R_MI {
 45     limm t1, imm, dataSize=asz
 46     ld reg, seg, [1, t0, t1]
 47 };
</span></pre></td></tr></tbody></table></code></div></div>
<p>While def macroop MOV_R_MI may resemble a typical function definition block in 
Python, its syntax cannot be interpreted by Python as a function (particularly 
given that MOV_R_MI follows the def macroop). To parse this GEM5 DSL, yacc needs
Context-Free-Grammar (CFG) defining the right syntax of the DSL. CFG allows yacc 
to parse macroop defined in GEM5 DSL and translate them into C++ which GEM5 can
understand. Let’s see CFG rule associated with parsing MOV_R_MI macroop.</p>

<p><em>gem5/src/arch/micro_asm.py</em></p>
<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre><span class="mi">351</span> <span class="c1"># Defines a macroop that is combinationally generated
</span><span class="mi">352</span> <span class="k">def</span> <span class="nf">p_macroop_def_1</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
<span class="mi">353</span>     <span class="sh">'</span><span class="s">macroop_def : DEF MACROOP ID block SEMI</span><span class="sh">'</span>
<span class="mi">354</span>     <span class="k">try</span><span class="p">:</span>
<span class="mi">355</span>         <span class="n">curop</span> <span class="o">=</span> <span class="n">t</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="nf">macro_type</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
<span class="mi">356</span>     <span class="k">except</span> <span class="nb">TypeError</span><span class="p">:</span>
<span class="mi">357</span>         <span class="nf">print_error</span><span class="p">(</span><span class="sh">"</span><span class="s">Error creating macroop object.</span><span class="sh">"</span><span class="p">)</span>
<span class="mi">358</span>         <span class="k">raise</span>
<span class="mi">359</span>     <span class="k">for</span> <span class="n">statement</span> <span class="ow">in</span> <span class="n">t</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">statements</span><span class="p">:</span>
<span class="mi">360</span>         <span class="nf">handle_statement</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">parser</span><span class="p">,</span> <span class="n">curop</span><span class="p">,</span> <span class="n">statement</span><span class="p">)</span>
<span class="mi">361</span>     <span class="n">t</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="n">macroops</span><span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span> <span class="o">=</span> <span class="n">curop</span>
</pre></td></tr></tbody></table></code></div></div>

<p>When the def macroop block is encountered, while parsing the microcode,  it 
calls one of the p_macroop_def_X functions based on the format of the macroop 
block (depending on the tokens within the def block). As the macroop block can 
take various formats, the corresponding context-free grammar matching precisely
with the macroop block is invoked. In this particular case, we are examining the
def macroop MOV_R_MI block, so the p_macroop_def_1 function will be invoked.</p>

<p>On line 355, you can observe that <strong>t[3]</strong>, representing the mnemonic of the 
currently parsed macroop, is passed to the macro_type function of the parser.
Keep in mind that the parser is a member field of the 
<a href="#microassembler">MicroAssembler class</a>, and the <strong>X86Macroop</strong> namespace has 
been assigned to parser.macro_type. Therefore, t.parser.macro_type(t[3]) gets 
translated into <strong>X86Macroop(MOV_R_MI)</strong> which will invoke
the <a href="#x86macroop">constructor call for the X86Macroop object</a>. This means that
whenever a def macroop block is encountered during parsing, it translates the 
def block into initialization code for X86Macroop python object.</p>

<h3 id="block-token-microops-consisting-of-macroop"><span class="me-2">Block token: microops consisting of macroop</span><a href="#block-token-microops-consisting-of-macroop" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>You may recall that a single X86Macroop object can encompass all the information
about a specific macroop operation, including its constituent microops. However,
right after the macroop instance is populated, it initially contains no 
information about the microops composing the current macroop class instance. As
indicated in the code snippet on lines 359-360, the parser proceeds to parse the
subsequent statements within the def macroop block and translates each microop 
operation into the corresponding microop classes. As observed in the earlier 
definition of a macroop, it becomes evident that the ‘block’ token represents a
collection of multiple lines of microops, forming a single macroop.</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre> <span class="mi">92</span> <span class="k">class</span> <span class="nc">Block</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
 <span class="mi">93</span>     <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
 <span class="mi">94</span>         <span class="n">self</span><span class="p">.</span><span class="n">statements</span> <span class="o">=</span> <span class="p">[]</span>
 <span class="mi">95</span>
<span class="p">...</span><span class="bp">...</span>
<span class="mi">363</span> <span class="c1"># A block of statements
</span><span class="mi">364</span> <span class="k">def</span> <span class="nf">p_block</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
<span class="mi">365</span>     <span class="sh">'</span><span class="s">block : LBRACE statements RBRACE</span><span class="sh">'</span>
<span class="mi">366</span>     <span class="n">block</span> <span class="o">=</span> <span class="nc">Block</span><span class="p">()</span>
<span class="mi">367</span>     <span class="n">block</span><span class="p">.</span><span class="n">statements</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="mi">368</span>     <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">block</span>
</pre></td></tr></tbody></table></code></div></div>
<p>As demonstrated in the grammar for block parsing, when the parser encounters the
‘block’ token, it initiates the creation of a ‘block’ object instance and 
subsequently adds the parsed statements (microops in string) to the ‘statement’
field of the block.</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre> <span class="mi">96</span> <span class="k">class</span> <span class="nc">Statement</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
 <span class="mi">97</span>     <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
 <span class="mi">98</span>         <span class="n">self</span><span class="p">.</span><span class="n">is_microop</span> <span class="o">=</span> <span class="bp">False</span>
 <span class="mi">99</span>         <span class="n">self</span><span class="p">.</span><span class="n">is_directive</span> <span class="o">=</span> <span class="bp">False</span>
<span class="mi">100</span>         <span class="n">self</span><span class="p">.</span><span class="n">params</span> <span class="o">=</span> <span class="sh">""</span>
<span class="mi">101</span>
<span class="mi">102</span> <span class="k">class</span> <span class="nc">Microop</span><span class="p">(</span><span class="n">Statement</span><span class="p">):</span>
<span class="mi">103</span>     <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
<span class="mi">104</span>         <span class="nf">super</span><span class="p">(</span><span class="n">Microop</span><span class="p">,</span> <span class="n">self</span><span class="p">).</span><span class="nf">__init__</span><span class="p">()</span>
<span class="mi">105</span>         <span class="n">self</span><span class="p">.</span><span class="n">mnemonic</span> <span class="o">=</span> <span class="sh">""</span>
<span class="mi">106</span>         <span class="n">self</span><span class="p">.</span><span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span>
<span class="mi">107</span>         <span class="n">self</span><span class="p">.</span><span class="n">is_microop</span> <span class="o">=</span> <span class="bp">True</span>
</pre></td></tr></tbody></table></code></div></div>
<p>Each Block object has statement member field, and its entries can be interpreted
as either microop or directive class. The block token grammar consists of two 
braces and one statements. The statements is a string consists of more than one 
microops. Therefore, each microops consisting of the statement should be parsed
further, and another CFG for parsing statements is required.</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
</pre></td><td class="rouge-code"><pre>
<span class="mi">376</span> <span class="k">def</span> <span class="nf">p_statements_0</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
<span class="mi">377</span>     <span class="sh">'</span><span class="s">statements : statement</span><span class="sh">'</span>
<span class="mi">378</span>     <span class="k">if</span> <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
<span class="mi">379</span>         <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
<span class="mi">380</span>     <span class="k">else</span><span class="p">:</span>
<span class="mi">381</span>         <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<span class="mi">382</span>
<span class="mi">383</span> <span class="k">def</span> <span class="nf">p_statements_1</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
<span class="mi">384</span>     <span class="sh">'</span><span class="s">statements : statements statement</span><span class="sh">'</span>
<span class="mi">385</span>     <span class="k">if</span> <span class="n">t</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
<span class="mi">386</span>         <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">append</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
<span class="mi">387</span>     <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="mi">388</span>
<span class="mi">389</span> <span class="k">def</span> <span class="nf">p_statement</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
<span class="mi">390</span>     <span class="sh">'</span><span class="s">statement : content_of_statement end_of_statement</span><span class="sh">'</span>
<span class="mi">391</span>     <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="mi">392</span>
<span class="mi">393</span> <span class="c1"># A statement can be a microop or an assembler directive
</span><span class="mi">394</span> <span class="k">def</span> <span class="nf">p_content_of_statement_0</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
<span class="mi">395</span>     <span class="sh">'''</span><span class="s">content_of_statement : microop
396                             | directive</span><span class="sh">'''</span>
<span class="mi">397</span>     <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="mi">398</span>
<span class="mi">399</span> <span class="c1"># Ignore empty statements
</span><span class="mi">400</span> <span class="k">def</span> <span class="nf">p_content_of_statement_1</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
<span class="mi">401</span>     <span class="sh">'</span><span class="s">content_of_statement : </span><span class="sh">'</span>
<span class="mi">402</span>     <span class="k">pass</span>
<span class="mi">403</span>
<span class="mi">404</span> <span class="c1"># Statements are ended by newlines or a semi colon
</span><span class="mi">405</span> <span class="k">def</span> <span class="nf">p_end_of_statement</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
<span class="mi">406</span>     <span class="sh">'''</span><span class="s">end_of_statement : NEWLINE
407                         | SEMI</span><span class="sh">'''</span>
<span class="mi">408</span>     <span class="k">pass</span>

</pre></td></tr></tbody></table></code></div></div>

<p>Let’s break down the rules outlined above in a step-by-step manner. Firstly, a 
‘statements’ can be interpreted as a ‘statement’ or another ‘statements’ 
followed by a ‘statement’ (as described in lines 376-387). Each ‘statement’ 
comprises ‘content_of_statement’ and ‘end_of_statement’ tokens (as indicated in
lines 389-391). Each ‘content of statement,’ can have either a ‘microop’ or a 
‘directive’ (as demonstrated in lines 394-397). Given our specific interest in 
cases where each ‘statement’ corresponds to a single ‘microop,’ let’s delve into
the grammatical rules for ‘microop’.”</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre><span class="mi">410</span> <span class="c1"># Different flavors of microop to avoid shift/reduce errors
</span><span class="mi">411</span> <span class="k">def</span> <span class="nf">p_microop_0</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
<span class="mi">412</span>     <span class="sh">'</span><span class="s">microop : labels ID</span><span class="sh">'</span>
<span class="mi">413</span>     <span class="n">microop</span> <span class="o">=</span> <span class="nc">Microop</span><span class="p">()</span>
<span class="mi">414</span>     <span class="n">microop</span><span class="p">.</span><span class="n">labels</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="mi">415</span>     <span class="n">microop</span><span class="p">.</span><span class="n">mnemonic</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="mi">416</span>     <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">microop</span>
<span class="bp">...</span>
<span class="mi">431</span>
<span class="mi">432</span> <span class="k">def</span> <span class="nf">p_microop_3</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
<span class="mi">433</span>     <span class="sh">'</span><span class="s">microop : ID PARAMS</span><span class="sh">'</span>
<span class="mi">434</span>     <span class="n">microop</span> <span class="o">=</span> <span class="nc">Microop</span><span class="p">()</span>
<span class="mi">435</span>     <span class="n">microop</span><span class="p">.</span><span class="n">mnemonic</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="mi">436</span>     <span class="n">microop</span><span class="p">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="mi">437</span>     <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">microop</span>
</pre></td></tr></tbody></table></code></div></div>

<p>GEM5 defines various grammar rules for ‘microop,’ but our specific case (i.e., 
‘limm t1, imm, dataSize=asz’) aligns with the ‘p_microop_3 grammar rule’ When 
the parser encounters a ‘microop’ statement consisting of microop ID (mnemonic)
and PARAMS (parameters of the microop), it generates a ‘Microop’ instance. It 
then assigns the parsed mnemonic and parameters to their respective fields 
within the ‘Microop’ object.</p>

<h2 id="translating-microops-to-python-class-object"><span class="me-2">Translating microops to python class object</span><a href="#translating-microops-to-python-class-object" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<p>Now, we have gained insight into how GEM5 parses a ‘def’ block that defines a 
‘macroop’ and translates its statements into ‘microop’ objects. However, this 
isn’t the final step in parsing ‘macroops.’ Let’s revisit the ‘p_macroop_def_1’
function. While the ‘macroop’ is translated into an ‘X86Macroop’ object, the 
‘microops’ that make up this ‘macroop’ have not yet been translated into their 
respective counterparts.</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="mi">352</span> <span class="k">def</span> <span class="nf">p_macroop_def_1</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>                                                     
<span class="mi">353</span>     <span class="sh">'</span><span class="s">macroop_def : DEF MACROOP ID block SEMI</span><span class="sh">'</span>                               
<span class="mi">354</span>     <span class="k">try</span><span class="p">:</span>                                                                    
<span class="mi">355</span>         <span class="n">curop</span> <span class="o">=</span> <span class="n">t</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="nf">macro_type</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>                                   
<span class="mi">356</span>     <span class="k">except</span> <span class="nb">TypeError</span><span class="p">:</span>                                                       
<span class="mi">357</span>         <span class="nf">print_error</span><span class="p">(</span><span class="sh">"</span><span class="s">Error creating macroop object.</span><span class="sh">"</span><span class="p">)</span>                       
<span class="mi">358</span>         <span class="k">raise</span>                                                               
<span class="mi">359</span>     <span class="k">for</span> <span class="n">statement</span> <span class="ow">in</span> <span class="n">t</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">statements</span><span class="p">:</span>                                       
<span class="mi">360</span>         <span class="nf">handle_statement</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">parser</span><span class="p">,</span> <span class="n">curop</span><span class="p">,</span> <span class="n">statement</span><span class="p">)</span>                        
<span class="mi">361</span>     <span class="n">t</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="n">macroops</span><span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span> <span class="o">=</span> <span class="n">curop</span>  
</pre></td></tr></tbody></table></code></div></div>

<p>In the lines 359-360 of the macroop parsing function, it goes through each 
statement, which in this context refers to the microops making up the macroop, 
and invokes the ‘handle_statement’ function. It’s crucial to emphasize that this
function necessitates both the ‘curop,’ representing the currently parsed 
‘X86Macroop’ object, and the ‘statement’, representing an individual microop.</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre></td><td class="rouge-code"><pre><span class="mi">126</span> <span class="k">def</span> <span class="nf">handle_statement</span><span class="p">(</span><span class="n">parser</span><span class="p">,</span> <span class="n">container</span><span class="p">,</span> <span class="n">statement</span><span class="p">):</span>
<span class="mi">127</span>     <span class="k">if</span> <span class="n">statement</span><span class="p">.</span><span class="n">is_microop</span><span class="p">:</span>
<span class="mi">128</span>         <span class="k">if</span> <span class="n">statement</span><span class="p">.</span><span class="n">mnemonic</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">parser</span><span class="p">.</span><span class="n">microops</span><span class="p">.</span><span class="nf">keys</span><span class="p">():</span>
<span class="mi">129</span>             <span class="k">raise</span> <span class="nb">Exception</span><span class="p">,</span> <span class="sh">"</span><span class="s">Unrecognized mnemonic: %s</span><span class="sh">"</span> <span class="o">%</span> <span class="n">statement</span><span class="p">.</span><span class="n">mnemonic</span>
<span class="mi">130</span>         <span class="n">parser</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="sh">"</span><span class="s">__microopClassFromInsideTheAssembler</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> \
<span class="mi">131</span>             <span class="n">parser</span><span class="p">.</span><span class="n">microops</span><span class="p">[</span><span class="n">statement</span><span class="p">.</span><span class="n">mnemonic</span><span class="p">]</span>
<span class="mi">132</span>         <span class="k">try</span><span class="p">:</span>
<span class="mi">133</span>             <span class="n">microop</span> <span class="o">=</span> <span class="nf">eval</span><span class="p">(</span><span class="sh">'</span><span class="s">__microopClassFromInsideTheAssembler(%s)</span><span class="sh">'</span> <span class="o">%</span>
<span class="mi">134</span>                     <span class="n">statement</span><span class="p">.</span><span class="n">params</span><span class="p">,</span> <span class="p">{},</span> <span class="n">parser</span><span class="p">.</span><span class="n">symbols</span><span class="p">)</span>
<span class="mi">135</span>         <span class="k">except</span><span class="p">:</span>
<span class="mi">136</span>             <span class="nf">print_error</span><span class="p">(</span><span class="sh">"</span><span class="s">Error creating microop object with mnemonic %s.</span><span class="sh">"</span> <span class="o">%</span> \
<span class="mi">137</span>                     <span class="n">statement</span><span class="p">.</span><span class="n">mnemonic</span><span class="p">)</span>
<span class="mi">138</span>             <span class="k">raise</span>
<span class="mi">139</span>         <span class="k">try</span><span class="p">:</span>
<span class="mi">140</span>             <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">statement</span><span class="p">.</span><span class="n">labels</span><span class="p">:</span>
<span class="mi">141</span>                 <span class="n">container</span><span class="p">.</span><span class="n">labels</span><span class="p">[</span><span class="n">label</span><span class="p">.</span><span class="n">text</span><span class="p">]</span> <span class="o">=</span> <span class="n">microop</span>
<span class="mi">142</span>                 <span class="k">if</span> <span class="n">label</span><span class="p">.</span><span class="n">is_extern</span><span class="p">:</span>
<span class="mi">143</span>                     <span class="n">container</span><span class="p">.</span><span class="n">externs</span><span class="p">[</span><span class="n">label</span><span class="p">.</span><span class="n">text</span><span class="p">]</span> <span class="o">=</span> <span class="n">microop</span>
<span class="mi">144</span>             <span class="n">container</span><span class="p">.</span><span class="nf">add_microop</span><span class="p">(</span><span class="n">statement</span><span class="p">.</span><span class="n">mnemonic</span><span class="p">,</span> <span class="n">microop</span><span class="p">)</span>
<span class="mi">145</span>         <span class="k">except</span><span class="p">:</span>
<span class="mi">146</span>             <span class="nf">print_error</span><span class="p">(</span><span class="sh">"</span><span class="s">Error adding microop.</span><span class="sh">"</span><span class="p">)</span>
<span class="mi">147</span>             <span class="k">raise</span>
<span class="mi">148</span>     <span class="k">elif</span> <span class="n">statement</span><span class="p">.</span><span class="n">is_directive</span><span class="p">:</span>
<span class="mi">149</span>         <span class="k">if</span> <span class="n">statement</span><span class="p">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">container</span><span class="p">.</span><span class="n">directives</span><span class="p">.</span><span class="nf">keys</span><span class="p">():</span>
<span class="mi">150</span>             <span class="k">raise</span> <span class="nb">Exception</span><span class="p">,</span> <span class="sh">"</span><span class="s">Unrecognized directive: %s</span><span class="sh">"</span> <span class="o">%</span> <span class="n">statement</span><span class="p">.</span><span class="n">name</span>
<span class="mi">151</span>         <span class="n">parser</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="sh">"</span><span class="s">__directiveFunctionFromInsideTheAssembler</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> \
<span class="mi">152</span>             <span class="n">container</span><span class="p">.</span><span class="n">directives</span><span class="p">[</span><span class="n">statement</span><span class="p">.</span><span class="n">name</span><span class="p">]</span>
<span class="mi">153</span>         <span class="k">try</span><span class="p">:</span>
<span class="mi">154</span>             <span class="nf">eval</span><span class="p">(</span><span class="sh">'</span><span class="s">__directiveFunctionFromInsideTheAssembler(%s)</span><span class="sh">'</span> <span class="o">%</span>
<span class="mi">155</span>                     <span class="n">statement</span><span class="p">.</span><span class="n">params</span><span class="p">,</span> <span class="p">{},</span> <span class="n">parser</span><span class="p">.</span><span class="n">symbols</span><span class="p">)</span>
<span class="mi">156</span>         <span class="k">except</span><span class="p">:</span>
<span class="mi">157</span>             <span class="nf">print_error</span><span class="p">(</span><span class="sh">"</span><span class="s">Error executing directive.</span><span class="sh">"</span><span class="p">)</span>
<span class="mi">158</span>             <span class="nf">print</span><span class="p">(</span><span class="n">container</span><span class="p">.</span><span class="n">directives</span><span class="p">)</span>
<span class="mi">159</span>             <span class="k">raise</span>
<span class="mi">160</span>     <span class="k">else</span><span class="p">:</span>
<span class="mi">161</span>         <span class="k">raise</span> <span class="nb">Exception</span><span class="p">,</span> <span class="sh">"</span><span class="s">Didn</span><span class="sh">'</span><span class="s">t recognize the type of statement</span><span class="sh">"</span><span class="p">,</span> <span class="n">statement</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Each statement in the code can be either a ‘microop’ or a ‘directive,’ and the 
processing of each statement depends on its type. Since we are currently 
focusing on ‘microops,’ let’s delve into the first conditional part 
(lines 127-147). As depicted in lines 130-131, <a href="#microopDict">microop dictionary</a> 
is used to look up the class associated with the current microop mnemonic. To 
represent each microops, GEM5 defines python classes representing each microop. 
The class retrieved from this dictionary is stored in the symbol variable of the
parser. It’s important to note that the parsed microop’s mnemonic field 
(i.e., ‘statement.mnemonic’) is used to find the corresponding reference to the 
microop class.</p>

<h3 id="what-class-object-is-used-for-microop-class-generation"><span class="me-2">What class object is used for microop class generation?</span><a href="#what-class-object-is-used-for-microop-class-generation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>It might be anticipated that the parsed microop instructions would be 
instantiated from a class with the same name as the microop mnemonic (microop 
opcode), like ‘Ld.’ However, upon closer examination, it becomes evident that 
a more general class is associated with the group of microops, and it doesn’t 
precisely match the microop mnemonic. For example, in the case of the ‘ld’ 
microop, the associated template class used is ‘LoadOp’ instead of ‘Ld’.
Similarly, for the ‘limm’ microop instruction, an ‘LimmOp’ class will represent
this microop. The explanation for this behavior can be found in the ‘let’ block.</p>

<p><em>gem5/src/arch/x86/isa/microops/limop.isa</em></p>
<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre></td><td class="rouge-code"><pre>
<span class="mi">105</span> <span class="n">let</span> <span class="p">{{</span>
<span class="mi">106</span>     <span class="k">class</span> <span class="nc">LimmOp</span><span class="p">(</span><span class="n">X86Microop</span><span class="p">):</span>
<span class="mi">107</span>         <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">imm</span><span class="p">,</span> <span class="n">dataSize</span><span class="o">=</span><span class="sh">"</span><span class="s">env.dataSize</span><span class="sh">"</span><span class="p">):</span>
<span class="mi">108</span>             <span class="n">self</span><span class="p">.</span><span class="n">className</span> <span class="o">=</span> <span class="sh">"</span><span class="s">Limm</span><span class="sh">"</span>
<span class="mi">109</span>             <span class="n">self</span><span class="p">.</span><span class="n">mnemonic</span> <span class="o">=</span> <span class="sh">"</span><span class="s">limm</span><span class="sh">"</span>
<span class="mi">110</span>             <span class="n">self</span><span class="p">.</span><span class="n">dest</span> <span class="o">=</span> <span class="n">dest</span>
<span class="mi">111</span>             <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">imm</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">long</span><span class="p">)):</span>
<span class="mi">112</span>                 <span class="n">imm</span> <span class="o">=</span> <span class="sh">"</span><span class="s">ULL(%d)</span><span class="sh">"</span> <span class="o">%</span> <span class="n">imm</span>
<span class="mi">113</span>             <span class="n">self</span><span class="p">.</span><span class="n">imm</span> <span class="o">=</span> <span class="n">imm</span>
<span class="mi">114</span>             <span class="n">self</span><span class="p">.</span><span class="n">dataSize</span> <span class="o">=</span> <span class="n">dataSize</span>
<span class="mi">115</span>
<span class="mi">116</span>         <span class="k">def</span> <span class="nf">getAllocator</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">microFlags</span><span class="p">):</span>
<span class="mi">117</span>             <span class="n">allocString</span> <span class="o">=</span> <span class="sh">'''</span><span class="s">
118                 (%(dataSize)s &gt;= 4) ?
119                     (StaticInstPtr)(new %(class_name)sBig(machInst,
120                         macrocodeBlock, %(flags)s, %(dest)s, %(imm)s,
121                         %(dataSize)s)) :
122                     (StaticInstPtr)(new %(class_name)s(machInst,
123                         macrocodeBlock, %(flags)s, %(dest)s, %(imm)s,
124                         %(dataSize)s))
125             </span><span class="sh">'''</span>
<span class="mi">126</span>             <span class="n">allocator</span> <span class="o">=</span> <span class="n">allocString</span> <span class="o">%</span> <span class="p">{</span>
<span class="mi">127</span>                 <span class="sh">"</span><span class="s">class_name</span><span class="sh">"</span> <span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">className</span><span class="p">,</span>
<span class="mi">128</span>                 <span class="sh">"</span><span class="s">mnemonic</span><span class="sh">"</span> <span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">mnemonic</span><span class="p">,</span>
<span class="mi">129</span>                 <span class="sh">"</span><span class="s">flags</span><span class="sh">"</span> <span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="nf">microFlagsText</span><span class="p">(</span><span class="n">microFlags</span><span class="p">),</span>
<span class="mi">130</span>                 <span class="sh">"</span><span class="s">dest</span><span class="sh">"</span> <span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">dest</span><span class="p">,</span> <span class="sh">"</span><span class="s">imm</span><span class="sh">"</span> <span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">imm</span><span class="p">,</span>
<span class="mi">131</span>                 <span class="sh">"</span><span class="s">dataSize</span><span class="sh">"</span> <span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">dataSize</span><span class="p">}</span>
<span class="mi">132</span>             <span class="k">return</span> <span class="n">allocator</span>
<span class="mi">133</span>
<span class="mi">134</span>     <span class="n">microopClasses</span><span class="p">[</span><span class="sh">"</span><span class="s">limm</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">LimmOp</span>
<span class="p">...</span><span class="bp">...</span>
<span class="mi">159</span> <span class="p">}};</span>

</pre></td></tr></tbody></table></code></div></div>

<p>A key takeaway from the ‘let’ block above is that it associates the class
‘LimmOp’ with its corresponding mnemonic (‘limm’) within the Python dictionary 
called ‘microopClasses’. Consequently, when the dictionary is queried using a
microop’s mnemonic, such as ‘limm,’ it will return the related Python class, 
‘LimmOp.’</p>

<h3 id="microop-class-instantiation"><span class="me-2">Microop class instantiation</span><a href="#microop-class-instantiation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>Following <em>eval</em> statement(133-134) instantiates microop class object.</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="mi">126</span> <span class="k">def</span> <span class="nf">handle_statement</span><span class="p">(</span><span class="n">parser</span><span class="p">,</span> <span class="n">container</span><span class="p">,</span> <span class="n">statement</span><span class="p">):</span>                         
<span class="mi">127</span>     <span class="k">if</span> <span class="n">statement</span><span class="p">.</span><span class="n">is_microop</span><span class="p">:</span>                                                
<span class="mi">128</span>         <span class="k">if</span> <span class="n">statement</span><span class="p">.</span><span class="n">mnemonic</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">parser</span><span class="p">.</span><span class="n">microops</span><span class="p">.</span><span class="nf">keys</span><span class="p">():</span>                
<span class="mi">129</span>             <span class="k">raise</span> <span class="nb">Exception</span><span class="p">,</span> <span class="sh">"</span><span class="s">Unrecognized mnemonic: %s</span><span class="sh">"</span> <span class="o">%</span> <span class="n">statement</span><span class="p">.</span><span class="n">mnemonic</span>
<span class="mi">130</span>         <span class="n">parser</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="sh">"</span><span class="s">__microopClassFromInsideTheAssembler</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> \          
<span class="mi">131</span>             <span class="n">parser</span><span class="p">.</span><span class="n">microops</span><span class="p">[</span><span class="n">statement</span><span class="p">.</span><span class="n">mnemonic</span><span class="p">]</span>                             
<span class="mi">132</span>         <span class="k">try</span><span class="p">:</span>                                                                
<span class="mi">133</span>             <span class="n">microop</span> <span class="o">=</span> <span class="nf">eval</span><span class="p">(</span><span class="sh">'</span><span class="s">__microopClassFromInsideTheAssembler(%s)</span><span class="sh">'</span> <span class="o">%</span>     
<span class="mi">134</span>                     <span class="n">statement</span><span class="p">.</span><span class="n">params</span><span class="p">,</span> <span class="p">{},</span> <span class="n">parser</span><span class="p">.</span><span class="n">symbols</span><span class="p">)</span>    
</pre></td></tr></tbody></table></code></div></div>
<p>A microop class object is instantiated using the previously retrieved microop 
class. Notably, the ‘statement.params’ variable is passed as an argument to the
‘eval’ function. This step is essential because different microops, may require 
different microop arguments. Therefore, it is imperative to pass these arguments
correctly to create the appropriate microop instances. The ‘statement.params’ 
argument contains all the microop operands that follow a microop mnemonic. For 
example, the ‘limm’ microop, as used in the ‘MOV_R_MI’ macroop definition, 
includes operands such as ‘t1, imm, dataSize=asz.’</p>

<p>Before the ‘eval’ function is executed, the microop’s operands are initially 
formatted as a string. However, because eval takes parser.symbol as its 
<em>local mapping dictionary</em>, these string operands are transformed into code 
statements that can be understood by the microop classes. For instance, the 
first operand ‘t1’ is translated into ‘InstRegIndex(NUM_INTREGS+1)’ as a result 
of the ‘eval’. Subsequently, these translated operands are provided to the 
constructor of the corresponding microop class based on the microop’s mnemonic.</p>

<p><em>gem5/src/arch/x86/isa/microops/limop.isa</em></p>
<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre></td><td class="rouge-code"><pre>
<span class="mi">105</span> <span class="n">let</span> <span class="p">{{</span>
<span class="mi">106</span>     <span class="k">class</span> <span class="nc">LimmOp</span><span class="p">(</span><span class="n">X86Microop</span><span class="p">):</span>
<span class="mi">107</span>         <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">imm</span><span class="p">,</span> <span class="n">dataSize</span><span class="o">=</span><span class="sh">"</span><span class="s">env.dataSize</span><span class="sh">"</span><span class="p">):</span>
<span class="mi">108</span>             <span class="n">self</span><span class="p">.</span><span class="n">className</span> <span class="o">=</span> <span class="sh">"</span><span class="s">Limm</span><span class="sh">"</span>
<span class="mi">109</span>             <span class="n">self</span><span class="p">.</span><span class="n">mnemonic</span> <span class="o">=</span> <span class="sh">"</span><span class="s">limm</span><span class="sh">"</span>
<span class="mi">110</span>             <span class="n">self</span><span class="p">.</span><span class="n">dest</span> <span class="o">=</span> <span class="n">dest</span>
<span class="mi">111</span>             <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">imm</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">long</span><span class="p">)):</span>
<span class="mi">112</span>                 <span class="n">imm</span> <span class="o">=</span> <span class="sh">"</span><span class="s">ULL(%d)</span><span class="sh">"</span> <span class="o">%</span> <span class="n">imm</span>
<span class="mi">113</span>             <span class="n">self</span><span class="p">.</span><span class="n">imm</span> <span class="o">=</span> <span class="n">imm</span>
<span class="mi">114</span>             <span class="n">self</span><span class="p">.</span><span class="n">dataSize</span> <span class="o">=</span> <span class="n">dataSize</span>
<span class="mi">115</span>
<span class="mi">116</span>         <span class="k">def</span> <span class="nf">getAllocator</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">microFlags</span><span class="p">):</span>
<span class="mi">117</span>             <span class="n">allocString</span> <span class="o">=</span> <span class="sh">'''</span><span class="s">
118                 (%(dataSize)s &gt;= 4) ?
119                     (StaticInstPtr)(new %(class_name)sBig(machInst,
120                         macrocodeBlock, %(flags)s, %(dest)s, %(imm)s,
121                         %(dataSize)s)) :
122                     (StaticInstPtr)(new %(class_name)s(machInst,
123                         macrocodeBlock, %(flags)s, %(dest)s, %(imm)s,
124                         %(dataSize)s))
125             </span><span class="sh">'''</span>
<span class="mi">126</span>             <span class="n">allocator</span> <span class="o">=</span> <span class="n">allocString</span> <span class="o">%</span> <span class="p">{</span>
<span class="mi">127</span>                 <span class="sh">"</span><span class="s">class_name</span><span class="sh">"</span> <span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">className</span><span class="p">,</span>
<span class="mi">128</span>                 <span class="sh">"</span><span class="s">mnemonic</span><span class="sh">"</span> <span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">mnemonic</span><span class="p">,</span>
<span class="mi">129</span>                 <span class="sh">"</span><span class="s">flags</span><span class="sh">"</span> <span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="nf">microFlagsText</span><span class="p">(</span><span class="n">microFlags</span><span class="p">),</span>
<span class="mi">130</span>                 <span class="sh">"</span><span class="s">dest</span><span class="sh">"</span> <span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">dest</span><span class="p">,</span> <span class="sh">"</span><span class="s">imm</span><span class="sh">"</span> <span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">imm</span><span class="p">,</span>
<span class="mi">131</span>                 <span class="sh">"</span><span class="s">dataSize</span><span class="sh">"</span> <span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">dataSize</span><span class="p">}</span>
<span class="mi">132</span>             <span class="k">return</span> <span class="n">allocator</span>
<span class="mi">133</span>
<span class="mi">134</span>     <span class="n">microopClasses</span><span class="p">[</span><span class="sh">"</span><span class="s">limm</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">LimmOp</span>
<span class="p">...</span><span class="bp">...</span>
<span class="mi">159</span> <span class="p">}};</span>

</pre></td></tr></tbody></table></code></div></div>

<p>It’s worth noting that the ‘LimmOp’ Python class requires three operands, and
the actual microcode of ‘MOV_R_MI’ provides these three operands when utilizing
the ‘limm’ microop. As a result of the ‘eval’ function, the operands of the 
‘limm’ microop are translated into a format that GEM5 can comprehend and are 
then passed to the ‘<strong>init</strong>’ definition of the ‘LimmOp’ class.</p>

<p>The ‘LimmOp’ class object, which corresponds to the ‘limm’ microop operation 
used to implement the ‘MOV_R_MI’ macroop, is instantiated. This ‘LimmOp’ class 
object is subsequently stored within the ‘X86Macroop’ object of the ‘MOV_R_MI’ 
instruction, accomplished through the ‘add_microop’ definition of ‘X86Macroop.’</p>

<h3 id="symbols-of-parser"><span class="me-2">Symbols of parser</span><a href="#symbols-of-parser" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>When discussing the translation of microop’s operands, I didn’t delve into the 
details of how this translation takes place. As mentioned earlier, 
‘parser.symbols’ serves as a dictionary that associates particular strings with
corresponding code statements. The string argument of the microop comprises 
operands like ‘rax,’ ‘rbx,’ ‘t1,’ ‘t2,’ and so on. However, these operands must
be converted into the appropriate code statements for register references, such
as ‘InstRegIndex(NUM_INTREGS+1).’ The mapping between one register to code 
referencing it is defined within the ‘parser.symbols’ dictionary.</p>

<p><em>gem5/src/arch/x86/isa/microasm.isa</em></p>
<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
</pre></td><td class="rouge-code"><pre>
 <span class="mi">61</span>     <span class="k">def</span> <span class="nf">regIdx</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
 <span class="mi">62</span>         <span class="k">return</span> <span class="sh">"</span><span class="s">InstRegIndex(%s)</span><span class="sh">"</span> <span class="o">%</span> <span class="n">idx</span>
 <span class="mi">63</span>
 <span class="mi">64</span>     <span class="n">assembler</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="sh">"</span><span class="s">regIdx</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">regIdx</span>
 <span class="mi">65</span>
 <span class="mi">66</span>     <span class="c1"># Add in symbols for the microcode registers
</span> <span class="mi">67</span>     <span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">16</span><span class="p">):</span>
 <span class="mi">68</span>         <span class="n">assembler</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="sh">"</span><span class="s">t%d</span><span class="sh">"</span> <span class="o">%</span> <span class="n">num</span><span class="p">]</span> <span class="o">=</span> <span class="nf">regIdx</span><span class="p">(</span><span class="sh">"</span><span class="s">NUM_INTREGS+%d</span><span class="sh">"</span> <span class="o">%</span> <span class="n">num</span><span class="p">)</span>
 <span class="mi">69</span>     <span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span>
 <span class="mi">70</span>         <span class="n">assembler</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="sh">"</span><span class="s">ufp%d</span><span class="sh">"</span> <span class="o">%</span> <span class="n">num</span><span class="p">]</span> <span class="o">=</span> \
 <span class="mi">71</span>             <span class="nf">regIdx</span><span class="p">(</span><span class="sh">"</span><span class="s">FLOATREG_MICROFP(%d)</span><span class="sh">"</span> <span class="o">%</span> <span class="n">num</span><span class="p">)</span>
 <span class="mi">72</span>     <span class="c1"># Add in symbols for the segment descriptor registers
</span> <span class="mi">73</span>     <span class="k">for</span> <span class="n">letter</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">C</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">D</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">E</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">F</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">G</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">H</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">S</span><span class="sh">"</span><span class="p">):</span>
 <span class="mi">74</span>         <span class="n">assembler</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="sh">"</span><span class="s">%ss</span><span class="sh">"</span> <span class="o">%</span> <span class="n">letter</span><span class="p">.</span><span class="nf">lower</span><span class="p">()]</span> <span class="o">=</span> \
 <span class="mi">75</span>             <span class="nf">regIdx</span><span class="p">(</span><span class="sh">"</span><span class="s">SEGMENT_REG_%sS</span><span class="sh">"</span> <span class="o">%</span> <span class="n">letter</span><span class="p">)</span>
 <span class="mi">76</span>
 <span class="mi">77</span>     <span class="c1"># Add in symbols for the various checks of segment selectors.
</span> <span class="mi">78</span>     <span class="k">for</span> <span class="n">check</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">NoCheck</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">CSCheck</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">CallGateCheck</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">IntGateCheck</span><span class="sh">"</span><span class="p">,</span>
 <span class="mi">79</span>                   <span class="sh">"</span><span class="s">SoftIntGateCheck</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">SSCheck</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">IretCheck</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">IntCSCheck</span><span class="sh">"</span><span class="p">,</span>
 <span class="mi">80</span>                   <span class="sh">"</span><span class="s">TRCheck</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">TSSCheck</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">InGDTCheck</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">LDTCheck</span><span class="sh">"</span><span class="p">):</span>
 <span class="mi">81</span>         <span class="n">assembler</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="n">check</span><span class="p">]</span> <span class="o">=</span> <span class="sh">"</span><span class="s">Seg%s</span><span class="sh">"</span> <span class="o">%</span> <span class="n">check</span>
 <span class="mi">82</span>
 <span class="mi">83</span>     <span class="k">for</span> <span class="n">reg</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">TR</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">IDTR</span><span class="sh">"</span><span class="p">):</span>
 <span class="mi">84</span>         <span class="n">assembler</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="n">reg</span><span class="p">.</span><span class="nf">lower</span><span class="p">()]</span> <span class="o">=</span> <span class="nf">regIdx</span><span class="p">(</span><span class="sh">"</span><span class="s">SYS_SEGMENT_REG_%s</span><span class="sh">"</span> <span class="o">%</span> <span class="n">reg</span><span class="p">)</span>
 <span class="mi">85</span>
 <span class="mi">86</span>     <span class="k">for</span> <span class="n">reg</span> <span class="ow">in</span> <span class="p">(</span><span class="sh">"</span><span class="s">TSL</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">TSG</span><span class="sh">"</span><span class="p">):</span>
 <span class="mi">87</span>         <span class="n">assembler</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="n">reg</span><span class="p">.</span><span class="nf">lower</span><span class="p">()]</span> <span class="o">=</span> <span class="nf">regIdx</span><span class="p">(</span><span class="sh">"</span><span class="s">SEGMENT_REG_%s</span><span class="sh">"</span> <span class="o">%</span> <span class="n">reg</span><span class="p">)</span>
 <span class="mi">88</span>
 <span class="mi">89</span>     <span class="c1"># Miscellaneous symbols
</span> <span class="mi">90</span>     <span class="n">symbols</span> <span class="o">=</span> <span class="p">{</span>
 <span class="mi">91</span>         <span class="sh">"</span><span class="s">reg</span><span class="sh">"</span> <span class="p">:</span> <span class="nf">regIdx</span><span class="p">(</span><span class="sh">"</span><span class="s">env.reg</span><span class="sh">"</span><span class="p">),</span>
 <span class="mi">92</span>         <span class="sh">"</span><span class="s">xmml</span><span class="sh">"</span> <span class="p">:</span> <span class="nf">regIdx</span><span class="p">(</span><span class="sh">"</span><span class="s">FLOATREG_XMM_LOW(env.reg)</span><span class="sh">"</span><span class="p">),</span>
 <span class="mi">93</span>         <span class="sh">"</span><span class="s">xmmh</span><span class="sh">"</span> <span class="p">:</span> <span class="nf">regIdx</span><span class="p">(</span><span class="sh">"</span><span class="s">FLOATREG_XMM_HIGH(env.reg)</span><span class="sh">"</span><span class="p">),</span>
 <span class="mi">94</span>         <span class="sh">"</span><span class="s">regm</span><span class="sh">"</span> <span class="p">:</span> <span class="nf">regIdx</span><span class="p">(</span><span class="sh">"</span><span class="s">env.regm</span><span class="sh">"</span><span class="p">),</span>
 <span class="mi">95</span>         <span class="sh">"</span><span class="s">xmmlm</span><span class="sh">"</span> <span class="p">:</span> <span class="nf">regIdx</span><span class="p">(</span><span class="sh">"</span><span class="s">FLOATREG_XMM_LOW(env.regm)</span><span class="sh">"</span><span class="p">),</span>
 <span class="mi">96</span>         <span class="sh">"</span><span class="s">xmmhm</span><span class="sh">"</span> <span class="p">:</span> <span class="nf">regIdx</span><span class="p">(</span><span class="sh">"</span><span class="s">FLOATREG_XMM_HIGH(env.regm)</span><span class="sh">"</span><span class="p">),</span>
 <span class="mi">97</span>         <span class="sh">"</span><span class="s">mmx</span><span class="sh">"</span> <span class="p">:</span> <span class="nf">regIdx</span><span class="p">(</span><span class="sh">"</span><span class="s">FLOATREG_MMX(env.reg)</span><span class="sh">"</span><span class="p">),</span>
 <span class="mi">98</span>         <span class="sh">"</span><span class="s">mmxm</span><span class="sh">"</span> <span class="p">:</span> <span class="nf">regIdx</span><span class="p">(</span><span class="sh">"</span><span class="s">FLOATREG_MMX(env.regm)</span><span class="sh">"</span><span class="p">),</span>
 <span class="mi">99</span>         <span class="sh">"</span><span class="s">imm</span><span class="sh">"</span> <span class="p">:</span> <span class="sh">"</span><span class="s">adjustedImm</span><span class="sh">"</span><span class="p">,</span>
<span class="mi">100</span>         <span class="sh">"</span><span class="s">disp</span><span class="sh">"</span> <span class="p">:</span> <span class="sh">"</span><span class="s">adjustedDisp</span><span class="sh">"</span><span class="p">,</span>
<span class="mi">101</span>         <span class="sh">"</span><span class="s">seg</span><span class="sh">"</span> <span class="p">:</span> <span class="nf">regIdx</span><span class="p">(</span><span class="sh">"</span><span class="s">env.seg</span><span class="sh">"</span><span class="p">),</span>
<span class="mi">102</span>         <span class="sh">"</span><span class="s">scale</span><span class="sh">"</span> <span class="p">:</span> <span class="sh">"</span><span class="s">env.scale</span><span class="sh">"</span><span class="p">,</span>
<span class="mi">103</span>         <span class="sh">"</span><span class="s">index</span><span class="sh">"</span> <span class="p">:</span> <span class="nf">regIdx</span><span class="p">(</span><span class="sh">"</span><span class="s">env.index</span><span class="sh">"</span><span class="p">),</span>
<span class="mi">104</span>         <span class="sh">"</span><span class="s">base</span><span class="sh">"</span> <span class="p">:</span> <span class="nf">regIdx</span><span class="p">(</span><span class="sh">"</span><span class="s">env.base</span><span class="sh">"</span><span class="p">),</span>
<span class="mi">105</span>         <span class="sh">"</span><span class="s">dsz</span><span class="sh">"</span> <span class="p">:</span> <span class="sh">"</span><span class="s">env.dataSize</span><span class="sh">"</span><span class="p">,</span>
<span class="mi">106</span>         <span class="sh">"</span><span class="s">asz</span><span class="sh">"</span> <span class="p">:</span> <span class="sh">"</span><span class="s">env.addressSize</span><span class="sh">"</span><span class="p">,</span>
<span class="mi">107</span>         <span class="sh">"</span><span class="s">ssz</span><span class="sh">"</span> <span class="p">:</span> <span class="sh">"</span><span class="s">env.stackSize</span><span class="sh">"</span>
<span class="mi">108</span>     <span class="p">}</span>
<span class="mi">109</span>     <span class="n">assembler</span><span class="p">.</span><span class="n">symbols</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">symbols</span><span class="p">)</span>

</pre></td></tr></tbody></table></code></div></div>

<p>As we examine the provided code snippet, which is a component of the symbol 
update process, we can observe that different register is mapped to different 
code that can reference that specific register. These symbols play a crucial 
role in converting strings into actual reference code.</p>

<h3 id="summary-handle_statement-adds-microop-object-to-macroop-object"><span class="me-2">Summary: handle_statement adds microop object to macroop object</span><a href="#summary-handle_statement-adds-microop-object-to-macroop-object" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>Let’s go back to the handle_statement.</p>
<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td><td class="rouge-code"><pre><span class="mi">126</span> <span class="k">def</span> <span class="nf">handle_statement</span><span class="p">(</span><span class="n">parser</span><span class="p">,</span> <span class="n">container</span><span class="p">,</span> <span class="n">statement</span><span class="p">):</span>
<span class="mi">127</span>     <span class="k">if</span> <span class="n">statement</span><span class="p">.</span><span class="n">is_microop</span><span class="p">:</span>
<span class="mi">128</span>         <span class="k">if</span> <span class="n">statement</span><span class="p">.</span><span class="n">mnemonic</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">parser</span><span class="p">.</span><span class="n">microops</span><span class="p">.</span><span class="nf">keys</span><span class="p">():</span>
<span class="mi">129</span>             <span class="k">raise</span> <span class="nb">Exception</span><span class="p">,</span> <span class="sh">"</span><span class="s">Unrecognized mnemonic: %s</span><span class="sh">"</span> <span class="o">%</span> <span class="n">statement</span><span class="p">.</span><span class="n">mnemonic</span>
<span class="mi">130</span>         <span class="n">parser</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="sh">"</span><span class="s">__microopClassFromInsideTheAssembler</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> \
<span class="mi">131</span>             <span class="n">parser</span><span class="p">.</span><span class="n">microops</span><span class="p">[</span><span class="n">statement</span><span class="p">.</span><span class="n">mnemonic</span><span class="p">]</span>
<span class="mi">132</span>         <span class="k">try</span><span class="p">:</span> 
<span class="mi">133</span>             <span class="n">microop</span> <span class="o">=</span> <span class="nf">eval</span><span class="p">(</span><span class="sh">'</span><span class="s">__microopClassFromInsideTheAssembler(%s)</span><span class="sh">'</span> <span class="o">%</span>
<span class="mi">134</span>                     <span class="n">statement</span><span class="p">.</span><span class="n">params</span><span class="p">,</span> <span class="p">{},</span> <span class="n">parser</span><span class="p">.</span><span class="n">symbols</span><span class="p">)</span>
<span class="mi">135</span>         <span class="k">except</span><span class="p">:</span>
<span class="mi">136</span>             <span class="nf">print_error</span><span class="p">(</span><span class="sh">"</span><span class="s">Error creating microop object with mnemonic %s.</span><span class="sh">"</span> <span class="o">%</span> \
<span class="mi">137</span>                     <span class="n">statement</span><span class="p">.</span><span class="n">mnemonic</span><span class="p">)</span>
<span class="mi">138</span>             <span class="k">raise</span>
<span class="mi">139</span>         <span class="k">try</span><span class="p">:</span> 
<span class="mi">140</span>             <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">statement</span><span class="p">.</span><span class="n">labels</span><span class="p">:</span>
<span class="mi">141</span>                 <span class="n">container</span><span class="p">.</span><span class="n">labels</span><span class="p">[</span><span class="n">label</span><span class="p">.</span><span class="n">text</span><span class="p">]</span> <span class="o">=</span> <span class="n">microop</span>
<span class="mi">142</span>                 <span class="k">if</span> <span class="n">label</span><span class="p">.</span><span class="n">is_extern</span><span class="p">:</span>
<span class="mi">143</span>                     <span class="n">container</span><span class="p">.</span><span class="n">externs</span><span class="p">[</span><span class="n">label</span><span class="p">.</span><span class="n">text</span><span class="p">]</span> <span class="o">=</span> <span class="n">microop</span>
<span class="mi">144</span>             <span class="n">container</span><span class="p">.</span><span class="nf">add_microop</span><span class="p">(</span><span class="n">statement</span><span class="p">.</span><span class="n">mnemonic</span><span class="p">,</span> <span class="n">microop</span><span class="p">)</span>
<span class="mi">145</span>         <span class="k">except</span><span class="p">:</span>
<span class="mi">146</span>             <span class="nf">print_error</span><span class="p">(</span><span class="sh">"</span><span class="s">Error adding microop.</span><span class="sh">"</span><span class="p">)</span>
<span class="mi">147</span>             <span class="k">raise</span>
</pre></td></tr></tbody></table></code></div></div>
<p>It’s essential to recall that we have instantiated a microop object (‘LimmOp’) 
that corresponds to the microop’s mnemonic (‘limm’). Additionally, to create 
this object, we translated the operands of the ‘limm’ microop. Another crucial
objective of the ‘handle_statement’ function is to add the populated microop 
objects to the macroop container, referred to as ‘container’ in the provided 
code (as seen in lines 139-144).</p>

<p>Although this procedure may seem lengthy, it can be broken down into two primary steps:</p>
<ol>
  <li>Generating the macroop container (‘curop’).</li>
  <li>Parsing the statements that constitute the macroop (‘microop parsing’).</li>
  <li>Storing the generated microop objects in the container.</li>
</ol>

<p>Once one macroop has been successfully parsed, the resulting macroop container 
is stored in the ‘parser.macroops’ dictionary (as indicated in line 361 of 
‘p_macroop_def_1’).</p>

<h1 id="translating-parsed-macroop-into-c-class">Translating parsed macroop into C++ class</h1>
<blockquote class="prompt-info">
  <p>The parsed macroops and its microops are instantiated as Python objects, not 
C++ class instances.</p>
</blockquote>

<p>The parsing result yields a Python dictionary that encompasses all the macroop 
containers, represented as X86Macroop objects. Also, microops comprising of each
macroop are Python class instances stored within the macroop container. It’s 
important to note that GEM5 requires C++ classes to represent both macroops and 
microops, not Python objects. Initially, when searching for the C++ counterparts
of these macroops and microops, you cannot locate them. However, after compiling
the code base, these classes can be automatically generated. Let’s explore how 
the Python classes can be automatically translated into C++ classes, using the
‘MOV_R_MI’ class as an example.</p>

<p><em>gem5/build/X86/arch/x86/generated/decoder-ns.cc.inc</em></p>
<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
</pre></td><td class="rouge-code"><pre> <span class="mi">28024</span> <span class="o">//</span> <span class="n">Inst</span><span class="p">::</span><span class="nc">MOV</span><span class="p">([</span><span class="sh">'</span><span class="s">rAb</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">Ob</span><span class="sh">'</span><span class="p">],{})</span>
 <span class="mi">28025</span>
 <span class="mi">28026</span>         <span class="n">X86Macroop</span><span class="p">::</span><span class="n">MOV_R_MI</span><span class="p">::</span><span class="nc">MOV_R_MI</span><span class="p">(</span>
 <span class="mi">28027</span>                 <span class="n">ExtMachInst</span> <span class="n">machInst</span><span class="p">,</span> <span class="n">EmulEnv</span> <span class="n">_env</span><span class="p">)</span>
 <span class="mi">28028</span>             <span class="p">:</span> <span class="nc">Macroop</span><span class="p">(</span><span class="sh">"</span><span class="s">mov</span><span class="sh">"</span><span class="p">,</span> <span class="n">machInst</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">_env</span><span class="p">)</span>
 <span class="mi">28029</span>         <span class="p">{</span>
 <span class="mi">28030</span>             <span class="p">;</span>
 <span class="mi">28031</span>
 <span class="mi">28032</span>                 <span class="n">uint64_t</span> <span class="n">adjustedImm</span> <span class="o">=</span> <span class="n">IMMEDIATE</span><span class="p">;</span>
 <span class="mi">28033</span>                 <span class="o">//</span><span class="n">This</span> <span class="ow">is</span> <span class="n">to</span> <span class="n">pacify</span> <span class="n">gcc</span> <span class="ow">in</span> <span class="n">case</span> <span class="n">the</span> <span class="n">immediate</span> <span class="n">isn</span><span class="sh">'</span><span class="s">t used.
 28034                 adjustedImm = adjustedImm;
 28035             ;
 28036
 28037                 uint64_t adjustedDisp = DISPLACEMENT;
 28038                 //This is to pacify gcc in case the displacement isn</span><span class="sh">'</span><span class="n">t</span> <span class="n">used</span><span class="p">.</span>
 <span class="mi">28039</span>                 <span class="n">adjustedDisp</span> <span class="o">=</span> <span class="n">adjustedDisp</span><span class="p">;</span>
 <span class="mi">28040</span>             <span class="p">;</span>
 <span class="mi">28041</span>             <span class="n">env</span><span class="p">.</span><span class="nf">setSeg</span><span class="p">(</span><span class="n">machInst</span><span class="p">);</span>
 <span class="mi">28042</span> <span class="p">;</span>
 <span class="mi">28043</span>
 <span class="mi">28044</span>         <span class="n">_numSrcRegs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
 <span class="mi">28045</span>         <span class="n">_numDestRegs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
 <span class="mi">28046</span>         <span class="n">_numFPDestRegs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
 <span class="mi">28047</span>         <span class="n">_numVecDestRegs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
 <span class="mi">28048</span>         <span class="n">_numVecElemDestRegs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
 <span class="mi">28049</span>         <span class="n">_numVecPredDestRegs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
 <span class="mi">28050</span>         <span class="n">_numIntDestRegs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
 <span class="mi">28051</span>         <span class="n">_numCCDestRegs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;;</span>
 <span class="mi">28052</span>             <span class="n">const</span> <span class="n">char</span> <span class="o">*</span><span class="n">macrocodeBlock</span> <span class="o">=</span> <span class="sh">"</span><span class="s">MOV_R_MI</span><span class="sh">"</span><span class="p">;</span>
 <span class="mi">28053</span>             <span class="o">//</span><span class="n">alloc_microops</span> <span class="ow">is</span> <span class="n">the</span> <span class="n">code</span> <span class="n">that</span> <span class="n">sets</span> <span class="n">up</span> <span class="n">the</span> <span class="n">microops</span>
 <span class="mi">28054</span>             <span class="o">//</span><span class="n">array</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">parent</span> <span class="n">class</span><span class="p">.</span>
 <span class="mi">28055</span>             <span class="n">microops</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
 <span class="mi">28056</span>                 <span class="p">(</span><span class="n">env</span><span class="p">.</span><span class="n">addressSize</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span> <span class="err">?</span>
 <span class="mi">28057</span>                     <span class="p">(</span><span class="n">StaticInstPtr</span><span class="p">)(</span><span class="n">new</span> <span class="nc">LimmBig</span><span class="p">(</span><span class="n">machInst</span><span class="p">,</span>
 <span class="mi">28058</span>                         <span class="n">macrocodeBlock</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="n">ULL</span> <span class="o">&lt;&lt;</span> <span class="n">StaticInst</span><span class="p">::</span><span class="n">IsMicroop</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span><span class="n">ULL</span> <span class="o">&lt;&lt;</span> <span class="n">StaticInst</span><span class="p">::</span><span class="n">IsFirstMicroop</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span><span class="n">ULL</span> <span class="o">&lt;&lt;</span> <span class="n">StaticInst</span><span class="p">::</span><span class="n">IsDelayedCommit</span><span class="p">),</span> <span class="nc">InstRegIndex</span><span class="p">(</span><span class="n">NUM_INTREGS</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">adjustedImm</span><span class="p">,</span>
 <span class="mi">28059</span>                         <span class="n">env</span><span class="p">.</span><span class="n">addressSize</span><span class="p">))</span> <span class="p">:</span>
 <span class="mi">28060</span>                     <span class="p">(</span><span class="n">StaticInstPtr</span><span class="p">)(</span><span class="n">new</span> <span class="nc">Limm</span><span class="p">(</span><span class="n">machInst</span><span class="p">,</span>
 <span class="mi">28061</span>                         <span class="n">macrocodeBlock</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="n">ULL</span> <span class="o">&lt;&lt;</span> <span class="n">StaticInst</span><span class="p">::</span><span class="n">IsMicroop</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span><span class="n">ULL</span> <span class="o">&lt;&lt;</span> <span class="n">StaticInst</span><span class="p">::</span><span class="n">IsFirstMicroop</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span><span class="n">ULL</span> <span class="o">&lt;&lt;</span> <span class="n">StaticInst</span><span class="p">::</span><span class="n">IsDelayedCommit</span><span class="p">),</span> <span class="nc">InstRegIndex</span><span class="p">(</span><span class="n">NUM_INTREGS</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">adjustedImm</span><span class="p">,</span>
 <span class="mi">28062</span>                         <span class="n">env</span><span class="p">.</span><span class="n">addressSize</span><span class="p">))</span>
 <span class="mi">28063</span>             <span class="p">;</span>
 <span class="mi">28064</span> <span class="n">microops</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
 <span class="mi">28065</span>                 <span class="p">(</span><span class="n">env</span><span class="p">.</span><span class="n">dataSize</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span> <span class="err">?</span>
 <span class="mi">28066</span>                     <span class="p">(</span><span class="n">StaticInstPtr</span><span class="p">)(</span><span class="n">new</span> <span class="nc">LdBig</span><span class="p">(</span><span class="n">machInst</span><span class="p">,</span>
 <span class="mi">28067</span>                         <span class="n">macrocodeBlock</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="n">ULL</span> <span class="o">&lt;&lt;</span> <span class="n">StaticInst</span><span class="p">::</span><span class="n">IsMicroop</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span><span class="n">ULL</span> <span class="o">&lt;&lt;</span> <span class="n">StaticInst</span><span class="p">::</span><span class="n">IsLastMicroop</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="nc">InstRegIndex</span><span class="p">(</span><span class="n">NUM_INTREGS</span><span class="o">+</span><span class="mi">0</span><span class="p">),</span>
 <span class="mi">28068</span>                         <span class="nc">InstRegIndex</span><span class="p">(</span><span class="n">NUM_INTREGS</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="nc">InstRegIndex</span><span class="p">(</span><span class="n">env</span><span class="p">.</span><span class="n">seg</span><span class="p">),</span> <span class="nc">InstRegIndex</span><span class="p">(</span><span class="n">env</span><span class="p">.</span><span class="n">reg</span><span class="p">),</span>
 <span class="mi">28069</span>                         <span class="n">env</span><span class="p">.</span><span class="n">dataSize</span><span class="p">,</span> <span class="n">env</span><span class="p">.</span><span class="n">addressSize</span><span class="p">,</span> <span class="mi">0</span> <span class="o">|</span> <span class="p">(</span><span class="n">machInst</span><span class="p">.</span><span class="n">legacy</span><span class="p">.</span><span class="n">addr</span> <span class="err">?</span> <span class="p">(</span><span class="n">AddrSizeFlagBit</span> <span class="o">&lt;&lt;</span> <span class="n">FlagShift</span><span class="p">)</span> <span class="p">:</span> <span class="mi">0</span><span class="p">)))</span> <span class="p">:</span>
 <span class="mi">28070</span>                     <span class="p">(</span><span class="n">StaticInstPtr</span><span class="p">)(</span><span class="n">new</span> <span class="nc">Ld</span><span class="p">(</span><span class="n">machInst</span><span class="p">,</span>
 <span class="mi">28071</span>                         <span class="n">macrocodeBlock</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="n">ULL</span> <span class="o">&lt;&lt;</span> <span class="n">StaticInst</span><span class="p">::</span><span class="n">IsMicroop</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span><span class="n">ULL</span> <span class="o">&lt;&lt;</span> <span class="n">StaticInst</span><span class="p">::</span><span class="n">IsLastMicroop</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="nc">InstRegIndex</span><span class="p">(</span><span class="n">NUM_INTREGS</span><span class="o">+</span><span class="mi">0</span><span class="p">),</span>
 <span class="mi">28072</span>                         <span class="nc">InstRegIndex</span><span class="p">(</span><span class="n">NUM_INTREGS</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="nc">InstRegIndex</span><span class="p">(</span><span class="n">env</span><span class="p">.</span><span class="n">seg</span><span class="p">),</span> <span class="nc">InstRegIndex</span><span class="p">(</span><span class="n">env</span><span class="p">.</span><span class="n">reg</span><span class="p">),</span>
 <span class="mi">28073</span>                         <span class="n">env</span><span class="p">.</span><span class="n">dataSize</span><span class="p">,</span> <span class="n">env</span><span class="p">.</span><span class="n">addressSize</span><span class="p">,</span> <span class="mi">0</span> <span class="o">|</span> <span class="p">(</span><span class="n">machInst</span><span class="p">.</span><span class="n">legacy</span><span class="p">.</span><span class="n">addr</span> <span class="err">?</span> <span class="p">(</span><span class="n">AddrSizeFlagBit</span> <span class="o">&lt;&lt;</span> <span class="n">FlagShift</span><span class="p">)</span> <span class="p">:</span> <span class="mi">0</span><span class="p">)))</span>
 <span class="mi">28074</span>             <span class="p">;</span>
 <span class="mi">28075</span> <span class="p">;</span>
 <span class="mi">28076</span>         <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>The above class is automatically generated. Since we already have Python-based
macroop containers defining the ‘MOV_R_MI’ macroop, we can naturally deduce that 
the generated C++ class is derived from the corresponding Python class.
Therefore, let’s examine the part of the code where the generated macroop 
containers, known as ‘macroopDict,’ are put to use.</p>

<p><em>gem5/src/arch/x86/isa/macroop.isa</em></p>
<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td class="rouge-code"><pre>
<span class="mi">333</span> <span class="n">let</span> <span class="p">{{</span>
<span class="mi">334</span>     <span class="n">doModRMString</span> <span class="o">=</span> <span class="sh">"</span><span class="s">env.doModRM(machInst);</span><span class="se">\n</span><span class="sh">"</span>
<span class="mi">335</span>     <span class="n">noModRMString</span> <span class="o">=</span> <span class="sh">"</span><span class="s">env.setSeg(machInst);</span><span class="se">\n</span><span class="sh">"</span>
<span class="mi">336</span>     <span class="k">def</span> <span class="nf">genMacroop</span><span class="p">(</span><span class="n">Name</span><span class="p">,</span> <span class="n">env</span><span class="p">):</span>
<span class="mi">337</span>         <span class="n">blocks</span> <span class="o">=</span> <span class="nc">OutputBlocks</span><span class="p">()</span>
<span class="mi">338</span>         <span class="k">if</span> <span class="ow">not</span> <span class="n">Name</span> <span class="ow">in</span> <span class="n">macroopDict</span><span class="p">:</span>
<span class="mi">339</span>             <span class="k">raise</span> <span class="nb">Exception</span><span class="p">,</span> <span class="sh">"</span><span class="s">Unrecognized instruction: %s</span><span class="sh">"</span> <span class="o">%</span> <span class="n">Name</span>
<span class="mi">340</span>         <span class="n">macroop</span> <span class="o">=</span> <span class="n">macroopDict</span><span class="p">[</span><span class="n">Name</span><span class="p">]</span>
<span class="mi">341</span>         <span class="k">if</span> <span class="ow">not</span> <span class="n">macroop</span><span class="p">.</span><span class="n">declared</span><span class="p">:</span>
<span class="mi">342</span>             <span class="k">if</span> <span class="n">env</span><span class="p">.</span><span class="n">doModRM</span><span class="p">:</span>
<span class="mi">343</span>                 <span class="n">macroop</span><span class="p">.</span><span class="n">initEnv</span> <span class="o">=</span> <span class="n">doModRMString</span>
<span class="mi">344</span>             <span class="k">else</span><span class="p">:</span>
<span class="mi">345</span>                 <span class="n">macroop</span><span class="p">.</span><span class="n">initEnv</span> <span class="o">=</span> <span class="n">noModRMString</span>
<span class="mi">346</span>             <span class="n">blocks</span><span class="p">.</span><span class="n">header_output</span> <span class="o">=</span> <span class="n">macroop</span><span class="p">.</span><span class="nf">getDeclaration</span><span class="p">()</span>
<span class="mi">347</span>             <span class="n">blocks</span><span class="p">.</span><span class="n">decoder_output</span> <span class="o">=</span> <span class="n">macroop</span><span class="p">.</span><span class="nf">getDefinition</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
<span class="mi">348</span>             <span class="n">macroop</span><span class="p">.</span><span class="n">declared</span> <span class="o">=</span> <span class="bp">True</span>
<span class="mi">349</span>         <span class="n">blocks</span><span class="p">.</span><span class="n">decode_block</span> <span class="o">=</span> <span class="sh">"</span><span class="s">return %s;</span><span class="se">\n</span><span class="sh">"</span> <span class="o">%</span> <span class="n">macroop</span><span class="p">.</span><span class="nf">getAllocator</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
<span class="mi">350</span>         <span class="k">return</span> <span class="n">blocks</span>
<span class="mi">351</span> <span class="p">}};</span>

</pre></td></tr></tbody></table></code></div></div>

<p>As depicted in the provided code, the ‘genMacroop’ function (at line 340) 
fetches the macroop container linked to the name of a specific macroop. 
Subsequently, it calls the ‘getDeclaration,’ ‘getDefinition,’ and ‘getAllocator’ 
functions of the acquired macroop container. It’s worth emphasizing that the 
container obtained here is an instance of the ‘X86Macroop’ Python class that is 
associated with the ‘MOV_R_MI’ macroop.</p>

<h3 id="getdefinition-x86macroop-generate-c-class-definition-for-macroop"><span class="me-2">getDefinition (X86Macroop): generate C++ class definition for macroop</span><a href="#getdefinition-x86macroop-generate-c-class-definition-for-macroop" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p><em>gem5/src/arch/x86/isa/macroop.isa</em></p>
<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
</pre></td><td class="rouge-code"><pre><span class="mi">205</span>         <span class="k">def</span> <span class="nf">getDefinition</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">env</span><span class="p">):</span>
<span class="mi">206</span>             <span class="c1">#FIXME This first parameter should be the mnemonic. I need to
</span><span class="mi">207</span>             <span class="c1">#write some code which pulls that out
</span><span class="mi">208</span>             <span class="n">numMicroops</span> <span class="o">=</span> <span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">microops</span><span class="p">)</span>
<span class="mi">209</span>             <span class="n">allocMicroops</span> <span class="o">=</span> <span class="sh">''</span>
<span class="mi">210</span>             <span class="n">micropc</span> <span class="o">=</span> <span class="mi">0</span>
<span class="mi">211</span>             <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">microops</span><span class="p">:</span>
<span class="mi">212</span>                 <span class="n">flags</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">IsMicroop</span><span class="sh">"</span><span class="p">]</span>
<span class="mi">213</span>                 <span class="k">if</span> <span class="n">micropc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<span class="mi">214</span>                     <span class="n">flags</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sh">"</span><span class="s">IsFirstMicroop</span><span class="sh">"</span><span class="p">)</span>
<span class="mi">215</span>
<span class="mi">216</span>                     <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">serialize_before</span><span class="p">:</span>
<span class="mi">217</span>                         <span class="n">flags</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sh">"</span><span class="s">IsSerializing</span><span class="sh">"</span><span class="p">)</span>
<span class="mi">218</span>                         <span class="n">flags</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sh">"</span><span class="s">IsSerializeBefore</span><span class="sh">"</span><span class="p">)</span>
<span class="mi">219</span>
<span class="mi">220</span>                 <span class="k">if</span> <span class="n">micropc</span> <span class="o">==</span> <span class="n">numMicroops</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
<span class="mi">221</span>                     <span class="n">flags</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sh">"</span><span class="s">IsLastMicroop</span><span class="sh">"</span><span class="p">)</span>
<span class="mi">222</span>
<span class="mi">223</span>                     <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">serialize_after</span><span class="p">:</span>
<span class="mi">224</span>                         <span class="n">flags</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sh">"</span><span class="s">IsSerializing</span><span class="sh">"</span><span class="p">)</span>
<span class="mi">225</span>                         <span class="n">flags</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sh">"</span><span class="s">IsSerializeAfter</span><span class="sh">"</span><span class="p">)</span>
<span class="mi">226</span>
<span class="mi">227</span>                     <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">function_call</span><span class="p">:</span>
<span class="mi">228</span>                         <span class="n">flags</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sh">"</span><span class="s">IsCall</span><span class="sh">"</span><span class="p">)</span>
<span class="mi">229</span>                         <span class="n">flags</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sh">"</span><span class="s">IsUncondControl</span><span class="sh">"</span><span class="p">)</span>
<span class="mi">230</span>                     <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">function_return</span><span class="p">:</span>
<span class="mi">231</span>                         <span class="n">flags</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sh">"</span><span class="s">IsReturn</span><span class="sh">"</span><span class="p">)</span>
<span class="mi">232</span>                         <span class="n">flags</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sh">"</span><span class="s">IsUncondControl</span><span class="sh">"</span><span class="p">)</span>
<span class="mi">233</span>                 <span class="k">else</span><span class="p">:</span>
<span class="mi">234</span>                     <span class="n">flags</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sh">"</span><span class="s">IsDelayedCommit</span><span class="sh">"</span><span class="p">)</span>
<span class="mi">235</span>
<span class="mi">236</span>                 <span class="n">allocMicroops</span> <span class="o">+=</span> \
<span class="mi">237</span>                     <span class="sh">"</span><span class="s">microops[%d] = %s;</span><span class="se">\n</span><span class="sh">"</span> <span class="o">%</span> \
<span class="mi">238</span>                     <span class="p">(</span><span class="n">micropc</span><span class="p">,</span> <span class="n">op</span><span class="p">.</span><span class="nf">getAllocator</span><span class="p">(</span><span class="n">flags</span><span class="p">))</span>
<span class="mi">239</span>                 <span class="n">micropc</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="mi">240</span>             <span class="k">if</span> <span class="n">env</span><span class="p">.</span><span class="n">useStackSize</span><span class="p">:</span>
<span class="mi">241</span>                 <span class="n">useStackSize</span> <span class="o">=</span> <span class="sh">"</span><span class="s">true</span><span class="sh">"</span>
<span class="mi">242</span>             <span class="k">else</span><span class="p">:</span>
<span class="mi">243</span>                 <span class="n">useStackSize</span> <span class="o">=</span> <span class="sh">"</span><span class="s">false</span><span class="sh">"</span>
<span class="mi">244</span>             <span class="k">if</span> <span class="n">env</span><span class="p">.</span><span class="n">memoryInst</span><span class="p">:</span>
<span class="mi">245</span>                 <span class="n">memoryInst</span> <span class="o">=</span> <span class="sh">"</span><span class="s">true</span><span class="sh">"</span>
<span class="mi">246</span>             <span class="k">else</span><span class="p">:</span>
<span class="mi">247</span>                 <span class="n">memoryInst</span> <span class="o">=</span> <span class="sh">"</span><span class="s">false</span><span class="sh">"</span>
<span class="mi">248</span>             <span class="n">regSize</span> <span class="o">=</span> <span class="sh">'''</span><span class="s">(%s || (env.base == INTREG_RSP &amp;&amp; %s) ?
249                          env.stackSize :
250                          env.dataSize)</span><span class="sh">'''</span> <span class="o">%</span> <span class="p">(</span><span class="n">useStackSize</span><span class="p">,</span> <span class="n">memoryInst</span><span class="p">)</span>
<span class="mi">251</span>             <span class="n">iop</span> <span class="o">=</span> <span class="nc">InstObjParams</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="nf">getMnemonic</span><span class="p">(),</span> <span class="n">self</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="sh">"</span><span class="s">Macroop</span><span class="sh">"</span><span class="p">,</span>
<span class="mi">252</span>                                 <span class="p">{</span><span class="sh">"</span><span class="s">code</span><span class="sh">"</span> <span class="p">:</span> <span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">num_microops</span><span class="sh">"</span> <span class="p">:</span> <span class="n">numMicroops</span><span class="p">,</span>
<span class="mi">253</span>                                  <span class="sh">"</span><span class="s">alloc_microops</span><span class="sh">"</span> <span class="p">:</span> <span class="n">allocMicroops</span><span class="p">,</span>
<span class="mi">254</span>                                  <span class="sh">"</span><span class="s">adjust_env</span><span class="sh">"</span> <span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">adjust_env</span><span class="p">,</span>
<span class="mi">255</span>                                  <span class="sh">"</span><span class="s">adjust_imm</span><span class="sh">"</span> <span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">adjust_imm</span><span class="p">,</span>
<span class="mi">256</span>                                  <span class="sh">"</span><span class="s">adjust_disp</span><span class="sh">"</span> <span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">adjust_disp</span><span class="p">,</span>
<span class="mi">257</span>                                  <span class="sh">"</span><span class="s">disassembly</span><span class="sh">"</span> <span class="p">:</span> <span class="n">env</span><span class="p">.</span><span class="n">disassembly</span><span class="p">,</span>
<span class="mi">258</span>                                  <span class="sh">"</span><span class="s">regSize</span><span class="sh">"</span> <span class="p">:</span> <span class="n">regSize</span><span class="p">,</span>
<span class="mi">259</span>                                  <span class="sh">"</span><span class="s">init_env</span><span class="sh">"</span> <span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">initEnv</span><span class="p">})</span>
<span class="mi">260</span>             <span class="k">return</span> <span class="n">MacroConstructor</span><span class="p">.</span><span class="nf">subst</span><span class="p">(</span><span class="n">iop</span><span class="p">)</span> <span class="o">+</span> \
<span class="mi">261</span>                    <span class="n">MacroDisassembly</span><span class="p">.</span><span class="nf">subst</span><span class="p">(</span><span class="n">iop</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></div></div>

<p>The main purpose of the <em>getDefinition</em> function is to define the characteristics 
and behavior of the corresponding macroop in the x86 architecture. In X86, the 
actual semantic of a macroop is determined by the microops that constitute it. 
Therefore, it is crucial for the constructor of the macroop to initialize its
microops properly.</p>

<blockquote class="prompt-info">
  <p>All Python microop classes that constitute a macroop are stored within the 
self.microops attribute of the X86Macroop object.</p>
</blockquote>

<p>Given that a macroop may consist of multiple microops, it is necessary to 
iterate through each Python microop class individually to generate the 
instantiation code for the corresponding C++ microop classes (Lines 210-239). 
The code responsible for creating instances of each microop class is obtained 
from the <em>getAllocator</em> method of each Python microop class. The resulting code, 
which instantiates the microops, is stored in the <em>allocMicroops</em> variable 
(Lines 236-238). Note that the microop <em>op</em> in the above code indicates the 
python class object of a microop.</p>

<h3 id="getallocator-retrieve-microop-class-instantiation-code"><span class="me-2">getAllocator: retrieve microop class instantiation code</span><a href="#getallocator-retrieve-microop-class-instantiation-code" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>The <em>getAllocator</em> function is called from the microop and is responsible for
producing C++ statements that create instances of C++ microop class objects. In
our specific case, where we are interested in the Limm microcode of the MOV_R_MI
macroop, we will examine how <em>getAllocator</em> function of the <em>LimmOp</em> class can 
generate corresponding C++ code.</p>

<p><em>gem5/src/arch/x86/isa/microops/limmop.isa</em></p>
<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td class="rouge-code"><pre>
<span class="mi">106</span>     <span class="k">class</span> <span class="nc">LimmOp</span><span class="p">(</span><span class="n">X86Microop</span><span class="p">):</span>
<span class="bp">...</span>
<span class="mi">116</span>         <span class="k">def</span> <span class="nf">getAllocator</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">microFlags</span><span class="p">):</span>
<span class="mi">117</span>             <span class="n">allocString</span> <span class="o">=</span> <span class="sh">'''</span><span class="s">
118                 (%(dataSize)s &gt;= 4) ?
119                     (StaticInstPtr)(new %(class_name)sBig(machInst,
120                         macrocodeBlock, %(flags)s, %(dest)s, %(imm)s,
121                         %(dataSize)s)) :
122                     (StaticInstPtr)(new %(class_name)s(machInst,
123                         macrocodeBlock, %(flags)s, %(dest)s, %(imm)s,
124                         %(dataSize)s))
125             </span><span class="sh">'''</span>
<span class="mi">126</span>             <span class="n">allocator</span> <span class="o">=</span> <span class="n">allocString</span> <span class="o">%</span> <span class="p">{</span>
<span class="mi">127</span>                 <span class="sh">"</span><span class="s">class_name</span><span class="sh">"</span> <span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">className</span><span class="p">,</span>
<span class="mi">128</span>                 <span class="sh">"</span><span class="s">mnemonic</span><span class="sh">"</span> <span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">mnemonic</span><span class="p">,</span>
<span class="mi">129</span>                 <span class="sh">"</span><span class="s">flags</span><span class="sh">"</span> <span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="nf">microFlagsText</span><span class="p">(</span><span class="n">microFlags</span><span class="p">),</span>
<span class="mi">130</span>                 <span class="sh">"</span><span class="s">dest</span><span class="sh">"</span> <span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">dest</span><span class="p">,</span> <span class="sh">"</span><span class="s">imm</span><span class="sh">"</span> <span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">imm</span><span class="p">,</span>
<span class="mi">131</span>                 <span class="sh">"</span><span class="s">dataSize</span><span class="sh">"</span> <span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">dataSize</span><span class="p">}</span>
<span class="mi">132</span>             <span class="k">return</span> <span class="n">allocator</span>

</pre></td></tr></tbody></table></code></div></div>
<p>The <em>getAllocator</em> function within the LimmOp Python class generates a Python 
doc string <em>allocString</em>, which comprises C++ formatted code for instantiating
microop objects (Lines 117-125). While I haven’t covered how GEM5 defines the 
C++ classes for microops in detail, we’ll delve into this in the upcoming post.
Note that the string contains format specifier that needs to be replaced with 
the appropriate value of the microop (Lines 126-131). Most of the substituted 
content is derived from the fields of the Python microop class. When an instance 
of the LimmOp Python class is created, microop-specific operands such as ‘dest’ 
and ‘imm’ are passed to the constructor of the LimmOp Python class. Recall how 
‘eval’ translates the microop’s operands and creates the associated Python 
object.</p>

<p>Since the ‘allocString’ contains all the C++ formatted statements, GEM5 should 
provide the remaining information required to compile the automatically
generated C++ source code. For instance, the <em>className</em> has been set as ‘Limm,’
which implies that there should be a corresponding ‘Limm’ C++ class that can be 
instantiated. The ‘Limm’ C++ class is also automatically declared by GEM5.</p>

<p><em>gem5/build/X86/arch/x86/generated/decoder-ns.hh.inc</em></p>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="rouge-code"><pre>    <span class="k">class</span> <span class="nc">Limm</span> <span class="o">:</span> <span class="k">public</span> <span class="n">X86ISA</span><span class="o">::</span><span class="n">X86MicroopBase</span>
    <span class="p">{</span>
      <span class="nl">protected:</span>
        <span class="k">const</span> <span class="n">RegIndex</span> <span class="n">dest</span><span class="p">;</span>
        <span class="k">const</span> <span class="kt">uint64_t</span> <span class="n">imm</span><span class="p">;</span>
        <span class="k">const</span> <span class="kt">uint8_t</span> <span class="n">dataSize</span><span class="p">;</span>
        <span class="n">RegIndex</span> <span class="n">foldOBit</span><span class="p">;</span>

        <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">generateDisassembly</span><span class="p">(</span><span class="n">Addr</span> <span class="n">pc</span><span class="p">,</span>
            <span class="k">const</span> <span class="n">SymbolTable</span> <span class="o">*</span><span class="n">symtab</span><span class="p">)</span> <span class="k">const</span><span class="p">;</span>

      <span class="nl">public:</span>
        <span class="n">Limm</span><span class="p">(</span><span class="n">ExtMachInst</span> <span class="n">_machInst</span><span class="p">,</span>
                <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">instMnem</span><span class="p">,</span>
                <span class="kt">uint64_t</span> <span class="n">setFlags</span><span class="p">,</span> <span class="n">InstRegIndex</span> <span class="n">_dest</span><span class="p">,</span>
                <span class="kt">uint64_t</span> <span class="n">_imm</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">_dataSize</span><span class="p">);</span>

        <span class="n">Fault</span> <span class="n">execute</span><span class="p">(</span><span class="n">ExecContext</span> <span class="o">*</span><span class="p">,</span> <span class="n">Trace</span><span class="o">::</span><span class="n">InstRecord</span> <span class="o">*</span><span class="p">)</span> <span class="k">const</span><span class="p">;</span>
    <span class="p">};</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="finalize-macroop-class-definition-with-template-substitution"><span class="me-2">Finalize Macroop class definition with template substitution</span><a href="#finalize-macroop-class-definition-with-template-substitution" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre><span class="mi">136</span>     <span class="k">class</span> <span class="nf">X86Macroop</span><span class="p">(</span><span class="n">Combinational_Macroop</span><span class="p">)</span><span class="o">:</span>                                
<span class="mi">137</span>         <span class="n">def</span> <span class="n">add_microop</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">mnemonic</span><span class="p">,</span> <span class="n">microop</span><span class="p">)</span><span class="o">:</span>    
            <span class="p">......</span>
<span class="mi">251</span>             <span class="n">iop</span> <span class="o">=</span> <span class="n">InstObjParams</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">getMnemonic</span><span class="p">(),</span> <span class="n">self</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="s">"Macroop"</span><span class="p">,</span>   
<span class="mi">252</span>                                 <span class="p">{</span><span class="s">"code"</span> <span class="o">:</span> <span class="s">""</span><span class="p">,</span> <span class="s">"num_microops"</span> <span class="o">:</span> <span class="n">numMicroops</span><span class="p">,</span> 
<span class="mi">253</span>                                  <span class="s">"alloc_microops"</span> <span class="o">:</span> <span class="n">allocMicroops</span><span class="p">,</span>          
<span class="mi">254</span>                                  <span class="s">"adjust_env"</span> <span class="o">:</span> <span class="n">self</span><span class="p">.</span><span class="n">adjust_env</span><span class="p">,</span>            
<span class="mi">255</span>                                  <span class="s">"adjust_imm"</span> <span class="o">:</span> <span class="n">self</span><span class="p">.</span><span class="n">adjust_imm</span><span class="p">,</span>            
<span class="mi">256</span>                                  <span class="s">"adjust_disp"</span> <span class="o">:</span> <span class="n">self</span><span class="p">.</span><span class="n">adjust_disp</span><span class="p">,</span>          
<span class="mi">257</span>                                  <span class="s">"disassembly"</span> <span class="o">:</span> <span class="n">env</span><span class="p">.</span><span class="n">disassembly</span><span class="p">,</span>           
<span class="mi">258</span>                                  <span class="s">"regSize"</span> <span class="o">:</span> <span class="n">regSize</span><span class="p">,</span>                       
<span class="mi">259</span>                                  <span class="s">"init_env"</span> <span class="o">:</span> <span class="n">self</span><span class="p">.</span><span class="n">initEnv</span><span class="p">})</span>                
<span class="mi">260</span>             <span class="k">return</span> <span class="n">MacroConstructor</span><span class="p">.</span><span class="n">subst</span><span class="p">(</span><span class="n">iop</span><span class="p">)</span> <span class="o">+</span> <span class="err">\</span>                          
<span class="mi">261</span>                    <span class="n">MacroDisassembly</span><span class="p">.</span><span class="n">subst</span><span class="p">(</span><span class="n">iop</span><span class="p">);</span> 
</pre></td></tr></tbody></table></code></div></div>

<p>of the MacroConstructor template. Therefore, each macroop needs to prepare its 
own substitution string, which can retrieve the CPP class definition for the 
corresponding macroop. This substitution string, unique to each macroop, is 
created as <strong>InstObjParams</strong>, as demonstrated in lines 251-259 of the 
getDefinition function.</p>

<p>As GEM5 needs to generate classes for various macroops automatically, it 
prepares string templates that implement most parts of the class. Only the 
macroop specific information should be filled in to the template by simple 
string substitution. The macroop specific information is crafted by the 
<em>InstObjParams</em>. It will be used to complete missing macroop-specific parts of 
the <em>MacroConstructor</em> and <em>MacroDisassembly</em> templates.</p>

<p><em>gem5/src/arch/x86/isa/macroop.isa</em></p>
<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre></td><td class="rouge-code"><pre>
 <span class="mi">79</span> <span class="o">//</span> <span class="n">Basic</span> <span class="n">instruction</span> <span class="k">class</span> <span class="nc">declaration</span> <span class="n">template</span><span class="p">.</span>
<span class="mi">100</span> <span class="k">def</span> <span class="nf">template</span> <span class="n">MacroDisassembly</span> <span class="p">{{</span>
<span class="mi">101</span>     <span class="n">std</span><span class="p">::</span><span class="n">string</span>
<span class="mi">102</span>     <span class="n">X86Macroop</span><span class="p">::</span><span class="o">%</span><span class="p">(</span><span class="n">class_name</span><span class="p">)</span><span class="n">s</span><span class="p">::</span><span class="nf">generateDisassembly</span><span class="p">(</span><span class="n">Addr</span> <span class="n">pc</span><span class="p">,</span>
<span class="mi">103</span>             <span class="n">const</span> <span class="n">SymbolTable</span> <span class="o">*</span><span class="n">symtab</span><span class="p">)</span> <span class="n">const</span>
<span class="mi">104</span>     <span class="p">{</span>
<span class="mi">105</span>         <span class="n">std</span><span class="p">::</span><span class="n">stringstream</span> <span class="n">out</span><span class="p">;</span>
<span class="mi">106</span>         <span class="n">out</span> <span class="o">&lt;&lt;</span> <span class="n">mnemonic</span> <span class="o">&lt;&lt;</span> <span class="sh">"</span><span class="se">\t</span><span class="sh">"</span><span class="p">;</span>
<span class="mi">107</span>
<span class="mi">108</span>         <span class="nb">int</span> <span class="n">regSize</span> <span class="o">=</span> <span class="o">%</span><span class="p">(</span><span class="n">regSize</span><span class="p">)</span><span class="n">s</span><span class="p">;</span>
<span class="mi">109</span>         <span class="o">%</span><span class="p">(</span><span class="n">disassembly</span><span class="p">)</span><span class="n">s</span>
<span class="mi">110</span>         <span class="o">//</span> <span class="n">Shut</span> <span class="n">up</span> <span class="n">gcc</span><span class="p">.</span>
<span class="mi">111</span>         <span class="n">regSize</span> <span class="o">=</span> <span class="n">regSize</span><span class="p">;</span>
<span class="mi">112</span>         <span class="k">return</span> <span class="n">out</span><span class="p">.</span><span class="nf">str</span><span class="p">();</span>
<span class="mi">113</span>     <span class="p">}</span>
<span class="mi">114</span> <span class="p">}};</span>
<span class="mi">115</span>
<span class="mi">116</span> <span class="o">//</span> <span class="n">Basic</span> <span class="n">instruction</span> <span class="k">class</span> <span class="nc">constructor</span> <span class="n">template</span><span class="p">.</span>
<span class="mi">117</span> <span class="k">def</span> <span class="nf">template</span> <span class="n">MacroConstructor</span> <span class="p">{{</span>
<span class="mi">118</span>         <span class="n">X86Macroop</span><span class="p">::</span><span class="o">%</span><span class="p">(</span><span class="n">class_name</span><span class="p">)</span><span class="n">s</span><span class="p">::</span><span class="o">%</span><span class="p">(</span><span class="n">class_name</span><span class="p">)</span><span class="nf">s</span><span class="p">(</span>
<span class="mi">119</span>                 <span class="n">ExtMachInst</span> <span class="n">machInst</span><span class="p">,</span> <span class="n">EmulEnv</span> <span class="n">_env</span><span class="p">)</span>
<span class="mi">120</span>             <span class="p">:</span> <span class="o">%</span><span class="p">(</span><span class="n">base_class</span><span class="p">)</span><span class="nf">s</span><span class="p">(</span><span class="sh">"</span><span class="s">%(mnemonic)s</span><span class="sh">"</span><span class="p">,</span> <span class="n">machInst</span><span class="p">,</span> <span class="o">%</span><span class="p">(</span><span class="n">num_microops</span><span class="p">)</span><span class="n">s</span><span class="p">,</span> <span class="n">_env</span><span class="p">)</span>
<span class="mi">121</span>         <span class="p">{</span>
<span class="mi">122</span>             <span class="o">%</span><span class="p">(</span><span class="n">adjust_env</span><span class="p">)</span><span class="n">s</span><span class="p">;</span>
<span class="mi">123</span>             <span class="o">%</span><span class="p">(</span><span class="n">adjust_imm</span><span class="p">)</span><span class="n">s</span><span class="p">;</span>
<span class="mi">124</span>             <span class="o">%</span><span class="p">(</span><span class="n">adjust_disp</span><span class="p">)</span><span class="n">s</span><span class="p">;</span>
<span class="mi">125</span>             <span class="o">%</span><span class="p">(</span><span class="n">init_env</span><span class="p">)</span><span class="n">s</span><span class="p">;</span>
<span class="mi">126</span>             <span class="o">%</span><span class="p">(</span><span class="n">constructor</span><span class="p">)</span><span class="n">s</span><span class="p">;</span>
<span class="mi">127</span>             <span class="n">const</span> <span class="n">char</span> <span class="o">*</span><span class="n">macrocodeBlock</span> <span class="o">=</span> <span class="sh">"</span><span class="s">%(class_name)s</span><span class="sh">"</span><span class="p">;</span>
<span class="mi">128</span>             <span class="o">//</span><span class="n">alloc_microops</span> <span class="ow">is</span> <span class="n">the</span> <span class="n">code</span> <span class="n">that</span> <span class="n">sets</span> <span class="n">up</span> <span class="n">the</span> <span class="n">microops</span>
<span class="mi">129</span>             <span class="o">//</span><span class="n">array</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">parent</span> <span class="n">class</span><span class="p">.</span>
<span class="mi">130</span>             <span class="o">%</span><span class="p">(</span><span class="n">alloc_microops</span><span class="p">)</span><span class="n">s</span><span class="p">;</span>
<span class="mi">131</span>         <span class="p">}</span>
<span class="mi">132</span> <span class="p">}};</span>

</pre></td></tr></tbody></table></code></div></div>
<p>As depicted in the code above, the MacroConstructor is responsible for crafting 
the definition of the macroop class. It’s worth noting that the placeholder 
%(alloc_microops)s, indicated in line 130, gets substituted with the constructor 
code for the microop classes, which is generated by the getAllocator method in 
the Python equivalent of the microops. The MacroDisassembly template is used to 
automatically introduce member function <em>generateDisassembly</em> to automatically 
generated macroop class.</p>

  </div>

  <div class="post-tail-wrapper text-muted">
    <!-- categories -->
    
      <div class="post-meta mb-3">
        <i class="far fa-folder-open fa-fw me-1"></i>
        
          <a href="/categories/gem5/">GEM5,</a>,
          <a href="/categories/macroop/">Macroop,</a>,
          <a href="/categories/microops/">Microops,</a>,
          <a href="/categories/ply/">PLY</a>
      </div>
    

    <!-- tags -->
    

    <div
      class="
        post-tail-bottom
        d-flex justify-content-between align-items-center mt-5 pb-2
      "
    >
      <div class="license-wrapper">
        
          

          This post is licensed under 
        <a href="https://creativecommons.org/licenses/by/4.0/">
          CC BY 4.0
        </a>
         by the author.
        
      </div>

      <!-- Post sharing snippet -->

<div class="share-wrapper d-flex align-items-center">
  <span class="share-label text-muted">Share</span>
  <span class="share-icons">
    
    
    

    

      

      <a
        href="https://twitter.com/intent/tweet?text=Gem5%20Macroop%20To%20Microop%20-%20Ruach&url=http%3A%2F%2Flocalhost%3A4000%2Fposts%2Fgem5-macroop-to-microop%2F"
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Twitter"
        target="_blank"
        rel="noopener"
        aria-label="Twitter"
      >
        <i class="fa-fw fa-brands fa-square-x-twitter"></i>
      </a>
    

      

      <a
        href="https://www.facebook.com/sharer/sharer.php?title=Gem5%20Macroop%20To%20Microop%20-%20Ruach&u=http%3A%2F%2Flocalhost%3A4000%2Fposts%2Fgem5-macroop-to-microop%2F"
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Facebook"
        target="_blank"
        rel="noopener"
        aria-label="Facebook"
      >
        <i class="fa-fw fab fa-facebook-square"></i>
      </a>
    

      

      <a
        href="https://t.me/share/url?url=http%3A%2F%2Flocalhost%3A4000%2Fposts%2Fgem5-macroop-to-microop%2F&text=Gem5%20Macroop%20To%20Microop%20-%20Ruach"
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Telegram"
        target="_blank"
        rel="noopener"
        aria-label="Telegram"
      >
        <i class="fa-fw fab fa-telegram"></i>
      </a>
    

      

      <a
        href="https://www.linkedin.com/sharing/share-offsite/?url=http%3A%2F%2Flocalhost%3A4000%2Fposts%2Fgem5-macroop-to-microop%2F"
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Linkedin"
        target="_blank"
        rel="noopener"
        aria-label="Linkedin"
      >
        <i class="fa-fw fab fa-linkedin"></i>
      </a>
    

    <button
      id="copy-link"
      aria-label="Copy link"
      class="btn small"
      data-bs-toggle="tooltip"
      data-bs-placement="top"
      title="Copy link"
      data-title-succeed="Link copied successfully!"
    >
      <i class="fa-fw fas fa-link pe-none fs-6"></i>
    </button>
  </span>
</div>

    </div>
    <!-- .post-tail-bottom -->
  </div>
  <!-- div.post-tail-wrapper -->
</article>


            
          </main>

          <!-- panel -->
          <aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 mb-5 text-muted">
            <div class="access">
              <!-- Get the last 5 posts from lastmod list. -->















              <!-- The trending tags list -->


















            </div>

            
              
              



  <section id="toc-wrapper" class="ps-0 pe-4">
    <h2 class="panel-heading ps-3 pt-2 mb-2">Contents</h2>
    <nav id="toc"></nav>
  </section>


            
          </aside>
        </div>

        <div class="row">
          <!-- tail -->
          <div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4">
            
              
              <!-- Recommend the other 3 posts according to the tags and categories of the current post. -->

<!-- The total size of related posts -->


<!-- An random integer that bigger than 0 -->


<!-- Equals to TAG_SCORE / {max_categories_hierarchy} -->














  

  

  

  

  

  

  

  
    










  <aside id="related-posts" aria-labelledby="related-label">
    <h3 class="mb-4" id="related-label">Further Reading</h3>
    <nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4">
      
        <article class="col">
          <a href="/posts/gem5-memaccess/" class="post-preview card h-100">
            <div class="card-body">
              <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1591329600"
  data-df="ll"
  
>
  Jun  5, 2020
</time>

              <h4 class="pt-0 my-2">Gem5 Memaccess</h4>
              <div class="text-muted">
                <p>
                  





                  In my previous post, I discussed the automatic generation of C++ classes for 
macroops and microops using various GEM5 tools, including a Python-based parser 
and string-based template substitution...
                </p>
              </div>
            </div>
          </a>
        </article>
      
    </nav>
  </aside>
  <!-- #related-posts -->


            
              
              <!-- Navigation buttons at the bottom of the post. -->

<nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation">
  
  

  
    <a
      href="/posts/gem5-event-loop/"
      class="btn btn-outline-primary"
      aria-label="Older"
    >
      <p>Gem5 Event Loop</p>
    </a>
  

  
    <a
      href="/posts/template-generating-microop/"
      class="btn btn-outline-primary"
      aria-label="Newer"
    >
      <p>Template Generating Microop</p>
    </a>
  
</nav>

            
              
              <!--  The comments switcher -->


            

            <!-- The Footer -->

<footer
  aria-label="Site Info"
  class="
    d-flex flex-column justify-content-center text-muted
    flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3
  "
>
  <p>
    ©
    <time>2023</time>
    <a href="https://ruach.github.io">Jaehyuk Lee</a>.
    
      <span
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author."
      >Some rights reserved.</span>
    
  </p>

  <p>Using the <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme for <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>
  </p>
</footer>

          </div>
        </div>

        <!-- The Search results -->

<div id="search-result-wrapper" class="d-flex justify-content-center unloaded">
  <div class="col-11 content">
    <div id="search-hints">
      <!-- The trending tags list -->


















    </div>
    <div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div>
  </div>
</div>

      </div>

      <aside aria-label="Scroll to Top">
        <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow">
          <i class="fas fa-angle-up"></i>
        </button>
      </aside>
    </div>

    <div id="mask"></div>

    
      <aside
  id="notification"
  class="toast"
  role="alert"
  aria-live="assertive"
  aria-atomic="true"
  data-bs-animation="true"
  data-bs-autohide="false"
>
  <div class="toast-header">
    <button
      type="button"
      class="btn-close ms-auto"
      data-bs-dismiss="toast"
      aria-label="Close"
    ></button>
  </div>
  <div class="toast-body text-center pt-0">
    <p class="px-2 mb-3">A new version of content is available.</p>
    <button type="button" class="btn btn-primary" aria-label="Update">
      Update
    </button>
  </div>
</aside>

    

    <!-- JavaScripts -->

    <!-- JS selector for site. -->

<!-- commons -->



<!-- layout specified -->


  

  
    <!-- image lazy-loading & popup & clipboard -->
    
  















  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  



  <script src="https://cdn.jsdelivr.net/combine/npm/jquery@3.7.1/dist/jquery.min.js,npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js,npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/magnific-popup@1.1.0/dist/jquery.magnific-popup.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.10/dayjs.min.js,npm/dayjs@1.11.10/locale/en.min.js,npm/dayjs@1.11.10/plugin/relativeTime.min.js,npm/dayjs@1.11.10/plugin/localizedFormat.min.js,npm/tocbot@4.21.2/dist/tocbot.min.js"></script>






<script defer src="/assets/js/dist/post.min.js"></script>






    

    <!--
  Jekyll Simple Search loader
  See: <https://github.com/christian-fei/Simple-Jekyll-Search>
-->





<script>
  /* Note: dependent library will be loaded in `js-selector.html` */
  SimpleJekyllSearch({
    searchInput: document.getElementById('search-input'),
    resultsContainer: document.getElementById('search-results'),
    json: '/assets/js/data/search.json',
    searchResultTemplate: '  <article class="px-1 px-sm-2 px-lg-4 px-xl-0">    <header>      <h2><a href="{url}">{title}</a></h2>      <div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1">        {categories}        {tags}      </div>    </header>    <p>{snippet}</p>  </article>',
    noResultsText: '<p class="mt-5"></p>',
    templateMiddleware: function(prop, value, template) {
      if (prop === 'categories') {
        if (value === '') {
          return `${value}`;
        } else {
          return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`;
        }
      }

      if (prop === 'tags') {
        if (value === '') {
          return `${value}`;
        } else {
          return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`;
        }
      }
    }
  });
</script>

  </body>
</html>

