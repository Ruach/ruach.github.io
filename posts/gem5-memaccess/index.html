<!doctype html>














<!-- `site.alt_lang` can specify a language different from the UI -->
<html lang="en" data-mode="light">
  <!-- The Head -->

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta
    name="viewport"
    content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover"
  >

  

  

  
    <!-- Begin Jekyll SEO tag v2.8.0 -->
<meta name="generator" content="Jekyll v4.3.2" />
<meta property="og:title" content="Gem5 Memaccess" />
<meta property="og:locale" content="en" />
<meta name="description" content="In my previous post, I discussed the automatic generation of C++ classes for macroops and microops using various GEM5 tools, including a Python-based parser and string-based template substitution. I also provided an example, explaining how a class definition and its constructor for micro-load instructions are generated. Additionally, I presented several definitions that implement the actual semantics of micro-load operations, including the execute function." />
<meta property="og:description" content="In my previous post, I discussed the automatic generation of C++ classes for macroops and microops using various GEM5 tools, including a Python-based parser and string-based template substitution. I also provided an example, explaining how a class definition and its constructor for micro-load instructions are generated. Additionally, I presented several definitions that implement the actual semantics of micro-load operations, including the execute function." />
<link rel="canonical" href="https://ruach.github.io/posts/gem5-memaccess/" />
<meta property="og:url" content="https://ruach.github.io/posts/gem5-memaccess/" />
<meta property="og:site_name" content="Ruach" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-06-05T00:00:00-04:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Gem5 Memaccess" />
<meta name="twitter:site" content="@ruach_lee" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2020-06-05T00:00:00-04:00","datePublished":"2020-06-05T00:00:00-04:00","description":"In my previous post, I discussed the automatic generation of C++ classes for macroops and microops using various GEM5 tools, including a Python-based parser and string-based template substitution. I also provided an example, explaining how a class definition and its constructor for micro-load instructions are generated. Additionally, I presented several definitions that implement the actual semantics of micro-load operations, including the execute function.","headline":"Gem5 Memaccess","mainEntityOfPage":{"@type":"WebPage","@id":"https://ruach.github.io/posts/gem5-memaccess/"},"url":"https://ruach.github.io/posts/gem5-memaccess/"}</script>
<!-- End Jekyll SEO tag -->

  

  <title>Gem5 Memaccess | Ruach
  </title>

  <!--
  The Favicons for Web, Android, Microsoft, and iOS (iPhone and iPad) Apps
  Generated by: https://realfavicongenerator.net/
-->



<link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png">
<link rel="manifest" href="/assets/img/favicons/site.webmanifest">
<link rel="shortcut icon" href="/assets/img/favicons/favicon.ico">
<meta name="apple-mobile-web-app-title" content="Ruach">
<meta name="application-name" content="Ruach">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml">
<meta name="theme-color" content="#ffffff">


  
    
      <link rel="preconnect" href="https://fonts.googleapis.com" >
      <link rel="dns-prefetch" href="https://fonts.googleapis.com" >
    
      <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      <link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin>
    
      <link rel="preconnect" href="https://fonts.googleapis.com" >
      <link rel="dns-prefetch" href="https://fonts.googleapis.com" >
    
      <link rel="preconnect" href="https://cdn.jsdelivr.net" >
      <link rel="dns-prefetch" href="https://cdn.jsdelivr.net" >
    

    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap">
  

  <!-- GA -->
  

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.2/css/all.min.css">

  <link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css">

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.21.2/dist/tocbot.min.css">
  

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css">
  

  
    <!-- Manific Popup -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css">
  

  <!-- JavaScript -->

  

  <!-- A placeholder to allow defining custom metadata -->

</head>


  <body>
    <!-- The Side Bar -->

<aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end">
  <header class="profile-wrapper">
    <a href="/" id="avatar" class="rounded-circle">
      
        
        <img src="/assets/img/jaehyuk.png" width="112" height="112" alt="avatar" onerror="this.style.display='none'">
      
    </a>

    <h1 class="site-title">
      <a href="/">Ruach</a>
    </h1>
    <p class="site-subtitle fst-italic mb-0">Jaehyuk Lee</p>
  </header>
  <!-- .profile-wrapper -->

  <nav class="flex-column flex-grow-1 w-100 ps-0">
    <ul class="nav">
      <!-- home -->
      <li class="nav-item">
        <a href="/" class="nav-link">
          <i class="fa-fw fas fa-home"></i>
          <span>HOME</span>
        </a>
      </li>
      <!-- the real tabs -->
      
        <li class="nav-item">
          <a href="/categories/" class="nav-link">
            <i class="fa-fw fas fa-stream"></i>
            

            <span>CATEGORIES</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/tags/" class="nav-link">
            <i class="fa-fw fas fa-tags"></i>
            

            <span>TAGS</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/archives/" class="nav-link">
            <i class="fa-fw fas fa-archive"></i>
            

            <span>ARCHIVES</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/about/" class="nav-link">
            <i class="fa-fw fas fa-info-circle"></i>
            

            <span>ABOUT</span>
          </a>
        </li>
        <!-- .nav-item -->
      
    </ul>
  </nav>

  <div class="sidebar-bottom d-flex flex-wrap  align-items-center w-100">
    

    
      

      
        <a
          href="javascript:location.href = 'mailto:' + ['jaehyuk','gatech.edu'].join('@')"
          aria-label="email"
          

          

          

          
        >
          <i class="fas fa-envelope"></i>
        </a>
      
    
      

      
        <a
          href="https://www.linkedin.com/in/jaehyuk-lee-29b33b121/"
          aria-label="linkedin"
          

          
            target="_blank"
            
          

          

          
            rel="noopener noreferrer"
          
        >
          <i class="fab fa-linkedin"></i>
        </a>
      
    
      

      
        <a
          href="https://github.com/Ruach"
          aria-label="github"
          

          
            target="_blank"
            
          

          

          
            rel="noopener noreferrer"
          
        >
          <i class="fab fa-github"></i>
        </a>
      
    
      

      
        <a
          href="https://stackoverflow.com/users/4460514/ruach?tab=profile"
          aria-label="stack-overflow"
          

          
            target="_blank"
            
          

          

          
            rel="noopener noreferrer"
          
        >
          <i class="fab fa-stack-overflow"></i>
        </a>
      
    
  </div>
  <!-- .sidebar-bottom -->
</aside>
<!-- #sidebar -->


    <div id="main-wrapper" class="d-flex justify-content-center">
      <div class="container d-flex flex-column px-xxl-5">
        <!-- The Top Bar -->

<header id="topbar-wrapper" aria-label="Top Bar">
  <div
    id="topbar"
    class="d-flex align-items-center justify-content-between px-lg-3 h-100"
  >
    <nav id="breadcrumb" aria-label="Breadcrumb">
      

      
        
          
            <span>
              <a href="/">
                Home
              </a>
            </span>

          
        
          
        
          
            
              <span>Gem5 Memaccess</span>
            

          
        
      
    </nav>
    <!-- endof #breadcrumb -->

    <button type="button" id="sidebar-trigger" class="btn btn-link">
      <i class="fas fa-bars fa-fw"></i>
    </button>

    <div id="topbar-title">
      Post
    </div>

    <button type="button" id="search-trigger" class="btn btn-link">
      <i class="fas fa-search fa-fw"></i>
    </button>

    <search class="align-items-center ms-3 ms-lg-0">
      <i class="fas fa-search fa-fw"></i>
      <input
        class="form-control"
        id="search-input"
        type="search"
        aria-label="search"
        autocomplete="off"
        placeholder="Search..."
      >
    </search>
    <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button>
  </div>
</header>


        <div class="row flex-grow-1">
          <main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4">
            
              <!-- Refactor the HTML structure -->



<!--
  In order to allow a wide table to scroll horizontally,
  we suround the markdown table with `<div class="table-wrapper">` and `</div>`
-->



<!--
  Fixed kramdown code highlight rendering:
  https://github.com/penibelst/jekyll-compress-html/issues/101
  https://github.com/penibelst/jekyll-compress-html/issues/71#issuecomment-188144901
-->



<!-- Change the icon of checkbox -->



<!-- Handle images -->





<!-- Add header for code snippets -->



<!-- Create heading anchors -->





  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      
    

    
  

  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    

    
  

  
  

  

  
  

  




<!-- return -->




<article class="px-1">
  <header>
    <h1 data-toc-skip>Gem5 Memaccess</h1>

    <div class="post-meta text-muted">
      <!-- published date -->
      <span>
        Posted
        <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1591329600"
  data-df="ll"
  
    data-bs-toggle="tooltip" data-bs-placement="bottom"
  
>
  Jun  5, 2020
</time>

      </span>

      <!-- lastmod date -->
      

      

      <div class="d-flex justify-content-between">
        <!-- author(s) -->
        <span>
          

          By

          <em>
            
              <a href="https://ruach.github.io">Jaehyuk Lee</a>
            
          </em>
        </span>

        <!-- read time -->
        <!-- Calculate the post's reading time, and display the word count in tooltip -->



<!-- words per minute -->










<!-- return element -->
<span
  class="readtime"
  data-bs-toggle="tooltip"
  data-bs-placement="bottom"
  title="4665 words"
>
  <em>25 min</em> read</span>

      </div>
      <!-- .d-flex -->
    </div>
    <!-- .post-meta -->
  </header>

  <div class="content">
    <p>In my previous post, I discussed the automatic generation of C++ classes for 
macroops and microops using various GEM5 tools, including a Python-based parser 
and string-based template substitution. I also provided an example, explaining 
how a class definition and its constructor for micro-load instructions are 
generated. Additionally, I presented several definitions that implement the 
actual semantics of micro-load operations, including the execute function.</p>

<p>The instructions are designed to change internal state of the system. More 
specifically, by executing certain instructions, they can induce specific 
changes in registers, memory, or internal states that are represented as 
architectural elements.
Given that GEM5 operates as an architecture-level emulator, the execution of a 
single micro-op should result in the alteration of a particular data structure 
representing a segment of the architecture. To achieve this, GEM5 provides the
“ExecContext” class, which emulates the entire underlying architecture. 
Additionally, the “execute” method and other definitions of the micro-operations
are designed to modify the “ExecContext” as a consequence of their execution. 
In essence, these definitions emulate the semantics of the instructions.
We will explore how the execution of a micro-op can modify the underlying 
architectural state through updating “ExecContext. To comprehend how GEM5 
executes micro-operations, we will briefly examine the pipeline of a simple 
processor.</p>

<h2 id="cpu-pipeline-of-the-simple-processor-fetch-decode-execute"><span class="me-2">CPU pipeline of the simple processor: fetch-decode-execute</span><a href="#cpu-pipeline-of-the-simple-processor-fetch-decode-execute" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<p>To understand how GEM5 emulates the entire architecture, one crucial question to
address is: <strong>When and how does GEM5 execute the next instruction?</strong> In other 
words, we must understand who utilizes the automatically generated micro-op 
class and its functions.
Each CPU model features a distinct pipeline architecture, and this difference 
significantly influences the execution of instructions within the pipeline. To 
shed light on this, we will examine the TimingSimple CPU model, which is the 
most basic CPU pipeline model supported by GEM5.</p>

<p>Here are the key characteristics of the SimpleTiming processor model in GEM5:</p>

<ul>
  <li><strong>Single-Cycle Execution</strong>: It operates on a single-cycle execution model,</li>
  <li>
    <p>where each instruction is executed in one clock cycle.</p>
  </li>
  <li><strong>Minimal Microarchitecture</strong>: It lacks the complexity of multiple pipeline</li>
  <li>
    <p>stages, making it relatively simple and easy to understand.</p>
  </li>
  <li><strong>Idealized Timing</strong>: The SimpleTiming model does not account for detailed</li>
  <li>timing, such as pipeline hazards or stalls, and assumes that instructions</li>
  <li>progress through the pipeline without delays.</li>
</ul>

<h3 id="processor-invokes-fetch-at-every-clock-tick"><span class="me-2">Processor invokes fetch at every clock tick</span><a href="#processor-invokes-fetch-at-every-clock-tick" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>To understand how the TimingSimple processor process the events,
we should understand which function will be invoked at the schedule event. 
Scheduling a specific event requires a EventFunctionWrapper instance
which contains information about event handler function.</p>

<p><em>gem5/src/cpu/simple/timing.hh</em></p>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre> <span class="mi">51</span> <span class="k">class</span> <span class="nc">TimingSimpleCPU</span> <span class="o">:</span> <span class="k">public</span> <span class="n">BaseSimpleCPU</span>
 <span class="mi">52</span> <span class="p">{</span>
<span class="p">......</span>
<span class="mi">325</span>   <span class="k">private</span><span class="o">:</span>
<span class="mi">326</span> 
<span class="mi">327</span>     <span class="n">EventFunctionWrapper</span> <span class="n">fetchEvent</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></div></div>

<p>As shown in the above class declaration of the TimingSimpleCPU, 
I can find that fetchEvent member field is declared as EventFunctionWrapper.
To utilize the wrapper to schedule event, 
proper initialization code is required.</p>

<p><em>gem5/src/cpu/simple/timing.cc</em></p>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre>  <span class="mi">82</span> <span class="n">TimingSimpleCPU</span><span class="o">::</span><span class="n">TimingSimpleCPU</span><span class="p">(</span><span class="n">TimingSimpleCPUParams</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
  <span class="mi">83</span>     <span class="o">:</span> <span class="n">BaseSimpleCPU</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="n">fetchTranslation</span><span class="p">(</span><span class="k">this</span><span class="p">),</span> <span class="n">icachePort</span><span class="p">(</span><span class="k">this</span><span class="p">),</span>
  <span class="mi">84</span>       <span class="nf">dcachePort</span><span class="p">(</span><span class="k">this</span><span class="p">),</span> <span class="n">ifetch_pkt</span><span class="p">(</span><span class="nb">NULL</span><span class="p">),</span> <span class="n">dcache_pkt</span><span class="p">(</span><span class="nb">NULL</span><span class="p">),</span> <span class="n">previousCycle</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
  <span class="mi">85</span>       <span class="n">fetchEvent</span><span class="p">([</span><span class="k">this</span><span class="p">]{</span> <span class="n">fetch</span><span class="p">();</span> <span class="p">},</span> <span class="n">name</span><span class="p">())</span>
  <span class="mi">86</span> <span class="p">{</span>
  <span class="mi">87</span>     <span class="n">_status</span> <span class="o">=</span> <span class="n">Idle</span><span class="p">;</span>
  <span class="mi">88</span> <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>As shown in the constructor of the TimingSimpleCPU, 
it initialize the fetchEvent member field with a function called <strong>fetch</strong>.
Therefore, whenever the fetchEvent is scheduled, 
the GEM5 will invoke the fetch function and start to fetch the instruction
from the memory (or cache).</p>

<h3 id="fetch-retrieving-next-instruction-to-execute-from-memory"><span class="me-2">fetch: retrieving next instruction to execute from memory</span><a href="#fetch-retrieving-next-instruction-to-execute-from-memory" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p><em>gem5/src/cpu/simple/timing.cc</em></p>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
</pre></td><td class="rouge-code"><pre> <span class="mi">653</span> <span class="kt">void</span>
 <span class="mi">654</span> <span class="n">TimingSimpleCPU</span><span class="o">::</span><span class="n">fetch</span><span class="p">()</span>
 <span class="mi">655</span> <span class="p">{</span>
 <span class="mi">656</span>     <span class="c1">// Change thread if multi-threaded</span>
 <span class="mi">657</span>     <span class="n">swapActiveThread</span><span class="p">();</span>
 <span class="mi">658</span>
 <span class="mi">659</span>     <span class="n">SimpleExecContext</span> <span class="o">&amp;</span><span class="n">t_info</span> <span class="o">=</span> <span class="o">*</span><span class="n">threadInfo</span><span class="p">[</span><span class="n">curThread</span><span class="p">];</span>
 <span class="mi">660</span>     <span class="n">SimpleThread</span><span class="o">*</span> <span class="kr">thread</span> <span class="o">=</span> <span class="n">t_info</span><span class="p">.</span><span class="kr">thread</span><span class="p">;</span>
 <span class="mi">661</span>
 <span class="mi">662</span>     <span class="n">DPRINTF</span><span class="p">(</span><span class="n">SimpleCPU</span><span class="p">,</span> <span class="s">"Fetch</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
 <span class="mi">663</span>
 <span class="mi">664</span>     <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">curStaticInst</span> <span class="o">||</span> <span class="o">!</span><span class="n">curStaticInst</span><span class="o">-&gt;</span><span class="n">isDelayedCommit</span><span class="p">())</span> <span class="p">{</span>
 <span class="mi">665</span>         <span class="n">checkForInterrupts</span><span class="p">();</span>
 <span class="mi">666</span>         <span class="n">checkPcEventQueue</span><span class="p">();</span>
 <span class="mi">667</span>     <span class="p">}</span>
 <span class="mi">668</span>
 <span class="mi">669</span>     <span class="c1">// We must have just got suspended by a PC event</span>
 <span class="mi">670</span>     <span class="k">if</span> <span class="p">(</span><span class="n">_status</span> <span class="o">==</span> <span class="n">Idle</span><span class="p">)</span>
 <span class="mi">671</span>         <span class="k">return</span><span class="p">;</span>
 <span class="mi">672</span>
 <span class="mi">673</span>     <span class="n">TheISA</span><span class="o">::</span><span class="n">PCState</span> <span class="n">pcState</span> <span class="o">=</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">pcState</span><span class="p">();</span>
 <span class="mi">674</span>     <span class="kt">bool</span> <span class="n">needToFetch</span> <span class="o">=</span> <span class="o">!</span><span class="n">isRomMicroPC</span><span class="p">(</span><span class="n">pcState</span><span class="p">.</span><span class="n">microPC</span><span class="p">())</span> <span class="o">&amp;&amp;</span>
 <span class="mi">675</span>                        <span class="o">!</span><span class="n">curMacroStaticInst</span><span class="p">;</span>
 <span class="mi">676</span>
 <span class="mi">677</span>     <span class="nf">if</span> <span class="p">(</span><span class="n">needToFetch</span><span class="p">)</span> <span class="p">{</span>
 <span class="mi">678</span>         <span class="n">_status</span> <span class="o">=</span> <span class="n">BaseSimpleCPU</span><span class="o">::</span><span class="n">Running</span><span class="p">;</span>
 <span class="mi">679</span>         <span class="n">RequestPtr</span> <span class="n">ifetch_req</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">Request</span><span class="o">&gt;</span><span class="p">();</span>
 <span class="mi">680</span>         <span class="n">ifetch_req</span><span class="o">-&gt;</span><span class="n">taskId</span><span class="p">(</span><span class="n">taskId</span><span class="p">());</span>
 <span class="mi">681</span>         <span class="n">ifetch_req</span><span class="o">-&gt;</span><span class="n">setContext</span><span class="p">(</span><span class="kr">thread</span><span class="o">-&gt;</span><span class="n">contextId</span><span class="p">());</span>
 <span class="mi">682</span>         <span class="n">setupFetchRequest</span><span class="p">(</span><span class="n">ifetch_req</span><span class="p">);</span>
 <span class="mi">683</span>         <span class="n">DPRINTF</span><span class="p">(</span><span class="n">SimpleCPU</span><span class="p">,</span> <span class="s">"Translating address %#x</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">ifetch_req</span><span class="o">-&gt;</span><span class="n">getVaddr</span><span class="p">());</span>
 <span class="mi">684</span>         <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">itb</span><span class="o">-&gt;</span><span class="n">translateTiming</span><span class="p">(</span><span class="n">ifetch_req</span><span class="p">,</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">getTC</span><span class="p">(),</span>
 <span class="mi">685</span>                 <span class="o">&amp;</span><span class="n">fetchTranslation</span><span class="p">,</span> <span class="n">BaseTLB</span><span class="o">::</span><span class="n">Execute</span><span class="p">);</span>
 <span class="mi">686</span>     <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
 <span class="mi">687</span>         <span class="n">_status</span> <span class="o">=</span> <span class="n">IcacheWaitResponse</span><span class="p">;</span>
 <span class="mi">688</span>         <span class="n">completeIfetch</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
 <span class="mi">689</span>
 <span class="mi">690</span>         <span class="n">updateCycleCounts</span><span class="p">();</span>
 <span class="mi">691</span>         <span class="n">updateCycleCounters</span><span class="p">(</span><span class="n">BaseCPU</span><span class="o">::</span><span class="n">CPU_STATE_ON</span><span class="p">);</span>
 <span class="mi">692</span>     <span class="p">}</span>
 <span class="mi">693</span> <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="decode"><span class="me-2">decode</span><a href="#decode" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>Processor can decode the memory blocks as instruction
after the memory has been fetched from the cache or memory.
Because timing simple CPU assume memory access takes more than single cycle,
it needs to be notified when the requested memory block has been brought to the processor.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="rouge-code"><pre> <span class="mi">874</span> <span class="kt">void</span>
 <span class="mi">875</span> <span class="n">TimingSimpleCPU</span><span class="o">::</span><span class="n">IcachePort</span><span class="o">::</span><span class="n">ITickEvent</span><span class="o">::</span><span class="n">process</span><span class="p">()</span>
 <span class="mi">876</span> <span class="p">{</span>
 <span class="mi">877</span>     <span class="n">cpu</span><span class="o">-&gt;</span><span class="n">completeIfetch</span><span class="p">(</span><span class="n">pkt</span><span class="p">);</span>
 <span class="mi">878</span> <span class="p">}</span>
 <span class="mi">879</span> 
 <span class="mi">880</span> <span class="kt">bool</span>
 <span class="mi">881</span> <span class="n">TimingSimpleCPU</span><span class="o">::</span><span class="n">IcachePort</span><span class="o">::</span><span class="n">recvTimingResp</span><span class="p">(</span><span class="n">PacketPtr</span> <span class="n">pkt</span><span class="p">)</span>
 <span class="mi">882</span> <span class="p">{</span>
 <span class="mi">883</span>     <span class="n">DPRINTF</span><span class="p">(</span><span class="n">SimpleCPU</span><span class="p">,</span> <span class="s">"Received fetch response %#x</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">getAddr</span><span class="p">());</span>
 <span class="mi">884</span>     <span class="c1">// we should only ever see one response per cycle since we only</span>
 <span class="mi">885</span>     <span class="c1">// issue a new request once this response is sunk</span>
 <span class="mi">886</span>     <span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">tickEvent</span><span class="p">.</span><span class="n">scheduled</span><span class="p">());</span>
 <span class="mi">887</span>     <span class="c1">// delay processing of returned data until next CPU clock edge</span>
 <span class="mi">888</span>     <span class="n">tickEvent</span><span class="p">.</span><span class="n">schedule</span><span class="p">(</span><span class="n">pkt</span><span class="p">,</span> <span class="n">cpu</span><span class="o">-&gt;</span><span class="n">clockEdge</span><span class="p">());</span>
 <span class="mi">889</span> 
 <span class="mi">890</span>     <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
 <span class="mi">891</span> <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>As a processor is connected to a memory subsystem through the bus,
bus should be programmed to invoke a function
that can handle the fetched instruction, <em>completeIfetch</em>.
When IcachePort receive response from 
memory subsystem, 
it schedule event with received packet.
Because it is scheduled to fire at right next cycle, 
it ends up invoking completeIfetch function of the TimingSimpleCPU.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
</pre></td><td class="rouge-code"><pre> <span class="mi">775</span> <span class="kt">void</span>
 <span class="mi">776</span> <span class="n">TimingSimpleCPU</span><span class="o">::</span><span class="n">completeIfetch</span><span class="p">(</span><span class="n">PacketPtr</span> <span class="n">pkt</span><span class="p">)</span>
 <span class="mi">777</span> <span class="p">{</span>
 <span class="mi">778</span>     <span class="n">SimpleExecContext</span><span class="o">&amp;</span> <span class="n">t_info</span> <span class="o">=</span> <span class="o">*</span><span class="n">threadInfo</span><span class="p">[</span><span class="n">curThread</span><span class="p">];</span>
 <span class="mi">779</span>
 <span class="mi">780</span>     <span class="n">DPRINTF</span><span class="p">(</span><span class="n">SimpleCPU</span><span class="p">,</span> <span class="s">"Complete ICache Fetch for addr %#x</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">pkt</span> <span class="o">?</span>
 <span class="mi">781</span>             <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">getAddr</span><span class="p">()</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
 <span class="mi">782</span>
 <span class="mi">783</span>     <span class="c1">// received a response from the icache: execute the received</span>
 <span class="mi">784</span>     <span class="c1">// instruction</span>
 <span class="mi">785</span>     <span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">pkt</span> <span class="o">||</span> <span class="o">!</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">isError</span><span class="p">());</span>
 <span class="mi">786</span>     <span class="n">assert</span><span class="p">(</span><span class="n">_status</span> <span class="o">==</span> <span class="n">IcacheWaitResponse</span><span class="p">);</span>
 <span class="mi">787</span>
 <span class="mi">788</span>     <span class="n">_status</span> <span class="o">=</span> <span class="n">BaseSimpleCPU</span><span class="o">::</span><span class="n">Running</span><span class="p">;</span>
 <span class="mi">789</span>
 <span class="mi">790</span>     <span class="n">updateCycleCounts</span><span class="p">();</span>
 <span class="mi">791</span>     <span class="n">updateCycleCounters</span><span class="p">(</span><span class="n">BaseCPU</span><span class="o">::</span><span class="n">CPU_STATE_ON</span><span class="p">);</span>
 <span class="mi">792</span>
 <span class="mi">793</span>     <span class="k">if</span> <span class="p">(</span><span class="n">pkt</span><span class="p">)</span>
 <span class="mi">794</span>         <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">setAccessLatency</span><span class="p">();</span>
 <span class="mi">795</span>
 <span class="mi">796</span>
 <span class="mi">797</span>     <span class="n">preExecute</span><span class="p">();</span>
 <span class="mi">798</span>     <span class="k">if</span> <span class="p">(</span><span class="n">curStaticInst</span> <span class="o">&amp;&amp;</span> <span class="n">curStaticInst</span><span class="o">-&gt;</span><span class="n">isMemRef</span><span class="p">())</span> <span class="p">{</span>
 <span class="mi">799</span>         <span class="c1">// load or store: just send to dcache</span>
 <span class="mi">800</span>         <span class="n">Fault</span> <span class="n">fault</span> <span class="o">=</span> <span class="n">curStaticInst</span><span class="o">-&gt;</span><span class="n">initiateAcc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t_info</span><span class="p">,</span> <span class="n">traceData</span><span class="p">);</span>
 <span class="mi">801</span>
 <span class="mi">802</span>         <span class="c1">// If we're not running now the instruction will complete in a dcache</span>
 <span class="mi">803</span>         <span class="c1">// response callback or the instruction faulted and has started an</span>
 <span class="mi">804</span>         <span class="c1">// ifetch</span>
 <span class="mi">805</span>         <span class="k">if</span> <span class="p">(</span><span class="n">_status</span> <span class="o">==</span> <span class="n">BaseSimpleCPU</span><span class="o">::</span><span class="n">Running</span><span class="p">)</span> <span class="p">{</span>
 <span class="mi">806</span>             <span class="k">if</span> <span class="p">(</span><span class="n">fault</span> <span class="o">!=</span> <span class="n">NoFault</span> <span class="o">&amp;&amp;</span> <span class="n">traceData</span><span class="p">)</span> <span class="p">{</span>
 <span class="mi">807</span>                 <span class="c1">// If there was a fault, we shouldn't trace this instruction.</span>
 <span class="mi">808</span>                 <span class="k">delete</span> <span class="n">traceData</span><span class="p">;</span>
 <span class="mi">809</span>                 <span class="n">traceData</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
 <span class="mi">810</span>             <span class="p">}</span>
 <span class="mi">811</span>
 <span class="mi">812</span>             <span class="nf">postExecute</span><span class="p">();</span>
 <span class="mi">813</span>             <span class="c1">// @todo remove me after debugging with legion done</span>
 <span class="mi">814</span>             <span class="k">if</span> <span class="p">(</span><span class="n">curStaticInst</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">curStaticInst</span><span class="o">-&gt;</span><span class="n">isMicroop</span><span class="p">()</span> <span class="o">||</span>
 <span class="mi">815</span>                         <span class="n">curStaticInst</span><span class="o">-&gt;</span><span class="n">isFirstMicroop</span><span class="p">()))</span>
 <span class="mi">816</span>                 <span class="n">instCnt</span><span class="o">++</span><span class="p">;</span>
 <span class="mi">817</span>             <span class="nf">advanceInst</span><span class="p">(</span><span class="n">fault</span><span class="p">);</span>
 <span class="mi">818</span>         <span class="p">}</span>
 <span class="mi">819</span>     <span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">curStaticInst</span><span class="p">)</span> <span class="p">{</span>
 <span class="mi">820</span>         <span class="c1">// non-memory instruction: execute completely now</span>
 <span class="mi">821</span>         <span class="n">Fault</span> <span class="n">fault</span> <span class="o">=</span> <span class="n">curStaticInst</span><span class="o">-&gt;</span><span class="n">execute</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t_info</span><span class="p">,</span> <span class="n">traceData</span><span class="p">);</span>
 <span class="mi">822</span>
 <span class="mi">823</span>         <span class="c1">// keep an instruction count</span>
 <span class="mi">824</span>         <span class="k">if</span> <span class="p">(</span><span class="n">fault</span> <span class="o">==</span> <span class="n">NoFault</span><span class="p">)</span>
 <span class="mi">825</span>             <span class="n">countInst</span><span class="p">();</span>
 <span class="mi">826</span>         <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">traceData</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">DTRACE</span><span class="p">(</span><span class="n">ExecFaulting</span><span class="p">))</span> <span class="p">{</span>
 <span class="mi">827</span>             <span class="k">delete</span> <span class="n">traceData</span><span class="p">;</span>
 <span class="mi">828</span>             <span class="n">traceData</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
 <span class="mi">829</span>         <span class="p">}</span>
 <span class="mi">830</span>
 <span class="mi">831</span>         <span class="nf">postExecute</span><span class="p">();</span>
 <span class="mi">832</span>         <span class="c1">// @todo remove me after debugging with legion done</span>
 <span class="mi">833</span>         <span class="k">if</span> <span class="p">(</span><span class="n">curStaticInst</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">curStaticInst</span><span class="o">-&gt;</span><span class="n">isMicroop</span><span class="p">()</span> <span class="o">||</span>
 <span class="mi">834</span>                 <span class="n">curStaticInst</span><span class="o">-&gt;</span><span class="n">isFirstMicroop</span><span class="p">()))</span>
 <span class="mi">835</span>             <span class="n">instCnt</span><span class="o">++</span><span class="p">;</span>
 <span class="mi">836</span>         <span class="nf">advanceInst</span><span class="p">(</span><span class="n">fault</span><span class="p">);</span>
 <span class="mi">837</span>     <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
 <span class="mi">838</span>         <span class="n">advanceInst</span><span class="p">(</span><span class="n">NoFault</span><span class="p">);</span>
 <span class="mi">839</span>     <span class="p">}</span>
 <span class="mi">840</span>
 <span class="mi">841</span>     <span class="nf">if</span> <span class="p">(</span><span class="n">pkt</span><span class="p">)</span> <span class="p">{</span>
 <span class="mi">842</span>         <span class="k">delete</span> <span class="n">pkt</span><span class="p">;</span>
 <span class="mi">843</span>     <span class="p">}</span>
 <span class="mi">844</span> <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>
<p>CompleteIfetch instruction consists of four parts:
preExecute, instruction execution, postExecute, and advanceInst.
By the way, although we cannot see any decoding logic
it makes use of curStaticInst to execute fetched instruction.
Who decodes the fetched packet and generate curStaticInst?
that is a <em>preExecute</em> function.</p>

<p><em>gem5/src/cpu/simple/base.cc</em></p>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
</pre></td><td class="rouge-code"><pre><span class="mi">481</span> <span class="kt">void</span>
<span class="mi">482</span> <span class="n">BaseSimpleCPU</span><span class="o">::</span><span class="n">preExecute</span><span class="p">()</span>
<span class="mi">483</span> <span class="p">{</span>
<span class="mi">484</span>     <span class="n">SimpleExecContext</span> <span class="o">&amp;</span><span class="n">t_info</span> <span class="o">=</span> <span class="o">*</span><span class="n">threadInfo</span><span class="p">[</span><span class="n">curThread</span><span class="p">];</span>
<span class="mi">485</span>     <span class="n">SimpleThread</span><span class="o">*</span> <span class="kr">thread</span> <span class="o">=</span> <span class="n">t_info</span><span class="p">.</span><span class="kr">thread</span><span class="p">;</span>
<span class="mi">486</span>
<span class="mi">487</span>     <span class="c1">// maintain $r0 semantics</span>
<span class="mi">488</span>     <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">setIntReg</span><span class="p">(</span><span class="n">ZeroReg</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="mi">489</span> <span class="err">#</span><span class="k">if</span> <span class="n">THE_ISA</span> <span class="o">==</span> <span class="n">ALPHA_ISA</span>
<span class="mi">490</span>     <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">setFloatReg</span><span class="p">(</span><span class="n">ZeroReg</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="mi">491</span> <span class="err">#</span><span class="n">endif</span> <span class="c1">// ALPHA_ISA</span>
<span class="mi">492</span>
<span class="mi">493</span>     <span class="c1">// resets predicates</span>
<span class="mi">494</span>     <span class="n">t_info</span><span class="p">.</span><span class="n">setPredicate</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
<span class="mi">495</span>     <span class="n">t_info</span><span class="p">.</span><span class="n">setMemAccPredicate</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
<span class="mi">496</span>
<span class="mi">497</span>     <span class="c1">// check for instruction-count-based events</span>
<span class="mi">498</span>     <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">comInstEventQueue</span><span class="p">.</span><span class="n">serviceEvents</span><span class="p">(</span><span class="n">t_info</span><span class="p">.</span><span class="n">numInst</span><span class="p">);</span>
<span class="mi">499</span>
<span class="mi">500</span>     <span class="c1">// decode the instruction</span>
<span class="mi">501</span>     <span class="n">TheISA</span><span class="o">::</span><span class="n">PCState</span> <span class="n">pcState</span> <span class="o">=</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">pcState</span><span class="p">();</span>
<span class="mi">502</span>
<span class="mi">503</span>     <span class="k">if</span> <span class="p">(</span><span class="n">isRomMicroPC</span><span class="p">(</span><span class="n">pcState</span><span class="p">.</span><span class="n">microPC</span><span class="p">()))</span> <span class="p">{</span>
<span class="mi">504</span>         <span class="n">t_info</span><span class="p">.</span><span class="n">stayAtPC</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="mi">505</span>         <span class="n">curStaticInst</span> <span class="o">=</span> <span class="n">microcodeRom</span><span class="p">.</span><span class="n">fetchMicroop</span><span class="p">(</span><span class="n">pcState</span><span class="p">.</span><span class="n">microPC</span><span class="p">(),</span>
<span class="mi">506</span>                                                   <span class="n">curMacroStaticInst</span><span class="p">);</span>
<span class="mi">507</span>     <span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="o">!</span><span class="n">curMacroStaticInst</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">508</span>         <span class="c1">//We're not in the middle of a macro instruction</span>
<span class="mi">509</span>         <span class="n">StaticInstPtr</span> <span class="n">instPtr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="mi">510</span>
<span class="mi">511</span>         <span class="n">TheISA</span><span class="o">::</span><span class="n">Decoder</span> <span class="o">*</span><span class="n">decoder</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="kr">thread</span><span class="o">-&gt;</span><span class="n">decoder</span><span class="p">);</span>
<span class="mi">512</span>
<span class="mi">513</span>         <span class="c1">//Predecode, ie bundle up an ExtMachInst</span>
<span class="mi">514</span>         <span class="c1">//If more fetch data is needed, pass it in.</span>
<span class="mi">515</span>         <span class="n">Addr</span> <span class="n">fetchPC</span> <span class="o">=</span> <span class="p">(</span><span class="n">pcState</span><span class="p">.</span><span class="n">instAddr</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">PCMask</span><span class="p">)</span> <span class="o">+</span> <span class="n">t_info</span><span class="p">.</span><span class="n">fetchOffset</span><span class="p">;</span>
<span class="mi">516</span>         <span class="c1">//if (decoder-&gt;needMoreBytes())</span>
<span class="mi">517</span>             <span class="n">decoder</span><span class="o">-&gt;</span><span class="n">moreBytes</span><span class="p">(</span><span class="n">pcState</span><span class="p">,</span> <span class="n">fetchPC</span><span class="p">,</span> <span class="n">inst</span><span class="p">);</span>
<span class="mi">518</span>         <span class="c1">//else</span>
<span class="mi">519</span>         <span class="c1">//    decoder-&gt;process();</span>
<span class="mi">520</span>
<span class="mi">521</span>         <span class="c1">//Decode an instruction if one is ready. Otherwise, we'll have to</span>
<span class="mi">522</span>         <span class="c1">//fetch beyond the MachInst at the current pc.</span>
<span class="mi">523</span>         <span class="n">instPtr</span> <span class="o">=</span> <span class="n">decoder</span><span class="o">-&gt;</span><span class="n">decode</span><span class="p">(</span><span class="n">pcState</span><span class="p">);</span>
<span class="mi">524</span>         <span class="k">if</span> <span class="p">(</span><span class="n">instPtr</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">525</span>             <span class="n">t_info</span><span class="p">.</span><span class="n">stayAtPC</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="mi">526</span>             <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">pcState</span><span class="p">(</span><span class="n">pcState</span><span class="p">);</span>
<span class="mi">527</span>         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="mi">528</span>             <span class="n">t_info</span><span class="p">.</span><span class="n">stayAtPC</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="mi">529</span>             <span class="n">t_info</span><span class="p">.</span><span class="n">fetchOffset</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">MachInst</span><span class="p">);</span>
<span class="mi">530</span>         <span class="p">}</span>
<span class="mi">531</span>
<span class="mi">532</span>         <span class="c1">//If we decoded an instruction and it's microcoded, start pulling</span>
<span class="mi">533</span>         <span class="c1">//out micro ops</span>
<span class="mi">534</span>         <span class="nf">if</span> <span class="p">(</span><span class="n">instPtr</span> <span class="o">&amp;&amp;</span> <span class="n">instPtr</span><span class="o">-&gt;</span><span class="n">isMacroop</span><span class="p">())</span> <span class="p">{</span>
<span class="mi">535</span>             <span class="n">curMacroStaticInst</span> <span class="o">=</span> <span class="n">instPtr</span><span class="p">;</span>
<span class="mi">536</span>             <span class="n">curStaticInst</span> <span class="o">=</span>
<span class="mi">537</span>                 <span class="n">curMacroStaticInst</span><span class="o">-&gt;</span><span class="n">fetchMicroop</span><span class="p">(</span><span class="n">pcState</span><span class="p">.</span><span class="n">microPC</span><span class="p">());</span>
<span class="mi">538</span>         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="mi">539</span>             <span class="n">curStaticInst</span> <span class="o">=</span> <span class="n">instPtr</span><span class="p">;</span>
<span class="mi">540</span>         <span class="p">}</span>
<span class="mi">541</span>     <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="mi">542</span>         <span class="c1">//Read the next micro op from the macro op</span>
<span class="mi">543</span>         <span class="n">curStaticInst</span> <span class="o">=</span> <span class="n">curMacroStaticInst</span><span class="o">-&gt;</span><span class="n">fetchMicroop</span><span class="p">(</span><span class="n">pcState</span><span class="p">.</span><span class="n">microPC</span><span class="p">());</span>
<span class="mi">544</span>     <span class="p">}</span>
<span class="mi">545</span>
<span class="mi">546</span>     <span class="c1">//If we decoded an instruction this "tick", record information about it.</span>
<span class="mi">547</span>     <span class="nf">if</span> <span class="p">(</span><span class="n">curStaticInst</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">548</span> <span class="err">#</span><span class="k">if</span> <span class="n">TRACING_ON</span>
<span class="mi">549</span>         <span class="n">traceData</span> <span class="o">=</span> <span class="n">tracer</span><span class="o">-&gt;</span><span class="n">getInstRecord</span><span class="p">(</span><span class="n">curTick</span><span class="p">(),</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">getTC</span><span class="p">(),</span>
<span class="mi">550</span>                 <span class="n">curStaticInst</span><span class="p">,</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">pcState</span><span class="p">(),</span> <span class="n">curMacroStaticInst</span><span class="p">);</span>
<span class="mi">551</span>
<span class="mi">552</span>         <span class="n">DPRINTF</span><span class="p">(</span><span class="n">Decode</span><span class="p">,</span><span class="s">"Decode: Decoded %s instruction: %#x</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
<span class="mi">553</span>                 <span class="n">curStaticInst</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">(),</span> <span class="n">curStaticInst</span><span class="o">-&gt;</span><span class="n">machInst</span><span class="p">);</span>
<span class="mi">554</span> <span class="err">#</span><span class="n">endif</span> <span class="c1">// TRACING_ON</span>
<span class="mi">555</span>     <span class="p">}</span>
<span class="mi">556</span>
<span class="mi">557</span>     <span class="nf">if</span> <span class="p">(</span><span class="n">branchPred</span> <span class="o">&amp;&amp;</span> <span class="n">curStaticInst</span> <span class="o">&amp;&amp;</span>
<span class="mi">558</span>         <span class="n">curStaticInst</span><span class="o">-&gt;</span><span class="n">isControl</span><span class="p">())</span> <span class="p">{</span>
<span class="mi">559</span>         <span class="c1">// Use a fake sequence number since we only have one</span>
<span class="mi">560</span>         <span class="c1">// instruction in flight at the same time.</span>
<span class="mi">561</span>         <span class="k">const</span> <span class="n">InstSeqNum</span> <span class="n">cur_sn</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="mi">562</span>         <span class="n">t_info</span><span class="p">.</span><span class="n">predPC</span> <span class="o">=</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">pcState</span><span class="p">();</span>
<span class="mi">563</span>         <span class="k">const</span> <span class="kt">bool</span> <span class="n">predict_taken</span><span class="p">(</span>
<span class="mi">564</span>             <span class="n">branchPred</span><span class="o">-&gt;</span><span class="n">predict</span><span class="p">(</span><span class="n">curStaticInst</span><span class="p">,</span> <span class="n">cur_sn</span><span class="p">,</span> <span class="n">t_info</span><span class="p">.</span><span class="n">predPC</span><span class="p">,</span>
<span class="mi">565</span>                                 <span class="n">curThread</span><span class="p">));</span>
<span class="mi">566</span>
<span class="mi">567</span>         <span class="k">if</span> <span class="p">(</span><span class="n">predict_taken</span><span class="p">)</span>
<span class="mi">568</span>             <span class="o">++</span><span class="n">t_info</span><span class="p">.</span><span class="n">numPredictedBranches</span><span class="p">;</span>
<span class="mi">569</span>     <span class="p">}</span>
<span class="mi">570</span> <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>
<h3 id="execute-modify-execcontext-based-on-instruction"><span class="me-2">execute: modify ExecContext based on instruction</span><a href="#execute-modify-execcontext-based-on-instruction" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p><em>gem5/build/X86/arch/x86/generated/exec-ns.cc.inc</em></p>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
</pre></td><td class="rouge-code"><pre><span class="mi">19101</span>     <span class="n">Fault</span> <span class="n">Ld</span><span class="o">::</span><span class="n">execute</span><span class="p">(</span><span class="n">ExecContext</span> <span class="o">*</span><span class="n">xc</span><span class="p">,</span>
<span class="mi">19102</span>           <span class="n">Trace</span><span class="o">::</span><span class="n">InstRecord</span> <span class="o">*</span><span class="n">traceData</span><span class="p">)</span> <span class="k">const</span>
<span class="mi">19103</span>     <span class="p">{</span>
<span class="mi">19104</span>         <span class="n">Fault</span> <span class="n">fault</span> <span class="o">=</span> <span class="n">NoFault</span><span class="p">;</span>
<span class="mi">19105</span>         <span class="n">Addr</span> <span class="n">EA</span><span class="p">;</span>
<span class="mi">19106</span>
<span class="mi">19107</span>         <span class="kt">uint64_t</span> <span class="n">Index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="mi">19108</span> <span class="kt">uint64_t</span> <span class="n">Base</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="mi">19109</span> <span class="kt">uint64_t</span> <span class="n">Data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="mi">19110</span> <span class="kt">uint64_t</span> <span class="n">SegBase</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="mi">19111</span> <span class="kt">uint64_t</span> <span class="n">Mem</span><span class="p">;</span>
<span class="mi">19112</span> <span class="p">;</span>
<span class="mi">19113</span>         <span class="n">Index</span> <span class="o">=</span> <span class="n">xc</span><span class="o">-&gt;</span><span class="n">readIntRegOperand</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="mi">19114</span> <span class="n">Base</span> <span class="o">=</span> <span class="n">xc</span><span class="o">-&gt;</span><span class="n">readIntRegOperand</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="mi">19115</span> <span class="n">Data</span> <span class="o">=</span> <span class="n">xc</span><span class="o">-&gt;</span><span class="n">readIntRegOperand</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="mi">19116</span> <span class="n">SegBase</span> <span class="o">=</span> <span class="n">xc</span><span class="o">-&gt;</span><span class="n">readMiscRegOperand</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
<span class="mi">19117</span> <span class="p">;</span>
<span class="mi">19118</span>         <span class="n">EA</span> <span class="o">=</span> <span class="n">SegBase</span> <span class="o">+</span> <span class="n">bits</span><span class="p">(</span><span class="n">scale</span> <span class="o">*</span> <span class="n">Index</span> <span class="o">+</span> <span class="n">Base</span> <span class="o">+</span> <span class="n">disp</span><span class="p">,</span> <span class="n">addressSize</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);;</span>
<span class="mi">19119</span>         <span class="n">DPRINTF</span><span class="p">(</span><span class="n">X86</span><span class="p">,</span> <span class="s">"%s : %s: The address is %#x</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">instMnem</span><span class="p">,</span> <span class="n">mnemonic</span><span class="p">,</span> <span class="n">EA</span><span class="p">);</span>
<span class="mi">19120</span>
<span class="mi">19121</span>         <span class="n">fault</span> <span class="o">=</span> <span class="n">readMemAtomic</span><span class="p">(</span><span class="n">xc</span><span class="p">,</span> <span class="n">traceData</span><span class="p">,</span> <span class="n">EA</span><span class="p">,</span> <span class="n">Mem</span><span class="p">,</span> <span class="n">dataSize</span><span class="p">,</span> <span class="n">memFlags</span><span class="p">);</span>
<span class="mi">19122</span>
<span class="mi">19123</span>         <span class="k">if</span> <span class="p">(</span><span class="n">fault</span> <span class="o">==</span> <span class="n">NoFault</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">19124</span>             <span class="n">Data</span> <span class="o">=</span> <span class="n">merge</span><span class="p">(</span><span class="n">Data</span><span class="p">,</span> <span class="n">Mem</span><span class="p">,</span> <span class="n">dataSize</span><span class="p">);;</span>
<span class="mi">19125</span>         <span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">memFlags</span> <span class="o">&amp;</span> <span class="n">Request</span><span class="o">::</span><span class="n">PREFETCH</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">19126</span>             <span class="c1">// For prefetches, ignore any faults/exceptions.</span>
<span class="mi">19127</span>             <span class="k">return</span> <span class="n">NoFault</span><span class="p">;</span>
<span class="mi">19128</span>         <span class="p">}</span>
<span class="mi">19129</span>         <span class="k">if</span><span class="p">(</span><span class="n">fault</span> <span class="o">==</span> <span class="n">NoFault</span><span class="p">)</span>
<span class="mi">19130</span>         <span class="p">{</span>
<span class="mi">19131</span>
<span class="mi">19132</span>
<span class="mi">19133</span>         <span class="p">{</span>
<span class="mi">19134</span>             <span class="kt">uint64_t</span> <span class="n">final_val</span> <span class="o">=</span> <span class="n">Data</span><span class="p">;</span>
<span class="mi">19135</span>             <span class="n">xc</span><span class="o">-&gt;</span><span class="n">setIntRegOperand</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">final_val</span><span class="p">);</span>
<span class="mi">19136</span>
<span class="mi">19137</span>             <span class="k">if</span> <span class="p">(</span><span class="n">traceData</span><span class="p">)</span> <span class="p">{</span> <span class="n">traceData</span><span class="o">-&gt;</span><span class="n">setData</span><span class="p">(</span><span class="n">final_val</span><span class="p">);</span> <span class="p">}</span>
<span class="mi">19138</span>         <span class="p">};</span>
<span class="mi">19139</span>         <span class="p">}</span>
<span class="mi">19140</span>
<span class="mi">19141</span>         <span class="k">return</span> <span class="n">fault</span><span class="p">;</span>
<span class="mi">19142</span>     <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p><em>gem5/src/arch/x86/memhelpers.hh</em></p>
<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre><span class="mi">106</span> <span class="n">static</span> <span class="n">Fault</span>
<span class="mi">107</span> <span class="nf">readMemAtomic</span><span class="p">(</span><span class="n">ExecContext</span> <span class="o">*</span><span class="n">xc</span><span class="p">,</span> <span class="n">Trace</span><span class="p">::</span><span class="n">InstRecord</span> <span class="o">*</span><span class="n">traceData</span><span class="p">,</span> <span class="n">Addr</span> <span class="n">addr</span><span class="p">,</span>
<span class="mi">108</span>               <span class="n">uint64_t</span> <span class="o">&amp;</span><span class="n">mem</span><span class="p">,</span> <span class="n">unsigned</span> <span class="n">dataSize</span><span class="p">,</span> <span class="n">Request</span><span class="p">::</span><span class="n">Flags</span> <span class="n">flags</span><span class="p">)</span>
<span class="mi">109</span> <span class="p">{</span>
<span class="mi">110</span>     <span class="nf">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mem</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nf">sizeof</span><span class="p">(</span><span class="n">mem</span><span class="p">));</span>
<span class="mi">111</span>     <span class="n">Fault</span> <span class="n">fault</span> <span class="o">=</span> <span class="n">xc</span><span class="o">-&gt;</span><span class="nf">readMem</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="p">(</span><span class="n">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">mem</span><span class="p">,</span> <span class="n">dataSize</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="mi">112</span>     <span class="nf">if </span><span class="p">(</span><span class="n">fault</span> <span class="o">==</span> <span class="n">NoFault</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">113</span>         <span class="o">//</span> <span class="n">If</span> <span class="n">LE</span> <span class="n">to</span> <span class="n">LE</span><span class="p">,</span> <span class="n">this</span> <span class="ow">is</span> <span class="n">a</span> <span class="n">nop</span><span class="p">,</span> <span class="k">if</span> <span class="n">LE</span> <span class="n">to</span> <span class="n">BE</span><span class="p">,</span> <span class="n">the</span> <span class="n">actual</span> <span class="n">data</span> <span class="n">ends</span> <span class="n">up</span>
<span class="mi">114</span>         <span class="o">//</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">right</span> <span class="n">place</span> <span class="n">because</span> <span class="n">the</span> <span class="n">LSBs</span> <span class="n">where</span> <span class="n">at</span> <span class="n">the</span> <span class="n">low</span> <span class="n">addresses</span> <span class="n">on</span>
<span class="mi">115</span>         <span class="o">//</span> <span class="n">access</span><span class="p">.</span> <span class="n">This</span> <span class="n">doesn</span><span class="sh">'</span><span class="s">t work for BE guests.
116         mem = letoh(mem);
117         if (traceData)
118             traceData-&gt;setData(mem);
119     }
120     return fault;
121 }
</span></pre></td></tr></tbody></table></code></div></div>

<p><em>gem5/src/cpu/exec_context.hh</em></p>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
</pre></td><td class="rouge-code"><pre> <span class="mi">57</span> <span class="cm">/**
 58  * The ExecContext is an abstract base class the provides the
 59  * interface used by the ISA to manipulate the state of the CPU model.
 60  *
 61  * Register accessor methods in this class typically provide the index
 62  * of the instruction's operand (e.g., 0 or 1), not the architectural
 63  * register index, to simplify the implementation of register
 64  * renaming.  The architectural register index can be found by
 65  * indexing into the instruction's own operand index table.
 66  *
 67  * @note The methods in this class typically take a raw pointer to the
 68  * StaticInst is provided instead of a ref-counted StaticInstPtr to
 69  * reduce overhead as an argument. This is fine as long as the
 70  * implementation doesn't copy the pointer into any long-term storage
 71  * (which is pretty hard to imagine they would have reason to do).
 72  */</span>
 <span class="mi">73</span> <span class="k">class</span> <span class="nc">ExecContext</span> <span class="p">{</span>
 <span class="mi">74</span>   <span class="k">public</span><span class="o">:</span>
 <span class="mi">75</span>     <span class="k">typedef</span> <span class="n">TheISA</span><span class="o">::</span><span class="n">PCState</span> <span class="n">PCState</span><span class="p">;</span>
 <span class="mi">76</span>
 <span class="mi">77</span>     <span class="k">using</span> <span class="n">VecRegContainer</span> <span class="o">=</span> <span class="n">TheISA</span><span class="o">::</span><span class="n">VecRegContainer</span><span class="p">;</span>
 <span class="mi">78</span>     <span class="k">using</span> <span class="n">VecElem</span> <span class="o">=</span> <span class="n">TheISA</span><span class="o">::</span><span class="n">VecElem</span><span class="p">;</span>
 <span class="mi">79</span>     <span class="k">using</span> <span class="n">VecPredRegContainer</span> <span class="o">=</span> <span class="n">TheISA</span><span class="o">::</span><span class="n">VecPredRegContainer</span><span class="p">;</span>
 <span class="p">...</span>
 <span class="mi">226</span>     <span class="cm">/**
 227      * @{
 228      * @name Memory Interface
 229      */</span>
 <span class="mi">230</span>     <span class="cm">/**
 231      * Perform an atomic memory read operation.  Must be overridden
 232      * for exec contexts that support atomic memory mode.  Not pure
 233      * virtual since exec contexts that only support timing memory
 234      * mode need not override (though in that case this function
 235      * should never be called).
 236      */</span>
 <span class="mi">237</span>     <span class="k">virtual</span> <span class="n">Fault</span> <span class="n">readMem</span><span class="p">(</span><span class="n">Addr</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span>
 <span class="mi">238</span>             <span class="n">Request</span><span class="o">::</span><span class="n">Flags</span> <span class="n">flags</span><span class="p">,</span>
 <span class="mi">239</span>             <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;&amp;</span> <span class="n">byte_enable</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span><span class="p">())</span>
 <span class="mi">240</span>     <span class="p">{</span>
 <span class="mi">241</span>         <span class="n">panic</span><span class="p">(</span><span class="s">"ExecContext::readMem() should be overridden</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
 <span class="mi">242</span>     <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>
<p>As mentioned in the comment,
<em>ExecContext</em> class is an abstract base class
used to manipulate state of the CPU model. 
Therefore, each CPU model provides concrete interface 
that can actually updates CPU context.
As an example, let’s take a loot at simple cpu model.</p>

<p><em>gem5/src/cpu/simple/exec_context.hh</em></p>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
</pre></td><td class="rouge-code"><pre> <span class="mi">61</span> <span class="k">class</span> <span class="nc">SimpleExecContext</span> <span class="o">:</span> <span class="k">public</span> <span class="n">ExecContext</span> <span class="p">{</span>
 <span class="mi">62</span>   <span class="k">protected</span><span class="o">:</span>
 <span class="mi">63</span>     <span class="k">using</span> <span class="n">VecRegContainer</span> <span class="o">=</span> <span class="n">TheISA</span><span class="o">::</span><span class="n">VecRegContainer</span><span class="p">;</span>
 <span class="mi">64</span>     <span class="k">using</span> <span class="n">VecElem</span> <span class="o">=</span> <span class="n">TheISA</span><span class="o">::</span><span class="n">VecElem</span><span class="p">;</span>
 <span class="mi">65</span>
 <span class="mi">66</span>   <span class="k">public</span><span class="o">:</span>
 <span class="mi">67</span>     <span class="n">BaseSimpleCPU</span> <span class="o">*</span><span class="n">cpu</span><span class="p">;</span>
 <span class="mi">68</span>     <span class="n">SimpleThread</span><span class="o">*</span> <span class="kr">thread</span><span class="p">;</span>
 <span class="mi">69</span>
 <span class="mi">70</span>     <span class="c1">// This is the offset from the current pc that fetch should be performed</span>
 <span class="mi">71</span>     <span class="n">Addr</span> <span class="n">fetchOffset</span><span class="p">;</span>
 <span class="mi">72</span>     <span class="c1">// This flag says to stay at the current pc. This is useful for</span>
 <span class="mi">73</span>     <span class="c1">// instructions which go beyond MachInst boundaries.</span>
 <span class="mi">74</span>     <span class="kt">bool</span> <span class="n">stayAtPC</span><span class="p">;</span>
 <span class="mi">75</span>
 <span class="mi">76</span>     <span class="c1">// Branch prediction</span>
 <span class="mi">77</span>     <span class="n">TheISA</span><span class="o">::</span><span class="n">PCState</span> <span class="n">predPC</span><span class="p">;</span>
 <span class="mi">78</span>
 <span class="mi">79</span>     <span class="cm">/** PER-THREAD STATS */</span>
 <span class="mi">80</span>
 <span class="mi">81</span>     <span class="c1">// Number of simulated instructions</span>
 <span class="mi">82</span>     <span class="n">Counter</span> <span class="n">numInst</span><span class="p">;</span>
 <span class="mi">83</span>     <span class="n">Stats</span><span class="o">::</span><span class="n">Scalar</span> <span class="n">numInsts</span><span class="p">;</span>
 <span class="mi">84</span>     <span class="n">Counter</span> <span class="n">numOp</span><span class="p">;</span>
 <span class="mi">85</span>     <span class="n">Stats</span><span class="o">::</span><span class="n">Scalar</span> <span class="n">numOps</span><span class="p">;</span>
 <span class="mi">86</span>
 <span class="mi">87</span>     <span class="c1">// Number of integer alu accesses</span>
 <span class="mi">88</span>     <span class="n">Stats</span><span class="o">::</span><span class="n">Scalar</span> <span class="n">numIntAluAccesses</span><span class="p">;</span>
<span class="p">...</span>
<span class="mi">437</span>     <span class="n">Fault</span>
<span class="mi">438</span>     <span class="n">readMem</span><span class="p">(</span><span class="n">Addr</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span>
<span class="mi">439</span>             <span class="n">Request</span><span class="o">::</span><span class="n">Flags</span> <span class="n">flags</span><span class="p">,</span>
<span class="mi">440</span>             <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;&amp;</span> <span class="n">byte_enable</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span><span class="p">())</span>
<span class="mi">441</span>         <span class="k">override</span>
<span class="mi">442</span>     <span class="p">{</span>
<span class="mi">443</span>         <span class="n">assert</span><span class="p">(</span><span class="n">byte_enable</span><span class="p">.</span><span class="n">empty</span><span class="p">()</span> <span class="o">||</span> <span class="n">byte_enable</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">==</span> <span class="n">size</span><span class="p">);</span>
<span class="mi">444</span>         <span class="k">return</span> <span class="n">cpu</span><span class="o">-&gt;</span><span class="n">readMem</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">byte_enable</span><span class="p">);</span>
<span class="mi">445</span>     <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>
<p>As shown in the line 437-445,
readMem method is overridden by <em>SimpleExecContext</em> class
inherited from ExecContext abstract class.
Because ExecContext is an interface class,
actual memory read operation is done by the corresponding CPU class.
For timing CPU, 
it doesn’t make use of execute,
but other autogenerated method to executed ld microop.</p>

<h3 id="initiateacc-send-memory-reference"><span class="me-2">InitiateAcc: send memory reference</span><a href="#initiateacc-send-memory-reference" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td class="rouge-code"><pre>
<span class="mi">119</span> <span class="k">def</span> <span class="nf">template</span> <span class="n">MicroLoadInitiateAcc</span> <span class="p">{{</span>
<span class="mi">120</span>     <span class="n">Fault</span> <span class="o">%</span><span class="p">(</span><span class="n">class_name</span><span class="p">)</span><span class="n">s</span><span class="p">::</span><span class="nf">initiateAcc</span><span class="p">(</span><span class="n">ExecContext</span> <span class="o">*</span> <span class="n">xc</span><span class="p">,</span>
<span class="mi">121</span>             <span class="n">Trace</span><span class="p">::</span><span class="n">InstRecord</span> <span class="o">*</span> <span class="n">traceData</span><span class="p">)</span> <span class="n">const</span>

<span class="mi">122</span>     <span class="p">{</span>
<span class="mi">123</span>         <span class="n">Fault</span> <span class="n">fault</span> <span class="o">=</span> <span class="n">NoFault</span><span class="p">;</span>
<span class="mi">124</span>         <span class="n">Addr</span> <span class="n">EA</span><span class="p">;</span>
<span class="mi">125</span>
<span class="mi">126</span>         <span class="o">%</span><span class="p">(</span><span class="n">op_decl</span><span class="p">)</span><span class="n">s</span><span class="p">;</span>
<span class="mi">127</span>         <span class="o">%</span><span class="p">(</span><span class="n">op_rd</span><span class="p">)</span><span class="n">s</span><span class="p">;</span>
<span class="mi">128</span>         <span class="o">%</span><span class="p">(</span><span class="n">ea_code</span><span class="p">)</span><span class="n">s</span><span class="p">;</span>
<span class="mi">129</span>         <span class="nc">DPRINTF</span><span class="p">(</span><span class="n">X86</span><span class="p">,</span> <span class="sh">"</span><span class="s">%s : %s: The address is %#x</span><span class="se">\n</span><span class="sh">"</span><span class="p">,</span> <span class="n">instMnem</span><span class="p">,</span> <span class="n">mnemonic</span><span class="p">,</span> <span class="n">EA</span><span class="p">);</span>
<span class="mi">130</span>
<span class="mi">131</span>         <span class="n">fault</span> <span class="o">=</span> <span class="nf">initiateMemRead</span><span class="p">(</span><span class="n">xc</span><span class="p">,</span> <span class="n">traceData</span><span class="p">,</span> <span class="n">EA</span><span class="p">,</span>
<span class="mi">132</span>                                 <span class="o">%</span><span class="p">(</span><span class="n">memDataSize</span><span class="p">)</span><span class="n">s</span><span class="p">,</span> <span class="n">memFlags</span><span class="p">);</span>
<span class="mi">133</span>
<span class="mi">134</span>         <span class="k">return</span> <span class="n">fault</span><span class="p">;</span>
<span class="mi">135</span>     <span class="p">}</span>
<span class="mi">136</span> <span class="p">}};</span>
<span class="mi">137</span>
</pre></td></tr></tbody></table></code></div></div>

<p>All the template code is required to generate load address.
And the generated address is used by initiateMemRead method
to actually access the memory. 
Note that this method receive ExecContext which is a interface to CPU module
and the generated logical address EA.
Also, memory flags such as prefetch are delivered to the memory module.
Remember that <em>memFlags</em> are passed to the class 
when the microop is constructed.</p>

<p><em>gem5/build/X86/arch/x86/generated/exec-ns.cc.inc</em></p>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td><td class="rouge-code"><pre><span class="mi">19144</span>     <span class="n">Fault</span> <span class="n">Ld</span><span class="o">::</span><span class="n">initiateAcc</span><span class="p">(</span><span class="n">ExecContext</span> <span class="o">*</span> <span class="n">xc</span><span class="p">,</span>
<span class="mi">19145</span>             <span class="n">Trace</span><span class="o">::</span><span class="n">InstRecord</span> <span class="o">*</span> <span class="n">traceData</span><span class="p">)</span> <span class="k">const</span>
<span class="mi">19146</span>     <span class="p">{</span>
<span class="mi">19147</span>         <span class="n">Fault</span> <span class="n">fault</span> <span class="o">=</span> <span class="n">NoFault</span><span class="p">;</span>
<span class="mi">19148</span>         <span class="n">Addr</span> <span class="n">EA</span><span class="p">;</span>
<span class="mi">19149</span>
<span class="mi">19150</span>         <span class="kt">uint64_t</span> <span class="n">Index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="mi">19151</span> <span class="kt">uint64_t</span> <span class="n">Base</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="mi">19152</span> <span class="kt">uint64_t</span> <span class="n">SegBase</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="mi">19153</span> <span class="p">;</span>
<span class="mi">19154</span>         <span class="n">Index</span> <span class="o">=</span> <span class="n">xc</span><span class="o">-&gt;</span><span class="n">readIntRegOperand</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="mi">19155</span> <span class="n">Base</span> <span class="o">=</span> <span class="n">xc</span><span class="o">-&gt;</span><span class="n">readIntRegOperand</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="mi">19156</span> <span class="n">SegBase</span> <span class="o">=</span> <span class="n">xc</span><span class="o">-&gt;</span><span class="n">readMiscRegOperand</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
<span class="mi">19157</span> <span class="p">;</span>
<span class="mi">19158</span>         <span class="n">EA</span> <span class="o">=</span> <span class="n">SegBase</span> <span class="o">+</span> <span class="n">bits</span><span class="p">(</span><span class="n">scale</span> <span class="o">*</span> <span class="n">Index</span> <span class="o">+</span> <span class="n">Base</span> <span class="o">+</span> <span class="n">disp</span><span class="p">,</span> <span class="n">addressSize</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);;</span>
<span class="mi">19159</span>         <span class="n">DPRINTF</span><span class="p">(</span><span class="n">X86</span><span class="p">,</span> <span class="s">"%s : %s: The address is %#x</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">instMnem</span><span class="p">,</span> <span class="n">mnemonic</span><span class="p">,</span> <span class="n">EA</span><span class="p">);</span>
<span class="mi">19160</span>
<span class="mi">19161</span>         <span class="n">fault</span> <span class="o">=</span> <span class="n">initiateMemRead</span><span class="p">(</span><span class="n">xc</span><span class="p">,</span> <span class="n">traceData</span><span class="p">,</span> <span class="n">EA</span><span class="p">,</span>
<span class="mi">19162</span>                                 <span class="n">dataSize</span><span class="p">,</span> <span class="n">memFlags</span><span class="p">);</span>
<span class="mi">19163</span>
<span class="mi">19164</span>         <span class="k">return</span> <span class="n">fault</span><span class="p">;</span>
<span class="mi">19165</span>     <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>For memory operation, <em>initiateAcc</em> is the most important function
that actually initiate memory access. 
initiateAcc invokes initiateMemRead function, and
each CPU class overrides initiateMemRead method.
Before we take a look at the detail implementation,
we have to understand that 
all the CPU specific functions are invoked 
through the interface ExecContext class.</p>

<p><em>gem5/src/arch/x86/memhelpers.hh</em></p>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre> <span class="mi">45</span> <span class="c1">/// Initiate a read from memory in timing mode.</span>
 <span class="mi">46</span> <span class="k">static</span> <span class="n">Fault</span>
 <span class="mi">47</span> <span class="nf">initiateMemRead</span><span class="p">(</span><span class="n">ExecContext</span> <span class="o">*</span><span class="n">xc</span><span class="p">,</span> <span class="n">Trace</span><span class="o">::</span><span class="n">InstRecord</span> <span class="o">*</span><span class="n">traceData</span><span class="p">,</span> <span class="n">Addr</span> <span class="n">addr</span><span class="p">,</span>
 <span class="mi">48</span>                 <span class="kt">unsigned</span> <span class="n">dataSize</span><span class="p">,</span> <span class="n">Request</span><span class="o">::</span><span class="n">Flags</span> <span class="n">flags</span><span class="p">)</span>
 <span class="mi">49</span> <span class="p">{</span>
 <span class="mi">50</span>     <span class="k">return</span> <span class="n">xc</span><span class="o">-&gt;</span><span class="n">initiateMemRead</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">dataSize</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
 <span class="mi">51</span> <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>initiateMemRead helper function defined in x86 arch directory
invokes actual initiateMemRead function
through the <em>ExecContext</em> interface.</p>

<p><em>gem5/src/cpu/simple/exec_context.hh</em></p>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="mi">447</span>     <span class="n">Fault</span>
<span class="mi">448</span>     <span class="nf">initiateMemRead</span><span class="p">(</span><span class="n">Addr</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span>
<span class="mi">449</span>                     <span class="n">Request</span><span class="o">::</span><span class="n">Flags</span> <span class="n">flags</span><span class="p">,</span>
<span class="mi">450</span>                     <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;&amp;</span> <span class="n">byte_enable</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span><span class="p">())</span>
<span class="mi">451</span>         <span class="k">override</span>
<span class="mi">452</span>     <span class="p">{</span>
<span class="mi">453</span>         <span class="n">assert</span><span class="p">(</span><span class="n">byte_enable</span><span class="p">.</span><span class="n">empty</span><span class="p">()</span> <span class="o">||</span> <span class="n">byte_enable</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">==</span> <span class="n">size</span><span class="p">);</span>
<span class="mi">454</span>         <span class="k">return</span> <span class="n">cpu</span><span class="o">-&gt;</span><span class="n">initiateMemRead</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">byte_enable</span><span class="p">);</span>
<span class="mi">455</span>     <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>
<p>Because we have interest in timing cpu model,
let’s figure how the timing cpu model implements initiateMemRead.</p>

<p><em>gem5/src/cpu/simple/timing.cc</em></p>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
</pre></td><td class="rouge-code"><pre> <span class="mi">418</span> <span class="n">Fault</span>
 <span class="mi">419</span> <span class="n">TimingSimpleCPU</span><span class="o">::</span><span class="n">initiateMemRead</span><span class="p">(</span><span class="n">Addr</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">size</span><span class="p">,</span>
 <span class="mi">420</span>                                  <span class="n">Request</span><span class="o">::</span><span class="n">Flags</span> <span class="n">flags</span><span class="p">,</span>
 <span class="mi">421</span>                                  <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;&amp;</span> <span class="n">byte_enable</span><span class="p">)</span>
 <span class="mi">422</span> <span class="p">{</span>
 <span class="mi">423</span>     <span class="n">SimpleExecContext</span> <span class="o">&amp;</span><span class="n">t_info</span> <span class="o">=</span> <span class="o">*</span><span class="n">threadInfo</span><span class="p">[</span><span class="n">curThread</span><span class="p">];</span>
 <span class="mi">424</span>     <span class="n">SimpleThread</span><span class="o">*</span> <span class="kr">thread</span> <span class="o">=</span> <span class="n">t_info</span><span class="p">.</span><span class="kr">thread</span><span class="p">;</span>
 <span class="mi">425</span>
 <span class="mi">426</span>     <span class="n">Fault</span> <span class="n">fault</span><span class="p">;</span>
 <span class="mi">427</span>     <span class="k">const</span> <span class="kt">int</span> <span class="n">asid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
 <span class="mi">428</span>     <span class="k">const</span> <span class="n">Addr</span> <span class="n">pc</span> <span class="o">=</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">instAddr</span><span class="p">();</span>
 <span class="mi">429</span>     <span class="kt">unsigned</span> <span class="n">block_size</span> <span class="o">=</span> <span class="n">cacheLineSize</span><span class="p">();</span>
 <span class="mi">430</span>     <span class="n">BaseTLB</span><span class="o">::</span><span class="n">Mode</span> <span class="n">mode</span> <span class="o">=</span> <span class="n">BaseTLB</span><span class="o">::</span><span class="n">Read</span><span class="p">;</span>
 <span class="mi">431</span>
 <span class="mi">432</span>     <span class="k">if</span> <span class="p">(</span><span class="n">traceData</span><span class="p">)</span>
 <span class="mi">433</span>         <span class="n">traceData</span><span class="o">-&gt;</span><span class="n">setMem</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
 <span class="mi">434</span>
 <span class="mi">435</span>     <span class="n">RequestPtr</span> <span class="n">req</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">Request</span><span class="o">&gt;</span><span class="p">(</span>
 <span class="mi">436</span>         <span class="n">asid</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">dataMasterId</span><span class="p">(),</span> <span class="n">pc</span><span class="p">,</span>
 <span class="mi">437</span>         <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">contextId</span><span class="p">());</span>
 <span class="mi">438</span>     <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">byte_enable</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
 <span class="mi">439</span>         <span class="n">req</span><span class="o">-&gt;</span><span class="n">setByteEnable</span><span class="p">(</span><span class="n">byte_enable</span><span class="p">);</span>
 <span class="mi">440</span>     <span class="p">}</span>
 <span class="mi">441</span>
 <span class="mi">442</span>     <span class="n">req</span><span class="o">-&gt;</span><span class="n">taskId</span><span class="p">(</span><span class="n">taskId</span><span class="p">());</span>
 <span class="mi">443</span>
 <span class="mi">444</span>     <span class="n">Addr</span> <span class="n">split_addr</span> <span class="o">=</span> <span class="n">roundDown</span><span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">block_size</span><span class="p">);</span>
 <span class="mi">445</span>     <span class="nf">assert</span><span class="p">(</span><span class="n">split_addr</span> <span class="o">&lt;=</span> <span class="n">addr</span> <span class="o">||</span> <span class="n">split_addr</span> <span class="o">-</span> <span class="n">addr</span> <span class="o">&lt;</span> <span class="n">block_size</span><span class="p">);</span>
 <span class="mi">446</span>
 <span class="mi">447</span>     <span class="n">_status</span> <span class="o">=</span> <span class="n">DTBWaitResponse</span><span class="p">;</span>
 <span class="mi">448</span>     <span class="nf">if</span> <span class="p">(</span><span class="n">split_addr</span> <span class="o">&gt;</span> <span class="n">addr</span><span class="p">)</span> <span class="p">{</span>
 <span class="mi">449</span>         <span class="n">RequestPtr</span> <span class="n">req1</span><span class="p">,</span> <span class="n">req2</span><span class="p">;</span>
 <span class="mi">450</span>         <span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">isLLSC</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">isSwap</span><span class="p">());</span>
 <span class="mi">451</span>         <span class="n">req</span><span class="o">-&gt;</span><span class="n">splitOnVaddr</span><span class="p">(</span><span class="n">split_addr</span><span class="p">,</span> <span class="n">req1</span><span class="p">,</span> <span class="n">req2</span><span class="p">);</span>
 <span class="mi">452</span>
 <span class="mi">453</span>         <span class="n">WholeTranslationState</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span>
 <span class="mi">454</span>             <span class="k">new</span> <span class="n">WholeTranslationState</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">req1</span><span class="p">,</span> <span class="n">req2</span><span class="p">,</span> <span class="k">new</span> <span class="kt">uint8_t</span><span class="p">[</span><span class="n">size</span><span class="p">],</span>
 <span class="mi">455</span>                                       <span class="nb">NULL</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
 <span class="mi">456</span>         <span class="n">DataTranslation</span><span class="o">&lt;</span><span class="n">TimingSimpleCPU</span> <span class="o">*&gt;</span> <span class="o">*</span><span class="n">trans1</span> <span class="o">=</span>
 <span class="mi">457</span>             <span class="k">new</span> <span class="n">DataTranslation</span><span class="o">&lt;</span><span class="n">TimingSimpleCPU</span> <span class="o">*&gt;</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
 <span class="mi">458</span>         <span class="n">DataTranslation</span><span class="o">&lt;</span><span class="n">TimingSimpleCPU</span> <span class="o">*&gt;</span> <span class="o">*</span><span class="n">trans2</span> <span class="o">=</span>
 <span class="mi">459</span>             <span class="k">new</span> <span class="n">DataTranslation</span><span class="o">&lt;</span><span class="n">TimingSimpleCPU</span> <span class="o">*&gt;</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
 <span class="mi">460</span>
 <span class="mi">461</span>         <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">dtb</span><span class="o">-&gt;</span><span class="n">translateTiming</span><span class="p">(</span><span class="n">req1</span><span class="p">,</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">getTC</span><span class="p">(),</span> <span class="n">trans1</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
 <span class="mi">462</span>         <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">dtb</span><span class="o">-&gt;</span><span class="n">translateTiming</span><span class="p">(</span><span class="n">req2</span><span class="p">,</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">getTC</span><span class="p">(),</span> <span class="n">trans2</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
 <span class="mi">463</span>     <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
 <span class="mi">464</span>         <span class="n">WholeTranslationState</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span>
 <span class="mi">465</span>             <span class="k">new</span> <span class="n">WholeTranslationState</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="k">new</span> <span class="kt">uint8_t</span><span class="p">[</span><span class="n">size</span><span class="p">],</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
 <span class="mi">466</span>         <span class="n">DataTranslation</span><span class="o">&lt;</span><span class="n">TimingSimpleCPU</span> <span class="o">*&gt;</span> <span class="o">*</span><span class="n">translation</span>
 <span class="mi">467</span>             <span class="o">=</span> <span class="k">new</span> <span class="n">DataTranslation</span><span class="o">&lt;</span><span class="n">TimingSimpleCPU</span> <span class="o">*&gt;</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
 <span class="mi">468</span>         <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">dtb</span><span class="o">-&gt;</span><span class="n">translateTiming</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">getTC</span><span class="p">(),</span> <span class="n">translation</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
 <span class="mi">469</span>     <span class="p">}</span>
 <span class="mi">470</span>
 <span class="mi">471</span>     <span class="k">return</span> <span class="n">NoFault</span><span class="p">;</span>
 <span class="mi">472</span> <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>
<p>This function first handles split memory access 
that needs two memory access requests.
When the memory address is not aligned, and 
the access crosses the memory block boundary,
then it should be handled with two separate memory requests.
Otherwise, it invokes <em>translateTiming</em> function defined in data tlb object(dtb).
Note that initiateMemRead doesn’t actually bring the data from the memory to cache.
It first check the tlb for virtual to physical mapping, and 
if the mapping doesn’t exist,
it initiate translation request to TLB</p>

<h3 id="completeacc-execute-memory-instruction-and-bring-the-data"><span class="me-2">completeAcc: execute memory instruction and bring the data</span><a href="#completeacc-execute-memory-instruction-and-bring-the-data" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td><td class="rouge-code"><pre>
<span class="mi">138</span> <span class="k">def</span> <span class="nf">template</span> <span class="n">MicroLoadCompleteAcc</span> <span class="p">{{</span>
<span class="mi">139</span>     <span class="n">Fault</span> <span class="o">%</span><span class="p">(</span><span class="n">class_name</span><span class="p">)</span><span class="n">s</span><span class="p">::</span><span class="nf">completeAcc</span><span class="p">(</span><span class="n">PacketPtr</span> <span class="n">pkt</span><span class="p">,</span> <span class="n">ExecContext</span> <span class="o">*</span> <span class="n">xc</span><span class="p">,</span>
<span class="mi">140</span>                                       <span class="n">Trace</span><span class="p">::</span><span class="n">InstRecord</span> <span class="o">*</span> <span class="n">traceData</span><span class="p">)</span> <span class="n">const</span>

<span class="mi">141</span>     <span class="p">{</span>
<span class="mi">142</span>         <span class="n">Fault</span> <span class="n">fault</span> <span class="o">=</span> <span class="n">NoFault</span><span class="p">;</span>
<span class="mi">143</span>
<span class="mi">144</span>         <span class="o">%</span><span class="p">(</span><span class="n">op_decl</span><span class="p">)</span><span class="n">s</span><span class="p">;</span>
<span class="mi">145</span>         <span class="o">%</span><span class="p">(</span><span class="n">op_rd</span><span class="p">)</span><span class="n">s</span><span class="p">;</span>
<span class="mi">146</span>
<span class="mi">147</span>         <span class="nf">getMem</span><span class="p">(</span><span class="n">pkt</span><span class="p">,</span> <span class="n">Mem</span><span class="p">,</span> <span class="n">dataSize</span><span class="p">,</span> <span class="n">traceData</span><span class="p">);</span>
<span class="mi">148</span>
<span class="mi">149</span>         <span class="o">%</span><span class="p">(</span><span class="n">code</span><span class="p">)</span><span class="n">s</span><span class="p">;</span>
<span class="mi">150</span>
<span class="mi">151</span>         <span class="nf">if</span><span class="p">(</span><span class="n">fault</span> <span class="o">==</span> <span class="n">NoFault</span><span class="p">)</span>
<span class="mi">152</span>         <span class="p">{</span>
<span class="mi">153</span>             <span class="o">%</span><span class="p">(</span><span class="n">op_wb</span><span class="p">)</span><span class="n">s</span><span class="p">;</span>
<span class="mi">154</span>         <span class="p">}</span>
<span class="mi">155</span>
<span class="mi">156</span>         <span class="k">return</span> <span class="n">fault</span><span class="p">;</span>
<span class="mi">157</span>     <span class="p">}</span>
<span class="mi">158</span> <span class="p">}};</span>
</pre></td></tr></tbody></table></code></div></div>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre></td><td class="rouge-code"><pre><span class="mi">19167</span>     <span class="n">Fault</span> <span class="n">Ld</span><span class="o">::</span><span class="n">completeAcc</span><span class="p">(</span><span class="n">PacketPtr</span> <span class="n">pkt</span><span class="p">,</span> <span class="n">ExecContext</span> <span class="o">*</span> <span class="n">xc</span><span class="p">,</span>
<span class="mi">19168</span>                                       <span class="n">Trace</span><span class="o">::</span><span class="n">InstRecord</span> <span class="o">*</span> <span class="n">traceData</span><span class="p">)</span> <span class="k">const</span>
<span class="mi">19169</span>     <span class="p">{</span>
<span class="mi">19170</span>         <span class="n">Fault</span> <span class="n">fault</span> <span class="o">=</span> <span class="n">NoFault</span><span class="p">;</span>
<span class="mi">19171</span>
<span class="mi">19172</span>         <span class="kt">uint64_t</span> <span class="n">Data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="mi">19173</span> <span class="kt">uint64_t</span> <span class="n">Mem</span><span class="p">;</span>
<span class="mi">19174</span> <span class="p">;</span>
<span class="mi">19175</span>         <span class="n">Data</span> <span class="o">=</span> <span class="n">xc</span><span class="o">-&gt;</span><span class="n">readIntRegOperand</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="mi">19176</span> <span class="p">;</span>
<span class="mi">19177</span>
<span class="mi">19178</span>         <span class="n">getMem</span><span class="p">(</span><span class="n">pkt</span><span class="p">,</span> <span class="n">Mem</span><span class="p">,</span> <span class="n">dataSize</span><span class="p">,</span> <span class="n">traceData</span><span class="p">);</span>
<span class="mi">19179</span>
<span class="mi">19180</span>         <span class="n">Data</span> <span class="o">=</span> <span class="n">merge</span><span class="p">(</span><span class="n">Data</span><span class="p">,</span> <span class="n">Mem</span><span class="p">,</span> <span class="n">dataSize</span><span class="p">);;</span>
<span class="mi">19181</span>
<span class="mi">19182</span>         <span class="k">if</span><span class="p">(</span><span class="n">fault</span> <span class="o">==</span> <span class="n">NoFault</span><span class="p">)</span>
<span class="mi">19183</span>         <span class="p">{</span>
<span class="mi">19184</span>
<span class="mi">19185</span>
<span class="mi">19186</span>         <span class="p">{</span>
<span class="mi">19187</span>             <span class="kt">uint64_t</span> <span class="n">final_val</span> <span class="o">=</span> <span class="n">Data</span><span class="p">;</span>
<span class="mi">19188</span>             <span class="n">xc</span><span class="o">-&gt;</span><span class="n">setIntRegOperand</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">final_val</span><span class="p">);</span>
<span class="mi">19189</span>
<span class="mi">19190</span>             <span class="k">if</span> <span class="p">(</span><span class="n">traceData</span><span class="p">)</span> <span class="p">{</span> <span class="n">traceData</span><span class="o">-&gt;</span><span class="n">setData</span><span class="p">(</span><span class="n">final_val</span><span class="p">);</span> <span class="p">}</span>
<span class="mi">19191</span>         <span class="p">};</span>
<span class="mi">19192</span>         <span class="p">}</span>
<span class="mi">19193</span>
<span class="mi">19194</span>         <span class="k">return</span> <span class="n">fault</span><span class="p">;</span>
<span class="mi">19195</span>     <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>
<p>completeAcc function receives the pkt as its parameter.
pkt contains the actual data read from the memory,
so getMem function reads the proper amount of the data 
from the pkt data structure.
Because memory operation reads 64bytes of data at once 
it should be properly feed to the pipeline depending on the data read size.</p>

<p>###execute</p>

<p>###preExecute: decode instruction and predict branch</p>

<h3 id="instruction-execution-execute-decoded-microop-instruction"><span class="me-2">Instruction execution: execute decoded microop instruction</span><a href="#instruction-execution-execute-decoded-microop-instruction" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>For memory operation (line 798-819),
it invokes <em>initiateAcc</em> method of current microop 
represented by the curStaticInst (line 800).
As we have seen before,
for each load/store microop, it defines initiateAcc function,
for example, for Ld, it defines Ld::initiateAcc.</p>

<p>Otherwise, for non-memory instruction,
it invokes <em>execute</em> method of microop 
instead of initiateAcc.</p>

<p>###postExecute: manage statistics related with execution</p>

<p>###adnvanceInst: start to fetch next instruction</p>

<p>After finishing translation,
and when the fault has not been deteced by the finish function,
it starts to read the actual data from the memory.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre></td><td class="rouge-code"><pre> <span class="mi">627</span> <span class="kt">void</span>
 <span class="mi">628</span> <span class="n">TimingSimpleCPU</span><span class="o">::</span><span class="n">finishTranslation</span><span class="p">(</span><span class="n">WholeTranslationState</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
 <span class="mi">629</span> <span class="p">{</span>
 <span class="mi">630</span>     <span class="n">_status</span> <span class="o">=</span> <span class="n">BaseSimpleCPU</span><span class="o">::</span><span class="n">Running</span><span class="p">;</span>
 <span class="mi">631</span>
 <span class="mi">632</span>     <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">getFault</span><span class="p">()</span> <span class="o">!=</span> <span class="n">NoFault</span><span class="p">)</span> <span class="p">{</span>
 <span class="mi">633</span>         <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">isPrefetch</span><span class="p">())</span> <span class="p">{</span>
 <span class="mi">634</span>             <span class="n">state</span><span class="o">-&gt;</span><span class="n">setNoFault</span><span class="p">();</span>
 <span class="mi">635</span>         <span class="p">}</span>
 <span class="mi">636</span>         <span class="k">delete</span> <span class="p">[]</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
 <span class="mi">637</span>         <span class="n">state</span><span class="o">-&gt;</span><span class="n">deleteReqs</span><span class="p">();</span>
 <span class="mi">638</span>         <span class="nf">translationFault</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">getFault</span><span class="p">());</span>
 <span class="mi">639</span>     <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
 <span class="mi">640</span>         <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">isSplit</span><span class="p">)</span> <span class="p">{</span>
 <span class="mi">641</span>             <span class="n">sendData</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">mainReq</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">,</span>
 <span class="mi">642</span>                      <span class="n">state</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">BaseTLB</span><span class="o">::</span><span class="n">Read</span><span class="p">);</span>
 <span class="mi">643</span>         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
 <span class="mi">644</span>             <span class="n">sendSplitData</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">sreqLow</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">sreqHigh</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">mainReq</span><span class="p">,</span>
 <span class="mi">645</span>                           <span class="n">state</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">BaseTLB</span><span class="o">::</span><span class="n">Read</span><span class="p">);</span>
 <span class="mi">646</span>         <span class="p">}</span>
 <span class="mi">647</span>     <span class="p">}</span>
 <span class="mi">648</span>
 <span class="mi">649</span>     <span class="k">delete</span> <span class="n">state</span><span class="p">;</span>
 <span class="mi">650</span> <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>
<p>As shown in line 639-649, 
when the fault has not been raised during translation,
then it sends memory access packet 
to DRAM through sendData function.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre></td><td class="rouge-code"><pre> <span class="mi">287</span> <span class="kt">void</span>
 <span class="mi">288</span> <span class="n">TimingSimpleCPU</span><span class="o">::</span><span class="n">sendData</span><span class="p">(</span><span class="k">const</span> <span class="n">RequestPtr</span> <span class="o">&amp;</span><span class="n">req</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="o">*</span><span class="n">res</span><span class="p">,</span>
 <span class="mi">289</span>                           <span class="kt">bool</span> <span class="n">read</span><span class="p">)</span>
 <span class="mi">290</span> <span class="p">{</span>
 <span class="mi">291</span>     <span class="n">SimpleExecContext</span> <span class="o">&amp;</span><span class="n">t_info</span> <span class="o">=</span> <span class="o">*</span><span class="n">threadInfo</span><span class="p">[</span><span class="n">curThread</span><span class="p">];</span>
 <span class="mi">292</span>     <span class="n">SimpleThread</span><span class="o">*</span> <span class="kr">thread</span> <span class="o">=</span> <span class="n">t_info</span><span class="p">.</span><span class="kr">thread</span><span class="p">;</span>
 <span class="mi">293</span>
 <span class="mi">294</span>     <span class="n">PacketPtr</span> <span class="n">pkt</span> <span class="o">=</span> <span class="n">buildPacket</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">read</span><span class="p">);</span>
 <span class="mi">295</span>     <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">dataDynamic</span><span class="o">&lt;</span><span class="kt">uint8_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
 <span class="mi">296</span>
 <span class="mi">297</span>     <span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">getFlags</span><span class="p">().</span><span class="n">isSet</span><span class="p">(</span><span class="n">Request</span><span class="o">::</span><span class="n">NO_ACCESS</span><span class="p">))</span> <span class="p">{</span>
 <span class="mi">298</span>         <span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">dcache_pkt</span><span class="p">);</span>
 <span class="mi">299</span>         <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">makeResponse</span><span class="p">();</span>
 <span class="mi">300</span>         <span class="n">completeDataAccess</span><span class="p">(</span><span class="n">pkt</span><span class="p">);</span>
 <span class="mi">301</span>     <span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">read</span><span class="p">)</span> <span class="p">{</span>
 <span class="mi">302</span>         <span class="n">handleReadPacket</span><span class="p">(</span><span class="n">pkt</span><span class="p">);</span>
 <span class="mi">303</span>     <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
 <span class="mi">304</span>         <span class="kt">bool</span> <span class="n">do_access</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>  <span class="c1">// flag to suppress cache access</span>
 <span class="mi">305</span>
 <span class="mi">306</span>         <span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">isLLSC</span><span class="p">())</span> <span class="p">{</span>
 <span class="mi">307</span>             <span class="n">do_access</span> <span class="o">=</span> <span class="n">TheISA</span><span class="o">::</span><span class="n">handleLockedWrite</span><span class="p">(</span><span class="kr">thread</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">dcachePort</span><span class="p">.</span><span class="n">cacheBlockMask</span><span class="p">);</span>
 <span class="mi">308</span>         <span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">isCondSwap</span><span class="p">())</span> <span class="p">{</span>
 <span class="mi">309</span>             <span class="n">assert</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>
 <span class="mi">310</span>             <span class="n">req</span><span class="o">-&gt;</span><span class="n">setExtraData</span><span class="p">(</span><span class="o">*</span><span class="n">res</span><span class="p">);</span>
 <span class="mi">311</span>         <span class="p">}</span>
 <span class="mi">312</span>
 <span class="mi">313</span>         <span class="nf">if</span> <span class="p">(</span><span class="n">do_access</span><span class="p">)</span> <span class="p">{</span>
 <span class="mi">314</span>             <span class="n">dcache_pkt</span> <span class="o">=</span> <span class="n">pkt</span><span class="p">;</span>
 <span class="mi">315</span>             <span class="n">handleWritePacket</span><span class="p">();</span>
 <span class="mi">316</span>             <span class="n">threadSnoop</span><span class="p">(</span><span class="n">pkt</span><span class="p">,</span> <span class="n">curThread</span><span class="p">);</span>
 <span class="mi">317</span>         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
 <span class="mi">318</span>             <span class="n">_status</span> <span class="o">=</span> <span class="n">DcacheWaitResponse</span><span class="p">;</span>
 <span class="mi">319</span>             <span class="n">completeDataAccess</span><span class="p">(</span><span class="n">pkt</span><span class="p">);</span>
 <span class="mi">320</span>         <span class="p">}</span>
 <span class="mi">321</span>     <span class="p">}</span>
 <span class="mi">322</span> <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Currently we are looking at load instruction not the store,
we are going to assume that read flag has been set.
Therefore, it invoked handleReadPacket(pkt) function 
in line 301-302.
Note that packer pkk is created as a combination of req and read
(line 294).
As req variable contains all the required address and data size 
to access memory, it should be contained in the request packet.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre></td><td class="rouge-code"><pre> <span class="mi">258</span> <span class="kt">bool</span>
 <span class="mi">259</span> <span class="n">TimingSimpleCPU</span><span class="o">::</span><span class="n">handleReadPacket</span><span class="p">(</span><span class="n">PacketPtr</span> <span class="n">pkt</span><span class="p">)</span>
 <span class="mi">260</span> <span class="p">{</span>
 <span class="mi">261</span>     <span class="n">SimpleExecContext</span> <span class="o">&amp;</span><span class="n">t_info</span> <span class="o">=</span> <span class="o">*</span><span class="n">threadInfo</span><span class="p">[</span><span class="n">curThread</span><span class="p">];</span>
 <span class="mi">262</span>     <span class="n">SimpleThread</span><span class="o">*</span> <span class="kr">thread</span> <span class="o">=</span> <span class="n">t_info</span><span class="p">.</span><span class="kr">thread</span><span class="p">;</span>
 <span class="mi">263</span>
 <span class="mi">264</span>     <span class="k">const</span> <span class="n">RequestPtr</span> <span class="o">&amp;</span><span class="n">req</span> <span class="o">=</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">;</span>
 <span class="mi">265</span>
 <span class="mi">266</span>     <span class="c1">// We're about the issues a locked load, so tell the monitor</span>
 <span class="mi">267</span>     <span class="c1">// to start caring about this address</span>
 <span class="mi">268</span>     <span class="k">if</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">isRead</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">isLLSC</span><span class="p">())</span> <span class="p">{</span>
 <span class="mi">269</span>         <span class="n">TheISA</span><span class="o">::</span><span class="n">handleLockedRead</span><span class="p">(</span><span class="kr">thread</span><span class="p">,</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">);</span>
 <span class="mi">270</span>     <span class="p">}</span>
 <span class="mi">271</span>     <span class="nf">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">isMmappedIpr</span><span class="p">())</span> <span class="p">{</span>
 <span class="mi">272</span>         <span class="n">Cycles</span> <span class="n">delay</span> <span class="o">=</span> <span class="n">TheISA</span><span class="o">::</span><span class="n">handleIprRead</span><span class="p">(</span><span class="kr">thread</span><span class="o">-&gt;</span><span class="n">getTC</span><span class="p">(),</span> <span class="n">pkt</span><span class="p">);</span>
 <span class="mi">273</span>         <span class="k">new</span> <span class="n">IprEvent</span><span class="p">(</span><span class="n">pkt</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="n">clockEdge</span><span class="p">(</span><span class="n">delay</span><span class="p">));</span>
 <span class="mi">274</span>         <span class="n">_status</span> <span class="o">=</span> <span class="n">DcacheWaitResponse</span><span class="p">;</span>
 <span class="mi">275</span>         <span class="n">dcache_pkt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
 <span class="mi">276</span>     <span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dcachePort</span><span class="p">.</span><span class="n">sendTimingReq</span><span class="p">(</span><span class="n">pkt</span><span class="p">))</span> <span class="p">{</span>
 <span class="mi">277</span>         <span class="n">_status</span> <span class="o">=</span> <span class="n">DcacheRetry</span><span class="p">;</span>
 <span class="mi">278</span>         <span class="n">dcache_pkt</span> <span class="o">=</span> <span class="n">pkt</span><span class="p">;</span>
 <span class="mi">279</span>     <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
 <span class="mi">280</span>         <span class="n">_status</span> <span class="o">=</span> <span class="n">DcacheWaitResponse</span><span class="p">;</span>
 <span class="mi">281</span>         <span class="c1">// memory system takes ownership of packet</span>
 <span class="mi">282</span>         <span class="n">dcache_pkt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
 <span class="mi">283</span>     <span class="p">}</span>
 <span class="mi">284</span>     <span class="k">return</span> <span class="n">dcache_pkt</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">;</span>
 <span class="mi">285</span> <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Because CPU is connected to memory component 
through master slave ports in GEM5,
it can initiate memory access by sending request packet 
through a <em>sendTimingReq</em> method.
Because CPU goes through the data cache 
before touching the physical memory, 
the sendTimingReq is invoked on the DcachePort.</p>

<p><em>gem5/src/mem/port.hh</em></p>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="mi">444</span> <span class="kr">inline</span> <span class="kt">bool</span>
<span class="mi">445</span> <span class="n">MasterPort</span><span class="o">::</span><span class="n">sendTimingReq</span><span class="p">(</span><span class="n">PacketPtr</span> <span class="n">pkt</span><span class="p">)</span>
<span class="mi">446</span> <span class="p">{</span>
<span class="mi">447</span>     <span class="k">return</span> <span class="n">TimingRequestProtocol</span><span class="o">::</span><span class="n">sendReq</span><span class="p">(</span><span class="n">_slavePort</span><span class="p">,</span> <span class="n">pkt</span><span class="p">);</span>
<span class="mi">448</span> <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>
<p><em>mem/protocol/timing.cc</em></p>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre> <span class="mi">47</span> <span class="cm">/* The request protocol. */</span>
 <span class="mi">48</span> 
 <span class="mi">49</span> <span class="kt">bool</span>
 <span class="mi">50</span> <span class="n">TimingRequestProtocol</span><span class="o">::</span><span class="n">sendReq</span><span class="p">(</span><span class="n">TimingResponseProtocol</span> <span class="o">*</span><span class="n">peer</span><span class="p">,</span> <span class="n">PacketPtr</span> <span class="n">pkt</span><span class="p">)</span>
 <span class="mi">51</span> <span class="p">{</span>
 <span class="mi">52</span>     <span class="n">assert</span><span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">isRequest</span><span class="p">());</span>
 <span class="mi">53</span>     <span class="k">return</span> <span class="n">peer</span><span class="o">-&gt;</span><span class="n">recvTimingReq</span><span class="p">(</span><span class="n">pkt</span><span class="p">);</span>
 <span class="mi">54</span> <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="recvtimingresp"><span class="me-2">recvTimingResp</span><a href="#recvtimingresp" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>When the request has been handled by the slave (DCache),
recvTimingResp method of DcachePort will be invoked 
to handle result of memory access.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="rouge-code"><pre> <span class="mi">978</span> <span class="kt">bool</span>
 <span class="mi">979</span> <span class="n">TimingSimpleCPU</span><span class="o">::</span><span class="n">DcachePort</span><span class="o">::</span><span class="n">recvTimingResp</span><span class="p">(</span><span class="n">PacketPtr</span> <span class="n">pkt</span><span class="p">)</span>
 <span class="mi">980</span> <span class="p">{</span>
 <span class="mi">981</span>     <span class="n">DPRINTF</span><span class="p">(</span><span class="n">SimpleCPU</span><span class="p">,</span> <span class="s">"Received load/store response %#x</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">getAddr</span><span class="p">());</span>
 <span class="mi">982</span>
 <span class="mi">983</span>     <span class="c1">// The timing CPU is not really ticked, instead it relies on the</span>
 <span class="mi">984</span>     <span class="c1">// memory system (fetch and load/store) to set the pace.</span>
 <span class="mi">985</span>     <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tickEvent</span><span class="p">.</span><span class="n">scheduled</span><span class="p">())</span> <span class="p">{</span>
 <span class="mi">986</span>         <span class="c1">// Delay processing of returned data until next CPU clock edge</span>
 <span class="mi">987</span>         <span class="n">tickEvent</span><span class="p">.</span><span class="n">schedule</span><span class="p">(</span><span class="n">pkt</span><span class="p">,</span> <span class="n">cpu</span><span class="o">-&gt;</span><span class="n">clockEdge</span><span class="p">());</span>
 <span class="mi">988</span>         <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
 <span class="mi">989</span>     <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
 <span class="mi">990</span>         <span class="c1">// In the case of a split transaction and a cache that is</span>
 <span class="mi">991</span>         <span class="c1">// faster than a CPU we could get two responses in the</span>
 <span class="mi">992</span>         <span class="c1">// same tick, delay the second one</span>
 <span class="mi">993</span>         <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">retryRespEvent</span><span class="p">.</span><span class="n">scheduled</span><span class="p">())</span>
 <span class="mi">994</span>             <span class="n">cpu</span><span class="o">-&gt;</span><span class="n">schedule</span><span class="p">(</span><span class="n">retryRespEvent</span><span class="p">,</span> <span class="n">cpu</span><span class="o">-&gt;</span><span class="n">clockEdge</span><span class="p">(</span><span class="n">Cycles</span><span class="p">(</span><span class="mi">1</span><span class="p">)));</span>
 <span class="mi">995</span>         <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
 <span class="mi">996</span>     <span class="p">}</span>
 <span class="mi">997</span> <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>
<p>It seems that it doesn’t handle the received packet.
However, it schedules tickEvent<br />
to process the recevied packet.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre> <span class="mi">999</span> <span class="kt">void</span>
<span class="mi">1000</span> <span class="n">TimingSimpleCPU</span><span class="o">::</span><span class="n">DcachePort</span><span class="o">::</span><span class="n">DTickEvent</span><span class="o">::</span><span class="n">process</span><span class="p">()</span>
<span class="mi">1001</span> <span class="p">{</span>
<span class="mi">1002</span>     <span class="n">cpu</span><span class="o">-&gt;</span><span class="n">completeDataAccess</span><span class="p">(</span><span class="n">pkt</span><span class="p">);</span>
<span class="mi">1003</span> <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>


  </div>

  <div class="post-tail-wrapper text-muted">
    <!-- categories -->
    
      <div class="post-meta mb-3">
        <i class="far fa-folder-open fa-fw me-1"></i>
        
          <a href="/categories/gem5/">GEM5,</a>,
          <a href="/categories/microops/">Microops</a>
      </div>
    

    <!-- tags -->
    

    <div
      class="
        post-tail-bottom
        d-flex justify-content-between align-items-center mt-5 pb-2
      "
    >
      <div class="license-wrapper">
        
          

          This post is licensed under 
        <a href="https://creativecommons.org/licenses/by/4.0/">
          CC BY 4.0
        </a>
         by the author.
        
      </div>

      <!-- Post sharing snippet -->

<div class="share-wrapper d-flex align-items-center">
  <span class="share-label text-muted">Share</span>
  <span class="share-icons">
    
    
    

    

      

      <a
        href="https://twitter.com/intent/tweet?text=Gem5%20Memaccess%20-%20Ruach&url=https%3A%2F%2Fruach.github.io%2Fposts%2Fgem5-memaccess%2F"
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Twitter"
        target="_blank"
        rel="noopener"
        aria-label="Twitter"
      >
        <i class="fa-fw fa-brands fa-square-x-twitter"></i>
      </a>
    

      

      <a
        href="https://www.facebook.com/sharer/sharer.php?title=Gem5%20Memaccess%20-%20Ruach&u=https%3A%2F%2Fruach.github.io%2Fposts%2Fgem5-memaccess%2F"
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Facebook"
        target="_blank"
        rel="noopener"
        aria-label="Facebook"
      >
        <i class="fa-fw fab fa-facebook-square"></i>
      </a>
    

      

      <a
        href="https://t.me/share/url?url=https%3A%2F%2Fruach.github.io%2Fposts%2Fgem5-memaccess%2F&text=Gem5%20Memaccess%20-%20Ruach"
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Telegram"
        target="_blank"
        rel="noopener"
        aria-label="Telegram"
      >
        <i class="fa-fw fab fa-telegram"></i>
      </a>
    

      

      <a
        href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fruach.github.io%2Fposts%2Fgem5-memaccess%2F"
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Linkedin"
        target="_blank"
        rel="noopener"
        aria-label="Linkedin"
      >
        <i class="fa-fw fab fa-linkedin"></i>
      </a>
    

    <button
      id="copy-link"
      aria-label="Copy link"
      class="btn small"
      data-bs-toggle="tooltip"
      data-bs-placement="top"
      title="Copy link"
      data-title-succeed="Link copied successfully!"
    >
      <i class="fa-fw fas fa-link pe-none fs-6"></i>
    </button>
  </span>
</div>

    </div>
    <!-- .post-tail-bottom -->
  </div>
  <!-- div.post-tail-wrapper -->
</article>


            
          </main>

          <!-- panel -->
          <aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 mb-5 text-muted">
            <div class="access">
              <!-- Get the last 5 posts from lastmod list. -->















              <!-- The trending tags list -->


















            </div>

            
              
              



  <section id="toc-wrapper" class="ps-0 pe-4">
    <h2 class="panel-heading ps-3 pt-2 mb-2">Contents</h2>
    <nav id="toc"></nav>
  </section>


            
          </aside>
        </div>

        <div class="row">
          <!-- tail -->
          <div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4">
            
              
              <!-- Recommend the other 3 posts according to the tags and categories of the current post. -->

<!-- The total size of related posts -->


<!-- An random integer that bigger than 0 -->


<!-- Equals to TAG_SCORE / {max_categories_hierarchy} -->














  

  
    
  

  

  

  

  

  











  <aside id="related-posts" aria-labelledby="related-label">
    <h3 class="mb-4" id="related-label">Further Reading</h3>
    <nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4">
      
        <article class="col">
          <a href="/posts/gem5-macroop-to-microop/" class="post-preview card h-100">
            <div class="card-body">
              <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1590984000"
  data-df="ll"
  
>
  Jun  1, 2020
</time>

              <h4 class="pt-0 my-2">Gem5 Macroop To Microop</h4>
              <div class="text-muted">
                <p>
                  





                  Macroop and Microop in Computer Architecture


  Macroop (Macro-operation):
    
      A macroop is a high-level instruction or operation that is part of the
instruction set architecture (ISA) of a...
                </p>
              </div>
            </div>
          </a>
        </article>
      
    </nav>
  </aside>
  <!-- #related-posts -->


            
              
              <!-- Navigation buttons at the bottom of the post. -->

<nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation">
  
  

  
    <a
      href="/posts/gem5-x86-tlb/"
      class="btn btn-outline-primary"
      aria-label="Older"
    >
      <p>Gem5 X86 Tlb</p>
    </a>
  

  
    <a
      href="/posts/initcalls/"
      class="btn btn-outline-primary"
      aria-label="Newer"
    >
      <p>Initcalls</p>
    </a>
  
</nav>

            
              
              <!--  The comments switcher -->

  
  <!-- The Disqus lazy loading. -->

<div id="disqus_thread">
  <p class="text-center text-muted small">Comments powered by <a href="https://disqus.com/">Disqus</a>.</p>
</div>

<script type="text/javascript">
  var disqus_config = function () {
    this.page.url = 'https://ruach.github.io/posts/gem5-memaccess/';
    this.page.identifier = '/posts/gem5-memaccess/';
  };

  /* Lazy loading */
  var disqus_observer = new IntersectionObserver(
    function (entries) {
      if (entries[0].isIntersecting) {
        (function () {
          var d = document,
            s = d.createElement('script');
          s.src = 'https://ruach.disqus.com/embed.js';
          s.setAttribute('data-timestamp', +new Date());
          (d.head || d.body).appendChild(s);
        })();

        disqus_observer.disconnect();
      }
    },
    { threshold: [0] }
  );

  disqus_observer.observe(document.querySelector('#disqus_thread'));

  /* Auto switch theme */
  function reloadDisqus() {
    if (event.source === window && event.data && event.data.direction === ModeToggle.ID) {
      /* Disqus hasn't been loaded */
      if (typeof DISQUS === 'undefined') {
        return;
      }

      if (document.readyState == 'complete') {
        DISQUS.reset({ reload: true, config: disqus_config });
      }
    }
  }

  if (document.querySelector('.mode-toggle')) {
    window.addEventListener('message', reloadDisqus);
  }
</script>



            

            <!-- The Footer -->

<footer
  aria-label="Site Info"
  class="
    d-flex flex-column justify-content-center text-muted
    flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3
  "
>
  <p>
    ©
    <time>2024</time>
    <a href="https://ruach.github.io">Jaehyuk Lee</a>.
    
      <span
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author."
      >Some rights reserved.</span>
    
  </p>

  <p>Using the <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme for <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>
  </p>
</footer>

          </div>
        </div>

        <!-- The Search results -->

<div id="search-result-wrapper" class="d-flex justify-content-center unloaded">
  <div class="col-11 content">
    <div id="search-hints">
      <!-- The trending tags list -->


















    </div>
    <div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div>
  </div>
</div>

      </div>

      <aside aria-label="Scroll to Top">
        <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow">
          <i class="fas fa-angle-up"></i>
        </button>
      </aside>
    </div>

    <div id="mask"></div>

    
      <aside
  id="notification"
  class="toast"
  role="alert"
  aria-live="assertive"
  aria-atomic="true"
  data-bs-animation="true"
  data-bs-autohide="false"
>
  <div class="toast-header">
    <button
      type="button"
      class="btn-close ms-auto"
      data-bs-dismiss="toast"
      aria-label="Close"
    ></button>
  </div>
  <div class="toast-body text-center pt-0">
    <p class="px-2 mb-3">A new version of content is available.</p>
    <button type="button" class="btn btn-primary" aria-label="Update">
      Update
    </button>
  </div>
</aside>

    

    <!-- JavaScripts -->

    <!-- JS selector for site. -->

<!-- commons -->



<!-- layout specified -->


  

  
    <!-- image lazy-loading & popup & clipboard -->
    
  















  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  



  <script src="https://cdn.jsdelivr.net/combine/npm/jquery@3.7.1/dist/jquery.min.js,npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js,npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/magnific-popup@1.1.0/dist/jquery.magnific-popup.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.10/dayjs.min.js,npm/dayjs@1.11.10/locale/en.min.js,npm/dayjs@1.11.10/plugin/relativeTime.min.js,npm/dayjs@1.11.10/plugin/localizedFormat.min.js,npm/tocbot@4.21.2/dist/tocbot.min.js"></script>






<script defer src="/assets/js/dist/post.min.js"></script>






    

    <!--
  Jekyll Simple Search loader
  See: <https://github.com/christian-fei/Simple-Jekyll-Search>
-->





<script>
  /* Note: dependent library will be loaded in `js-selector.html` */
  SimpleJekyllSearch({
    searchInput: document.getElementById('search-input'),
    resultsContainer: document.getElementById('search-results'),
    json: '/assets/js/data/search.json',
    searchResultTemplate: '  <article class="px-1 px-sm-2 px-lg-4 px-xl-0">    <header>      <h2><a href="{url}">{title}</a></h2>      <div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1">        {categories}        {tags}      </div>    </header>    <p>{snippet}</p>  </article>',
    noResultsText: '<p class="mt-5"></p>',
    templateMiddleware: function(prop, value, template) {
      if (prop === 'categories') {
        if (value === '') {
          return `${value}`;
        } else {
          return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`;
        }
      }

      if (prop === 'tags') {
        if (value === '') {
          return `${value}`;
        } else {
          return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`;
        }
      }
    }
  });
</script>

  </body>
</html>

