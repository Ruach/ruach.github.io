<!doctype html>














<!-- `site.alt_lang` can specify a language different from the UI -->
<html lang="en" data-mode="light">
  <!-- The Head -->

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta
    name="viewport"
    content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover"
  >

  

  

  
    <!-- Begin Jekyll SEO tag v2.8.0 -->
<meta name="generator" content="Jekyll v4.3.2" />
<meta property="og:title" content="GEM5, from entry point to simulation loop" />
<meta property="og:locale" content="en" />
<meta name="description" content="Complexity of Gem5: mix of CPP and Python When you first take a look at the GEM5 source code, it could be confusing because it has Python, CPP, and isa files which you might haven’t seen before. In GEM5, Most of the simulation logic is implemented as a CPP, but it utilizes Python heavily for platform configuration and automatic generation of CPP class from templates. For example, ISA files define hardware logic with Domain Specific Language (DSL) and will be translated into CPP classes with the help of Python. Forget about isa file in this posting! I will go over it in another blog posting." />
<meta property="og:description" content="Complexity of Gem5: mix of CPP and Python When you first take a look at the GEM5 source code, it could be confusing because it has Python, CPP, and isa files which you might haven’t seen before. In GEM5, Most of the simulation logic is implemented as a CPP, but it utilizes Python heavily for platform configuration and automatic generation of CPP class from templates. For example, ISA files define hardware logic with Domain Specific Language (DSL) and will be translated into CPP classes with the help of Python. Forget about isa file in this posting! I will go over it in another blog posting." />
<link rel="canonical" href="https://ruach.github.io/posts/gem5-simobject/" />
<meta property="og:url" content="https://ruach.github.io/posts/gem5-simobject/" />
<meta property="og:site_name" content="Ruach" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-05-19T00:00:00-04:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="GEM5, from entry point to simulation loop" />
<meta name="twitter:site" content="@ruach_lee" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2020-05-19T00:00:00-04:00","datePublished":"2020-05-19T00:00:00-04:00","description":"Complexity of Gem5: mix of CPP and Python When you first take a look at the GEM5 source code, it could be confusing because it has Python, CPP, and isa files which you might haven’t seen before. In GEM5, Most of the simulation logic is implemented as a CPP, but it utilizes Python heavily for platform configuration and automatic generation of CPP class from templates. For example, ISA files define hardware logic with Domain Specific Language (DSL) and will be translated into CPP classes with the help of Python. Forget about isa file in this posting! I will go over it in another blog posting.","headline":"GEM5, from entry point to simulation loop","mainEntityOfPage":{"@type":"WebPage","@id":"https://ruach.github.io/posts/gem5-simobject/"},"url":"https://ruach.github.io/posts/gem5-simobject/"}</script>
<!-- End Jekyll SEO tag -->

  

  <title>GEM5, from entry point to simulation loop | Ruach
  </title>

  <!--
  The Favicons for Web, Android, Microsoft, and iOS (iPhone and iPad) Apps
  Generated by: https://realfavicongenerator.net/
-->



<link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png">
<link rel="manifest" href="/assets/img/favicons/site.webmanifest">
<link rel="shortcut icon" href="/assets/img/favicons/favicon.ico">
<meta name="apple-mobile-web-app-title" content="Ruach">
<meta name="application-name" content="Ruach">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml">
<meta name="theme-color" content="#ffffff">


  
    
      <link rel="preconnect" href="https://fonts.googleapis.com" >
      <link rel="dns-prefetch" href="https://fonts.googleapis.com" >
    
      <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      <link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin>
    
      <link rel="preconnect" href="https://fonts.googleapis.com" >
      <link rel="dns-prefetch" href="https://fonts.googleapis.com" >
    
      <link rel="preconnect" href="https://cdn.jsdelivr.net" >
      <link rel="dns-prefetch" href="https://cdn.jsdelivr.net" >
    

    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap">
  

  <!-- GA -->
  

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.2/css/all.min.css">

  <link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css">

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.21.2/dist/tocbot.min.css">
  

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css">
  

  
    <!-- Manific Popup -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css">
  

  <!-- JavaScript -->

  

  <!-- A placeholder to allow defining custom metadata -->

</head>


  <body>
    <!-- The Side Bar -->

<aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end">
  <header class="profile-wrapper">
    <a href="/" id="avatar" class="rounded-circle">
      
        
        <img src="/assets/img/jaehyuk.png" width="112" height="112" alt="avatar" onerror="this.style.display='none'">
      
    </a>

    <h1 class="site-title">
      <a href="/">Ruach</a>
    </h1>
    <p class="site-subtitle fst-italic mb-0">Security Researcher at Gatech</p>
  </header>
  <!-- .profile-wrapper -->

  <nav class="flex-column flex-grow-1 w-100 ps-0">
    <ul class="nav">
      <!-- home -->
      <li class="nav-item">
        <a href="/" class="nav-link">
          <i class="fa-fw fas fa-home"></i>
          <span>HOME</span>
        </a>
      </li>
      <!-- the real tabs -->
      
        <li class="nav-item">
          <a href="/categories/" class="nav-link">
            <i class="fa-fw fas fa-stream"></i>
            

            <span>CATEGORIES</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/tags/" class="nav-link">
            <i class="fa-fw fas fa-tags"></i>
            

            <span>TAGS</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/archives/" class="nav-link">
            <i class="fa-fw fas fa-archive"></i>
            

            <span>ARCHIVES</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/about/" class="nav-link">
            <i class="fa-fw fas fa-info-circle"></i>
            

            <span>ABOUT</span>
          </a>
        </li>
        <!-- .nav-item -->
      
    </ul>
  </nav>

  <div class="sidebar-bottom d-flex flex-wrap  align-items-center w-100">
    

    
      

      
        <a
          href="javascript:location.href = 'mailto:' + ['jaehyuk','gatech.edu'].join('@')"
          aria-label="email"
          

          

          

          
        >
          <i class="fas fa-envelope"></i>
        </a>
      
    
      

      
        <a
          href="https://www.linkedin.com/in/jaehyuk-lee-29b33b121/"
          aria-label="linkedin"
          

          
            target="_blank"
            
          

          

          
            rel="noopener noreferrer"
          
        >
          <i class="fab fa-linkedin"></i>
        </a>
      
    
      

      
        <a
          href="https://github.com/Ruach"
          aria-label="github"
          

          
            target="_blank"
            
          

          

          
            rel="noopener noreferrer"
          
        >
          <i class="fab fa-github"></i>
        </a>
      
    
      

      
        <a
          href="https://stackoverflow.com/users/4460514/ruach?tab=profile"
          aria-label="stack-overflow"
          

          
            target="_blank"
            
          

          

          
            rel="noopener noreferrer"
          
        >
          <i class="fab fa-stack-overflow"></i>
        </a>
      
    
  </div>
  <!-- .sidebar-bottom -->
</aside>
<!-- #sidebar -->


    <div id="main-wrapper" class="d-flex justify-content-center">
      <div class="container d-flex flex-column px-xxl-5">
        <!-- The Top Bar -->

<header id="topbar-wrapper" aria-label="Top Bar">
  <div
    id="topbar"
    class="d-flex align-items-center justify-content-between px-lg-3 h-100"
  >
    <nav id="breadcrumb" aria-label="Breadcrumb">
      

      
        
          
            <span>
              <a href="/">
                Home
              </a>
            </span>

          
        
          
        
          
            
              <span>GEM5, from entry point to simulation loop</span>
            

          
        
      
    </nav>
    <!-- endof #breadcrumb -->

    <button type="button" id="sidebar-trigger" class="btn btn-link">
      <i class="fas fa-bars fa-fw"></i>
    </button>

    <div id="topbar-title">
      Post
    </div>

    <button type="button" id="search-trigger" class="btn btn-link">
      <i class="fas fa-search fa-fw"></i>
    </button>

    <search class="align-items-center ms-3 ms-lg-0">
      <i class="fas fa-search fa-fw"></i>
      <input
        class="form-control"
        id="search-input"
        type="search"
        aria-label="search"
        autocomplete="off"
        placeholder="Search..."
      >
    </search>
    <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button>
  </div>
</header>


        <div class="row flex-grow-1">
          <main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4">
            
              <!-- Refactor the HTML structure -->



<!--
  In order to allow a wide table to scroll horizontally,
  we suround the markdown table with `<div class="table-wrapper">` and `</div>`
-->



<!--
  Fixed kramdown code highlight rendering:
  https://github.com/penibelst/jekyll-compress-html/issues/101
  https://github.com/penibelst/jekyll-compress-html/issues/71#issuecomment-188144901
-->



<!-- Change the icon of checkbox -->



<!-- Handle images -->





<!-- Add header for code snippets -->



<!-- Create heading anchors -->





  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    

    
  

  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    

    
  

  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    

    
  

  
  

  




<!-- return -->




<article class="px-1">
  <header>
    <h1 data-toc-skip>GEM5, from entry point to simulation loop</h1>

    <div class="post-meta text-muted">
      <!-- published date -->
      <span>
        Posted
        <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1589860800"
  data-df="ll"
  
    data-bs-toggle="tooltip" data-bs-placement="bottom"
  
>
  May 19, 2020
</time>

      </span>

      <!-- lastmod date -->
      

      

      <div class="d-flex justify-content-between">
        <!-- author(s) -->
        <span>
          

          By

          <em>
            
              <a href="https://ruach.github.io">Jaehyuk Lee</a>
            
          </em>
        </span>

        <!-- read time -->
        <!-- Calculate the post's reading time, and display the word count in tooltip -->



<!-- words per minute -->










<!-- return element -->
<span
  class="readtime"
  data-bs-toggle="tooltip"
  data-bs-placement="bottom"
  title="10209 words"
>
  <em>56 min</em> read</span>

      </div>
      <!-- .d-flex -->
    </div>
    <!-- .post-meta -->
  </header>

  <div class="content">
    <h2 id="complexity-of-gem5-mix-of-cpp-and-python"><span class="me-2">Complexity of Gem5: mix of CPP and Python</span><a href="#complexity-of-gem5-mix-of-cpp-and-python" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<p>When you first take a look at the GEM5 source code, it could be confusing 
because it has <strong>Python, CPP, and isa files</strong> which you might haven’t seen 
before. In GEM5, Most of the simulation logic is implemented as a CPP, but it 
utilizes Python heavily for platform configuration and automatic generation of
CPP class from templates. For example, ISA files define hardware logic with 
Domain Specific Language (DSL) and will be translated into CPP classes with the 
help of Python. Forget about isa file in this posting! I will go over it in 
another blog posting.</p>

<p>Since the GEM5 execution is a mixture of CPP functions and Python scripts, and 
there are duplicated names for classes and functions in both files, it would be 
tricky to understand how GEM5 works. This confusion even start from the program 
execution. Let’s see the gem5 execution command, particularly for simulating X86
architecture. If this is first time of using GEM5 please read some articles from
<a href="https://www.gem5.org/documentation/learning_gem5/introduction/">GEM5 tutorial</a>
before reading this post.</p>

<blockquote class="prompt-info">
  <p>build/X86/gem5.opt &lt;Python script for configuration&gt;</p>
</blockquote>

<p>The gem5.opt is a <strong>elf binary</strong> compiled from GEM5 CPP code base. However, to 
run simulation, GEM5 requires additional configuration script written in <strong>Python.</strong> 
This script specifies configuration of the platform you want to simulate with 
GEM5, which includes configuration of CPU, Memory, caches and buses. Wait, I 
told you most of the simulation logic is implemented as CPP, then why suddenly
Python script is necessary for configuring simulated platform?</p>

<p>I couldn’t find any documents detailing the integration of Python and CPP for 
GEM5 implementation. In my opinion, the idea is to decouple hardware 
configuration from the main code base to avoid re-compilation cost. If a user
doesn’t introduce new component nor want to simulate another architecture, 
adjusting the configuration of the simulated platform would not need another 
compilation.</p>

<p>Irrespective of the rationale, since GEM5 extensively utilizes both Python and 
C++, the execution of code involves frequent transitions between the two 
languages. Moreover, given that the class names and attributes are either 
identical or highly similar in both Python and C++, navigating the codebase can 
be quite confusing.</p>

<h3 id="motivating-example"><span class="me-2">Motivating Example</span><a href="#motivating-example" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="c1"># create the system we are going to simulate                                    
</span><span class="n">system</span> <span class="o">=</span> <span class="nc">System</span><span class="p">()</span>                                                               
                                                                                
<span class="c1"># Create a simple CPU                                                           
</span><span class="n">system</span><span class="p">.</span><span class="n">cpu</span> <span class="o">=</span> <span class="nc">TimingSimpleCPU</span><span class="p">()</span>                                                  
</pre></td></tr></tbody></table></code></div></div>

<p>When examining the Python script passed to gem5.opt, you’ll notice that it calls
various functions associated with hardware components. For instance, it invokes 
the TimingSimpleCPU function.</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">TimingSimpleCPU</span><span class="p">(</span><span class="n">BaseSimpleCPU</span><span class="p">):</span>
    <span class="nb">type</span> <span class="o">=</span> <span class="sh">'</span><span class="s">TimingSimpleCPU</span><span class="sh">'</span>
    <span class="n">cxx_header</span> <span class="o">=</span> <span class="sh">"</span><span class="s">cpu/simple/timing.hh</span><span class="sh">"</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">memory_mode</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="sh">'</span><span class="s">timing</span><span class="sh">'</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">support_take_over</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">True</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Given that it is Python code, it’s evident that this function is defined in 
Python. Indeed, as evident in the provided code, it is a Python function 
instantiating a TimingSimpleCPU class object. However, somewhat confusingly, you 
can also simultaneously find the CPP implementation for TimingSimpleCPU.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">TimingSimpleCPU</span> <span class="o">:</span> <span class="k">public</span> <span class="n">BaseSimpleCPU</span>
<span class="p">{</span>
  <span class="nl">public:</span>

    <span class="n">TimingSimpleCPU</span><span class="p">(</span><span class="n">TimingSimpleCPUParams</span> <span class="o">*</span> <span class="n">params</span><span class="p">);</span>
    <span class="k">virtual</span> <span class="o">~</span><span class="n">TimingSimpleCPU</span><span class="p">();</span>

    <span class="kt">void</span> <span class="n">init</span><span class="p">()</span> <span class="k">override</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></div></div>

<p>As mentioned earlier, the CPP implementation handles the actual hardware 
simulation, while the configuration is accomplished through the Python script. 
Consequently, it is necessary to translate Python class objects into CPP class 
objects to simulate the architecture. In this posting, I will explain how this 
transformation is accomplished in GEM5.</p>

<h2 id="allowing-python-to-access-cpp-definitions"><span class="me-2">Allowing Python to access CPP definitions</span><a href="#allowing-python-to-access-cpp-definitions" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<p>Since Python require access to classes and attributes implemented in different 
languages, CPP, a wrapper or helper is essential. GEM5 extensively employs 
pybind11 to facilitate Python scripts in accessing CPP-defined classes 
and structs. Detailed information about pybind11 is not covered in this post, 
so it is recommended to read 
<a href="https://pybind11.readthedocs.io/en/stable/basics.html">pybind11 documentation</a>, 
before proceeding with further reading.</p>

<h3 id="_m5-module-exporting-cpp-to-python"><span class="me-2">_m5 module exporting CPP to Python</span><a href="#_m5-module-exporting-cpp-to-python" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<blockquote class="prompt-info">
  <p>Please be aware that our current operations involve the execution of CPP main 
functions, not Python. The gem5.opt is an ELF binary compiled from CPP.</p>
</blockquote>

<p>GEM5 exports required CPP implementation as the _m5 Python module through 
pybind11. Additionally, the sub-modules are organized based on the categories 
of the C++ implementation.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
</pre></td><td class="rouge-code"><pre><span class="c1">//src/sim/main.cc</span>

<span class="kt">int</span>
<span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

    <span class="c1">// Initialize m5 special signal handling.</span>
    <span class="n">initSignals</span><span class="p">();</span>

<span class="cp">#if PY_MAJOR_VERSION &gt;= 3
</span>    <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="kt">wchar_t</span><span class="p">[],</span> <span class="k">decltype</span><span class="p">(</span><span class="o">&amp;</span><span class="n">PyMem_RawFree</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">program</span><span class="p">(</span>
        <span class="n">Py_DecodeLocale</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">NULL</span><span class="p">),</span>
        <span class="o">&amp;</span><span class="n">PyMem_RawFree</span><span class="p">);</span>
    <span class="n">Py_SetProgramName</span><span class="p">(</span><span class="n">program</span><span class="p">.</span><span class="n">get</span><span class="p">());</span>
<span class="cp">#else
</span>    <span class="n">Py_SetProgramName</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="cp">#endif
</span>
    <span class="c1">// Register native modules with Python's init system before</span>
    <span class="c1">// initializing the interpreter.</span>
    <span class="n">registerNativeModules</span><span class="p">();</span>

    <span class="c1">// initialize embedded Python interpreter</span>
    <span class="n">Py_Initialize</span><span class="p">();</span>

    <span class="c1">// Initialize the embedded m5 Python library</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">EmbeddedPython</span><span class="o">::</span><span class="n">initAll</span><span class="p">();</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// start m5</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">m5Main</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// clean up Python intepreter.</span>
    <span class="n">Py_Finalize</span><span class="p">();</span>

    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
    <span class="p">}</span>

</pre></td></tr></tbody></table></code></div></div>

<p>GEM5 defines EmbeddedPython class in CPP to provide all functions and attributes 
for developer to export through the pybind11. The <strong>EmbeddedPython::initAll</strong> 
function exposes the required C++ definitions for running the simulation. Upon 
export, it then executes the m5Main function, transferring control from the CPP 
to Python.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
</pre></td><td class="rouge-code"><pre><span class="c1">// src/sim/init.cc</span>

<span class="n">EmbeddedPyBind</span><span class="o">::</span><span class="n">initAll</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">list</span><span class="o">&lt;</span><span class="n">EmbeddedPyBind</span> <span class="o">*&gt;</span> <span class="n">pending</span><span class="p">;</span>

    <span class="n">py</span><span class="o">::</span><span class="n">module</span> <span class="n">m_m5</span> <span class="o">=</span> <span class="n">py</span><span class="o">::</span><span class="n">module</span><span class="p">(</span><span class="s">"_m5"</span><span class="p">);</span>
    <span class="n">m_m5</span><span class="p">.</span><span class="n">attr</span><span class="p">(</span><span class="s">"__package__"</span><span class="p">)</span> <span class="o">=</span> <span class="n">py</span><span class="o">::</span><span class="n">cast</span><span class="p">(</span><span class="s">"_m5"</span><span class="p">);</span>

    <span class="n">pybind_init_core</span><span class="p">(</span><span class="n">m_m5</span><span class="p">);</span>
    <span class="n">pybind_init_debug</span><span class="p">(</span><span class="n">m_m5</span><span class="p">);</span>

    <span class="n">pybind_init_event</span><span class="p">(</span><span class="n">m_m5</span><span class="p">);</span>
    <span class="n">pybind_init_stats</span><span class="p">(</span><span class="n">m_m5</span><span class="p">);</span>

    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="n">kv</span> <span class="o">:</span> <span class="n">getMap</span><span class="p">())</span> <span class="p">{</span>
        <span class="k">auto</span> <span class="o">&amp;</span><span class="n">obj</span> <span class="o">=</span> <span class="n">kv</span><span class="p">.</span><span class="n">second</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
            <span class="n">obj</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">(</span><span class="n">m_m5</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">pending</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">pending</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="n">it</span> <span class="o">=</span> <span class="n">pending</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span> <span class="n">it</span> <span class="o">!=</span> <span class="n">pending</span><span class="p">.</span><span class="n">end</span><span class="p">();</span> <span class="p">)</span> <span class="p">{</span>
            <span class="n">EmbeddedPyBind</span> <span class="o">&amp;</span><span class="n">obj</span> <span class="o">=</span> <span class="o">**</span><span class="n">it</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="p">.</span><span class="n">depsReady</span><span class="p">())</span> <span class="p">{</span>
                <span class="n">obj</span><span class="p">.</span><span class="n">init</span><span class="p">(</span><span class="n">m_m5</span><span class="p">);</span>
                <span class="n">it</span> <span class="o">=</span> <span class="n">pending</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">it</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="o">++</span><span class="n">it</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

<span class="cp">#if PY_MAJOR_VERSION &gt;= 3
</span>    <span class="k">return</span> <span class="n">m_m5</span><span class="p">.</span><span class="n">ptr</span><span class="p">();</span>
<span class="cp">#endif
</span><span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>The Python-exported CPP implementations from the initAll module can be categorized 
into two groups. The initial category comprises CPP functions associated with 
general operations essential for simulation, including debugging, simulation loops,
and statistical operations. The second category involves exporting a parameter 
struct designed for instantiating hardware components responsible for simulating 
the architecture.</p>

<h4 id="pybind-initialization-for-simulation"><span class="me-2">Pybind initialization for simulation</span><a href="#pybind-initialization-for-simulation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4>
<p>Functions named  “pybind_init_XXX” exports CPP implementations required for the
simulation. It exports CPP classes and functions relevant to specific categories 
as sub modules such as core, debug, event, and stats.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre></td><td class="rouge-code"><pre><span class="n">pybind_init_event</span><span class="p">(</span><span class="n">py</span><span class="o">::</span><span class="n">module</span> <span class="o">&amp;</span><span class="n">m_native</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">py</span><span class="o">::</span><span class="n">module</span> <span class="n">m</span> <span class="o">=</span> <span class="n">m_native</span><span class="p">.</span><span class="n">def_submodule</span><span class="p">(</span><span class="s">"event"</span><span class="p">);</span>

    <span class="n">m</span><span class="p">.</span><span class="n">def</span><span class="p">(</span><span class="s">"simulate"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">simulate</span><span class="p">,</span>
          <span class="n">py</span><span class="o">::</span><span class="n">arg</span><span class="p">(</span><span class="s">"ticks"</span><span class="p">)</span> <span class="o">=</span> <span class="n">MaxTick</span><span class="p">);</span>
    <span class="n">m</span><span class="p">.</span><span class="n">def</span><span class="p">(</span><span class="s">"exitSimLoop"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">exitSimLoop</span><span class="p">);</span>
    <span class="n">m</span><span class="p">.</span><span class="n">def</span><span class="p">(</span><span class="s">"getEventQueue"</span><span class="p">,</span> <span class="p">[]()</span> <span class="p">{</span> <span class="k">return</span> <span class="n">curEventQueue</span><span class="p">();</span> <span class="p">},</span>
          <span class="n">py</span><span class="o">::</span><span class="n">return_value_policy</span><span class="o">::</span><span class="n">reference</span><span class="p">);</span>
    <span class="n">m</span><span class="p">.</span><span class="n">def</span><span class="p">(</span><span class="s">"setEventQueue"</span><span class="p">,</span> <span class="p">[](</span><span class="n">EventQueue</span> <span class="o">*</span><span class="n">q</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">curEventQueue</span><span class="p">(</span><span class="n">q</span><span class="p">);</span> <span class="p">});</span>
    <span class="n">m</span><span class="p">.</span><span class="n">def</span><span class="p">(</span><span class="s">"getEventQueue"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">getEventQueue</span><span class="p">,</span>
          <span class="n">py</span><span class="o">::</span><span class="n">return_value_policy</span><span class="o">::</span><span class="n">reference</span><span class="p">);</span>

    <span class="n">py</span><span class="o">::</span><span class="n">class_</span><span class="o">&lt;</span><span class="n">EventQueue</span><span class="o">&gt;</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">"EventQueue"</span><span class="p">)</span>
        <span class="p">.</span><span class="n">def</span><span class="p">(</span><span class="s">"name"</span><span class="p">,</span>  <span class="p">[](</span><span class="n">EventQueue</span> <span class="o">*</span><span class="n">eq</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">eq</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">();</span> <span class="p">})</span>
        <span class="p">.</span><span class="n">def</span><span class="p">(</span><span class="s">"dump"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">EventQueue</span><span class="o">::</span><span class="n">dump</span><span class="p">)</span>
        <span class="p">.</span><span class="n">def</span><span class="p">(</span><span class="s">"schedule"</span><span class="p">,</span> <span class="p">[](</span><span class="n">EventQueue</span> <span class="o">*</span><span class="n">eq</span><span class="p">,</span> <span class="n">PyEvent</span> <span class="o">*</span><span class="n">e</span><span class="p">,</span> <span class="n">Tick</span> <span class="n">t</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">eq</span><span class="o">-&gt;</span><span class="n">schedule</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">t</span><span class="p">);</span>
            <span class="p">},</span> <span class="n">py</span><span class="o">::</span><span class="n">arg</span><span class="p">(</span><span class="s">"event"</span><span class="p">),</span> <span class="n">py</span><span class="o">::</span><span class="n">arg</span><span class="p">(</span><span class="s">"when"</span><span class="p">))</span>
        <span class="p">.</span><span class="n">def</span><span class="p">(</span><span class="s">"deschedule"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">EventQueue</span><span class="o">::</span><span class="n">deschedule</span><span class="p">,</span>
             <span class="n">py</span><span class="o">::</span><span class="n">arg</span><span class="p">(</span><span class="s">"event"</span><span class="p">))</span>
        <span class="p">.</span><span class="n">def</span><span class="p">(</span><span class="s">"reschedule"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">EventQueue</span><span class="o">::</span><span class="n">reschedule</span><span class="p">,</span>
             <span class="n">py</span><span class="o">::</span><span class="n">arg</span><span class="p">(</span><span class="s">"event"</span><span class="p">),</span> <span class="n">py</span><span class="o">::</span><span class="n">arg</span><span class="p">(</span><span class="s">"tick"</span><span class="p">),</span> <span class="n">py</span><span class="o">::</span><span class="n">arg</span><span class="p">(</span><span class="s">"always"</span><span class="p">)</span> <span class="o">=</span> <span class="nb">false</span><span class="p">)</span>
        <span class="p">;</span>
</pre></td></tr></tbody></table></code></div></div>

<p>For example, Python function should be able to invoke CPP functions associated 
with hardware simulation because actual simulation is done by CPP not python. 
As depicted in the example, it exports simulation-related functions under 
sub-modules ‘_m5.event’. Later, the exported simulate function will be invoked
from python to start hardware simulation.</p>

<h4 id="pybind-initialization-for-hw-components"><span class="me-2">Pybind Initialization for HW components</span><a href="#pybind-initialization-for-hw-components" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4>
<p>In contrast to functions in the first category, which are already implemented in
the CPP code base of GEM5, certain CPP implementations are automatically generated
during compile time. Consequently, exporting them is not feasible in the same 
manner as the first category, as the module name is unknown prior to generation. 
Additionally, if users incorporate extra hardware components, they must be added 
to the CPP class for proper exportation through Pybind. I will explain details 
about what CPP implementations will be automatically generated soon, so please 
bear with me.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span> <span class="n">EmbeddedPyBind</span> <span class="o">*&gt;</span> <span class="o">&amp;</span>
<span class="n">EmbeddedPyBind</span><span class="o">::</span><span class="n">getMap</span><span class="p">()</span>
<span class="p">{</span>   
    <span class="k">static</span> <span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span> <span class="n">EmbeddedPyBind</span> <span class="o">*&gt;</span> <span class="n">objs</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">objs</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="n">EmbeddedPyBind</span><span class="o">::</span><span class="n">init</span><span class="p">(</span><span class="n">py</span><span class="o">::</span><span class="n">module</span> <span class="o">&amp;</span><span class="n">m</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">registered</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">initFunc</span><span class="p">(</span><span class="n">m</span><span class="p">);</span>
        <span class="n">registered</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">cprintf</span><span class="p">(</span><span class="s">"Warning: %s already registered.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>EmbeddedPyBind class defines map ‘objs’ to manage all EmbeddedPyBind objects and
return this map when the getMap function is invoked.  The initAll function
iterates this objects returned from getMap function and invokes ‘init’ function 
of the EmbeddedPyBind object. It further invokes initFunc which is a private 
function pointer member field of EmbeddedPyBind class.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre><span class="n">EmbeddedPyBind</span><span class="o">::</span><span class="n">EmbeddedPyBind</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">_name</span><span class="p">,</span>
                               <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">init_func</span><span class="p">)(</span><span class="n">py</span><span class="o">::</span><span class="n">module</span> <span class="o">&amp;</span><span class="p">),</span>
                               <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">_base</span><span class="p">)</span>
    <span class="o">:</span> <span class="n">initFunc</span><span class="p">(</span><span class="n">init_func</span><span class="p">),</span> <span class="n">registered</span><span class="p">(</span><span class="nb">false</span><span class="p">),</span> <span class="n">name</span><span class="p">(</span><span class="n">_name</span><span class="p">),</span> <span class="n">base</span><span class="p">(</span><span class="n">_base</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">getMap</span><span class="p">()[</span><span class="n">_name</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">EmbeddedPyBind</span><span class="o">::</span><span class="n">EmbeddedPyBind</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">_name</span><span class="p">,</span>
                               <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">init_func</span><span class="p">)(</span><span class="n">py</span><span class="o">::</span><span class="n">module</span> <span class="o">&amp;</span><span class="p">))</span>
    <span class="o">:</span> <span class="n">initFunc</span><span class="p">(</span><span class="n">init_func</span><span class="p">),</span> <span class="n">registered</span><span class="p">(</span><span class="nb">false</span><span class="p">),</span> <span class="n">name</span><span class="p">(</span><span class="n">_name</span><span class="p">),</span> <span class="n">base</span><span class="p">(</span><span class="s">""</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">getMap</span><span class="p">()[</span><span class="n">_name</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>This function pointer is initialized by constructor of the EmbeddedPyBind class. 
However, you will not be able to find any relevant code instantiating 
EmbeddedPyBind for system component class. The reason is GEM5 automatically 
generate CPP code snippet, and EmbeddedPyBind class will be instantiated by that 
code. I will cover the details soon! Let’s assume that all required CPP 
implementations were exported to Python through pybind11.</p>

<h2 id="transferring-execution-control-to-python"><span class="me-2">Transferring execution control to Python</span><a href="#transferring-execution-control-to-python" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<p>After exporting CPP implementation, now it can finally jumps to GEM5 Python 
code base. Note that it will not execute the script initially passed to the 
gem5.opt executable.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
</pre></td><td class="rouge-code"><pre><span class="c1">//src/sim/init.cc</span>

<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">weak</span><span class="p">))</span> <span class="n">m5MainCommands</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">"import m5"</span><span class="p">,</span>
    <span class="s">"m5.main()"</span><span class="p">,</span>
    <span class="mi">0</span> <span class="c1">// sentinel is required</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">m5Main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">_argv</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#if HAVE_PROTOBUF
</span>    <span class="c1">// Verify that the version of the protobuf library that we linked</span>
    <span class="c1">// against is compatible with the version of the headers we</span>
    <span class="c1">// compiled against.</span>
    <span class="n">GOOGLE_PROTOBUF_VERIFY_VERSION</span><span class="p">;</span>
<span class="cp">#endif
</span>    
        
<span class="cp">#if PY_MAJOR_VERSION &gt;= 3
</span>    <span class="k">typedef</span> <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="kt">wchar_t</span><span class="p">[],</span> <span class="k">decltype</span><span class="p">(</span><span class="o">&amp;</span><span class="n">PyMem_RawFree</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">WArgUPtr</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">WArgUPtr</span><span class="o">&gt;</span> <span class="n">v_argv</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">wchar_t</span> <span class="o">*&gt;</span> <span class="n">vp_argv</span><span class="p">;</span>
    <span class="n">v_argv</span><span class="p">.</span><span class="n">reserve</span><span class="p">(</span><span class="n">argc</span><span class="p">);</span>
    <span class="n">vp_argv</span><span class="p">.</span><span class="n">reserve</span><span class="p">(</span><span class="n">argc</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">argc</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">v_argv</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="n">Py_DecodeLocale</span><span class="p">(</span><span class="n">_argv</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="nb">NULL</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">PyMem_RawFree</span><span class="p">);</span>
        <span class="n">vp_argv</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="n">v_argv</span><span class="p">.</span><span class="n">back</span><span class="p">().</span><span class="n">get</span><span class="p">());</span>
    <span class="p">}</span>
    
    <span class="kt">wchar_t</span> <span class="o">**</span><span class="n">argv</span> <span class="o">=</span> <span class="n">vp_argv</span><span class="p">.</span><span class="n">data</span><span class="p">();</span>
<span class="cp">#else
</span>    <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span> <span class="o">=</span> <span class="n">_argv</span><span class="p">;</span>
<span class="cp">#endif
</span>
    <span class="n">PySys_SetArgv</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">);</span>
        
    <span class="c1">// We have to set things up in the special __main__ module</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">module</span> <span class="o">=</span> <span class="n">PyImport_AddModule</span><span class="p">(</span><span class="n">PyCC</span><span class="p">(</span><span class="s">"__main__"</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">module</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
        <span class="n">panic</span><span class="p">(</span><span class="s">"Could not import __main__"</span><span class="p">);</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">dict</span> <span class="o">=</span> <span class="n">PyModule_GetDict</span><span class="p">(</span><span class="n">module</span><span class="p">);</span>

    <span class="c1">// import the main m5 module</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">result</span><span class="p">;</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">command</span> <span class="o">=</span> <span class="n">m5MainCommands</span><span class="p">;</span>

    <span class="c1">// evaluate each command in the m5MainCommands array (basically a</span>
    <span class="c1">// bunch of Python statements.</span>
    <span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">command</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">PyRun_String</span><span class="p">(</span><span class="o">*</span><span class="n">command</span><span class="p">,</span> <span class="n">Py_file_input</span><span class="p">,</span> <span class="n">dict</span><span class="p">,</span> <span class="n">dict</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">PyErr_Print</span><span class="p">();</span>
            <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">Py_DECREF</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>

        <span class="n">command</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>

<span class="cp">#if HAVE_PROTOBUF
</span>    <span class="n">google</span><span class="o">::</span><span class="n">protobuf</span><span class="o">::</span><span class="n">ShutdownProtobufLibrary</span><span class="p">();</span>
<span class="cp">#endif
</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>
<p>To transfer execution control to Python code, it invokes 
<a href="https://docs.Python.org/3/c-api/veryhigh.html">PyRun_String</a>.
PyRun_String is a function in the Python C API that allows you to execute a 
Python code snippet from a C program. It takes a string containing the Python 
code as one of its arguments and executes it within the Python interpreter.
As depicted in the above CPP string, m5MainCommands, it will invoks m5.main 
through PyRun_String.</p>

<h3 id="gem5-m5-main-python-code"><span class="me-2">GEM5 m5 main Python code</span><a href="#gem5-m5-main-python-code" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<blockquote class="prompt-info">
  <p>From this part, the execution is transferred to Python.</p>
</blockquote>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
</pre></td><td class="rouge-code"><pre><span class="o">//</span><span class="n">src</span><span class="o">/</span><span class="n">Python</span><span class="o">/</span><span class="n">m5</span><span class="o">/</span><span class="n">main</span><span class="p">.</span><span class="n">py</span> 

<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="kn">import</span> <span class="n">m5</span>
    
    <span class="kn">from</span> <span class="n">.</span> <span class="kn">import</span> <span class="n">core</span>
    <span class="kn">from</span> <span class="n">.</span> <span class="kn">import</span> <span class="n">debug</span>
    <span class="kn">from</span> <span class="n">.</span> <span class="kn">import</span> <span class="n">defines</span>
    <span class="kn">from</span> <span class="n">.</span> <span class="kn">import</span> <span class="n">event</span>
    <span class="kn">from</span> <span class="n">.</span> <span class="kn">import</span> <span class="n">info</span>
    <span class="kn">from</span> <span class="n">.</span> <span class="kn">import</span> <span class="n">stats</span>
    <span class="kn">from</span> <span class="n">.</span> <span class="kn">import</span> <span class="n">trace</span>
    
    <span class="kn">from</span> <span class="n">.util</span> <span class="kn">import</span> <span class="n">inform</span><span class="p">,</span> <span class="n">fatal</span><span class="p">,</span> <span class="n">panic</span><span class="p">,</span> <span class="n">isInteractive</span>
    <span class="kn">from</span> <span class="n">m5.util.terminal_formatter</span> <span class="kn">import</span> <span class="n">TerminalFormatter</span>
    
    <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">options</span><span class="p">,</span> <span class="n">arguments</span> <span class="o">=</span> <span class="nf">parse_options</span><span class="p">()</span>
    <span class="k">elif</span> <span class="nf">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">options</span><span class="p">,</span> <span class="n">arguments</span> <span class="o">=</span> <span class="n">args</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nc">TypeError</span><span class="p">(</span><span class="sh">"</span><span class="s">main() takes 0 or 2 arguments (%d given)</span><span class="sh">"</span> <span class="o">%</span> <span class="nf">len</span><span class="p">(</span><span class="n">args</span><span class="p">))</span>
    
    <span class="n">m5</span><span class="p">.</span><span class="n">options</span> <span class="o">=</span> <span class="n">options</span>
    
    <span class="c1"># Set the main event queue for the main thread.
</span>    <span class="n">event</span><span class="p">.</span><span class="n">mainq</span> <span class="o">=</span> <span class="n">event</span><span class="p">.</span><span class="nf">getEventQueue</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">event</span><span class="p">.</span><span class="nf">setEventQueue</span><span class="p">(</span><span class="n">event</span><span class="p">.</span><span class="n">mainq</span><span class="p">)</span>
    <span class="p">...</span><span class="bp">...</span>
    <span class="n">sys</span><span class="p">.</span><span class="n">argv</span> <span class="o">=</span> <span class="n">arguments</span>
    <span class="n">sys</span><span class="p">.</span><span class="n">path</span> <span class="o">=</span> <span class="p">[</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">dirname</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">]</span> <span class="o">+</span> <span class="n">sys</span><span class="p">.</span><span class="n">path</span>

    <span class="n">filename</span> <span class="o">=</span> <span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">filedata</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="sh">'</span><span class="s">r</span><span class="sh">'</span><span class="p">).</span><span class="nf">read</span><span class="p">()</span>
    <span class="n">filecode</span> <span class="o">=</span> <span class="nf">compile</span><span class="p">(</span><span class="n">filedata</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="sh">'</span><span class="s">exec</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">scope</span> <span class="o">=</span> <span class="p">{</span> <span class="sh">'</span><span class="s">__file__</span><span class="sh">'</span> <span class="p">:</span> <span class="n">filename</span><span class="p">,</span>
              <span class="sh">'</span><span class="s">__name__</span><span class="sh">'</span> <span class="p">:</span> <span class="sh">'</span><span class="s">__m5_main__</span><span class="sh">'</span> <span class="p">}</span>
    <span class="k">if</span> <span class="n">options</span><span class="p">.</span><span class="n">pdb</span><span class="p">:</span>
        <span class="kn">import</span> <span class="n">pdb</span>
        <span class="kn">import</span> <span class="n">traceback</span>

        <span class="n">pdb</span> <span class="o">=</span> <span class="n">pdb</span><span class="p">.</span><span class="nc">Pdb</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">pdb</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">filecode</span><span class="p">,</span> <span class="n">scope</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">SystemExit</span><span class="p">:</span>
            <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">The program exited via sys.exit(). Exit status: </span><span class="sh">"</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="sh">'</span><span class="s"> </span><span class="sh">'</span><span class="p">)</span>
            <span class="nf">print</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="nf">exc_info</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">traceback</span><span class="p">.</span><span class="nf">print_exc</span><span class="p">()</span>
            <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Uncaught exception. Entering post mortem debugging</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">sys</span><span class="p">.</span><span class="nf">exc_info</span><span class="p">()[</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">while</span> <span class="n">t</span><span class="p">.</span><span class="n">tb_next</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">t</span><span class="p">.</span><span class="n">tb_next</span>
                <span class="n">pdb</span><span class="p">.</span><span class="nf">interaction</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">tb_frame</span><span class="p">,</span><span class="n">t</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nf">exec</span><span class="p">(</span><span class="n">filecode</span><span class="p">,</span> <span class="n">scope</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></div></div>

<p>There are two important initialization code in the above Python code: 
initializing main event queue and execute Python snippet originally provided 
to gem5.opt. The event queue will be covered in <a href="">another blog posting</a>.
You might remember that we have passed config script defining configuration 
of one platform we want to simulate. That Python script is passed to above 
Python code snippet through ‘sys.argv[0]’, and compiled and exec. 
Therefore, it will not return to CPP, but the execution control is transferred
to configuration Python script!</p>

<h2 id="python-configuration-to-cpp-implementation"><span class="me-2">Python configuration to CPP implementation!</span><a href="#python-configuration-to-cpp-implementation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<p>To understand how Python configuration script interacts with CPP implementation 
in simulating one architecture, I will pick very simple configuration script 
provided by GEM5.</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="rouge-code"><pre><span class="c1"># create the system we are going to simulate 
</span><span class="n">system</span> <span class="o">=</span> <span class="nc">System</span><span class="p">()</span> 

<span class="c1"># Create a simple CPU
</span><span class="n">system</span><span class="p">.</span><span class="n">cpu</span> <span class="o">=</span> <span class="nc">TimingSimpleCPU</span><span class="p">()</span>

<span class="c1"># Create a memory bus, a system crossbar, in this case
</span><span class="n">system</span><span class="p">.</span><span class="n">membus</span> <span class="o">=</span> <span class="nc">SystemXBar</span><span class="p">()</span>

<span class="c1"># Hook the CPU ports up to the membus
</span><span class="n">system</span><span class="p">.</span><span class="n">cpu</span><span class="p">.</span><span class="n">icache_port</span> <span class="o">=</span> <span class="n">system</span><span class="p">.</span><span class="n">membus</span><span class="p">.</span><span class="n">slave</span>
<span class="n">system</span><span class="p">.</span><span class="n">cpu</span><span class="p">.</span><span class="n">dcache_port</span> <span class="o">=</span> <span class="n">system</span><span class="p">.</span><span class="n">membus</span><span class="p">.</span><span class="n">slave</span>

<span class="c1"># Create a DDR3 memory controller and connect it to the membus
</span><span class="n">system</span><span class="p">.</span><span class="n">mem_ctrl</span> <span class="o">=</span> <span class="nc">MemCtrl</span><span class="p">()</span>
<span class="n">system</span><span class="p">.</span><span class="n">mem_ctrl</span><span class="p">.</span><span class="n">dram</span> <span class="o">=</span> <span class="nc">DDR3_1600_8x8</span><span class="p">()</span>
<span class="n">system</span><span class="p">.</span><span class="n">mem_ctrl</span><span class="p">.</span><span class="n">dram</span><span class="p">.</span><span class="nb">range</span> <span class="o">=</span> <span class="n">system</span><span class="p">.</span><span class="n">mem_ranges</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">system</span><span class="p">.</span><span class="n">mem_ctrl</span><span class="p">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">system</span><span class="p">.</span><span class="n">membus</span><span class="p">.</span><span class="n">master</span>
</pre></td></tr></tbody></table></code></div></div>

<p>In the Python configuration script above, it creates instances of the CPU, 
crossbar, and DRAM. Additionally, it establishes the connection between the CPU 
and memory via the crossbar. As previously explained, GEM5 represents each 
hardware component as a CPP class for simulation. Consequently, the 
configurations defined in Python for the simulated platform need to be translated
into CPP implementation to effectively simulate hardware logic. This involves 
transforming the hardware components and the interconnections between them.</p>

<h3 id="start-from-relevance-between-python-and-cpp-class"><span class="me-2">Start from relevance between python and CPP class</span><a href="#start-from-relevance-between-python-and-cpp-class" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>Currently, the instantiation process of CPP class objects by a Python class 
remains unclear. However, by examining the constructor function of the CPP class 
and the attributes of the Python class, we can make an informed assumption that 
the Python class is likely associated with the parameters needed for instantiating 
the CPP class object. Let’s explore this further!</p>

<blockquote class="prompt-info">
  <p>CPP implementation of System class</p>
</blockquote>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre></td><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">System</span><span class="p">(</span><span class="n">SimObject</span><span class="p">):</span>
    <span class="nb">type</span> <span class="o">=</span> <span class="sh">'</span><span class="s">System</span><span class="sh">'</span>
    <span class="n">cxx_header</span> <span class="o">=</span> <span class="sh">"</span><span class="s">sim/system.hh</span><span class="sh">"</span>
    <span class="n">system_port</span> <span class="o">=</span> <span class="nc">RequestPort</span><span class="p">(</span><span class="sh">"</span><span class="s">System port</span><span class="sh">"</span><span class="p">)</span>

    <span class="n">cxx_exports</span> <span class="o">=</span> <span class="p">[</span>
        <span class="nc">PyBindMethod</span><span class="p">(</span><span class="sh">"</span><span class="s">getMemoryMode</span><span class="sh">"</span><span class="p">),</span>
        <span class="nc">PyBindMethod</span><span class="p">(</span><span class="sh">"</span><span class="s">setMemoryMode</span><span class="sh">"</span><span class="p">),</span>
    <span class="p">]</span>

    <span class="n">memories</span> <span class="o">=</span> <span class="n">VectorParam</span><span class="p">.</span><span class="nc">AbstractMemory</span><span class="p">(</span><span class="n">Self</span><span class="p">.</span><span class="nb">all</span><span class="p">,</span>
                                          <span class="sh">"</span><span class="s">All memories in the system</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">mem_mode</span> <span class="o">=</span> <span class="n">Param</span><span class="p">.</span><span class="nc">MemoryMode</span><span class="p">(</span><span class="sh">'</span><span class="s">atomic</span><span class="sh">'</span><span class="p">,</span> <span class="sh">"</span><span class="s">The mode the memory system is in</span><span class="sh">"</span><span class="p">)</span>

    <span class="n">thermal_model</span> <span class="o">=</span> <span class="n">Param</span><span class="p">.</span><span class="nc">ThermalModel</span><span class="p">(</span><span class="n">NULL</span><span class="p">,</span> <span class="sh">"</span><span class="s">Thermal model</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">thermal_components</span> <span class="o">=</span> <span class="n">VectorParam</span><span class="p">.</span><span class="nc">SimObject</span><span class="p">([],</span>
            <span class="sh">"</span><span class="s">A collection of all thermal components in the system.</span><span class="sh">"</span><span class="p">)</span>

    <span class="c1"># When reserving memory on the host, we have the option of
</span>    <span class="c1"># reserving swap space or not (by passing MAP_NORESERVE to
</span>    <span class="c1"># mmap). By enabling this flag, we accommodate cases where a large
</span>    <span class="c1"># (but sparse) memory is simulated.
</span>    <span class="n">mmap_using_noreserve</span> <span class="o">=</span> <span class="n">Param</span><span class="p">.</span><span class="nc">Bool</span><span class="p">(</span><span class="bp">False</span><span class="p">,</span> <span class="sh">"</span><span class="s">mmap the backing store </span><span class="sh">"</span> \
                                          <span class="sh">"</span><span class="s">without reserving swap</span><span class="sh">"</span><span class="p">)</span>

    <span class="c1"># The memory ranges are to be populated when creating the system
</span>    <span class="c1"># such that these can be passed from the I/O subsystem through an
</span>    <span class="c1"># I/O bridge or cache
</span>    <span class="n">mem_ranges</span> <span class="o">=</span> <span class="n">VectorParam</span><span class="p">.</span><span class="nc">AddrRange</span><span class="p">([],</span> <span class="sh">"</span><span class="s">Ranges that constitute main memory</span><span class="sh">"</span><span class="p">)</span>

    <span class="n">shared_backstore</span> <span class="o">=</span> <span class="n">Param</span><span class="p">.</span><span class="nc">String</span><span class="p">(</span><span class="sh">""</span><span class="p">,</span> <span class="sh">"</span><span class="s">backstore</span><span class="sh">'</span><span class="s">s shmem segment filename, </span><span class="sh">"</span>
        <span class="sh">"</span><span class="s">use to directly address the backstore from another host-OS process. </span><span class="sh">"</span>
        <span class="sh">"</span><span class="s">Leave this empty to unset the MAP_SHARED flag.</span><span class="sh">"</span><span class="p">)</span>

    <span class="n">cache_line_size</span> <span class="o">=</span> <span class="n">Param</span><span class="p">.</span><span class="nc">Unsigned</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="sh">"</span><span class="s">Cache line size in bytes</span><span class="sh">"</span><span class="p">)</span>
    <span class="p">...</span><span class="bp">...</span>
</pre></td></tr></tbody></table></code></div></div>

<blockquote>
  <p>Python implementation of System class</p>
  <div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre></td><td class="rouge-code"><pre><span class="n">System</span><span class="o">::</span><span class="n">System</span><span class="p">(</span><span class="n">Params</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
    <span class="o">:</span> <span class="n">SimObject</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="n">_systemPort</span><span class="p">(</span><span class="s">"system_port"</span><span class="p">,</span> <span class="k">this</span><span class="p">),</span>
      <span class="n">multiThread</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">multi_thread</span><span class="p">),</span>
      <span class="n">pagePtr</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
      <span class="n">init_param</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">init_param</span><span class="p">),</span>
      <span class="n">physProxy</span><span class="p">(</span><span class="n">_systemPort</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">cache_line_size</span><span class="p">),</span>
      <span class="n">workload</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">workload</span><span class="p">),</span>
<span class="cp">#if USE_KVM
</span>      <span class="n">kvmVM</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">kvm_vm</span><span class="p">),</span>
<span class="cp">#else
</span>      <span class="n">kvmVM</span><span class="p">(</span><span class="nb">nullptr</span><span class="p">),</span>
<span class="cp">#endif
</span>      <span class="n">physmem</span><span class="p">(</span><span class="n">name</span><span class="p">()</span> <span class="o">+</span> <span class="s">".physmem"</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">memories</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">mmap_using_noreserve</span><span class="p">,</span>
              <span class="n">p</span><span class="o">-&gt;</span><span class="n">shared_backstore</span><span class="p">),</span>
      <span class="n">memoryMode</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">mem_mode</span><span class="p">),</span>
      <span class="n">_cacheLineSize</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">cache_line_size</span><span class="p">),</span>
      <span class="n">workItemsBegin</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
      <span class="n">workItemsEnd</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
      <span class="n">numWorkIds</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">num_work_ids</span><span class="p">),</span>
      <span class="n">thermalModel</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">thermal_model</span><span class="p">),</span>
      <span class="n">_params</span><span class="p">(</span><span class="n">p</span><span class="p">),</span>
      <span class="n">_m5opRange</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">m5ops_base</span> <span class="o">?</span>
                 <span class="n">RangeSize</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">m5ops_base</span><span class="p">,</span> <span class="mh">0x10000</span><span class="p">)</span> <span class="o">:</span>
                 <span class="n">AddrRange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span> <span class="c1">// Create an empty range if disabled</span>
      <span class="n">totalNumInsts</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
      <span class="n">redirectPaths</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">redirect_paths</span><span class="p">)</span>
<span class="p">{</span>
</pre></td></tr></tbody></table></code></div>  </div>
</blockquote>

<p>As an illustration, consider the attribute “cache_line_size” within the Python 
class. This attribute not only exists within the Python class but is also employed
to initialize a _cacheLineSize member field of the CPP System class. Note that 
this attribute is accessed through the Param struct, which encapsulates all the 
configuration details of the hardware module necessary for instantiating it as a 
CPP class object.</p>

<h3 id="automatic-param-generation"><span class="me-2">Automatic Param generation</span><a href="#automatic-param-generation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>From the example, you might grab the idea of python script. It provides hardware 
configurations to instantiate hardware component for simulation! As each hardware
component may need distinctive configurations, like cache line size or the number 
of buffer entries, Python classes gather all pertinent hardware configuration 
details and transmit them to the CPP implementation through the Param struct.
Nevertheless, the CPP Param struct passed to the System constructor is not 
explicitly present in the codebase. This absence is attributed to the automatic 
generation of the Param struct for instantiating the System class object, 
transitioning seamlessly from Python class to CPP struct. Let’s examine the 
the automatically generated struct to gain a comprehensive understanding.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre></td><td class="rouge-code"><pre><span class="k">struct</span> <span class="nc">SystemParams</span>
    <span class="o">:</span> <span class="k">public</span> <span class="n">SimObjectParams</span>
<span class="p">{</span>
    <span class="n">System</span> <span class="o">*</span> <span class="n">create</span><span class="p">();</span>
    <span class="n">ByteOrder</span> <span class="n">byte_order</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="n">cache_line_size</span><span class="p">;</span>
    <span class="kt">bool</span> <span class="n">exit_on_work_items</span><span class="p">;</span>
    <span class="kt">uint64_t</span> <span class="n">init_param</span><span class="p">;</span>
    <span class="n">KvmVM</span> <span class="o">*</span> <span class="n">kvm_vm</span><span class="p">;</span>
    <span class="n">Addr</span> <span class="n">m5ops_base</span><span class="p">;</span>
    <span class="n">Enums</span><span class="o">::</span><span class="n">MemoryMode</span> <span class="n">mem_mode</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span> <span class="n">AddrRange</span> <span class="o">&gt;</span> <span class="n">mem_ranges</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span> <span class="n">AbstractMemory</span> <span class="o">*</span> <span class="o">&gt;</span> <span class="n">memories</span><span class="p">;</span>
    <span class="kt">bool</span> <span class="n">mmap_using_noreserve</span><span class="p">;</span>
    <span class="kt">bool</span> <span class="n">multi_thread</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">num_work_ids</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">readfile</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span> <span class="n">RedirectPath</span> <span class="o">*</span> <span class="o">&gt;</span> <span class="n">redirect_paths</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">shared_backstore</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">symbolfile</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span> <span class="n">SimObject</span> <span class="o">*</span> <span class="o">&gt;</span> <span class="n">thermal_components</span><span class="p">;</span>
    <span class="n">ThermalModel</span> <span class="o">*</span> <span class="n">thermal_model</span><span class="p">;</span>
    <span class="n">Counter</span> <span class="n">work_begin_ckpt_count</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">work_begin_cpu_id_exit</span><span class="p">;</span>
    <span class="n">Counter</span> <span class="n">work_begin_exit_count</span><span class="p">;</span>
    <span class="n">Counter</span> <span class="n">work_cpus_ckpt_count</span><span class="p">;</span>
    <span class="n">Counter</span> <span class="n">work_end_ckpt_count</span><span class="p">;</span>
    <span class="n">Counter</span> <span class="n">work_end_exit_count</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">work_item_id</span><span class="p">;</span>
    <span class="n">Workload</span> <span class="o">*</span> <span class="n">workload</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">port_system_port_connection_count</span><span class="p">;</span>
<span class="p">};</span>
</pre></td></tr></tbody></table></code></div></div>

<p>The SystemParams struct is automatically created and supplied to the constructor
of the System class, facilitating the initialization of hardware parameters for 
the System component. Furthermore, the generated struct contains member fields 
that correspond to certain attributes of the System class in Python. I will 
explain which attributes of the python classes can be translated into CPP counter
parts soon. Please bear with me!</p>

<h4 id="automatic-pybind-generation"><span class="me-2">Automatic pybind generation</span><a href="#automatic-pybind-generation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4>
<p>As the generated struct is implemented in CPP, it needs to be exported to Python
so that it can configure the parameters based on the information provided by the
Python configuration script.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
</pre></td><td class="rouge-code"><pre><span class="k">static</span> <span class="kt">void</span>
<span class="nf">module_init</span><span class="p">(</span><span class="n">py</span><span class="o">::</span><span class="n">module</span> <span class="o">&amp;</span><span class="n">m_internal</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">py</span><span class="o">::</span><span class="n">module</span> <span class="n">m</span> <span class="o">=</span> <span class="n">m_internal</span><span class="p">.</span><span class="n">def_submodule</span><span class="p">(</span><span class="s">"param_System"</span><span class="p">);</span>
    <span class="n">py</span><span class="o">::</span><span class="n">class_</span><span class="o">&lt;</span><span class="n">SystemParams</span><span class="p">,</span> <span class="n">SimObjectParams</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">SystemParams</span><span class="p">,</span> <span class="n">py</span><span class="o">::</span><span class="n">nodelete</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">"SystemParams"</span><span class="p">)</span>
        <span class="p">.</span><span class="n">def</span><span class="p">(</span><span class="n">py</span><span class="o">::</span><span class="n">init</span><span class="o">&lt;&gt;</span><span class="p">())</span>
        <span class="p">.</span><span class="n">def</span><span class="p">(</span><span class="s">"create"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SystemParams</span><span class="o">::</span><span class="n">create</span><span class="p">)</span>
        <span class="p">.</span><span class="n">def_readwrite</span><span class="p">(</span><span class="s">"byte_order"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SystemParams</span><span class="o">::</span><span class="n">byte_order</span><span class="p">)</span>
        <span class="p">.</span><span class="n">def_readwrite</span><span class="p">(</span><span class="s">"cache_line_size"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SystemParams</span><span class="o">::</span><span class="n">cache_line_size</span><span class="p">)</span>
        <span class="p">.</span><span class="n">def_readwrite</span><span class="p">(</span><span class="s">"exit_on_work_items"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SystemParams</span><span class="o">::</span><span class="n">exit_on_work_items</span><span class="p">)</span>
        <span class="p">.</span><span class="n">def_readwrite</span><span class="p">(</span><span class="s">"init_param"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SystemParams</span><span class="o">::</span><span class="n">init_param</span><span class="p">)</span>
        <span class="p">.</span><span class="n">def_readwrite</span><span class="p">(</span><span class="s">"kvm_vm"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SystemParams</span><span class="o">::</span><span class="n">kvm_vm</span><span class="p">)</span>
        <span class="p">.</span><span class="n">def_readwrite</span><span class="p">(</span><span class="s">"m5ops_base"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SystemParams</span><span class="o">::</span><span class="n">m5ops_base</span><span class="p">)</span>
        <span class="p">.</span><span class="n">def_readwrite</span><span class="p">(</span><span class="s">"mem_mode"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SystemParams</span><span class="o">::</span><span class="n">mem_mode</span><span class="p">)</span>
        <span class="p">.</span><span class="n">def_readwrite</span><span class="p">(</span><span class="s">"mem_ranges"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SystemParams</span><span class="o">::</span><span class="n">mem_ranges</span><span class="p">)</span>
        <span class="p">.</span><span class="n">def_readwrite</span><span class="p">(</span><span class="s">"memories"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SystemParams</span><span class="o">::</span><span class="n">memories</span><span class="p">)</span>
        <span class="p">.</span><span class="n">def_readwrite</span><span class="p">(</span><span class="s">"mmap_using_noreserve"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SystemParams</span><span class="o">::</span><span class="n">mmap_using_noreserve</span><span class="p">)</span>
        <span class="p">.</span><span class="n">def_readwrite</span><span class="p">(</span><span class="s">"multi_thread"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SystemParams</span><span class="o">::</span><span class="n">multi_thread</span><span class="p">)</span>
        <span class="p">.</span><span class="n">def_readwrite</span><span class="p">(</span><span class="s">"num_work_ids"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SystemParams</span><span class="o">::</span><span class="n">num_work_ids</span><span class="p">)</span>
        <span class="p">.</span><span class="n">def_readwrite</span><span class="p">(</span><span class="s">"readfile"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SystemParams</span><span class="o">::</span><span class="n">readfile</span><span class="p">)</span>
        <span class="p">.</span><span class="n">def_readwrite</span><span class="p">(</span><span class="s">"redirect_paths"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SystemParams</span><span class="o">::</span><span class="n">redirect_paths</span><span class="p">)</span>
        <span class="p">.</span><span class="n">def_readwrite</span><span class="p">(</span><span class="s">"shared_backstore"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SystemParams</span><span class="o">::</span><span class="n">shared_backstore</span><span class="p">)</span>
        <span class="p">.</span><span class="n">def_readwrite</span><span class="p">(</span><span class="s">"symbolfile"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SystemParams</span><span class="o">::</span><span class="n">symbolfile</span><span class="p">)</span>
        <span class="p">.</span><span class="n">def_readwrite</span><span class="p">(</span><span class="s">"thermal_components"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SystemParams</span><span class="o">::</span><span class="n">thermal_components</span><span class="p">)</span>
        <span class="p">.</span><span class="n">def_readwrite</span><span class="p">(</span><span class="s">"thermal_model"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SystemParams</span><span class="o">::</span><span class="n">thermal_model</span><span class="p">)</span>
        <span class="p">.</span><span class="n">def_readwrite</span><span class="p">(</span><span class="s">"work_begin_ckpt_count"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SystemParams</span><span class="o">::</span><span class="n">work_begin_ckpt_count</span><span class="p">)</span>
        <span class="p">.</span><span class="n">def_readwrite</span><span class="p">(</span><span class="s">"work_begin_cpu_id_exit"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SystemParams</span><span class="o">::</span><span class="n">work_begin_cpu_id_exit</span><span class="p">)</span>
        <span class="p">.</span><span class="n">def_readwrite</span><span class="p">(</span><span class="s">"work_begin_exit_count"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SystemParams</span><span class="o">::</span><span class="n">work_begin_exit_count</span><span class="p">)</span>
        <span class="p">.</span><span class="n">def_readwrite</span><span class="p">(</span><span class="s">"work_cpus_ckpt_count"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SystemParams</span><span class="o">::</span><span class="n">work_cpus_ckpt_count</span><span class="p">)</span>
        <span class="p">.</span><span class="n">def_readwrite</span><span class="p">(</span><span class="s">"work_end_ckpt_count"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SystemParams</span><span class="o">::</span><span class="n">work_end_ckpt_count</span><span class="p">)</span>
        <span class="p">.</span><span class="n">def_readwrite</span><span class="p">(</span><span class="s">"work_end_exit_count"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SystemParams</span><span class="o">::</span><span class="n">work_end_exit_count</span><span class="p">)</span>
        <span class="p">.</span><span class="n">def_readwrite</span><span class="p">(</span><span class="s">"work_item_id"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SystemParams</span><span class="o">::</span><span class="n">work_item_id</span><span class="p">)</span>
        <span class="p">.</span><span class="n">def_readwrite</span><span class="p">(</span><span class="s">"workload"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SystemParams</span><span class="o">::</span><span class="n">workload</span><span class="p">)</span>
        <span class="p">.</span><span class="n">def_readwrite</span><span class="p">(</span><span class="s">"port_system_port_connection_count"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SystemParams</span><span class="o">::</span><span class="n">port_system_port_connection_count</span><span class="p">)</span>
        <span class="p">;</span>

    <span class="n">py</span><span class="o">::</span><span class="n">class_</span><span class="o">&lt;</span><span class="n">System</span><span class="p">,</span> <span class="n">SimObject</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">System</span><span class="p">,</span> <span class="n">py</span><span class="o">::</span><span class="n">nodelete</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">"System"</span><span class="p">)</span>
        <span class="p">.</span><span class="n">def</span><span class="p">(</span><span class="s">"getMemoryMode"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">System</span><span class="o">::</span><span class="n">getMemoryMode</span><span class="p">)</span>
        <span class="p">.</span><span class="n">def</span><span class="p">(</span><span class="s">"setMemoryMode"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">System</span><span class="o">::</span><span class="n">setMemoryMode</span><span class="p">)</span>
        <span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="n">EmbeddedPyBind</span> <span class="nf">embed_obj</span><span class="p">(</span><span class="s">"System"</span><span class="p">,</span> <span class="n">module_init</span><span class="p">,</span> <span class="s">"SimObject"</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></div></div>

<p>As illustrated in the provided code, GEM5 automatically generates “module_init” 
function that utilizes the pybind library to export the automatically generated 
Param struct and its member fields to Python. Additionally, it creates an 
EmbeddedPyBind object to register the automatically generated module_init 
function to the object. 
The module_init function is responsible for exporting the CPP implementation to
Python, falling into the second category outlined in 
<a href="#pybind-initialization-for-hw-components">Pybind Initialization for HW components</a>.
Now you can understand why GEM5 main function exports the CPP implementation 
in two different ways.</p>

<h2 id="simobject-python-class"><span class="me-2">SimObject Python class</span><a href="#simobject-python-class" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<p>To understand how GEM5 automatically generate CPP Param struct and its pybind 
from Python classes, we should understand SimObject class and MetaSimObject 
metaclass. In GEM5, a SimObject represents a simulation entity and forms the 
basis for modeling components within the system being simulated. In other words, 
all system component related classes instantiated in the Python configuration 
script should be inherited from the SimObject class.</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="c1"># gem5/src/Python/m5/SimbObject.py
</span>
<span class="nd">@add_metaclass</span><span class="p">(</span><span class="n">MetaSimObject</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">SimObject</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="c1"># Specify metaclass.  Any class inheriting from SimObject will
</span>    <span class="c1"># get this metaclass.
</span>    <span class="nb">type</span> <span class="o">=</span> <span class="sh">'</span><span class="s">SimObject</span><span class="sh">'</span>
    <span class="n">abstract</span> <span class="o">=</span> <span class="bp">True</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Although SimObject is the fundamental building block of GEM5 simulation in 
defining hardware components, its metaclass, MetaSibObject is the most important
in terms of bridging Python to CPP.</p>

<h3 id="metasimobject-metaclass-of-simobject"><span class="me-2">MetaSimObject: metaclass of SimObject</span><a href="#metasimobject-metaclass-of-simobject" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>When one Python class has metaclass, functions defined in metaclass can 
pre-process newly defined class. For example, attributes of Python class having 
metaclass can be audited by metaclasss functions such as ‘<strong>init</strong>, <strong>new</strong> or, 
<strong>call</strong>’. Since metaclass can access class and its attributes (dictionary), it 
can modify or introduce particular attribute and logic during the class 
instantiation. For further details of metaclass, please refer to 
<a href="https://realPython.com/Python-metaclasses/">Python-metaclass</a>.</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="rouge-code"><pre><span class="c1">#src/Python/m5/SimObject.py
</span>
<span class="k">class</span> <span class="nc">MetaSimObject</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
    <span class="c1"># Attributes that can be set only at initialization time
</span>    <span class="n">init_keywords</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sh">'</span><span class="s">abstract</span><span class="sh">'</span> <span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">cxx_class</span><span class="sh">'</span> <span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">cxx_type</span><span class="sh">'</span> <span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">cxx_header</span><span class="sh">'</span> <span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">type</span><span class="sh">'</span> <span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">cxx_base</span><span class="sh">'</span> <span class="p">:</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nf">type</span><span class="p">(</span><span class="bp">None</span><span class="p">)),</span>
        <span class="sh">'</span><span class="s">cxx_extra_bases</span><span class="sh">'</span> <span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">cxx_exports</span><span class="sh">'</span> <span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">cxx_param_exports</span><span class="sh">'</span> <span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">cxx_template_params</span><span class="sh">'</span> <span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="c1"># Attributes that can be set any time
</span>    <span class="n">keywords</span> <span class="o">=</span> <span class="p">{</span> <span class="sh">'</span><span class="s">check</span><span class="sh">'</span> <span class="p">:</span> <span class="n">FunctionType</span> <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<h2 id="generate-cpp-param-struct-and-its-pybind"><span class="me-2">Generate CPP Param struct and its pybind</span><a href="#generate-cpp-param-struct-and-its-pybind" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<p>Examining the Python class for System reveals the presence of certain Python 
attributes unrelated to the CPP System class. Our task is to selectively filter 
out only those Python class attributes essential for instantiating their CPP 
class counterparts. If the notion of Python metaclass comes to mind, there’s no
need for an in-depth exploration. As mentioned earlier, Python metaclass provides
access to all attributes of a class that has it as a metaclass, making it an 
ideal location to efficiently <strong>filter and extract only the necessary attributes.</strong></p>

<p>Before delving into how the metaclass aids in filtering out only the relevant 
attributes from the Python class, let’s first examine the Python code responsible 
for automatically generating the Param struct. This will provide insight into 
which attributes of the Python classes need to be filtered out to generate CPP 
code. Given that many Python-based automatic code generation processes involve 
string manipulation and substitution, locating the function can be done by 
searching for relevant logic within the generated CPP code.</p>

<p><a name="cxx-param-decl"></a></p>
<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
</pre></td><td class="rouge-code"><pre>    <span class="k">def</span> <span class="nf">cxx_param_decl</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">code</span><span class="p">):</span>
        <span class="n">params</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">k_v</span><span class="p">:</span> <span class="n">k_v</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nf">sorted</span><span class="p">(</span><span class="n">cls</span><span class="p">.</span><span class="n">_params</span><span class="p">.</span><span class="n">local</span><span class="p">.</span><span class="nf">items</span><span class="p">())))</span>
        <span class="n">ports</span> <span class="o">=</span> <span class="n">cls</span><span class="p">.</span><span class="n">_ports</span><span class="p">.</span><span class="n">local</span>
        <span class="p">...</span><span class="bp">...</span>
        <span class="k">if</span> <span class="n">cls</span> <span class="o">==</span> <span class="n">SimObject</span><span class="p">:</span>
            <span class="nf">code</span><span class="p">(</span><span class="sh">'''</span><span class="s">#include &lt;string&gt;</span><span class="sh">'''</span><span class="p">)</span>
        
        <span class="n">cxx_class</span> <span class="o">=</span> <span class="nc">CxxClass</span><span class="p">(</span><span class="n">cls</span><span class="p">.</span><span class="n">_value_dict</span><span class="p">[</span><span class="sh">'</span><span class="s">cxx_class</span><span class="sh">'</span><span class="p">],</span>
                             <span class="n">cls</span><span class="p">.</span><span class="n">_value_dict</span><span class="p">[</span><span class="sh">'</span><span class="s">cxx_template_params</span><span class="sh">'</span><span class="p">])</span>
        
        <span class="c1"># A forward class declaration is sufficient since we are just
</span>        <span class="c1"># declaring a pointer.
</span>        <span class="n">cxx_class</span><span class="p">.</span><span class="nf">declare</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
            <span class="n">param</span><span class="p">.</span><span class="nf">cxx_predecls</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">port</span> <span class="ow">in</span> <span class="n">ports</span><span class="p">.</span><span class="nf">values</span><span class="p">():</span>
            <span class="n">port</span><span class="p">.</span><span class="nf">cxx_predecls</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
        <span class="nf">code</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">cls</span><span class="p">.</span><span class="n">_base</span><span class="p">:</span>
            <span class="nf">code</span><span class="p">(</span><span class="sh">'</span><span class="s">#include </span><span class="sh">"</span><span class="s">params/$.hh</span><span class="sh">"'</span><span class="p">)</span>
            <span class="nf">code</span><span class="p">()</span>
        
        <span class="k">for</span> <span class="n">ptype</span> <span class="ow">in</span> <span class="n">ptypes</span><span class="p">:</span>
            <span class="k">if</span> <span class="nf">issubclass</span><span class="p">(</span><span class="n">ptype</span><span class="p">,</span> <span class="n">Enum</span><span class="p">):</span>
                <span class="nf">code</span><span class="p">(</span><span class="sh">'</span><span class="s">#include </span><span class="sh">"</span><span class="s">enums/$.hh</span><span class="sh">"'</span><span class="p">)</span>
                <span class="nf">code</span><span class="p">()</span>
        
        <span class="c1"># now generate the actual param struct
</span>        <span class="nf">code</span><span class="p">(</span><span class="sh">"</span><span class="s">struct ${cls}Params</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cls</span><span class="p">.</span><span class="n">_base</span><span class="p">:</span>
            <span class="nf">code</span><span class="p">(</span><span class="sh">"</span><span class="s">    : public $Params</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">code</span><span class="p">(</span><span class="sh">"</span><span class="s">{</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="sh">'</span><span class="s">abstract</span><span class="sh">'</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">cls</span><span class="p">.</span><span class="n">abstract</span><span class="p">:</span>
            <span class="k">if</span> <span class="sh">'</span><span class="s">type</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">cls</span><span class="p">.</span><span class="n">__dict__</span><span class="p">:</span>
                <span class="nf">code</span><span class="p">(</span><span class="sh">"</span><span class="s">    $ create();</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="n">code</span><span class="p">.</span><span class="nf">indent</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">cls</span> <span class="o">==</span> <span class="n">SimObject</span><span class="p">:</span>
            <span class="nf">code</span><span class="p">(</span><span class="sh">'''</span><span class="s">
    SimObjectParams() {}
    virtual ~SimObjectParams() {}

    std::string name;
            </span><span class="sh">'''</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
            <span class="n">param</span><span class="p">.</span><span class="nf">cxx_decl</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">port</span> <span class="ow">in</span> <span class="n">ports</span><span class="p">.</span><span class="nf">values</span><span class="p">():</span>
            <span class="n">port</span><span class="p">.</span><span class="nf">cxx_decl</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
        
        <span class="n">code</span><span class="p">.</span><span class="nf">dedent</span><span class="p">()</span>
        <span class="nf">code</span><span class="p">(</span><span class="sh">'</span><span class="s">};</span><span class="sh">'</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></div></div>
<p>By comparing the code above with the automatically generated struct, it will 
become apparent which sections of the Python code correspond to the which parts
of the CPP implementation. Presented below is the Python code responsible for 
generating the CPP function (i.e., module_init) that exports the automatically 
generated struct to Python through pybind.</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
</pre></td><td class="rouge-code"><pre>    <span class="k">def</span> <span class="nf">pybind_predecls</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">code</span><span class="p">):</span>
        <span class="nf">code</span><span class="p">(</span><span class="sh">'</span><span class="s">#include </span><span class="sh">"</span><span class="s">$</span><span class="sh">"'</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">pybind_decl</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">code</span><span class="p">):</span>
        <span class="n">py_class_name</span> <span class="o">=</span> <span class="n">cls</span><span class="p">.</span><span class="n">pybind_class</span>
        
        <span class="c1"># The 'local' attribute restricts us to the params declared in
</span>        <span class="c1"># the object itself, not including inherited params (which
</span>        <span class="c1"># will also be inherited from the base class's param struct
</span>        <span class="c1"># here). Sort the params based on their key
</span>        <span class="n">params</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">k_v</span><span class="p">:</span> <span class="n">k_v</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nf">sorted</span><span class="p">(</span><span class="n">cls</span><span class="p">.</span><span class="n">_params</span><span class="p">.</span><span class="n">local</span><span class="p">.</span><span class="nf">items</span><span class="p">())))</span>
        <span class="n">ports</span> <span class="o">=</span> <span class="n">cls</span><span class="p">.</span><span class="n">_ports</span><span class="p">.</span><span class="n">local</span>
        
        <span class="nf">code</span><span class="p">(</span><span class="sh">'''</span><span class="s">#include </span><span class="sh">"</span><span class="s">pybind11/pybind11.h</span><span class="sh">"</span><span class="s">
#include </span><span class="sh">"</span><span class="s">pybind11/stl.h</span><span class="sh">"</span><span class="s">

#include </span><span class="sh">"</span><span class="s">params/$cls.hh</span><span class="sh">"</span><span class="s">
#include </span><span class="sh">"</span><span class="s">Python/pybind11/core.hh</span><span class="sh">"</span><span class="s">
#include </span><span class="sh">"</span><span class="s">sim/init.hh</span><span class="sh">"</span><span class="s">
#include </span><span class="sh">"</span><span class="s">sim/sim_object.hh</span><span class="sh">"</span><span class="s">

#include </span><span class="sh">"</span><span class="s">$</span><span class="sh">"</span><span class="s">

</span><span class="sh">'''</span><span class="p">)</span>    
        
        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
            <span class="n">param</span><span class="p">.</span><span class="nf">pybind_predecls</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
        
        <span class="nf">code</span><span class="p">(</span><span class="sh">'''</span><span class="s">namespace py = pybind11;

static void
module_init(py::module &amp;m_internal)
{
    py::module m = m_internal.def_submodule(</span><span class="sh">"</span><span class="s">param_${cls}</span><span class="sh">"</span><span class="s">);
</span><span class="sh">'''</span><span class="p">)</span>    
        <span class="n">code</span><span class="p">.</span><span class="nf">indent</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">cls</span><span class="p">.</span><span class="n">_base</span><span class="p">:</span>
            <span class="nf">code</span><span class="p">(</span><span class="sh">'</span><span class="s">py::class_&lt;${cls}Params, $Params, </span><span class="sh">'</span> \
                 <span class="sh">'</span><span class="s">std::unique_ptr&lt;$Params, py::nodelete&gt;&gt;(</span><span class="sh">'</span> \
                 <span class="sh">'</span><span class="s">m, </span><span class="sh">"</span><span class="s">${cls}Params</span><span class="sh">"</span><span class="s">)</span><span class="sh">'</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nf">code</span><span class="p">(</span><span class="sh">'</span><span class="s">py::class_&lt;${cls}Params, </span><span class="sh">'</span> \
                 <span class="sh">'</span><span class="s">std::unique_ptr&lt;${cls}Params, py::nodelete&gt;&gt;(</span><span class="sh">'</span> \
                 <span class="sh">'</span><span class="s">m, </span><span class="sh">"</span><span class="s">${cls}Params</span><span class="sh">"</span><span class="s">)</span><span class="sh">'</span><span class="p">)</span>
        
        <span class="n">code</span><span class="p">.</span><span class="nf">indent</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="sh">'</span><span class="s">abstract</span><span class="sh">'</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">cls</span><span class="p">.</span><span class="n">abstract</span><span class="p">:</span>
            <span class="nf">code</span><span class="p">(</span><span class="sh">'</span><span class="s">.def(py::init&lt;&gt;())</span><span class="sh">'</span><span class="p">)</span>
            <span class="nf">code</span><span class="p">(</span><span class="sh">'</span><span class="s">.def(</span><span class="sh">"</span><span class="s">create</span><span class="sh">"</span><span class="s">, &amp;${cls}Params::create)</span><span class="sh">'</span><span class="p">)</span>
        
        <span class="n">param_exports</span> <span class="o">=</span> <span class="n">cls</span><span class="p">.</span><span class="n">cxx_param_exports</span> <span class="o">+</span> <span class="p">[</span>
            <span class="nc">PyBindProperty</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nf">sorted</span><span class="p">(</span><span class="n">cls</span><span class="p">.</span><span class="n">_params</span><span class="p">.</span><span class="n">local</span><span class="p">.</span><span class="nf">items</span><span class="p">())</span>
        <span class="p">]</span> <span class="o">+</span> <span class="p">[</span>
            <span class="nc">PyBindProperty</span><span class="p">(</span><span class="sh">"</span><span class="s">port_%s_connection_count</span><span class="sh">"</span> <span class="o">%</span> <span class="n">port</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">port</span> <span class="ow">in</span> <span class="n">ports</span><span class="p">.</span><span class="nf">values</span><span class="p">()</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">exp</span> <span class="ow">in</span> <span class="n">param_exports</span><span class="p">:</span>
            <span class="n">exp</span><span class="p">.</span><span class="nf">export</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="sh">"</span><span class="s">%sParams</span><span class="sh">"</span> <span class="o">%</span> <span class="n">cls</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></div></div>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">PyBindProperty</span><span class="p">(</span><span class="n">PyBindExport</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">cxx_name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">writable</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cxx_name</span> <span class="o">=</span> <span class="n">cxx_name</span> <span class="k">if</span> <span class="n">cxx_name</span> <span class="k">else</span> <span class="n">name</span>
        <span class="n">self</span><span class="p">.</span><span class="n">writable</span> <span class="o">=</span> <span class="n">writable</span>
        
    <span class="k">def</span> <span class="nf">export</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">cname</span><span class="p">):</span>
        <span class="n">export</span> <span class="o">=</span> <span class="sh">"</span><span class="s">def_readwrite</span><span class="sh">"</span> <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">writable</span> <span class="k">else</span> <span class="sh">"</span><span class="s">def_readonly</span><span class="sh">"</span>
        <span class="nf">code</span><span class="p">(</span><span class="sh">'</span><span class="s">.${export}(</span><span class="sh">"</span><span class="s">$</span><span class="sh">"</span><span class="s">, &amp;${cname}::$)</span><span class="sh">'</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Upon a thorough comparison of the automatically generated code and the 
corresponding Python code, it becomes evident that attributes instantiated as 
instances of Port and Param play a crucial role in both generating the CPP 
implementation of the Param struct and facilitating its pybind integration.</p>

<h3 id="init-of-metasimobject"><span class="me-2"><strong>init</strong> of MetaSimObject</span><a href="#init-of-metasimobject" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>From the Python code template, it becomes clear that attributes related to Param 
and Port are crucial for automatically generating the Param struct and its pybind 
integration. The next step is to determine how to selectively filter out the
attributes relevant to Param and Port from the classes associated with each 
hardware component. This is where SimObject becomes useful. We will explore how 
a metaclass aids in filtering out attributes related to Param and Port from 
Python classes that inherit from SimObject.</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
</pre></td><td class="rouge-code"><pre>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>                                       
        <span class="nf">super</span><span class="p">(</span><span class="n">MetaSimObject</span><span class="p">,</span> <span class="n">cls</span><span class="p">).</span><span class="nf">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>                   
                                                                                
        <span class="c1"># initialize required attributes                                        
</span>                                                                                
        <span class="c1"># class-only attributes                                                 
</span>        <span class="n">cls</span><span class="p">.</span><span class="n">_params</span> <span class="o">=</span> <span class="nf">multidict</span><span class="p">()</span> <span class="c1"># param descriptions                          
</span>        <span class="n">cls</span><span class="p">.</span><span class="n">_ports</span> <span class="o">=</span> <span class="nf">multidict</span><span class="p">()</span>  <span class="c1"># port descriptions                           
</span>                                                                                
        <span class="n">cls</span><span class="p">.</span><span class="n">_deprecated_params</span> <span class="o">=</span> <span class="nf">multidict</span><span class="p">()</span>                                    
                                                                                
        <span class="c1"># class or instance attributes                                          
</span>        <span class="n">cls</span><span class="p">.</span><span class="n">_values</span> <span class="o">=</span> <span class="nf">multidict</span><span class="p">()</span>   <span class="c1"># param values                              
</span>        <span class="n">cls</span><span class="p">.</span><span class="n">_hr_values</span> <span class="o">=</span> <span class="nf">multidict</span><span class="p">()</span> <span class="c1"># human readable param values              
</span>        <span class="n">cls</span><span class="p">.</span><span class="n">_children</span> <span class="o">=</span> <span class="nf">multidict</span><span class="p">()</span> <span class="c1"># SimObject children                        
</span>        <span class="n">cls</span><span class="p">.</span><span class="n">_port_refs</span> <span class="o">=</span> <span class="nf">multidict</span><span class="p">()</span> <span class="c1"># port ref objects                         
</span>        <span class="n">cls</span><span class="p">.</span><span class="n">_instantiated</span> <span class="o">=</span> <span class="bp">False</span> <span class="c1"># really instantiated, cloned, or subclassed  
</span>                                                                                
        <span class="p">...</span><span class="bp">...</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">val</span> <span class="ow">in</span> <span class="n">cls</span><span class="p">.</span><span class="n">_value_dict</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>                                 
            <span class="c1"># param descriptions                                                
</span>            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">ParamDesc</span><span class="p">):</span>                                      
                <span class="n">cls</span><span class="p">.</span><span class="nf">_new_param</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>                                        
                                                                                
            <span class="c1"># port objects                                                      
</span>            <span class="k">elif</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">Port</span><span class="p">):</span>                                         
                <span class="n">cls</span><span class="p">.</span><span class="nf">_new_port</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>                                         
                                                                                
            <span class="c1"># Deprecated variable names                                         
</span>            <span class="k">elif</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">DeprecatedParam</span><span class="p">):</span>                              
                <span class="n">new_name</span><span class="p">,</span> <span class="n">new_val</span> <span class="o">=</span> <span class="n">cls</span><span class="p">.</span><span class="nf">_get_param_by_value</span><span class="p">(</span><span class="n">val</span><span class="p">.</span><span class="n">newParam</span><span class="p">)</span>       
                <span class="c1"># Note: We don't know the (string) name of this variable until  
</span>                <span class="c1"># here, so now we can finish setting up the dep_param.          
</span>                <span class="n">val</span><span class="p">.</span><span class="n">oldName</span> <span class="o">=</span> <span class="n">key</span>                                               
                <span class="n">val</span><span class="p">.</span><span class="n">newName</span> <span class="o">=</span> <span class="n">new_name</span>                                          
                <span class="n">cls</span><span class="p">.</span><span class="n">_deprecated_params</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>                               
                                                                                
            <span class="c1"># init-time-only keywords                                           
</span>            <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">cls</span><span class="p">.</span><span class="n">init_keywords</span><span class="p">:</span>                                      
                <span class="n">cls</span><span class="p">.</span><span class="nf">_set_keyword</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">cls</span><span class="p">.</span><span class="n">init_keywords</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>              
                                                                                
            <span class="c1"># default: use normal path (ends up in __setattr__)                 
</span>            <span class="k">else</span><span class="p">:</span>                                                               
                <span class="nf">setattr</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>     

</pre></td></tr></tbody></table></code></div></div>
<p>The MetaSimObject metaclass’s above <strong>init</strong> function is triggered for any Python 
classes inheriting SimObject, thanks to SimObject setting MetaSimObject as its 
metaclass. This function iterates through all attributes in the class and checks
if it is an instance of either ParamDesc or Port. Depending on the instance type, 
it invokes ‘_new_param’ or ‘new_port,’ placing the attribute in the ‘_params’ or 
‘_ports’ dictionary of the class. In essence, this process effectively filters 
out and organizes these two types of attributes in their respective dictionaries.</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre>    <span class="k">def</span> <span class="nf">_new_param</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">pdesc</span><span class="p">):</span>
        <span class="c1"># each param desc should be uniquely assigned to one variable
</span>        <span class="nf">assert</span><span class="p">(</span><span class="ow">not</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">pdesc</span><span class="p">,</span> <span class="sh">'</span><span class="s">name</span><span class="sh">'</span><span class="p">))</span>
        <span class="n">pdesc</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="n">cls</span><span class="p">.</span><span class="n">_params</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">pdesc</span>
        <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">pdesc</span><span class="p">,</span> <span class="sh">'</span><span class="s">default</span><span class="sh">'</span><span class="p">):</span>
            <span class="n">cls</span><span class="p">.</span><span class="nf">_set_param</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">pdesc</span><span class="p">.</span><span class="n">default</span><span class="p">,</span> <span class="n">pdesc</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_new_port</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">port</span><span class="p">):</span>
        <span class="c1"># each port should be uniquely assigned to one variable
</span>        <span class="nf">assert</span><span class="p">(</span><span class="ow">not</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="sh">'</span><span class="s">name</span><span class="sh">'</span><span class="p">))</span>
        <span class="n">port</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="n">cls</span><span class="p">.</span><span class="n">_ports</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">port</span>

</pre></td></tr></tbody></table></code></div></div>

<p>Upon revisiting the <a href="#generate-cpp-param-struct-and-its-pybind">code</a>, you can
discern the utilization of the newly introduced dictionaries as keys in
automatically generating the CPP implementation for the Param struct and its 
corresponding pybind code.</p>

<h3 id="type-sensitive-python-params"><span class="me-2">Type sensitive Python Params</span><a href="#type-sensitive-python-params" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>Python Param class is a placeholder for any parameter that should be translated 
into CPP from Python attribute. Compared with Python which doesn’t need a strict
type for attribute, CPP need clear and distinct type for all variables. Therefore,
to translate Python attribute to CPP variable, GEM5 should manage value and type
altogether, which is achieved by ParamDesc class.</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="c1"># Python/m5/params.py
</span>
<span class="k">class</span> <span class="nc">ParamDesc</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">cxx_decl</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">code</span><span class="p">):</span>
        <span class="nf">code</span><span class="p">(</span><span class="sh">'</span><span class="s">$ $;</span><span class="sh">'</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></div></div>

<p>The ‘cxx_decl’ method is called during GEM5’s process of automatically converting 
Python attributes (instances of ParamDesc) into CPP variables in the cxx_param_decl
function. As depicted in the code, it retrieves the CPP type from the
‘self.ptype.cxx_type’ and its name from ‘self.name’. We will take a look at how 
Param related python classes manages those two attributes. You might wonder why
it is ParamDesc not Param previously used to define attributes in Python class.</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">Param</span> <span class="o">=</span> <span class="nc">ParamFactory</span><span class="p">(</span><span class="n">ParamDesc</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></div></div>

<p>The trick is assigning another class ParamFactory to Param so that developer 
can easily instantiate ParamDesc object per attribute, required for generating 
CPP class parameter.</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">ParamFactory</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">param_desc_class</span><span class="p">,</span> <span class="n">ptype_str</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">param_desc_class</span> <span class="o">=</span> <span class="n">param_desc_class</span>
        <span class="n">self</span><span class="p">.</span><span class="n">ptype_str</span> <span class="o">=</span> <span class="n">ptype_str</span>
    
    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">ptype_str</span><span class="p">:</span>
            <span class="n">attr</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">ptype_str</span> <span class="o">+</span> <span class="sh">'</span><span class="s">.</span><span class="sh">'</span> <span class="o">+</span> <span class="n">attr</span>
        <span class="k">return</span> <span class="nc">ParamFactory</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">param_desc_class</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">ptype</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ptype</span> <span class="o">=</span> <span class="n">allParams</span><span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">ptype_str</span><span class="p">]</span>
        <span class="k">except</span> <span class="nb">KeyError</span><span class="p">:</span>
            <span class="c1"># if name isn't defined yet, assume it's a SimObject, and
</span>            <span class="c1"># try to resolve it later
</span>            <span class="k">pass</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="nf">param_desc_class</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">ptype_str</span><span class="p">,</span> <span class="n">ptype</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></div></div>

<p>As Python lacks a type that can directly correspond to C++ types on a one-to-one 
basis, it employs various Python classes to represent C++ types that the Param 
should be translated into. Let’s explore how the ParamFactory and ParamDesc can
be used to generate a Python class object representing specific C++ types.</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>    <span class="n">cache_line_size</span> <span class="o">=</span> <span class="n">Param</span><span class="p">.</span><span class="nc">Unsigned</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="sh">"</span><span class="s">Cache line size in bytes</span><span class="sh">"</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></div></div>

<p>The right-hand side of the assignment appears simple at first glance, but it 
involves multiple function invocations in detail. Initially, the interpretation 
of Param is as ParamFactory(ParamDesc), resulting in a ParamFactory object with 
‘param_desc_class’ set to ‘ParamDesc’. This returned object is then utilized to
access its ‘Unsigned’ attribute. As it defines the ‘<strong>getattr</strong>’ function, this 
function is invoked instead of directly accessing the ‘Unsigned’ attribute. 
Consequently, it generates another ParamFactory object with ‘param_desc_class’
set to ‘ParamDesc’ and ‘ptype_str’ set to ‘Unsigned’. The parentheses following 
the ParamFactory object are interpreted as a function call, leading to the 
invocation of the ‘<strong>call</strong>’ method. While allParams is not yet known, it returns
the class that matches ptype_str (‘Unsigned’). Subsequently, it returns a 
ParamDesc object initialized with “Unsigned” and the class matching with the 
pytype_str.</p>

<p>Then how GEM5 generates dictionary mapping ptype_str to class object
associated with the string? To manage allParams dictionary, GEM5 utilize another 
Python metaclass, MetaParamValue.</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">MetaParamValue</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="n">mcls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">dct</span><span class="p">):</span>
        <span class="n">cls</span> <span class="o">=</span> <span class="nf">super</span><span class="p">(</span><span class="n">MetaParamValue</span><span class="p">,</span> <span class="n">mcls</span><span class="p">).</span><span class="nf">__new__</span><span class="p">(</span><span class="n">mcls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">dct</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">allParams</span><span class="p">:</span>
            <span class="nf">warn</span><span class="p">(</span><span class="sh">"</span><span class="s">%s already exists in allParams. This may be caused by the </span><span class="sh">"</span> \
                 <span class="sh">"</span><span class="s">Python 2.7 compatibility layer.</span><span class="sh">"</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="p">))</span>
        <span class="n">allParams</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">cls</span>
        <span class="k">return</span> <span class="n">cls</span> 
</pre></td></tr></tbody></table></code></div></div>

<p>As shown in the ‘<strong>new</strong>’ function of the metaclass,it produces an ‘allParams’ 
dictionary that can be accessed using its class name and returns the corresponding 
class object. Consequently, Python classes intended for translating the ‘Param’
attribute to the appropriate CPP type implementation should designate 
‘MetaParamValue’ as their metaclass.</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre></td><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">Unsigned</span><span class="p">(</span><span class="n">CheckedInt</span><span class="p">):</span> <span class="n">cxx_type</span> <span class="o">=</span> <span class="sh">'</span><span class="s">unsigned</span><span class="sh">'</span><span class="p">;</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span> <span class="n">unsigned</span> <span class="o">=</span> <span class="bp">True</span>

<span class="k">class</span> <span class="nc">CheckedIntType</span><span class="p">(</span><span class="n">MetaParamValue</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">(</span><span class="n">CheckedIntType</span><span class="p">,</span> <span class="n">cls</span><span class="p">).</span><span class="nf">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
    
        <span class="c1"># CheckedInt is an abstract base class, so we actually don't
</span>        <span class="c1"># want to do any processing on it... the rest of this code is
</span>        <span class="c1"># just for classes that derive from CheckedInt.
</span>        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="sh">'</span><span class="s">CheckedInt</span><span class="sh">'</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nf">hasattr</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="sh">'</span><span class="s">min</span><span class="sh">'</span><span class="p">)</span> <span class="ow">and</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="sh">'</span><span class="s">max</span><span class="sh">'</span><span class="p">)):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nf">hasattr</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="sh">'</span><span class="s">size</span><span class="sh">'</span><span class="p">)</span> <span class="ow">and</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="sh">'</span><span class="s">unsigned</span><span class="sh">'</span><span class="p">)):</span>
                <span class="nf">panic</span><span class="p">(</span><span class="sh">"</span><span class="s">CheckedInt subclass %s must define either</span><span class="se">\n</span><span class="sh">"</span> \
                      <span class="sh">"</span><span class="s">    </span><span class="sh">'</span><span class="s">min</span><span class="sh">'</span><span class="s"> and </span><span class="sh">'</span><span class="s">max</span><span class="sh">'</span><span class="s"> or </span><span class="sh">'</span><span class="s">size</span><span class="sh">'</span><span class="s"> and </span><span class="sh">'</span><span class="s">unsigned</span><span class="sh">'</span><span class="se">\n</span><span class="sh">"</span><span class="p">,</span>
                      <span class="n">name</span><span class="p">);</span>
            <span class="k">if</span> <span class="n">cls</span><span class="p">.</span><span class="n">unsigned</span><span class="p">:</span>
                <span class="n">cls</span><span class="p">.</span><span class="nb">min</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">cls</span><span class="p">.</span><span class="nb">max</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">**</span> <span class="n">cls</span><span class="p">.</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cls</span><span class="p">.</span><span class="nb">min</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="p">(</span><span class="n">cls</span><span class="p">.</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
                <span class="n">cls</span><span class="p">.</span><span class="nb">max</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="p">(</span><span class="n">cls</span><span class="p">.</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span>

</pre></td></tr></tbody></table></code></div></div>

<p>As indicated in the class definition, the ‘Unsigned’ class inherits from 
‘CheckedIntType,’ which designates ‘MetaParamValue’ as its metaclass. 
Consequently, during the initialization of the ‘Unsigned’ class, it will call
the ‘<strong>new</strong>’ function of the ‘MetaParamValue’ metaclass, creating a mapping from
the string ‘Unsigned’ to the class object ‘Unsigned’ in the ‘allParams’.
Therefore, in the preceding code, the ‘ptype’ returned from ‘allParams’ should
be an object of the ‘Unsigned’ class. In summary, the RHS of the assignment 
will be</p>

<blockquote>
  <p>ParamDesc(“Unsigned”, Unsigned class object, *args, **kwargs)</p>
</blockquote>

<p>Therefore the cache_line_size will have the ParamDesc class object instantiated
by the code block.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">ParamDesc</span><span class="p">(</span><span class="n">object</span><span class="p">)</span><span class="o">:</span>
    <span class="n">def</span> <span class="n">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">ptype_str</span><span class="p">,</span> <span class="n">ptype</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span><span class="o">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">ptype_str</span> <span class="o">=</span> <span class="n">ptype_str</span>
        <span class="cp"># remember ptype only if it is provided
</span>        <span class="k">if</span> <span class="n">ptype</span> <span class="o">!=</span> <span class="n">None</span><span class="o">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">ptype</span> <span class="o">=</span> <span class="n">ptype</span>

        <span class="k">if</span> <span class="n">args</span><span class="o">:</span>
            <span class="k">if</span> <span class="n">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="o">:</span>
                <span class="n">self</span><span class="p">.</span><span class="n">desc</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">elif</span> <span class="n">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="o">:</span>
                <span class="n">self</span><span class="p">.</span><span class="k">default</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">self</span><span class="p">.</span><span class="n">desc</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="o">:</span>
                <span class="n">raise</span> <span class="n">TypeError</span><span class="p">(</span><span class="err">'</span><span class="n">too</span> <span class="n">many</span> <span class="n">arguments</span><span class="err">'</span><span class="p">)</span>
        <span class="p">......</span>
</pre></td></tr></tbody></table></code></div></div>

<p>The passed string and class object are stored in the ParamDesc attributes and 
will be used to generate the CPP type!</p>

<h2 id="python-port-describes-connectivity"><span class="me-2">Python Port describes connectivity</span><a href="#python-port-describes-connectivity" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<p>While going through Params and its pybind, you may have noticed that 
MetaSimObject filter out Port attributes from Python classes separately as well
as the ParamDesc instance. Given that GEM5 serves as a comprehensive system 
simulator, it necessitates not only diverse hardware elements like CPU and 
memory controllers that make up the platform but also the interconnecting wires
facilitating communication between these hardware components. Given that the 
communication medium functions as a hardware component, GEM5 simulates it just 
like any other hardware components in the system.</p>

<p>Moreover, as well as the Python classes are utilized to provide parameters of 
hardware components and instantiate the simulation for each hardware component 
implemented in CPP, the connectivity presented in Python code should be translated 
into CPP and generate connection between CPP class objects. Therefore, we need 
to understand how this transformation happens.</p>

<h3 id="how-python-script-establish-the-connection"><span class="me-2">How Python script establish the connection?</span><a href="#how-python-script-establish-the-connection" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>Let’s see how Python script generates connection between two different hardware
components through the port.</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="c1"># create the system we are going to simulate
</span><span class="n">system</span> <span class="o">=</span> <span class="nc">System</span><span class="p">()</span>

<span class="c1"># Create a memory bus, a system crossbar, in this case
</span><span class="n">system</span><span class="p">.</span><span class="n">membus</span> <span class="o">=</span> <span class="nc">SystemXBar</span><span class="p">()</span>

<span class="c1"># Connect the system up to the membus
</span><span class="n">system</span><span class="p">.</span><span class="n">system_port</span> <span class="o">=</span> <span class="n">system</span><span class="p">.</span><span class="n">membus</span><span class="p">.</span><span class="n">slave</span>
</pre></td></tr></tbody></table></code></div></div>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre></td><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">System</span><span class="p">(</span><span class="n">SimObject</span><span class="p">):</span>                                                        
    <span class="nb">type</span> <span class="o">=</span> <span class="sh">'</span><span class="s">System</span><span class="sh">'</span>                                                             
    <span class="n">cxx_header</span> <span class="o">=</span> <span class="sh">"</span><span class="s">sim/system.hh</span><span class="sh">"</span>                                                
    <span class="n">system_port</span> <span class="o">=</span> <span class="nc">RequestPort</span><span class="p">(</span><span class="sh">"</span><span class="s">System port</span><span class="sh">"</span><span class="p">)</span>   

<span class="k">class</span> <span class="nc">Port</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="p">...</span><span class="bp">...</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">role</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="n">is_source</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">desc</span> <span class="o">=</span> <span class="n">desc</span>
        <span class="n">self</span><span class="p">.</span><span class="n">role</span> <span class="o">=</span> <span class="n">role</span>
        <span class="n">self</span><span class="p">.</span><span class="n">is_source</span> <span class="o">=</span> <span class="n">is_source</span>
    <span class="p">...</span><span class="bp">...</span>


<span class="k">class</span> <span class="nc">RequestPort</span><span class="p">(</span><span class="n">Port</span><span class="p">):</span>
    <span class="c1"># RequestPort("description")
</span>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">desc</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">(</span><span class="n">RequestPort</span><span class="p">,</span> <span class="n">self</span><span class="p">).</span><span class="nf">__init__</span><span class="p">(</span>
                <span class="sh">'</span><span class="s">GEM5 REQUESTOR</span><span class="sh">'</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="n">is_source</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">ResponsePort</span><span class="p">(</span><span class="n">Port</span><span class="p">):</span>
    <span class="c1"># ResponsePort("description")
</span>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">desc</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">(</span><span class="n">ResponsePort</span><span class="p">,</span> <span class="n">self</span><span class="p">).</span><span class="nf">__init__</span><span class="p">(</span><span class="sh">'</span><span class="s">GEM5 RESPONDER</span><span class="sh">'</span><span class="p">,</span> <span class="n">desc</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></div></div>
<p>As illustrated in the Python script, it sets up the configuration for the System
and SystemXBar, creating a connection between them by linking the Response port 
(SystemXBar.slave) to the Request port (System.system_port). While this may 
appear as a straightforward assignment, there are intricate details underlying 
the support for Port assignment. To grasp this, it’s essential to recall that
all hardware component classes inherit from SimObject. The SimObject class 
defines the <strong>getattr</strong> and <strong>setattr</strong> functions to control attribute access
and assignment. Let’s delve into each of these details in turn.</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
</pre></td><td class="rouge-code"><pre>    <span class="k">def</span> <span class="nf">__setattr__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="c1"># normal processing for private attributes
</span>        <span class="k">if</span> <span class="n">attr</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">'</span><span class="s">_</span><span class="sh">'</span><span class="p">):</span>
            <span class="nb">object</span><span class="p">.</span><span class="nf">__setattr__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="k">return</span>
        
        <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_deprecated_params</span><span class="p">:</span>
            <span class="n">dep_param</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_deprecated_params</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
            <span class="n">dep_param</span><span class="p">.</span><span class="nf">printWarning</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">__class__</span><span class="p">.</span><span class="n">__name__</span><span class="p">)</span> 
            <span class="k">return</span> <span class="nf">setattr</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">_deprecated_params</span><span class="p">[</span><span class="n">attr</span><span class="p">].</span><span class="n">newName</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_ports</span><span class="p">:</span>
            <span class="c1"># set up port connection
</span>            <span class="n">self</span><span class="p">.</span><span class="nf">_get_port_ref</span><span class="p">(</span><span class="n">attr</span><span class="p">).</span><span class="nf">connect</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">return</span>
        
        <span class="n">param</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_params</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">param</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">hr_value</span> <span class="o">=</span> <span class="n">value</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">param</span><span class="p">.</span><span class="nf">convert</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sh">"</span><span class="s">%s</span><span class="se">\n</span><span class="s">Error setting param %s.%s to %s</span><span class="se">\n</span><span class="sh">"</span> <span class="o">%</span> \
                      <span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">__class__</span><span class="p">.</span><span class="n">__name__</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                <span class="n">e</span><span class="p">.</span><span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="p">)</span>
                <span class="k">raise</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_values</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="c1"># implicitly parent unparented objects assigned as params
</span>            <span class="k">if</span> <span class="nf">isSimObjectOrVector</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">value</span><span class="p">.</span><span class="nf">has_parent</span><span class="p">():</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">add_child</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="c1"># set the human-readable value dict if this is a param
</span>            <span class="c1"># with a literal value and is not being set as an object
</span>            <span class="c1"># or proxy.
</span>            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nf">isSimObjectOrVector</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="ow">or</span>\
                    <span class="nf">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">m5</span><span class="p">.</span><span class="n">proxy</span><span class="p">.</span><span class="n">BaseProxy</span><span class="p">)):</span>
                <span class="n">self</span><span class="p">.</span><span class="n">_hr_values</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">hr_value</span>
            
            <span class="k">return</span>
        
        <span class="c1"># if RHS is a SimObject, it's an implicit child assignment
</span>        <span class="k">if</span> <span class="nf">isSimObjectOrSequence</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">add_child</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="k">return</span>
        
        <span class="c1"># no valid assignment... raise exception
</span>        <span class="k">raise</span> <span class="nc">AttributeError</span><span class="p">(</span><span class="sh">"</span><span class="s">Class %s has no parameter %s</span><span class="sh">"</span> \
              <span class="o">%</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">__class__</span><span class="p">.</span><span class="n">__name__</span><span class="p">,</span> <span class="n">attr</span><span class="p">))</span>

</pre></td></tr></tbody></table></code></div></div>

<p>To understand the reference system.membus.slave, it’s crucial to grasp how membus 
becomes an attribute of the System. Given that there is no statically predefined 
attribute named membus in the System class, it is dynamically added to the System
class object during runtime. The <strong>setattr</strong> function in the SimObject class 
comes into play when a new attribute is introduced to the object. Since the added 
value is another SimObject class object obtained from SystemXBar(), it is treated
as a child of the System.</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre>    <span class="c1"># Add a new child to this object.
</span>    <span class="k">def</span> <span class="nf">add_child</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">child</span><span class="p">):</span>
        <span class="n">child</span> <span class="o">=</span> <span class="nf">coerceSimObjectOrVector</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">child</span><span class="p">.</span><span class="nf">has_parent</span><span class="p">():</span>
            <span class="nf">warn</span><span class="p">(</span><span class="sh">"</span><span class="s">add_child(</span><span class="sh">'</span><span class="s">%s</span><span class="sh">'</span><span class="s">): child </span><span class="sh">'</span><span class="s">%s</span><span class="sh">'</span><span class="s"> already has parent</span><span class="sh">"</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
                <span class="n">child</span><span class="p">.</span><span class="nf">get_name</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_children</span><span class="p">:</span>
            <span class="c1"># This code path had an undiscovered bug that would make it fail
</span>            <span class="c1"># at runtime. It had been here for a long time and was only
</span>            <span class="c1"># exposed by a buggy script. Changes here will probably not be
</span>            <span class="c1"># exercised without specialized testing.
</span>            <span class="n">self</span><span class="p">.</span><span class="nf">clear_child</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">child</span><span class="p">.</span><span class="nf">set_parent</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nf">isNullPointer</span><span class="p">(</span><span class="n">child</span><span class="p">):</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_children</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">child</span>
</pre></td></tr></tbody></table></code></div></div>
<p>Recall my earlier mention that SimObject can be structured hierarchically. 
Considering that the System class represents the entire simulated system, it 
follows logically that the crossbar connecting hardware components in the system
should be a child of the System. Now, let’s explore the outcome when attempting 
to access system.membus.slave!</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre></td><td class="rouge-code"><pre>    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_deprecated_params</span><span class="p">:</span>
            <span class="n">dep_param</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_deprecated_params</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
            <span class="n">dep_param</span><span class="p">.</span><span class="nf">printWarning</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">__class__</span><span class="p">.</span><span class="n">__name__</span><span class="p">)</span>
            <span class="k">return</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">_deprecated_params</span><span class="p">[</span><span class="n">attr</span><span class="p">].</span><span class="n">newName</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_ports</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="nf">_get_port_ref</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_values</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_values</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_children</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_children</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
        
        <span class="c1"># If the attribute exists on the C++ object, transparently
</span>        <span class="c1"># forward the reference there.  This is typically used for
</span>        <span class="c1"># methods exported to Python (e.g., init(), and startup())
</span>        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_ccObject</span> <span class="ow">and</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_ccObject</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
            <span class="k">return</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_ccObject</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
        
        <span class="n">err_string</span> <span class="o">=</span> <span class="sh">"</span><span class="s">object </span><span class="sh">'</span><span class="s">%s</span><span class="sh">'</span><span class="s"> has no attribute </span><span class="sh">'</span><span class="s">%s</span><span class="sh">'"</span> \
              <span class="o">%</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">__class__</span><span class="p">.</span><span class="n">__name__</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="n">_ccObject</span><span class="p">:</span>
            <span class="n">err_string</span> <span class="o">+=</span> <span class="sh">"</span><span class="se">\n</span><span class="s">  (C++ object is not yet constructed,</span><span class="sh">"</span> \
                          <span class="sh">"</span><span class="s"> so wrapped C++ methods are unavailable.)</span><span class="sh">"</span>
        
        <span class="k">raise</span> <span class="nc">AttributeError</span><span class="p">(</span><span class="n">err_string</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></div></div>

<p>The access is accomplished through two calls to the <code class="language-plaintext highlighter-rouge">__getattr__</code> method. It can
be conceptualized as ‘(system.membus).slave’. Since System is a SimObject, and
the SimObject class defines the <code class="language-plaintext highlighter-rouge">__getattr__</code> function, this function is
automatically invoked to access the <code class="language-plaintext highlighter-rouge">membus</code> attribute. As <code class="language-plaintext highlighter-rouge">membus</code> has been
registered as a child of the system, the SystemXBar class object is retrieved
first. Additionally, since it is a SimObject, when the <code class="language-plaintext highlighter-rouge">slave</code> attribute is
accessed, it triggers another <code class="language-plaintext highlighter-rouge">__getattr__</code> function. As the <code class="language-plaintext highlighter-rouge">slave</code> attribute is
declared as a Port in the BaseXBar class, which is the base Python class of
SystemXBar, it should have been filtered out as ‘_ports’ when the SystemXBar is
defined, thanks to the metaclass. Therefore, when an attribute related to Port
is accessed, it invokes ‘_get_port_ref’ to return a reference to that port.</p>

<h3 id="portref-connecting-two-end-ports"><span class="me-2">PortRef, connecting two end ports</span><a href="#portref-connecting-two-end-ports" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre>    <span class="n">def</span> <span class="n">_get_port_ref</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span><span class="o">:</span>
        <span class="cp"># Return reference that can be assigned to another port
</span>        <span class="cp"># via __setattr__.  There is only ever one reference
</span>        <span class="cp"># object per port, but we create them lazily here.
</span>        <span class="n">ref</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_port_refs</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ref</span> <span class="o">==</span> <span class="n">None</span><span class="o">:</span>
            <span class="n">ref</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_ports</span><span class="p">[</span><span class="n">attr</span><span class="p">].</span><span class="n">makeRef</span><span class="p">(</span><span class="n">self</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_port_refs</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">ref</span>
        <span class="k">return</span> <span class="n">ref</span> 
</pre></td></tr></tbody></table></code></div></div>

<p>SimObject has cache for reference of Port, self._port_refs. If it is the first
time to access this attribute, then the cache should be empty and will invoke
makeRef function of the system_port object.</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">Port</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>                                                             
    <span class="p">...</span><span class="bp">...</span>
    <span class="c1"># Port("role", "description") 
</span>    <span class="c1"># Generate a PortRef for this port on the given SimObject with the          
</span>    <span class="c1"># given name                                                                
</span>    <span class="k">def</span> <span class="nf">makeRef</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">simobj</span><span class="p">):</span>                                                  
        <span class="k">return</span> <span class="nc">PortRef</span><span class="p">(</span><span class="n">simobj</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">role</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">is_source</span><span class="p">)</span>  

</pre></td></tr></tbody></table></code></div></div>
<p>makeRef creates an instance of PortRef, where Port serves as a wrapper class 
that conveys information about the port, and the actual reference to the Port is
defined by the PortRef class. The retrieved PortRef instance is then stored in 
the ‘_ports’ attribute of the SimObject. This storage will later be employed to 
transfer the Python-presented connectivity between the hardware components to
C++. Regardless, the right-hand side of the assignment is transformed into an 
object of PortRef. Assigning it to ‘system.system_port’ on the left-hand side
triggers another ‘setattr’ within the SimObject!</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre>        <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_ports</span><span class="p">:</span>                                                 
            <span class="c1"># set up port connection                                            
</span>            <span class="n">self</span><span class="p">.</span><span class="nf">_get_port_ref</span><span class="p">(</span><span class="n">attr</span><span class="p">).</span><span class="nf">connect</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>                             
            <span class="k">return</span>                     
</pre></td></tr></tbody></table></code></div></div>
<p>At this point, since ‘system_port’ is an instance of a Port class, this attribute
must exist in the ‘_ports’ dictionary. When considering the assignment in terms 
of ports logically, it should establish a connection between two hardware
components. To accomplish this, it effectively invokes the ‘connect’ function!
Given that ‘_get_port_ref’ returns another PortRef for the ‘system_port’, it
proceeds to connect the PortRef of ‘system_port’ and ‘slave’.</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">PortRef</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span> 
    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">VectorPortRef</span><span class="p">):</span>
            <span class="c1"># reference to plain VectorPort is implicit append
</span>            <span class="n">other</span> <span class="o">=</span> <span class="n">other</span><span class="p">.</span><span class="nf">_get_next</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">peer</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">proxy</span><span class="p">.</span><span class="nf">isproxy</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">peer</span><span class="p">):</span>
            <span class="nf">fatal</span><span class="p">(</span><span class="sh">"</span><span class="s">Port %s is already connected to %s, cannot connect %s</span><span class="se">\n</span><span class="sh">"</span><span class="p">,</span>
                  <span class="n">self</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">peer</span><span class="p">,</span> <span class="n">other</span><span class="p">);</span>
        <span class="n">self</span><span class="p">.</span><span class="n">peer</span> <span class="o">=</span> <span class="n">other</span>

        <span class="k">if</span> <span class="n">proxy</span><span class="p">.</span><span class="nf">isproxy</span><span class="p">(</span><span class="n">other</span><span class="p">):</span>
            <span class="n">other</span><span class="p">.</span><span class="nf">set_param_desc</span><span class="p">(</span><span class="nc">PortParamDesc</span><span class="p">())</span>
            <span class="k">return</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">PortRef</span><span class="p">):</span>
            <span class="k">raise</span> <span class="nc">TypeError</span><span class="p">(</span><span class="sh">"</span><span class="s">assigning non-port reference </span><span class="sh">'</span><span class="s">%s</span><span class="sh">'</span><span class="s"> to port </span><span class="sh">'</span><span class="s">%s</span><span class="sh">'"</span> \
                  <span class="o">%</span> <span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">self</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">Port</span><span class="p">.</span><span class="nf">is_compat</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
            <span class="nf">fatal</span><span class="p">(</span><span class="sh">"</span><span class="s">Ports %s and %s with roles </span><span class="sh">'</span><span class="s">%s</span><span class="sh">'</span><span class="s"> and </span><span class="sh">'</span><span class="s">%s</span><span class="sh">'</span><span class="s"> </span><span class="sh">"</span>
                    <span class="sh">"</span><span class="s">are not compatible</span><span class="sh">"</span><span class="p">,</span> <span class="n">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">role</span><span class="p">,</span> <span class="n">other</span><span class="p">.</span><span class="n">role</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">other</span><span class="p">.</span><span class="n">peer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">self</span><span class="p">:</span>
            <span class="n">other</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">self</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></div></div>

<h2 id="sconscript-generating-files-for-cpp-implementation"><span class="me-2">SConscript: generating files for CPP implementation</span><a href="#sconscript-generating-files-for-cpp-implementation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<p>Now we can understand where the Python code is located and how the data required
for generating CPP implementation can be gathered from each Python class. Then,
some program should invoke the Python method to generate actual CPP and header
file containing automatically generated CPP implementation. That is done at the 
compile time by scone. SCons is a build automation tool that uses Python scripts
for configuration and build control.</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
</pre></td><td class="rouge-code"><pre><span class="c1"># gem5/src/SConscript
</span>
<span class="c1"># Generate all of the SimObject param C++ struct header files
</span><span class="n">params_hh_files</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">name</span><span class="p">,</span><span class="n">simobj</span> <span class="ow">in</span> <span class="nf">sorted</span><span class="p">(</span><span class="n">sim_objects</span><span class="p">.</span><span class="nf">items</span><span class="p">()):</span>
    <span class="c1"># If this simobject's source changes, we need to regenerate the header.
</span>    <span class="n">py_source</span> <span class="o">=</span> <span class="n">PySource</span><span class="p">.</span><span class="n">modules</span><span class="p">[</span><span class="n">simobj</span><span class="p">.</span><span class="n">__module__</span><span class="p">]</span>
    <span class="n">extra_deps</span> <span class="o">=</span> <span class="p">[</span> <span class="n">py_source</span><span class="p">.</span><span class="n">tnode</span> <span class="p">]</span>
    
    <span class="c1"># Get the params for just this SimObject, excluding base classes.
</span>    <span class="n">params</span> <span class="o">=</span> <span class="n">simobj</span><span class="p">.</span><span class="n">_params</span><span class="p">.</span><span class="n">local</span><span class="p">.</span><span class="nf">values</span><span class="p">()</span>
    <span class="c1"># Extract the parameters' c++ types.
</span>    <span class="n">types</span> <span class="o">=</span> <span class="nf">sorted</span><span class="p">(</span><span class="nf">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">p</span><span class="p">.</span><span class="n">ptype</span><span class="p">.</span><span class="n">cxx_type</span><span class="p">,</span> <span class="n">params</span><span class="p">))</span>
    <span class="c1"># If any of these types have changed, we need to regenerate the header.
</span>    <span class="n">extra_deps</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">Value</span><span class="p">(</span><span class="n">types</span><span class="p">))</span>
    
    <span class="n">hh_file</span> <span class="o">=</span> <span class="nc">File</span><span class="p">(</span><span class="sh">'</span><span class="s">params/%s.hh</span><span class="sh">'</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
    <span class="n">params_hh_files</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">hh_file</span><span class="p">)</span>
    <span class="n">env</span><span class="p">.</span><span class="nc">Command</span><span class="p">(</span><span class="n">hh_file</span><span class="p">,</span> <span class="nc">Value</span><span class="p">(</span><span class="n">name</span><span class="p">),</span>
                <span class="nc">MakeAction</span><span class="p">(</span><span class="n">createSimObjectParamStruct</span><span class="p">,</span> <span class="nc">Transform</span><span class="p">(</span><span class="sh">"</span><span class="s">SO PARAM</span><span class="sh">"</span><span class="p">)))</span>
    <span class="n">env</span><span class="p">.</span><span class="nc">Depends</span><span class="p">(</span><span class="n">hh_file</span><span class="p">,</span> <span class="n">depends</span> <span class="o">+</span> <span class="n">extra_deps</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">createSimObjectParamStruct</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">env</span><span class="p">):</span>
    <span class="k">assert</span> <span class="nf">len</span><span class="p">(</span><span class="n">target</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nf">len</span><span class="p">(</span><span class="n">source</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>

    <span class="n">name</span> <span class="o">=</span> <span class="n">source</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">get_text_contents</span><span class="p">()</span>
    <span class="n">obj</span> <span class="o">=</span> <span class="n">sim_objects</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

    <span class="n">code</span> <span class="o">=</span> <span class="nf">code_formatter</span><span class="p">()</span>
    <span class="n">obj</span><span class="p">.</span><span class="nf">cxx_param_decl</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
    <span class="n">code</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">target</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">abspath</span><span class="p">)</span>

<span class="c1"># Generate SimObject Python bindings wrapper files
</span><span class="k">if</span> <span class="n">env</span><span class="p">[</span><span class="sh">'</span><span class="s">USE_PYTHON</span><span class="sh">'</span><span class="p">]:</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span><span class="n">simobj</span> <span class="ow">in</span> <span class="nf">sorted</span><span class="p">(</span><span class="n">sim_objects</span><span class="p">.</span><span class="nf">iteritems</span><span class="p">()):</span>
        <span class="n">py_source</span> <span class="o">=</span> <span class="n">PySource</span><span class="p">.</span><span class="n">modules</span><span class="p">[</span><span class="n">simobj</span><span class="p">.</span><span class="n">__module__</span><span class="p">]</span>
        <span class="n">extra_deps</span> <span class="o">=</span> <span class="p">[</span> <span class="n">py_source</span><span class="p">.</span><span class="n">tnode</span> <span class="p">]</span>
        <span class="n">cc_file</span> <span class="o">=</span> <span class="nc">File</span><span class="p">(</span><span class="sh">'</span><span class="s">Python/_m5/param_%s.cc</span><span class="sh">'</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
        <span class="n">env</span><span class="p">.</span><span class="nc">Command</span><span class="p">(</span><span class="n">cc_file</span><span class="p">,</span> <span class="nc">Value</span><span class="p">(</span><span class="n">name</span><span class="p">),</span>
                    <span class="nc">MakeAction</span><span class="p">(</span><span class="n">createSimObjectPyBindWrapper</span><span class="p">,</span>
                               <span class="nc">Transform</span><span class="p">(</span><span class="sh">"</span><span class="s">SO PyBind</span><span class="sh">"</span><span class="p">)))</span>
        <span class="n">env</span><span class="p">.</span><span class="nc">Depends</span><span class="p">(</span><span class="n">cc_file</span><span class="p">,</span> <span class="n">depends</span> <span class="o">+</span> <span class="n">extra_deps</span><span class="p">)</span>
        <span class="nc">Source</span><span class="p">(</span><span class="n">cc_file</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">createSimObjectPyBindWrapper</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">env</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">source</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">get_text_contents</span><span class="p">()</span>
    <span class="n">obj</span> <span class="o">=</span> <span class="n">sim_objects</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

    <span class="n">code</span> <span class="o">=</span> <span class="nf">code_formatter</span><span class="p">()</span>
    <span class="n">obj</span><span class="p">.</span><span class="nf">pybind_decl</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
    <span class="n">code</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">target</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">abspath</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></div></div>

<p>When you take a look at the main SConScript located in the root src directory,
there are two locations invoking Python methods that you must be familiar with
(obj.pybind_decl and obj.cxx_param_decl). One thing not clear in the SConscript 
is <strong>sim_objects</strong>.</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="c1"># gem5/src/SConscript  
</span>
<span class="n">sim_objects</span> <span class="o">=</span> <span class="n">m5</span><span class="p">.</span><span class="n">SimObject</span><span class="p">.</span><span class="n">allClasses</span>
</pre></td></tr></tbody></table></code></div></div>

<p>In the SConscript, it is defined as attribute from m5.SibObject Python module. 
Then what is allClasses? The answer is in the MetaSimObject!</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td><td class="rouge-code"><pre><span class="c1"># Python/m5/SimObject.py
</span>
<span class="c1"># list of all SimObject classes
</span><span class="n">allClasses</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">class</span> <span class="nc">MetaSimObject</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="n">mcls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">allClasses</span><span class="p">,</span> <span class="sh">"</span><span class="s">SimObject %s already present</span><span class="sh">"</span> <span class="o">%</span> <span class="n">name</span>
        
        <span class="c1"># Copy "private" attributes, functions, and classes to the
</span>        <span class="c1"># official dict.  Everything else goes in _init_dict to be
</span>        <span class="c1"># filtered in __init__.
</span>        <span class="n">cls_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">value_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">cxx_exports</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="p">...</span><span class="bp">...</span>

        <span class="n">cls</span> <span class="o">=</span> <span class="nf">super</span><span class="p">(</span><span class="n">MetaSimObject</span><span class="p">,</span> <span class="n">mcls</span><span class="p">).</span><span class="nf">__new__</span><span class="p">(</span><span class="n">mcls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">cls_dict</span><span class="p">)</span>
        <span class="k">if</span> <span class="sh">'</span><span class="s">type</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">value_dict</span><span class="p">:</span>
            <span class="n">allClasses</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">cls</span>
        <span class="k">return</span> <span class="n">cls</span>
</pre></td></tr></tbody></table></code></div></div>
<p>As depicted in the above code, the <strong>new</strong> method generate dictionary consisting
of its name and actual class object and assign it to allClasses attribute in the
m5.SimObject. However, to make MetaSimObject to invoke <strong>new</strong> method for all
Python classes inheriting from SimObject and fill out allClasses dictionary,
all Python classes should be imported first.</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">SimObject</span><span class="p">(</span><span class="n">PySource</span><span class="p">):</span>
    <span class="sh">'''</span><span class="s">Add a SimObject Python file as a Python source object and add
    it to a list of sim object modules</span><span class="sh">'''</span>

    <span class="n">fixed</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">modnames</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">add_tags</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sh">'''</span><span class="s">Specify the source file and any tags (automatically in
        the m5.objects package)</span><span class="sh">'''</span>
        <span class="nf">super</span><span class="p">(</span><span class="n">SimObject</span><span class="p">,</span> <span class="n">self</span><span class="p">).</span><span class="nf">__init__</span><span class="p">(</span><span class="sh">'</span><span class="s">m5.objects</span><span class="sh">'</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">tags</span><span class="p">,</span> <span class="n">add_tags</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">fixed</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">AttributeError</span><span class="p">(</span><span class="sh">"</span><span class="s">Too late to call SimObject now.</span><span class="sh">"</span><span class="p">)</span>

        <span class="n">bisect</span><span class="p">.</span><span class="nf">insort_right</span><span class="p">(</span><span class="n">SimObject</span><span class="p">.</span><span class="n">modnames</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">modname</span><span class="p">)</span>

<span class="k">for</span> <span class="n">modname</span> <span class="ow">in</span> <span class="n">SimObject</span><span class="p">.</span><span class="n">modnames</span><span class="p">:</span>
    <span class="nf">exec</span><span class="p">(</span><span class="sh">'</span><span class="s">from m5.objects import %s</span><span class="sh">'</span> <span class="o">%</span> <span class="n">modname</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></div></div>

<p>To import relevant Python classes, root SConscript defines SimObject class and 
import the classes to the Python environment where SConscript is being executed.</p>

<blockquote>
  <p>Note that SimObject class is not identical to SimObject class having
MetaSimObject as its metaclass used for defining simulated components.</p>
</blockquote>

<p>Then who instantiates above SimObjects? SConscript can exist in subdirectories 
to handle the build details. Let’s take a look at the sub-directory containing 
Python code defining Python classes inheriting SimObject.</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre><span class="c1"># /gem5/src/sim/SConscript
</span>
<span class="nc">Import</span><span class="p">(</span><span class="sh">'</span><span class="s">*</span><span class="sh">'</span><span class="p">)</span>

<span class="nc">SimObject</span><span class="p">(</span><span class="sh">'</span><span class="s">ClockedObject.py</span><span class="sh">'</span><span class="p">)</span>
<span class="nc">SimObject</span><span class="p">(</span><span class="sh">'</span><span class="s">TickedObject.py</span><span class="sh">'</span><span class="p">)</span>
<span class="nc">SimObject</span><span class="p">(</span><span class="sh">'</span><span class="s">Workload.py</span><span class="sh">'</span><span class="p">)</span>
<span class="nc">SimObject</span><span class="p">(</span><span class="sh">'</span><span class="s">Root.py</span><span class="sh">'</span><span class="p">)</span>
<span class="nc">SimObject</span><span class="p">(</span><span class="sh">'</span><span class="s">ClockDomain.py</span><span class="sh">'</span><span class="p">)</span>
<span class="nc">SimObject</span><span class="p">(</span><span class="sh">'</span><span class="s">VoltageDomain.py</span><span class="sh">'</span><span class="p">)</span>
<span class="nc">SimObject</span><span class="p">(</span><span class="sh">'</span><span class="s">System.py</span><span class="sh">'</span><span class="p">)</span>
<span class="nc">SimObject</span><span class="p">(</span><span class="sh">'</span><span class="s">DVFSHandler.py</span><span class="sh">'</span><span class="p">)</span>
<span class="nc">SimObject</span><span class="p">(</span><span class="sh">'</span><span class="s">SubSystem.py</span><span class="sh">'</span><span class="p">)</span>
<span class="nc">SimObject</span><span class="p">(</span><span class="sh">'</span><span class="s">RedirectPath.py</span><span class="sh">'</span><span class="p">)</span>
<span class="nc">SimObject</span><span class="p">(</span><span class="sh">'</span><span class="s">PowerState.py</span><span class="sh">'</span><span class="p">)</span>
<span class="nc">SimObject</span><span class="p">(</span><span class="sh">'</span><span class="s">PowerDomain.py</span><span class="sh">'</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></div></div>

<p>As shown in the above script, it instantiates SimObject to import Python classes
defining hardware simulation building block. You might wonder how this exported 
CPP implementation can be utilized by Python classes, but please bear with me!
I will give you details after covering Port!</p>

<h2 id="python-to-cpp-transformation"><span class="me-2">Python to CPP transformation</span><a href="#python-to-cpp-transformation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<p>Whoa! It was quite intense because GEM5 heavily relies on Python classes to
represent and organize hardware components. However, the most crucial question
remains unanswered! As Python serves merely as a wrapper for CPP classes used
in the actual simulation, the configuration specified in Python must be
translated into CPP implementation, encompassing the instantiation of CPP
classes and the establishment of connections between them.</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="c1"># set up the root SimObject and start the simulation
</span><span class="n">root</span> <span class="o">=</span> <span class="nc">Root</span><span class="p">(</span><span class="n">full_system</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> <span class="n">system</span> <span class="o">=</span> <span class="n">system</span><span class="p">)</span>
<span class="c1"># instantiate all of the objects we've created above
</span><span class="n">m5</span><span class="p">.</span><span class="nf">instantiate</span><span class="p">()</span>
</pre></td></tr></tbody></table></code></div></div>

<p>When you finish configuration, you should instantiate Root class and invoke 
‘instantiate’ function to transform your Python configurations into CPP 
implementation.</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
</pre></td><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">Root</span><span class="p">(</span><span class="n">SimObject</span><span class="p">):</span>
    
    <span class="n">_the_instance</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">Root</span><span class="p">.</span><span class="n">_the_instance</span><span class="p">:</span>
            <span class="nf">fatal</span><span class="p">(</span><span class="sh">"</span><span class="s">Attempt to allocate multiple instances of Root.</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">None</span>

        <span class="n">Root</span><span class="p">.</span><span class="n">_the_instance</span> <span class="o">=</span> <span class="n">SimObject</span><span class="p">.</span><span class="nf">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Root</span><span class="p">.</span><span class="n">_the_instance</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">getInstance</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Root</span><span class="p">.</span><span class="n">_the_instance</span>
    

    <span class="nb">type</span> <span class="o">=</span> <span class="sh">'</span><span class="s">Root</span><span class="sh">'</span>
    <span class="n">cxx_header</span> <span class="o">=</span> <span class="sh">"</span><span class="s">sim/root.hh</span><span class="sh">"</span>
                      
    <span class="c1"># By default, root sim object and hence all other sim objects schedule
</span>    <span class="c1"># event on the eventq with index 0.
</span>    <span class="n">eventq_index</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># Simulation Quantum for multiple main event queue simulation.
</span>    <span class="c1"># Needs to be set explicitly for a multi-eventq simulation.
</span>    <span class="n">sim_quantum</span> <span class="o">=</span> <span class="n">Param</span><span class="p">.</span><span class="nc">Tick</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="sh">"</span><span class="s">simulation quantum</span><span class="sh">"</span><span class="p">)</span>

    <span class="n">full_system</span> <span class="o">=</span> <span class="n">Param</span><span class="p">.</span><span class="nc">Bool</span><span class="p">(</span><span class="sh">"</span><span class="s">if this is a full system simulation</span><span class="sh">"</span><span class="p">)</span>

    <span class="c1"># Time syncing prevents the simulation from running faster than real time.
</span>    <span class="n">time_sync_enable</span> <span class="o">=</span> <span class="n">Param</span><span class="p">.</span><span class="nc">Bool</span><span class="p">(</span><span class="bp">False</span><span class="p">,</span> <span class="sh">"</span><span class="s">whether time syncing is enabled</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">time_sync_period</span> <span class="o">=</span> <span class="n">Param</span><span class="p">.</span><span class="nc">Clock</span><span class="p">(</span><span class="sh">"</span><span class="s">100ms</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">how often to sync with real time</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">time_sync_spin_threshold</span> <span class="o">=</span> \
            <span class="n">Param</span><span class="p">.</span><span class="nc">Clock</span><span class="p">(</span><span class="sh">"</span><span class="s">100us</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">when less than this much time is left, spin</span><span class="sh">"</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></div></div>

<p>The Root Python class utilize singleton design pattern that restricts the 
instantiation of a class to only one instance and provides a global point of 
access to that instance. The getInstance returns singleton object.</p>

<h3 id="instantiate-cpp-implementation"><span class="me-2">Instantiate CPP implementation</span><a href="#instantiate-cpp-implementation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre></td><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">instantiate</span><span class="p">(</span><span class="n">ckpt_dir</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="kn">from</span> <span class="n">m5</span> <span class="kn">import</span> <span class="n">options</span>
    
    <span class="n">root</span> <span class="o">=</span> <span class="n">objects</span><span class="p">.</span><span class="n">Root</span><span class="p">.</span><span class="nf">getInstance</span><span class="p">()</span>
        
    <span class="k">if</span> <span class="ow">not</span> <span class="n">root</span><span class="p">:</span>
        <span class="nf">fatal</span><span class="p">(</span><span class="sh">"</span><span class="s">Need to instantiate Root() before calling instantiate()</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="c1"># we need to fix the global frequency
</span>    <span class="n">ticks</span><span class="p">.</span><span class="nf">fixGlobalFrequency</span><span class="p">()</span>

    <span class="c1"># Make sure SimObject-valued params are in the configuration
</span>    <span class="c1"># hierarchy so we catch them with future descendants() walks
</span>    <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">root</span><span class="p">.</span><span class="nf">descendants</span><span class="p">():</span> <span class="n">obj</span><span class="p">.</span><span class="nf">adoptOrphanParams</span><span class="p">()</span>
    
    <span class="c1"># Unproxy in sorted order for determinism
</span>    <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">root</span><span class="p">.</span><span class="nf">descendants</span><span class="p">():</span> <span class="n">obj</span><span class="p">.</span><span class="nf">unproxyParams</span><span class="p">()</span>
    
    <span class="p">...</span><span class="bp">...</span>
    
    <span class="c1"># Create the C++ sim objects and connect ports
</span>    <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">root</span><span class="p">.</span><span class="nf">descendants</span><span class="p">():</span> <span class="n">obj</span><span class="p">.</span><span class="nf">createCCObject</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">root</span><span class="p">.</span><span class="nf">descendants</span><span class="p">():</span> <span class="n">obj</span><span class="p">.</span><span class="nf">connectPorts</span><span class="p">()</span>

    <span class="c1"># Do a second pass to finish initializing the sim objects
</span>    <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">root</span><span class="p">.</span><span class="nf">descendants</span><span class="p">():</span> <span class="n">obj</span><span class="p">.</span><span class="nf">init</span><span class="p">()</span>
    
    <span class="c1"># Do a third pass to initialize statistics
</span>    <span class="n">stats</span><span class="p">.</span><span class="nf">_bindStatHierarchy</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
    <span class="n">root</span><span class="p">.</span><span class="nf">regStats</span><span class="p">()</span>
    <span class="p">...</span><span class="bp">...</span>
</pre></td></tr></tbody></table></code></div></div>

<p>The main role of the instantiate function is iterating all SimObjects in the 
hierarchies and initialize CPP classes and ports. As we already set-up all 
required information to instantiate CPP classes (e.g., Params) and connectivity
between the hardware components (e.g., Ports), its role is invoking proper 
CPP functions to finalize set-up!</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre>    <span class="k">def</span> <span class="nf">descendants</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">yield</span> <span class="n">self</span>
        <span class="c1"># The order of the dict is implementation dependent, so sort
</span>        <span class="c1"># it based on the key (name) to ensure the order is the same
</span>        <span class="c1"># on all hosts
</span>        <span class="nf">for </span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">child</span><span class="p">)</span> <span class="ow">in</span> <span class="nf">sorted</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_children</span><span class="p">.</span><span class="nf">items</span><span class="p">()):</span>
            <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">child</span><span class="p">.</span><span class="nf">descendants</span><span class="p">():</span>
                <span class="k">yield</span> <span class="n">obj</span>
</pre></td></tr></tbody></table></code></div></div>

<p>One thing to note is because Root Python class is also SimObject, but the root
node in hierarchy, it can access other system components through ‘descendants’ 
method provided by the SimObject. It just iterates all SimObject!</p>

<h3 id="create-cpp-objects"><span class="me-2">Create CPP objects!</span><a href="#create-cpp-objects" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre>    <span class="c1"># Call C++ to create C++ object corresponding to this object
</span>    <span class="k">def</span> <span class="nf">createCCObject</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">getCCParams</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">getCCObject</span><span class="p">()</span> <span class="c1"># force creation
</span></pre></td></tr></tbody></table></code></div></div>

<p>Our goal is instantiating CPP class object representing hardware component. Since
the information required for initializing this class is conveyed to the class 
constructor, so first of all it needs the Param struct. And then, we need to 
instantiate the CPP class representing the hardware component.</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
</pre></td><td class="rouge-code"><pre>    <span class="k">def</span> <span class="nf">getCCParams</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_ccParams</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_ccParams</span>
        
        <span class="n">cc_params_struct</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">m5</span><span class="p">.</span><span class="n">internal</span><span class="p">.</span><span class="n">params</span><span class="p">,</span> <span class="sh">'</span><span class="s">%sParams</span><span class="sh">'</span> <span class="o">%</span> <span class="n">self</span><span class="p">.</span><span class="nb">type</span><span class="p">)</span>
        <span class="n">cc_params</span> <span class="o">=</span> <span class="nf">cc_params_struct</span><span class="p">()</span>
        <span class="n">cc_params</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">self</span><span class="p">)</span>
        
        <span class="n">param_names</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_params</span><span class="p">.</span><span class="nf">keys</span><span class="p">())</span>
        <span class="n">param_names</span><span class="p">.</span><span class="nf">sort</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">param_names</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_values</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="nf">fatal</span><span class="p">(</span><span class="sh">"</span><span class="s">%s.%s without default or user set value</span><span class="sh">"</span><span class="p">,</span>
                      <span class="n">self</span><span class="p">.</span><span class="nf">path</span><span class="p">(),</span> <span class="n">param</span><span class="p">)</span>
            
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">.</span><span class="nf">getValue</span><span class="p">()</span>
            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_params</span><span class="p">[</span><span class="n">param</span><span class="p">],</span> <span class="n">VectorParamDesc</span><span class="p">):</span>
                <span class="k">assert</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
                <span class="n">vec</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">cc_params</span><span class="p">,</span> <span class="n">param</span><span class="p">)</span>
                <span class="k">assert</span> <span class="ow">not</span> <span class="nf">len</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span>
                <span class="c1"># Some types are exposed as opaque types. They support
</span>                <span class="c1"># the append operation unlike the automatically
</span>                <span class="c1"># wrapped types.
</span>                <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">vec</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="nf">setattr</span><span class="p">(</span><span class="n">cc_params</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="nf">list</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                        <span class="nf">getattr</span><span class="p">(</span><span class="n">cc_params</span><span class="p">,</span> <span class="n">param</span><span class="p">).</span><span class="nf">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nf">setattr</span><span class="p">(</span><span class="n">cc_params</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        
        <span class="n">port_names</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_ports</span><span class="p">.</span><span class="nf">keys</span><span class="p">())</span>
        <span class="n">port_names</span><span class="p">.</span><span class="nf">sort</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">port_name</span> <span class="ow">in</span> <span class="n">port_names</span><span class="p">:</span>
            <span class="n">port</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_port_refs</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">port_name</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">port</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span> 
                <span class="n">port_count</span> <span class="o">=</span> <span class="nf">len</span><span class="p">(</span><span class="n">port</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">port_count</span> <span class="o">=</span> <span class="mi">0</span> 
            <span class="nf">setattr</span><span class="p">(</span><span class="n">cc_params</span><span class="p">,</span> <span class="sh">'</span><span class="s">port_</span><span class="sh">'</span> <span class="o">+</span> <span class="n">port_name</span> <span class="o">+</span> <span class="sh">'</span><span class="s">_connection_count</span><span class="sh">'</span><span class="p">,</span>
                    <span class="n">port_count</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_ccParams</span> <span class="o">=</span> <span class="n">cc_params</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_ccParams</span>
</pre></td></tr></tbody></table></code></div></div>

<p>As we have all required information to generate and initialize Param struct, we 
should utilize it! First of all, we need to instantiate the Param struct associated
with the class that we want to instantiate to simulate one hardware component.
We’ve seen that the automatically generated pybind code exports the Param struct
to Python.</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="c1"># gem5/src/Python/m5/internal/params.py
</span>
<span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">module</span> <span class="ow">in</span> <span class="n">inspect</span><span class="p">.</span><span class="nf">getmembers</span><span class="p">(</span><span class="n">_m5</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">name</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">'</span><span class="s">param_</span><span class="sh">'</span><span class="p">)</span> <span class="ow">or</span> <span class="n">name</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">'</span><span class="s">enum_</span><span class="sh">'</span><span class="p">):</span>
        <span class="nf">exec</span><span class="p">(</span><span class="sh">"</span><span class="s">from _m5.%s import *</span><span class="sh">"</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></div></div>

<p>As all CPP implementations are exported to Python as a module of ‘_m5’ the 
Struct mapped for Param that we need to instantiate the CPP class should be 
accessible from importing ‘_m5’ module.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="k">static</span> <span class="kt">void</span>
<span class="nf">module_init</span><span class="p">(</span><span class="n">py</span><span class="o">::</span><span class="n">module</span> <span class="o">&amp;</span><span class="n">m_internal</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">py</span><span class="o">::</span><span class="n">module</span> <span class="n">m</span> <span class="o">=</span> <span class="n">m_internal</span><span class="p">.</span><span class="n">def_submodule</span><span class="p">(</span><span class="s">"param_BaseTLB"</span><span class="p">);</span>
    <span class="n">py</span><span class="o">::</span><span class="n">class_</span><span class="o">&lt;</span><span class="n">BaseTLBParams</span><span class="p">,</span> <span class="n">SimObjectParams</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">BaseTLBParams</span><span class="p">,</span> <span class="n">py</span><span class="o">::</span><span class="n">nodelete</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">"BaseTLBParams"</span><span class="p">)</span>
        <span class="p">.</span><span class="n">def_readwrite</span><span class="p">(</span><span class="s">"port_cpu_side_ports_connection_count"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">BaseTLBParams</span><span class="o">::</span><span class="n">port_cpu_side_ports_connection_count</span><span class="p">)</span>
        <span class="p">.</span><span class="n">def_readwrite</span><span class="p">(</span><span class="s">"port_mem_side_port_connection_count"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">BaseTLBParams</span><span class="o">::</span><span class="n">port_mem_side_port_connection_count</span><span class="p">)</span>
        <span class="p">;</span>

    <span class="n">py</span><span class="o">::</span><span class="n">class_</span><span class="o">&lt;</span><span class="n">BaseTLB</span><span class="p">,</span> <span class="n">SimObject</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">BaseTLB</span><span class="p">,</span> <span class="n">py</span><span class="o">::</span><span class="n">nodelete</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">"BaseTLB"</span><span class="p">)</span>
        <span class="p">;</span>

<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>
<p>For example, BaseTLBParams CPP struct will be exported as ‘_m5.param_BaseTLB’.
Therefore all pybind exported CPP implementation will be imported to 
m5.internal.params module and ‘cc_params_struct’ will get the Python Class
object of the Param struct. By instantiating it, cc_params will have the instance
of the class, and will be initialized based on the values previously collected 
from the Python class BaseTLB. After initializing all fields of the struct, it 
assign the object to the ‘_ccParams’.</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre>    <span class="k">def</span> <span class="nf">getCCObject</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="n">_ccObject</span><span class="p">:</span>
            <span class="c1"># Make sure this object is in the configuration hierarchy
</span>            <span class="k">if</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="n">_parent</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nf">isRoot</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
                <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">Attempt to instantiate orphan node</span><span class="sh">"</span><span class="p">)</span>
            <span class="c1"># Cycles in the configuration hierarchy are not supported. This
</span>            <span class="c1"># will catch the resulting recursion and stop.
</span>            <span class="n">self</span><span class="p">.</span><span class="n">_ccObject</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="n">abstract</span><span class="p">:</span>
                <span class="n">params</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">getCCParams</span><span class="p">()</span>
                <span class="n">self</span><span class="p">.</span><span class="n">_ccObject</span> <span class="o">=</span> <span class="n">params</span><span class="p">.</span><span class="nf">create</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">self</span><span class="p">.</span><span class="n">_ccObject</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">%s: Cycle found in configuration hierarchy.</span><span class="sh">"</span> \
                  <span class="o">%</span> <span class="n">self</span><span class="p">.</span><span class="nf">path</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_ccObject</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Now as we have the Param struct object, we need to instantiate a CPP class 
object that actually simulate the hardware logic. ‘getCCParams’ returns the 
Param struct object previously assigned to ‘_ccParams’. Afterwards, it invokes
create() method defined in the Param struct. That would be weird to you because
you cannot find the create method in the automatically generated Param struct. 
However, when you look at the auto-generated pybind code, you can definitely 
find it exports the create function defined for Param struct. That’s because 
the create method should be implemented manually by the developer beforehand in
cpp code.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="c1">// gem5/src/sim/system.cc </span>

<span class="n">System</span> <span class="o">*</span>
<span class="n">SystemParams</span><span class="o">::</span><span class="n">create</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">System</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Each create method for hardware component should instantiate the CPP class 
associated with the component. Also note that it passes <strong>this</strong> to the System 
constructor which is the SystemParams passing all information required to 
initialize the class! Finally you can retrieve CPP class object instantiated 
with Param configured based on Python script.</p>

<h3 id="connect-ports-in-cpp"><span class="me-2">Connect Ports in CPP</span><a href="#connect-ports-in-cpp" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>As we’ve seen in previous Python code, we established all connectivity between
hardware components in Python, not in actual CPP simulation. It is time to 
transfer this connection implemented in Python to CPP implementations to 
establish actual connection between simulated hardware components.</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">SimObject</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>  
    <span class="k">def</span> <span class="nf">connectPorts</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="c1"># Sort the ports based on their attribute name to ensure the
</span>        <span class="c1"># order is the same on all hosts
</span>        <span class="nf">for </span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">portRef</span><span class="p">)</span> <span class="ow">in</span> <span class="nf">sorted</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_port_refs</span><span class="p">.</span><span class="nf">items</span><span class="p">()):</span>
            <span class="n">portRef</span><span class="p">.</span><span class="nf">ccConnect</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">PortRef</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">ccConnect</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">ccConnected</span><span class="p">:</span> <span class="c1"># already done this
</span>            <span class="k">return</span>
        
        <span class="n">peer</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">peer</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="n">peer</span><span class="p">:</span> <span class="c1"># nothing to connect to
</span>            <span class="k">return</span>
    
        <span class="n">port</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">simobj</span><span class="p">.</span><span class="nf">getPort</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">peer_port</span> <span class="o">=</span> <span class="n">peer</span><span class="p">.</span><span class="n">simobj</span><span class="p">.</span><span class="nf">getPort</span><span class="p">(</span><span class="n">peer</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">peer</span><span class="p">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">port</span><span class="p">.</span><span class="nf">bind</span><span class="p">(</span><span class="n">peer_port</span><span class="p">)</span>
    
        <span class="n">self</span><span class="p">.</span><span class="n">ccConnected</span> <span class="o">=</span> <span class="bp">True</span> 
</pre></td></tr></tbody></table></code></div></div>
<p>Since PortRef Python class have all information required to establish connection
between two components (two end ports, self and peer), the remaining task is 
invoking proper CPP functions to establish the connection as described by the 
Python PortRef. First of all, it needs information about two end-ports that 
should be connected to each other in CPP implementation.</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
</pre></td><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">SimObject</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span> 
    <span class="nd">@cxxMethod</span><span class="p">(</span><span class="n">return_value_policy</span><span class="o">=</span><span class="sh">"</span><span class="s">reference</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">getPort</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">if_name</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
        <span class="k">pass</span>

<span class="k">def</span> <span class="nf">cxxMethod</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">Decorator to export C++ functions to Python</span><span class="sh">"""</span>

    <span class="k">def</span> <span class="nf">decorate</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">func</span><span class="p">.</span><span class="n">__name__</span>
        <span class="n">override</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">override</span><span class="sh">"</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="n">cxx_name</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">cxx_name</span><span class="sh">"</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="n">return_value_policy</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">return_value_policy</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">static</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">static</span><span class="sh">"</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        
        <span class="n">args</span><span class="p">,</span> <span class="n">varargs</span><span class="p">,</span> <span class="n">keywords</span><span class="p">,</span> <span class="n">defaults</span> <span class="o">=</span> <span class="n">inspect</span><span class="p">.</span><span class="nf">getargspec</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">varargs</span> <span class="ow">or</span> <span class="n">keywords</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">Wrapped methods must not contain variable </span><span class="sh">"</span> \
                             <span class="sh">"</span><span class="s">arguments</span><span class="sh">"</span><span class="p">)</span>
    
        <span class="c1"># Create tuples of (argument, default)
</span>        <span class="k">if</span> <span class="n">defaults</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">args</span><span class="p">[:</span><span class="o">-</span><span class="nf">len</span><span class="p">(</span><span class="n">defaults</span><span class="p">)]</span> <span class="o">+</span> \
                   <span class="nf">list</span><span class="p">(</span><span class="nf">zip</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="o">-</span><span class="nf">len</span><span class="p">(</span><span class="n">defaults</span><span class="p">):],</span> <span class="n">defaults</span><span class="p">))</span>
        <span class="c1"># Don't include self in the argument list to PyBind
</span>        <span class="n">args</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

    
        <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">cxx_call</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">ccobj</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">getCCClass</span><span class="p">()</span> <span class="k">if</span> <span class="n">static</span> <span class="k">else</span> <span class="n">self</span><span class="p">.</span><span class="nf">getCCObject</span><span class="p">()</span>
            <span class="k">return</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">ccobj</span><span class="p">,</span> <span class="n">name</span><span class="p">)(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    
        <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">py_call</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">return</span> <span class="nf">func</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">f</span> <span class="o">=</span> <span class="n">py_call</span> <span class="k">if</span> <span class="n">override</span> <span class="k">else</span> <span class="n">cxx_call</span>
        <span class="n">f</span><span class="p">.</span><span class="n">__pybind</span> <span class="o">=</span> <span class="nc">PyBindMethod</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">cxx_name</span><span class="o">=</span><span class="n">cxx_name</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">,</span>
                                  <span class="n">return_value_policy</span><span class="o">=</span><span class="n">return_value_policy</span><span class="p">,</span>
                                  <span class="n">static</span><span class="o">=</span><span class="n">static</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">f</span>

    <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">decorate</span>
    <span class="k">elif</span> <span class="nf">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nf">len</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="nf">decorate</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nc">TypeError</span><span class="p">(</span><span class="sh">"</span><span class="s">One argument and no kwargs, or only kwargs expected</span><span class="sh">"</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></div></div>

<p>GEM5 defines decorator function cxxMethod which bridge the Python function call
to corresponding CPP function call. I will not cover details of decorator in 
Python. Please refer to this 
<a href="https://realPython.com/primer-on-Python-decorators/">blog posting for further details</a>.
The important thing is when you invoke getPort, it will invoke getPort member 
function defined in the CPP class representing hardware component having the 
port. Let’s see the example.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre><span class="n">Port</span> <span class="o">&amp;</span>
<span class="n">BaseXBar</span><span class="o">::</span><span class="n">getPort</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="o">&amp;</span><span class="n">if_name</span><span class="p">,</span> <span class="n">PortID</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">if_name</span> <span class="o">==</span> <span class="s">"mem_side_ports"</span> <span class="o">&amp;&amp;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">memSidePorts</span><span class="p">.</span><span class="n">size</span><span class="p">())</span> <span class="p">{</span>
        <span class="c1">// the memory-side ports index translates directly to the vector</span>
        <span class="c1">// position</span>
        <span class="k">return</span> <span class="o">*</span><span class="n">memSidePorts</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
    <span class="p">}</span> <span class="k">else</span>  <span class="nf">if</span> <span class="p">(</span><span class="n">if_name</span> <span class="o">==</span> <span class="s">"default"</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="o">*</span><span class="n">memSidePorts</span><span class="p">[</span><span class="n">defaultPortID</span><span class="p">];</span>
    <span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">if_name</span> <span class="o">==</span> <span class="s">"cpu_side_ports"</span> <span class="o">&amp;&amp;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">cpuSidePorts</span><span class="p">.</span><span class="n">size</span><span class="p">())</span> <span class="p">{</span>
        <span class="c1">// the CPU-side ports index translates directly to the vector position</span>
        <span class="k">return</span> <span class="o">*</span><span class="n">cpuSidePorts</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">ClockedObject</span><span class="o">::</span><span class="n">getPort</span><span class="p">(</span><span class="n">if_name</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>BaseXBar has three member fields describing hardware ports. Therefore, when the 
getPort is invoked from the Python class, for example SystemXBar inheriting the 
BaseXBar, it will invoke the getPort of the BaseXBar. Also, based on the passed
string, and index (for vectored ports), it will return CPP port member field of 
the class to Python! Since the returned object is CPP object not Python, the 
bind function will be invoked from CPP.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="kt">void</span>
<span class="n">RequestPort</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="n">Port</span> <span class="o">&amp;</span><span class="n">peer</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">auto</span> <span class="o">*</span><span class="n">response_port</span> <span class="o">=</span> <span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="n">ResponsePort</span> <span class="o">*&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">peer</span><span class="p">);</span>
    <span class="n">fatal_if</span><span class="p">(</span><span class="o">!</span><span class="n">response_port</span><span class="p">,</span> <span class="s">"Can't bind port %s to non-response port %s."</span><span class="p">,</span>
             <span class="n">name</span><span class="p">(),</span> <span class="n">peer</span><span class="p">.</span><span class="n">name</span><span class="p">());</span>
    <span class="c1">// request port keeps track of the response port</span>
    <span class="n">_responsePort</span> <span class="o">=</span> <span class="n">response_port</span><span class="p">;</span>
    <span class="n">Port</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="n">peer</span><span class="p">);</span>
    <span class="c1">// response port also keeps track of request port</span>
    <span class="n">_responsePort</span><span class="o">-&gt;</span><span class="n">responderBind</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>The actual binding is very simple operation because it just tracks the information
about the port and its connection (peer port). I will cover how the ports are 
utilized in simulation to transfer data between the components connected through 
the ports. In this posting, understanding how to establish the connection between
two different components having port would be sufficient.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">Port</span>
<span class="p">{</span>
    <span class="cm">/** Attach to a peer port. */</span>
    <span class="k">virtual</span> <span class="kt">void</span>
    <span class="n">bind</span><span class="p">(</span><span class="n">Port</span> <span class="o">&amp;</span><span class="n">peer</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">_peer</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">peer</span><span class="p">;</span>
        <span class="n">_connected</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span>

<span class="kt">void</span>
<span class="n">ResponsePort</span><span class="o">::</span><span class="n">responderBind</span><span class="p">(</span><span class="n">RequestPort</span><span class="o">&amp;</span> <span class="n">request_port</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">_requestPort</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">request_port</span><span class="p">;</span>
    <span class="n">Port</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="n">request_port</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Binding should be done in bi-directional, so the above function establish the 
connection in two different ports (request and response).</p>

<h2 id="final-remarks"><span class="me-2">Final remarks</span><a href="#final-remarks" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<p>At the first outlook, it must be very confusing to understand why GEM5 has 
Python script and CPP defining similar classes, which makes you misunderstand 
what is the role of each classes defined in different languages. However, the 
the points is the actual simulation is mostly achieved by CPP implementation, 
and the Python is a wrapper for those CPP implementation. In detail, the Python
is utilized to configure hardware parameters such as cache size, data size, and
whatnot. 
I covered several Python specific concepts such as metaclass and pybind to allow
GEM5 automatically generate several CPP implementations and its binding to Python
so that Python script can instantiate the CPP class object for actual simulation.
Hope that this posting can help you understand mysterious configuration of GEM5.</p>


  </div>

  <div class="post-tail-wrapper text-muted">
    <!-- categories -->
    
      <div class="post-meta mb-3">
        <i class="far fa-folder-open fa-fw me-1"></i>
        
          <a href="/categories/gem5/">Gem5,</a>,
          <a href="/categories/simobject/">SimObject,</a>,
          <a href="/categories/pybind11/">pybind11,</a>,
          <a href="/categories/metaclass/">metaclass</a>
      </div>
    

    <!-- tags -->
    

    <div
      class="
        post-tail-bottom
        d-flex justify-content-between align-items-center mt-5 pb-2
      "
    >
      <div class="license-wrapper">
        
          

          This post is licensed under 
        <a href="https://creativecommons.org/licenses/by/4.0/">
          CC BY 4.0
        </a>
         by the author.
        
      </div>

      <!-- Post sharing snippet -->

<div class="share-wrapper d-flex align-items-center">
  <span class="share-label text-muted">Share</span>
  <span class="share-icons">
    
    
    

    

      

      <a
        href="https://twitter.com/intent/tweet?text=GEM5,%20from%20entry%20point%20to%20simulation%20loop%20-%20Ruach&url=https%3A%2F%2Fruach.github.io%2Fposts%2Fgem5-simobject%2F"
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Twitter"
        target="_blank"
        rel="noopener"
        aria-label="Twitter"
      >
        <i class="fa-fw fa-brands fa-square-x-twitter"></i>
      </a>
    

      

      <a
        href="https://www.facebook.com/sharer/sharer.php?title=GEM5,%20from%20entry%20point%20to%20simulation%20loop%20-%20Ruach&u=https%3A%2F%2Fruach.github.io%2Fposts%2Fgem5-simobject%2F"
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Facebook"
        target="_blank"
        rel="noopener"
        aria-label="Facebook"
      >
        <i class="fa-fw fab fa-facebook-square"></i>
      </a>
    

      

      <a
        href="https://t.me/share/url?url=https%3A%2F%2Fruach.github.io%2Fposts%2Fgem5-simobject%2F&text=GEM5,%20from%20entry%20point%20to%20simulation%20loop%20-%20Ruach"
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Telegram"
        target="_blank"
        rel="noopener"
        aria-label="Telegram"
      >
        <i class="fa-fw fab fa-telegram"></i>
      </a>
    

      

      <a
        href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fruach.github.io%2Fposts%2Fgem5-simobject%2F"
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Linkedin"
        target="_blank"
        rel="noopener"
        aria-label="Linkedin"
      >
        <i class="fa-fw fab fa-linkedin"></i>
      </a>
    

    <button
      id="copy-link"
      aria-label="Copy link"
      class="btn small"
      data-bs-toggle="tooltip"
      data-bs-placement="top"
      title="Copy link"
      data-title-succeed="Link copied successfully!"
    >
      <i class="fa-fw fas fa-link pe-none fs-6"></i>
    </button>
  </span>
</div>

    </div>
    <!-- .post-tail-bottom -->
  </div>
  <!-- div.post-tail-wrapper -->
</article>


            
          </main>

          <!-- panel -->
          <aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 mb-5 text-muted">
            <div class="access">
              <!-- Get the last 5 posts from lastmod list. -->















              <!-- The trending tags list -->


















            </div>

            
              
              



  <section id="toc-wrapper" class="ps-0 pe-4">
    <h2 class="panel-heading ps-3 pt-2 mb-2">Contents</h2>
    <nav id="toc"></nav>
  </section>


            
          </aside>
        </div>

        <div class="row">
          <!-- tail -->
          <div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4">
            
              
              <!-- Recommend the other 3 posts according to the tags and categories of the current post. -->

<!-- The total size of related posts -->


<!-- An random integer that bigger than 0 -->


<!-- Equals to TAG_SCORE / {max_categories_hierarchy} -->














  

  
    











            
              
              <!-- Navigation buttons at the bottom of the post. -->

<nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation">
  
  

  
    <div class="btn btn-outline-primary disabled" aria-label="Older">
      <p>-</p>
    </div>
  

  
    <a
      href="/posts/gem5-event-loop/"
      class="btn btn-outline-primary"
      aria-label="Newer"
    >
      <p>Gem5 Event Loop</p>
    </a>
  
</nav>

            
              
              <!--  The comments switcher -->

  
  <!-- The Disqus lazy loading. -->

<div id="disqus_thread">
  <p class="text-center text-muted small">Comments powered by <a href="https://disqus.com/">Disqus</a>.</p>
</div>

<script type="text/javascript">
  var disqus_config = function () {
    this.page.url = 'https://ruach.github.io/posts/gem5-simobject/';
    this.page.identifier = '/posts/gem5-simobject/';
  };

  /* Lazy loading */
  var disqus_observer = new IntersectionObserver(
    function (entries) {
      if (entries[0].isIntersecting) {
        (function () {
          var d = document,
            s = d.createElement('script');
          s.src = 'https://ruach.disqus.com/embed.js';
          s.setAttribute('data-timestamp', +new Date());
          (d.head || d.body).appendChild(s);
        })();

        disqus_observer.disconnect();
      }
    },
    { threshold: [0] }
  );

  disqus_observer.observe(document.querySelector('#disqus_thread'));

  /* Auto switch theme */
  function reloadDisqus() {
    if (event.source === window && event.data && event.data.direction === ModeToggle.ID) {
      /* Disqus hasn't been loaded */
      if (typeof DISQUS === 'undefined') {
        return;
      }

      if (document.readyState == 'complete') {
        DISQUS.reset({ reload: true, config: disqus_config });
      }
    }
  }

  if (document.querySelector('.mode-toggle')) {
    window.addEventListener('message', reloadDisqus);
  }
</script>



            

            <!-- The Footer -->

<footer
  aria-label="Site Info"
  class="
    d-flex flex-column justify-content-center text-muted
    flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3
  "
>
  <p>
    ©
    <time>2023</time>
    <a href="https://ruach.github.io">Jaehyuk Lee</a>.
    
      <span
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author."
      >Some rights reserved.</span>
    
  </p>

  <p>Using the <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme for <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>
  </p>
</footer>

          </div>
        </div>

        <!-- The Search results -->

<div id="search-result-wrapper" class="d-flex justify-content-center unloaded">
  <div class="col-11 content">
    <div id="search-hints">
      <!-- The trending tags list -->


















    </div>
    <div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div>
  </div>
</div>

      </div>

      <aside aria-label="Scroll to Top">
        <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow">
          <i class="fas fa-angle-up"></i>
        </button>
      </aside>
    </div>

    <div id="mask"></div>

    
      <aside
  id="notification"
  class="toast"
  role="alert"
  aria-live="assertive"
  aria-atomic="true"
  data-bs-animation="true"
  data-bs-autohide="false"
>
  <div class="toast-header">
    <button
      type="button"
      class="btn-close ms-auto"
      data-bs-dismiss="toast"
      aria-label="Close"
    ></button>
  </div>
  <div class="toast-body text-center pt-0">
    <p class="px-2 mb-3">A new version of content is available.</p>
    <button type="button" class="btn btn-primary" aria-label="Update">
      Update
    </button>
  </div>
</aside>

    

    <!-- JavaScripts -->

    <!-- JS selector for site. -->

<!-- commons -->



<!-- layout specified -->


  

  
    <!-- image lazy-loading & popup & clipboard -->
    
  















  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  



  <script src="https://cdn.jsdelivr.net/combine/npm/jquery@3.7.1/dist/jquery.min.js,npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js,npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/magnific-popup@1.1.0/dist/jquery.magnific-popup.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.10/dayjs.min.js,npm/dayjs@1.11.10/locale/en.min.js,npm/dayjs@1.11.10/plugin/relativeTime.min.js,npm/dayjs@1.11.10/plugin/localizedFormat.min.js,npm/tocbot@4.21.2/dist/tocbot.min.js"></script>






<script defer src="/assets/js/dist/post.min.js"></script>






    

    <!--
  Jekyll Simple Search loader
  See: <https://github.com/christian-fei/Simple-Jekyll-Search>
-->





<script>
  /* Note: dependent library will be loaded in `js-selector.html` */
  SimpleJekyllSearch({
    searchInput: document.getElementById('search-input'),
    resultsContainer: document.getElementById('search-results'),
    json: '/assets/js/data/search.json',
    searchResultTemplate: '  <article class="px-1 px-sm-2 px-lg-4 px-xl-0">    <header>      <h2><a href="{url}">{title}</a></h2>      <div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1">        {categories}        {tags}      </div>    </header>    <p>{snippet}</p>  </article>',
    noResultsText: '<p class="mt-5"></p>',
    templateMiddleware: function(prop, value, template) {
      if (prop === 'categories') {
        if (value === '') {
          return `${value}`;
        } else {
          return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`;
        }
      }

      if (prop === 'tags') {
        if (value === '') {
          return `${value}`;
        } else {
          return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`;
        }
      }
    }
  });
</script>

  </body>
</html>

