<!doctype html>














<!-- `site.alt_lang` can specify a language different from the UI -->
<html lang="en" data-mode="light">
  <!-- The Head -->

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta
    name="viewport"
    content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover"
  >

  

  

  
    <!-- Begin Jekyll SEO tag v2.8.0 -->
<meta name="generator" content="Jekyll v4.3.2" />
<meta property="og:title" content="Gem5 X86 Tlb" />
<meta property="og:locale" content="en" />
<meta name="description" content="A minimal, responsive and feature-rich Jekyll theme for technical writing." />
<meta property="og:description" content="A minimal, responsive and feature-rich Jekyll theme for technical writing." />
<link rel="canonical" href="http://localhost:4000/posts/gem5-x86-tlb/" />
<meta property="og:url" content="http://localhost:4000/posts/gem5-x86-tlb/" />
<meta property="og:site_name" content="Ruach" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-06-03T00:00:00-04:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Gem5 X86 Tlb" />
<meta name="twitter:site" content="@ruach_lee" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2020-06-03T00:00:00-04:00","datePublished":"2020-06-03T00:00:00-04:00","description":"A minimal, responsive and feature-rich Jekyll theme for technical writing.","headline":"Gem5 X86 Tlb","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/posts/gem5-x86-tlb/"},"url":"http://localhost:4000/posts/gem5-x86-tlb/"}</script>
<!-- End Jekyll SEO tag -->

  

  <title>Gem5 X86 Tlb | Ruach
  </title>

  <!--
  The Favicons for Web, Android, Microsoft, and iOS (iPhone and iPad) Apps
  Generated by: https://realfavicongenerator.net/
-->



<link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png">
<link rel="manifest" href="/assets/img/favicons/site.webmanifest">
<link rel="shortcut icon" href="/assets/img/favicons/favicon.ico">
<meta name="apple-mobile-web-app-title" content="Ruach">
<meta name="application-name" content="Ruach">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml">
<meta name="theme-color" content="#ffffff">


  
    
      <link rel="preconnect" href="https://fonts.googleapis.com" >
      <link rel="dns-prefetch" href="https://fonts.googleapis.com" >
    
      <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      <link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin>
    
      <link rel="preconnect" href="https://fonts.googleapis.com" >
      <link rel="dns-prefetch" href="https://fonts.googleapis.com" >
    
      <link rel="preconnect" href="https://cdn.jsdelivr.net" >
      <link rel="dns-prefetch" href="https://cdn.jsdelivr.net" >
    

    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap">
  

  <!-- GA -->
  

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.2/css/all.min.css">

  <link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css">

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.21.2/dist/tocbot.min.css">
  

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css">
  

  
    <!-- Manific Popup -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css">
  

  <!-- JavaScript -->

  

  <!-- A placeholder to allow defining custom metadata -->

</head>


  <body>
    <!-- The Side Bar -->

<aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end">
  <header class="profile-wrapper">
    <a href="/" id="avatar" class="rounded-circle">
      
        
        <img src="/assets/img/jaehyuk.png" width="112" height="112" alt="avatar" onerror="this.style.display='none'">
      
    </a>

    <h1 class="site-title">
      <a href="/">Ruach</a>
    </h1>
    <p class="site-subtitle fst-italic mb-0">Security Researcher at Gatech</p>
  </header>
  <!-- .profile-wrapper -->

  <nav class="flex-column flex-grow-1 w-100 ps-0">
    <ul class="nav">
      <!-- home -->
      <li class="nav-item">
        <a href="/" class="nav-link">
          <i class="fa-fw fas fa-home"></i>
          <span>HOME</span>
        </a>
      </li>
      <!-- the real tabs -->
      
        <li class="nav-item">
          <a href="/categories/" class="nav-link">
            <i class="fa-fw fas fa-stream"></i>
            

            <span>CATEGORIES</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/tags/" class="nav-link">
            <i class="fa-fw fas fa-tags"></i>
            

            <span>TAGS</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/archives/" class="nav-link">
            <i class="fa-fw fas fa-archive"></i>
            

            <span>ARCHIVES</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/about/" class="nav-link">
            <i class="fa-fw fas fa-info-circle"></i>
            

            <span>ABOUT</span>
          </a>
        </li>
        <!-- .nav-item -->
      
    </ul>
  </nav>

  <div class="sidebar-bottom d-flex flex-wrap  align-items-center w-100">
    

    
      

      
        <a
          href="javascript:location.href = 'mailto:' + ['jaehyuk','gatech.edu'].join('@')"
          aria-label="email"
          

          

          

          
        >
          <i class="fas fa-envelope"></i>
        </a>
      
    
      

      
        <a
          href="https://www.linkedin.com/in/jaehyuk-lee-29b33b121/"
          aria-label="linkedin"
          

          
            target="_blank"
            
          

          

          
            rel="noopener noreferrer"
          
        >
          <i class="fab fa-linkedin"></i>
        </a>
      
    
      

      
        <a
          href="https://github.com/Ruach"
          aria-label="github"
          

          
            target="_blank"
            
          

          

          
            rel="noopener noreferrer"
          
        >
          <i class="fab fa-github"></i>
        </a>
      
    
      

      
        <a
          href="https://stackoverflow.com/users/4460514/ruach?tab=profile"
          aria-label="stack-overflow"
          

          
            target="_blank"
            
          

          

          
            rel="noopener noreferrer"
          
        >
          <i class="fab fa-stack-overflow"></i>
        </a>
      
    
  </div>
  <!-- .sidebar-bottom -->
</aside>
<!-- #sidebar -->


    <div id="main-wrapper" class="d-flex justify-content-center">
      <div class="container d-flex flex-column px-xxl-5">
        <!-- The Top Bar -->

<header id="topbar-wrapper" aria-label="Top Bar">
  <div
    id="topbar"
    class="d-flex align-items-center justify-content-between px-lg-3 h-100"
  >
    <nav id="breadcrumb" aria-label="Breadcrumb">
      

      
        
          
            <span>
              <a href="/">
                Home
              </a>
            </span>

          
        
          
        
          
            
              <span>Gem5 X86 Tlb</span>
            

          
        
      
    </nav>
    <!-- endof #breadcrumb -->

    <button type="button" id="sidebar-trigger" class="btn btn-link">
      <i class="fas fa-bars fa-fw"></i>
    </button>

    <div id="topbar-title">
      Post
    </div>

    <button type="button" id="search-trigger" class="btn btn-link">
      <i class="fas fa-search fa-fw"></i>
    </button>

    <search class="align-items-center ms-3 ms-lg-0">
      <i class="fas fa-search fa-fw"></i>
      <input
        class="form-control"
        id="search-input"
        type="search"
        aria-label="search"
        autocomplete="off"
        placeholder="Search..."
      >
    </search>
    <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button>
  </div>
</header>


        <div class="row flex-grow-1">
          <main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4">
            
              <!-- Refactor the HTML structure -->



<!--
  In order to allow a wide table to scroll horizontally,
  we suround the markdown table with `<div class="table-wrapper">` and `</div>`
-->



<!--
  Fixed kramdown code highlight rendering:
  https://github.com/penibelst/jekyll-compress-html/issues/101
  https://github.com/penibelst/jekyll-compress-html/issues/71#issuecomment-188144901
-->



<!-- Change the icon of checkbox -->



<!-- Handle images -->





<!-- Add header for code snippets -->



<!-- Create heading anchors -->





  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    

    
  

  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    

    
  

  
  

  

  
  

  




<!-- return -->




<article class="px-1">
  <header>
    <h1 data-toc-skip>Gem5 X86 Tlb</h1>

    <div class="post-meta text-muted">
      <!-- published date -->
      <span>
        Posted
        <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1591156800"
  data-df="ll"
  
    data-bs-toggle="tooltip" data-bs-placement="bottom"
  
>
  Jun  3, 2020
</time>

      </span>

      <!-- lastmod date -->
      

      

      <div class="d-flex justify-content-between">
        <!-- author(s) -->
        <span>
          

          By

          <em>
            
              <a href="https://ruach.github.io">Jaehyuk Lee</a>
            
          </em>
        </span>

        <!-- read time -->
        <!-- Calculate the post's reading time, and display the word count in tooltip -->



<!-- words per minute -->










<!-- return element -->
<span
  class="readtime"
  data-bs-toggle="tooltip"
  data-bs-placement="bottom"
  title="9980 words"
>
  <em>55 min</em> read</span>

      </div>
      <!-- .d-flex -->
    </div>
    <!-- .post-meta -->
  </header>

  <div class="content">
    
<hr />
<p>layout: post
tittle: “Pagetable walking and pagefault handling in Gem5”
categories: GEM5, TLB
—
In this posting, 
we are going to take a look at how the memory accesses
can be resolved through the TLB and pagetable walking.</p>

<h1 id="who-initiates-tlb-access">Who initiates TLB access?</h1>
<p>TLB maintains a virtual to physical address translation information
to reduce time of walking the entire page table at every memory access.
In other words, it is a cache of virtual to physical mapping maintained 
by the processor usually. 
Then which part of the CPU logic initiates the TLB logic, 
and what operations should be done by the TLB component?</p>

<h2 id="interface-between-cpu-pipeline-and-tlb-component"><span class="me-2">Interface between CPU pipeline and TLB component</span><a href="#interface-between-cpu-pipeline-and-tlb-component" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
</pre></td><td class="rouge-code"><pre> <span class="mi">425</span> <span class="n">Fault</span>
 <span class="mi">426</span> <span class="n">TimingSimpleCPU</span><span class="o">::</span><span class="n">initiateMemRead</span><span class="p">(</span><span class="n">Addr</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">size</span><span class="p">,</span>
 <span class="mi">427</span>                                  <span class="n">Request</span><span class="o">::</span><span class="n">Flags</span> <span class="n">flags</span><span class="p">,</span>
 <span class="mi">428</span>                                  <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;&amp;</span> <span class="n">byte_enable</span><span class="p">)</span>
 <span class="mi">429</span> <span class="p">{</span>
 <span class="mi">430</span>     <span class="n">SimpleExecContext</span> <span class="o">&amp;</span><span class="n">t_info</span> <span class="o">=</span> <span class="o">*</span><span class="n">threadInfo</span><span class="p">[</span><span class="n">curThread</span><span class="p">];</span>
 <span class="mi">431</span>     <span class="n">SimpleThread</span><span class="o">*</span> <span class="kr">thread</span> <span class="o">=</span> <span class="n">t_info</span><span class="p">.</span><span class="kr">thread</span><span class="p">;</span>
 <span class="mi">432</span> 
 <span class="mi">439</span>     <span class="n">Fault</span> <span class="n">fault</span><span class="p">;</span>
 <span class="mi">440</span>     <span class="k">const</span> <span class="kt">int</span> <span class="n">asid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
 <span class="mi">441</span>     <span class="k">const</span> <span class="n">Addr</span> <span class="n">pc</span> <span class="o">=</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">instAddr</span><span class="p">();</span>
 <span class="mi">442</span>     <span class="kt">unsigned</span> <span class="n">block_size</span> <span class="o">=</span> <span class="n">cacheLineSize</span><span class="p">();</span>
 <span class="mi">443</span>     <span class="n">BaseTLB</span><span class="o">::</span><span class="n">Mode</span> <span class="n">mode</span> <span class="o">=</span> <span class="n">BaseTLB</span><span class="o">::</span><span class="n">Read</span><span class="p">;</span>
 <span class="mi">444</span> 
 <span class="mi">445</span>     <span class="k">if</span> <span class="p">(</span><span class="n">traceData</span><span class="p">)</span>
 <span class="mi">446</span>         <span class="n">traceData</span><span class="o">-&gt;</span><span class="n">setMem</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
 <span class="mi">447</span> 
 <span class="mi">448</span>     <span class="n">RequestPtr</span> <span class="n">req</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">Request</span><span class="o">&gt;</span><span class="p">(</span>
 <span class="mi">449</span>         <span class="n">asid</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">dataMasterId</span><span class="p">(),</span> <span class="n">pc</span><span class="p">,</span>
 <span class="mi">450</span>         <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">contextId</span><span class="p">());</span>
 <span class="mi">451</span>     <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">byte_enable</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
 <span class="mi">452</span>         <span class="n">req</span><span class="o">-&gt;</span><span class="n">setByteEnable</span><span class="p">(</span><span class="n">byte_enable</span><span class="p">);</span>
 <span class="mi">453</span>     <span class="p">}</span>
 <span class="mi">454</span>    
 <span class="mi">455</span>     <span class="n">req</span><span class="o">-&gt;</span><span class="n">taskId</span><span class="p">(</span><span class="n">taskId</span><span class="p">());</span>
 <span class="mi">456</span> 
 <span class="mi">457</span>     <span class="n">Addr</span> <span class="n">split_addr</span> <span class="o">=</span> <span class="n">roundDown</span><span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">block_size</span><span class="p">);</span>
 <span class="mi">458</span>     <span class="nf">assert</span><span class="p">(</span><span class="n">split_addr</span> <span class="o">&lt;=</span> <span class="n">addr</span> <span class="o">||</span> <span class="n">split_addr</span> <span class="o">-</span> <span class="n">addr</span> <span class="o">&lt;</span> <span class="n">block_size</span><span class="p">);</span>
 <span class="mi">459</span>                                  
 <span class="mi">460</span>     <span class="n">_status</span> <span class="o">=</span> <span class="n">DTBWaitResponse</span><span class="p">;</span>
 <span class="mi">461</span>     <span class="nf">if</span> <span class="p">(</span><span class="n">split_addr</span> <span class="o">&gt;</span> <span class="n">addr</span><span class="p">)</span> <span class="p">{</span>
 <span class="mi">462</span>         <span class="n">RequestPtr</span> <span class="n">req1</span><span class="p">,</span> <span class="n">req2</span><span class="p">;</span>
 <span class="mi">463</span>         <span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">isLLSC</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">isSwap</span><span class="p">());</span>
 <span class="mi">464</span>         <span class="n">req</span><span class="o">-&gt;</span><span class="n">splitOnVaddr</span><span class="p">(</span><span class="n">split_addr</span><span class="p">,</span> <span class="n">req1</span><span class="p">,</span> <span class="n">req2</span><span class="p">);</span>
 <span class="mi">465</span>    
 <span class="mi">466</span>         <span class="n">WholeTranslationState</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span>
 <span class="mi">467</span>             <span class="k">new</span> <span class="n">WholeTranslationState</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">req1</span><span class="p">,</span> <span class="n">req2</span><span class="p">,</span> <span class="k">new</span> <span class="kt">uint8_t</span><span class="p">[</span><span class="n">size</span><span class="p">],</span>
 <span class="mi">468</span>                                       <span class="nb">NULL</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
 <span class="mi">469</span>         <span class="n">DataTranslation</span><span class="o">&lt;</span><span class="n">TimingSimpleCPU</span> <span class="o">*&gt;</span> <span class="o">*</span><span class="n">trans1</span> <span class="o">=</span>
 <span class="mi">470</span>             <span class="k">new</span> <span class="n">DataTranslation</span><span class="o">&lt;</span><span class="n">TimingSimpleCPU</span> <span class="o">*&gt;</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
 <span class="mi">471</span>         <span class="n">DataTranslation</span><span class="o">&lt;</span><span class="n">TimingSimpleCPU</span> <span class="o">*&gt;</span> <span class="o">*</span><span class="n">trans2</span> <span class="o">=</span>
 <span class="mi">472</span>             <span class="k">new</span> <span class="n">DataTranslation</span><span class="o">&lt;</span><span class="n">TimingSimpleCPU</span> <span class="o">*&gt;</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
 <span class="mi">473</span> 
 <span class="mi">474</span>         <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">dtb</span><span class="o">-&gt;</span><span class="n">translateTiming</span><span class="p">(</span><span class="n">req1</span><span class="p">,</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">getTC</span><span class="p">(),</span> <span class="n">trans1</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
 <span class="mi">475</span>         <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">dtb</span><span class="o">-&gt;</span><span class="n">translateTiming</span><span class="p">(</span><span class="n">req2</span><span class="p">,</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">getTC</span><span class="p">(),</span> <span class="n">trans2</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
 <span class="mi">476</span>     <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
 <span class="mi">477</span>         <span class="n">WholeTranslationState</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span>
 <span class="mi">478</span>             <span class="k">new</span> <span class="n">WholeTranslationState</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="k">new</span> <span class="kt">uint8_t</span><span class="p">[</span><span class="n">size</span><span class="p">],</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
 <span class="mi">479</span>         <span class="n">DataTranslation</span><span class="o">&lt;</span><span class="n">TimingSimpleCPU</span> <span class="o">*&gt;</span> <span class="o">*</span><span class="n">translation</span>
 <span class="mi">480</span>             <span class="o">=</span> <span class="k">new</span> <span class="n">DataTranslation</span><span class="o">&lt;</span><span class="n">TimingSimpleCPU</span> <span class="o">*&gt;</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
 <span class="mi">481</span>         <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">dtb</span><span class="o">-&gt;</span><span class="n">translateTiming</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">getTC</span><span class="p">(),</span> <span class="n">translation</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
 <span class="mi">482</span>     <span class="p">}</span>
 <span class="mi">483</span> 
 <span class="mi">484</span>     <span class="k">return</span> <span class="n">NoFault</span><span class="p">;</span>
 <span class="mi">485</span> <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>
<p>One of the most important basic capability of processor is accessing memory.
GEM5 make each processor implement their own memory access building blocks as 
member function of each processor class. We are going to take a look at simple 
processor, <strong>TimingSimpleCPU</strong> and corresponding memory function, 
<strong>initiateMemRead.</strong> 
Note that at the end of the initiateMemRead function, it generates 
<strong>DataTranslation</strong> object and pass it to the translateTiming function defined 
in the data TLB component of the processor. 
This translation object will be used to process current TLB access request.
Also note that translateTiming function needs threadContext to execute TLB 
accessing and RequestPtr object containing all the memory access request 
information such as virtual address.</p>

<h2 id="its-all-about-tlb-no-actual-memory-access-to-the-virtual-address"><span class="me-2">It’s all about TLB! No actual memory access to the virtual address!</span><a href="#its-all-about-tlb-no-actual-memory-access-to-the-virtual-address" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<blockquote>
  <p>initiateMemRead function does not initiate actual memory access, it only asks 
TLB component to generate virtual address to physical address mapping in its 
TLB cache.</p>
</blockquote>

<p>It could be confusing because of its name <strong>initateMemRead</strong> but the actual 
memory access could only be occured after the TLB request can be successfully 
resolved. I will describe how actual memory access happens in this posting []
Keep in mind that we will only focus on the translation part!</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre><span class="c1">//gem5/src/arch/x86/tlb.cc</span>

<span class="mi">441</span> <span class="kt">void</span>
<span class="mi">442</span> <span class="n">TLB</span><span class="o">::</span><span class="n">translateTiming</span><span class="p">(</span><span class="k">const</span> <span class="n">RequestPtr</span> <span class="o">&amp;</span><span class="n">req</span><span class="p">,</span> <span class="n">ThreadContext</span> <span class="o">*</span><span class="n">tc</span><span class="p">,</span>
<span class="mi">443</span>         <span class="n">Translation</span> <span class="o">*</span><span class="n">translation</span><span class="p">,</span> <span class="n">Mode</span> <span class="n">mode</span><span class="p">)</span>
<span class="mi">444</span> <span class="p">{</span>
<span class="mi">445</span>     <span class="kt">bool</span> <span class="n">delayedResponse</span><span class="p">;</span>
<span class="mi">446</span>     <span class="n">assert</span><span class="p">(</span><span class="n">translation</span><span class="p">);</span>
<span class="mi">447</span>     <span class="n">Fault</span> <span class="n">fault</span> <span class="o">=</span>
<span class="mi">448</span>         <span class="n">TLB</span><span class="o">::</span><span class="n">translate</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">tc</span><span class="p">,</span> <span class="n">translation</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">delayedResponse</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
<span class="mi">449</span>
<span class="mi">450</span>     <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">delayedResponse</span><span class="p">)</span>
<span class="mi">451</span>         <span class="n">translation</span><span class="o">-&gt;</span><span class="n">finish</span><span class="p">(</span><span class="n">fault</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">tc</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
<span class="mi">452</span>     <span class="k">else</span>
<span class="mi">453</span>         <span class="n">translation</span><span class="o">-&gt;</span><span class="n">markDelayed</span><span class="p">();</span>
<span class="mi">454</span> <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>As we assume that GEM5 is compiled for X86 architecture, it will invoke TLB 
implementation for X86 architecture. 
Please be aware that the translateTiming function is implemented as part of the
TLB class, indicating that we are presently working with TLB components, 
transitioning away from the processor pipeline. The actual translation is done 
by <strong>TLB::translate</strong> function. 
Depending on whether the target virtual address has previously been resolved and
its mapping cached in the TLB or not, the function can either retrieve the TLB 
entry from the cache or obtain it by traversing the page table.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
</pre></td><td class="rouge-code"><pre><span class="c1">// gem5/src/arch/x86/tlb.cc</span>

<span class="mi">277</span> <span class="n">Fault</span>
<span class="mi">278</span> <span class="n">TLB</span><span class="o">::</span><span class="n">translate</span><span class="p">(</span><span class="k">const</span> <span class="n">RequestPtr</span> <span class="o">&amp;</span><span class="n">req</span><span class="p">,</span>
<span class="mi">279</span>         <span class="n">ThreadContext</span> <span class="o">*</span><span class="n">tc</span><span class="p">,</span> <span class="n">Translation</span> <span class="o">*</span><span class="n">translation</span><span class="p">,</span>
<span class="mi">280</span>         <span class="n">Mode</span> <span class="n">mode</span><span class="p">,</span> <span class="kt">bool</span> <span class="o">&amp;</span><span class="n">delayedResponse</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">timing</span><span class="p">)</span>
<span class="mi">281</span> <span class="p">{</span>
<span class="mi">282</span>     <span class="n">Request</span><span class="o">::</span><span class="n">Flags</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">getFlags</span><span class="p">();</span>
<span class="mi">283</span>     <span class="kt">int</span> <span class="n">seg</span> <span class="o">=</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SegmentFlagMask</span><span class="p">;</span>
<span class="mi">284</span>     <span class="kt">bool</span> <span class="n">storeCheck</span> <span class="o">=</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">StoreCheck</span> <span class="o">&lt;&lt;</span> <span class="n">FlagShift</span><span class="p">);</span>
<span class="p">...</span>
<span class="mi">341</span>         <span class="c1">// If paging is enabled, do the translation.</span>
<span class="mi">342</span>         <span class="k">if</span> <span class="p">(</span><span class="n">m5Reg</span><span class="p">.</span><span class="n">paging</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">343</span>             <span class="n">DPRINTF</span><span class="p">(</span><span class="n">TLB</span><span class="p">,</span> <span class="s">"Paging enabled.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="mi">344</span>             <span class="c1">// The vaddr already has the segment base applied.</span>
<span class="mi">345</span>             <span class="n">TlbEntry</span> <span class="o">*</span><span class="n">entry</span> <span class="o">=</span> <span class="n">lookup</span><span class="p">(</span><span class="n">vaddr</span><span class="p">);</span>
<span class="mi">346</span>             <span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">Read</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">347</span>                 <span class="n">rdAccesses</span><span class="o">++</span><span class="p">;</span>
<span class="mi">348</span>             <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="mi">349</span>                 <span class="n">wrAccesses</span><span class="o">++</span><span class="p">;</span>
<span class="mi">350</span>             <span class="p">}</span>
<span class="mi">351</span>             <span class="nf">if</span> <span class="p">(</span><span class="o">!</span><span class="n">entry</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">352</span>                 <span class="n">DPRINTF</span><span class="p">(</span><span class="n">TLB</span><span class="p">,</span> <span class="s">"Handling a TLB miss for "</span>
<span class="mi">353</span>                         <span class="s">"address %#x at pc %#x.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
<span class="mi">354</span>                         <span class="n">vaddr</span><span class="p">,</span> <span class="n">tc</span><span class="o">-&gt;</span><span class="n">instAddr</span><span class="p">());</span>
<span class="mi">355</span>                 <span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">Read</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">356</span>                     <span class="n">rdMisses</span><span class="o">++</span><span class="p">;</span>
<span class="mi">357</span>                 <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="mi">358</span>                     <span class="n">wrMisses</span><span class="o">++</span><span class="p">;</span>
<span class="mi">359</span>                 <span class="p">}</span>
<span class="mi">360</span>                 <span class="nf">if</span> <span class="p">(</span><span class="n">FullSystem</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">361</span>                     <span class="n">Fault</span> <span class="n">fault</span> <span class="o">=</span> <span class="n">walker</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">(</span><span class="n">tc</span><span class="p">,</span> <span class="n">translation</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
<span class="mi">362</span>                     <span class="k">if</span> <span class="p">(</span><span class="n">timing</span> <span class="o">||</span> <span class="n">fault</span> <span class="o">!=</span> <span class="n">NoFault</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">363</span>                         <span class="c1">// This gets ignored in atomic mode.</span>
<span class="mi">364</span>                         <span class="n">delayedResponse</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="mi">365</span>                         <span class="k">return</span> <span class="n">fault</span><span class="p">;</span>
<span class="mi">366</span>                     <span class="p">}</span>
<span class="mi">367</span>                     <span class="n">entry</span> <span class="o">=</span> <span class="n">lookup</span><span class="p">(</span><span class="n">vaddr</span><span class="p">);</span>
<span class="mi">368</span>                     <span class="nf">assert</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
<span class="mi">369</span>                 <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</pre></td></tr></tbody></table></code></div></div>

<p>The initial step in the translate function involves a query to the TLB, 
inquiring whether the necessary translation entry is present in the TLB (line
345). In cases where the TLB entry is <strong>absent</strong>, the process then proceeds to 
navigate through the page table, which is stored in memory, in order to acquire 
the virtual-to-physical translation (spanning from line 351 to 395). Given the 
presumed interest in utilizing full-system emulation, I will focus on FullSystem
parts of TLB handling. 
In GEM5’s fullsystem mode, when a TLB miss occurs, the system proceeds to 
navigate the page table using the “pagetable_walker” object (as indicated in 
line 361). It’s important to note that the “req” parameter is passed to the 
pagetable_walker because it contains all the essential information, including 
the address and flags, necessary for correctly resolving memory access.</p>

<h2 id="page-table-walking-in-tlb"><span class="me-2">Page table walking in TLB</span><a href="#page-table-walking-in-tlb" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<p>In cases where it is either the first request or the previous TLB entry has been
evicted from the TLB cache, it is required to traverse the page table and obtain
the virtual to physical mapping. Let’s examine the process by which the TLB 
effectively navigates the page table and retrieves the final-level page table 
entry.</p>

<h3 id="walkerstate-per-request"><span class="me-2">WalkerState per request</span><a href="#walkerstate-per-request" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<blockquote>
  <p>In contrast to simpler operations, it’s typically not possible to resolve TLB
misses in a single cycle.</p>
</blockquote>

<p>As the page table is structured with multiple levels, the page table walking 
demands numerous memory accesses. These accesses are essential for reaching the 
leaf page table entry that contains the virtual-to-physical mapping and other 
pertinent flags.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre></td><td class="rouge-code"><pre><span class="c1">//gem5/src/arch/x86/pagetable_walker.cc</span>

 <span class="mi">71</span> <span class="n">Fault</span>
 <span class="mi">72</span> <span class="n">Walker</span><span class="o">::</span><span class="n">start</span><span class="p">(</span><span class="n">ThreadContext</span> <span class="o">*</span> <span class="n">_tc</span><span class="p">,</span> <span class="n">BaseTLB</span><span class="o">::</span><span class="n">Translation</span> <span class="o">*</span><span class="n">_translation</span><span class="p">,</span>
 <span class="mi">73</span>               <span class="k">const</span> <span class="n">RequestPtr</span> <span class="o">&amp;</span><span class="n">_req</span><span class="p">,</span> <span class="n">BaseTLB</span><span class="o">::</span><span class="n">Mode</span> <span class="n">_mode</span><span class="p">)</span>
 <span class="mi">74</span> <span class="p">{</span>
 <span class="mi">75</span>     <span class="c1">// TODO: in timing mode, instead of blocking when there are other</span>
 <span class="mi">76</span>     <span class="c1">// outstanding requests, see if this request can be coalesced with</span>
 <span class="mi">77</span>     <span class="c1">// another one (i.e. either coalesce or start walk)</span>
 <span class="mi">78</span>     <span class="n">WalkerState</span> <span class="o">*</span> <span class="n">newState</span> <span class="o">=</span> <span class="k">new</span> <span class="n">WalkerState</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">_translation</span><span class="p">,</span> <span class="n">_req</span><span class="p">);</span>
 <span class="mi">79</span>     <span class="n">newState</span><span class="o">-&gt;</span><span class="n">initState</span><span class="p">(</span><span class="n">_tc</span><span class="p">,</span> <span class="n">_mode</span><span class="p">,</span> <span class="n">sys</span><span class="o">-&gt;</span><span class="n">isTimingMode</span><span class="p">());</span>
 <span class="mi">80</span>     <span class="k">if</span> <span class="p">(</span><span class="n">currStates</span><span class="p">.</span><span class="n">size</span><span class="p">())</span> <span class="p">{</span>
 <span class="mi">81</span>         <span class="n">assert</span><span class="p">(</span><span class="n">newState</span><span class="o">-&gt;</span><span class="n">isTiming</span><span class="p">());</span>
 <span class="mi">82</span>         <span class="n">DPRINTF</span><span class="p">(</span><span class="n">PageTableWalker</span><span class="p">,</span> <span class="s">"Walks in progress: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">currStates</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
 <span class="mi">83</span>         <span class="n">currStates</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">newState</span><span class="p">);</span>
 <span class="mi">84</span>         <span class="k">return</span> <span class="n">NoFault</span><span class="p">;</span>
 <span class="mi">85</span>     <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
 <span class="mi">86</span>         <span class="n">currStates</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">newState</span><span class="p">);</span>
 <span class="mi">87</span>         <span class="n">Fault</span> <span class="n">fault</span> <span class="o">=</span> <span class="n">newState</span><span class="o">-&gt;</span><span class="n">startWalk</span><span class="p">();</span>
 <span class="mi">88</span>         <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">newState</span><span class="o">-&gt;</span><span class="n">isTiming</span><span class="p">())</span> <span class="p">{</span>
 <span class="mi">89</span>             <span class="n">currStates</span><span class="p">.</span><span class="n">pop_front</span><span class="p">();</span>
 <span class="mi">90</span>             <span class="k">delete</span> <span class="n">newState</span><span class="p">;</span>
 <span class="mi">91</span>         <span class="p">}</span>
 <span class="mi">92</span>         <span class="k">return</span> <span class="n">fault</span><span class="p">;</span>
 <span class="mi">93</span>     <span class="p">}</span>
 <span class="mi">94</span> <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>It is important to note that TLB misses can occur simultaneously because 
multiple processors might try to access a memory address for which the 
virtual-to-physical mapping is not stored in the TLB cache. Additional, since 
each request cannot be handled in a single clock cycle, there is a need to store 
the state of page table walking for each request. 
The “walkerState” is employed for this specific purpose, maintaining all the 
necessary information for page table walking on a per-request basis.</p>

<p>The “currStates” keeps track of all the outstanding requests, which are those 
that have been requested previously but have not yet been resolved, in the form 
of a list. If there are any unresolved TLB misses, the current request is simply 
added to the list, and the system waits until the preceding requests have been
resolved, as seen in lines 80-84. Once the outstanding request has been resolved,
the pending requests are then processed one after another.</p>

<p>If there is no remaining requests in the list, as indicated in lines 85-92, a 
newly generated state should be added, and the “startWalk” function is called 
with the newly created state. Upon completion of the page table walking by the 
“startWalk” function, in the case of a timing CPU, there is no need to remove 
the current state from the “currStates” list, as another stage in the timing CPU
model takes care of removing the current state from the list.</p>

<h3 id="startwalk-initiating-page-table-walking"><span class="me-2">startWalk, initiating page table walking</span><a href="#startwalk-initiating-page-table-walking" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p><em>gem5/src/arch/x86/pagetable_walker.cc</em></p>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre></td><td class="rouge-code"><pre><span class="mi">229</span> <span class="n">Fault</span>
<span class="mi">230</span> <span class="n">Walker</span><span class="o">::</span><span class="n">WalkerState</span><span class="o">::</span><span class="n">startWalk</span><span class="p">()</span>
<span class="mi">231</span> <span class="p">{</span>
<span class="mi">232</span>     <span class="n">Fault</span> <span class="n">fault</span> <span class="o">=</span> <span class="n">NoFault</span><span class="p">;</span>
<span class="mi">233</span>     <span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">started</span><span class="p">);</span>
<span class="mi">234</span>     <span class="n">started</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="mi">235</span>     <span class="n">setupWalk</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">getVaddr</span><span class="p">());</span>
<span class="mi">236</span>     <span class="k">if</span> <span class="p">(</span><span class="n">timing</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">237</span>         <span class="n">nextState</span> <span class="o">=</span> <span class="n">state</span><span class="p">;</span>
<span class="mi">238</span>         <span class="n">state</span> <span class="o">=</span> <span class="n">Waiting</span><span class="p">;</span>
<span class="mi">239</span>         <span class="n">timingFault</span> <span class="o">=</span> <span class="n">NoFault</span><span class="p">;</span>
<span class="mi">240</span>         <span class="n">sendPackets</span><span class="p">();</span>
<span class="mi">241</span>     <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="mi">242</span>         <span class="k">do</span> <span class="p">{</span>
<span class="mi">243</span>             <span class="n">walker</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">sendAtomic</span><span class="p">(</span><span class="n">read</span><span class="p">);</span>
<span class="mi">244</span>             <span class="n">PacketPtr</span> <span class="n">write</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="mi">245</span>             <span class="n">fault</span> <span class="o">=</span> <span class="n">stepWalk</span><span class="p">(</span><span class="n">write</span><span class="p">);</span>
<span class="mi">246</span>             <span class="n">assert</span><span class="p">(</span><span class="n">fault</span> <span class="o">==</span> <span class="n">NoFault</span> <span class="o">||</span> <span class="n">read</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="mi">247</span>             <span class="n">state</span> <span class="o">=</span> <span class="n">nextState</span><span class="p">;</span>
<span class="mi">248</span>             <span class="n">nextState</span> <span class="o">=</span> <span class="n">Ready</span><span class="p">;</span>
<span class="mi">249</span>             <span class="k">if</span> <span class="p">(</span><span class="n">write</span><span class="p">)</span>
<span class="mi">250</span>                 <span class="n">walker</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">sendAtomic</span><span class="p">(</span><span class="n">write</span><span class="p">);</span>
<span class="mi">251</span>         <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">read</span><span class="p">);</span>
<span class="mi">252</span>         <span class="n">state</span> <span class="o">=</span> <span class="n">Ready</span><span class="p">;</span>
<span class="mi">253</span>         <span class="n">nextState</span> <span class="o">=</span> <span class="n">Waiting</span><span class="p">;</span>
<span class="mi">254</span>     <span class="p">}</span>
<span class="mi">255</span>     <span class="k">return</span> <span class="n">fault</span><span class="p">;</span>
<span class="mi">256</span> <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Since the page table is stored in memory or cache, whenever the TLB miss happens
it should retrieve page table content from the memory subsystem. To this end, 
TLB component initiates memory request through <em>sendPackets</em> function.</p>

<h3 id="multi-level-page-table-walking-process--multiple-packets"><span class="me-2">multi-level page table walking process = multiple packets</span><a href="#multi-level-page-table-walking-process--multiple-packets" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre></td><td class="rouge-code"><pre><span class="mi">661</span> <span class="kt">void</span>
<span class="mi">662</span> <span class="n">Walker</span><span class="o">::</span><span class="n">WalkerState</span><span class="o">::</span><span class="n">sendPackets</span><span class="p">()</span>
<span class="mi">663</span> <span class="p">{</span>
<span class="mi">664</span>     <span class="c1">//If we're already waiting for the port to become available, just return.</span>
<span class="mi">665</span>     <span class="k">if</span> <span class="p">(</span><span class="n">retrying</span><span class="p">)</span>
<span class="mi">666</span>         <span class="k">return</span><span class="p">;</span>
<span class="mi">667</span>
<span class="mi">668</span>     <span class="c1">//Reads always have priority</span>
<span class="mi">669</span>     <span class="k">if</span> <span class="p">(</span><span class="n">read</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">670</span>         <span class="n">PacketPtr</span> <span class="n">pkt</span> <span class="o">=</span> <span class="n">read</span><span class="p">;</span>
<span class="mi">671</span>         <span class="n">read</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="mi">672</span>         <span class="n">inflight</span><span class="o">++</span><span class="p">;</span>
<span class="mi">673</span>         <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">walker</span><span class="o">-&gt;</span><span class="n">sendTiming</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">pkt</span><span class="p">))</span> <span class="p">{</span>
<span class="mi">674</span>             <span class="n">retrying</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="mi">675</span>             <span class="n">read</span> <span class="o">=</span> <span class="n">pkt</span><span class="p">;</span>
<span class="mi">676</span>             <span class="n">inflight</span><span class="o">--</span><span class="p">;</span>
<span class="mi">677</span>             <span class="k">return</span><span class="p">;</span>
<span class="mi">678</span>         <span class="p">}</span>
<span class="mi">679</span>     <span class="p">}</span>
<span class="mi">680</span>     <span class="c1">//Send off as many of the writes as we can.</span>
<span class="mi">681</span>     <span class="nf">while</span> <span class="p">(</span><span class="n">writes</span><span class="p">.</span><span class="n">size</span><span class="p">())</span> <span class="p">{</span>
<span class="mi">682</span>         <span class="n">PacketPtr</span> <span class="n">write</span> <span class="o">=</span> <span class="n">writes</span><span class="p">.</span><span class="n">back</span><span class="p">();</span>
<span class="mi">683</span>         <span class="n">writes</span><span class="p">.</span><span class="n">pop_back</span><span class="p">();</span>
<span class="mi">684</span>         <span class="n">inflight</span><span class="o">++</span><span class="p">;</span>
<span class="mi">685</span>         <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">walker</span><span class="o">-&gt;</span><span class="n">sendTiming</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">write</span><span class="p">))</span> <span class="p">{</span>
<span class="mi">686</span>             <span class="n">retrying</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="mi">687</span>             <span class="n">writes</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">write</span><span class="p">);</span>
<span class="mi">688</span>             <span class="n">inflight</span><span class="o">--</span><span class="p">;</span>
<span class="mi">689</span>             <span class="k">return</span><span class="p">;</span>
<span class="mi">690</span>         <span class="p">}</span>
<span class="mi">691</span>     <span class="p">}</span>
<span class="mi">692</span> <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>With modern processors making use of multi-level page tables, it becomes 
challenging to pre-determine which page table entries will be accessed before 
resolving the memory access at the previous level of page table entry. 
Because of this interdependence among page table access, the accesses to these 
entries must be carried out sequentially rather than in parallel
Consequently, TLB accesses are structured into multiple stages, with each stage 
responsible for accessing one level of the page table.</p>

<p>Since TLB should request memory subsystem to fetch next level of page table 
entry one by one, it should send send different packets at different stage to 
access a specific level of the page table.</p>

<p>When you look at the “sendPackets” function, you will notice a familiar function
name, “sendTiming,” which dispatches page-table-access-request-packets to the 
memory subsystem (e.g., cache or memory).</p>

<h3 id="initial-page-table-access-packet-creation"><span class="me-2">Initial page table access packet creation</span><a href="#initial-page-table-access-packet-creation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>When you take a look at the “sendPackets” function, you won’t observe any packet
creation within it. However, you will notice that the “sendTiming” function 
receives a parameter named pkt. So, where does this pkt come from? 
The “setupWalk” function within the “startWalk” function is responsible for
populating the appropriate request packet, which initiates the access to the 
page table.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
</pre></td><td class="rouge-code"><pre><span class="mi">551</span> <span class="kt">void</span>
<span class="mi">552</span> <span class="n">Walker</span><span class="o">::</span><span class="n">WalkerState</span><span class="o">::</span><span class="n">setupWalk</span><span class="p">(</span><span class="n">Addr</span> <span class="n">vaddr</span><span class="p">)</span>
<span class="mi">553</span> <span class="p">{</span>
<span class="mi">554</span>     <span class="n">VAddr</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">vaddr</span><span class="p">;</span>
<span class="mi">555</span>     <span class="n">CR3</span> <span class="n">cr3</span> <span class="o">=</span> <span class="n">tc</span><span class="o">-&gt;</span><span class="n">readMiscRegNoEffect</span><span class="p">(</span><span class="n">MISCREG_CR3</span><span class="p">);</span>
<span class="mi">556</span>     <span class="c1">// Check if we're in long mode or not</span>
<span class="mi">557</span>     <span class="n">Efer</span> <span class="n">efer</span> <span class="o">=</span> <span class="n">tc</span><span class="o">-&gt;</span><span class="n">readMiscRegNoEffect</span><span class="p">(</span><span class="n">MISCREG_EFER</span><span class="p">);</span>
<span class="mi">558</span>     <span class="n">dataSize</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
<span class="mi">559</span>     <span class="n">Addr</span> <span class="n">topAddr</span><span class="p">;</span>
<span class="mi">560</span>     <span class="k">if</span> <span class="p">(</span><span class="n">efer</span><span class="p">.</span><span class="n">lma</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">561</span>         <span class="c1">// Do long mode.</span>
<span class="mi">562</span>         <span class="n">state</span> <span class="o">=</span> <span class="n">LongPML4</span><span class="p">;</span>
<span class="mi">563</span>         <span class="n">topAddr</span> <span class="o">=</span> <span class="p">(</span><span class="n">cr3</span><span class="p">.</span><span class="n">longPdtb</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">+</span> <span class="n">addr</span><span class="p">.</span><span class="n">longl4</span> <span class="o">*</span> <span class="n">dataSize</span><span class="p">;</span>
<span class="mi">564</span>         <span class="n">enableNX</span> <span class="o">=</span> <span class="n">efer</span><span class="p">.</span><span class="n">nxe</span><span class="p">;</span>
<span class="mi">565</span>     <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="mi">566</span>         <span class="c1">// We're in some flavor of legacy mode.</span>
<span class="mi">567</span>         <span class="n">CR4</span> <span class="n">cr4</span> <span class="o">=</span> <span class="n">tc</span><span class="o">-&gt;</span><span class="n">readMiscRegNoEffect</span><span class="p">(</span><span class="n">MISCREG_CR4</span><span class="p">);</span>
<span class="mi">568</span>         <span class="k">if</span> <span class="p">(</span><span class="n">cr4</span><span class="p">.</span><span class="n">pae</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">569</span>             <span class="c1">// Do legacy PAE.</span>
<span class="mi">570</span>             <span class="n">state</span> <span class="o">=</span> <span class="n">PAEPDP</span><span class="p">;</span>
<span class="mi">571</span>             <span class="n">topAddr</span> <span class="o">=</span> <span class="p">(</span><span class="n">cr3</span><span class="p">.</span><span class="n">paePdtb</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="n">addr</span><span class="p">.</span><span class="n">pael3</span> <span class="o">*</span> <span class="n">dataSize</span><span class="p">;</span>
<span class="mi">572</span>             <span class="n">enableNX</span> <span class="o">=</span> <span class="n">efer</span><span class="p">.</span><span class="n">nxe</span><span class="p">;</span>
<span class="mi">573</span>         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="mi">574</span>             <span class="n">dataSize</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
<span class="mi">575</span>             <span class="n">topAddr</span> <span class="o">=</span> <span class="p">(</span><span class="n">cr3</span><span class="p">.</span><span class="n">pdtb</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">+</span> <span class="n">addr</span><span class="p">.</span><span class="n">norml2</span> <span class="o">*</span> <span class="n">dataSize</span><span class="p">;</span>
<span class="mi">576</span>             <span class="k">if</span> <span class="p">(</span><span class="n">cr4</span><span class="p">.</span><span class="n">pse</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">577</span>                 <span class="c1">// Do legacy PSE.</span>
<span class="mi">578</span>                 <span class="n">state</span> <span class="o">=</span> <span class="n">PSEPD</span><span class="p">;</span>
<span class="mi">579</span>             <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="mi">580</span>                 <span class="c1">// Do legacy non PSE.</span>
<span class="mi">581</span>                 <span class="n">state</span> <span class="o">=</span> <span class="n">PD</span><span class="p">;</span>
<span class="mi">582</span>             <span class="p">}</span>
<span class="mi">583</span>             <span class="n">enableNX</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="mi">584</span>         <span class="p">}</span>
<span class="mi">585</span>     <span class="p">}</span>
<span class="mi">586</span>
<span class="mi">587</span>     <span class="n">nextState</span> <span class="o">=</span> <span class="n">Ready</span><span class="p">;</span>
<span class="mi">588</span>     <span class="n">entry</span><span class="p">.</span><span class="n">vaddr</span> <span class="o">=</span> <span class="n">vaddr</span><span class="p">;</span>
<span class="mi">589</span>
<span class="mi">590</span>     <span class="n">Request</span><span class="o">::</span><span class="n">Flags</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">Request</span><span class="o">::</span><span class="n">PHYSICAL</span><span class="p">;</span>
<span class="mi">591</span>     <span class="nf">if</span> <span class="p">(</span><span class="n">cr3</span><span class="p">.</span><span class="n">pcd</span><span class="p">)</span>
<span class="mi">592</span>         <span class="n">flags</span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="n">Request</span><span class="o">::</span><span class="n">UNCACHEABLE</span><span class="p">);</span>
<span class="mi">593</span>
<span class="mi">594</span>     <span class="n">RequestPtr</span> <span class="n">request</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">Request</span><span class="o">&gt;</span><span class="p">(</span>
<span class="mi">595</span>         <span class="n">topAddr</span><span class="p">,</span> <span class="n">dataSize</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">walker</span><span class="o">-&gt;</span><span class="n">masterId</span><span class="p">);</span>
<span class="mi">596</span>
<span class="mi">597</span>     <span class="n">read</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">Packet</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">MemCmd</span><span class="o">::</span><span class="n">ReadReq</span><span class="p">);</span>
<span class="mi">598</span>     <span class="n">read</span><span class="o">-&gt;</span><span class="n">allocate</span><span class="p">();</span>
<span class="mi">599</span> <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>We’ve learned that the “sendPackets” function is employed to transmit multiple 
page table access requests, depending on the various stages of the page table 
walking process. So, how are the packets for the subsequent stages created and 
provided to the “sendPackets” function? Please bear with me as we progress 
through one complete step of page table walking; I will address this aspect 
shortly.</p>

<h3 id="sendtiming-function-sends-request-and-save-current-state"><span class="me-2">SendTiming function: sends request and save current state</span><a href="#sendtiming-function-sends-request-and-save-current-state" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>Now, let’s explore how the “sendTiming” function transmits the generated page 
table access request packet to the memory subsystem via the designated port.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre><span class="mi">156</span> <span class="kt">bool</span> <span class="n">Walker</span><span class="o">::</span><span class="n">sendTiming</span><span class="p">(</span><span class="n">WalkerState</span><span class="o">*</span> <span class="n">sendingState</span><span class="p">,</span> <span class="n">PacketPtr</span> <span class="n">pkt</span><span class="p">)</span>
<span class="mi">157</span> <span class="p">{</span>
<span class="mi">158</span>     <span class="n">WalkerSenderState</span><span class="o">*</span> <span class="n">walker_state</span> <span class="o">=</span> <span class="k">new</span> <span class="n">WalkerSenderState</span><span class="p">(</span><span class="n">sendingState</span><span class="p">);</span>
<span class="mi">159</span>     <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">pushSenderState</span><span class="p">(</span><span class="n">walker_state</span><span class="p">);</span>
<span class="mi">160</span>     <span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="p">.</span><span class="n">sendTimingReq</span><span class="p">(</span><span class="n">pkt</span><span class="p">))</span> <span class="p">{</span>
<span class="mi">161</span>         <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="mi">162</span>     <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="mi">163</span>         <span class="c1">// undo the adding of the sender state and delete it, as we</span>
<span class="mi">164</span>         <span class="c1">// will do it again the next time we attempt to send it</span>
<span class="mi">165</span>         <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">popSenderState</span><span class="p">();</span>
<span class="mi">166</span>         <span class="k">delete</span> <span class="n">walker_state</span><span class="p">;</span>
<span class="mi">167</span>         <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="mi">168</span>     <span class="p">}</span>
<span class="mi">169</span>
<span class="mi">170</span> <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>It’s worth noting that the “sendTiming” function initially generates a separate 
state called “WalkerSenderState.” This state variable is essential for handling 
the requested page table access and for processing the response from the memory
subsystem once the page table access has been completed.</p>

<h2 id="handling-return-packet-from-memory-sub-system"><span class="me-2">Handling return packet from memory sub-system</span><a href="#handling-return-packet-from-memory-sub-system" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<p>When memory sub-system successfully handled the page table access request,
pagetable_walker receives the result packet through the port.
When the packet arrives to the port
connecting pagetable_walker and memory sub-system,
it invokes recvTimingResp function of the walker.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre></td><td class="rouge-code"><pre><span class="mi">104</span> <span class="kt">bool</span>
<span class="mi">105</span> <span class="n">Walker</span><span class="o">::</span><span class="n">WalkerPort</span><span class="o">::</span><span class="n">recvTimingResp</span><span class="p">(</span><span class="n">PacketPtr</span> <span class="n">pkt</span><span class="p">)</span>
<span class="mi">106</span> <span class="p">{</span>
<span class="mi">107</span>     <span class="k">return</span> <span class="n">walker</span><span class="o">-&gt;</span><span class="n">recvTimingResp</span><span class="p">(</span><span class="n">pkt</span><span class="p">);</span>
<span class="mi">108</span> <span class="p">}</span>
<span class="mi">109</span>
<span class="mi">110</span> <span class="kt">bool</span>
<span class="mi">111</span> <span class="n">Walker</span><span class="o">::</span><span class="n">recvTimingResp</span><span class="p">(</span><span class="n">PacketPtr</span> <span class="n">pkt</span><span class="p">)</span>
<span class="mi">112</span> <span class="p">{</span>
<span class="mi">113</span>     <span class="n">WalkerSenderState</span> <span class="o">*</span> <span class="n">senderState</span> <span class="o">=</span>
<span class="mi">114</span>         <span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="n">WalkerSenderState</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">popSenderState</span><span class="p">());</span>
<span class="mi">115</span>     <span class="n">WalkerState</span> <span class="o">*</span> <span class="n">senderWalk</span> <span class="o">=</span> <span class="n">senderState</span><span class="o">-&gt;</span><span class="n">senderWalk</span><span class="p">;</span>
<span class="mi">116</span>     <span class="kt">bool</span> <span class="n">walkComplete</span> <span class="o">=</span> <span class="n">senderWalk</span><span class="o">-&gt;</span><span class="n">recvPacket</span><span class="p">(</span><span class="n">pkt</span><span class="p">);</span>
<span class="mi">117</span>     <span class="k">delete</span> <span class="n">senderState</span><span class="p">;</span>
<span class="mi">118</span>     <span class="k">if</span> <span class="p">(</span><span class="n">walkComplete</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">119</span>         <span class="n">std</span><span class="o">::</span><span class="n">list</span><span class="o">&lt;</span><span class="n">WalkerState</span> <span class="o">*&gt;::</span><span class="n">iterator</span> <span class="n">iter</span><span class="p">;</span>
<span class="mi">120</span>         <span class="k">for</span> <span class="p">(</span><span class="n">iter</span> <span class="o">=</span> <span class="n">currStates</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span> <span class="n">iter</span> <span class="o">!=</span> <span class="n">currStates</span><span class="p">.</span><span class="n">end</span><span class="p">();</span> <span class="n">iter</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">121</span>             <span class="n">WalkerState</span> <span class="o">*</span> <span class="n">walkerState</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">iter</span><span class="p">);</span>
<span class="mi">122</span>             <span class="k">if</span> <span class="p">(</span><span class="n">walkerState</span> <span class="o">==</span> <span class="n">senderWalk</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">123</span>                 <span class="n">iter</span> <span class="o">=</span> <span class="n">currStates</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">iter</span><span class="p">);</span>
<span class="mi">124</span>                 <span class="k">break</span><span class="p">;</span>
<span class="mi">125</span>             <span class="p">}</span>
<span class="mi">126</span>         <span class="p">}</span>
<span class="mi">127</span>         <span class="k">delete</span> <span class="n">senderWalk</span><span class="p">;</span>
<span class="mi">128</span>         <span class="c1">// Since we block requests when another is outstanding, we</span>
<span class="mi">129</span>         <span class="c1">// need to check if there is a waiting request to be serviced</span>
<span class="mi">130</span>         <span class="nf">if</span> <span class="p">(</span><span class="n">currStates</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">startWalkWrapperEvent</span><span class="p">.</span><span class="n">scheduled</span><span class="p">())</span>
<span class="mi">131</span>             <span class="c1">// delay sending any new requests until we are finished</span>
<span class="mi">132</span>             <span class="c1">// with the responses</span>
<span class="mi">133</span>             <span class="n">schedule</span><span class="p">(</span><span class="n">startWalkWrapperEvent</span><span class="p">,</span> <span class="n">clockEdge</span><span class="p">());</span>
<span class="mi">134</span>     <span class="p">}</span>
<span class="mi">135</span>     <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="mi">136</span> <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>As we’ve seen before,
WalkerSenderState wraps up 
the walker instance (<em>WalkerState</em>) 
which has been used 
to send pagetable access request 
associated with currently received packet.</p>

<h3 id="recvpacket-handles-received-packet-and-send-another-packet-for-next-stage-pagetable-access"><span class="me-2">recvPacket handles received packet and send another packet for next stage pagetable access</span><a href="#recvpacket-handles-received-packet-and-send-another-packet-for-next-stage-pagetable-access" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>Retrieved WalkerState instance handles the received packet
by calling <em>recvPacket</em> function of the WalkerState.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
</pre></td><td class="rouge-code"><pre><span class="mi">602</span> <span class="kt">bool</span>
<span class="mi">603</span> <span class="n">Walker</span><span class="o">::</span><span class="n">WalkerState</span><span class="o">::</span><span class="n">recvPacket</span><span class="p">(</span><span class="n">PacketPtr</span> <span class="n">pkt</span><span class="p">)</span>
<span class="mi">604</span> <span class="p">{</span>
<span class="mi">605</span>     <span class="n">assert</span><span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">isResponse</span><span class="p">());</span>
<span class="mi">606</span>     <span class="n">assert</span><span class="p">(</span><span class="n">inflight</span><span class="p">);</span>
<span class="mi">607</span>     <span class="n">assert</span><span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">Waiting</span><span class="p">);</span>
<span class="mi">608</span>     <span class="n">inflight</span><span class="o">--</span><span class="p">;</span>
<span class="mi">609</span>     <span class="k">if</span> <span class="p">(</span><span class="n">squashed</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">610</span>         <span class="c1">// if were were squashed, return true once inflight is zero and</span>
<span class="mi">611</span>         <span class="c1">// this WalkerState will be freed there.</span>
<span class="mi">612</span>         <span class="k">return</span> <span class="p">(</span><span class="n">inflight</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
<span class="mi">613</span>     <span class="p">}</span>
<span class="mi">614</span>     <span class="nf">if</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">isRead</span><span class="p">())</span> <span class="p">{</span>
<span class="mi">615</span>         <span class="c1">// should not have a pending read it we also had one outstanding</span>
<span class="mi">616</span>         <span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">read</span><span class="p">);</span>
<span class="mi">617</span>
<span class="mi">618</span>         <span class="c1">// @todo someone should pay for this</span>
<span class="mi">619</span>         <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">headerDelay</span> <span class="o">=</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">payloadDelay</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="mi">620</span>
<span class="mi">621</span>         <span class="n">state</span> <span class="o">=</span> <span class="n">nextState</span><span class="p">;</span>
<span class="mi">622</span>         <span class="n">nextState</span> <span class="o">=</span> <span class="n">Ready</span><span class="p">;</span>
<span class="mi">623</span>         <span class="n">PacketPtr</span> <span class="n">write</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="mi">624</span>         <span class="n">read</span> <span class="o">=</span> <span class="n">pkt</span><span class="p">;</span>
<span class="mi">625</span>         <span class="n">timingFault</span> <span class="o">=</span> <span class="n">stepWalk</span><span class="p">(</span><span class="n">write</span><span class="p">);</span>
<span class="mi">626</span>         <span class="n">state</span> <span class="o">=</span> <span class="n">Waiting</span><span class="p">;</span>
<span class="mi">627</span>         <span class="n">assert</span><span class="p">(</span><span class="n">timingFault</span> <span class="o">==</span> <span class="n">NoFault</span> <span class="o">||</span> <span class="n">read</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="mi">628</span>         <span class="k">if</span> <span class="p">(</span><span class="n">write</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">629</span>             <span class="n">writes</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">write</span><span class="p">);</span>
<span class="mi">630</span>         <span class="p">}</span>
<span class="mi">631</span>         <span class="nf">sendPackets</span><span class="p">();</span>
<span class="mi">632</span>     <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="mi">633</span>         <span class="n">sendPackets</span><span class="p">();</span>
<span class="mi">634</span>     <span class="p">}</span>
<span class="mi">635</span>     <span class="nf">if</span> <span class="p">(</span><span class="n">inflight</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">read</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">writes</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">636</span>         <span class="n">state</span> <span class="o">=</span> <span class="n">Ready</span><span class="p">;</span>
<span class="mi">637</span>         <span class="n">nextState</span> <span class="o">=</span> <span class="n">Waiting</span><span class="p">;</span>
<span class="mi">638</span>         <span class="k">if</span> <span class="p">(</span><span class="n">timingFault</span> <span class="o">==</span> <span class="n">NoFault</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">639</span>             <span class="cm">/*
640              * Finish the translation. Now that we know the right entry is
641              * in the TLB, this should work with no memory accesses.
642              * There could be new faults unrelated to the table walk like
643              * permissions violations, so we'll need the return value as
644              * well.
645              */</span>
<span class="mi">646</span>             <span class="kt">bool</span> <span class="n">delayedResponse</span><span class="p">;</span>
<span class="mi">647</span>             <span class="n">Fault</span> <span class="n">fault</span> <span class="o">=</span> <span class="n">walker</span><span class="o">-&gt;</span><span class="n">tlb</span><span class="o">-&gt;</span><span class="n">translate</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">tc</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span>
<span class="mi">648</span>                                                  <span class="n">delayedResponse</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
<span class="mi">649</span>             <span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">delayedResponse</span><span class="p">);</span>
<span class="mi">650</span>             <span class="c1">// Let the CPU continue.</span>
<span class="mi">651</span>             <span class="n">translation</span><span class="o">-&gt;</span><span class="n">finish</span><span class="p">(</span><span class="n">fault</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">tc</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
<span class="mi">652</span>         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="mi">653</span>             <span class="c1">// There was a fault during the walk. Let the CPU know.</span>
<span class="mi">654</span>             <span class="n">translation</span><span class="o">-&gt;</span><span class="n">finish</span><span class="p">(</span><span class="n">timingFault</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">tc</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
<span class="mi">655</span>         <span class="p">}</span>
<span class="mi">656</span>         <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="mi">657</span>     <span class="p">}</span>
<span class="mi">658</span>
<span class="mi">659</span>     <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="mi">660</span> <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>
<p>Because the recvPacket function has been invoked 
as a result of memory read (initial pagetable access)
614-634 will be executed. 
There are some functions that we don’t know,
but it finally invokes <em>sendPackets</em> function again.
Wait why sendPackets once again in receive function?</p>

<h3 id="remember-page-table-walking-is-not-a-single-memory-access"><span class="me-2">Remember! Page table walking is not a single memory access</span><a href="#remember-page-table-walking-is-not-a-single-memory-access" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>Note that we are currently dealing with the result packet 
from the memory sub-system 
as a result of 
sending initial pagetable access request (accessing first level of pagetable)
Therefore, the received packet should contain
next level page table information 
not the Page table entry which actually contains
physical address to virtual address mapping. 
Therefore, to acquire the last level page table entry,
it needs additional memory accesses to the sub levels of pagetables,
which should requires another sendPackets.</p>

<h3 id="preparing-packets-for-the-next-pagetable-access-requests"><span class="me-2">Preparing packets for the next pagetable access requests</span><a href="#preparing-packets-for-the-next-pagetable-access-requests" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>As we generated initiating packet with the help of setupWalk,
packets required for accessing further page table layers 
are prepared by <em>stepWalk</em> function.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
</pre></td><td class="rouge-code"><pre><span class="mi">282</span> <span class="n">Fault</span>
<span class="mi">283</span> <span class="n">Walker</span><span class="o">::</span><span class="n">WalkerState</span><span class="o">::</span><span class="n">stepWalk</span><span class="p">(</span><span class="n">PacketPtr</span> <span class="o">&amp;</span><span class="n">write</span><span class="p">)</span>
<span class="mi">284</span> <span class="p">{</span>
<span class="mi">285</span>     <span class="n">assert</span><span class="p">(</span><span class="n">state</span> <span class="o">!=</span> <span class="n">Ready</span> <span class="o">&amp;&amp;</span> <span class="n">state</span> <span class="o">!=</span> <span class="n">Waiting</span><span class="p">);</span>
<span class="mi">286</span>     <span class="n">Fault</span> <span class="n">fault</span> <span class="o">=</span> <span class="n">NoFault</span><span class="p">;</span>
<span class="mi">287</span>     <span class="n">write</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="mi">288</span>     <span class="n">PageTableEntry</span> <span class="n">pte</span><span class="p">;</span>
<span class="mi">289</span>     <span class="k">if</span> <span class="p">(</span><span class="n">dataSize</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span>
<span class="mi">290</span>         <span class="n">pte</span> <span class="o">=</span> <span class="n">read</span><span class="o">-&gt;</span><span class="n">getLE</span><span class="o">&lt;</span><span class="kt">uint64_t</span><span class="o">&gt;</span><span class="p">();</span>
<span class="mi">291</span>     <span class="k">else</span>
<span class="mi">292</span>         <span class="n">pte</span> <span class="o">=</span> <span class="n">read</span><span class="o">-&gt;</span><span class="n">getLE</span><span class="o">&lt;</span><span class="kt">uint32_t</span><span class="o">&gt;</span><span class="p">();</span>
<span class="mi">293</span>     <span class="n">VAddr</span> <span class="n">vaddr</span> <span class="o">=</span> <span class="n">entry</span><span class="p">.</span><span class="n">vaddr</span><span class="p">;</span>
<span class="mi">294</span>     <span class="kt">bool</span> <span class="n">uncacheable</span> <span class="o">=</span> <span class="n">pte</span><span class="p">.</span><span class="n">pcd</span><span class="p">;</span>
<span class="mi">295</span>     <span class="n">Addr</span> <span class="n">nextRead</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="mi">296</span>     <span class="kt">bool</span> <span class="n">doWrite</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="mi">297</span>     <span class="kt">bool</span> <span class="n">doTLBInsert</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="mi">298</span>     <span class="kt">bool</span> <span class="n">doEndWalk</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="mi">299</span>     <span class="kt">bool</span> <span class="n">badNX</span> <span class="o">=</span> <span class="n">pte</span><span class="p">.</span><span class="n">nx</span> <span class="o">&amp;&amp;</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">BaseTLB</span><span class="o">::</span><span class="n">Execute</span> <span class="o">&amp;&amp;</span> <span class="n">enableNX</span><span class="p">;</span>
<span class="mi">300</span>     <span class="k">switch</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">301</span>       <span class="k">case</span> <span class="n">LongPML4</span><span class="p">:</span>
<span class="mi">302</span>         <span class="n">DPRINTF</span><span class="p">(</span><span class="n">PageTableWalker</span><span class="p">,</span>
<span class="mi">303</span>                 <span class="s">"Got long mode PML4 entry %#016x.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint64_t</span><span class="p">)</span><span class="n">pte</span><span class="p">);</span>
<span class="mi">304</span>         <span class="n">nextRead</span> <span class="o">=</span> <span class="p">((</span><span class="kt">uint64_t</span><span class="p">)</span><span class="n">pte</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">mask</span><span class="p">(</span><span class="mi">40</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">))</span> <span class="o">+</span> <span class="n">vaddr</span><span class="p">.</span><span class="n">longl3</span> <span class="o">*</span> <span class="n">dataSize</span><span class="p">;</span>
<span class="mi">305</span>         <span class="n">doWrite</span> <span class="o">=</span> <span class="o">!</span><span class="n">pte</span><span class="p">.</span><span class="n">a</span><span class="p">;</span>
<span class="mi">306</span>         <span class="n">pte</span><span class="p">.</span><span class="n">a</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="mi">307</span>         <span class="n">entry</span><span class="p">.</span><span class="n">writable</span> <span class="o">=</span> <span class="n">pte</span><span class="p">.</span><span class="n">w</span><span class="p">;</span>
<span class="mi">308</span>         <span class="n">entry</span><span class="p">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">pte</span><span class="p">.</span><span class="n">u</span><span class="p">;</span>
<span class="mi">309</span>         <span class="k">if</span> <span class="p">(</span><span class="n">badNX</span> <span class="o">||</span> <span class="o">!</span><span class="n">pte</span><span class="p">.</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">310</span>             <span class="n">doEndWalk</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="mi">311</span>             <span class="n">fault</span> <span class="o">=</span> <span class="n">pageFault</span><span class="p">(</span><span class="n">pte</span><span class="p">.</span><span class="n">p</span><span class="p">);</span>
<span class="mi">312</span>             <span class="k">break</span><span class="p">;</span>
<span class="mi">313</span>         <span class="p">}</span>
<span class="mi">314</span>         <span class="n">entry</span><span class="p">.</span><span class="n">noExec</span> <span class="o">=</span> <span class="n">pte</span><span class="p">.</span><span class="n">nx</span><span class="p">;</span>
<span class="mi">315</span>         <span class="n">nextState</span> <span class="o">=</span> <span class="n">LongPDP</span><span class="p">;</span>
<span class="mi">316</span>         <span class="k">break</span><span class="p">;</span>
<span class="mi">317</span>       <span class="k">case</span> <span class="n">LongPDP</span><span class="p">:</span>
<span class="mi">318</span>         <span class="nf">DPRINTF</span><span class="p">(</span><span class="n">PageTableWalker</span><span class="p">,</span>
<span class="mi">319</span>                 <span class="s">"Got long mode PDP entry %#016x.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint64_t</span><span class="p">)</span><span class="n">pte</span><span class="p">);</span>
<span class="mi">320</span>         <span class="n">nextRead</span> <span class="o">=</span> <span class="p">((</span><span class="kt">uint64_t</span><span class="p">)</span><span class="n">pte</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">mask</span><span class="p">(</span><span class="mi">40</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">))</span> <span class="o">+</span> <span class="n">vaddr</span><span class="p">.</span><span class="n">longl2</span> <span class="o">*</span> <span class="n">dataSize</span><span class="p">;</span>
<span class="mi">321</span>         <span class="n">doWrite</span> <span class="o">=</span> <span class="o">!</span><span class="n">pte</span><span class="p">.</span><span class="n">a</span><span class="p">;</span>
<span class="mi">322</span>         <span class="n">pte</span><span class="p">.</span><span class="n">a</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="mi">323</span>         <span class="n">entry</span><span class="p">.</span><span class="n">writable</span> <span class="o">=</span> <span class="n">entry</span><span class="p">.</span><span class="n">writable</span> <span class="o">&amp;&amp;</span> <span class="n">pte</span><span class="p">.</span><span class="n">w</span><span class="p">;</span>
<span class="mi">324</span>         <span class="n">entry</span><span class="p">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">entry</span><span class="p">.</span><span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">pte</span><span class="p">.</span><span class="n">u</span><span class="p">;</span>
<span class="mi">325</span>         <span class="nf">if</span> <span class="p">(</span><span class="n">badNX</span> <span class="o">||</span> <span class="o">!</span><span class="n">pte</span><span class="p">.</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">326</span>             <span class="n">doEndWalk</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="mi">327</span>             <span class="n">fault</span> <span class="o">=</span> <span class="n">pageFault</span><span class="p">(</span><span class="n">pte</span><span class="p">.</span><span class="n">p</span><span class="p">);</span>
<span class="mi">328</span>             <span class="k">break</span><span class="p">;</span>
<span class="mi">329</span>         <span class="p">}</span>
<span class="mi">330</span>         <span class="n">nextState</span> <span class="o">=</span> <span class="n">LongPD</span><span class="p">;</span>
<span class="mi">331</span>         <span class="k">break</span><span class="p">;</span>
<span class="mi">332</span>       <span class="k">case</span> <span class="n">LongPD</span><span class="p">:</span>
<span class="mi">333</span>         <span class="nf">DPRINTF</span><span class="p">(</span><span class="n">PageTableWalker</span><span class="p">,</span>
<span class="mi">334</span>                 <span class="s">"Got long mode PD entry %#016x.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint64_t</span><span class="p">)</span><span class="n">pte</span><span class="p">);</span>
<span class="mi">335</span>         <span class="n">doWrite</span> <span class="o">=</span> <span class="o">!</span><span class="n">pte</span><span class="p">.</span><span class="n">a</span><span class="p">;</span>
<span class="mi">336</span>         <span class="n">pte</span><span class="p">.</span><span class="n">a</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="mi">337</span>         <span class="n">entry</span><span class="p">.</span><span class="n">writable</span> <span class="o">=</span> <span class="n">entry</span><span class="p">.</span><span class="n">writable</span> <span class="o">&amp;&amp;</span> <span class="n">pte</span><span class="p">.</span><span class="n">w</span><span class="p">;</span>
<span class="mi">338</span>         <span class="n">entry</span><span class="p">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">entry</span><span class="p">.</span><span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">pte</span><span class="p">.</span><span class="n">u</span><span class="p">;</span>
<span class="mi">339</span>         <span class="nf">if</span> <span class="p">(</span><span class="n">badNX</span> <span class="o">||</span> <span class="o">!</span><span class="n">pte</span><span class="p">.</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">340</span>             <span class="n">doEndWalk</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="mi">341</span>             <span class="n">fault</span> <span class="o">=</span> <span class="n">pageFault</span><span class="p">(</span><span class="n">pte</span><span class="p">.</span><span class="n">p</span><span class="p">);</span>
<span class="mi">342</span>             <span class="k">break</span><span class="p">;</span>
<span class="mi">343</span>         <span class="p">}</span>
<span class="mi">344</span>         <span class="nf">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pte</span><span class="p">.</span><span class="n">ps</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">345</span>             <span class="c1">// 4 KB page</span>
<span class="mi">346</span>             <span class="n">entry</span><span class="p">.</span><span class="n">logBytes</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>
<span class="mi">347</span>             <span class="n">nextRead</span> <span class="o">=</span>
<span class="mi">348</span>                 <span class="p">((</span><span class="kt">uint64_t</span><span class="p">)</span><span class="n">pte</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">mask</span><span class="p">(</span><span class="mi">40</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">))</span> <span class="o">+</span> <span class="n">vaddr</span><span class="p">.</span><span class="n">longl1</span> <span class="o">*</span> <span class="n">dataSize</span><span class="p">;</span>
<span class="mi">349</span>             <span class="n">nextState</span> <span class="o">=</span> <span class="n">LongPTE</span><span class="p">;</span>
<span class="mi">350</span>             <span class="k">break</span><span class="p">;</span>
<span class="mi">351</span>         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="mi">352</span>             <span class="c1">// 2 MB page</span>
<span class="mi">353</span>             <span class="n">entry</span><span class="p">.</span><span class="n">logBytes</span> <span class="o">=</span> <span class="mi">21</span><span class="p">;</span>
<span class="mi">354</span>             <span class="n">entry</span><span class="p">.</span><span class="n">paddr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint64_t</span><span class="p">)</span><span class="n">pte</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">mask</span><span class="p">(</span><span class="mi">31</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">21</span><span class="p">);</span>
<span class="mi">355</span>             <span class="n">entry</span><span class="p">.</span><span class="n">uncacheable</span> <span class="o">=</span> <span class="n">uncacheable</span><span class="p">;</span>
<span class="mi">356</span>             <span class="n">entry</span><span class="p">.</span><span class="n">global</span> <span class="o">=</span> <span class="n">pte</span><span class="p">.</span><span class="n">g</span><span class="p">;</span>
<span class="mi">357</span>             <span class="n">entry</span><span class="p">.</span><span class="n">patBit</span> <span class="o">=</span> <span class="n">bits</span><span class="p">(</span><span class="n">pte</span><span class="p">,</span> <span class="mi">12</span><span class="p">);</span>
<span class="mi">358</span>             <span class="n">entry</span><span class="p">.</span><span class="n">vaddr</span> <span class="o">=</span> <span class="n">entry</span><span class="p">.</span><span class="n">vaddr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">((</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<span class="mi">359</span>             <span class="n">doTLBInsert</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="mi">360</span>             <span class="n">doEndWalk</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="mi">361</span>             <span class="k">break</span><span class="p">;</span>
<span class="mi">362</span>         <span class="p">}</span>
<span class="mi">363</span>       <span class="k">case</span> <span class="n">LongPTE</span><span class="p">:</span>
<span class="mi">364</span>         <span class="nf">DPRINTF</span><span class="p">(</span><span class="n">PageTableWalker</span><span class="p">,</span>
<span class="mi">365</span>                 <span class="s">"Got long mode PTE entry %#016x.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint64_t</span><span class="p">)</span><span class="n">pte</span><span class="p">);</span>
<span class="mi">366</span>         <span class="n">doWrite</span> <span class="o">=</span> <span class="o">!</span><span class="n">pte</span><span class="p">.</span><span class="n">a</span><span class="p">;</span>
<span class="mi">367</span>         <span class="n">pte</span><span class="p">.</span><span class="n">a</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="mi">368</span>         <span class="n">entry</span><span class="p">.</span><span class="n">writable</span> <span class="o">=</span> <span class="n">entry</span><span class="p">.</span><span class="n">writable</span> <span class="o">&amp;&amp;</span> <span class="n">pte</span><span class="p">.</span><span class="n">w</span><span class="p">;</span>
<span class="mi">369</span>         <span class="n">entry</span><span class="p">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">entry</span><span class="p">.</span><span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">pte</span><span class="p">.</span><span class="n">u</span><span class="p">;</span>
<span class="mi">370</span>         <span class="nf">if</span> <span class="p">(</span><span class="n">badNX</span> <span class="o">||</span> <span class="o">!</span><span class="n">pte</span><span class="p">.</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">371</span>             <span class="n">doEndWalk</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="mi">372</span>             <span class="n">fault</span> <span class="o">=</span> <span class="n">pageFault</span><span class="p">(</span><span class="n">pte</span><span class="p">.</span><span class="n">p</span><span class="p">);</span>
<span class="mi">373</span>             <span class="k">break</span><span class="p">;</span>
<span class="mi">374</span>         <span class="p">}</span>
<span class="mi">375</span>         <span class="n">entry</span><span class="p">.</span><span class="n">paddr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint64_t</span><span class="p">)</span><span class="n">pte</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">mask</span><span class="p">(</span><span class="mi">40</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">);</span>
<span class="mi">376</span>         <span class="n">entry</span><span class="p">.</span><span class="n">uncacheable</span> <span class="o">=</span> <span class="n">uncacheable</span><span class="p">;</span>
<span class="mi">377</span>         <span class="n">entry</span><span class="p">.</span><span class="n">global</span> <span class="o">=</span> <span class="n">pte</span><span class="p">.</span><span class="n">g</span><span class="p">;</span>
<span class="mi">378</span>         <span class="n">entry</span><span class="p">.</span><span class="n">patBit</span> <span class="o">=</span> <span class="n">bits</span><span class="p">(</span><span class="n">pte</span><span class="p">,</span> <span class="mi">12</span><span class="p">);</span>
<span class="mi">379</span>         <span class="n">entry</span><span class="p">.</span><span class="n">vaddr</span> <span class="o">=</span> <span class="n">entry</span><span class="p">.</span><span class="n">vaddr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">((</span><span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<span class="mi">380</span>         <span class="n">doTLBInsert</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="mi">381</span>         <span class="n">doEndWalk</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="mi">382</span>         <span class="k">break</span><span class="p">;</span>
<span class="mi">383</span>       <span class="k">case</span> <span class="n">PAEPDP</span><span class="p">:</span>
<span class="mi">384</span>         <span class="nf">DPRINTF</span><span class="p">(</span><span class="n">PageTableWalker</span><span class="p">,</span>
<span class="mi">385</span>                 <span class="s">"Got legacy mode PAE PDP entry %#08x.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">pte</span><span class="p">);</span>
<span class="mi">386</span>         <span class="n">nextRead</span> <span class="o">=</span> <span class="p">((</span><span class="kt">uint64_t</span><span class="p">)</span><span class="n">pte</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">mask</span><span class="p">(</span><span class="mi">40</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">))</span> <span class="o">+</span> <span class="n">vaddr</span><span class="p">.</span><span class="n">pael2</span> <span class="o">*</span> <span class="n">dataSize</span><span class="p">;</span>
<span class="mi">387</span>         <span class="nf">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pte</span><span class="p">.</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">388</span>             <span class="n">doEndWalk</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="mi">389</span>             <span class="n">fault</span> <span class="o">=</span> <span class="n">pageFault</span><span class="p">(</span><span class="n">pte</span><span class="p">.</span><span class="n">p</span><span class="p">);</span>
<span class="mi">390</span>             <span class="k">break</span><span class="p">;</span>
<span class="mi">391</span>         <span class="p">}</span>
<span class="mi">392</span>         <span class="n">nextState</span> <span class="o">=</span> <span class="n">PAEPD</span><span class="p">;</span>
<span class="mi">393</span>         <span class="k">break</span><span class="p">;</span>
<span class="mi">394</span>       <span class="k">case</span> <span class="n">PAEPD</span><span class="p">:</span>
<span class="mi">395</span>         <span class="nf">DPRINTF</span><span class="p">(</span><span class="n">PageTableWalker</span><span class="p">,</span>
<span class="mi">396</span>                 <span class="s">"Got legacy mode PAE PD entry %#08x.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">pte</span><span class="p">);</span>
<span class="mi">397</span>         <span class="n">doWrite</span> <span class="o">=</span> <span class="o">!</span><span class="n">pte</span><span class="p">.</span><span class="n">a</span><span class="p">;</span>
<span class="mi">398</span>         <span class="n">pte</span><span class="p">.</span><span class="n">a</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="mi">399</span>         <span class="n">entry</span><span class="p">.</span><span class="n">writable</span> <span class="o">=</span> <span class="n">pte</span><span class="p">.</span><span class="n">w</span><span class="p">;</span>
<span class="mi">400</span>         <span class="n">entry</span><span class="p">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">pte</span><span class="p">.</span><span class="n">u</span><span class="p">;</span>
<span class="mi">401</span>         <span class="nf">if</span> <span class="p">(</span><span class="n">badNX</span> <span class="o">||</span> <span class="o">!</span><span class="n">pte</span><span class="p">.</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">402</span>             <span class="n">doEndWalk</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="mi">403</span>             <span class="n">fault</span> <span class="o">=</span> <span class="n">pageFault</span><span class="p">(</span><span class="n">pte</span><span class="p">.</span><span class="n">p</span><span class="p">);</span>
<span class="mi">404</span>             <span class="k">break</span><span class="p">;</span>
<span class="mi">405</span>         <span class="p">}</span>
<span class="mi">406</span>         <span class="nf">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pte</span><span class="p">.</span><span class="n">ps</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">407</span>             <span class="c1">// 4 KB page</span>
<span class="mi">408</span>             <span class="n">entry</span><span class="p">.</span><span class="n">logBytes</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>
<span class="mi">409</span>             <span class="n">nextRead</span> <span class="o">=</span> <span class="p">((</span><span class="kt">uint64_t</span><span class="p">)</span><span class="n">pte</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">mask</span><span class="p">(</span><span class="mi">40</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">))</span> <span class="o">+</span> <span class="n">vaddr</span><span class="p">.</span><span class="n">pael1</span> <span class="o">*</span> <span class="n">dataSize</span><span class="p">;</span>
<span class="mi">410</span>             <span class="n">nextState</span> <span class="o">=</span> <span class="n">PAEPTE</span><span class="p">;</span>
<span class="mi">411</span>             <span class="k">break</span><span class="p">;</span>
<span class="mi">412</span>         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="mi">413</span>             <span class="c1">// 2 MB page</span>
<span class="mi">414</span>             <span class="n">entry</span><span class="p">.</span><span class="n">logBytes</span> <span class="o">=</span> <span class="mi">21</span><span class="p">;</span>
<span class="mi">415</span>             <span class="n">entry</span><span class="p">.</span><span class="n">paddr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint64_t</span><span class="p">)</span><span class="n">pte</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">mask</span><span class="p">(</span><span class="mi">31</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">21</span><span class="p">);</span>
<span class="mi">416</span>             <span class="n">entry</span><span class="p">.</span><span class="n">uncacheable</span> <span class="o">=</span> <span class="n">uncacheable</span><span class="p">;</span>
<span class="mi">417</span>             <span class="n">entry</span><span class="p">.</span><span class="n">global</span> <span class="o">=</span> <span class="n">pte</span><span class="p">.</span><span class="n">g</span><span class="p">;</span>
<span class="mi">418</span>             <span class="n">entry</span><span class="p">.</span><span class="n">patBit</span> <span class="o">=</span> <span class="n">bits</span><span class="p">(</span><span class="n">pte</span><span class="p">,</span> <span class="mi">12</span><span class="p">);</span>
<span class="mi">419</span>             <span class="n">entry</span><span class="p">.</span><span class="n">vaddr</span> <span class="o">=</span> <span class="n">entry</span><span class="p">.</span><span class="n">vaddr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">((</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<span class="mi">420</span>             <span class="n">doTLBInsert</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="mi">421</span>             <span class="n">doEndWalk</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="mi">422</span>             <span class="k">break</span><span class="p">;</span>
<span class="mi">443</span>         <span class="k">break</span><span class="p">;</span>
<span class="mi">444</span>       <span class="k">case</span> <span class="n">PSEPD</span><span class="p">:</span>                                                                                                                       <span class="mi">445</span>         <span class="n">DPRINTF</span><span class="p">(</span><span class="n">PageTableWalker</span><span class="p">,</span>
<span class="mi">446</span>                 <span class="s">"Got legacy mode PSE PD entry %#08x.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">pte</span><span class="p">);</span>
<span class="mi">447</span>         <span class="n">doWrite</span> <span class="o">=</span> <span class="o">!</span><span class="n">pte</span><span class="p">.</span><span class="n">a</span><span class="p">;</span>
<span class="mi">448</span>         <span class="n">pte</span><span class="p">.</span><span class="n">a</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="mi">449</span>         <span class="n">entry</span><span class="p">.</span><span class="n">writable</span> <span class="o">=</span> <span class="n">pte</span><span class="p">.</span><span class="n">w</span><span class="p">;</span>
<span class="mi">450</span>         <span class="n">entry</span><span class="p">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">pte</span><span class="p">.</span><span class="n">u</span><span class="p">;</span>
<span class="mi">451</span>         <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pte</span><span class="p">.</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">452</span>             <span class="n">doEndWalk</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="mi">453</span>             <span class="n">fault</span> <span class="o">=</span> <span class="n">pageFault</span><span class="p">(</span><span class="n">pte</span><span class="p">.</span><span class="n">p</span><span class="p">);</span>
<span class="mi">454</span>             <span class="k">break</span><span class="p">;</span>
<span class="mi">455</span>         <span class="p">}</span>
<span class="mi">456</span>         <span class="nf">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pte</span><span class="p">.</span><span class="n">ps</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">457</span>             <span class="c1">// 4 KB page</span>
<span class="mi">458</span>             <span class="n">entry</span><span class="p">.</span><span class="n">logBytes</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>
<span class="mi">459</span>             <span class="n">nextRead</span> <span class="o">=</span>
<span class="mi">460</span>                 <span class="p">((</span><span class="kt">uint64_t</span><span class="p">)</span><span class="n">pte</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">mask</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">))</span> <span class="o">+</span> <span class="n">vaddr</span><span class="p">.</span><span class="n">norml2</span> <span class="o">*</span> <span class="n">dataSize</span><span class="p">;</span>
<span class="mi">461</span>             <span class="n">nextState</span> <span class="o">=</span> <span class="n">PTE</span><span class="p">;</span>
<span class="mi">462</span>             <span class="k">break</span><span class="p">;</span>
<span class="mi">463</span>         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="mi">464</span>             <span class="c1">// 4 MB page</span>
<span class="mi">465</span>             <span class="n">entry</span><span class="p">.</span><span class="n">logBytes</span> <span class="o">=</span> <span class="mi">21</span><span class="p">;</span>
<span class="mi">466</span>             <span class="n">entry</span><span class="p">.</span><span class="n">paddr</span> <span class="o">=</span> <span class="n">bits</span><span class="p">(</span><span class="n">pte</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">13</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span> <span class="o">|</span> <span class="n">bits</span><span class="p">(</span><span class="n">pte</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">22</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">22</span><span class="p">;</span>
<span class="mi">467</span>             <span class="n">entry</span><span class="p">.</span><span class="n">uncacheable</span> <span class="o">=</span> <span class="n">uncacheable</span><span class="p">;</span>
<span class="mi">468</span>             <span class="n">entry</span><span class="p">.</span><span class="n">global</span> <span class="o">=</span> <span class="n">pte</span><span class="p">.</span><span class="n">g</span><span class="p">;</span>
<span class="mi">469</span>             <span class="n">entry</span><span class="p">.</span><span class="n">patBit</span> <span class="o">=</span> <span class="n">bits</span><span class="p">(</span><span class="n">pte</span><span class="p">,</span> <span class="mi">12</span><span class="p">);</span>
<span class="mi">470</span>             <span class="n">entry</span><span class="p">.</span><span class="n">vaddr</span> <span class="o">=</span> <span class="n">entry</span><span class="p">.</span><span class="n">vaddr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">((</span><span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<span class="mi">471</span>             <span class="n">doTLBInsert</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="mi">472</span>             <span class="n">doEndWalk</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="mi">473</span>             <span class="k">break</span><span class="p">;</span>
<span class="mi">474</span>         <span class="p">}</span>
<span class="mi">475</span>       <span class="k">case</span> <span class="n">PD</span><span class="p">:</span>
<span class="mi">476</span>         <span class="nf">DPRINTF</span><span class="p">(</span><span class="n">PageTableWalker</span><span class="p">,</span>
<span class="mi">477</span>                 <span class="s">"Got legacy mode PD entry %#08x.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">pte</span><span class="p">);</span>
<span class="mi">478</span>         <span class="n">doWrite</span> <span class="o">=</span> <span class="o">!</span><span class="n">pte</span><span class="p">.</span><span class="n">a</span><span class="p">;</span>
<span class="mi">479</span>         <span class="n">pte</span><span class="p">.</span><span class="n">a</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="mi">480</span>         <span class="n">entry</span><span class="p">.</span><span class="n">writable</span> <span class="o">=</span> <span class="n">pte</span><span class="p">.</span><span class="n">w</span><span class="p">;</span>
<span class="mi">481</span>         <span class="n">entry</span><span class="p">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">pte</span><span class="p">.</span><span class="n">u</span><span class="p">;</span>
<span class="mi">482</span>         <span class="nf">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pte</span><span class="p">.</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">483</span>             <span class="n">doEndWalk</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="mi">484</span>             <span class="n">fault</span> <span class="o">=</span> <span class="n">pageFault</span><span class="p">(</span><span class="n">pte</span><span class="p">.</span><span class="n">p</span><span class="p">);</span>
<span class="mi">485</span>             <span class="k">break</span><span class="p">;</span>
<span class="mi">486</span>         <span class="p">}</span>
<span class="mi">487</span>         <span class="c1">// 4 KB page</span>
<span class="mi">488</span>         <span class="n">entry</span><span class="p">.</span><span class="n">logBytes</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>
<span class="mi">489</span>         <span class="n">nextRead</span> <span class="o">=</span> <span class="p">((</span><span class="kt">uint64_t</span><span class="p">)</span><span class="n">pte</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">mask</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">))</span> <span class="o">+</span> <span class="n">vaddr</span><span class="p">.</span><span class="n">norml2</span> <span class="o">*</span> <span class="n">dataSize</span><span class="p">;</span>
<span class="mi">490</span>         <span class="n">nextState</span> <span class="o">=</span> <span class="n">PTE</span><span class="p">;</span>
<span class="mi">491</span>         <span class="k">break</span><span class="p">;</span>
<span class="mi">492</span>       <span class="k">case</span> <span class="n">PTE</span><span class="p">:</span>
<span class="mi">493</span>         <span class="nf">DPRINTF</span><span class="p">(</span><span class="n">PageTableWalker</span><span class="p">,</span>
<span class="mi">494</span>                 <span class="s">"Got legacy mode PTE entry %#08x.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">pte</span><span class="p">);</span>
<span class="mi">495</span>         <span class="n">doWrite</span> <span class="o">=</span> <span class="o">!</span><span class="n">pte</span><span class="p">.</span><span class="n">a</span><span class="p">;</span>
<span class="mi">496</span>         <span class="n">pte</span><span class="p">.</span><span class="n">a</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="mi">497</span>         <span class="n">entry</span><span class="p">.</span><span class="n">writable</span> <span class="o">=</span> <span class="n">pte</span><span class="p">.</span><span class="n">w</span><span class="p">;</span>
<span class="mi">498</span>         <span class="n">entry</span><span class="p">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">pte</span><span class="p">.</span><span class="n">u</span><span class="p">;</span>
<span class="mi">499</span>         <span class="nf">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pte</span><span class="p">.</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">500</span>             <span class="n">doEndWalk</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="mi">501</span>             <span class="n">fault</span> <span class="o">=</span> <span class="n">pageFault</span><span class="p">(</span><span class="n">pte</span><span class="p">.</span><span class="n">p</span><span class="p">);</span>
<span class="mi">502</span>             <span class="k">break</span><span class="p">;</span>
<span class="mi">503</span>         <span class="p">}</span>
<span class="mi">504</span>         <span class="n">entry</span><span class="p">.</span><span class="n">paddr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint64_t</span><span class="p">)</span><span class="n">pte</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">mask</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">);</span>
<span class="mi">505</span>         <span class="n">entry</span><span class="p">.</span><span class="n">uncacheable</span> <span class="o">=</span> <span class="n">uncacheable</span><span class="p">;</span>
<span class="mi">506</span>         <span class="n">entry</span><span class="p">.</span><span class="n">global</span> <span class="o">=</span> <span class="n">pte</span><span class="p">.</span><span class="n">g</span><span class="p">;</span>
<span class="mi">507</span>         <span class="n">entry</span><span class="p">.</span><span class="n">patBit</span> <span class="o">=</span> <span class="n">bits</span><span class="p">(</span><span class="n">pte</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>
<span class="mi">508</span>         <span class="n">entry</span><span class="p">.</span><span class="n">vaddr</span> <span class="o">=</span> <span class="n">entry</span><span class="p">.</span><span class="n">vaddr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">((</span><span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<span class="mi">509</span>         <span class="n">doTLBInsert</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="mi">510</span>         <span class="n">doEndWalk</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="mi">511</span>         <span class="k">break</span><span class="p">;</span>
<span class="mi">512</span>       <span class="k">default</span><span class="o">:</span>
<span class="mi">513</span>         <span class="nf">panic</span><span class="p">(</span><span class="s">"Unknown page table walker state %d!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="mi">514</span>     <span class="p">}</span>
<span class="mi">515</span>     <span class="nf">if</span> <span class="p">(</span><span class="n">doEndWalk</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">516</span>         <span class="k">if</span> <span class="p">(</span><span class="n">doTLBInsert</span><span class="p">)</span>
<span class="mi">517</span>             <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">functional</span><span class="p">)</span>
<span class="mi">518</span>                 <span class="n">walker</span><span class="o">-&gt;</span><span class="n">tlb</span><span class="o">-&gt;</span><span class="n">insert</span><span class="p">(</span><span class="n">entry</span><span class="p">.</span><span class="n">vaddr</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="n">tc</span><span class="p">);</span>
<span class="mi">519</span>         <span class="n">endWalk</span><span class="p">();</span>
<span class="mi">520</span>     <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="mi">521</span>         <span class="n">PacketPtr</span> <span class="n">oldRead</span> <span class="o">=</span> <span class="n">read</span><span class="p">;</span>
<span class="mi">522</span>         <span class="c1">//If we didn't return, we're setting up another read.</span>
<span class="mi">523</span>         <span class="n">Request</span><span class="o">::</span><span class="n">Flags</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">oldRead</span><span class="o">-&gt;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">getFlags</span><span class="p">();</span>
<span class="mi">524</span>         <span class="n">flags</span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="n">Request</span><span class="o">::</span><span class="n">UNCACHEABLE</span><span class="p">,</span> <span class="n">uncacheable</span><span class="p">);</span>
<span class="mi">525</span>         <span class="n">RequestPtr</span> <span class="n">request</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">Request</span><span class="o">&gt;</span><span class="p">(</span>
<span class="mi">526</span>             <span class="n">nextRead</span><span class="p">,</span> <span class="n">oldRead</span><span class="o">-&gt;</span><span class="n">getSize</span><span class="p">(),</span> <span class="n">flags</span><span class="p">,</span> <span class="n">walker</span><span class="o">-&gt;</span><span class="n">masterId</span><span class="p">);</span>
<span class="mi">527</span>         <span class="n">read</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Packet</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">MemCmd</span><span class="o">::</span><span class="n">ReadReq</span><span class="p">);</span>
<span class="mi">528</span>         <span class="n">read</span><span class="o">-&gt;</span><span class="n">allocate</span><span class="p">();</span>
<span class="mi">529</span>         <span class="c1">// If we need to write, adjust the read packet to write the modified</span>
<span class="mi">530</span>         <span class="c1">// value back to memory.</span>
<span class="mi">531</span>         <span class="k">if</span> <span class="p">(</span><span class="n">doWrite</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">532</span>             <span class="n">write</span> <span class="o">=</span> <span class="n">oldRead</span><span class="p">;</span>
<span class="mi">533</span>             <span class="n">write</span><span class="o">-&gt;</span><span class="n">setLE</span><span class="o">&lt;</span><span class="kt">uint64_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">pte</span><span class="p">);</span>
<span class="mi">534</span>             <span class="n">write</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">MemCmd</span><span class="o">::</span><span class="n">WriteReq</span><span class="p">;</span>
<span class="mi">535</span>         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="mi">536</span>             <span class="n">write</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="mi">537</span>             <span class="k">delete</span> <span class="n">oldRead</span><span class="p">;</span>
<span class="mi">538</span>         <span class="p">}</span>
<span class="mi">539</span>     <span class="p">}</span>
<span class="mi">540</span>     <span class="k">return</span> <span class="n">fault</span><span class="p">;</span>
<span class="mi">541</span> <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>
<p>Even though it is very long,
depending on the current state
representing a level of the page table 
accessed by the currently received packet,
next level page table address and corresponding packet is populated.</p>

<p>Because we are here
as a result of accessing PML4 (first level page table),
line 301-316 will be executed and prepare the information
to access the next level pagetable. 
Note that
the next state is set to
the next level of page table level, PDP.</p>

<p>After setting fields associated with next page table level access,
it generates another read packet (Line 520-539)
to convey all the information required to access the next level pagetable. 
Note that the newly populated packet is assigned to the read field of the 
current WalkerState object.
This read packet is used by the sendPackets function 
to access further pagetable layers.</p>

<p>These sending and receiving steps are repeated until the final PTE is read.
When PTE is read from the memory sub-system,
it sets the doEndWalk flag and doTLBInsert flag
When the flags are set,
new TLB entry is inserted to the TLB module (line 515-520).</p>

<h2 id="finish-tlb-translation"><span class="me-2">Finish TLB translation</span><a href="#finish-tlb-translation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<p>After the translation has been finished,
whether it ends up TLB hit, 
TLB miss and page table walking, 
or unexpected TLB fault,
it invokes <em>finish</em> function through a translation object.</p>

<p><em>gem5/src/arch/x86/tlb.cc</em></p>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre><span class="mi">441</span> <span class="kt">void</span>
<span class="mi">442</span> <span class="n">TLB</span><span class="o">::</span><span class="n">translateTiming</span><span class="p">(</span><span class="k">const</span> <span class="n">RequestPtr</span> <span class="o">&amp;</span><span class="n">req</span><span class="p">,</span> <span class="n">ThreadContext</span> <span class="o">*</span><span class="n">tc</span><span class="p">,</span>
<span class="mi">443</span>         <span class="n">Translation</span> <span class="o">*</span><span class="n">translation</span><span class="p">,</span> <span class="n">Mode</span> <span class="n">mode</span><span class="p">)</span>
<span class="mi">444</span> <span class="p">{</span>
<span class="mi">445</span>     <span class="kt">bool</span> <span class="n">delayedResponse</span><span class="p">;</span>
<span class="mi">446</span>     <span class="n">assert</span><span class="p">(</span><span class="n">translation</span><span class="p">);</span>
<span class="mi">447</span>     <span class="n">Fault</span> <span class="n">fault</span> <span class="o">=</span>
<span class="mi">448</span>         <span class="n">TLB</span><span class="o">::</span><span class="n">translate</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">tc</span><span class="p">,</span> <span class="n">translation</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">delayedResponse</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
<span class="mi">449</span>
<span class="mi">450</span>     <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">delayedResponse</span><span class="p">)</span>
<span class="mi">451</span>         <span class="n">translation</span><span class="o">-&gt;</span><span class="n">finish</span><span class="p">(</span><span class="n">fault</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">tc</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
<span class="mi">452</span>     <span class="k">else</span>
<span class="mi">453</span>         <span class="n">translation</span><span class="o">-&gt;</span><span class="n">markDelayed</span><span class="p">();</span>
<span class="mi">454</span> <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<h2 id="translation-object"><span class="me-2">Translation object</span><a href="#translation-object" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<p>Wait, what is the translation object? 
We haven’t deal with it before.
Let’s go back to initiateMemRead function again
to understand what is the translation object.</p>

<h3 id="datatranslation-class-and-finish-method"><span class="me-2">DataTranslation class and finish method</span><a href="#datatranslation-class-and-finish-method" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre> <span class="mi">464</span>         <span class="n">WholeTranslationState</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span>
 <span class="mi">465</span>             <span class="k">new</span> <span class="nf">WholeTranslationState</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="k">new</span> <span class="kt">uint8_t</span><span class="p">[</span><span class="n">size</span><span class="p">],</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
 <span class="mi">466</span>         <span class="n">DataTranslation</span><span class="o">&lt;</span><span class="n">TimingSimpleCPU</span> <span class="o">*&gt;</span> <span class="o">*</span><span class="n">translation</span>
 <span class="mi">467</span>             <span class="o">=</span> <span class="k">new</span> <span class="n">DataTranslation</span><span class="o">&lt;</span><span class="n">TimingSimpleCPU</span> <span class="o">*&gt;</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
 <span class="mi">468</span>         <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">dtb</span><span class="o">-&gt;</span><span class="n">translateTiming</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">getTC</span><span class="p">(),</span> <span class="n">translation</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></div></div>

<p>At line 464-468, we can find that 
it is an object of <em>DataTranslation</em> class.
To find out implementation of finish function,
let’s take a look at DataTranslation class.</p>

<p><em>gem5/src/cpu/translation.hh</em></p>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
</pre></td><td class="rouge-code"><pre><span class="mi">208</span> <span class="cm">/**
209  * This class represents part of a data address translation.  All state for
210  * the translation is held in WholeTranslationState (above).  Therefore this
211  * class does not need to know whether the translation is split or not.  The
212  * index variable determines this but is simply passed on to the state class.
213  * When this part of the translation is completed, finish is called.  If the
214  * translation state class indicate that the whole translation is complete
215  * then the execution context is informed.
216  */</span>
<span class="mi">217</span> <span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">ExecContextPtr</span><span class="p">&gt;</span>
<span class="mi">218</span> <span class="k">class</span> <span class="nc">DataTranslation</span> <span class="o">:</span> <span class="k">public</span> <span class="n">BaseTLB</span><span class="o">::</span><span class="n">Translation</span>
<span class="mi">219</span> <span class="p">{</span>
<span class="mi">220</span>   <span class="k">protected</span><span class="o">:</span>
<span class="mi">221</span>     <span class="n">ExecContextPtr</span> <span class="n">xc</span><span class="p">;</span>
<span class="mi">222</span>     <span class="n">WholeTranslationState</span> <span class="o">*</span><span class="n">state</span><span class="p">;</span>
<span class="mi">223</span>     <span class="kt">int</span> <span class="n">index</span><span class="p">;</span>
<span class="mi">224</span>
<span class="mi">225</span>   <span class="k">public</span><span class="o">:</span>
<span class="mi">226</span>     <span class="n">DataTranslation</span><span class="p">(</span><span class="n">ExecContextPtr</span> <span class="n">_xc</span><span class="p">,</span> <span class="n">WholeTranslationState</span><span class="o">*</span> <span class="n">_state</span><span class="p">)</span>
<span class="mi">227</span>         <span class="o">:</span> <span class="n">xc</span><span class="p">(</span><span class="n">_xc</span><span class="p">),</span> <span class="n">state</span><span class="p">(</span><span class="n">_state</span><span class="p">),</span> <span class="n">index</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="mi">228</span>     <span class="p">{</span>
<span class="mi">229</span>     <span class="p">}</span>
<span class="mi">230</span>
<span class="mi">231</span>     <span class="n">DataTranslation</span><span class="p">(</span><span class="n">ExecContextPtr</span> <span class="n">_xc</span><span class="p">,</span> <span class="n">WholeTranslationState</span><span class="o">*</span> <span class="n">_state</span><span class="p">,</span>
<span class="mi">232</span>                     <span class="kt">int</span> <span class="n">_index</span><span class="p">)</span>
<span class="mi">233</span>         <span class="o">:</span> <span class="n">xc</span><span class="p">(</span><span class="n">_xc</span><span class="p">),</span> <span class="n">state</span><span class="p">(</span><span class="n">_state</span><span class="p">),</span> <span class="n">index</span><span class="p">(</span><span class="n">_index</span><span class="p">)</span>
<span class="mi">234</span>     <span class="p">{</span>
<span class="mi">235</span>     <span class="p">}</span>
<span class="mi">236</span>
<span class="mi">237</span>     <span class="cm">/**
238      * Signal the translation state that the translation has been delayed due
239      * to a hw page table walk.  Split requests are transparently handled.
240      */</span>
<span class="mi">241</span>     <span class="kt">void</span>
<span class="mi">242</span>     <span class="n">markDelayed</span><span class="p">()</span>
<span class="mi">243</span>     <span class="p">{</span>
<span class="mi">244</span>         <span class="n">state</span><span class="o">-&gt;</span><span class="n">delay</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="mi">245</span>     <span class="p">}</span>
<span class="mi">246</span>
<span class="mi">247</span>     <span class="cm">/**
248      * Finish this part of the translation and indicate that the whole
249      * translation is complete if the state says so.
250      */</span>
<span class="mi">251</span>     <span class="kt">void</span>
<span class="mi">252</span>     <span class="nf">finish</span><span class="p">(</span><span class="k">const</span> <span class="n">Fault</span> <span class="o">&amp;</span><span class="n">fault</span><span class="p">,</span> <span class="k">const</span> <span class="n">RequestPtr</span> <span class="o">&amp;</span><span class="n">req</span><span class="p">,</span> <span class="n">ThreadContext</span> <span class="o">*</span><span class="n">tc</span><span class="p">,</span>
<span class="mi">253</span>            <span class="n">BaseTLB</span><span class="o">::</span><span class="n">Mode</span> <span class="n">mode</span><span class="p">)</span>
<span class="mi">254</span>     <span class="p">{</span>
<span class="mi">255</span>         <span class="n">assert</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
<span class="mi">256</span>         <span class="nf">assert</span><span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">);</span>
<span class="mi">257</span>         <span class="nf">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">finish</span><span class="p">(</span><span class="n">fault</span><span class="p">,</span> <span class="n">index</span><span class="p">))</span> <span class="p">{</span>
<span class="mi">258</span>             <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">getFault</span><span class="p">()</span> <span class="o">==</span> <span class="n">NoFault</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">259</span>                 <span class="c1">// Don't access the request if faulted (due to squash)</span>
<span class="mi">260</span>                 <span class="n">req</span><span class="o">-&gt;</span><span class="n">setTranslateLatency</span><span class="p">();</span>
<span class="mi">261</span>             <span class="p">}</span>
<span class="mi">262</span>             <span class="n">xc</span><span class="o">-&gt;</span><span class="n">finishTranslation</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
<span class="mi">263</span>         <span class="p">}</span>
<span class="mi">264</span>         <span class="k">delete</span> <span class="k">this</span><span class="p">;</span>
<span class="mi">265</span>     <span class="p">}</span>
<span class="mi">266</span>
<span class="mi">267</span>     <span class="kt">bool</span>
<span class="mi">268</span>     <span class="nf">squashed</span><span class="p">()</span> <span class="k">const</span>
<span class="mi">269</span>     <span class="p">{</span>
<span class="mi">270</span>         <span class="k">return</span> <span class="n">xc</span><span class="o">-&gt;</span><span class="n">isSquashed</span><span class="p">();</span>
<span class="mi">271</span>     <span class="p">}</span>
<span class="mi">272</span> <span class="p">};</span>
</pre></td></tr></tbody></table></code></div></div>

<p>We can find that finish function is implemented in the DataTranslation class.
The finish function defined in <em>DataTranslation</em> class
re-invokes another finish function 
through the state member field (line 257).
Also after invoking finish function,
it invokes finishTranslation method
of ThreadContext
when Fault has been raised as a consequence of TLB processing.</p>

<h3 id="wholetranslationstate-class-object-contains-translation-related-info"><span class="me-2">WholeTranslationState class object contains translation related info</span><a href="#wholetranslationstate-class-object-contains-translation-related-info" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>When we look at the initiateMemRead function again,
<em>WholeTranslationState</em> instance is passed 
to the DataTranslation constructor as a state parameter.</p>

<p>Therefore, state-&gt;finish of the DataTranslation invokes 
WholeTranslationState::finish method. 
Note that WholeTranslationState contains actual request
used for accessing page table entry from tlb.</p>

<p><em>gem5/src/cpu/translation.hh</em></p>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
</pre></td><td class="rouge-code"><pre> <span class="mi">51</span> <span class="cm">/**
 52  * This class captures the state of an address translation.  A translation
 53  * can be split in two if the ISA supports it and the memory access crosses
 54  * a page boundary.  In this case, this class is shared by two data
 55  * translations (below).  Otherwise it is used by a single data translation
 56  * class.  When each part of the translation is finished, the finish
 57  * function is called which will indicate whether the whole translation is
 58  * completed or not.  There are also functions for accessing parts of the
 59  * translation state which deal with the possible split correctly.
 60  */</span>
 <span class="mi">61</span> <span class="k">class</span> <span class="nc">WholeTranslationState</span>
 <span class="mi">62</span> <span class="p">{</span>
 <span class="mi">63</span>   <span class="k">protected</span><span class="o">:</span>
 <span class="mi">64</span>     <span class="kt">int</span> <span class="n">outstanding</span><span class="p">;</span>
 <span class="mi">65</span>     <span class="n">Fault</span> <span class="n">faults</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
 <span class="mi">66</span>
 <span class="mi">67</span>   <span class="k">public</span><span class="o">:</span>
 <span class="mi">68</span>     <span class="kt">bool</span> <span class="n">delay</span><span class="p">;</span>
 <span class="mi">69</span>     <span class="kt">bool</span> <span class="n">isSplit</span><span class="p">;</span>
 <span class="mi">70</span>     <span class="n">RequestPtr</span> <span class="n">mainReq</span><span class="p">;</span>
 <span class="mi">71</span>     <span class="n">RequestPtr</span> <span class="n">sreqLow</span><span class="p">;</span>
 <span class="mi">72</span>     <span class="n">RequestPtr</span> <span class="n">sreqHigh</span><span class="p">;</span>
 <span class="mi">73</span>     <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
 <span class="mi">74</span>     <span class="kt">uint64_t</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>
 <span class="mi">75</span>     <span class="n">BaseTLB</span><span class="o">::</span><span class="n">Mode</span> <span class="n">mode</span><span class="p">;</span>
 <span class="mi">76</span>
 <span class="mi">77</span>     <span class="cm">/**
 78      * Single translation state.  We set the number of outstanding
 79      * translations to one and indicate that it is not split.
 80      */</span>
 <span class="mi">81</span>     <span class="n">WholeTranslationState</span><span class="p">(</span><span class="k">const</span> <span class="n">RequestPtr</span> <span class="o">&amp;</span><span class="n">_req</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">_data</span><span class="p">,</span>
 <span class="mi">82</span>                           <span class="kt">uint64_t</span> <span class="o">*</span><span class="n">_res</span><span class="p">,</span> <span class="n">BaseTLB</span><span class="o">::</span><span class="n">Mode</span> <span class="n">_mode</span><span class="p">)</span>
 <span class="mi">83</span>         <span class="o">:</span> <span class="n">outstanding</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">delay</span><span class="p">(</span><span class="nb">false</span><span class="p">),</span> <span class="n">isSplit</span><span class="p">(</span><span class="nb">false</span><span class="p">),</span> <span class="n">mainReq</span><span class="p">(</span><span class="n">_req</span><span class="p">),</span>
 <span class="mi">84</span>           <span class="n">sreqLow</span><span class="p">(</span><span class="nb">NULL</span><span class="p">),</span> <span class="n">sreqHigh</span><span class="p">(</span><span class="nb">NULL</span><span class="p">),</span> <span class="n">data</span><span class="p">(</span><span class="n">_data</span><span class="p">),</span> <span class="n">res</span><span class="p">(</span><span class="n">_res</span><span class="p">),</span> <span class="n">mode</span><span class="p">(</span><span class="n">_mode</span><span class="p">)</span>
 <span class="mi">85</span>     <span class="p">{</span>
 <span class="mi">86</span>         <span class="n">faults</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">faults</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">NoFault</span><span class="p">;</span>
 <span class="mi">87</span>         <span class="n">assert</span><span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">BaseTLB</span><span class="o">::</span><span class="n">Read</span> <span class="o">||</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">BaseTLB</span><span class="o">::</span><span class="n">Write</span><span class="p">);</span>
 <span class="mi">88</span>     <span class="p">}</span>
 <span class="mi">89</span>
 <span class="mi">90</span>     <span class="cm">/**
 91      * Split translation state.  We copy all state into this class, set the
 92      * number of outstanding translations to two and then mark this as a
 93      * split translation.
 94      */</span>
 <span class="mi">95</span>     <span class="n">WholeTranslationState</span><span class="p">(</span><span class="k">const</span> <span class="n">RequestPtr</span> <span class="o">&amp;</span><span class="n">_req</span><span class="p">,</span> <span class="k">const</span> <span class="n">RequestPtr</span> <span class="o">&amp;</span><span class="n">_sreqLow</span><span class="p">,</span>
 <span class="mi">96</span>                           <span class="k">const</span> <span class="n">RequestPtr</span> <span class="o">&amp;</span><span class="n">_sreqHigh</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">_data</span><span class="p">,</span>
 <span class="mi">97</span>                           <span class="kt">uint64_t</span> <span class="o">*</span><span class="n">_res</span><span class="p">,</span> <span class="n">BaseTLB</span><span class="o">::</span><span class="n">Mode</span> <span class="n">_mode</span><span class="p">)</span>
 <span class="mi">98</span>         <span class="o">:</span> <span class="n">outstanding</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">delay</span><span class="p">(</span><span class="nb">false</span><span class="p">),</span> <span class="n">isSplit</span><span class="p">(</span><span class="nb">true</span><span class="p">),</span> <span class="n">mainReq</span><span class="p">(</span><span class="n">_req</span><span class="p">),</span>
 <span class="mi">99</span>           <span class="n">sreqLow</span><span class="p">(</span><span class="n">_sreqLow</span><span class="p">),</span> <span class="n">sreqHigh</span><span class="p">(</span><span class="n">_sreqHigh</span><span class="p">),</span> <span class="n">data</span><span class="p">(</span><span class="n">_data</span><span class="p">),</span> <span class="n">res</span><span class="p">(</span><span class="n">_res</span><span class="p">),</span>
<span class="mi">100</span>           <span class="n">mode</span><span class="p">(</span><span class="n">_mode</span><span class="p">)</span>
<span class="mi">101</span>     <span class="p">{</span>
<span class="mi">102</span>         <span class="n">faults</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">faults</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">NoFault</span><span class="p">;</span>
<span class="mi">103</span>         <span class="n">assert</span><span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">BaseTLB</span><span class="o">::</span><span class="n">Read</span> <span class="o">||</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">BaseTLB</span><span class="o">::</span><span class="n">Write</span><span class="p">);</span>
<span class="mi">104</span>     <span class="p">}</span>
<span class="mi">105</span>
<span class="mi">106</span>     <span class="cm">/**
107      * Finish part of a translation.  If there is only one request then this
108      * translation is completed.  If the request has been split in two then
109      * the outstanding count determines whether the translation is complete.
110      * In this case, flags from the split request are copied to the main
111      * request to make it easier to access them later on.
112      */</span>
<span class="mi">113</span>     <span class="kt">bool</span>
<span class="mi">114</span>     <span class="nf">finish</span><span class="p">(</span><span class="k">const</span> <span class="n">Fault</span> <span class="o">&amp;</span><span class="n">fault</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">)</span>
<span class="mi">115</span>     <span class="p">{</span>
<span class="mi">116</span>         <span class="n">assert</span><span class="p">(</span><span class="n">outstanding</span><span class="p">);</span>
<span class="mi">117</span>         <span class="n">faults</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">fault</span><span class="p">;</span>
<span class="mi">118</span>         <span class="n">outstanding</span><span class="o">--</span><span class="p">;</span>
<span class="mi">119</span>         <span class="nf">if</span> <span class="p">(</span><span class="n">isSplit</span> <span class="o">&amp;&amp;</span> <span class="n">outstanding</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">120</span>
<span class="mi">121</span>             <span class="c1">// For ease later, we copy some state to the main request.</span>
<span class="mi">122</span>             <span class="k">if</span> <span class="p">(</span><span class="n">faults</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">NoFault</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">123</span>                 <span class="n">mainReq</span><span class="o">-&gt;</span><span class="n">setPaddr</span><span class="p">(</span><span class="n">sreqLow</span><span class="o">-&gt;</span><span class="n">getPaddr</span><span class="p">());</span>
<span class="mi">124</span>             <span class="p">}</span>
<span class="mi">125</span>             <span class="n">mainReq</span><span class="o">-&gt;</span><span class="n">setFlags</span><span class="p">(</span><span class="n">sreqLow</span><span class="o">-&gt;</span><span class="n">getFlags</span><span class="p">());</span>
<span class="mi">126</span>             <span class="n">mainReq</span><span class="o">-&gt;</span><span class="n">setFlags</span><span class="p">(</span><span class="n">sreqHigh</span><span class="o">-&gt;</span><span class="n">getFlags</span><span class="p">());</span>
<span class="mi">127</span>         <span class="p">}</span>
<span class="mi">128</span>         <span class="k">return</span> <span class="n">outstanding</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span>
<span class="mi">129</span>     <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>the finish function of WholeTranslationState
stores generated fault on its internal buffer
when meaningful fault has been raised in translation process
(line 117).
After the fault has been stored by WholeTranslationState’s finish function,
remaining part of DataTranslation’s finish function invokes
<em>xc-&gt;finishTranslation(state)</em> function.
Note that finishTranslation function requires
WholeTranslationStation instance as state argument.</p>

<p>To understand details, 
we have to look at what is the xc variable.
Because DataTranslation class is declared as a template class, and 
xc is declared as template type,
it will be an instance of template type class.</p>

<h1 id="now-the-time-of-processor-not-the-tlb">Now the time of processor, not the TLB</h1>
<h2 id="datatranslation-as-an-interface-to-interact-with-cpu"><span class="me-2">DataTranslation as an interface to interact with CPU</span><a href="#datatranslation-as-an-interface-to-interact-with-cpu" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre> <span class="mi">466</span>         <span class="n">DataTranslation</span><span class="o">&lt;</span><span class="n">TimingSimpleCPU</span> <span class="o">*&gt;</span> <span class="o">*</span><span class="n">translation</span>
 <span class="mi">467</span>             <span class="o">=</span> <span class="k">new</span> <span class="n">DataTranslation</span><span class="o">&lt;</span><span class="n">TimingSimpleCPU</span> <span class="o">*&gt;</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></div></div>
<p>Because the translation variable 
has been declared with *DataTranslation<TimingSimpleCPU>* type,
xc variable is as an instance of *TimingSimpleCpu*.
Therefore, 
when the xc-&gt;finishTranslation(state) is called,
it will invoke TimingSimpleCPU::finishTranslation function.
Note that we are jumping into the CPU code
from the TLB module.</TimingSimpleCPU></p>

<h3 id="what-cpu-has-to-do-after-the-tlb-finish-its-job"><span class="me-2">What CPU has to do after the TLB finish its job</span><a href="#what-cpu-has-to-do-after-the-tlb-finish-its-job" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre></td><td class="rouge-code"><pre> <span class="mi">627</span> <span class="kt">void</span>
 <span class="mi">628</span> <span class="n">TimingSimpleCPU</span><span class="o">::</span><span class="n">finishTranslation</span><span class="p">(</span><span class="n">WholeTranslationState</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
 <span class="mi">629</span> <span class="p">{</span>
 <span class="mi">630</span>     <span class="n">_status</span> <span class="o">=</span> <span class="n">BaseSimpleCPU</span><span class="o">::</span><span class="n">Running</span><span class="p">;</span>
 <span class="mi">631</span>
 <span class="mi">632</span>     <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">getFault</span><span class="p">()</span> <span class="o">!=</span> <span class="n">NoFault</span><span class="p">)</span> <span class="p">{</span>
 <span class="mi">633</span>         <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">isPrefetch</span><span class="p">())</span> <span class="p">{</span>
 <span class="mi">634</span>             <span class="n">state</span><span class="o">-&gt;</span><span class="n">setNoFault</span><span class="p">();</span>
 <span class="mi">635</span>         <span class="p">}</span>
 <span class="mi">636</span>         <span class="k">delete</span> <span class="p">[]</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
 <span class="mi">637</span>         <span class="n">state</span><span class="o">-&gt;</span><span class="n">deleteReqs</span><span class="p">();</span>
 <span class="mi">638</span>         <span class="nf">translationFault</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">getFault</span><span class="p">());</span>
 <span class="mi">639</span>     <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
 <span class="mi">640</span>         <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">isSplit</span><span class="p">)</span> <span class="p">{</span>
 <span class="mi">641</span>             <span class="n">sendData</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">mainReq</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">,</span>
 <span class="mi">642</span>                      <span class="n">state</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">BaseTLB</span><span class="o">::</span><span class="n">Read</span><span class="p">);</span>
 <span class="mi">643</span>         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
 <span class="mi">644</span>             <span class="n">sendSplitData</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">sreqLow</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">sreqHigh</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">mainReq</span><span class="p">,</span>
 <span class="mi">645</span>                           <span class="n">state</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">BaseTLB</span><span class="o">::</span><span class="n">Read</span><span class="p">);</span>
 <span class="mi">646</span>         <span class="p">}</span>
 <span class="mi">647</span>     <span class="p">}</span>
 <span class="mi">648</span>
 <span class="mi">649</span>     <span class="k">delete</span> <span class="n">state</span><span class="p">;</span>
 <span class="mi">650</span> <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>
<p>When there exists translation fault,
it ends up ivnoking <em>translationFault</em> function of the CPU
with a previously stored fault(line 638).
Note that state-&gt;getFault method returns the fault
previously stored by WholeTranslationState’s finish.
When a translation has happended
because of prefetch instruction,
it suppress generated fault because it is not critical for execution.</p>

<p>However, 
when no fault has been encountered 
during the translation,
it invokes sendData function.
We will cover this later.</p>

<h2 id="let-cpu-handle-the-tlb-fault"><span class="me-2">Let CPU handle the TLB fault</span><a href="#let-cpu-handle-the-tlb-fault" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="rouge-code"><pre> <span class="mi">361</span> <span class="kt">void</span>
 <span class="mi">362</span> <span class="n">TimingSimpleCPU</span><span class="o">::</span><span class="n">translationFault</span><span class="p">(</span><span class="k">const</span> <span class="n">Fault</span> <span class="o">&amp;</span><span class="n">fault</span><span class="p">)</span>
 <span class="mi">363</span> <span class="p">{</span>
 <span class="mi">364</span>     <span class="c1">// fault may be NoFault in cases where a fault is suppressed,</span>
 <span class="mi">365</span>     <span class="c1">// for instance prefetches.</span>
 <span class="mi">366</span>     <span class="n">updateCycleCounts</span><span class="p">();</span>
 <span class="mi">367</span>     <span class="n">updateCycleCounters</span><span class="p">(</span><span class="n">BaseCPU</span><span class="o">::</span><span class="n">CPU_STATE_ON</span><span class="p">);</span>
 <span class="mi">368</span>
 <span class="mi">369</span>     <span class="k">if</span> <span class="p">(</span><span class="n">traceData</span><span class="p">)</span> <span class="p">{</span>
 <span class="mi">370</span>         <span class="c1">// Since there was a fault, we shouldn't trace this instruction.</span>
 <span class="mi">371</span>         <span class="k">delete</span> <span class="n">traceData</span><span class="p">;</span>
 <span class="mi">372</span>         <span class="n">traceData</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
 <span class="mi">373</span>     <span class="p">}</span>
 <span class="mi">374</span>
 <span class="mi">375</span>     <span class="nf">postExecute</span><span class="p">();</span>
 <span class="mi">376</span>
 <span class="mi">377</span>     <span class="nf">advanceInst</span><span class="p">(</span><span class="n">fault</span><span class="p">);</span>
 <span class="mi">378</span> <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>The <em>translationFault</em> function invokes postExecute and advanceInst function.
By looking at the function argument,
we can infer that <em>advanceInst</em> function 
actually deal with the fault.
The postExecute function doesn’t invoke any meaningful function to proceed pipeline, but
it updates stat of the processor such as 
power model, load instruction counter, etc.
Therefore, let’s jump into the <em>advanceInst</em> function.</p>

<h3 id="advanceinst-to-process-generated-translation-fault"><span class="me-2">advanceInst to process generated translation fault</span><a href="#advanceinst-to-process-generated-translation-fault" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p><em>gem5/src/cpu/simple/timing.cc</em></p>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
</pre></td><td class="rouge-code"><pre> <span class="mi">734</span> <span class="kt">void</span>
 <span class="mi">735</span> <span class="n">TimingSimpleCPU</span><span class="o">::</span><span class="n">advanceInst</span><span class="p">(</span><span class="k">const</span> <span class="n">Fault</span> <span class="o">&amp;</span><span class="n">fault</span><span class="p">)</span>
 <span class="mi">736</span> <span class="p">{</span>
 <span class="mi">737</span>     <span class="n">SimpleExecContext</span> <span class="o">&amp;</span><span class="n">t_info</span> <span class="o">=</span> <span class="o">*</span><span class="n">threadInfo</span><span class="p">[</span><span class="n">curThread</span><span class="p">];</span>
 <span class="mi">738</span>
 <span class="mi">739</span>     <span class="k">if</span> <span class="p">(</span><span class="n">_status</span> <span class="o">==</span> <span class="n">Faulting</span><span class="p">)</span>
 <span class="mi">740</span>         <span class="k">return</span><span class="p">;</span>
 <span class="mi">741</span>
 <span class="mi">742</span>     <span class="k">if</span> <span class="p">(</span><span class="n">fault</span> <span class="o">!=</span> <span class="n">NoFault</span><span class="p">)</span> <span class="p">{</span>
 <span class="mi">743</span>         <span class="n">DPRINTF</span><span class="p">(</span><span class="n">SimpleCPU</span><span class="p">,</span> <span class="s">"Fault occured. Handling the fault</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
 <span class="mi">744</span>
 <span class="mi">745</span>         <span class="n">advancePC</span><span class="p">(</span><span class="n">fault</span><span class="p">);</span>
 <span class="mi">746</span>
 <span class="mi">747</span>         <span class="c1">// A syscall fault could suspend this CPU (e.g., futex_wait)</span>
 <span class="mi">748</span>         <span class="c1">// If the _status is not Idle, schedule an event to fetch the next</span>
 <span class="mi">749</span>         <span class="c1">// instruction after 'stall' ticks.</span>
 <span class="mi">750</span>         <span class="c1">// If the cpu has been suspended (i.e., _status == Idle), another</span>
 <span class="mi">751</span>         <span class="c1">// cpu will wake this cpu up later.</span>
 <span class="mi">752</span>         <span class="k">if</span> <span class="p">(</span><span class="n">_status</span> <span class="o">!=</span> <span class="n">Idle</span><span class="p">)</span> <span class="p">{</span>
 <span class="mi">753</span>             <span class="n">DPRINTF</span><span class="p">(</span><span class="n">SimpleCPU</span><span class="p">,</span> <span class="s">"Scheduling fetch event after the Fault</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
 <span class="mi">754</span>
 <span class="mi">755</span>             <span class="n">Tick</span> <span class="n">stall</span> <span class="o">=</span> <span class="n">dynamic_pointer_cast</span><span class="o">&lt;</span><span class="n">SyscallRetryFault</span><span class="o">&gt;</span><span class="p">(</span><span class="n">fault</span><span class="p">)</span> <span class="o">?</span>
 <span class="mi">756</span>                          <span class="n">clockEdge</span><span class="p">(</span><span class="n">syscallRetryLatency</span><span class="p">)</span> <span class="o">:</span> <span class="n">clockEdge</span><span class="p">();</span>
 <span class="mi">757</span>             <span class="n">reschedule</span><span class="p">(</span><span class="n">fetchEvent</span><span class="p">,</span> <span class="n">stall</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
 <span class="mi">758</span>             <span class="n">_status</span> <span class="o">=</span> <span class="n">Faulting</span><span class="p">;</span>
 <span class="mi">759</span>         <span class="p">}</span>
 <span class="mi">760</span>
 <span class="mi">761</span>         <span class="k">return</span><span class="p">;</span>
 <span class="mi">762</span>     <span class="p">}</span>
 <span class="mi">763</span>
 <span class="mi">764</span>     <span class="nf">if</span> <span class="p">(</span><span class="o">!</span><span class="n">t_info</span><span class="p">.</span><span class="n">stayAtPC</span><span class="p">)</span>
 <span class="mi">765</span>         <span class="n">advancePC</span><span class="p">(</span><span class="n">fault</span><span class="p">);</span>
 <span class="mi">766</span>
 <span class="mi">767</span>     <span class="k">if</span> <span class="p">(</span><span class="n">tryCompleteDrain</span><span class="p">())</span>
 <span class="mi">768</span>         <span class="k">return</span><span class="p">;</span>
 <span class="mi">769</span>
 <span class="mi">770</span>     <span class="nf">if</span> <span class="p">(</span><span class="n">_status</span> <span class="o">==</span> <span class="n">BaseSimpleCPU</span><span class="o">::</span><span class="n">Running</span><span class="p">)</span> <span class="p">{</span>
 <span class="mi">771</span>         <span class="c1">// kick off fetch of next instruction... callback from icache</span>
 <span class="mi">772</span>         <span class="c1">// response will cause that instruction to be executed,</span>
 <span class="mi">773</span>         <span class="c1">// keeping the CPU running.</span>
 <span class="mi">774</span>         <span class="n">fetch</span><span class="p">();</span>
 <span class="mi">775</span>     <span class="p">}</span>
 <span class="mi">776</span> <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>When there is a pending translation fault,
it delegates fault exception to the <em>advancePC</em> function
which actually controls the PC register of the CPU.
TimingSimpleCPU inherits this function from BaseSimpleCPU,
we will look at the BaseSimpleCPU class.</p>

<p><em>gem5/src/cpu/simple/base.cc</em></p>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
</pre></td><td class="rouge-code"><pre><span class="mi">661</span> <span class="kt">void</span>
<span class="mi">662</span> <span class="n">BaseSimpleCPU</span><span class="o">::</span><span class="n">advancePC</span><span class="p">(</span><span class="k">const</span> <span class="n">Fault</span> <span class="o">&amp;</span><span class="n">fault</span><span class="p">)</span>
<span class="mi">663</span> <span class="p">{</span>
<span class="mi">664</span>     <span class="n">SimpleExecContext</span> <span class="o">&amp;</span><span class="n">t_info</span> <span class="o">=</span> <span class="o">*</span><span class="n">threadInfo</span><span class="p">[</span><span class="n">curThread</span><span class="p">];</span>
<span class="mi">665</span>     <span class="n">SimpleThread</span><span class="o">*</span> <span class="kr">thread</span> <span class="o">=</span> <span class="n">t_info</span><span class="p">.</span><span class="kr">thread</span><span class="p">;</span>
<span class="mi">666</span>
<span class="mi">667</span>     <span class="k">const</span> <span class="kt">bool</span> <span class="n">branching</span><span class="p">(</span><span class="kr">thread</span><span class="o">-&gt;</span><span class="n">pcState</span><span class="p">().</span><span class="n">branching</span><span class="p">());</span>
<span class="mi">668</span>
<span class="mi">669</span>     <span class="c1">//Since we're moving to a new pc, zero out the offset</span>
<span class="mi">670</span>     <span class="n">t_info</span><span class="p">.</span><span class="n">fetchOffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="mi">671</span>     <span class="k">if</span> <span class="p">(</span><span class="n">fault</span> <span class="o">!=</span> <span class="n">NoFault</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">672</span>         <span class="n">curMacroStaticInst</span> <span class="o">=</span> <span class="n">StaticInst</span><span class="o">::</span><span class="n">nullStaticInstPtr</span><span class="p">;</span>
<span class="mi">673</span>         <span class="n">fault</span><span class="o">-&gt;</span><span class="n">invoke</span><span class="p">(</span><span class="n">threadContexts</span><span class="p">[</span><span class="n">curThread</span><span class="p">],</span> <span class="n">curStaticInst</span><span class="p">);</span>
<span class="mi">674</span>         <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">decoder</span><span class="p">.</span><span class="n">reset</span><span class="p">();</span>
<span class="mi">675</span>     <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="mi">676</span>         <span class="k">if</span> <span class="p">(</span><span class="n">curStaticInst</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">677</span>             <span class="k">if</span> <span class="p">(</span><span class="n">curStaticInst</span><span class="o">-&gt;</span><span class="n">isLastMicroop</span><span class="p">())</span>
<span class="mi">678</span>                 <span class="n">curMacroStaticInst</span> <span class="o">=</span> <span class="n">StaticInst</span><span class="o">::</span><span class="n">nullStaticInstPtr</span><span class="p">;</span>
<span class="mi">679</span>             <span class="n">TheISA</span><span class="o">::</span><span class="n">PCState</span> <span class="n">pcState</span> <span class="o">=</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">pcState</span><span class="p">();</span>
<span class="mi">680</span>             <span class="n">TheISA</span><span class="o">::</span><span class="n">advancePC</span><span class="p">(</span><span class="n">pcState</span><span class="p">,</span> <span class="n">curStaticInst</span><span class="p">);</span>
<span class="mi">681</span>             <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">pcState</span><span class="p">(</span><span class="n">pcState</span><span class="p">);</span>
<span class="mi">682</span>         <span class="p">}</span>
<span class="mi">683</span>     <span class="p">}</span>
<span class="mi">684</span>
<span class="mi">685</span>     <span class="nf">if</span> <span class="p">(</span><span class="n">branchPred</span> <span class="o">&amp;&amp;</span> <span class="n">curStaticInst</span> <span class="o">&amp;&amp;</span> <span class="n">curStaticInst</span><span class="o">-&gt;</span><span class="n">isControl</span><span class="p">())</span> <span class="p">{</span>
<span class="mi">686</span>         <span class="c1">// Use a fake sequence number since we only have one</span>
<span class="mi">687</span>         <span class="c1">// instruction in flight at the same time.</span>
<span class="mi">688</span>         <span class="k">const</span> <span class="n">InstSeqNum</span> <span class="n">cur_sn</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="mi">689</span>
<span class="mi">690</span>         <span class="k">if</span> <span class="p">(</span><span class="n">t_info</span><span class="p">.</span><span class="n">predPC</span> <span class="o">==</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">pcState</span><span class="p">())</span> <span class="p">{</span>
<span class="mi">691</span>             <span class="c1">// Correctly predicted branch</span>
<span class="mi">692</span>             <span class="n">branchPred</span><span class="o">-&gt;</span><span class="n">update</span><span class="p">(</span><span class="n">cur_sn</span><span class="p">,</span> <span class="n">curThread</span><span class="p">);</span>
<span class="mi">693</span>         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="mi">694</span>             <span class="c1">// Mis-predicted branch</span>
<span class="mi">695</span>             <span class="n">branchPred</span><span class="o">-&gt;</span><span class="n">squash</span><span class="p">(</span><span class="n">cur_sn</span><span class="p">,</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">pcState</span><span class="p">(),</span> <span class="n">branching</span><span class="p">,</span> <span class="n">curThread</span><span class="p">);</span>
<span class="mi">696</span>             <span class="o">++</span><span class="n">t_info</span><span class="p">.</span><span class="n">numBranchMispred</span><span class="p">;</span>
<span class="mi">697</span>         <span class="p">}</span>
<span class="mi">698</span>     <span class="p">}</span>
<span class="mi">699</span> <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>In general, the advancePC function updates current CPU context.
However, depending on the current CPU state,
whether the fault has been raised or not,
it chooses different options
to handle the generated fault and redirect the PC to move on.
The <em>invoke</em> function called through the fault object handles 
the generated fault 
usually with the help of pre-defined ROM code.
Also, it resets decoder and make curMacroStaticInst as Null.
This is because we have to move on to the new PC 
after handling fault.</p>

<p>On the other hand, 
as usually taken path,
when the fault has not been raised 
during the current instruction execution,
it updates micropc of the processor to the next instruction 
(line 676-682).</p>

<h3 id="pre-defined-rom-code-handles-generated-fault"><span class="me-2">pre-defined ROM code handles generated fault!</span><a href="#pre-defined-rom-code-handles-generated-fault" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>Then let’s take a look at
how the fault can be handled by the invoke function
implemented in the fault class.</p>

<p><em>gem5/srch/arch/x86/faults.cc</em></p>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
</pre></td><td class="rouge-code"><pre> <span class="mi">53</span> <span class="k">namespace</span> <span class="n">X86ISA</span>
 <span class="mi">54</span> <span class="p">{</span>
 <span class="mi">55</span>     <span class="kt">void</span> <span class="n">X86FaultBase</span><span class="o">::</span><span class="n">invoke</span><span class="p">(</span><span class="n">ThreadContext</span> <span class="o">*</span> <span class="n">tc</span><span class="p">,</span> <span class="k">const</span> <span class="n">StaticInstPtr</span> <span class="o">&amp;</span><span class="n">inst</span><span class="p">)</span>
 <span class="mi">56</span>     <span class="p">{</span>
 <span class="mi">57</span>         <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">FullSystem</span><span class="p">)</span> <span class="p">{</span>
 <span class="mi">58</span>             <span class="n">FaultBase</span><span class="o">::</span><span class="n">invoke</span><span class="p">(</span><span class="n">tc</span><span class="p">,</span> <span class="n">inst</span><span class="p">);</span>
 <span class="mi">59</span>             <span class="k">return</span><span class="p">;</span>
 <span class="mi">60</span>         <span class="p">}</span>
 <span class="mi">61</span>
 <span class="mi">62</span>         <span class="n">PCState</span> <span class="n">pcState</span> <span class="o">=</span> <span class="n">tc</span><span class="o">-&gt;</span><span class="n">pcState</span><span class="p">();</span>
 <span class="mi">63</span>         <span class="n">Addr</span> <span class="n">pc</span> <span class="o">=</span> <span class="n">pcState</span><span class="p">.</span><span class="n">pc</span><span class="p">();</span>
 <span class="mi">64</span>         <span class="nf">DPRINTF</span><span class="p">(</span><span class="n">Faults</span><span class="p">,</span> <span class="s">"RIP %#x: vector %d: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
 <span class="mi">65</span>                 <span class="n">pc</span><span class="p">,</span> <span class="n">vector</span><span class="p">,</span> <span class="n">describe</span><span class="p">());</span>
 <span class="mi">66</span>         <span class="k">using</span> <span class="k">namespace</span> <span class="n">X86ISAInst</span><span class="o">::</span><span class="n">RomLabels</span><span class="p">;</span>
 <span class="mi">67</span>         <span class="n">HandyM5Reg</span> <span class="n">m5reg</span> <span class="o">=</span> <span class="n">tc</span><span class="o">-&gt;</span><span class="n">readMiscRegNoEffect</span><span class="p">(</span><span class="n">MISCREG_M5_REG</span><span class="p">);</span>
 <span class="mi">68</span>         <span class="n">MicroPC</span> <span class="n">entry</span><span class="p">;</span>
 <span class="mi">69</span>         <span class="nf">if</span> <span class="p">(</span><span class="n">m5reg</span><span class="p">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">LongMode</span><span class="p">)</span> <span class="p">{</span>
 <span class="mi">70</span>             <span class="k">if</span> <span class="p">(</span><span class="n">isSoft</span><span class="p">())</span> <span class="p">{</span>
 <span class="mi">71</span>                 <span class="n">entry</span> <span class="o">=</span> <span class="n">extern_label_longModeSoftInterrupt</span><span class="p">;</span>
 <span class="mi">72</span>             <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
 <span class="mi">73</span>                 <span class="n">entry</span> <span class="o">=</span> <span class="n">extern_label_longModeInterrupt</span><span class="p">;</span>
 <span class="mi">74</span>             <span class="p">}</span>
 <span class="mi">75</span>         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
 <span class="mi">76</span>             <span class="n">entry</span> <span class="o">=</span> <span class="n">extern_label_legacyModeInterrupt</span><span class="p">;</span>
 <span class="mi">77</span>         <span class="p">}</span>
 <span class="mi">78</span>         <span class="n">tc</span><span class="o">-&gt;</span><span class="n">setIntReg</span><span class="p">(</span><span class="n">INTREG_MICRO</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">vector</span><span class="p">);</span>
 <span class="mi">79</span>         <span class="n">tc</span><span class="o">-&gt;</span><span class="n">setIntReg</span><span class="p">(</span><span class="n">INTREG_MICRO</span><span class="p">(</span><span class="mi">7</span><span class="p">),</span> <span class="n">pc</span><span class="p">);</span>
 <span class="mi">80</span>         <span class="nf">if</span> <span class="p">(</span><span class="n">errorCode</span> <span class="o">!=</span> <span class="p">(</span><span class="kt">uint64_t</span><span class="p">)(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
 <span class="mi">81</span>             <span class="k">if</span> <span class="p">(</span><span class="n">m5reg</span><span class="p">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">LongMode</span><span class="p">)</span> <span class="p">{</span>
 <span class="mi">82</span>                 <span class="n">entry</span> <span class="o">=</span> <span class="n">extern_label_longModeInterruptWithError</span><span class="p">;</span>
 <span class="mi">83</span>             <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
 <span class="mi">84</span>                 <span class="n">panic</span><span class="p">(</span><span class="s">"Legacy mode interrupts with error codes "</span>
 <span class="mi">85</span>                         <span class="s">"aren't implementde.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
 <span class="mi">86</span>             <span class="p">}</span>
 <span class="mi">87</span>             <span class="c1">// Software interrupts shouldn't have error codes. If one</span>
 <span class="mi">88</span>             <span class="c1">// does, there would need to be microcode to set it up.</span>
 <span class="mi">89</span>             <span class="nf">assert</span><span class="p">(</span><span class="o">!</span><span class="n">isSoft</span><span class="p">());</span>
 <span class="mi">90</span>             <span class="n">tc</span><span class="o">-&gt;</span><span class="n">setIntReg</span><span class="p">(</span><span class="n">INTREG_MICRO</span><span class="p">(</span><span class="mi">15</span><span class="p">),</span> <span class="n">errorCode</span><span class="p">);</span>
 <span class="mi">91</span>         <span class="p">}</span>
 <span class="mi">92</span>         <span class="n">pcState</span><span class="p">.</span><span class="n">upc</span><span class="p">(</span><span class="n">romMicroPC</span><span class="p">(</span><span class="n">entry</span><span class="p">));</span>
 <span class="mi">93</span>         <span class="n">pcState</span><span class="p">.</span><span class="n">nupc</span><span class="p">(</span><span class="n">romMicroPC</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
 <span class="mi">94</span>         <span class="n">tc</span><span class="o">-&gt;</span><span class="n">pcState</span><span class="p">(</span><span class="n">pcState</span><span class="p">);</span>
 <span class="mi">95</span>     <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>
<p>To look at the behavior of the invoke function of the fault,
we have to look at the fault related classes first.
GEM5 provides base interface for every faults 
defined in the x86 architecture.
x86 provides different types of events 
that can intervene the execution flow,
which are fault, abort, trap, interrupts. 
All those events inherit from the base x86 fault class <em>X86FaultBase</em>
which provides general interfaces and semantics of the x86 fault events.</p>

<p>However, depending on type of events,
different classes inheriting the X86FaultBase 
can override invoke function
to define their own semantics of fault events. 
For example, 
PageFault class inherits <em>X86FaultBase</em> class 
and overrides <em>invoke</em> function to add 
its own pagefault related semantics 
before invoking the parent’s invoke function 
provided by the X86FaultBase class.</p>

<h3 id="invoke-change-current-rip-to-pre-defined-microops"><span class="me-2">Invoke change current RIP to pre-defined microops</span><a href="#invoke-change-current-rip-to-pre-defined-microops" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>Basically, 
invoke function makes the processor 
jump to the pre-defined microcode function
that implements actual semantics of x86 fault handling.
When the fault or interrupt is reported to the processor,
first of all,
it should stores current context of the processor.
And then,
it transfers a control flow of the processor 
to the designated fault handler 
represented by the IDTR register in x86.</p>

<p>To jump to the pre-defined ROM code
from the invoke function,
it makes use of ROM labels 
that statically stores sequence of x86 microops.
All the available ROM labels are defined 
in the RomLabels namespace 
as show in the below.</p>

<p><em>gem5/build/X86/arch/x86/generated/decoder-ns.hh.inc</em></p>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre></td><td class="rouge-code"><pre> <span class="mi">4587</span> <span class="k">namespace</span> <span class="n">RomLabels</span> <span class="p">{</span>
 <span class="mi">4588</span> <span class="k">const</span> <span class="k">static</span> <span class="kt">uint64_t</span> <span class="n">label_longModeSoftInterrupt_stackSwitched</span> <span class="o">=</span> <span class="mi">92</span><span class="p">;</span>
 <span class="mi">4589</span> <span class="k">const</span> <span class="k">static</span> <span class="kt">uint64_t</span> <span class="n">label_longModeInterrupt_processDescriptor</span> <span class="o">=</span> <span class="mi">11</span><span class="p">;</span>
 <span class="mi">4590</span> <span class="k">const</span> <span class="k">static</span> <span class="kt">uint64_t</span> <span class="n">label_longModeInterruptWithError_cplStackSwitch</span> <span class="o">=</span> <span class="mi">152</span><span class="p">;</span>
 <span class="mi">4591</span> <span class="k">const</span> <span class="k">static</span> <span class="kt">uint64_t</span> <span class="n">label_longModeInterrupt_istStackSwitch</span> <span class="o">=</span> <span class="mi">28</span><span class="p">;</span>
 <span class="mi">4592</span> <span class="k">const</span> <span class="k">static</span> <span class="kt">uint64_t</span> <span class="n">label_jmpFarWork</span> <span class="o">=</span> <span class="mi">192</span><span class="p">;</span>
 <span class="mi">4593</span> <span class="k">const</span> <span class="k">static</span> <span class="kt">uint64_t</span> <span class="n">label_farJmpSystemDescriptor</span> <span class="o">=</span> <span class="mi">207</span><span class="p">;</span>
 <span class="mi">4594</span> <span class="k">const</span> <span class="k">static</span> <span class="kt">uint64_t</span> <span class="n">label_longModeSoftInterrupt_globalDescriptor</span> <span class="o">=</span> <span class="mi">71</span><span class="p">;</span>
 <span class="mi">4595</span> <span class="k">const</span> <span class="k">static</span> <span class="kt">uint64_t</span> <span class="n">label_farJmpGlobalDescriptor</span> <span class="o">=</span> <span class="mi">199</span><span class="p">;</span>
 <span class="mi">4596</span> <span class="k">const</span> <span class="k">static</span> <span class="kt">uint64_t</span> <span class="n">label_initIntHalt</span> <span class="o">=</span> <span class="mi">186</span><span class="p">;</span>
 <span class="mi">4597</span> <span class="k">const</span> <span class="k">static</span> <span class="kt">uint64_t</span> <span class="n">label_longModeInterruptWithError_istStackSwitch</span> <span class="o">=</span> <span class="mi">150</span><span class="p">;</span>
 <span class="mi">4598</span> <span class="k">const</span> <span class="k">static</span> <span class="kt">uint64_t</span> <span class="n">label_legacyModeInterrupt</span> <span class="o">=</span> <span class="mi">184</span><span class="p">;</span>
 <span class="mi">4599</span> <span class="k">const</span> <span class="k">static</span> <span class="kt">uint64_t</span> <span class="n">label_longModeInterruptWithError_globalDescriptor</span> <span class="o">=</span> <span class="mi">132</span><span class="p">;</span>
 <span class="mi">4600</span> <span class="k">const</span> <span class="k">static</span> <span class="kt">uint64_t</span> <span class="n">label_longModeSoftInterrupt_processDescriptor</span> <span class="o">=</span> <span class="mi">72</span><span class="p">;</span>
 <span class="mi">4601</span> <span class="k">const</span> <span class="k">static</span> <span class="kt">uint64_t</span> <span class="n">label_longModeInterruptWithError</span> <span class="o">=</span> <span class="mi">122</span><span class="p">;</span>
 <span class="mi">4602</span> <span class="k">const</span> <span class="k">static</span> <span class="kt">uint64_t</span> <span class="n">label_farJmpProcessDescriptor</span> <span class="o">=</span> <span class="mi">200</span><span class="p">;</span>
 <span class="mi">4603</span> <span class="k">const</span> <span class="k">static</span> <span class="kt">uint64_t</span> <span class="n">label_longModeSoftInterrupt</span> <span class="o">=</span> <span class="mi">61</span><span class="p">;</span>
 <span class="mi">4604</span> <span class="k">const</span> <span class="k">static</span> <span class="kt">uint64_t</span> <span class="n">label_longModeSoftInterrupt_istStackSwitch</span> <span class="o">=</span> <span class="mi">89</span><span class="p">;</span>
 <span class="mi">4605</span> <span class="k">const</span> <span class="k">static</span> <span class="kt">uint64_t</span> <span class="n">label_longModeInterrupt_globalDescriptor</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
 <span class="mi">4606</span> <span class="k">const</span> <span class="k">static</span> <span class="kt">uint64_t</span> <span class="n">label_longModeInterrupt_cplStackSwitch</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span>
 <span class="mi">4607</span> <span class="k">const</span> <span class="k">static</span> <span class="kt">uint64_t</span> <span class="n">label_longModeInterrupt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
 <span class="mi">4608</span> <span class="k">const</span> <span class="k">static</span> <span class="kt">uint64_t</span> <span class="n">label_longModeInterruptWithError_processDescriptor</span> <span class="o">=</span> <span class="mi">133</span><span class="p">;</span>
 <span class="mi">4609</span> <span class="k">const</span> <span class="k">static</span> <span class="kt">uint64_t</span> <span class="n">label_longModeInterruptWithError_stackSwitched</span> <span class="o">=</span> <span class="mi">153</span><span class="p">;</span>
 <span class="mi">4610</span> <span class="k">const</span> <span class="k">static</span> <span class="kt">uint64_t</span> <span class="n">label_longModeInterrupt_stackSwitched</span> <span class="o">=</span> <span class="mi">31</span><span class="p">;</span>
 <span class="mi">4611</span> <span class="k">const</span> <span class="k">static</span> <span class="kt">uint64_t</span> <span class="n">label_longModeSoftInterrupt_cplStackSwitch</span> <span class="o">=</span> <span class="mi">91</span><span class="p">;</span>
 <span class="mi">4612</span> <span class="k">const</span> <span class="k">static</span> <span class="n">MicroPC</span> <span class="n">extern_label_initIntHalt</span> <span class="o">=</span> <span class="mi">186</span><span class="p">;</span>
 <span class="mi">4613</span> <span class="k">const</span> <span class="k">static</span> <span class="n">MicroPC</span> <span class="n">extern_label_longModeInterruptWithError</span> <span class="o">=</span> <span class="mi">122</span><span class="p">;</span>
 <span class="mi">4614</span> <span class="k">const</span> <span class="k">static</span> <span class="n">MicroPC</span> <span class="n">extern_label_longModeInterrupt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
 <span class="mi">4615</span> <span class="k">const</span> <span class="k">static</span> <span class="n">MicroPC</span> <span class="n">extern_label_longModeSoftInterrupt</span> <span class="o">=</span> <span class="mi">61</span><span class="p">;</span>
 <span class="mi">4616</span> <span class="k">const</span> <span class="k">static</span> <span class="n">MicroPC</span> <span class="n">extern_label_legacyModeInterrupt</span> <span class="o">=</span> <span class="mi">184</span><span class="p">;</span>
 <span class="mi">4617</span> <span class="k">const</span> <span class="k">static</span> <span class="n">MicroPC</span> <span class="n">extern_label_jmpFarWork</span> <span class="o">=</span> <span class="mi">192</span><span class="p">;</span>
 <span class="mi">4618</span> <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="pagefault-handling-rom-code"><span class="me-2">PageFault handling ROM code</span><a href="#pagefault-handling-rom-code" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>Although we are looking at translation fault,
note that is can be described as PageFault in x86.</p>

<p><strong>gem5/src/arch/x86/faults.cc</strong></p>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
</pre></td><td class="rouge-code"><pre><span class="mi">137</span>     <span class="kt">void</span> <span class="n">PageFault</span><span class="o">::</span><span class="n">invoke</span><span class="p">(</span><span class="n">ThreadContext</span> <span class="o">*</span> <span class="n">tc</span><span class="p">,</span> <span class="k">const</span> <span class="n">StaticInstPtr</span> <span class="o">&amp;</span><span class="n">inst</span><span class="p">)</span>
<span class="mi">138</span>     <span class="p">{</span>
<span class="mi">139</span>         <span class="k">if</span> <span class="p">(</span><span class="n">FullSystem</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">140</span>             <span class="cm">/* Invalidate any matching TLB entries before handling the page fault */</span>
<span class="mi">141</span>             <span class="n">tc</span><span class="o">-&gt;</span><span class="n">getITBPtr</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">demapPage</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="mi">142</span>             <span class="n">tc</span><span class="o">-&gt;</span><span class="n">getDTBPtr</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">demapPage</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="mi">143</span>             <span class="n">HandyM5Reg</span> <span class="n">m5reg</span> <span class="o">=</span> <span class="n">tc</span><span class="o">-&gt;</span><span class="n">readMiscRegNoEffect</span><span class="p">(</span><span class="n">MISCREG_M5_REG</span><span class="p">);</span>
<span class="mi">144</span>             <span class="n">X86FaultBase</span><span class="o">::</span><span class="n">invoke</span><span class="p">(</span><span class="n">tc</span><span class="p">);</span>
<span class="mi">145</span>             <span class="cm">/*
146              * If something bad happens while trying to enter the page fault
147              * handler, I'm pretty sure that's a double fault and then all
148              * bets are off. That means it should be safe to update this
149              * state now.
150              */</span>
<span class="mi">151</span>             <span class="k">if</span> <span class="p">(</span><span class="n">m5reg</span><span class="p">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">LongMode</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">152</span>                 <span class="n">tc</span><span class="o">-&gt;</span><span class="n">setMiscReg</span><span class="p">(</span><span class="n">MISCREG_CR2</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
<span class="mi">153</span>             <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="mi">154</span>                 <span class="n">tc</span><span class="o">-&gt;</span><span class="n">setMiscReg</span><span class="p">(</span><span class="n">MISCREG_CR2</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">addr</span><span class="p">);</span>
<span class="mi">155</span>             <span class="p">}</span>
<span class="mi">156</span>         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="mi">157</span>             <span class="n">PageFaultErrorCode</span> <span class="n">code</span> <span class="o">=</span> <span class="n">errorCode</span><span class="p">;</span>
<span class="mi">158</span>             <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">modeStr</span> <span class="o">=</span> <span class="s">""</span><span class="p">;</span>
<span class="mi">159</span>             <span class="k">if</span> <span class="p">(</span><span class="n">code</span><span class="p">.</span><span class="n">fetch</span><span class="p">)</span>
<span class="mi">160</span>                 <span class="n">modeStr</span> <span class="o">=</span> <span class="s">"execute"</span><span class="p">;</span>
<span class="mi">161</span>             <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">code</span><span class="p">.</span><span class="n">write</span><span class="p">)</span>
<span class="mi">162</span>                 <span class="n">modeStr</span> <span class="o">=</span> <span class="s">"write"</span><span class="p">;</span>
<span class="mi">163</span>             <span class="k">else</span>
<span class="mi">164</span>                 <span class="n">modeStr</span> <span class="o">=</span> <span class="s">"read"</span><span class="p">;</span>
<span class="mi">165</span>
<span class="mi">166</span>             <span class="c1">// print information about what we are panic'ing on</span>
<span class="mi">167</span>             <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">inst</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">168</span>                 <span class="n">panic</span><span class="p">(</span><span class="s">"Tried to %s unmapped address %#x.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">modeStr</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
<span class="mi">169</span>             <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="mi">170</span>                 <span class="n">panic</span><span class="p">(</span><span class="s">"Tried to %s unmapped address %#x.</span><span class="se">\n</span><span class="s">PC: %#x, Instr: %s"</span><span class="p">,</span>
<span class="mi">171</span>                       <span class="n">modeStr</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">tc</span><span class="o">-&gt;</span><span class="n">pcState</span><span class="p">().</span><span class="n">pc</span><span class="p">(),</span>
<span class="mi">172</span>                       <span class="n">inst</span><span class="o">-&gt;</span><span class="n">disassemble</span><span class="p">(</span><span class="n">tc</span><span class="o">-&gt;</span><span class="n">pcState</span><span class="p">().</span><span class="n">pc</span><span class="p">(),</span> <span class="n">debugSymbolTable</span><span class="p">));</span>
<span class="mi">173</span>             <span class="p">}</span>
<span class="mi">174</span>         <span class="p">}</span>
<span class="mi">175</span>     <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Because most of the fault handling logic 
of the PageFault class 
overlaps with X86FaultBase,
after handling TLB related issues,
it just calls invoke function of X86FaultBase class.
Because translation fault mainly happens in longmode,
and generated fault is not software interrupt,
we will take a look at the ROM label named <em>label_longModeInterrupt</em>.</p>

<h3 id="pass-arguments-to-the-rom-code"><span class="me-2">Pass arguments to the ROM code</span><a href="#pass-arguments-to-the-rom-code" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>Also, before jumping to the ROM label,
it sets micro architectural registers 
to pass <em>interrupt number</em> and <em>PC address</em> to the ROM code.
Additionaly, 
when the interrupt makes use of error code,
it should also be passed to the microcode</p>

<p>To pass the arguments to the microcode world, 
it invokes setIntReg functions defined in the threadcontext. 
<em>Threadcontext</em> is instance of SimpleThread class 
defined in cpu/simple_thread.hh
(When you use the o3 out-of-order cpu model, 
you have to look at O3ThreadContext class).
Regardless of your processor model,
both classes inherit ThreadContext class 
which provide generic register context and 
interface for manipulating the registers.</p>

<p><em>gem5/src/cpu/simple_thread.hh</em></p>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre></td><td class="rouge-code"><pre> <span class="mi">98</span> <span class="k">class</span> <span class="nc">SimpleThread</span> <span class="o">:</span> <span class="k">public</span> <span class="n">ThreadState</span><span class="p">,</span> <span class="k">public</span> <span class="n">ThreadContext</span>
 <span class="mi">99</span> <span class="p">{</span>
<span class="mi">100</span>   <span class="k">protected</span><span class="o">:</span>
<span class="mi">101</span>     <span class="k">typedef</span> <span class="n">TheISA</span><span class="o">::</span><span class="n">MachInst</span> <span class="n">MachInst</span><span class="p">;</span>
<span class="mi">102</span>     <span class="k">using</span> <span class="n">VecRegContainer</span> <span class="o">=</span> <span class="n">TheISA</span><span class="o">::</span><span class="n">VecRegContainer</span><span class="p">;</span>
<span class="mi">103</span>     <span class="k">using</span> <span class="n">VecElem</span> <span class="o">=</span> <span class="n">TheISA</span><span class="o">::</span><span class="n">VecElem</span><span class="p">;</span>
<span class="mi">104</span>     <span class="k">using</span> <span class="n">VecPredRegContainer</span> <span class="o">=</span> <span class="n">TheISA</span><span class="o">::</span><span class="n">VecPredRegContainer</span><span class="p">;</span>
<span class="mi">105</span>   <span class="k">public</span><span class="o">:</span>
<span class="mi">106</span>     <span class="k">typedef</span> <span class="n">ThreadContext</span><span class="o">::</span><span class="n">Status</span> <span class="n">Status</span><span class="p">;</span>
<span class="mi">107</span>
<span class="mi">108</span>   <span class="k">protected</span><span class="o">:</span>
<span class="mi">109</span>     <span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="n">RegVal</span><span class="p">,</span> <span class="n">TheISA</span><span class="o">::</span><span class="n">NumFloatRegs</span><span class="o">&gt;</span> <span class="n">floatRegs</span><span class="p">;</span>
<span class="mi">110</span>     <span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="n">RegVal</span><span class="p">,</span> <span class="n">TheISA</span><span class="o">::</span><span class="n">NumIntRegs</span><span class="o">&gt;</span> <span class="n">intRegs</span><span class="p">;</span>
<span class="mi">111</span>     <span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="n">VecRegContainer</span><span class="p">,</span> <span class="n">TheISA</span><span class="o">::</span><span class="n">NumVecRegs</span><span class="o">&gt;</span> <span class="n">vecRegs</span><span class="p">;</span>
<span class="mi">112</span>     <span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="n">VecPredRegContainer</span><span class="p">,</span> <span class="n">TheISA</span><span class="o">::</span><span class="n">NumVecPredRegs</span><span class="o">&gt;</span> <span class="n">vecPredRegs</span><span class="p">;</span>
<span class="mi">113</span>     <span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="n">RegVal</span><span class="p">,</span> <span class="n">TheISA</span><span class="o">::</span><span class="n">NumCCRegs</span><span class="o">&gt;</span> <span class="n">ccRegs</span><span class="p">;</span>
<span class="mi">114</span>     <span class="n">TheISA</span><span class="o">::</span><span class="n">ISA</span> <span class="o">*</span><span class="k">const</span> <span class="n">isa</span><span class="p">;</span>    <span class="c1">// one "instance" of the current ISA.</span>
<span class="mi">115</span>
<span class="mi">116</span>     <span class="n">TheISA</span><span class="o">::</span><span class="n">PCState</span> <span class="n">_pcState</span><span class="p">;</span>

<span class="mi">477</span>     <span class="kt">void</span>
<span class="mi">478</span>     <span class="n">setIntReg</span><span class="p">(</span><span class="n">RegIndex</span> <span class="n">reg_idx</span><span class="p">,</span> <span class="n">RegVal</span> <span class="n">val</span><span class="p">)</span> <span class="k">override</span>
<span class="mi">479</span>     <span class="p">{</span>
<span class="mi">480</span>         <span class="kt">int</span> <span class="n">flatIndex</span> <span class="o">=</span> <span class="n">isa</span><span class="o">-&gt;</span><span class="n">flattenIntIndex</span><span class="p">(</span><span class="n">reg_idx</span><span class="p">);</span>
<span class="mi">481</span>         <span class="n">assert</span><span class="p">(</span><span class="n">flatIndex</span> <span class="o">&lt;</span> <span class="n">TheISA</span><span class="o">::</span><span class="n">NumIntRegs</span><span class="p">);</span>
<span class="mi">482</span>         <span class="n">DPRINTF</span><span class="p">(</span><span class="n">IntRegs</span><span class="p">,</span> <span class="s">"Setting int reg %d (%d) to %#x.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
<span class="mi">483</span>                 <span class="n">reg_idx</span><span class="p">,</span> <span class="n">flatIndex</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="mi">484</span>         <span class="n">setIntRegFlat</span><span class="p">(</span><span class="n">flatIndex</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="mi">485</span>     <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="detour-to-theisa-namespace"><span class="me-2">Detour to TheISA namespace</span><a href="#detour-to-theisa-namespace" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>Although <em>SimpleThread</em> class can be seen as 
providing generic registers regardless of architectures, 
it declares ISA dependent registers. 
The magic is <em>TheISA</em> symbol. 
<em>TheISA</em> symbol will be translated to 
architecture specific namespace 
depending on the architecture
that the Gem5 has been compiled to.
Let’s little bit detour and figure out how <em>TheISA</em> namespace works.</p>

<p>When you don’t know what is the <em>TheISA</em> namesapce,
you may want to grep “namespace TheISA”
to find out files that define TheISA namespace.
However, unfortunately,
you can only find very few places
where the <em>TheISA</em> namespace has been declared
with a handful of member functions.
Then where those functions and variables of the TheISA namespace come from?
To understand the TheISA:: namespace,
we should look at the build files not the source file.</p>

<p><em>build/X86/config/the_isa.hh</em></p>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre></td><td class="rouge-code"><pre>  <span class="mi">1</span> <span class="err">#</span><span class="n">ifndef</span> <span class="n">__CONFIG_THE_ISA_HH__</span>
  <span class="mi">2</span> <span class="err">#</span><span class="n">define</span> <span class="n">__CONFIG_THE_ISA_HH__</span>
  <span class="mi">3</span>
  <span class="mi">4</span> <span class="err">#</span><span class="n">define</span> <span class="n">ALPHA_ISA</span> <span class="mi">1</span>
  <span class="mi">5</span> <span class="err">#</span><span class="n">define</span> <span class="n">ARM_ISA</span> <span class="mi">2</span>
  <span class="mi">6</span> <span class="err">#</span><span class="n">define</span> <span class="n">MIPS_ISA</span> <span class="mi">3</span>
  <span class="mi">7</span> <span class="err">#</span><span class="n">define</span> <span class="n">NULL_ISA</span> <span class="mi">4</span>
  <span class="mi">8</span> <span class="err">#</span><span class="n">define</span> <span class="n">POWER_ISA</span> <span class="mi">5</span>
  <span class="mi">9</span> <span class="err">#</span><span class="n">define</span> <span class="n">RISCV_ISA</span> <span class="mi">6</span>
 <span class="mi">10</span> <span class="err">#</span><span class="n">define</span> <span class="n">SPARC_ISA</span> <span class="mi">7</span>
 <span class="mi">11</span> <span class="err">#</span><span class="n">define</span> <span class="n">X86_ISA</span> <span class="mi">8</span>
 <span class="mi">12</span>
 <span class="mi">13</span> <span class="k">enum</span> <span class="k">class</span> <span class="nc">Arch</span> <span class="p">{</span>
 <span class="mi">14</span>   <span class="n">AlphaISA</span> <span class="o">=</span> <span class="n">ALPHA_ISA</span><span class="p">,</span>
 <span class="mi">15</span>   <span class="n">ArmISA</span> <span class="o">=</span> <span class="n">ARM_ISA</span><span class="p">,</span>
 <span class="mi">16</span>   <span class="n">MipsISA</span> <span class="o">=</span> <span class="n">MIPS_ISA</span><span class="p">,</span>
 <span class="mi">17</span>   <span class="n">NullISA</span> <span class="o">=</span> <span class="n">NULL_ISA</span><span class="p">,</span>
 <span class="mi">18</span>   <span class="n">PowerISA</span> <span class="o">=</span> <span class="n">POWER_ISA</span><span class="p">,</span>
 <span class="mi">19</span>   <span class="n">RiscvISA</span> <span class="o">=</span> <span class="n">RISCV_ISA</span><span class="p">,</span>
 <span class="mi">20</span>   <span class="n">SparcISA</span> <span class="o">=</span> <span class="n">SPARC_ISA</span><span class="p">,</span>
 <span class="mi">21</span>   <span class="n">X86ISA</span> <span class="o">=</span> <span class="n">X86_ISA</span>
 <span class="mi">22</span> <span class="p">};</span>
 <span class="mi">23</span>
 <span class="mi">24</span> <span class="err">#</span><span class="n">define</span> <span class="n">THE_ISA</span> <span class="n">X86_ISA</span>
 <span class="mi">25</span> <span class="err">#</span><span class="n">define</span> <span class="n">TheISA</span> <span class="n">X86ISA</span>
 <span class="mi">26</span> <span class="err">#</span><span class="n">define</span> <span class="n">THE_ISA_STR</span> <span class="s">"x86"</span>
 <span class="mi">27</span>
 <span class="mi">28</span> <span class="err">#</span><span class="n">endif</span> <span class="c1">// __CONFIG_THE_ISA_HH__</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Here, we can easily find that 
TheISA is defined as X86ISA.
Also when we look at the SConScript file,
we can find python function names <em>makeTheISA</em> that
actually fills out content of config/the_isa.hh file.
Here, because I compiled GEM5 with the X86 configuration,
it defines the <em>TheISA</em> as <em>X86ISA</em>.</p>

<p>Therefore, when the TheISA has been used on the cpu related files,
it is not a actual namespace called “TheISA”,
but the architecture dependent ISA namespace.
Consequently,
when you encounter namespace TheISA,
first check whether the config/the_isa.hh header file has been included
in your target source file;
and when the answer is yes,
you have to look at the architecture dependent namespace
defined in the gem5/src/arch/YOUR_ARCHITECTURE directory.
In my case, because I use the X86
it should be X86ISA namespace.</p>

<h3 id="setintreg-with-theisa"><span class="me-2">SetIntReg with TheISA</span><a href="#setintreg-with-theisa" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>Now let’s go back to SimpleThread class.
In addition to the architecture specific register context,
it provides <em>setIntReg</em> function.
It allows the processor to store the data 
on intRegs array located by the index.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre><span class="mi">477</span>     <span class="kt">void</span>
<span class="mi">478</span>     <span class="nf">setIntReg</span><span class="p">(</span><span class="n">RegIndex</span> <span class="n">reg_idx</span><span class="p">,</span> <span class="n">RegVal</span> <span class="n">val</span><span class="p">)</span> <span class="k">override</span>
<span class="mi">479</span>     <span class="p">{</span>
<span class="mi">480</span>         <span class="kt">int</span> <span class="n">flatIndex</span> <span class="o">=</span> <span class="n">isa</span><span class="o">-&gt;</span><span class="n">flattenIntIndex</span><span class="p">(</span><span class="n">reg_idx</span><span class="p">);</span>
<span class="mi">481</span>         <span class="nf">assert</span><span class="p">(</span><span class="n">flatIndex</span> <span class="o">&lt;</span> <span class="n">TheISA</span><span class="o">::</span><span class="n">NumIntRegs</span><span class="p">);</span>
<span class="mi">482</span>         <span class="nf">DPRINTF</span><span class="p">(</span><span class="n">IntRegs</span><span class="p">,</span> <span class="s">"Setting int reg %d (%d) to %#x.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
<span class="mi">483</span>                 <span class="n">reg_idx</span><span class="p">,</span> <span class="n">flatIndex</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="mi">484</span>         <span class="nf">setIntRegFlat</span><span class="p">(</span><span class="n">flatIndex</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="mi">485</span>     <span class="p">}</span>

<span class="mi">618</span>     <span class="kt">void</span>
<span class="mi">619</span>     <span class="n">setIntRegFlat</span><span class="p">(</span><span class="n">RegIndex</span> <span class="n">idx</span><span class="p">,</span> <span class="n">RegVal</span> <span class="n">val</span><span class="p">)</span> <span class="k">override</span>
<span class="mi">620</span>     <span class="p">{</span>
<span class="mi">621</span>         <span class="n">intRegs</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
<span class="mi">622</span>     <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>
<p>Note that the val is stored in the intRegs array 
through the unified interface <em>setIntReg</em> function.
The IntRegs contains 
not only the architecture registers 
such as rsi,rdi,rcx in x86,
but also the integer type micro-registers 
used only by the microops.</p>

<p>Because x86 in GEM5 defines 
16 Integer registers available to the microops,
(look at gem5/src/arch/x86/x86_traits.hh) 
it can pass up to 16 Integer value 
to the microcode
through the setIntReg function.
As shown in the invoke function,
micro register 1,7, and 15 has been used 
to pass the fault related arguments to the microops.</p>

<h2 id="jump-to-the-rom-code"><span class="me-2">Jump to the ROM code!</span><a href="#jump-to-the-rom-code" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<p>After finishing setting the required parameters
now, it jumps to the stored ROM code 
pointed to by the label.
This control flow transition is done by 
updating <em>_pcState</em> memeber field 
of the SimpleThread class object.</p>

<p><em>gem5/srch/arch/x86/faults.cc</em></p>
<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre> 92         pcState.upc(romMicroPC(entry));
 93         pcState.nupc(romMicroPC(entry) + 1);
 94         tc-&gt;pcState(pcState);
 95     }
</pre></td></tr></tbody></table></code></div></div>

<p>When we look at the above code
in the invoke function of X86FaultBase class,
we can find that it updates upc field of the pcState 
to location of the ROM code.</p>

<p><em>gem5/src/base/types.hh</em></p>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td class="rouge-code"><pre><span class="mi">144</span> <span class="k">typedef</span> <span class="kt">uint16_t</span> <span class="n">MicroPC</span><span class="p">;</span>
<span class="mi">145</span>
<span class="mi">146</span> <span class="k">static</span> <span class="k">const</span> <span class="n">MicroPC</span> <span class="n">MicroPCRomBit</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">MicroPC</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<span class="mi">147</span>
<span class="mi">148</span> <span class="k">static</span> <span class="kr">inline</span> <span class="n">MicroPC</span>
<span class="mi">149</span> <span class="n">romMicroPC</span><span class="p">(</span><span class="n">MicroPC</span> <span class="n">upc</span><span class="p">)</span>
<span class="mi">150</span> <span class="p">{</span>
<span class="mi">151</span>     <span class="k">return</span> <span class="n">upc</span> <span class="o">|</span> <span class="n">MicroPCRomBit</span><span class="p">;</span>
<span class="mi">152</span> <span class="p">}</span>
<span class="mi">153</span>
<span class="mi">154</span> <span class="k">static</span> <span class="kr">inline</span> <span class="n">MicroPC</span>
<span class="mi">155</span> <span class="n">normalMicroPC</span><span class="p">(</span><span class="n">MicroPC</span> <span class="n">upc</span><span class="p">)</span>
<span class="mi">156</span> <span class="p">{</span>
<span class="mi">157</span>     <span class="k">return</span> <span class="n">upc</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">MicroPCRomBit</span><span class="p">;</span>
<span class="mi">158</span> <span class="p">}</span>
<span class="mi">159</span>
<span class="mi">160</span> <span class="k">static</span> <span class="kr">inline</span> <span class="kt">bool</span>
<span class="mi">161</span> <span class="n">isRomMicroPC</span><span class="p">(</span><span class="n">MicroPC</span> <span class="n">upc</span><span class="p">)</span>
<span class="mi">162</span> <span class="p">{</span>
<span class="mi">163</span>     <span class="k">return</span> <span class="n">MicroPCRomBit</span> <span class="o">&amp;</span> <span class="n">upc</span><span class="p">;</span>
<span class="mi">164</span> <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Note that romMicroPC function sets flag to specify upc 
points to start address of ROM code.
Here the flag is just bit-wise ored to the upc address.</p>

<p><em>arch/generic/types.hh</em></p>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre><span class="mi">193</span> <span class="c1">// A PC and microcode PC.</span>
<span class="mi">194</span> <span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">MachInst</span><span class="p">&gt;</span>
<span class="mi">195</span> <span class="k">class</span> <span class="nc">UPCState</span> <span class="o">:</span> <span class="k">public</span> <span class="n">SimplePCState</span><span class="o">&lt;</span><span class="n">MachInst</span><span class="o">&gt;</span>
<span class="mi">196</span> <span class="p">{</span>
<span class="mi">197</span>   <span class="k">protected</span><span class="o">:</span>
<span class="mi">198</span>     <span class="k">typedef</span> <span class="n">SimplePCState</span><span class="o">&lt;</span><span class="n">MachInst</span><span class="o">&gt;</span> <span class="n">Base</span><span class="p">;</span>
<span class="mi">199</span> 
<span class="mi">200</span>     <span class="n">MicroPC</span> <span class="n">_upc</span><span class="p">;</span>
<span class="mi">201</span>     <span class="n">MicroPC</span> <span class="n">_nupc</span><span class="p">;</span>
<span class="mi">202</span> 
<span class="mi">203</span>   <span class="k">public</span><span class="o">:</span>
<span class="mi">204</span> 
<span class="mi">205</span>     <span class="n">MicroPC</span> <span class="n">upc</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">_upc</span><span class="p">;</span> <span class="p">}</span>
<span class="mi">206</span>     <span class="kt">void</span> <span class="nf">upc</span><span class="p">(</span><span class="n">MicroPC</span> <span class="n">val</span><span class="p">)</span> <span class="p">{</span> <span class="n">_upc</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span> <span class="p">}</span>
<span class="mi">207</span> 
<span class="mi">208</span>     <span class="n">MicroPC</span> <span class="n">nupc</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">_nupc</span><span class="p">;</span> <span class="p">}</span>
<span class="mi">209</span>     <span class="kt">void</span> <span class="nf">nupc</span><span class="p">(</span><span class="n">MicroPC</span> <span class="n">val</span><span class="p">)</span> <span class="p">{</span> <span class="n">_nupc</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span> <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>
<p>After the upc address is generated,
it needs to update the pcState variable to change the 
current upc address. You can also update the upc address of the 
current processor’s pcState variable, it is recommended to pass
newly initialized pcState object to the processor context. 
Therefore, new pcState variable invokes upc function
to update its upc address.
After that, by invoking tc-&gt;pcState(pcState),
it update member field _pcState of a threadContexts
to a new pcState,
which makes the processor run 
from the updated micro pc address
when the next fetch happens.</p>

<p>However, note that this function just updates 
_pcState member field of the ThreadContex.
Then who actually redirects the pipeline to 
fetch the new instructions from the ROM
not from the faulting instruction?
Let’s go back to the advancePC function
that called the invoke function.</p>

<h1 id="lets-go-back-to-advancepc--advanceinst">Let’s go back to advancePC &amp; advanceInst</h1>
<p><em>gem5/src/cpu/simple/base.cc</em></p>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="mi">673</span>         <span class="n">fault</span><span class="o">-&gt;</span><span class="n">invoke</span><span class="p">(</span><span class="n">threadContexts</span><span class="p">[</span><span class="n">curThread</span><span class="p">],</span> <span class="n">curStaticInst</span><span class="p">);</span>
<span class="mi">674</span>         <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">decoder</span><span class="p">.</span><span class="n">reset</span><span class="p">();</span>
</pre></td></tr></tbody></table></code></div></div>
<p>After the invoke function is called 
as part of the advancePC function,
it resets the decoder,
which updates decoder state as <em>ResetState</em>.</p>

<p><em>gem5/src/cpu/simple/timing.cc</em></p>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre></td><td class="rouge-code"><pre> <span class="mi">730</span> <span class="kt">void</span>
 <span class="mi">731</span> <span class="n">TimingSimpleCPU</span><span class="o">::</span><span class="n">advanceInst</span><span class="p">(</span><span class="k">const</span> <span class="n">Fault</span> <span class="o">&amp;</span><span class="n">fault</span><span class="p">)</span>
 <span class="mi">732</span> <span class="p">{</span>
 <span class="mi">733</span>     <span class="n">SimpleExecContext</span> <span class="o">&amp;</span><span class="n">t_info</span> <span class="o">=</span> <span class="o">*</span><span class="n">threadInfo</span><span class="p">[</span><span class="n">curThread</span><span class="p">];</span>
 <span class="mi">734</span>
 <span class="mi">735</span>     <span class="k">if</span> <span class="p">(</span><span class="n">_status</span> <span class="o">==</span> <span class="n">Faulting</span><span class="p">)</span>
 <span class="mi">736</span>         <span class="k">return</span><span class="p">;</span>
 <span class="mi">737</span>
 <span class="mi">738</span>     <span class="k">if</span> <span class="p">(</span><span class="n">fault</span> <span class="o">!=</span> <span class="n">NoFault</span><span class="p">)</span> <span class="p">{</span>
 <span class="mi">739</span>         <span class="n">DPRINTF</span><span class="p">(</span><span class="n">SimpleCPU</span><span class="p">,</span> <span class="s">"Fault occured. Handling the fault</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
 <span class="mi">740</span>
 <span class="mi">741</span>         <span class="n">advancePC</span><span class="p">(</span><span class="n">fault</span><span class="p">);</span>
 <span class="mi">742</span>     <span class="k">if</span> <span class="p">(</span><span class="n">fault</span> <span class="o">!=</span> <span class="n">NoFault</span><span class="p">)</span> <span class="p">{</span>
 <span class="mi">743</span>         <span class="n">DPRINTF</span><span class="p">(</span><span class="n">SimpleCPU</span><span class="p">,</span> <span class="s">"Fault occured. Handling the fault</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
 <span class="mi">744</span>
 <span class="mi">745</span>         <span class="n">advancePC</span><span class="p">(</span><span class="n">fault</span><span class="p">);</span>
 <span class="mi">746</span>
 <span class="mi">747</span>         <span class="c1">// A syscall fault could suspend this CPU (e.g., futex_wait)</span>
 <span class="mi">748</span>         <span class="c1">// If the _status is not Idle, schedule an event to fetch the next</span>
 <span class="mi">749</span>         <span class="c1">// instruction after 'stall' ticks.</span>
 <span class="mi">750</span>         <span class="c1">// If the cpu has been suspended (i.e., _status == Idle), another</span>
 <span class="mi">751</span>         <span class="c1">// cpu will wake this cpu up later.</span>
 <span class="mi">752</span>         <span class="k">if</span> <span class="p">(</span><span class="n">_status</span> <span class="o">!=</span> <span class="n">Idle</span><span class="p">)</span> <span class="p">{</span>
 <span class="mi">753</span>             <span class="n">DPRINTF</span><span class="p">(</span><span class="n">SimpleCPU</span><span class="p">,</span> <span class="s">"Scheduling fetch event after the Fault</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
 <span class="mi">754</span>
 <span class="mi">755</span>             <span class="n">Tick</span> <span class="n">stall</span> <span class="o">=</span> <span class="n">dynamic_pointer_cast</span><span class="o">&lt;</span><span class="n">SyscallRetryFault</span><span class="o">&gt;</span><span class="p">(</span><span class="n">fault</span><span class="p">)</span> <span class="o">?</span>
 <span class="mi">756</span>                          <span class="n">clockEdge</span><span class="p">(</span><span class="n">syscallRetryLatency</span><span class="p">)</span> <span class="o">:</span> <span class="n">clockEdge</span><span class="p">();</span>
 <span class="mi">757</span>             <span class="n">reschedule</span><span class="p">(</span><span class="n">fetchEvent</span><span class="p">,</span> <span class="n">stall</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
 <span class="mi">758</span>             <span class="n">_status</span> <span class="o">=</span> <span class="n">Faulting</span><span class="p">;</span>
 <span class="mi">759</span>         <span class="p">}</span>
 <span class="mi">760</span>
 <span class="mi">761</span>         <span class="k">return</span><span class="p">;</span>
 <span class="mi">762</span>     <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>After returning from the advancePC instruction,
<em>advanceInst</em> function checks status of the current processor.
When the processor is not in idle state, 
it reschedules fetchEvent
to be executed again after stall ticks.
Also note that status of the processor 
has been changed to Faulting.</p>

<h3 id="fetchevent-invokes-fetch-function"><span class="me-2">fetchEvent invokes fetch() function</span><a href="#fetchevent-invokes-fetch-function" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>By the way what is the fetchEvent?</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre>  <span class="mi">79</span> <span class="n">TimingSimpleCPU</span><span class="o">::</span><span class="n">TimingSimpleCPU</span><span class="p">(</span><span class="n">TimingSimpleCPUParams</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
  <span class="mi">80</span>     <span class="o">:</span> <span class="n">BaseSimpleCPU</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="n">fetchTranslation</span><span class="p">(</span><span class="k">this</span><span class="p">),</span> <span class="n">icachePort</span><span class="p">(</span><span class="k">this</span><span class="p">),</span>
  <span class="mi">81</span>       <span class="nf">dcachePort</span><span class="p">(</span><span class="k">this</span><span class="p">),</span> <span class="n">ifetch_pkt</span><span class="p">(</span><span class="nb">NULL</span><span class="p">),</span> <span class="n">dcache_pkt</span><span class="p">(</span><span class="nb">NULL</span><span class="p">),</span> <span class="n">previousCycle</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
  <span class="mi">82</span>       <span class="n">fetchEvent</span><span class="p">([</span><span class="k">this</span><span class="p">]{</span> <span class="n">fetch</span><span class="p">();</span> <span class="p">},</span> <span class="n">name</span><span class="p">())</span>
  <span class="mi">83</span> <span class="p">{</span>
  <span class="mi">84</span>     <span class="n">_status</span> <span class="o">=</span> <span class="n">Idle</span><span class="p">;</span>
  <span class="mi">85</span> <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Because <em>fetchEvent</em> is initialized to invoke <em>fetch()</em> function
at TimingSimpleCPU constructor,
after a stall time passed, 
it will invoke fetch function to fetch new instruction from the 
faulting address.</p>

<p><em>fetchEvent</em> is defined as a EventFunctionWrapper type 
used for registering event in GEM5.
Also, the fetchEvent is initiated by the constructor 
of the TimingSimpleCPU class 
to invoke fetch() function.
Therefore, after the stall ticks passed,
it invokes fetch() function defined in the TimingSimpleCPU class.</p>

<h2 id="now-start-to-fetch-from-updatd-rip-the-rom-code"><span class="me-2">Now start to fetch from updatd RIP, the ROM code!</span><a href="#now-start-to-fetch-from-updatd-rip-the-rom-code" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
</pre></td><td class="rouge-code"><pre> <span class="mi">653</span> <span class="kt">void</span>
 <span class="mi">654</span> <span class="n">TimingSimpleCPU</span><span class="o">::</span><span class="n">fetch</span><span class="p">()</span>
 <span class="mi">655</span> <span class="p">{</span>
 <span class="mi">656</span>     <span class="c1">// Change thread if multi-threaded</span>
 <span class="mi">657</span>     <span class="n">swapActiveThread</span><span class="p">();</span>
 <span class="mi">658</span>
 <span class="mi">659</span>     <span class="n">SimpleExecContext</span> <span class="o">&amp;</span><span class="n">t_info</span> <span class="o">=</span> <span class="o">*</span><span class="n">threadInfo</span><span class="p">[</span><span class="n">curThread</span><span class="p">];</span>
 <span class="mi">660</span>     <span class="n">SimpleThread</span><span class="o">*</span> <span class="kr">thread</span> <span class="o">=</span> <span class="n">t_info</span><span class="p">.</span><span class="kr">thread</span><span class="p">;</span>
 <span class="mi">661</span>
 <span class="mi">662</span>     <span class="n">DPRINTF</span><span class="p">(</span><span class="n">SimpleCPU</span><span class="p">,</span> <span class="s">"Fetch</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
 <span class="mi">663</span>
 <span class="mi">664</span>     <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">curStaticInst</span> <span class="o">||</span> <span class="o">!</span><span class="n">curStaticInst</span><span class="o">-&gt;</span><span class="n">isDelayedCommit</span><span class="p">())</span> <span class="p">{</span>
 <span class="mi">665</span>         <span class="n">checkForInterrupts</span><span class="p">();</span>
 <span class="mi">666</span>         <span class="n">checkPcEventQueue</span><span class="p">();</span>
 <span class="mi">667</span>     <span class="p">}</span>
 <span class="mi">668</span>
 <span class="mi">669</span>     <span class="c1">// We must have just got suspended by a PC event</span>
 <span class="mi">670</span>     <span class="k">if</span> <span class="p">(</span><span class="n">_status</span> <span class="o">==</span> <span class="n">Idle</span><span class="p">)</span>
 <span class="mi">671</span>         <span class="k">return</span><span class="p">;</span>
 <span class="mi">672</span>
 <span class="mi">673</span>     <span class="n">TheISA</span><span class="o">::</span><span class="n">PCState</span> <span class="n">pcState</span> <span class="o">=</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">pcState</span><span class="p">();</span>
 <span class="mi">674</span>     <span class="kt">bool</span> <span class="n">needToFetch</span> <span class="o">=</span> <span class="o">!</span><span class="n">isRomMicroPC</span><span class="p">(</span><span class="n">pcState</span><span class="p">.</span><span class="n">microPC</span><span class="p">())</span> <span class="o">&amp;&amp;</span>
 <span class="mi">675</span>                        <span class="o">!</span><span class="n">curMacroStaticInst</span><span class="p">;</span>
 <span class="mi">676</span>
 <span class="mi">677</span>     <span class="nf">if</span> <span class="p">(</span><span class="n">needToFetch</span><span class="p">)</span> <span class="p">{</span>
 <span class="mi">678</span>         <span class="n">_status</span> <span class="o">=</span> <span class="n">BaseSimpleCPU</span><span class="o">::</span><span class="n">Running</span><span class="p">;</span>
 <span class="mi">679</span>         <span class="n">RequestPtr</span> <span class="n">ifetch_req</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">Request</span><span class="o">&gt;</span><span class="p">();</span>
 <span class="mi">680</span>         <span class="n">ifetch_req</span><span class="o">-&gt;</span><span class="n">taskId</span><span class="p">(</span><span class="n">taskId</span><span class="p">());</span>
 <span class="mi">681</span>         <span class="n">ifetch_req</span><span class="o">-&gt;</span><span class="n">setContext</span><span class="p">(</span><span class="kr">thread</span><span class="o">-&gt;</span><span class="n">contextId</span><span class="p">());</span>
 <span class="mi">682</span>         <span class="n">setupFetchRequest</span><span class="p">(</span><span class="n">ifetch_req</span><span class="p">);</span>
 <span class="mi">683</span>         <span class="n">DPRINTF</span><span class="p">(</span><span class="n">SimpleCPU</span><span class="p">,</span> <span class="s">"Translating address %#x</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">ifetch_req</span><span class="o">-&gt;</span><span class="n">getVaddr</span><span class="p">());</span>
 <span class="mi">684</span>         <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">itb</span><span class="o">-&gt;</span><span class="n">translateTiming</span><span class="p">(</span><span class="n">ifetch_req</span><span class="p">,</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">getTC</span><span class="p">(),</span>
 <span class="mi">685</span>                 <span class="o">&amp;</span><span class="n">fetchTranslation</span><span class="p">,</span> <span class="n">BaseTLB</span><span class="o">::</span><span class="n">Execute</span><span class="p">);</span>
 <span class="mi">686</span>     <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
 <span class="mi">687</span>         <span class="n">_status</span> <span class="o">=</span> <span class="n">IcacheWaitResponse</span><span class="p">;</span>
 <span class="mi">688</span>         <span class="n">completeIfetch</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
 <span class="mi">689</span>
 <span class="mi">690</span>         <span class="n">updateCycleCounts</span><span class="p">();</span>
 <span class="mi">691</span>         <span class="n">updateCycleCounters</span><span class="p">(</span><span class="n">BaseCPU</span><span class="o">::</span><span class="n">CPU_STATE_ON</span><span class="p">);</span>
 <span class="mi">692</span>     <span class="p">}</span>
 <span class="mi">693</span> <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Remeber that 
curMacroStaticInst has been set to 
<em>StaticInst::nullStaticInstPtr</em>
by advancePC.
Also, upc has been updated to the ROM code address
with MicroPCRomBit flag.
Therefore, it sets needToFetch True 
and start to fetch new instructions from the ROM code.</p>

  </div>

  <div class="post-tail-wrapper text-muted">
    <!-- categories -->
    

    <!-- tags -->
    

    <div
      class="
        post-tail-bottom
        d-flex justify-content-between align-items-center mt-5 pb-2
      "
    >
      <div class="license-wrapper">
        
          

          This post is licensed under 
        <a href="https://creativecommons.org/licenses/by/4.0/">
          CC BY 4.0
        </a>
         by the author.
        
      </div>

      <!-- Post sharing snippet -->

<div class="share-wrapper d-flex align-items-center">
  <span class="share-label text-muted">Share</span>
  <span class="share-icons">
    
    
    

    

      

      <a
        href="https://twitter.com/intent/tweet?text=Gem5%20X86%20Tlb%20-%20Ruach&url=http%3A%2F%2Flocalhost%3A4000%2Fposts%2Fgem5-x86-tlb%2F"
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Twitter"
        target="_blank"
        rel="noopener"
        aria-label="Twitter"
      >
        <i class="fa-fw fa-brands fa-square-x-twitter"></i>
      </a>
    

      

      <a
        href="https://www.facebook.com/sharer/sharer.php?title=Gem5%20X86%20Tlb%20-%20Ruach&u=http%3A%2F%2Flocalhost%3A4000%2Fposts%2Fgem5-x86-tlb%2F"
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Facebook"
        target="_blank"
        rel="noopener"
        aria-label="Facebook"
      >
        <i class="fa-fw fab fa-facebook-square"></i>
      </a>
    

      

      <a
        href="https://t.me/share/url?url=http%3A%2F%2Flocalhost%3A4000%2Fposts%2Fgem5-x86-tlb%2F&text=Gem5%20X86%20Tlb%20-%20Ruach"
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Telegram"
        target="_blank"
        rel="noopener"
        aria-label="Telegram"
      >
        <i class="fa-fw fab fa-telegram"></i>
      </a>
    

      

      <a
        href="https://www.linkedin.com/sharing/share-offsite/?url=http%3A%2F%2Flocalhost%3A4000%2Fposts%2Fgem5-x86-tlb%2F"
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Linkedin"
        target="_blank"
        rel="noopener"
        aria-label="Linkedin"
      >
        <i class="fa-fw fab fa-linkedin"></i>
      </a>
    

    <button
      id="copy-link"
      aria-label="Copy link"
      class="btn small"
      data-bs-toggle="tooltip"
      data-bs-placement="top"
      title="Copy link"
      data-title-succeed="Link copied successfully!"
    >
      <i class="fa-fw fas fa-link pe-none fs-6"></i>
    </button>
  </span>
</div>

    </div>
    <!-- .post-tail-bottom -->
  </div>
  <!-- div.post-tail-wrapper -->
</article>


            
          </main>

          <!-- panel -->
          <aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 mb-5 text-muted">
            <div class="access">
              <!-- Get the last 5 posts from lastmod list. -->















              <!-- The trending tags list -->


















            </div>

            
              
              



  <section id="toc-wrapper" class="ps-0 pe-4">
    <h2 class="panel-heading ps-3 pt-2 mb-2">Contents</h2>
    <nav id="toc"></nav>
  </section>


            
          </aside>
        </div>

        <div class="row">
          <!-- tail -->
          <div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4">
            
              
              <!-- Recommend the other 3 posts according to the tags and categories of the current post. -->

<!-- The total size of related posts -->


<!-- An random integer that bigger than 0 -->


<!-- Equals to TAG_SCORE / {max_categories_hierarchy} -->

























            
              
              <!-- Navigation buttons at the bottom of the post. -->

<nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation">
  
  

  
    <a
      href="/posts/template-generating-microop/"
      class="btn btn-outline-primary"
      aria-label="Older"
    >
      <p>Template Generating Microop</p>
    </a>
  

  
    <a
      href="/posts/gem5-memaccess/"
      class="btn btn-outline-primary"
      aria-label="Newer"
    >
      <p>Gem5 Memaccess</p>
    </a>
  
</nav>

            
              
              <!--  The comments switcher -->


            

            <!-- The Footer -->

<footer
  aria-label="Site Info"
  class="
    d-flex flex-column justify-content-center text-muted
    flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3
  "
>
  <p>
    ©
    <time>2023</time>
    <a href="https://ruach.github.io">Jaehyuk Lee</a>.
    
      <span
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author."
      >Some rights reserved.</span>
    
  </p>

  <p>Using the <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme for <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>
  </p>
</footer>

          </div>
        </div>

        <!-- The Search results -->

<div id="search-result-wrapper" class="d-flex justify-content-center unloaded">
  <div class="col-11 content">
    <div id="search-hints">
      <!-- The trending tags list -->


















    </div>
    <div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div>
  </div>
</div>

      </div>

      <aside aria-label="Scroll to Top">
        <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow">
          <i class="fas fa-angle-up"></i>
        </button>
      </aside>
    </div>

    <div id="mask"></div>

    
      <aside
  id="notification"
  class="toast"
  role="alert"
  aria-live="assertive"
  aria-atomic="true"
  data-bs-animation="true"
  data-bs-autohide="false"
>
  <div class="toast-header">
    <button
      type="button"
      class="btn-close ms-auto"
      data-bs-dismiss="toast"
      aria-label="Close"
    ></button>
  </div>
  <div class="toast-body text-center pt-0">
    <p class="px-2 mb-3">A new version of content is available.</p>
    <button type="button" class="btn btn-primary" aria-label="Update">
      Update
    </button>
  </div>
</aside>

    

    <!-- JavaScripts -->

    <!-- JS selector for site. -->

<!-- commons -->



<!-- layout specified -->


  

  
    <!-- image lazy-loading & popup & clipboard -->
    
  















  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  



  <script src="https://cdn.jsdelivr.net/combine/npm/jquery@3.7.1/dist/jquery.min.js,npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js,npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/magnific-popup@1.1.0/dist/jquery.magnific-popup.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.10/dayjs.min.js,npm/dayjs@1.11.10/locale/en.min.js,npm/dayjs@1.11.10/plugin/relativeTime.min.js,npm/dayjs@1.11.10/plugin/localizedFormat.min.js,npm/tocbot@4.21.2/dist/tocbot.min.js"></script>






<script defer src="/assets/js/dist/post.min.js"></script>






    

    <!--
  Jekyll Simple Search loader
  See: <https://github.com/christian-fei/Simple-Jekyll-Search>
-->





<script>
  /* Note: dependent library will be loaded in `js-selector.html` */
  SimpleJekyllSearch({
    searchInput: document.getElementById('search-input'),
    resultsContainer: document.getElementById('search-results'),
    json: '/assets/js/data/search.json',
    searchResultTemplate: '  <article class="px-1 px-sm-2 px-lg-4 px-xl-0">    <header>      <h2><a href="{url}">{title}</a></h2>      <div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1">        {categories}        {tags}      </div>    </header>    <p>{snippet}</p>  </article>',
    noResultsText: '<p class="mt-5"></p>',
    templateMiddleware: function(prop, value, template) {
      if (prop === 'categories') {
        if (value === '') {
          return `${value}`;
        } else {
          return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`;
        }
      }

      if (prop === 'tags') {
        if (value === '') {
          return `${value}`;
        } else {
          return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`;
        }
      }
    }
  });
</script>

  </body>
</html>

