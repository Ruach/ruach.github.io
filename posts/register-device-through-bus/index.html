<!doctype html>














<!-- `site.alt_lang` can specify a language different from the UI -->
<html lang="en" data-mode="light">
  <!-- The Head -->

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta
    name="viewport"
    content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover"
  >

  

  

  
    <!-- Begin Jekyll SEO tag v2.8.0 -->
<meta name="generator" content="Jekyll v4.3.2" />
<meta property="og:title" content="Register Device Through Bus" />
<meta property="og:locale" content="en" />
<meta name="description" content="Initializing usb subsystem ```c /* Init */ static int __init usb_init(void) { int retval; if (usb_disabled()) { pr_info(“%s: USB support disabled\n”, usbcore_name); return 0; } usb_init_pool_max();" />
<meta property="og:description" content="Initializing usb subsystem ```c /* Init */ static int __init usb_init(void) { int retval; if (usb_disabled()) { pr_info(“%s: USB support disabled\n”, usbcore_name); return 0; } usb_init_pool_max();" />
<link rel="canonical" href="https://ruach.github.io/posts/register-device-through-bus/" />
<meta property="og:url" content="https://ruach.github.io/posts/register-device-through-bus/" />
<meta property="og:site_name" content="Ruach" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-05-04T00:00:00-04:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Register Device Through Bus" />
<meta name="twitter:site" content="@ruach_lee" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2021-05-04T00:00:00-04:00","datePublished":"2021-05-04T00:00:00-04:00","description":"Initializing usb subsystem ```c /* Init */ static int __init usb_init(void) { int retval; if (usb_disabled()) { pr_info(“%s: USB support disabled\\n”, usbcore_name); return 0; } usb_init_pool_max();","headline":"Register Device Through Bus","mainEntityOfPage":{"@type":"WebPage","@id":"https://ruach.github.io/posts/register-device-through-bus/"},"url":"https://ruach.github.io/posts/register-device-through-bus/"}</script>
<!-- End Jekyll SEO tag -->

  

  <title>Register Device Through Bus | Ruach
  </title>

  <!--
  The Favicons for Web, Android, Microsoft, and iOS (iPhone and iPad) Apps
  Generated by: https://realfavicongenerator.net/
-->



<link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png">
<link rel="manifest" href="/assets/img/favicons/site.webmanifest">
<link rel="shortcut icon" href="/assets/img/favicons/favicon.ico">
<meta name="apple-mobile-web-app-title" content="Ruach">
<meta name="application-name" content="Ruach">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml">
<meta name="theme-color" content="#ffffff">


  
    
      <link rel="preconnect" href="https://fonts.googleapis.com" >
      <link rel="dns-prefetch" href="https://fonts.googleapis.com" >
    
      <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      <link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin>
    
      <link rel="preconnect" href="https://fonts.googleapis.com" >
      <link rel="dns-prefetch" href="https://fonts.googleapis.com" >
    
      <link rel="preconnect" href="https://cdn.jsdelivr.net" >
      <link rel="dns-prefetch" href="https://cdn.jsdelivr.net" >
    

    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap">
  

  <!-- GA -->
  

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.2/css/all.min.css">

  <link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css">

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.21.2/dist/tocbot.min.css">
  

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css">
  

  
    <!-- Manific Popup -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css">
  

  <!-- JavaScript -->

  

  <!-- A placeholder to allow defining custom metadata -->

</head>


  <body>
    <!-- The Side Bar -->

<aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end">
  <header class="profile-wrapper">
    <a href="/" id="avatar" class="rounded-circle">
      
        
        <img src="/assets/img/jaehyuk.png" width="112" height="112" alt="avatar" onerror="this.style.display='none'">
      
    </a>

    <h1 class="site-title">
      <a href="/">Ruach</a>
    </h1>
    <p class="site-subtitle fst-italic mb-0">Jaehyuk Lee</p>
  </header>
  <!-- .profile-wrapper -->

  <nav class="flex-column flex-grow-1 w-100 ps-0">
    <ul class="nav">
      <!-- home -->
      <li class="nav-item">
        <a href="/" class="nav-link">
          <i class="fa-fw fas fa-home"></i>
          <span>HOME</span>
        </a>
      </li>
      <!-- the real tabs -->
      
        <li class="nav-item">
          <a href="/categories/" class="nav-link">
            <i class="fa-fw fas fa-stream"></i>
            

            <span>CATEGORIES</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/tags/" class="nav-link">
            <i class="fa-fw fas fa-tags"></i>
            

            <span>TAGS</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/archives/" class="nav-link">
            <i class="fa-fw fas fa-archive"></i>
            

            <span>ARCHIVES</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/about/" class="nav-link">
            <i class="fa-fw fas fa-info-circle"></i>
            

            <span>ABOUT</span>
          </a>
        </li>
        <!-- .nav-item -->
      
    </ul>
  </nav>

  <div class="sidebar-bottom d-flex flex-wrap  align-items-center w-100">
    

    
      

      
        <a
          href="javascript:location.href = 'mailto:' + ['jaehyuk','gatech.edu'].join('@')"
          aria-label="email"
          

          

          

          
        >
          <i class="fas fa-envelope"></i>
        </a>
      
    
      

      
        <a
          href="https://www.linkedin.com/in/jaehyuk-lee-29b33b121/"
          aria-label="linkedin"
          

          
            target="_blank"
            
          

          

          
            rel="noopener noreferrer"
          
        >
          <i class="fab fa-linkedin"></i>
        </a>
      
    
      

      
        <a
          href="https://github.com/Ruach"
          aria-label="github"
          

          
            target="_blank"
            
          

          

          
            rel="noopener noreferrer"
          
        >
          <i class="fab fa-github"></i>
        </a>
      
    
      

      
        <a
          href="https://stackoverflow.com/users/4460514/ruach?tab=profile"
          aria-label="stack-overflow"
          

          
            target="_blank"
            
          

          

          
            rel="noopener noreferrer"
          
        >
          <i class="fab fa-stack-overflow"></i>
        </a>
      
    
  </div>
  <!-- .sidebar-bottom -->
</aside>
<!-- #sidebar -->


    <div id="main-wrapper" class="d-flex justify-content-center">
      <div class="container d-flex flex-column px-xxl-5">
        <!-- The Top Bar -->

<header id="topbar-wrapper" aria-label="Top Bar">
  <div
    id="topbar"
    class="d-flex align-items-center justify-content-between px-lg-3 h-100"
  >
    <nav id="breadcrumb" aria-label="Breadcrumb">
      

      
        
          
            <span>
              <a href="/">
                Home
              </a>
            </span>

          
        
          
        
          
            
              <span>Register Device Through Bus</span>
            

          
        
      
    </nav>
    <!-- endof #breadcrumb -->

    <button type="button" id="sidebar-trigger" class="btn btn-link">
      <i class="fas fa-bars fa-fw"></i>
    </button>

    <div id="topbar-title">
      Post
    </div>

    <button type="button" id="search-trigger" class="btn btn-link">
      <i class="fas fa-search fa-fw"></i>
    </button>

    <search class="align-items-center ms-3 ms-lg-0">
      <i class="fas fa-search fa-fw"></i>
      <input
        class="form-control"
        id="search-input"
        type="search"
        aria-label="search"
        autocomplete="off"
        placeholder="Search..."
      >
    </search>
    <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button>
  </div>
</header>


        <div class="row flex-grow-1">
          <main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4">
            
              <!-- Refactor the HTML structure -->



<!--
  In order to allow a wide table to scroll horizontally,
  we suround the markdown table with `<div class="table-wrapper">` and `</div>`
-->



<!--
  Fixed kramdown code highlight rendering:
  https://github.com/penibelst/jekyll-compress-html/issues/101
  https://github.com/penibelst/jekyll-compress-html/issues/71#issuecomment-188144901
-->



<!-- Change the icon of checkbox -->



<!-- Handle images -->





<!-- Add header for code snippets -->



<!-- Create heading anchors -->





  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    

    
  

  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    

    
  

  
  

  

  
  

  




<!-- return -->




<article class="px-1">
  <header>
    <h1 data-toc-skip>Register Device Through Bus</h1>

    <div class="post-meta text-muted">
      <!-- published date -->
      <span>
        Posted
        <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1620100800"
  data-df="ll"
  
    data-bs-toggle="tooltip" data-bs-placement="bottom"
  
>
  May  4, 2021
</time>

      </span>

      <!-- lastmod date -->
      

      

      <div class="d-flex justify-content-between">
        <!-- author(s) -->
        <span>
          

          By

          <em>
            
              <a href="https://ruach.github.io">Jaehyuk Lee</a>
            
          </em>
        </span>

        <!-- read time -->
        <!-- Calculate the post's reading time, and display the word count in tooltip -->



<!-- words per minute -->










<!-- return element -->
<span
  class="readtime"
  data-bs-toggle="tooltip"
  data-bs-placement="bottom"
  title="10106 words"
>
  <em>56 min</em> read</span>

      </div>
      <!-- .d-flex -->
    </div>
    <!-- .post-meta -->
  </header>

  <div class="content">
    <h1 id="initializing-usb-subsystem">Initializing usb subsystem</h1>
<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
</pre></td><td class="rouge-code"><pre><span class="cm">/*
 * Init
 */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">usb_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">usb_disabled</span><span class="p">())</span> <span class="p">{</span>
                <span class="n">pr_info</span><span class="p">(</span><span class="s">"%s: USB support disabled</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">usbcore_name</span><span class="p">);</span>
                <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">usb_init_pool_max</span><span class="p">();</span>

        <span class="n">usb_debugfs_init</span><span class="p">();</span>

        <span class="n">usb_acpi_register</span><span class="p">();</span>
        <span class="n">retval</span> <span class="o">=</span> <span class="n">bus_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usb_bus_type</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
                <span class="k">goto</span> <span class="n">bus_register_failed</span><span class="p">;</span>
        <span class="n">retval</span> <span class="o">=</span> <span class="n">bus_register_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usb_bus_type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usb_bus_nb</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
                <span class="k">goto</span> <span class="n">bus_notifier_failed</span><span class="p">;</span>
        <span class="n">retval</span> <span class="o">=</span> <span class="n">usb_major_init</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
                <span class="k">goto</span> <span class="n">major_init_failed</span><span class="p">;</span>
        <span class="n">retval</span> <span class="o">=</span> <span class="n">usb_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usbfs_driver</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
                <span class="k">goto</span> <span class="n">driver_register_failed</span><span class="p">;</span>
        <span class="n">retval</span> <span class="o">=</span> <span class="n">usb_devio_init</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
                <span class="k">goto</span> <span class="n">usb_devio_init_failed</span><span class="p">;</span>
        <span class="n">retval</span> <span class="o">=</span> <span class="n">usb_hub_init</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
                <span class="k">goto</span> <span class="n">hub_init_failed</span><span class="p">;</span>
        <span class="n">retval</span> <span class="o">=</span> <span class="n">usb_register_device_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usb_generic_driver</span><span class="p">,</span> <span class="n">THIS_MODULE</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">retval</span><span class="p">)</span>
                <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

        <span class="n">usb_hub_cleanup</span><span class="p">();</span>
<span class="nl">hub_init_failed:</span>
        <span class="n">usb_devio_cleanup</span><span class="p">();</span>
<span class="nl">usb_devio_init_failed:</span>
        <span class="n">usb_deregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usbfs_driver</span><span class="p">);</span>
<span class="nl">driver_register_failed:</span>
        <span class="n">usb_major_cleanup</span><span class="p">();</span>
<span class="nl">major_init_failed:</span>
        <span class="n">bus_unregister_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usb_bus_type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usb_bus_nb</span><span class="p">);</span>
<span class="nl">bus_notifier_failed:</span>
        <span class="n">bus_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usb_bus_type</span><span class="p">);</span>
<span class="nl">bus_register_failed:</span>
        <span class="n">usb_acpi_unregister</span><span class="p">();</span>
        <span class="n">usb_debugfs_cleanup</span><span class="p">();</span>
<span class="nl">out:</span>
        <span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define subsys_initcall(fn)             __define_initcall(fn, 4)
</span><span class="n">subsys_initcall</span><span class="p">(</span><span class="n">usb_init</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="usb-bus-registration"><span class="me-2">Usb bus registration</span><a href="#usb-bus-registration" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>Based on the previous postings,
we can know that a bus_type object 
representing a specific bus sub-system
should be initialized and registered
by invoking bus_register function. 
Let’s take a look at which field of bus_type 
has been statically provided by the usb core first.</p>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="k">struct</span> <span class="n">bus_type</span> <span class="n">usb_bus_type</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">.</span><span class="n">name</span> <span class="o">=</span>         <span class="s">"usb"</span><span class="p">,</span>
        <span class="p">.</span><span class="n">match</span> <span class="o">=</span>        <span class="n">usb_device_match</span><span class="p">,</span>
        <span class="p">.</span><span class="n">uevent</span> <span class="o">=</span>       <span class="n">usb_uevent</span><span class="p">,</span>
        <span class="p">.</span><span class="n">need_parent_lock</span> <span class="o">=</span>     <span class="nb">true</span><span class="p">,</span>
<span class="p">};</span>
</pre></td></tr></tbody></table></code></div></div>
<p>Compared to the bus_type object used for the platform bus,
usb bus_type object provides only handful of information.
Note that even the probe function has not been provided.</p>

<h3 id="registering-notifier-block-for-usb-bus"><span class="me-2">Registering notifier block for usb bus</span><a href="#registering-notifier-block-for-usb-bus" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>We doesn’t utilize the notifier block for the platform bus, 
but usb bus utilize the notifier block.
The bus_register_notifier set the usb_bus_nb notifier block 
to the initialized usb bus.</p>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre></td><td class="rouge-code"><pre><span class="k">static</span> <span class="k">struct</span> <span class="n">notifier_block</span> <span class="n">usb_bus_nb</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">.</span><span class="n">notifier_call</span> <span class="o">=</span> <span class="n">usb_bus_notify</span><span class="p">,</span>
<span class="p">};</span>   

<span class="cm">/*
 * Notifications of device and interface registration
 */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">usb_bus_notify</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">nb</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">action</span><span class="p">,</span>
                <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

        <span class="k">switch</span> <span class="p">(</span><span class="n">action</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">case</span> <span class="n">BUS_NOTIFY_ADD_DEVICE</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">usb_device_type</span><span class="p">)</span>
                        <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">usb_create_sysfs_dev_files</span><span class="p">(</span><span class="n">to_usb_device</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
                <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">usb_if_device_type</span><span class="p">)</span>
                        <span class="n">usb_create_sysfs_intf_files</span><span class="p">(</span><span class="n">to_usb_interface</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
                <span class="k">break</span><span class="p">;</span>

        <span class="k">case</span> <span class="n">BUS_NOTIFY_DEL_DEVICE</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">usb_device_type</span><span class="p">)</span>
                        <span class="n">usb_remove_sysfs_dev_files</span><span class="p">(</span><span class="n">to_usb_device</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
                <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">usb_if_device_type</span><span class="p">)</span>
                        <span class="n">usb_remove_sysfs_intf_files</span><span class="p">(</span><span class="n">to_usb_interface</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
                <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>  
</pre></td></tr></tbody></table></code></div></div>
<p>When the notification is sent, the above usb_bus_notify function will be invoked 
with the action parameter.
Based on the action, 
it hanldes usb device management on the sysfs.</p>

<h3 id="register-usb-filesystem-driver-usbfs"><span class="me-2">Register usb filesystem driver, usbfs</span><a href="#register-usb-filesystem-driver-usbfs" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
</pre></td><td class="rouge-code"><pre><span class="k">struct</span> <span class="n">usb_driver</span> <span class="n">usbfs_driver</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">.</span><span class="n">name</span> <span class="o">=</span>         <span class="s">"usbfs"</span><span class="p">,</span>
        <span class="p">.</span><span class="n">probe</span> <span class="o">=</span>        <span class="n">driver_probe</span><span class="p">,</span>
        <span class="p">.</span><span class="n">disconnect</span> <span class="o">=</span>   <span class="n">driver_disconnect</span><span class="p">,</span>
        <span class="p">.</span><span class="n">suspend</span> <span class="o">=</span>      <span class="n">driver_suspend</span><span class="p">,</span>
        <span class="p">.</span><span class="n">resume</span> <span class="o">=</span>       <span class="n">driver_resume</span><span class="p">,</span>
        <span class="p">.</span><span class="n">supports_autosuspend</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>      

<span class="cp">#define usb_register(driver) \
        usb_register_driver(driver, THIS_MODULE, KBUILD_MODNAME)
</span>
<span class="cm">/**
 * usb_register_driver - register a USB interface driver
 * @new_driver: USB operations for the interface driver
 * @owner: module owner of this driver.
 * @mod_name: module name string
 *
 * Registers a USB interface driver with the USB core.  The list of
 * unattached interfaces will be rescanned whenever a new driver is
 * added, allowing the new driver to attach to any recognized interfaces.
 *
 * Return: A negative error code on failure and 0 on success.
 *
 * NOTE: if you want your driver to use the USB major number, you must call
 * usb_register_dev() to enable that functionality.  This function no longer
 * takes care of that.
 */</span>
<span class="kt">int</span> <span class="nf">usb_register_driver</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_driver</span> <span class="o">*</span><span class="n">new_driver</span><span class="p">,</span> <span class="k">struct</span> <span class="n">module</span> <span class="o">*</span><span class="n">owner</span><span class="p">,</span>
                        <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">mod_name</span><span class="p">)</span>
<span class="p">{</span>       
        <span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="n">usb_disabled</span><span class="p">())</span>
                <span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

        <span class="n">new_driver</span><span class="o">-&gt;</span><span class="n">drvwrap</span><span class="p">.</span><span class="n">for_devices</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">new_driver</span><span class="o">-&gt;</span><span class="n">drvwrap</span><span class="p">.</span><span class="n">driver</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">new_driver</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
        <span class="n">new_driver</span><span class="o">-&gt;</span><span class="n">drvwrap</span><span class="p">.</span><span class="n">driver</span><span class="p">.</span><span class="n">bus</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">usb_bus_type</span><span class="p">;</span>
        <span class="n">new_driver</span><span class="o">-&gt;</span><span class="n">drvwrap</span><span class="p">.</span><span class="n">driver</span><span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">usb_probe_interface</span><span class="p">;</span>
        <span class="n">new_driver</span><span class="o">-&gt;</span><span class="n">drvwrap</span><span class="p">.</span><span class="n">driver</span><span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">usb_unbind_interface</span><span class="p">;</span>
        <span class="n">new_driver</span><span class="o">-&gt;</span><span class="n">drvwrap</span><span class="p">.</span><span class="n">driver</span><span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">owner</span><span class="p">;</span>
        <span class="n">new_driver</span><span class="o">-&gt;</span><span class="n">drvwrap</span><span class="p">.</span><span class="n">driver</span><span class="p">.</span><span class="n">mod_name</span> <span class="o">=</span> <span class="n">mod_name</span><span class="p">;</span>
        <span class="n">new_driver</span><span class="o">-&gt;</span><span class="n">drvwrap</span><span class="p">.</span><span class="n">driver</span><span class="p">.</span><span class="n">dev_groups</span> <span class="o">=</span> <span class="n">new_driver</span><span class="o">-&gt;</span><span class="n">dev_groups</span><span class="p">;</span>
        <span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_driver</span><span class="o">-&gt;</span><span class="n">dynids</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
        <span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_driver</span><span class="o">-&gt;</span><span class="n">dynids</span><span class="p">.</span><span class="n">list</span><span class="p">);</span>
 
        <span class="n">retval</span> <span class="o">=</span> <span class="n">driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_driver</span><span class="o">-&gt;</span><span class="n">drvwrap</span><span class="p">.</span><span class="n">driver</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
                <span class="k">goto</span> <span class="n">out</span><span class="p">;</span> 
 
        <span class="n">retval</span> <span class="o">=</span> <span class="n">usb_create_newid_files</span><span class="p">(</span><span class="n">new_driver</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
                <span class="k">goto</span> <span class="n">out_newid</span><span class="p">;</span>
        
        <span class="n">pr_info</span><span class="p">(</span><span class="s">"%s: registered new interface driver %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
                        <span class="n">usbcore_name</span><span class="p">,</span> <span class="n">new_driver</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
        
<span class="nl">out:</span>    
        <span class="k">return</span> <span class="n">retval</span><span class="p">;</span>

<span class="nl">out_newid:</span>
        <span class="n">driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_driver</span><span class="o">-&gt;</span><span class="n">drvwrap</span><span class="p">.</span><span class="n">driver</span><span class="p">);</span>
 
        <span class="n">pr_err</span><span class="p">(</span><span class="s">"%s: error %d registering interface driver %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
                <span class="n">usbcore_name</span><span class="p">,</span> <span class="n">retval</span><span class="p">,</span> <span class="n">new_driver</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
        <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>usb_register macro invokes usb_register_driver 
which register the usb related driver to the usb bus.</p>

<h3 id="initializing-usb-devio"><span class="me-2">Initializing usb devio</span><a href="#initializing-usb-devio" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
</pre></td><td class="rouge-code"><pre><span class="k">static</span> <span class="k">struct</span> <span class="n">cdev</span> <span class="n">usb_device_cdev</span><span class="p">;</span>
        
<span class="kt">int</span> <span class="n">__init</span> <span class="nf">usb_devio_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>               
        <span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
        
        <span class="n">retval</span> <span class="o">=</span> <span class="n">register_chrdev_region</span><span class="p">(</span><span class="n">USB_DEVICE_DEV</span><span class="p">,</span> <span class="n">USB_DEVICE_MAX</span><span class="p">,</span>
                                        <span class="s">"usb_device"</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">"Unable to register minors for usb_device</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
                <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">cdev_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usb_device_cdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usbdev_file_operations</span><span class="p">);</span>
        <span class="n">retval</span> <span class="o">=</span> <span class="n">cdev_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usb_device_cdev</span><span class="p">,</span> <span class="n">USB_DEVICE_DEV</span><span class="p">,</span> <span class="n">USB_DEVICE_MAX</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">"Unable to get usb_device major %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
                       <span class="n">USB_DEVICE_MAJOR</span><span class="p">);</span>
                <span class="k">goto</span> <span class="n">error_cdev</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">usb_register_notify</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usbdev_nb</span><span class="p">);</span>
<span class="nl">out:</span>    
        <span class="k">return</span> <span class="n">retval</span><span class="p">;</span>

<span class="nl">error_cdev:</span>
        <span class="n">unregister_chrdev_region</span><span class="p">(</span><span class="n">USB_DEVICE_DEV</span><span class="p">,</span> <span class="n">USB_DEVICE_MAX</span><span class="p">);</span>
        <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">usbdev_file_operations</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">.</span><span class="n">owner</span> <span class="o">=</span>          <span class="n">THIS_MODULE</span><span class="p">,</span>
        <span class="p">.</span><span class="n">llseek</span> <span class="o">=</span>         <span class="n">no_seek_end_llseek</span><span class="p">,</span>
        <span class="p">.</span><span class="n">read</span> <span class="o">=</span>           <span class="n">usbdev_read</span><span class="p">,</span>
        <span class="p">.</span><span class="n">poll</span> <span class="o">=</span>           <span class="n">usbdev_poll</span><span class="p">,</span>
        <span class="p">.</span><span class="n">unlocked_ioctl</span> <span class="o">=</span> <span class="n">usbdev_ioctl</span><span class="p">,</span>
        <span class="p">.</span><span class="n">compat_ioctl</span> <span class="o">=</span>   <span class="n">compat_ptr_ioctl</span><span class="p">,</span>
        <span class="p">.</span><span class="n">mmap</span> <span class="o">=</span>           <span class="n">usbdev_mmap</span><span class="p">,</span>
        <span class="p">.</span><span class="n">open</span> <span class="o">=</span>           <span class="n">usbdev_open</span><span class="p">,</span>
        <span class="p">.</span><span class="n">release</span> <span class="o">=</span>        <span class="n">usbdev_release</span><span class="p">,</span>      
<span class="p">};</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">usbdev_notify</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span>
                               <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">action</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>               
        <span class="k">switch</span> <span class="p">(</span><span class="n">action</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">case</span> <span class="n">USB_DEVICE_ADD</span><span class="p">:</span>
                <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="n">USB_DEVICE_REMOVE</span><span class="p">:</span>
                <span class="n">usbdev_remove</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">NOTIFY_OK</span><span class="p">;</span>
<span class="p">}</span>               
        
<span class="k">static</span> <span class="k">struct</span> <span class="n">notifier_block</span> <span class="n">usbdev_nb</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">.</span><span class="n">notifier_call</span> <span class="o">=</span>        <span class="n">usbdev_notify</span><span class="p">,</span>
<span class="p">};</span>      

</pre></td></tr></tbody></table></code></div></div>
<p>The first thing done by the usb devio initialization is 
initializing and creating the character device for usb devices.
Compared to platform devices,
usb devices provides interfaces to the user programs
so that the user can directly communicate with the 
device files of the usb devices. 
The usb_dev_file_operations provides 
file operations related callback functions for that purpose. 
XXX: how the other devices are accessed ? does it through the devio??????</p>

<h3 id="registering-usb-hub-device-driver"><span class="me-2">Registering usb hub device driver</span><a href="#registering-usb-hub-device-driver" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
</pre></td><td class="rouge-code"><pre><span class="kt">int</span> <span class="nf">usb_hub_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>       
        <span class="k">if</span> <span class="p">(</span><span class="n">usb_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hub_driver</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">"%s: can't register hub driver</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
                        <span class="n">usbcore_name</span><span class="p">);</span>
                <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
        
        <span class="cm">/*      
         * The workqueue needs to be freezable to avoid interfering with
         * USB-PERSIST port handover. Otherwise it might see that a full-speed
         * device was gone before the EHCI controller had handed its port
         * over to the companion full-speed controller.
         */</span>
        <span class="n">hub_wq</span> <span class="o">=</span> <span class="n">alloc_workqueue</span><span class="p">(</span><span class="s">"usb_hub_wq"</span><span class="p">,</span> <span class="n">WQ_FREEZABLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">hub_wq</span><span class="p">)</span>
                <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

        <span class="cm">/* Fall through if kernel_thread failed */</span>
        <span class="n">usb_deregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hub_driver</span><span class="p">);</span>
        <span class="n">pr_err</span><span class="p">(</span><span class="s">"%s: can't allocate workqueue for usb hub</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">usbcore_name</span><span class="p">);</span>

        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>  
        
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">usb</span><span class="p">,</span> <span class="n">hub_id_table</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_driver</span> <span class="n">hub_driver</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">.</span><span class="n">name</span> <span class="o">=</span>         <span class="s">"hub"</span><span class="p">,</span>
        <span class="p">.</span><span class="n">probe</span> <span class="o">=</span>        <span class="n">hub_probe</span><span class="p">,</span>
        <span class="p">.</span><span class="n">disconnect</span> <span class="o">=</span>   <span class="n">hub_disconnect</span><span class="p">,</span>
        <span class="p">.</span><span class="n">suspend</span> <span class="o">=</span>      <span class="n">hub_suspend</span><span class="p">,</span>
        <span class="p">.</span><span class="n">resume</span> <span class="o">=</span>       <span class="n">hub_resume</span><span class="p">,</span>
        <span class="p">.</span><span class="n">reset_resume</span> <span class="o">=</span> <span class="n">hub_reset_resume</span><span class="p">,</span>
        <span class="p">.</span><span class="n">pre_reset</span> <span class="o">=</span>    <span class="n">hub_pre_reset</span><span class="p">,</span>
        <span class="p">.</span><span class="n">post_reset</span> <span class="o">=</span>   <span class="n">hub_post_reset</span><span class="p">,</span>
        <span class="p">.</span><span class="n">unlocked_ioctl</span> <span class="o">=</span> <span class="n">hub_ioctl</span><span class="p">,</span>
        <span class="p">.</span><span class="n">id_table</span> <span class="o">=</span>     <span class="n">hub_id_table</span><span class="p">,</span>
        <span class="p">.</span><span class="n">supports_autosuspend</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>      
                
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="n">hub_id_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">{</span> <span class="p">.</span><span class="n">match_flags</span> <span class="o">=</span> <span class="n">USB_DEVICE_ID_MATCH_VENDOR</span>
                   <span class="o">|</span> <span class="n">USB_DEVICE_ID_MATCH_PRODUCT</span>
                   <span class="o">|</span> <span class="n">USB_DEVICE_ID_MATCH_INT_CLASS</span><span class="p">,</span>
      <span class="p">.</span><span class="n">idVendor</span> <span class="o">=</span> <span class="n">USB_VENDOR_SMSC</span><span class="p">,</span>
      <span class="p">.</span><span class="n">idProduct</span> <span class="o">=</span> <span class="n">USB_PRODUCT_USB5534B</span><span class="p">,</span>
      <span class="p">.</span><span class="n">bInterfaceClass</span> <span class="o">=</span> <span class="n">USB_CLASS_HUB</span><span class="p">,</span>
      <span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">HUB_QUIRK_DISABLE_AUTOSUSPEND</span><span class="p">},</span>
    <span class="p">{</span> <span class="p">.</span><span class="n">match_flags</span> <span class="o">=</span> <span class="n">USB_DEVICE_ID_MATCH_VENDOR</span>
                        <span class="o">|</span> <span class="n">USB_DEVICE_ID_MATCH_INT_CLASS</span><span class="p">,</span>
      <span class="p">.</span><span class="n">idVendor</span> <span class="o">=</span> <span class="n">USB_VENDOR_GENESYS_LOGIC</span><span class="p">,</span>
      <span class="p">.</span><span class="n">bInterfaceClass</span> <span class="o">=</span> <span class="n">USB_CLASS_HUB</span><span class="p">,</span>
      <span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">HUB_QUIRK_CHECK_PORT_AUTOSUSPEND</span><span class="p">},</span>
    <span class="p">{</span> <span class="p">.</span><span class="n">match_flags</span> <span class="o">=</span> <span class="n">USB_DEVICE_ID_MATCH_DEV_CLASS</span><span class="p">,</span>
      <span class="p">.</span><span class="n">bDeviceClass</span> <span class="o">=</span> <span class="n">USB_CLASS_HUB</span><span class="p">},</span>
    <span class="p">{</span> <span class="p">.</span><span class="n">match_flags</span> <span class="o">=</span> <span class="n">USB_DEVICE_ID_MATCH_INT_CLASS</span><span class="p">,</span>
      <span class="p">.</span><span class="n">bInterfaceClass</span> <span class="o">=</span> <span class="n">USB_CLASS_HUB</span><span class="p">},</span> 
    <span class="p">{</span> <span class="p">}</span>                                         <span class="cm">/* Terminating entry */</span>
<span class="p">};</span>      
</pre></td></tr></tbody></table></code></div></div>

<h3 id="registering-hub_event-thread"><span class="me-2">Registering hub_event thread</span><a href="#registering-hub_event-thread" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
</pre></td><td class="rouge-code"><pre><span class="k">static</span> <span class="kt">int</span> <span class="nf">hub_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_host_interface</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">hdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_hub</span> <span class="o">*</span><span class="n">hub</span><span class="p">;</span>

	<span class="n">desc</span> <span class="o">=</span> <span class="n">intf</span><span class="o">-&gt;</span><span class="n">cur_altsetting</span><span class="p">;</span>
	<span class="n">hdev</span> <span class="o">=</span> <span class="n">interface_to_usbdev</span><span class="p">(</span><span class="n">intf</span><span class="p">);</span>

	<span class="cm">/*
	 * Set default autosuspend delay as 0 to speedup bus suspend,
	 * based on the below considerations:
	 *
	 * - Unlike other drivers, the hub driver does not rely on the
	 *   autosuspend delay to provide enough time to handle a wakeup
	 *   event, and the submitted status URB is just to check future
	 *   change on hub downstream ports, so it is safe to do it.
	 *
	 * - The patch might cause one or more auto supend/resume for
	 *   below very rare devices when they are plugged into hub
	 *   first time:
	 *
	 *   	devices having trouble initializing, and disconnect
	 *   	themselves from the bus and then reconnect a second
	 *   	or so later
	 *
	 *   	devices just for downloading firmware, and disconnects
	 *   	themselves after completing it
	 *
	 *   For these quite rare devices, their drivers may change the
	 *   autosuspend delay of their parent hub in the probe() to one
	 *   appropriate value to avoid the subtle problem if someone
	 *   does care it.
	 *
	 * - The patch may cause one or more auto suspend/resume on
	 *   hub during running 'lsusb', but it is probably too
	 *   infrequent to worry about.
	 *
	 * - Change autosuspend delay of hub can avoid unnecessary auto
	 *   suspend timer for hub, also may decrease power consumption
	 *   of USB bus.
	 *
	 * - If user has indicated to prevent autosuspend by passing
	 *   usbcore.autosuspend = -1 then keep autosuspend disabled.
	 */</span>
<span class="cp">#ifdef CONFIG_PM
</span>	<span class="k">if</span> <span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">power</span><span class="p">.</span><span class="n">autosuspend_delay</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">pm_runtime_set_autosuspend_delay</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="cp">#endif
</span>
	<span class="cm">/*
	 * Hubs have proper suspend/resume support, except for root hubs
	 * where the controller driver doesn't have bus_suspend and
	 * bus_resume methods.
	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">)</span> <span class="p">{</span>		<span class="cm">/* normal device */</span>
		<span class="n">usb_enable_autosuspend</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>			<span class="cm">/* root hub */</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">hc_driver</span> <span class="o">*</span><span class="n">drv</span> <span class="o">=</span> <span class="n">bus_to_hcd</span><span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">drv</span><span class="o">-&gt;</span><span class="n">bus_suspend</span> <span class="o">&amp;&amp;</span> <span class="n">drv</span><span class="o">-&gt;</span><span class="n">bus_resume</span><span class="p">)</span>
			<span class="n">usb_enable_autosuspend</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">==</span> <span class="n">MAX_TOPO_LEVEL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">"Unsupported bus topology: hub nested too deep</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">E2BIG</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef	CONFIG_USB_OTG_DISABLE_EXTERNAL_HUB
</span>	<span class="k">if</span> <span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">"ignoring external hub</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif
</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hub_descriptor_is_sane</span><span class="p">(</span><span class="n">desc</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">"bad descriptor, ignoring hub</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* We found a hub */</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">"USB hub found</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>

	<span class="n">hub</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">hub</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hub</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">kref_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hub</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">);</span>
	<span class="n">hub</span><span class="o">-&gt;</span><span class="n">intfdev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">hub</span><span class="o">-&gt;</span><span class="n">hdev</span> <span class="o">=</span> <span class="n">hdev</span><span class="p">;</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hub</span><span class="o">-&gt;</span><span class="n">leds</span><span class="p">,</span> <span class="n">led_work</span><span class="p">);</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hub</span><span class="o">-&gt;</span><span class="n">init_work</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hub</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">,</span> <span class="n">hub_event</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hub</span><span class="o">-&gt;</span><span class="n">irq_urb_lock</span><span class="p">);</span>
	<span class="n">timer_setup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hub</span><span class="o">-&gt;</span><span class="n">irq_urb_retry</span><span class="p">,</span> <span class="n">hub_retry_irq_urb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">usb_get_intf</span><span class="p">(</span><span class="n">intf</span><span class="p">);</span>
	<span class="n">usb_get_dev</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>

	<span class="n">usb_set_intfdata</span><span class="p">(</span><span class="n">intf</span><span class="p">,</span> <span class="n">hub</span><span class="p">);</span>
	<span class="n">intf</span><span class="o">-&gt;</span><span class="n">needs_remote_wakeup</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">pm_suspend_ignore_children</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">==</span> <span class="n">USB_SPEED_HIGH</span><span class="p">)</span>
		<span class="n">highspeed_hubs</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">driver_info</span> <span class="o">&amp;</span> <span class="n">HUB_QUIRK_CHECK_PORT_AUTOSUSPEND</span><span class="p">)</span>
		<span class="n">hub</span><span class="o">-&gt;</span><span class="n">quirk_check_port_auto_suspend</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">driver_info</span> <span class="o">&amp;</span> <span class="n">HUB_QUIRK_DISABLE_AUTOSUSPEND</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hub</span><span class="o">-&gt;</span><span class="n">quirk_disable_autosuspend</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">usb_autopm_get_interface_no_resume</span><span class="p">(</span><span class="n">intf</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hub_configure</span><span class="p">(</span><span class="n">hub</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">desc</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">hub_disconnect</span><span class="p">(</span><span class="n">intf</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
</pre></td><td class="rouge-code"><pre><span class="mi">5362</span> <span class="k">static</span> <span class="kt">void</span> <span class="n">hub_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="mi">5363</span> <span class="p">{</span>
<span class="mi">5364</span>         <span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">hdev</span><span class="p">;</span>
<span class="mi">5365</span>         <span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">;</span>
<span class="mi">5366</span>         <span class="k">struct</span> <span class="n">usb_hub</span> <span class="o">*</span><span class="n">hub</span><span class="p">;</span>
<span class="mi">5367</span>         <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">hub_dev</span><span class="p">;</span>
<span class="mi">5368</span>         <span class="n">u16</span> <span class="n">hubstatus</span><span class="p">;</span>
<span class="mi">5369</span>         <span class="n">u16</span> <span class="n">hubchange</span><span class="p">;</span>
<span class="mi">5370</span>         <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>
<span class="mi">5371</span> 
<span class="mi">5372</span>         <span class="n">hub</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_hub</span><span class="p">,</span> <span class="n">events</span><span class="p">);</span>
<span class="mi">5373</span>         <span class="n">hdev</span> <span class="o">=</span> <span class="n">hub</span><span class="o">-&gt;</span><span class="n">hdev</span><span class="p">;</span>
<span class="mi">5374</span>         <span class="n">hub_dev</span> <span class="o">=</span> <span class="n">hub</span><span class="o">-&gt;</span><span class="n">intfdev</span><span class="p">;</span>
<span class="mi">5375</span>         <span class="n">intf</span> <span class="o">=</span> <span class="n">to_usb_interface</span><span class="p">(</span><span class="n">hub_dev</span><span class="p">);</span>
<span class="mi">5376</span> 
<span class="mi">5377</span>         <span class="n">dev_dbg</span><span class="p">(</span><span class="n">hub_dev</span><span class="p">,</span> <span class="s">"state %d ports %d chg %04x evt %04x</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
<span class="mi">5378</span>                         <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">maxchild</span><span class="p">,</span>
<span class="mi">5379</span>                         <span class="cm">/* NOTE: expects max 15 ports... */</span>
<span class="mi">5380</span>                         <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">hub</span><span class="o">-&gt;</span><span class="n">change_bits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
<span class="mi">5381</span>                         <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">hub</span><span class="o">-&gt;</span><span class="n">event_bits</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="mi">5382</span> 
<span class="mi">5383</span>         <span class="cm">/* Lock the device, then check to see if we were
5384          * disconnected while waiting for the lock to succeed. */</span>
<span class="mi">5385</span>         <span class="n">usb_lock_device</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
<span class="mi">5386</span>         <span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">hub</span><span class="o">-&gt;</span><span class="n">disconnected</span><span class="p">))</span>
<span class="mi">5387</span>                 <span class="k">goto</span> <span class="n">out_hdev_lock</span><span class="p">;</span>
<span class="mi">5388</span> 
<span class="mi">5389</span>         <span class="cm">/* If the hub has died, clean up after it */</span>
<span class="mi">5390</span>         <span class="k">if</span> <span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">USB_STATE_NOTATTACHED</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">5391</span>                 <span class="n">hub</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="mi">5392</span>                 <span class="n">hub_quiesce</span><span class="p">(</span><span class="n">hub</span><span class="p">,</span> <span class="n">HUB_DISCONNECT</span><span class="p">);</span>
<span class="mi">5393</span>                 <span class="k">goto</span> <span class="n">out_hdev_lock</span><span class="p">;</span>
<span class="mi">5394</span>         <span class="p">}</span>
<span class="mi">5395</span> 
<span class="mi">5396</span>         <span class="cm">/* Autoresume */</span>
<span class="mi">5397</span>         <span class="n">ret</span> <span class="o">=</span> <span class="n">usb_autopm_get_interface</span><span class="p">(</span><span class="n">intf</span><span class="p">);</span>
<span class="mi">5398</span>         <span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">5399</span>                 <span class="n">dev_dbg</span><span class="p">(</span><span class="n">hub_dev</span><span class="p">,</span> <span class="s">"Can't autoresume: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
<span class="mi">5400</span>                 <span class="k">goto</span> <span class="n">out_hdev_lock</span><span class="p">;</span>
<span class="mi">5401</span>         <span class="p">}</span>
<span class="mi">5402</span> 
<span class="mi">5403</span>         <span class="cm">/* If this is an inactive hub, do nothing */</span>
<span class="mi">5404</span>         <span class="k">if</span> <span class="p">(</span><span class="n">hub</span><span class="o">-&gt;</span><span class="n">quiescing</span><span class="p">)</span>
<span class="mi">5405</span>                 <span class="k">goto</span> <span class="n">out_autopm</span><span class="p">;</span>
<span class="mi">5406</span> 
<span class="mi">5407</span>         <span class="k">if</span> <span class="p">(</span><span class="n">hub</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">5408</span>                 <span class="n">dev_dbg</span><span class="p">(</span><span class="n">hub_dev</span><span class="p">,</span> <span class="s">"resetting for error %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">hub</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">);</span>
<span class="mi">5409</span> 
<span class="mi">5410</span>                 <span class="n">ret</span> <span class="o">=</span> <span class="n">usb_reset_device</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
<span class="mi">5411</span>                 <span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">5412</span>                         <span class="n">dev_dbg</span><span class="p">(</span><span class="n">hub_dev</span><span class="p">,</span> <span class="s">"error resetting hub: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
<span class="mi">5413</span>                         <span class="k">goto</span> <span class="n">out_autopm</span><span class="p">;</span>
<span class="mi">5414</span>                 <span class="p">}</span>
<span class="mi">5415</span> 
<span class="mi">5416</span>                 <span class="n">hub</span><span class="o">-&gt;</span><span class="n">nerrors</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="mi">5417</span>                 <span class="n">hub</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="mi">5418</span>         <span class="p">}</span>
<span class="mi">5419</span> 
<span class="mi">5420</span>         <span class="cm">/* deal with port status changes */</span>
<span class="mi">5421</span>         <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">maxchild</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">5422</span>                 <span class="k">struct</span> <span class="n">usb_port</span> <span class="o">*</span><span class="n">port_dev</span> <span class="o">=</span> <span class="n">hub</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
<span class="mi">5423</span> 
<span class="mi">5424</span>                 <span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">hub</span><span class="o">-&gt;</span><span class="n">event_bits</span><span class="p">)</span>
<span class="mi">5425</span>                                 <span class="o">||</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">hub</span><span class="o">-&gt;</span><span class="n">change_bits</span><span class="p">)</span>
<span class="mi">5426</span>                                 <span class="o">||</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">hub</span><span class="o">-&gt;</span><span class="n">wakeup_bits</span><span class="p">))</span> <span class="p">{</span>
<span class="mi">5427</span>                         <span class="cm">/*
5428                          * The get_noresume and barrier ensure that if
5429                          * the port was in the process of resuming, we
5430                          * flush that work and keep the port active for
5431                          * the duration of the port_event().  However,
5432                          * if the port is runtime pm suspended
5433                          * (powered-off), we leave it in that state, run
5434                          * an abbreviated port_event(), and move on.
5435                          */</span>
<span class="mi">5436</span>                         <span class="n">pm_runtime_get_noresume</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="mi">5437</span>                         <span class="n">pm_runtime_barrier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="mi">5438</span>                         <span class="n">usb_lock_port</span><span class="p">(</span><span class="n">port_dev</span><span class="p">);</span>
<span class="mi">5439</span>                         <span class="n">port_event</span><span class="p">(</span><span class="n">hub</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
<span class="mi">5440</span>                         <span class="n">usb_unlock_port</span><span class="p">(</span><span class="n">port_dev</span><span class="p">);</span>
<span class="mi">5441</span>                         <span class="n">pm_runtime_put_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="mi">5442</span>                 <span class="p">}</span>
<span class="mi">5443</span>         <span class="p">}</span>
<span class="mi">5444</span> 
<span class="mi">5445</span>         <span class="cm">/* deal with hub status changes */</span>
<span class="mi">5446</span>         <span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">hub</span><span class="o">-&gt;</span><span class="n">event_bits</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<span class="mi">5447</span>                 <span class="p">;</span>       <span class="cm">/* do nothing */</span>
<span class="mi">5448</span>         <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">hub_hub_status</span><span class="p">(</span><span class="n">hub</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hubstatus</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hubchange</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
<span class="mi">5449</span>                 <span class="n">dev_err</span><span class="p">(</span><span class="n">hub_dev</span><span class="p">,</span> <span class="s">"get_hub_status failed</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="mi">5450</span>         <span class="k">else</span> <span class="p">{</span>
<span class="mi">5451</span>                 <span class="k">if</span> <span class="p">(</span><span class="n">hubchange</span> <span class="o">&amp;</span> <span class="n">HUB_CHANGE_LOCAL_POWER</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">5452</span>                         <span class="n">dev_dbg</span><span class="p">(</span><span class="n">hub_dev</span><span class="p">,</span> <span class="s">"power change</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="mi">5453</span>                         <span class="n">clear_hub_feature</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">C_HUB_LOCAL_POWER</span><span class="p">);</span>
<span class="mi">5454</span>                         <span class="k">if</span> <span class="p">(</span><span class="n">hubstatus</span> <span class="o">&amp;</span> <span class="n">HUB_STATUS_LOCAL_POWER</span><span class="p">)</span>
<span class="mi">5455</span>                                 <span class="cm">/* FIXME: Is this always true? */</span>
<span class="mi">5456</span>                                 <span class="n">hub</span><span class="o">-&gt;</span><span class="n">limited_power</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="mi">5457</span>                         <span class="k">else</span>
<span class="mi">5458</span>                                 <span class="n">hub</span><span class="o">-&gt;</span><span class="n">limited_power</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="mi">5459</span>                 <span class="p">}</span>
<span class="mi">5460</span>                 <span class="k">if</span> <span class="p">(</span><span class="n">hubchange</span> <span class="o">&amp;</span> <span class="n">HUB_CHANGE_OVERCURRENT</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">5461</span>                         <span class="n">u16</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="mi">5462</span>                         <span class="n">u16</span> <span class="n">unused</span><span class="p">;</span>
<span class="mi">5463</span> 
<span class="mi">5464</span>                         <span class="n">dev_dbg</span><span class="p">(</span><span class="n">hub_dev</span><span class="p">,</span> <span class="s">"over-current change</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="mi">5465</span>                         <span class="n">clear_hub_feature</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">C_HUB_OVER_CURRENT</span><span class="p">);</span>
<span class="mi">5466</span>                         <span class="n">msleep</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>    <span class="cm">/* Cool down */</span>
<span class="mi">5467</span>                         <span class="n">hub_power_on</span><span class="p">(</span><span class="n">hub</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
<span class="mi">5468</span>                         <span class="n">hub_hub_status</span><span class="p">(</span><span class="n">hub</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">unused</span><span class="p">);</span>
<span class="mi">5469</span>                         <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">HUB_STATUS_OVERCURRENT</span><span class="p">)</span>
<span class="mi">5470</span>                                 <span class="n">dev_err</span><span class="p">(</span><span class="n">hub_dev</span><span class="p">,</span> <span class="s">"over-current condition</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="mi">5471</span>                 <span class="p">}</span>
<span class="mi">5472</span>         <span class="p">}</span>
<span class="mi">5473</span> 
<span class="mi">5474</span> <span class="n">out_autopm</span><span class="o">:</span>
<span class="mi">5475</span>         <span class="cm">/* Balance the usb_autopm_get_interface() above */</span>
<span class="mi">5476</span>         <span class="n">usb_autopm_put_interface_no_suspend</span><span class="p">(</span><span class="n">intf</span><span class="p">);</span>
<span class="mi">5477</span> <span class="n">out_hdev_lock</span><span class="o">:</span>
<span class="mi">5478</span>         <span class="n">usb_unlock_device</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
<span class="mi">5479</span> 
<span class="mi">5480</span>         <span class="cm">/* Balance the stuff in kick_hub_wq() and allow autosuspend */</span>
<span class="mi">5481</span>         <span class="n">usb_autopm_put_interface</span><span class="p">(</span><span class="n">intf</span><span class="p">);</span>
<span class="mi">5482</span>         <span class="n">kref_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hub</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">,</span> <span class="n">hub_release</span><span class="p">);</span>
<span class="mi">5483</span> <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
</pre></td><td class="rouge-code"><pre><span class="mi">5254</span> <span class="k">static</span> <span class="kt">void</span> <span class="n">port_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_hub</span> <span class="o">*</span><span class="n">hub</span><span class="p">,</span> <span class="kt">int</span> <span class="n">port1</span><span class="p">)</span>
<span class="mi">5255</span>                 <span class="n">__must_hold</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port_dev</span><span class="o">-&gt;</span><span class="n">status_lock</span><span class="p">)</span>
<span class="mi">5256</span> <span class="p">{</span>
<span class="mi">5257</span>         <span class="kt">int</span> <span class="n">connect_change</span><span class="p">;</span>
<span class="mi">5258</span>         <span class="k">struct</span> <span class="n">usb_port</span> <span class="o">*</span><span class="n">port_dev</span> <span class="o">=</span> <span class="n">hub</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">port1</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
<span class="mi">5259</span>         <span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">udev</span> <span class="o">=</span> <span class="n">port_dev</span><span class="o">-&gt;</span><span class="n">child</span><span class="p">;</span>
<span class="mi">5260</span>         <span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">hdev</span> <span class="o">=</span> <span class="n">hub</span><span class="o">-&gt;</span><span class="n">hdev</span><span class="p">;</span>
<span class="mi">5261</span>         <span class="n">u16</span> <span class="n">portstatus</span><span class="p">,</span> <span class="n">portchange</span><span class="p">;</span>
<span class="mi">5262</span> 
<span class="mi">5263</span>         <span class="n">connect_change</span> <span class="o">=</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">port1</span><span class="p">,</span> <span class="n">hub</span><span class="o">-&gt;</span><span class="n">change_bits</span><span class="p">);</span>
<span class="mi">5264</span>         <span class="n">clear_bit</span><span class="p">(</span><span class="n">port1</span><span class="p">,</span> <span class="n">hub</span><span class="o">-&gt;</span><span class="n">event_bits</span><span class="p">);</span>
<span class="mi">5265</span>         <span class="n">clear_bit</span><span class="p">(</span><span class="n">port1</span><span class="p">,</span> <span class="n">hub</span><span class="o">-&gt;</span><span class="n">wakeup_bits</span><span class="p">);</span>
<span class="mi">5266</span> 
<span class="mi">5267</span>         <span class="k">if</span> <span class="p">(</span><span class="n">hub_port_status</span><span class="p">(</span><span class="n">hub</span><span class="p">,</span> <span class="n">port1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">portstatus</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">portchange</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
<span class="mi">5268</span>                 <span class="k">return</span><span class="p">;</span>
<span class="mi">5269</span> 
<span class="mi">5270</span>         <span class="k">if</span> <span class="p">(</span><span class="n">portchange</span> <span class="o">&amp;</span> <span class="n">USB_PORT_STAT_C_CONNECTION</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">5271</span>                 <span class="n">usb_clear_port_feature</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">port1</span><span class="p">,</span> <span class="n">USB_PORT_FEAT_C_CONNECTION</span><span class="p">);</span>
<span class="mi">5272</span>                 <span class="n">connect_change</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="mi">5273</span>         <span class="p">}</span>
<span class="mi">5274</span> 
<span class="mi">5275</span>         <span class="k">if</span> <span class="p">(</span><span class="n">portchange</span> <span class="o">&amp;</span> <span class="n">USB_PORT_STAT_C_ENABLE</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">5276</span>                 <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">connect_change</span><span class="p">)</span>
<span class="mi">5277</span>                         <span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">"enable change, status %08x</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
<span class="mi">5278</span>                                         <span class="n">portstatus</span><span class="p">);</span>
<span class="mi">5279</span>                 <span class="n">usb_clear_port_feature</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">port1</span><span class="p">,</span> <span class="n">USB_PORT_FEAT_C_ENABLE</span><span class="p">);</span>
<span class="mi">5280</span> 
<span class="mi">5281</span>                 <span class="cm">/*
5282                  * EM interference sometimes causes badly shielded USB devices
5283                  * to be shutdown by the hub, this hack enables them again.
5284                  * Works at least with mouse driver.
5285                  */</span>
<span class="mi">5286</span>                 <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">portstatus</span> <span class="o">&amp;</span> <span class="n">USB_PORT_STAT_ENABLE</span><span class="p">)</span>
<span class="mi">5287</span>                     <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">connect_change</span> <span class="o">&amp;&amp;</span> <span class="n">udev</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">5288</span>                         <span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">"disabled by hub (EMI?), re-enabling...</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="mi">5289</span>                         <span class="n">connect_change</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="mi">5290</span>                 <span class="p">}</span>
<span class="mi">5291</span>         <span class="p">}</span>
<span class="mi">5292</span> 
<span class="mi">5293</span>         <span class="k">if</span> <span class="p">(</span><span class="n">portchange</span> <span class="o">&amp;</span> <span class="n">USB_PORT_STAT_C_OVERCURRENT</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">5294</span>                 <span class="n">u16</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">unused</span><span class="p">;</span>
<span class="mi">5295</span>                 <span class="n">port_dev</span><span class="o">-&gt;</span><span class="n">over_current_count</span><span class="o">++</span><span class="p">;</span>
<span class="mi">5296</span>                 <span class="n">port_over_current_notify</span><span class="p">(</span><span class="n">port_dev</span><span class="p">);</span>
<span class="mi">5297</span> 
<span class="mi">5298</span>                 <span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">"over-current change #%u</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
<span class="mi">5299</span>                         <span class="n">port_dev</span><span class="o">-&gt;</span><span class="n">over_current_count</span><span class="p">);</span>
<span class="mi">5300</span>                 <span class="n">usb_clear_port_feature</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">port1</span><span class="p">,</span>
<span class="mi">5301</span>                                 <span class="n">USB_PORT_FEAT_C_OVER_CURRENT</span><span class="p">);</span>
<span class="mi">5302</span>                 <span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>    <span class="cm">/* Cool down */</span>
<span class="mi">5303</span>                 <span class="n">hub_power_on</span><span class="p">(</span><span class="n">hub</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
<span class="mi">5304</span>                 <span class="n">hub_port_status</span><span class="p">(</span><span class="n">hub</span><span class="p">,</span> <span class="n">port1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">unused</span><span class="p">);</span>
<span class="mi">5305</span>                 <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">USB_PORT_STAT_OVERCURRENT</span><span class="p">)</span>
<span class="mi">5306</span>                         <span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">"over-current condition</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="mi">5307</span>         <span class="p">}</span>
<span class="mi">5308</span> 
<span class="mi">5309</span>         <span class="k">if</span> <span class="p">(</span><span class="n">portchange</span> <span class="o">&amp;</span> <span class="n">USB_PORT_STAT_C_RESET</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">5310</span>                 <span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">"reset change</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="mi">5311</span>                 <span class="n">usb_clear_port_feature</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">port1</span><span class="p">,</span> <span class="n">USB_PORT_FEAT_C_RESET</span><span class="p">);</span>
<span class="mi">5312</span>         <span class="p">}</span>
<span class="mi">5313</span>         <span class="k">if</span> <span class="p">((</span><span class="n">portchange</span> <span class="o">&amp;</span> <span class="n">USB_PORT_STAT_C_BH_RESET</span><span class="p">)</span>
<span class="mi">5314</span>             <span class="o">&amp;&amp;</span> <span class="n">hub_is_superspeed</span><span class="p">(</span><span class="n">hdev</span><span class="p">))</span> <span class="p">{</span>
<span class="mi">5315</span>                 <span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">"warm reset change</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="mi">5316</span>                 <span class="n">usb_clear_port_feature</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">port1</span><span class="p">,</span>
<span class="mi">5317</span>                                 <span class="n">USB_PORT_FEAT_C_BH_PORT_RESET</span><span class="p">);</span>
<span class="mi">5318</span>         <span class="p">}</span>
<span class="mi">5319</span>         <span class="k">if</span> <span class="p">(</span><span class="n">portchange</span> <span class="o">&amp;</span> <span class="n">USB_PORT_STAT_C_LINK_STATE</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">5320</span>                 <span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">"link state change</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="mi">5321</span>                 <span class="n">usb_clear_port_feature</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">port1</span><span class="p">,</span>
<span class="mi">5322</span>                                 <span class="n">USB_PORT_FEAT_C_PORT_LINK_STATE</span><span class="p">);</span>
<span class="mi">5323</span>         <span class="p">}</span>
<span class="mi">5324</span>         <span class="k">if</span> <span class="p">(</span><span class="n">portchange</span> <span class="o">&amp;</span> <span class="n">USB_PORT_STAT_C_CONFIG_ERROR</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">5325</span>                 <span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">"config error</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="mi">5326</span>                 <span class="n">usb_clear_port_feature</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">port1</span><span class="p">,</span>
<span class="mi">5327</span>                                 <span class="n">USB_PORT_FEAT_C_PORT_CONFIG_ERROR</span><span class="p">);</span>
<span class="mi">5328</span>         <span class="p">}</span>
<span class="mi">5329</span> 
<span class="mi">5330</span>         <span class="cm">/* skip port actions that require the port to be powered on */</span>
<span class="mi">5331</span>         <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pm_runtime_active</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span>
<span class="mi">5332</span>                 <span class="k">return</span><span class="p">;</span>
<span class="mi">5333</span> 
<span class="mi">5334</span>         <span class="k">if</span> <span class="p">(</span><span class="n">hub_handle_remote_wakeup</span><span class="p">(</span><span class="n">hub</span><span class="p">,</span> <span class="n">port1</span><span class="p">,</span> <span class="n">portstatus</span><span class="p">,</span> <span class="n">portchange</span><span class="p">))</span>
<span class="mi">5335</span>                 <span class="n">connect_change</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="mi">5336</span> 
<span class="mi">5337</span>         <span class="cm">/*
5338          * Warm reset a USB3 protocol port if it's in
5339          * SS.Inactive state.
5340          */</span>
<span class="mi">5341</span>         <span class="k">if</span> <span class="p">(</span><span class="n">hub_port_warm_reset_required</span><span class="p">(</span><span class="n">hub</span><span class="p">,</span> <span class="n">port1</span><span class="p">,</span> <span class="n">portstatus</span><span class="p">))</span> <span class="p">{</span>
<span class="mi">5342</span>                 <span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">"do warm reset</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="mi">5343</span>                 <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">udev</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">portstatus</span> <span class="o">&amp;</span> <span class="n">USB_PORT_STAT_CONNECTION</span><span class="p">)</span>
<span class="mi">5344</span>                                 <span class="o">||</span> <span class="n">udev</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">USB_STATE_NOTATTACHED</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">5345</span>                         <span class="k">if</span> <span class="p">(</span><span class="n">hub_port_reset</span><span class="p">(</span><span class="n">hub</span><span class="p">,</span> <span class="n">port1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
<span class="mi">5346</span>                                         <span class="n">HUB_BH_RESET_TIME</span><span class="p">,</span> <span class="nb">true</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
<span class="mi">5347</span>                                 <span class="n">hub_port_disable</span><span class="p">(</span><span class="n">hub</span><span class="p">,</span> <span class="n">port1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="mi">5348</span>                 <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="mi">5349</span>                         <span class="n">usb_unlock_port</span><span class="p">(</span><span class="n">port_dev</span><span class="p">);</span>
<span class="mi">5350</span>                         <span class="n">usb_lock_device</span><span class="p">(</span><span class="n">udev</span><span class="p">);</span>
<span class="mi">5351</span>                         <span class="n">usb_reset_device</span><span class="p">(</span><span class="n">udev</span><span class="p">);</span>
<span class="mi">5352</span>                         <span class="n">usb_unlock_device</span><span class="p">(</span><span class="n">udev</span><span class="p">);</span>
<span class="mi">5353</span>                         <span class="n">usb_lock_port</span><span class="p">(</span><span class="n">port_dev</span><span class="p">);</span>
<span class="mi">5354</span>                         <span class="n">connect_change</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="mi">5355</span>                 <span class="p">}</span>
<span class="mi">5356</span>         <span class="p">}</span>
<span class="mi">5357</span> 
<span class="mi">5358</span>         <span class="k">if</span> <span class="p">(</span><span class="n">connect_change</span><span class="p">)</span>
<span class="mi">5359</span>                 <span class="n">hub_port_connect_change</span><span class="p">(</span><span class="n">hub</span><span class="p">,</span> <span class="n">port1</span><span class="p">,</span> <span class="n">portstatus</span><span class="p">,</span> <span class="n">portchange</span><span class="p">);</span>
<span class="mi">5360</span> <span class="p">}</span>

</pre></td></tr></tbody></table></code></div></div>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
</pre></td><td class="rouge-code"><pre><span class="mi">5156</span> <span class="cm">/* Handle physical or logical connection change events.
5157  * This routine is called when:
5158  *      a port connection-change occurs;
5159  *      a port enable-change occurs (often caused by EMI);
5160  *      usb_reset_and_verify_device() encounters changed descriptors (as from
5161  *              a firmware download)
5162  * caller already locked the hub
5163  */</span>
<span class="mi">5164</span> <span class="k">static</span> <span class="kt">void</span> <span class="n">hub_port_connect_change</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_hub</span> <span class="o">*</span><span class="n">hub</span><span class="p">,</span> <span class="kt">int</span> <span class="n">port1</span><span class="p">,</span>
<span class="mi">5165</span>                                         <span class="n">u16</span> <span class="n">portstatus</span><span class="p">,</span> <span class="n">u16</span> <span class="n">portchange</span><span class="p">)</span>
<span class="mi">5166</span>                 <span class="n">__must_hold</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port_dev</span><span class="o">-&gt;</span><span class="n">status_lock</span><span class="p">)</span>
<span class="mi">5167</span> <span class="p">{</span>
<span class="mi">5168</span>         <span class="k">struct</span> <span class="n">usb_port</span> <span class="o">*</span><span class="n">port_dev</span> <span class="o">=</span> <span class="n">hub</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">port1</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
<span class="mi">5169</span>         <span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">udev</span> <span class="o">=</span> <span class="n">port_dev</span><span class="o">-&gt;</span><span class="n">child</span><span class="p">;</span>
<span class="mi">5170</span>         <span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="mi">5171</span> 
<span class="mi">5172</span>         <span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">"status %04x, change %04x, %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">portstatus</span><span class="p">,</span>
<span class="mi">5173</span>                         <span class="n">portchange</span><span class="p">,</span> <span class="n">portspeed</span><span class="p">(</span><span class="n">hub</span><span class="p">,</span> <span class="n">portstatus</span><span class="p">));</span>
<span class="mi">5174</span> 
<span class="mi">5175</span>         <span class="k">if</span> <span class="p">(</span><span class="n">hub</span><span class="o">-&gt;</span><span class="n">has_indicators</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">5176</span>                 <span class="n">set_port_led</span><span class="p">(</span><span class="n">hub</span><span class="p">,</span> <span class="n">port1</span><span class="p">,</span> <span class="n">HUB_LED_AUTO</span><span class="p">);</span>
<span class="mi">5177</span>                 <span class="n">hub</span><span class="o">-&gt;</span><span class="n">indicator</span><span class="p">[</span><span class="n">port1</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">INDICATOR_AUTO</span><span class="p">;</span>
<span class="mi">5178</span>         <span class="p">}</span>
<span class="mi">5179</span> 
<span class="mi">5180</span> <span class="err">#</span><span class="n">ifdef</span>  <span class="n">CONFIG_USB_OTG</span>
<span class="mi">5181</span>         <span class="cm">/* during HNP, don't repeat the debounce */</span>
<span class="mi">5182</span>         <span class="k">if</span> <span class="p">(</span><span class="n">hub</span><span class="o">-&gt;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">is_b_host</span><span class="p">)</span>
<span class="mi">5183</span>                 <span class="n">portchange</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">USB_PORT_STAT_C_CONNECTION</span> <span class="o">|</span>
<span class="mi">5184</span>                                 <span class="n">USB_PORT_STAT_C_ENABLE</span><span class="p">);</span>
<span class="mi">5185</span> <span class="err">#</span><span class="n">endif</span>
<span class="mi">5186</span> 
<span class="mi">5187</span>         <span class="cm">/* Try to resuscitate an existing device */</span>
<span class="mi">5188</span>         <span class="k">if</span> <span class="p">((</span><span class="n">portstatus</span> <span class="o">&amp;</span> <span class="n">USB_PORT_STAT_CONNECTION</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">udev</span> <span class="o">&amp;&amp;</span>
<span class="mi">5189</span>                         <span class="n">udev</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">USB_STATE_NOTATTACHED</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">5190</span>                 <span class="k">if</span> <span class="p">(</span><span class="n">portstatus</span> <span class="o">&amp;</span> <span class="n">USB_PORT_STAT_ENABLE</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">5191</span>                         <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>             <span class="cm">/* Nothing to do */</span>
<span class="mi">5192</span> <span class="err">#</span><span class="n">ifdef</span> <span class="n">CONFIG_PM</span>
<span class="mi">5193</span>                 <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">USB_STATE_SUSPENDED</span> <span class="o">&amp;&amp;</span>
<span class="mi">5194</span>                                 <span class="n">udev</span><span class="o">-&gt;</span><span class="n">persist_enabled</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">5195</span>                         <span class="cm">/* For a suspended device, treat this as a
5196                          * remote wakeup event.
5197                          */</span>
<span class="mi">5198</span>                         <span class="n">usb_unlock_port</span><span class="p">(</span><span class="n">port_dev</span><span class="p">);</span>
<span class="mi">5199</span>                         <span class="n">status</span> <span class="o">=</span> <span class="n">usb_remote_wakeup</span><span class="p">(</span><span class="n">udev</span><span class="p">);</span>
<span class="mi">5200</span>                         <span class="n">usb_lock_port</span><span class="p">(</span><span class="n">port_dev</span><span class="p">);</span>
<span class="mi">5201</span> <span class="err">#</span><span class="n">endif</span>
<span class="mi">5202</span>                 <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="mi">5203</span>                         <span class="cm">/* Don't resuscitate */</span><span class="p">;</span>
<span class="mi">5204</span>                 <span class="p">}</span>
<span class="mi">5205</span>         <span class="p">}</span>
<span class="mi">5206</span>         <span class="n">clear_bit</span><span class="p">(</span><span class="n">port1</span><span class="p">,</span> <span class="n">hub</span><span class="o">-&gt;</span><span class="n">change_bits</span><span class="p">);</span>
<span class="mi">5207</span> 
<span class="mi">5208</span>         <span class="cm">/* successfully revalidated the connection */</span>
<span class="mi">5209</span>         <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<span class="mi">5210</span>                 <span class="k">return</span><span class="p">;</span>
<span class="mi">5211</span> 
<span class="mi">5212</span>         <span class="n">usb_unlock_port</span><span class="p">(</span><span class="n">port_dev</span><span class="p">);</span>
<span class="mi">5213</span>         <span class="n">hub_port_connect</span><span class="p">(</span><span class="n">hub</span><span class="p">,</span> <span class="n">port1</span><span class="p">,</span> <span class="n">portstatus</span><span class="p">,</span> <span class="n">portchange</span><span class="p">);</span>
<span class="mi">5214</span>         <span class="n">usb_lock_port</span><span class="p">(</span><span class="n">port_dev</span><span class="p">);</span>
<span class="mi">5215</span> <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
</pre></td><td class="rouge-code"><pre><span class="mi">4933</span> <span class="k">static</span> <span class="kt">void</span> <span class="n">hub_port_connect</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_hub</span> <span class="o">*</span><span class="n">hub</span><span class="p">,</span> <span class="kt">int</span> <span class="n">port1</span><span class="p">,</span> <span class="n">u16</span> <span class="n">portstatus</span><span class="p">,</span>
<span class="mi">4934</span>                 <span class="n">u16</span> <span class="n">portchange</span><span class="p">)</span>
<span class="mi">4935</span> <span class="p">{</span>
<span class="mi">4936</span>         <span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="mi">4937</span>         <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
<span class="mi">4938</span>         <span class="kt">unsigned</span> <span class="n">unit_load</span><span class="p">;</span>
<span class="mi">4939</span>         <span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">hdev</span> <span class="o">=</span> <span class="n">hub</span><span class="o">-&gt;</span><span class="n">hdev</span><span class="p">;</span>
<span class="mi">4940</span>         <span class="k">struct</span> <span class="n">usb_hcd</span> <span class="o">*</span><span class="n">hcd</span> <span class="o">=</span> <span class="n">bus_to_hcd</span><span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">);</span>
<span class="mi">4941</span>         <span class="k">struct</span> <span class="n">usb_port</span> <span class="o">*</span><span class="n">port_dev</span> <span class="o">=</span> <span class="n">hub</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">port1</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
<span class="mi">4942</span>         <span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">udev</span> <span class="o">=</span> <span class="n">port_dev</span><span class="o">-&gt;</span><span class="n">child</span><span class="p">;</span>
<span class="mi">4943</span>         <span class="k">static</span> <span class="kt">int</span> <span class="n">unreliable_port</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="mi">4944</span> 
<span class="mi">4945</span>         <span class="cm">/* Disconnect any existing devices under this port */</span>
<span class="mi">4946</span>         <span class="k">if</span> <span class="p">(</span><span class="n">udev</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">4947</span>                 <span class="k">if</span> <span class="p">(</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">usb_phy</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">)</span>
<span class="mi">4948</span>                         <span class="n">usb_phy_notify_disconnect</span><span class="p">(</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">usb_phy</span><span class="p">,</span> <span class="n">udev</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">);</span>
<span class="mi">4949</span>                 <span class="n">usb_disconnect</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port_dev</span><span class="o">-&gt;</span><span class="n">child</span><span class="p">);</span>
<span class="mi">4950</span>         <span class="p">}</span>
<span class="mi">4951</span> 
<span class="mi">4952</span>         <span class="cm">/* We can forget about a "removed" device when there's a physical
4953          * disconnect or the connect status changes.
4954          */</span>
<span class="mi">4955</span>         <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">portstatus</span> <span class="o">&amp;</span> <span class="n">USB_PORT_STAT_CONNECTION</span><span class="p">)</span> <span class="o">||</span>
<span class="mi">4956</span>                         <span class="p">(</span><span class="n">portchange</span> <span class="o">&amp;</span> <span class="n">USB_PORT_STAT_C_CONNECTION</span><span class="p">))</span>
<span class="mi">4957</span>                 <span class="n">clear_bit</span><span class="p">(</span><span class="n">port1</span><span class="p">,</span> <span class="n">hub</span><span class="o">-&gt;</span><span class="n">removed_bits</span><span class="p">);</span>
<span class="mi">4958</span> 
<span class="mi">4959</span>         <span class="k">if</span> <span class="p">(</span><span class="n">portchange</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">USB_PORT_STAT_C_CONNECTION</span> <span class="o">|</span>
<span class="mi">4960</span>                                 <span class="n">USB_PORT_STAT_C_ENABLE</span><span class="p">))</span> <span class="p">{</span>
<span class="mi">4961</span>                 <span class="n">status</span> <span class="o">=</span> <span class="n">hub_port_debounce_be_stable</span><span class="p">(</span><span class="n">hub</span><span class="p">,</span> <span class="n">port1</span><span class="p">);</span>
<span class="mi">4962</span>                 <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">4963</span>                         <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ENODEV</span> <span class="o">&amp;&amp;</span>
<span class="mi">4964</span>                                 <span class="n">port1</span> <span class="o">!=</span> <span class="n">unreliable_port</span> <span class="o">&amp;&amp;</span>
<span class="mi">4965</span>                                 <span class="n">printk_ratelimit</span><span class="p">())</span>
<span class="mi">4966</span>                                 <span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">"connect-debounce failed</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="mi">4967</span>                         <span class="n">portstatus</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">USB_PORT_STAT_CONNECTION</span><span class="p">;</span>
<span class="mi">4968</span>                         <span class="n">unreliable_port</span> <span class="o">=</span> <span class="n">port1</span><span class="p">;</span>
<span class="mi">4969</span>                 <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="mi">4970</span>                         <span class="n">portstatus</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>
<span class="mi">4971</span>                 <span class="p">}</span>
<span class="mi">4972</span>         <span class="p">}</span>
<span class="mi">4973</span> 
<span class="mi">4974</span>         <span class="cm">/* Return now if debouncing failed or nothing is connected or
4975          * the device was "removed".
4976          */</span>
<span class="mi">4977</span>         <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">portstatus</span> <span class="o">&amp;</span> <span class="n">USB_PORT_STAT_CONNECTION</span><span class="p">)</span> <span class="o">||</span>
<span class="mi">4978</span>                         <span class="n">test_bit</span><span class="p">(</span><span class="n">port1</span><span class="p">,</span> <span class="n">hub</span><span class="o">-&gt;</span><span class="n">removed_bits</span><span class="p">))</span> <span class="p">{</span>
<span class="mi">4979</span> 
<span class="mi">4980</span>                 <span class="cm">/*
4981                  * maybe switch power back on (e.g. root hub was reset)
4982                  * but only if the port isn't owned by someone else.
4983                  */</span>
<span class="mi">4984</span>                 <span class="k">if</span> <span class="p">(</span><span class="n">hub_is_port_power_switchable</span><span class="p">(</span><span class="n">hub</span><span class="p">)</span>
<span class="mi">4985</span>                                 <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">port_is_power_on</span><span class="p">(</span><span class="n">hub</span><span class="p">,</span> <span class="n">portstatus</span><span class="p">)</span>
<span class="mi">4986</span>                                 <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">port_dev</span><span class="o">-&gt;</span><span class="n">port_owner</span><span class="p">)</span>
<span class="mi">4987</span>                         <span class="n">set_port_feature</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">port1</span><span class="p">,</span> <span class="n">USB_PORT_FEAT_POWER</span><span class="p">);</span>
<span class="mi">4988</span> 
<span class="mi">4989</span>                 <span class="k">if</span> <span class="p">(</span><span class="n">portstatus</span> <span class="o">&amp;</span> <span class="n">USB_PORT_STAT_ENABLE</span><span class="p">)</span>
<span class="mi">4990</span>                         <span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
<span class="mi">4991</span>                 <span class="k">return</span><span class="p">;</span>
<span class="mi">4992</span>         <span class="p">}</span>
<span class="mi">4993</span>         <span class="k">if</span> <span class="p">(</span><span class="n">hub_is_superspeed</span><span class="p">(</span><span class="n">hub</span><span class="o">-&gt;</span><span class="n">hdev</span><span class="p">))</span>
<span class="mi">4994</span>                 <span class="n">unit_load</span> <span class="o">=</span> <span class="mi">150</span><span class="p">;</span>
<span class="mi">4995</span>         <span class="k">else</span>
<span class="mi">4996</span>                 <span class="n">unit_load</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
<span class="mi">4997</span> 
<span class="mi">4998</span>         <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="mi">4999</span>         <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SET_CONFIG_TRIES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">5000</span> 
<span class="mi">5001</span>                 <span class="cm">/* reallocate for each attempt, since references
5002                  * to the previous one can escape in various ways
5003                  */</span>
<span class="mi">5004</span>                 <span class="n">udev</span> <span class="o">=</span> <span class="n">usb_alloc_dev</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">,</span> <span class="n">port1</span><span class="p">);</span>
<span class="mi">5005</span>                 <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">udev</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">5006</span>                         <span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
<span class="mi">5007</span>                                         <span class="s">"couldn't allocate usb_device</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="mi">5008</span>                         <span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
<span class="mi">5009</span>                 <span class="p">}</span>
<span class="mi">5010</span> 
<span class="mi">5011</span>                 <span class="n">usb_set_device_state</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">USB_STATE_POWERED</span><span class="p">);</span>
<span class="mi">5012</span>                 <span class="n">udev</span><span class="o">-&gt;</span><span class="n">bus_mA</span> <span class="o">=</span> <span class="n">hub</span><span class="o">-&gt;</span><span class="n">mA_per_port</span><span class="p">;</span>
<span class="mi">5013</span>                 <span class="n">udev</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">=</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<span class="mi">5014</span>                 <span class="n">udev</span><span class="o">-&gt;</span><span class="n">wusb</span> <span class="o">=</span> <span class="n">hub_is_wusb</span><span class="p">(</span><span class="n">hub</span><span class="p">);</span>
<span class="mi">5015</span> 
<span class="mi">5016</span>                 <span class="cm">/* Devices connected to SuperSpeed hubs are USB 3.0 or later */</span>
<span class="mi">5017</span>                 <span class="k">if</span> <span class="p">(</span><span class="n">hub_is_superspeed</span><span class="p">(</span><span class="n">hub</span><span class="o">-&gt;</span><span class="n">hdev</span><span class="p">))</span>
<span class="mi">5018</span>                         <span class="n">udev</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">=</span> <span class="n">USB_SPEED_SUPER</span><span class="p">;</span>
<span class="mi">5019</span>                 <span class="k">else</span>
<span class="mi">5020</span>                         <span class="n">udev</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">=</span> <span class="n">USB_SPEED_UNKNOWN</span><span class="p">;</span>
<span class="mi">5021</span> 
<span class="mi">5022</span>                 <span class="n">choose_devnum</span><span class="p">(</span><span class="n">udev</span><span class="p">);</span>
<span class="mi">5023</span>                 <span class="k">if</span> <span class="p">(</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">devnum</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">5024</span>                         <span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOTCONN</span><span class="p">;</span>     <span class="cm">/* Don't retry */</span>
<span class="mi">5025</span>                         <span class="k">goto</span> <span class="n">loop</span><span class="p">;</span>
<span class="mi">5026</span>                 <span class="p">}</span>
<span class="mi">5027</span> 
<span class="mi">5028</span>                 <span class="cm">/* reset (non-USB 3.0 devices) and get descriptor */</span>
<span class="mi">5029</span>                 <span class="n">usb_lock_port</span><span class="p">(</span><span class="n">port_dev</span><span class="p">);</span>
<span class="mi">5030</span>                 <span class="n">status</span> <span class="o">=</span> <span class="n">hub_port_init</span><span class="p">(</span><span class="n">hub</span><span class="p">,</span> <span class="n">udev</span><span class="p">,</span> <span class="n">port1</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
<span class="mi">5031</span>                 <span class="n">usb_unlock_port</span><span class="p">(</span><span class="n">port_dev</span><span class="p">);</span>
<span class="mi">5032</span>                 <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
<span class="mi">5033</span>                         <span class="k">goto</span> <span class="n">loop</span><span class="p">;</span>
<span class="mi">5034</span> 
<span class="mi">5035</span>                 <span class="k">if</span> <span class="p">(</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">quirks</span> <span class="o">&amp;</span> <span class="n">USB_QUIRK_DELAY_INIT</span><span class="p">)</span>
<span class="mi">5036</span>                         <span class="n">msleep</span><span class="p">(</span><span class="mi">2000</span><span class="p">);</span>
<span class="mi">5037</span> 
<span class="mi">5038</span>                 <span class="cm">/* consecutive bus-powered hubs aren't reliable; they can
5039                  * violate the voltage drop budget.  if the new child has
5040                  * a "powered" LED, users should notice we didn't enable it
5041                  * (without reading syslog), even without per-port LEDs
5042                  * on the parent.
5043                  */</span>
<span class="mi">5044</span>                 <span class="k">if</span> <span class="p">(</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">bDeviceClass</span> <span class="o">==</span> <span class="n">USB_CLASS_HUB</span>
<span class="mi">5045</span>                                 <span class="o">&amp;&amp;</span> <span class="n">udev</span><span class="o">-&gt;</span><span class="n">bus_mA</span> <span class="o">&lt;=</span> <span class="n">unit_load</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">5046</span>                         <span class="n">u16</span>     <span class="n">devstat</span><span class="p">;</span>
<span class="mi">5047</span> 
<span class="mi">5048</span>                         <span class="n">status</span> <span class="o">=</span> <span class="n">usb_get_std_status</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">USB_RECIP_DEVICE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
<span class="mi">5049</span>                                         <span class="o">&amp;</span><span class="n">devstat</span><span class="p">);</span>
<span class="mi">5050</span>                         <span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">5051</span>                                 <span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">"get status %d ?</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
<span class="mi">5052</span>                                 <span class="k">goto</span> <span class="n">loop_disable</span><span class="p">;</span>
<span class="mi">5053</span>                         <span class="p">}</span>
<span class="mi">5054</span>                         <span class="k">if</span> <span class="p">((</span><span class="n">devstat</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">USB_DEVICE_SELF_POWERED</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">5055</span>                                 <span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
<span class="mi">5056</span>                                         <span class="s">"can't connect bus-powered hub "</span>
<span class="mi">5057</span>                                         <span class="s">"to this port</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="mi">5058</span>                                 <span class="k">if</span> <span class="p">(</span><span class="n">hub</span><span class="o">-&gt;</span><span class="n">has_indicators</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">5059</span>                                         <span class="n">hub</span><span class="o">-&gt;</span><span class="n">indicator</span><span class="p">[</span><span class="n">port1</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
<span class="mi">5060</span>                                                 <span class="n">INDICATOR_AMBER_BLINK</span><span class="p">;</span>
<span class="mi">5061</span>                                         <span class="n">queue_delayed_work</span><span class="p">(</span>
<span class="mi">5062</span>                                                 <span class="n">system_power_efficient_wq</span><span class="p">,</span>
<span class="mi">5063</span>                                                 <span class="o">&amp;</span><span class="n">hub</span><span class="o">-&gt;</span><span class="n">leds</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="mi">5064</span>                                 <span class="p">}</span>
<span class="mi">5065</span>                                 <span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOTCONN</span><span class="p">;</span>     <span class="cm">/* Don't retry */</span>
<span class="mi">5066</span>                                 <span class="k">goto</span> <span class="n">loop_disable</span><span class="p">;</span>
<span class="mi">5067</span>                         <span class="p">}</span>
<span class="mi">5068</span>                 <span class="p">}</span>
<span class="mi">5069</span> 
<span class="mi">5070</span>                 <span class="cm">/* check for devices running slower than they could */</span>
<span class="mi">5071</span>                 <span class="k">if</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">bcdUSB</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mh">0x0200</span>
<span class="mi">5072</span>                                 <span class="o">&amp;&amp;</span> <span class="n">udev</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">==</span> <span class="n">USB_SPEED_FULL</span>
<span class="mi">5073</span>                                 <span class="o">&amp;&amp;</span> <span class="n">highspeed_hubs</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
<span class="mi">5074</span>                         <span class="n">check_highspeed</span><span class="p">(</span><span class="n">hub</span><span class="p">,</span> <span class="n">udev</span><span class="p">,</span> <span class="n">port1</span><span class="p">);</span>
<span class="mi">5075</span> 
<span class="mi">5076</span>                 <span class="cm">/* Store the parent's children[] pointer.  At this point
5077                  * udev becomes globally accessible, although presumably
5078                  * no one will look at it until hdev is unlocked.
5079                  */</span>
<span class="mi">5080</span>                 <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="mi">5081</span> 
<span class="mi">5082</span>                 <span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usb_port_peer_mutex</span><span class="p">);</span>
<span class="mi">5083</span> 
<span class="mi">5084</span>                 <span class="cm">/* We mustn't add new devices if the parent hub has
5085                  * been disconnected; we would race with the
5086                  * recursively_mark_NOTATTACHED() routine.
5087                  */</span>
<span class="mi">5088</span>                 <span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device_state_lock</span><span class="p">);</span>
<span class="mi">5089</span>                 <span class="k">if</span> <span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">USB_STATE_NOTATTACHED</span><span class="p">)</span>
<span class="mi">5090</span>                         <span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOTCONN</span><span class="p">;</span>
<span class="mi">5091</span>                 <span class="k">else</span>
<span class="mi">5092</span>                         <span class="n">port_dev</span><span class="o">-&gt;</span><span class="n">child</span> <span class="o">=</span> <span class="n">udev</span><span class="p">;</span>
<span class="mi">5093</span>                 <span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device_state_lock</span><span class="p">);</span>
<span class="mi">5094</span>                 <span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usb_port_peer_mutex</span><span class="p">);</span>
<span class="mi">5095</span> 
<span class="mi">5096</span>                 <span class="cm">/* Run it through the hoops (find a driver, etc) */</span>
<span class="mi">5097</span>                 <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">5098</span>                         <span class="n">status</span> <span class="o">=</span> <span class="n">usb_new_device</span><span class="p">(</span><span class="n">udev</span><span class="p">);</span>
<span class="mi">5099</span>                         <span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">5100</span>                                 <span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usb_port_peer_mutex</span><span class="p">);</span>
<span class="mi">5101</span>                                 <span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device_state_lock</span><span class="p">);</span>
<span class="mi">5102</span>                                 <span class="n">port_dev</span><span class="o">-&gt;</span><span class="n">child</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="mi">5103</span>                                 <span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device_state_lock</span><span class="p">);</span>
<span class="mi">5104</span>                                 <span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usb_port_peer_mutex</span><span class="p">);</span>
<span class="mi">5105</span>                         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="mi">5106</span>                                 <span class="k">if</span> <span class="p">(</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">usb_phy</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">)</span>
<span class="mi">5107</span>                                         <span class="n">usb_phy_notify_connect</span><span class="p">(</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">usb_phy</span><span class="p">,</span>
<span class="mi">5108</span>                                                         <span class="n">udev</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">);</span>
<span class="mi">5109</span>                         <span class="p">}</span>
<span class="mi">5110</span>                 <span class="p">}</span>
<span class="mi">5111</span> 
<span class="mi">5112</span>                 <span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
<span class="mi">5113</span>                         <span class="k">goto</span> <span class="n">loop_disable</span><span class="p">;</span>
<span class="mi">5114</span> 
<span class="mi">5115</span>                 <span class="n">status</span> <span class="o">=</span> <span class="n">hub_power_remaining</span><span class="p">(</span><span class="n">hub</span><span class="p">);</span>
<span class="mi">5116</span>                 <span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
<span class="mi">5117</span>                         <span class="n">dev_dbg</span><span class="p">(</span><span class="n">hub</span><span class="o">-&gt;</span><span class="n">intfdev</span><span class="p">,</span> <span class="s">"%dmA power budget left</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
<span class="mi">5118</span> 
<span class="mi">5119</span>                 <span class="k">return</span><span class="p">;</span>
<span class="mi">5120</span> 
<span class="mi">5121</span> <span class="n">loop_disable</span><span class="o">:</span>
<span class="mi">5122</span>                 <span class="n">hub_port_disable</span><span class="p">(</span><span class="n">hub</span><span class="p">,</span> <span class="n">port1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="mi">5123</span> <span class="n">loop</span><span class="o">:</span>
<span class="mi">5124</span>                 <span class="n">usb_ep0_reinit</span><span class="p">(</span><span class="n">udev</span><span class="p">);</span>
<span class="mi">5125</span>                 <span class="n">release_devnum</span><span class="p">(</span><span class="n">udev</span><span class="p">);</span>
<span class="mi">5126</span>                 <span class="n">hub_free_dev</span><span class="p">(</span><span class="n">udev</span><span class="p">);</span>
<span class="mi">5127</span>                 <span class="n">usb_put_dev</span><span class="p">(</span><span class="n">udev</span><span class="p">);</span>
<span class="mi">5128</span>                 <span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOTCONN</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOTSUPP</span><span class="p">))</span>
<span class="mi">5129</span>                         <span class="k">break</span><span class="p">;</span>
<span class="mi">5130</span> 
<span class="mi">5131</span>                 <span class="cm">/* When halfway through our retry count, power-cycle the port */</span>
<span class="mi">5132</span>                 <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="p">(</span><span class="n">SET_CONFIG_TRIES</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">5133</span>                         <span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">"attempt power cycle</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="mi">5134</span>                         <span class="n">usb_hub_set_port_power</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">hub</span><span class="p">,</span> <span class="n">port1</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
<span class="mi">5135</span>                         <span class="n">msleep</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">hub_power_on_good_delay</span><span class="p">(</span><span class="n">hub</span><span class="p">));</span>
<span class="mi">5136</span>                         <span class="n">usb_hub_set_port_power</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">hub</span><span class="p">,</span> <span class="n">port1</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
<span class="mi">5137</span>                         <span class="n">msleep</span><span class="p">(</span><span class="n">hub_power_on_good_delay</span><span class="p">(</span><span class="n">hub</span><span class="p">));</span>
<span class="mi">5138</span>                 <span class="p">}</span>
<span class="mi">5139</span>         <span class="p">}</span>
<span class="mi">5140</span>         <span class="k">if</span> <span class="p">(</span><span class="n">hub</span><span class="o">-&gt;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">parent</span> <span class="o">||</span>
<span class="mi">5141</span>                         <span class="o">!</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">port_handed_over</span> <span class="o">||</span>
<span class="mi">5142</span>                         <span class="o">!</span><span class="p">(</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">port_handed_over</span><span class="p">)(</span><span class="n">hcd</span><span class="p">,</span> <span class="n">port1</span><span class="p">))</span> <span class="p">{</span>
<span class="mi">5143</span>                 <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ENOTCONN</span> <span class="o">&amp;&amp;</span> <span class="n">status</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">)</span>
<span class="mi">5144</span>                         <span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
<span class="mi">5145</span>                                         <span class="s">"unable to enumerate USB device</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="mi">5146</span>         <span class="p">}</span>
<span class="mi">5147</span> 
<span class="mi">5148</span> <span class="n">done</span><span class="o">:</span>
<span class="mi">5149</span>         <span class="n">hub_port_disable</span><span class="p">(</span><span class="n">hub</span><span class="p">,</span> <span class="n">port1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="mi">5150</span>         <span class="k">if</span> <span class="p">(</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">relinquish_port</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">hub</span><span class="o">-&gt;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">5151</span>                 <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ENOTCONN</span> <span class="o">&amp;&amp;</span> <span class="n">status</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">)</span>
<span class="mi">5152</span>                         <span class="n">hcd</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">relinquish_port</span><span class="p">(</span><span class="n">hcd</span><span class="p">,</span> <span class="n">port1</span><span class="p">);</span>
<span class="mi">5153</span>         <span class="p">}</span>
<span class="mi">5154</span> <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="add-new-device"><span class="me-2">Add new device</span><a href="#add-new-device" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
</pre></td><td class="rouge-code"><pre><span class="mi">2482</span> <span class="kt">int</span> <span class="n">usb_new_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">udev</span><span class="p">)</span>
<span class="mi">2483</span> <span class="p">{</span>
<span class="mi">2484</span>     <span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
<span class="mi">2485</span> 
<span class="mi">2486</span>     <span class="k">if</span> <span class="p">(</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">2487</span>         <span class="cm">/* Initialize non-root-hub device wakeup to disabled;
2488          * device (un)configuration controls wakeup capable
2489          * sysfs power/wakeup controls wakeup enabled/disabled
2490          */</span>
<span class="mi">2491</span>         <span class="n">device_init_wakeup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="mi">2492</span>     <span class="p">}</span>
<span class="mi">2493</span> 
<span class="mi">2494</span>     <span class="cm">/* Tell the runtime-PM framework the device is active */</span>
<span class="mi">2495</span>     <span class="n">pm_runtime_set_active</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="mi">2496</span>     <span class="n">pm_runtime_get_noresume</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="mi">2497</span>     <span class="n">pm_runtime_use_autosuspend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="mi">2498</span>     <span class="n">pm_runtime_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="mi">2499</span> 
<span class="mi">2500</span>     <span class="cm">/* By default, forbid autosuspend for all devices.  It will be
2501      * allowed for hubs during binding.
2502      */</span>
<span class="mi">2503</span>     <span class="n">usb_disable_autosuspend</span><span class="p">(</span><span class="n">udev</span><span class="p">);</span>
<span class="mi">2504</span> 
<span class="mi">2505</span>     <span class="n">err</span> <span class="o">=</span> <span class="n">usb_enumerate_device</span><span class="p">(</span><span class="n">udev</span><span class="p">);</span>   <span class="cm">/* Read descriptors */</span>
<span class="mi">2506</span>     <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
<span class="mi">2507</span>         <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
<span class="mi">2508</span>     <span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">"udev %d, busnum %d, minor = %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
<span class="mi">2509</span>             <span class="n">udev</span><span class="o">-&gt;</span><span class="n">devnum</span><span class="p">,</span> <span class="n">udev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">busnum</span><span class="p">,</span>
<span class="mi">2510</span>             <span class="p">(((</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">busnum</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">128</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">devnum</span><span class="o">-</span><span class="mi">1</span><span class="p">)));</span>
<span class="mi">2511</span>     <span class="cm">/* export the usbdev device-node for libusb */</span>
<span class="mi">2512</span>     <span class="n">udev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">devt</span> <span class="o">=</span> <span class="n">MKDEV</span><span class="p">(</span><span class="n">USB_DEVICE_MAJOR</span><span class="p">,</span>
<span class="mi">2513</span>             <span class="p">(((</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">busnum</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">128</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">devnum</span><span class="o">-</span><span class="mi">1</span><span class="p">)));</span>
<span class="mi">2514</span> 
<span class="mi">2515</span>     <span class="cm">/* Tell the world! */</span>
<span class="mi">2516</span>     <span class="n">announce_device</span><span class="p">(</span><span class="n">udev</span><span class="p">);</span>
<span class="mi">2517</span> 
<span class="mi">2518</span>     <span class="k">if</span> <span class="p">(</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">)</span>
<span class="mi">2519</span>         <span class="n">add_device_randomness</span><span class="p">(</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">));</span>
<span class="mi">2520</span>     <span class="k">if</span> <span class="p">(</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">product</span><span class="p">)</span>
<span class="mi">2521</span>         <span class="n">add_device_randomness</span><span class="p">(</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">product</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">product</span><span class="p">));</span>
<span class="mi">2522</span>     <span class="k">if</span> <span class="p">(</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">manufacturer</span><span class="p">)</span>
<span class="mi">2523</span>         <span class="n">add_device_randomness</span><span class="p">(</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">manufacturer</span><span class="p">,</span>
<span class="mi">2524</span>                       <span class="n">strlen</span><span class="p">(</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">manufacturer</span><span class="p">));</span>
<span class="mi">2525</span> 
<span class="mi">2526</span>     <span class="n">device_enable_async_suspend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="mi">2527</span> 
<span class="mi">2528</span>     <span class="cm">/* check whether the hub or firmware marks this port as non-removable */</span>
<span class="mi">2529</span>     <span class="k">if</span> <span class="p">(</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">)</span>
<span class="mi">2530</span>         <span class="n">set_usb_port_removable</span><span class="p">(</span><span class="n">udev</span><span class="p">);</span>
<span class="mi">2531</span> 
<span class="mi">2532</span>     <span class="cm">/* Register the device.  The device driver is responsible
2533      * for configuring the device and invoking the add-device
2534      * notifier chain (used by usbfs and possibly others).
2535      */</span>
<span class="mi">2536</span>     <span class="n">err</span> <span class="o">=</span> <span class="n">device_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="mi">2537</span>     <span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">2538</span>         <span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">"can't device_add, error %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
<span class="mi">2539</span>         <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
<span class="mi">2540</span>     <span class="p">}</span>
<span class="mi">2541</span> 
<span class="mi">2542</span>     <span class="cm">/* Create link files between child device and usb port device. */</span>
<span class="mi">2543</span>     <span class="k">if</span> <span class="p">(</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">2544</span>         <span class="k">struct</span> <span class="n">usb_hub</span> <span class="o">*</span><span class="n">hub</span> <span class="o">=</span> <span class="n">usb_hub_to_struct_hub</span><span class="p">(</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">);</span>
<span class="mi">2545</span>         <span class="kt">int</span> <span class="n">port1</span> <span class="o">=</span> <span class="n">udev</span><span class="o">-&gt;</span><span class="n">portnum</span><span class="p">;</span>
<span class="mi">2546</span>         <span class="k">struct</span> <span class="n">usb_port</span> <span class="o">*</span><span class="n">port_dev</span> <span class="o">=</span> <span class="n">hub</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">port1</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
<span class="mi">2547</span> 
<span class="mi">2548</span>         <span class="n">err</span> <span class="o">=</span> <span class="n">sysfs_create_link</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span>
<span class="mi">2549</span>                 <span class="o">&amp;</span><span class="n">port_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="s">"port"</span><span class="p">);</span>
<span class="mi">2550</span>         <span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
<span class="mi">2551</span>             <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
<span class="mi">2552</span> 
<span class="mi">2553</span>         <span class="n">err</span> <span class="o">=</span> <span class="n">sysfs_create_link</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span>
<span class="mi">2554</span>                 <span class="o">&amp;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="s">"device"</span><span class="p">);</span>
<span class="mi">2555</span>         <span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">2556</span>             <span class="n">sysfs_remove_link</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="s">"port"</span><span class="p">);</span>
<span class="mi">2557</span>             <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
<span class="mi">2558</span>         <span class="p">}</span>
<span class="mi">2559</span> 
<span class="mi">2560</span>         <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">port1</span><span class="p">,</span> <span class="n">hub</span><span class="o">-&gt;</span><span class="n">child_usage_bits</span><span class="p">))</span>
<span class="mi">2561</span>             <span class="n">pm_runtime_get_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="mi">2562</span>     <span class="p">}</span>
<span class="mi">2563</span> 
<span class="mi">2564</span>     <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">usb_create_ep_devs</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">ep0</span><span class="p">,</span> <span class="n">udev</span><span class="p">);</span>
<span class="mi">2565</span>     <span class="n">usb_mark_last_busy</span><span class="p">(</span><span class="n">udev</span><span class="p">);</span>
<span class="mi">2566</span>     <span class="n">pm_runtime_put_sync_autosuspend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="mi">2567</span>     <span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="mi">2568</span> 
<span class="mi">2569</span> <span class="n">fail</span><span class="o">:</span>
<span class="mi">2570</span>     <span class="n">usb_set_device_state</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">USB_STATE_NOTATTACHED</span><span class="p">);</span>
<span class="mi">2571</span>     <span class="n">pm_runtime_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="mi">2572</span>     <span class="n">pm_runtime_set_suspended</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="mi">2573</span>     <span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="mi">2574</span> <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<h2 id="register-usb-device-drivers"><span class="me-2">Register usb device drivers</span><a href="#register-usb-device-drivers" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
</pre></td><td class="rouge-code"><pre><span class="k">struct</span> <span class="n">usb_device_driver</span> <span class="n">usb_generic_driver</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">"usb"</span><span class="p">,</span>
        <span class="p">.</span><span class="n">match</span> <span class="o">=</span> <span class="n">usb_generic_driver_match</span><span class="p">,</span>
        <span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">usb_generic_driver_probe</span><span class="p">,</span>
        <span class="p">.</span><span class="n">disconnect</span> <span class="o">=</span> <span class="n">usb_generic_driver_disconnect</span><span class="p">,</span>
<span class="cp">#ifdef  CONFIG_PM
</span>        <span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">usb_generic_driver_suspend</span><span class="p">,</span>
        <span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">usb_generic_driver_resume</span><span class="p">,</span>
<span class="cp">#endif
</span>        <span class="p">.</span><span class="n">supports_autosuspend</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>


<span class="cm">/**
 * usb_register_device_driver - register a USB device (not interface) driver
 * @new_udriver: USB operations for the device driver
 * @owner: module owner of this driver.
 *
 * Registers a USB device driver with the USB core.  The list of
 * unattached devices will be rescanned whenever a new driver is
 * added, allowing the new driver to attach to any recognized devices.
 *
 * Return: A negative error code on failure and 0 on success.
 */</span>
<span class="kt">int</span> <span class="nf">usb_register_device_driver</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_device_driver</span> <span class="o">*</span><span class="n">new_udriver</span><span class="p">,</span>
                <span class="k">struct</span> <span class="n">module</span> <span class="o">*</span><span class="n">owner</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">usb_disabled</span><span class="p">())</span>
                <span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

        <span class="n">new_udriver</span><span class="o">-&gt;</span><span class="n">drvwrap</span><span class="p">.</span><span class="n">for_devices</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">new_udriver</span><span class="o">-&gt;</span><span class="n">drvwrap</span><span class="p">.</span><span class="n">driver</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">new_udriver</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
        <span class="n">new_udriver</span><span class="o">-&gt;</span><span class="n">drvwrap</span><span class="p">.</span><span class="n">driver</span><span class="p">.</span><span class="n">bus</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">usb_bus_type</span><span class="p">;</span>
        <span class="n">new_udriver</span><span class="o">-&gt;</span><span class="n">drvwrap</span><span class="p">.</span><span class="n">driver</span><span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">usb_probe_device</span><span class="p">;</span>
        <span class="n">new_udriver</span><span class="o">-&gt;</span><span class="n">drvwrap</span><span class="p">.</span><span class="n">driver</span><span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">usb_unbind_device</span><span class="p">;</span>
        <span class="n">new_udriver</span><span class="o">-&gt;</span><span class="n">drvwrap</span><span class="p">.</span><span class="n">driver</span><span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">owner</span><span class="p">;</span>
        <span class="n">new_udriver</span><span class="o">-&gt;</span><span class="n">drvwrap</span><span class="p">.</span><span class="n">driver</span><span class="p">.</span><span class="n">dev_groups</span> <span class="o">=</span> <span class="n">new_udriver</span><span class="o">-&gt;</span><span class="n">dev_groups</span><span class="p">;</span>

        <span class="n">retval</span> <span class="o">=</span> <span class="n">driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_udriver</span><span class="o">-&gt;</span><span class="n">drvwrap</span><span class="p">.</span><span class="n">driver</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">pr_info</span><span class="p">(</span><span class="s">"%s: registered new device driver %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
                        <span class="n">usbcore_name</span><span class="p">,</span> <span class="n">new_udriver</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
                <span class="cm">/*
                 * Check whether any device could be better served with
                 * this new driver
                 */</span>
                <span class="n">bus_for_each_dev</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usb_bus_type</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">new_udriver</span><span class="p">,</span>
                                 <span class="n">__usb_bus_reprobe_drivers</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">pr_err</span><span class="p">(</span><span class="s">"%s: error %d registering device driver %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
                        <span class="n">usbcore_name</span><span class="p">,</span> <span class="n">retval</span><span class="p">,</span> <span class="n">new_udriver</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">usb_register_device_driver</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></div></div>
<p>Note that this function is slightly different 
from usb_register_driver function
which was used for 
registering usb core interface drivers
such as hub_driver, usbfs_driver.
One of the notable difference is for_device field is only set 
for the usb_generic_driver, and other interface driver 
doesn’t set the flag.
Also differnet call back functions are set for this driver
XXX
The other biggest difference is 
it invokes __usb_bus_reprobe_drivers function 
for devices registered on the usb bus.</p>

<h1 id="long-journey-to-understand-how-the-usb-device-can-be-hot-plugged">Long journey to understand how the USB device can be hot-plugged</h1>
<p>Although most basic usb core part and usb bus
have been initialized at the boot-up,
the internal usb controllers and another 
layers of device driver should be bound
to fully manage the usb subsystem.</p>

<p>Previous initializations are mostly focused on the 
usb core parts that provides 
generic software layers for usb management 
regardless of the hardware specification of the internal usb controller.</p>

<p>However, the first layer that actually encounters
usb attachment and detachment is the usb controller.
As usb specification develops, 
its controller implementing the specifications also evolved,
and linux supports various usb controllers.</p>

<p>First to understand the linux-supporting usb controllers,
you have to clearly distinguish 
usb host controller interface from actual usb controller.
There are four typical host controller interfaces supported by Linux:
*OHCI (Open Host Controller Interface(Compaq)) supporting only USB1.1 (Full and Low speeds),
*UHCI (Universal Host Controller Interface (Intel)) supporting 1.x(Full and Low speeds). 
The hardware composition of UHCI is simple which makes its driver more complex burdening your processor.
*EHCI (Extended Host Controller Interface) supporting USB 2.0.
*XHCI (Extended Host Controller Interface) supporting USB 3.x and belows for compatibility (including 2.0, 1.X)</p>

<p>XXX
Although there is only one fixed specification for a particular USB version, 
there can be various versions of USB controller 
that implements particular specifications. 
Therefore, 
to support those controllers,
device driver should be required.
For example,
the linux provides device driver supports for DWC3 
which is 
SuperSpeed (SS) USB 3.0 Dual-Role-Device (DRD) from Synopsys.
Also, it has support for CDNS3
which is a SuperSpeed (SS) USB 3.0 Dual-Role-Device (DRD) controller from Cadence.
Furthermore, 
note that there can be more device specific USB micro controller
that is not supported by the linux officially. 
For further information about Linux supported USB controller,
take a look at usb directory.</p>

<h2 id="the-usb-host-controller-drivers"><span class="me-2">The USB Host controller drivers</span><a href="#the-usb-host-controller-drivers" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<p>There are various usb controllers 
implemented by the different vendors 
even though they support same USB specification.
Therefore, to reduce the boilerplate in
multiple host controller driver,
linux implementes generic host controller code 
that can support multiple versions of it.</p>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre></td><td class="rouge-code"><pre><span class="k">struct</span> <span class="n">usb_hcd</span> <span class="p">{</span>

        <span class="cm">/*
         * housekeeping
         */</span>
        <span class="k">struct</span> <span class="n">usb_bus</span>          <span class="n">self</span><span class="p">;</span>           <span class="cm">/* hcd is-a bus */</span>
        <span class="k">struct</span> <span class="n">kref</span>             <span class="n">kref</span><span class="p">;</span>           <span class="cm">/* reference counter */</span>

        <span class="k">const</span> <span class="kt">char</span>              <span class="o">*</span><span class="n">product_desc</span><span class="p">;</span>  <span class="cm">/* product/vendor string */</span>
        <span class="kt">int</span>                     <span class="n">speed</span><span class="p">;</span>          <span class="cm">/* Speed for this roothub.
                                                 * May be different from
                                                 * hcd-&gt;driver-&gt;flags &amp; HCD_MASK
                                                 */</span>
        <span class="kt">char</span>                    <span class="n">irq_descr</span><span class="p">[</span><span class="mi">24</span><span class="p">];</span>  <span class="cm">/* driver + bus # */</span>

        <span class="k">struct</span> <span class="n">timer_list</span>       <span class="n">rh_timer</span><span class="p">;</span>       <span class="cm">/* drives root-hub polling */</span>
        <span class="k">struct</span> <span class="n">urb</span>              <span class="o">*</span><span class="n">status_urb</span><span class="p">;</span>    <span class="cm">/* the current status urb */</span>
<span class="cp">#ifdef CONFIG_PM
</span>        <span class="k">struct</span> <span class="n">work_struct</span>      <span class="n">wakeup_work</span><span class="p">;</span>    <span class="cm">/* for remote wakeup */</span>
<span class="cp">#endif
</span>        <span class="k">struct</span> <span class="n">work_struct</span>      <span class="n">died_work</span><span class="p">;</span>      <span class="cm">/* for when the device dies */</span>

        <span class="cm">/*
         * hardware info/state
         */</span>
        <span class="k">const</span> <span class="k">struct</span> <span class="n">hc_driver</span>  <span class="o">*</span><span class="n">driver</span><span class="p">;</span>        <span class="cm">/* hw-specific hooks */</span>
	<span class="p">...</span>

<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>
<p>Usb_hcd structure maintains general information
required for managing USB controllers 
regradless of its specification versions and vendors. 
Therefore, 
to utilize the benefit of Linux USB subsystem,
each host controller driver should provide
all information required by generic usb_hcd structure.</p>

<h3 id="xhci-usb-specification"><span class="me-2">xHCI usb specification</span><a href="#xhci-usb-specification" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>Let’s switch gears and take a look at 
USB specification, particularly xHCI. 
At the time of writing this posting,
the xHCI usb specification is the up-to-date version of USB
supporting usb3.x and belows such as usb1.x and usb 2.0.</p>

<p>The USB specification is a essential information
to represent a particular USB host controller device.
You can see that 
usb_hcd structure contains the hc_driver structure pointer
in the above code block.
This structure contains USB specification specific callback functions 
utilized by the USB host controller driver 
to support specific USB protocol such as USB 3.0, USB 2.0, etc.</p>

<p><strong>drivers/usb/host/xhci.c file</strong></p>
<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
</pre></td><td class="rouge-code"><pre><span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">hc_driver</span> <span class="n">xhci_hc_driver</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">.</span><span class="n">description</span> <span class="o">=</span>          <span class="s">"xhci-hcd"</span><span class="p">,</span>
        <span class="p">.</span><span class="n">product_desc</span> <span class="o">=</span>         <span class="s">"xHCI Host Controller"</span><span class="p">,</span>
        <span class="p">.</span><span class="n">hcd_priv_size</span> <span class="o">=</span>        <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xhci_hcd</span><span class="p">),</span>

        <span class="cm">/*
         * generic hardware linkage
         */</span>
        <span class="p">.</span><span class="n">irq</span> <span class="o">=</span>                  <span class="n">xhci_irq</span><span class="p">,</span>
        <span class="p">.</span><span class="n">flags</span> <span class="o">=</span>                <span class="n">HCD_MEMORY</span> <span class="o">|</span> <span class="n">HCD_DMA</span> <span class="o">|</span> <span class="n">HCD_USB3</span> <span class="o">|</span> <span class="n">HCD_SHARED</span> <span class="o">|</span>
                                <span class="n">HCD_BH</span><span class="p">,</span>

        <span class="cm">/*
         * basic lifecycle operations
         */</span>
        <span class="p">.</span><span class="n">reset</span> <span class="o">=</span>                <span class="nb">NULL</span><span class="p">,</span> <span class="cm">/* set in xhci_init_driver() */</span>
        <span class="p">.</span><span class="n">start</span> <span class="o">=</span>                <span class="n">xhci_run</span><span class="p">,</span>
        <span class="p">.</span><span class="n">stop</span> <span class="o">=</span>                 <span class="n">xhci_stop</span><span class="p">,</span>
        <span class="p">.</span><span class="n">shutdown</span> <span class="o">=</span>             <span class="n">xhci_shutdown</span><span class="p">,</span>

        <span class="cm">/*
         * managing i/o requests and associated device resources
         */</span>
        <span class="p">.</span><span class="n">map_urb_for_dma</span> <span class="o">=</span>      <span class="n">xhci_map_urb_for_dma</span><span class="p">,</span>
        <span class="p">.</span><span class="n">unmap_urb_for_dma</span> <span class="o">=</span>    <span class="n">xhci_unmap_urb_for_dma</span><span class="p">,</span>
        <span class="p">.</span><span class="n">urb_enqueue</span> <span class="o">=</span>          <span class="n">xhci_urb_enqueue</span><span class="p">,</span>
        <span class="p">.</span><span class="n">urb_dequeue</span> <span class="o">=</span>          <span class="n">xhci_urb_dequeue</span><span class="p">,</span>
        <span class="p">.</span><span class="n">alloc_dev</span> <span class="o">=</span>            <span class="n">xhci_alloc_dev</span><span class="p">,</span>
        <span class="p">.</span><span class="n">free_dev</span> <span class="o">=</span>             <span class="n">xhci_free_dev</span><span class="p">,</span>
        <span class="p">.</span><span class="n">alloc_streams</span> <span class="o">=</span>        <span class="n">xhci_alloc_streams</span><span class="p">,</span>
        <span class="p">.</span><span class="n">free_streams</span> <span class="o">=</span>         <span class="n">xhci_free_streams</span><span class="p">,</span>
        <span class="p">.</span><span class="n">add_endpoint</span> <span class="o">=</span>         <span class="n">xhci_add_endpoint</span><span class="p">,</span>
        <span class="p">.</span><span class="n">drop_endpoint</span> <span class="o">=</span>        <span class="n">xhci_drop_endpoint</span><span class="p">,</span>
        <span class="p">.</span><span class="n">endpoint_disable</span> <span class="o">=</span>     <span class="n">xhci_endpoint_disable</span><span class="p">,</span>
        <span class="p">.</span><span class="n">endpoint_reset</span> <span class="o">=</span>       <span class="n">xhci_endpoint_reset</span><span class="p">,</span>
        <span class="p">.</span><span class="n">check_bandwidth</span> <span class="o">=</span>      <span class="n">xhci_check_bandwidth</span><span class="p">,</span>
        <span class="p">.</span><span class="n">reset_bandwidth</span> <span class="o">=</span>      <span class="n">xhci_reset_bandwidth</span><span class="p">,</span>
        <span class="p">.</span><span class="n">address_device</span> <span class="o">=</span>       <span class="n">xhci_address_device</span><span class="p">,</span>
        <span class="p">.</span><span class="n">enable_device</span> <span class="o">=</span>        <span class="n">xhci_enable_device</span><span class="p">,</span>
        <span class="p">.</span><span class="n">update_hub_device</span> <span class="o">=</span>    <span class="n">xhci_update_hub_device</span><span class="p">,</span>
        <span class="p">.</span><span class="n">reset_device</span> <span class="o">=</span>         <span class="n">xhci_discover_or_reset_device</span><span class="p">,</span>

        <span class="cm">/*
         * scheduling support
         */</span>
        <span class="p">.</span><span class="n">get_frame_number</span> <span class="o">=</span>     <span class="n">xhci_get_frame</span><span class="p">,</span>

        <span class="cm">/*
         * root hub support
         */</span>
        <span class="p">.</span><span class="n">hub_control</span> <span class="o">=</span>          <span class="n">xhci_hub_control</span><span class="p">,</span>
        <span class="p">.</span><span class="n">hub_status_data</span> <span class="o">=</span>      <span class="n">xhci_hub_status_data</span><span class="p">,</span>
        <span class="p">.</span><span class="n">bus_suspend</span> <span class="o">=</span>          <span class="n">xhci_bus_suspend</span><span class="p">,</span>
        <span class="p">.</span><span class="n">bus_resume</span> <span class="o">=</span>           <span class="n">xhci_bus_resume</span><span class="p">,</span>
        <span class="p">.</span><span class="n">get_resuming_ports</span> <span class="o">=</span>   <span class="n">xhci_get_resuming_ports</span><span class="p">,</span>

        <span class="cm">/*
         * call back when device connected and addressed
         */</span>
        <span class="p">.</span><span class="n">update_device</span> <span class="o">=</span>        <span class="n">xhci_update_device</span><span class="p">,</span>
        <span class="p">.</span><span class="n">set_usb2_hw_lpm</span> <span class="o">=</span>      <span class="n">xhci_set_usb2_hardware_lpm</span><span class="p">,</span>
        <span class="p">.</span><span class="n">enable_usb3_lpm_timeout</span> <span class="o">=</span>      <span class="n">xhci_enable_usb3_lpm_timeout</span><span class="p">,</span>
        <span class="p">.</span><span class="n">disable_usb3_lpm_timeout</span> <span class="o">=</span>     <span class="n">xhci_disable_usb3_lpm_timeout</span><span class="p">,</span>
        <span class="p">.</span><span class="n">find_raw_port_number</span> <span class="o">=</span> <span class="n">xhci_find_raw_port_number</span><span class="p">,</span>
        <span class="p">.</span><span class="n">clear_tt_buffer_complete</span> <span class="o">=</span> <span class="n">xhci_clear_tt_buffer_complete</span><span class="p">,</span>
<span class="p">};</span>
</pre></td></tr></tbody></table></code></div></div>
<p>Because various USB controllers can adopt the xHCI specification,
to reduce boiler plate code,
Linux developers already implemented the generic operations
required to support xHCI spec.</p>

<p>When one has reference to the xhci_hc_driver
it can utilize all xHCI provided functionalities 
and doesn’t need to implement xHCI protocol 
on its driver implementation once again.</p>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre><span class="kt">void</span> <span class="nf">xhci_init_driver</span><span class="p">(</span><span class="k">struct</span> <span class="n">hc_driver</span> <span class="o">*</span><span class="n">drv</span><span class="p">,</span>
                      <span class="k">const</span> <span class="k">struct</span> <span class="n">xhci_driver_overrides</span> <span class="o">*</span><span class="n">over</span><span class="p">)</span>
<span class="p">{</span>
        <span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">over</span><span class="p">);</span>

        <span class="cm">/* Copy the generic table to drv then apply the overrides */</span>
        <span class="o">*</span><span class="n">drv</span> <span class="o">=</span> <span class="n">xhci_hc_driver</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">over</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">drv</span><span class="o">-&gt;</span><span class="n">hcd_priv_size</span> <span class="o">+=</span> <span class="n">over</span><span class="o">-&gt;</span><span class="n">extra_priv_size</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">over</span><span class="o">-&gt;</span><span class="n">reset</span><span class="p">)</span>
                        <span class="n">drv</span><span class="o">-&gt;</span><span class="n">reset</span> <span class="o">=</span> <span class="n">over</span><span class="o">-&gt;</span><span class="n">reset</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">over</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">)</span>
                        <span class="n">drv</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="n">over</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
        <span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">xhci_init_driver</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></div></div>
<p>The xHCI driver implementing the xhci_hc_driver doesn’t consume this structure,
but provide it to other drivers who want to utilize the xHCI specification.
In other words, 
xHCI driver is not designed to be bound to specific hardware module,
but a just kernel level driver 
designed to supports other usb host controllers.
To acheive that, it exports function <em>xhci_init_driver</em>.
When other device driver invokes this function,
the xhci_hc_driver’s reference is returned.</p>

<h3 id="xhci-platform-driver"><span class="me-2">xHCI platform driver</span><a href="#xhci-platform-driver" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre></td><td class="rouge-code"><pre><span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">usb_xhci_driver</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">.</span><span class="n">probe</span>  <span class="o">=</span> <span class="n">xhci_plat_probe</span><span class="p">,</span>
        <span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">xhci_plat_remove</span><span class="p">,</span>
        <span class="p">.</span><span class="n">shutdown</span> <span class="o">=</span> <span class="n">usb_hcd_platform_shutdown</span><span class="p">,</span>
        <span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
                <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">"xhci-hcd"</span><span class="p">,</span>
                <span class="p">.</span><span class="n">pm</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">xhci_plat_pm_ops</span><span class="p">,</span>
                <span class="p">.</span><span class="n">of_match_table</span> <span class="o">=</span> <span class="n">of_match_ptr</span><span class="p">(</span><span class="n">usb_xhci_of_match</span><span class="p">),</span>
                <span class="p">.</span><span class="n">acpi_match_table</span> <span class="o">=</span> <span class="n">ACPI_PTR</span><span class="p">(</span><span class="n">usb_xhci_acpi_match</span><span class="p">),</span>
        <span class="p">},</span>
<span class="p">};</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">"platform:xhci-hcd"</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">xhci_plat_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
        <span class="n">xhci_init_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xhci_plat_hc_driver</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xhci_plat_overrides</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">platform_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usb_xhci_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">xhci_init_driver</span><span class="p">(</span><span class="k">struct</span> <span class="n">hc_driver</span> <span class="o">*</span><span class="n">drv</span><span class="p">,</span>
                      <span class="k">const</span> <span class="k">struct</span> <span class="n">xhci_driver_overrides</span> <span class="o">*</span><span class="n">over</span><span class="p">)</span>
<span class="p">{</span>
        <span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">over</span><span class="p">);</span>

        <span class="cm">/* Copy the generic table to drv then apply the overrides */</span>
        <span class="o">*</span><span class="n">drv</span> <span class="o">=</span> <span class="n">xhci_hc_driver</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">over</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">drv</span><span class="o">-&gt;</span><span class="n">hcd_priv_size</span> <span class="o">+=</span> <span class="n">over</span><span class="o">-&gt;</span><span class="n">extra_priv_size</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">over</span><span class="o">-&gt;</span><span class="n">reset</span><span class="p">)</span>
                        <span class="n">drv</span><span class="o">-&gt;</span><span class="n">reset</span> <span class="o">=</span> <span class="n">over</span><span class="o">-&gt;</span><span class="n">reset</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">over</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">)</span>
                        <span class="n">drv</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="n">over</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
        <span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">xhci_init_driver</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></div></div>
<p>The paltform driver for xHCI host controller interface
invokes xhci_init_driver in its driver init function.
This allows the xhci-hcd driver to get reference of the xHCI core object for hc_driver, and 
also register the driver itself as platform driver.
Note that usb_xhci_driver is a driver for platform xHCI controller.</p>

<h3 id="dwc3"><span class="me-2">DWC3</span><a href="#dwc3" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>DWC3 is a SuperSpeed USB 3.0 controller developed by 
the Synopsys DesignWare.
In this posting this USB controller is used in our SoC
and probed by the device tree.</p>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td><td class="rouge-code"><pre><span class="cp">#ifdef CONFIG_OF
</span><span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">of_device_id</span> <span class="n">of_dwc3_match</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">{</span>
                <span class="p">.</span><span class="n">compatible</span> <span class="o">=</span> <span class="s">"snps,dwc3"</span>
        <span class="p">},</span>
        <span class="p">{</span>
                <span class="p">.</span><span class="n">compatible</span> <span class="o">=</span> <span class="s">"synopsys,dwc3"</span>
        <span class="p">},</span>
        <span class="p">{</span> <span class="p">},</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">of</span><span class="p">,</span> <span class="n">of_dwc3_match</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">dwc3_driver</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">.</span><span class="n">probe</span>          <span class="o">=</span> <span class="n">dwc3_probe</span><span class="p">,</span>
        <span class="p">.</span><span class="n">remove</span>         <span class="o">=</span> <span class="n">dwc3_remove</span><span class="p">,</span>
        <span class="p">.</span><span class="n">driver</span>         <span class="o">=</span> <span class="p">{</span>
                <span class="p">.</span><span class="n">name</span>   <span class="o">=</span> <span class="s">"dwc3"</span><span class="p">,</span>
                <span class="p">.</span><span class="n">of_match_table</span> <span class="o">=</span> <span class="n">of_match_ptr</span><span class="p">(</span><span class="n">of_dwc3_match</span><span class="p">),</span>
                <span class="p">.</span><span class="n">acpi_match_table</span> <span class="o">=</span> <span class="n">ACPI_PTR</span><span class="p">(</span><span class="n">dwc3_acpi_match</span><span class="p">),</span>
                <span class="p">.</span><span class="n">pm</span>     <span class="o">=</span> <span class="o">&amp;</span><span class="n">dwc3_dev_pm_ops</span><span class="p">,</span>
        <span class="p">},</span>
<span class="p">};</span>
<span class="n">module_platform_driver</span><span class="p">(</span><span class="n">dwc3_driver</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></div></div>

<p>When a device node in the device tree
has compatilbe string one of “snps,dwc3” or “synopsys,dwc3”
the pre-designated probe function, dwc3_probe will be invoked.</p>

<h3 id="dwc3-probe-function"><span class="me-2">DWC3 probe function</span><a href="#dwc3-probe-function" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>Let’s take a look at what happens when the DWC3 controller is found.</p>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
</pre></td><td class="rouge-code"><pre><span class="k">static</span> <span class="kt">int</span> <span class="nf">dwc3_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">struct</span> <span class="n">device</span>           <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">resource</span>         <span class="o">*</span><span class="n">res</span><span class="p">,</span> <span class="n">dwc_res</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">dwc3</span>             <span class="o">*</span><span class="n">dwc</span><span class="p">;</span>

        <span class="kt">int</span>                     <span class="n">ret</span><span class="p">;</span>

        <span class="kt">void</span> <span class="n">__iomem</span>            <span class="o">*</span><span class="n">regs</span><span class="p">;</span>

        <span class="n">dwc</span> <span class="o">=</span> <span class="n">devm_kzalloc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">dwc</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dwc</span><span class="p">)</span>
                <span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

        <span class="n">dwc</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">"missing memory resource</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
                <span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">dwc</span><span class="o">-&gt;</span><span class="n">xhci_resources</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">start</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
        <span class="n">dwc</span><span class="o">-&gt;</span><span class="n">xhci_resources</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">end</span> <span class="o">=</span> <span class="n">dwc</span><span class="o">-&gt;</span><span class="n">xhci_resources</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">start</span> <span class="o">+</span>
                                        <span class="n">DWC3_XHCI_REGS_END</span><span class="p">;</span>
        <span class="n">dwc</span><span class="o">-&gt;</span><span class="n">xhci_resources</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">flags</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>
        <span class="n">dwc</span><span class="o">-&gt;</span><span class="n">xhci_resources</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">name</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>

        <span class="cm">/*
         * Request memory region but exclude xHCI regs,
         * since it will be requested by the xhci-plat driver.
         */</span>
        <span class="n">dwc_res</span> <span class="o">=</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>
        <span class="n">dwc_res</span><span class="p">.</span><span class="n">start</span> <span class="o">+=</span> <span class="n">DWC3_GLOBALS_REGS_START</span><span class="p">;</span>

        <span class="n">regs</span> <span class="o">=</span> <span class="n">devm_ioremap_resource</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dwc_res</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">regs</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>

        <span class="n">dwc</span><span class="o">-&gt;</span><span class="n">regs</span>       <span class="o">=</span> <span class="n">regs</span><span class="p">;</span>
        <span class="n">dwc</span><span class="o">-&gt;</span><span class="n">regs_size</span>  <span class="o">=</span> <span class="n">resource_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dwc_res</span><span class="p">);</span>

        <span class="n">dwc3_get_properties</span><span class="p">(</span><span class="n">dwc</span><span class="p">);</span>

        <span class="n">dma_set_mask_and_coherent</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">dma_mask_bits</span><span class="p">));</span>

        <span class="n">dwc</span><span class="o">-&gt;</span><span class="n">reset</span> <span class="o">=</span> <span class="n">devm_reset_control_array_get</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">reset</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">reset</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">of_node</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="n">devm_clk_bulk_get_all</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">clks</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">EPROBE_DEFER</span><span class="p">)</span>
                        <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
                <span class="cm">/*
                 * Clocks are optional, but new DT platforms should support all
                 * clocks as required by the DT-binding.
                 */</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
                        <span class="n">dwc</span><span class="o">-&gt;</span><span class="n">num_clks</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="k">else</span>
                        <span class="n">dwc</span><span class="o">-&gt;</span><span class="n">num_clks</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>

        <span class="p">}</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">reset_control_deassert</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">reset</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

        <span class="n">ret</span> <span class="o">=</span> <span class="n">clk_bulk_prepare_enable</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">num_clks</span><span class="p">,</span> <span class="n">dwc</span><span class="o">-&gt;</span><span class="n">clks</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
                <span class="k">goto</span> <span class="n">assert_reset</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dwc3_core_is_valid</span><span class="p">(</span><span class="n">dwc</span><span class="p">))</span> <span class="p">{</span> 
                <span class="n">dev_err</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">"this is not a DesignWare USB3 DRD Core</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
                <span class="k">goto</span> <span class="n">disable_clks</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">dwc</span><span class="p">);</span>
        <span class="n">dwc3_cache_hwparams</span><span class="p">(</span><span class="n">dwc</span><span class="p">);</span>

        <span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

        <span class="n">pm_runtime_set_active</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
        <span class="n">pm_runtime_use_autosuspend</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
        <span class="n">pm_runtime_set_autosuspend_delay</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DWC3_DEFAULT_AUTOSUSPEND_DELAY</span><span class="p">);</span>
        <span class="n">pm_runtime_enable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">pm_runtime_get_sync</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">goto</span> <span class="n">err1</span><span class="p">;</span>

        <span class="n">pm_runtime_forbid</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

        <span class="n">ret</span> <span class="o">=</span> <span class="n">dwc3_alloc_event_buffers</span><span class="p">(</span><span class="n">dwc</span><span class="p">,</span> <span class="n">DWC3_EVENT_BUFFERS_SIZE</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">dev_err</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">"failed to allocate event buffers</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
                <span class="k">goto</span> <span class="n">err2</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">ret</span> <span class="o">=</span> <span class="n">dwc3_get_dr_mode</span><span class="p">(</span><span class="n">dwc</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
                <span class="k">goto</span> <span class="n">err3</span><span class="p">;</span>

        <span class="n">ret</span> <span class="o">=</span> <span class="n">dwc3_alloc_scratch_buffers</span><span class="p">(</span><span class="n">dwc</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
                <span class="k">goto</span> <span class="n">err3</span><span class="p">;</span>

        <span class="n">ret</span> <span class="o">=</span> <span class="n">dwc3_core_init</span><span class="p">(</span><span class="n">dwc</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EPROBE_DEFER</span><span class="p">)</span>
                        <span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">"failed to initialize core: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
                <span class="k">goto</span> <span class="n">err4</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">dwc3_check_params</span><span class="p">(</span><span class="n">dwc</span><span class="p">);</span>

        <span class="n">ret</span> <span class="o">=</span> <span class="n">dwc3_core_init_mode</span><span class="p">(</span><span class="n">dwc</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
                <span class="k">goto</span> <span class="n">err5</span><span class="p">;</span>

        <span class="n">dwc3_debugfs_init</span><span class="p">(</span><span class="n">dwc</span><span class="p">);</span>
        <span class="n">pm_runtime_put</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">...</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>
<p>The first priority of the dwc3_probe function is 
retrieving the memory mapped address of the dwc3 USB controller. 
This address should be specified in the device node of the DWC3 controller. 
When you look at the binding of the DWC3,
you can easily find that 
the first reg value of the DWC3 binding is 
a memory address of the DWC3 controller mapped on that system.
Therefore, by invoking <em>res = platform_get_resource(pdev, IORESOURCE_MEM, 0)</em>
you can retrieve the memory mapped address of the DWC3 controller.</p>

<p>This address region not only contains xHCI information, but also DWC3 specific registers. 
Because we will defer to the xHCI driver 
on discovering its registers and configuring xHCI specific settings,
we will skip the memory region containing the xHCI registers
by adding predefined DWC3 offset
(dwc_res.start += DWC3_GLOBALS_REGS_START).</p>

<p>Because currently accessible address is physically mapped DWC3 register address,
we need to let the kernel translate this address and 
generate kernel virtual address. 
To achieve it,
it invoke sdevm_ioremap_resource function. 
After this function is invokes, 
we can access the DWC3 register as if
it resides on the virtual memory of the kernel.</p>

<p>After the successful ioremap,
dwc3_cache_hwparams function reads the DWC3 configuration registers 
and stores them in the dwc3 structure object
as a cache.
The reason of having cache is reading those information from the actual memory
is much faster than reading them from the memory mapped DWC3’s actual registers.</p>
<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre><span class="k">static</span> <span class="kt">void</span> <span class="nf">dwc3_cache_hwparams</span><span class="p">(</span><span class="k">struct</span> <span class="n">dwc3</span> <span class="o">*</span><span class="n">dwc</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">struct</span> <span class="n">dwc3_hwparams</span>    <span class="o">*</span><span class="n">parms</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">hwparams</span><span class="p">;</span>

        <span class="n">parms</span><span class="o">-&gt;</span><span class="n">hwparams0</span> <span class="o">=</span> <span class="n">dwc3_readl</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">DWC3_GHWPARAMS0</span><span class="p">);</span>
        <span class="n">parms</span><span class="o">-&gt;</span><span class="n">hwparams1</span> <span class="o">=</span> <span class="n">dwc3_readl</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">DWC3_GHWPARAMS1</span><span class="p">);</span>
        <span class="n">parms</span><span class="o">-&gt;</span><span class="n">hwparams2</span> <span class="o">=</span> <span class="n">dwc3_readl</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">DWC3_GHWPARAMS2</span><span class="p">);</span>
        <span class="n">parms</span><span class="o">-&gt;</span><span class="n">hwparams3</span> <span class="o">=</span> <span class="n">dwc3_readl</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">DWC3_GHWPARAMS3</span><span class="p">);</span>
        <span class="n">parms</span><span class="o">-&gt;</span><span class="n">hwparams4</span> <span class="o">=</span> <span class="n">dwc3_readl</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">DWC3_GHWPARAMS4</span><span class="p">);</span>
        <span class="n">parms</span><span class="o">-&gt;</span><span class="n">hwparams5</span> <span class="o">=</span> <span class="n">dwc3_readl</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">DWC3_GHWPARAMS5</span><span class="p">);</span>
        <span class="n">parms</span><span class="o">-&gt;</span><span class="n">hwparams6</span> <span class="o">=</span> <span class="n">dwc3_readl</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">DWC3_GHWPARAMS6</span><span class="p">);</span>
        <span class="n">parms</span><span class="o">-&gt;</span><span class="n">hwparams7</span> <span class="o">=</span> <span class="n">dwc3_readl</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">DWC3_GHWPARAMS7</span><span class="p">);</span>
        <span class="n">parms</span><span class="o">-&gt;</span><span class="n">hwparams8</span> <span class="o">=</span> <span class="n">dwc3_readl</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">DWC3_GHWPARAMS8</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>
<p>The registers read by the above function are 
GHWPARAMS0 to GHWPARAMS7 which are Global Hardware Parameters registers.
These registers contain all the information
required to initialize the DWC3 device driver.
The detailed information about those registers are described in the DWC3 specification.</p>

<p>The GHWPARAMS0 register read from dwc3_cache_hwparams function
is used to determine the mode of the DWC3 controller.
There are three different types of mode:
Device-only, Host-only, and  Dual-role device (DRD).</p>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
</pre></td><td class="rouge-code"><pre><span class="k">static</span> <span class="kt">int</span> <span class="nf">dwc3_get_dr_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">dwc3</span> <span class="o">*</span><span class="n">dwc</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">enum</span> <span class="n">usb_dr_mode</span> <span class="n">mode</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hw_mode</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">dr_mode</span> <span class="o">==</span> <span class="n">USB_DR_MODE_UNKNOWN</span><span class="p">)</span>
                <span class="n">dwc</span><span class="o">-&gt;</span><span class="n">dr_mode</span> <span class="o">=</span> <span class="n">USB_DR_MODE_OTG</span><span class="p">;</span>

        <span class="n">mode</span> <span class="o">=</span> <span class="n">dwc</span><span class="o">-&gt;</span><span class="n">dr_mode</span><span class="p">;</span>
        <span class="n">hw_mode</span> <span class="o">=</span> <span class="n">DWC3_GHWPARAMS0_MODE</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">hwparams</span><span class="p">.</span><span class="n">hwparams0</span><span class="p">);</span>

        <span class="k">switch</span> <span class="p">(</span><span class="n">hw_mode</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">case</span> <span class="n">DWC3_GHWPARAMS0_MODE_GADGET</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">IS_ENABLED</span><span class="p">(</span><span class="n">CONFIG_USB_DWC3_HOST</span><span class="p">))</span> <span class="p">{</span>
                        <span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
                                <span class="s">"Controller does not support host mode.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
                        <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="n">mode</span> <span class="o">=</span> <span class="n">USB_DR_MODE_PERIPHERAL</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="n">DWC3_GHWPARAMS0_MODE_HOST</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">IS_ENABLED</span><span class="p">(</span><span class="n">CONFIG_USB_DWC3_GADGET</span><span class="p">))</span> <span class="p">{</span>
                        <span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
                                <span class="s">"Controller does not support device mode.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
                        <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="n">mode</span> <span class="o">=</span> <span class="n">USB_DR_MODE_HOST</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
        <span class="nl">default:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">IS_ENABLED</span><span class="p">(</span><span class="n">CONFIG_USB_DWC3_HOST</span><span class="p">))</span>
                        <span class="n">mode</span> <span class="o">=</span> <span class="n">USB_DR_MODE_HOST</span><span class="p">;</span>
                <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_ENABLED</span><span class="p">(</span><span class="n">CONFIG_USB_DWC3_GADGET</span><span class="p">))</span>
                        <span class="n">mode</span> <span class="o">=</span> <span class="n">USB_DR_MODE_PERIPHERAL</span><span class="p">;</span>

                <span class="cm">/*
                 * DWC_usb31 and DWC_usb3 v3.30a and higher do not support OTG
                 * mode. If the controller supports DRD but the dr_mode is not
                 * specified or set to OTG, then set the mode to peripheral.
                 */</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">USB_DR_MODE_OTG</span> <span class="o">&amp;&amp;</span>
                    <span class="p">(</span><span class="o">!</span><span class="n">IS_ENABLED</span><span class="p">(</span><span class="n">CONFIG_USB_ROLE_SWITCH</span><span class="p">)</span> <span class="o">||</span>
                     <span class="o">!</span><span class="n">device_property_read_bool</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">"usb-role-switch"</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
                    <span class="o">!</span><span class="n">DWC3_VER_IS_PRIOR</span><span class="p">(</span><span class="n">DWC3</span><span class="p">,</span> <span class="mi">330</span><span class="n">A</span><span class="p">))</span>
                        <span class="n">mode</span> <span class="o">=</span> <span class="n">USB_DR_MODE_PERIPHERAL</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">dwc</span><span class="o">-&gt;</span><span class="n">dr_mode</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">dev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
                         <span class="s">"Configuration mismatch. dr_mode forced to %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
                         <span class="n">mode</span> <span class="o">==</span> <span class="n">USB_DR_MODE_HOST</span> <span class="o">?</span> <span class="s">"host"</span> <span class="o">:</span> <span class="s">"gadget"</span><span class="p">);</span>

                <span class="n">dwc</span><span class="o">-&gt;</span><span class="n">dr_mode</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>
<p>The above function determines the operation mode of the DWC3
Based on this mode, dwc3 core can be initialized in different way.</p>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
</pre></td><td class="rouge-code"><pre><span class="n">tatic</span> <span class="kt">int</span> <span class="nf">dwc3_core_init_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">dwc3</span> <span class="o">*</span><span class="n">dwc</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

        <span class="k">switch</span> <span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">dr_mode</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">case</span> <span class="n">USB_DR_MODE_PERIPHERAL</span><span class="p">:</span>
                <span class="n">dwc3_set_prtcap</span><span class="p">(</span><span class="n">dwc</span><span class="p">,</span> <span class="n">DWC3_GCTL_PRTCAP_DEVICE</span><span class="p">);</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">usb2_phy</span><span class="p">)</span>
                        <span class="n">otg_set_vbus</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">usb2_phy</span><span class="o">-&gt;</span><span class="n">otg</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
                <span class="n">phy_set_mode</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">usb2_generic_phy</span><span class="p">,</span> <span class="n">PHY_MODE_USB_DEVICE</span><span class="p">);</span>
                <span class="n">phy_set_mode</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">usb3_generic_phy</span><span class="p">,</span> <span class="n">PHY_MODE_USB_DEVICE</span><span class="p">);</span>

                <span class="n">ret</span> <span class="o">=</span> <span class="n">dwc3_gadget_init</span><span class="p">(</span><span class="n">dwc</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EPROBE_DEFER</span><span class="p">)</span>
                                <span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">"failed to initialize gadget</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
                        <span class="n">eeturn</span> <span class="n">ret</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="n">USB_DR_MODE_HOST</span><span class="p">:</span>
                <span class="n">dwc3_set_prtcap</span><span class="p">(</span><span class="n">dwc</span><span class="p">,</span> <span class="n">DWC3_GCTL_PRTCAP_HOST</span><span class="p">);</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">usb2_phy</span><span class="p">)</span>
                        <span class="n">otg_set_vbus</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">usb2_phy</span><span class="o">-&gt;</span><span class="n">otg</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
                <span class="n">phy_set_mode</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">usb2_generic_phy</span><span class="p">,</span> <span class="n">PHY_MODE_USB_HOST</span><span class="p">);</span>
                <span class="n">phy_set_mode</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">usb3_generic_phy</span><span class="p">,</span> <span class="n">PHY_MODE_USB_HOST</span><span class="p">);</span>

                <span class="n">ret</span> <span class="o">=</span> <span class="n">dwc3_host_init</span><span class="p">(</span><span class="n">dwc</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EPROBE_DEFER</span><span class="p">)</span>
                                <span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">"failed to initialize host</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
                        <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="n">USB_DR_MODE_OTG</span><span class="p">:</span>
                <span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">drd_work</span><span class="p">,</span> <span class="n">__dwc3_set_mode</span><span class="p">);</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="n">dwc3_drd_init</span><span class="p">(</span><span class="n">dwc</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EPROBE_DEFER</span><span class="p">)</span>
                                <span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">"failed to initialize dual-role</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
                        <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">break</span><span class="p">;</span>
        <span class="nl">default:</span>
                <span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">"Unsupported mode of operation %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">dwc</span><span class="o">-&gt;</span><span class="n">dr_mode</span><span class="p">);</span>
                <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>
<p>When the dr_mode is set as USB_DR_MODE_HOST,
it invokes dwc_host_init function
which register xHCI device!</p>

<h3 id="dwc3-host-init-allocate-xhci-hcd-platform-device"><span class="me-2">dwc3 host init-allocate xhci-hcd platform device</span><a href="#dwc3-host-init-allocate-xhci-hcd-platform-device" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
</pre></td><td class="rouge-code"><pre><span class="kt">int</span> <span class="nf">dwc3_host_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">dwc3</span> <span class="o">*</span><span class="n">dwc</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">struct</span> <span class="n">property_entry</span>   <span class="n">props</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
        <span class="k">struct</span> <span class="n">platform_device</span>  <span class="o">*</span><span class="n">xhci</span><span class="p">;</span>
        <span class="kt">int</span>                     <span class="n">ret</span><span class="p">,</span> <span class="n">irq</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">resource</span>         <span class="o">*</span><span class="n">res</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">platform_device</span>  <span class="o">*</span><span class="n">dwc3_pdev</span> <span class="o">=</span> <span class="n">to_platform_device</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
        <span class="kt">int</span>                     <span class="n">prop_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

        <span class="n">irq</span> <span class="o">=</span> <span class="n">dwc3_host_get_irq</span><span class="p">(</span><span class="n">dwc</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">irq</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">irq</span><span class="p">;</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">platform_get_resource_byname</span><span class="p">(</span><span class="n">dwc3_pdev</span><span class="p">,</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span> <span class="s">"host"</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">platform_get_resource_byname</span><span class="p">(</span><span class="n">dwc3_pdev</span><span class="p">,</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
                                <span class="s">"dwc_usb3"</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">dwc3_pdev</span><span class="p">,</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span>
                <span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

        <span class="n">dwc</span><span class="o">-&gt;</span><span class="n">xhci_resources</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">start</span> <span class="o">=</span> <span class="n">irq</span><span class="p">;</span>
        <span class="n">dwc</span><span class="o">-&gt;</span><span class="n">xhci_resources</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">end</span> <span class="o">=</span> <span class="n">irq</span><span class="p">;</span>
        <span class="n">dwc</span><span class="o">-&gt;</span><span class="n">xhci_resources</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">flags</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>
        <span class="n">dwc</span><span class="o">-&gt;</span><span class="n">xhci_resources</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">name</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>

        <span class="n">xhci</span> <span class="o">=</span> <span class="n">platform_device_alloc</span><span class="p">(</span><span class="s">"xhci-hcd"</span><span class="p">,</span> <span class="n">PLATFORM_DEVID_AUTO</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xhci</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">dev_err</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">"couldn't allocate xHCI device</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
                <span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">xhci</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span>        <span class="o">=</span> <span class="n">dwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
        <span class="n">ACPI_COMPANION_SET</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xhci</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">ACPI_COMPANION</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">));</span>

        <span class="n">dwc</span><span class="o">-&gt;</span><span class="n">xhci</span> <span class="o">=</span> <span class="n">xhci</span><span class="p">;</span>

        <span class="n">ret</span> <span class="o">=</span> <span class="n">platform_device_add_resources</span><span class="p">(</span><span class="n">xhci</span><span class="p">,</span> <span class="n">dwc</span><span class="o">-&gt;</span><span class="n">xhci_resources</span><span class="p">,</span>
                                                <span class="n">DWC3_XHCI_RESOURCES_NUM</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">dev_err</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">"couldn't add resources to xHCI device</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
                <span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">memset</span><span class="p">(</span><span class="n">props</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">property_entry</span><span class="p">)</span> <span class="o">*</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">props</span><span class="p">));</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">usb3_lpm_capable</span><span class="p">)</span>
                <span class="n">props</span><span class="p">[</span><span class="n">prop_idx</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">PROPERTY_ENTRY_BOOL</span><span class="p">(</span><span class="s">"usb3-lpm-capable"</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">usb2_lpm_disable</span><span class="p">)</span>
                <span class="n">props</span><span class="p">[</span><span class="n">prop_idx</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">PROPERTY_ENTRY_BOOL</span><span class="p">(</span><span class="s">"usb2-lpm-disable"</span><span class="p">);</span>

        <span class="cm">/**
         * WORKAROUND: dwc3 revisions &lt;=3.00a have a limitation
         * where Port Disable command doesn't work.
         *
         * The suggested workaround is that we avoid Port Disable
         * completely.
         *
         * This following flag tells XHCI to do just that.
         */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">DWC3_VER_IS_WITHIN</span><span class="p">(</span><span class="n">DWC3</span><span class="p">,</span> <span class="n">ANY</span><span class="p">,</span> <span class="mi">300</span><span class="n">A</span><span class="p">))</span>
                <span class="n">props</span><span class="p">[</span><span class="n">prop_idx</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">PROPERTY_ENTRY_BOOL</span><span class="p">(</span><span class="s">"quirk-broken-port-ped"</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">prop_idx</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="n">platform_device_add_properties</span><span class="p">(</span><span class="n">xhci</span><span class="p">,</span> <span class="n">props</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">dev_err</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">"failed to add properties to xHCI</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
                        <span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
                <span class="p">}</span>
        <span class="p">}</span>

        <span class="n">ret</span> <span class="o">=</span> <span class="n">platform_device_add</span><span class="p">(</span><span class="n">xhci</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">dev_err</span><span class="p">(</span><span class="n">dwc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">"failed to register xHCI device</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
                <span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err:</span>
        <span class="n">platform_device_put</span><span class="p">(</span><span class="n">xhci</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>
<p>It invokes platform_device_alloc(“xhci-hcd”, PLATFORM_DEVID_AUTO) function
which allocates and register the platform device.
Note that the device name “xhci-hcd” is the name of the device driver 
that we’ve explored before.
Yes this is the name of usb_xhci_driver
which will be used to bind the allocated device to the driver. 
After the xHCI device is allocated,
it registers the generated device to the platform bus
by invoking platform_device_add function.
This function invokes device_add function, and
because the autoprobe flag is enabled for the platform bus,
its corresponding driver’s bind function will be invoked.</p>

<h2 id="lets-go-back-to-usb_xhi_driver-again"><span class="me-2">Let’s go back to usb_xhi_driver again!</span><a href="#lets-go-back-to-usb_xhi_driver-again" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<p>Because the generated platform device doesn’t have of_match table,
it will utilize the name of the device “xhci-hcd” and
will bound to the usb_xhci_driver.</p>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
</pre></td><td class="rouge-code"><pre><span class="k">static</span> <span class="kt">int</span> <span class="nf">xhci_plat_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">const</span> <span class="k">struct</span> <span class="n">xhci_plat_priv</span> <span class="o">*</span><span class="n">priv_match</span><span class="p">;</span>
        <span class="k">const</span> <span class="k">struct</span> <span class="n">hc_driver</span>  <span class="o">*</span><span class="n">driver</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">device</span>           <span class="o">*</span><span class="n">sysdev</span><span class="p">,</span> <span class="o">*</span><span class="n">tmpdev</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">xhci_hcd</span>         <span class="o">*</span><span class="n">xhci</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">resource</span>         <span class="o">*</span><span class="n">res</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">usb_hcd</span>          <span class="o">*</span><span class="n">hcd</span><span class="p">;</span>
        <span class="kt">int</span>                     <span class="n">ret</span><span class="p">;</span>
        <span class="kt">int</span>                     <span class="n">irq</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">xhci_plat_priv</span>   <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>


        <span class="k">if</span> <span class="p">(</span><span class="n">usb_disabled</span><span class="p">())</span>
                <span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

        <span class="n">driver</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">xhci_plat_hc_driver</span><span class="p">;</span>

        <span class="n">irq</span> <span class="o">=</span> <span class="n">platform_get_irq</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">irq</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">irq</span><span class="p">;</span>

        <span class="cm">/*
         * sysdev must point to a device that is known to the system firmware
         * or PCI hardware. We handle these three cases here:
         * 1. xhci_plat comes from firmware
         * 2. xhci_plat is child of a device from firmware (dwc3-plat)
         * 3. xhci_plat is grandchild of a pci device (dwc3-pci)
         */</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">sysdev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span> <span class="n">sysdev</span><span class="p">;</span> <span class="n">sysdev</span> <span class="o">=</span> <span class="n">sysdev</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">is_of_node</span><span class="p">(</span><span class="n">sysdev</span><span class="o">-&gt;</span><span class="n">fwnode</span><span class="p">)</span> <span class="o">||</span>
                        <span class="n">is_acpi_device_node</span><span class="p">(</span><span class="n">sysdev</span><span class="o">-&gt;</span><span class="n">fwnode</span><span class="p">))</span>
                        <span class="k">break</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_PCI
</span>                <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sysdev</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">pci_bus_type</span><span class="p">)</span>
                        <span class="k">break</span><span class="p">;</span>
<span class="cp">#endif
</span>        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sysdev</span><span class="p">)</span>
                <span class="n">sysdev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

        <span class="cm">/* Try to set 64-bit DMA first */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">sysdev</span><span class="o">-&gt;</span><span class="n">dma_mask</span><span class="p">))</span>
                <span class="cm">/* Platform did not initialize dma_mask */</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="n">dma_coerce_mask_and_coherent</span><span class="p">(</span><span class="n">sysdev</span><span class="p">,</span>
                                                   <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">64</span><span class="p">));</span>
        <span class="k">else</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="n">dma_set_mask_and_coherent</span><span class="p">(</span><span class="n">sysdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">64</span><span class="p">));</span>

        <span class="cm">/* If seting 64-bit DMA mask fails, fall back to 32-bit DMA mask */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="n">dma_set_mask_and_coherent</span><span class="p">(</span><span class="n">sysdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">));</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
                        <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">pm_runtime_set_active</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
        <span class="n">pm_runtime_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
        <span class="n">pm_runtime_get_noresume</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

        <span class="n">hcd</span> <span class="o">=</span> <span class="n">__usb_create_hcd</span><span class="p">(</span><span class="n">driver</span><span class="p">,</span> <span class="n">sysdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
                               <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hcd</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
                <span class="k">goto</span> <span class="n">disable_runtime</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">hcd</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">=</span> <span class="n">devm_platform_get_and_ioremap_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">))</span> <span class="p">{</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">);</span>
                <span class="k">goto</span> <span class="n">put_hcd</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">hcd</span><span class="o">-&gt;</span><span class="n">rsrc_start</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
        <span class="n">hcd</span><span class="o">-&gt;</span><span class="n">rsrc_len</span> <span class="o">=</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>

        <span class="n">xhci</span> <span class="o">=</span> <span class="n">hcd_to_xhci</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>

        <span class="cm">/*
         * Not all platforms have clks so it is not an error if the
         * clock do not exist.
         */</span>
        <span class="n">xhci</span><span class="o">-&gt;</span><span class="n">reg_clk</span> <span class="o">=</span> <span class="n">devm_clk_get_optional</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">"reg"</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">xhci</span><span class="o">-&gt;</span><span class="n">reg_clk</span><span class="p">))</span> <span class="p">{</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">xhci</span><span class="o">-&gt;</span><span class="n">reg_clk</span><span class="p">);</span>
                <span class="k">goto</span> <span class="n">put_hcd</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">ret</span> <span class="o">=</span> <span class="n">clk_prepare_enable</span><span class="p">(</span><span class="n">xhci</span><span class="o">-&gt;</span><span class="n">reg_clk</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
                <span class="k">goto</span> <span class="n">put_hcd</span><span class="p">;</span>

        <span class="n">xhci</span><span class="o">-&gt;</span><span class="n">clk</span> <span class="o">=</span> <span class="n">devm_clk_get_optional</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">xhci</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">))</span> <span class="p">{</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">xhci</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
                <span class="k">goto</span> <span class="n">disable_reg_clk</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">ret</span> <span class="o">=</span> <span class="n">clk_prepare_enable</span><span class="p">(</span><span class="n">xhci</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
                <span class="k">goto</span> <span class="n">disable_reg_clk</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">)</span>
                <span class="n">priv_match</span> <span class="o">=</span> <span class="n">of_device_get_match_data</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
        <span class="k">else</span>
                <span class="n">priv_match</span> <span class="o">=</span> <span class="n">dev_get_platdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">priv_match</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">priv</span> <span class="o">=</span> <span class="n">hcd_to_xhci_priv</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
                <span class="cm">/* Just copy data for now */</span>
                <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="o">*</span><span class="n">priv_match</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">device_set_wakeup_capable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

        <span class="n">xhci</span><span class="o">-&gt;</span><span class="n">main_hcd</span> <span class="o">=</span> <span class="n">hcd</span><span class="p">;</span>
        <span class="n">xhci</span><span class="o">-&gt;</span><span class="n">shared_hcd</span> <span class="o">=</span> <span class="n">__usb_create_hcd</span><span class="p">(</span><span class="n">driver</span><span class="p">,</span> <span class="n">sysdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
                        <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span> <span class="n">hcd</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xhci</span><span class="o">-&gt;</span><span class="n">shared_hcd</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
                <span class="k">goto</span> <span class="n">disable_clk</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="cm">/* imod_interval is the interrupt moderation value in nanoseconds. */</span>
        <span class="n">xhci</span><span class="o">-&gt;</span><span class="n">imod_interval</span> <span class="o">=</span> <span class="mi">40000</span><span class="p">;</span>

        <span class="cm">/* Iterate over all parent nodes for finding quirks */</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">tmpdev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span> <span class="n">tmpdev</span><span class="p">;</span> <span class="n">tmpdev</span> <span class="o">=</span> <span class="n">tmpdev</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">)</span> <span class="p">{</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">device_property_read_bool</span><span class="p">(</span><span class="n">tmpdev</span><span class="p">,</span> <span class="s">"usb2-lpm-disable"</span><span class="p">))</span>
                        <span class="n">xhci</span><span class="o">-&gt;</span><span class="n">quirks</span> <span class="o">|=</span> <span class="n">XHCI_HW_LPM_DISABLE</span><span class="p">;</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">device_property_read_bool</span><span class="p">(</span><span class="n">tmpdev</span><span class="p">,</span> <span class="s">"usb3-lpm-capable"</span><span class="p">))</span>
                        <span class="n">xhci</span><span class="o">-&gt;</span><span class="n">quirks</span> <span class="o">|=</span> <span class="n">XHCI_LPM_SUPPORT</span><span class="p">;</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">device_property_read_bool</span><span class="p">(</span><span class="n">tmpdev</span><span class="p">,</span> <span class="s">"quirk-broken-port-ped"</span><span class="p">))</span>
                        <span class="n">xhci</span><span class="o">-&gt;</span><span class="n">quirks</span> <span class="o">|=</span> <span class="n">XHCI_BROKEN_PORT_PED</span><span class="p">;</span>

                <span class="n">device_property_read_u32</span><span class="p">(</span><span class="n">tmpdev</span><span class="p">,</span> <span class="s">"imod-interval-ns"</span><span class="p">,</span>
                                         <span class="o">&amp;</span><span class="n">xhci</span><span class="o">-&gt;</span><span class="n">imod_interval</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="n">hcd</span><span class="o">-&gt;</span><span class="n">usb_phy</span> <span class="o">=</span> <span class="n">devm_usb_get_phy_by_phandle</span><span class="p">(</span><span class="n">sysdev</span><span class="p">,</span> <span class="s">"usb-phy"</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">usb_phy</span><span class="p">))</span> <span class="p">{</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">usb_phy</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">EPROBE_DEFER</span><span class="p">)</span>
                        <span class="k">goto</span> <span class="n">put_usb3_hcd</span><span class="p">;</span>
                <span class="n">hcd</span><span class="o">-&gt;</span><span class="n">usb_phy</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="n">usb_phy_init</span><span class="p">(</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">usb_phy</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
                        <span class="k">goto</span> <span class="n">put_usb3_hcd</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">hcd</span><span class="o">-&gt;</span><span class="n">tpl_support</span> <span class="o">=</span> <span class="n">of_usb_host_tpl_support</span><span class="p">(</span><span class="n">sysdev</span><span class="o">-&gt;</span><span class="n">of_node</span><span class="p">);</span>
        <span class="n">xhci</span><span class="o">-&gt;</span><span class="n">shared_hcd</span><span class="o">-&gt;</span><span class="n">tpl_support</span> <span class="o">=</span> <span class="n">hcd</span><span class="o">-&gt;</span><span class="n">tpl_support</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">priv</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">quirks</span> <span class="o">&amp;</span> <span class="n">XHCI_SKIP_PHY_INIT</span><span class="p">))</span>
                <span class="n">hcd</span><span class="o">-&gt;</span><span class="n">skip_phy_initialization</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">priv</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">quirks</span> <span class="o">&amp;</span> <span class="n">XHCI_SG_TRB_CACHE_SIZE_QUIRK</span><span class="p">))</span>
                <span class="n">xhci</span><span class="o">-&gt;</span><span class="n">quirks</span> <span class="o">|=</span> <span class="n">XHCI_SG_TRB_CACHE_SIZE_QUIRK</span><span class="p">;</span>

        <span class="n">ret</span> <span class="o">=</span> <span class="n">usb_add_hcd</span><span class="p">(</span><span class="n">hcd</span><span class="p">,</span> <span class="n">irq</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
                <span class="k">goto</span> <span class="n">disable_usb_phy</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">HCC_MAX_PSA</span><span class="p">(</span><span class="n">xhci</span><span class="o">-&gt;</span><span class="n">hcc_params</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span>
                <span class="n">xhci</span><span class="o">-&gt;</span><span class="n">shared_hcd</span><span class="o">-&gt;</span><span class="n">can_do_streams</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

        <span class="n">ret</span> <span class="o">=</span> <span class="n">usb_add_hcd</span><span class="p">(</span><span class="n">xhci</span><span class="o">-&gt;</span><span class="n">shared_hcd</span><span class="p">,</span> <span class="n">irq</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
                <span class="k">goto</span> <span class="n">dealloc_usb2_hcd</span><span class="p">;</span>

        <span class="n">device_enable_async_suspend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
        <span class="n">pm_runtime_put_noidle</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

        <span class="cm">/*
         * Prevent runtime pm from being on as default, users should enable
         * runtime pm using power/control in sysfs.
         */</span>
        <span class="n">pm_runtime_forbid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>


<span class="nl">dealloc_usb2_hcd:</span>
        <span class="n">usb_remove_hcd</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>

<span class="nl">disable_usb_phy:</span>
        <span class="n">usb_phy_shutdown</span><span class="p">(</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">usb_phy</span><span class="p">);</span>

<span class="nl">put_usb3_hcd:</span>
        <span class="n">usb_put_hcd</span><span class="p">(</span><span class="n">xhci</span><span class="o">-&gt;</span><span class="n">shared_hcd</span><span class="p">);</span>

<span class="nl">disable_clk:</span>
        <span class="n">clk_disable_unprepare</span><span class="p">(</span><span class="n">xhci</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>

<span class="nl">disable_reg_clk:</span>
        <span class="n">clk_disable_unprepare</span><span class="p">(</span><span class="n">xhci</span><span class="o">-&gt;</span><span class="n">reg_clk</span><span class="p">);</span>

<span class="nl">put_hcd:</span>
        <span class="n">usb_put_hcd</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>

<span class="nl">disable_runtime:</span>
        <span class="n">pm_runtime_put_noidle</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
        <span class="n">pm_runtime_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

        <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>
<p>The probe function firstly assigns the xhci_plat_hc_driver object 
to the driver local variable. 
Remember that 
xhci_plat_hc_driver object is intialized 
to contain the reference of xhci core hc_driver
at the module loading time.</p>

<h3 id="xhci-platform-probe---registering-root-hub"><span class="me-2">xHCI platform probe - registering root hub</span><a href="#xhci-platform-probe---registering-root-hub" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>XXXTODO!!
###Registering root hub from the controller</p>
<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
</pre></td><td class="rouge-code"><pre><span class="cm">/**
 * usb_add_hcd - finish generic HCD structure initialization and register
 * @hcd: the usb_hcd structure to initialize
 * @irqnum: Interrupt line to allocate
 * @irqflags: Interrupt type flags
 *
 * Finish the remaining parts of generic HCD initialization: allocate the
 * buffers of consistent memory, register the bus, request the IRQ line,
 * and call the driver's reset() and start() routines.
 */</span>
<span class="kt">int</span> <span class="nf">usb_add_hcd</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_hcd</span> <span class="o">*</span><span class="n">hcd</span><span class="p">,</span>
                <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irqnum</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">irqflags</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">rhdev</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">skip_phy_initialization</span> <span class="o">&amp;&amp;</span> <span class="n">usb_hcd_is_primary_hcd</span><span class="p">(</span><span class="n">hcd</span><span class="p">))</span> <span class="p">{</span>
                <span class="n">hcd</span><span class="o">-&gt;</span><span class="n">phy_roothub</span> <span class="o">=</span> <span class="n">usb_phy_roothub_alloc</span><span class="p">(</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">.</span><span class="n">sysdev</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">phy_roothub</span><span class="p">))</span>
                        <span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">phy_roothub</span><span class="p">);</span>

                <span class="n">retval</span> <span class="o">=</span> <span class="n">usb_phy_roothub_init</span><span class="p">(</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">phy_roothub</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
                        <span class="k">return</span> <span class="n">retval</span><span class="p">;</span>

                <span class="n">retval</span> <span class="o">=</span> <span class="n">usb_phy_roothub_set_mode</span><span class="p">(</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">phy_roothub</span><span class="p">,</span>
                                                  <span class="n">PHY_MODE_USB_HOST_SS</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
                        <span class="n">retval</span> <span class="o">=</span> <span class="n">usb_phy_roothub_set_mode</span><span class="p">(</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">phy_roothub</span><span class="p">,</span>
                                                          <span class="n">PHY_MODE_USB_HOST</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
                        <span class="k">goto</span> <span class="n">err_usb_phy_roothub_power_on</span><span class="p">;</span>

                <span class="n">retval</span> <span class="o">=</span> <span class="n">usb_phy_roothub_power_on</span><span class="p">(</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">phy_roothub</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
                        <span class="k">goto</span> <span class="n">err_usb_phy_roothub_power_on</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">dev_info</span><span class="p">(</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">.</span><span class="n">controller</span><span class="p">,</span> <span class="s">"%s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">hcd</span><span class="o">-&gt;</span><span class="n">product_desc</span><span class="p">);</span>

        <span class="k">switch</span> <span class="p">(</span><span class="n">authorized_default</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">case</span> <span class="n">USB_AUTHORIZE_NONE</span><span class="p">:</span>
                <span class="n">hcd</span><span class="o">-&gt;</span><span class="n">dev_policy</span> <span class="o">=</span> <span class="n">USB_DEVICE_AUTHORIZE_NONE</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>

        <span class="k">case</span> <span class="n">USB_AUTHORIZE_ALL</span><span class="p">:</span>
                <span class="n">hcd</span><span class="o">-&gt;</span><span class="n">dev_policy</span> <span class="o">=</span> <span class="n">USB_DEVICE_AUTHORIZE_ALL</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>

        <span class="k">case</span> <span class="n">USB_AUTHORIZE_INTERNAL</span><span class="p">:</span>
                <span class="n">hcd</span><span class="o">-&gt;</span><span class="n">dev_policy</span> <span class="o">=</span> <span class="n">USB_DEVICE_AUTHORIZE_INTERNAL</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>

        <span class="k">case</span> <span class="n">USB_AUTHORIZE_WIRED</span><span class="p">:</span>
        <span class="nl">default:</span>
                <span class="n">hcd</span><span class="o">-&gt;</span><span class="n">dev_policy</span> <span class="o">=</span> <span class="n">hcd</span><span class="o">-&gt;</span><span class="n">wireless</span> <span class="o">?</span>
                        <span class="n">USB_DEVICE_AUTHORIZE_NONE</span> <span class="o">:</span> <span class="n">USB_DEVICE_AUTHORIZE_ALL</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">set_bit</span><span class="p">(</span><span class="n">HCD_FLAG_HW_ACCESSIBLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

        <span class="cm">/* per default all interfaces are authorized */</span>
        <span class="n">set_bit</span><span class="p">(</span><span class="n">HCD_FLAG_INTF_AUTHORIZED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

        <span class="cm">/* HC is in reset state, but accessible.  Now do the one-time init,
         * bottom up so that hcds can customize the root hubs before hub_wq
         * starts talking to them.  (Note, bus id is assigned early too.)
         */</span>
        <span class="n">retval</span> <span class="o">=</span> <span class="n">hcd_buffer_create</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">dev_dbg</span><span class="p">(</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">.</span><span class="n">sysdev</span><span class="p">,</span> <span class="s">"pool alloc failed</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
                <span class="k">goto</span> <span class="n">err_create_buf</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">retval</span> <span class="o">=</span> <span class="n">usb_register_bus</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">goto</span> <span class="n">err_register_bus</span><span class="p">;</span>

        <span class="n">rhdev</span> <span class="o">=</span> <span class="n">usb_alloc_dev</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">rhdev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">dev_err</span><span class="p">(</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">.</span><span class="n">sysdev</span><span class="p">,</span> <span class="s">"unable to allocate root hub</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
                <span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
                <span class="k">goto</span> <span class="n">err_allocate_root_hub</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usb_port_peer_mutex</span><span class="p">);</span>
        <span class="n">hcd</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">.</span><span class="n">root_hub</span> <span class="o">=</span> <span class="n">rhdev</span><span class="p">;</span>
        <span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usb_port_peer_mutex</span><span class="p">);</span>

        <span class="n">rhdev</span><span class="o">-&gt;</span><span class="n">rx_lanes</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">rhdev</span><span class="o">-&gt;</span><span class="n">tx_lanes</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

        <span class="k">switch</span> <span class="p">(</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">case</span> <span class="n">HCD_USB11</span><span class="p">:</span>
                <span class="n">rhdev</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">=</span> <span class="n">USB_SPEED_FULL</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="n">HCD_USB2</span><span class="p">:</span>
                <span class="n">rhdev</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">=</span> <span class="n">USB_SPEED_HIGH</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="n">HCD_USB25</span><span class="p">:</span>
                <span class="n">rhdev</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">=</span> <span class="n">USB_SPEED_WIRELESS</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="n">HCD_USB3</span><span class="p">:</span>
                <span class="n">rhdev</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">=</span> <span class="n">USB_SPEED_SUPER</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="n">HCD_USB32</span><span class="p">:</span>
                <span class="n">rhdev</span><span class="o">-&gt;</span><span class="n">rx_lanes</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
                <span class="n">rhdev</span><span class="o">-&gt;</span><span class="n">tx_lanes</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
                <span class="n">fallthrough</span><span class="p">;</span>
        <span class="k">case</span> <span class="n">HCD_USB31</span><span class="p">:</span>
                <span class="n">rhdev</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">=</span> <span class="n">USB_SPEED_SUPER_PLUS</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
        <span class="nl">default:</span>
                <span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
                <span class="k">goto</span> <span class="n">err_set_rh_speed</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="cm">/* wakeup flag init defaults to "everything works" for root hubs,
         * but drivers can override it in reset() if needed, along with
         * recording the overall controller's system wakeup capability.
         */</span>
        <span class="n">device_set_wakeup_capable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rhdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

        <span class="cm">/* HCD_FLAG_RH_RUNNING doesn't matter until the root hub is
         * registered.  But since the controller can die at any time,
         * let's initialize the flag before touching the hardware.
         */</span>
        <span class="n">set_bit</span><span class="p">(</span><span class="n">HCD_FLAG_RH_RUNNING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

        <span class="cm">/* "reset" is misnamed; its role is now one-time init. the controller
         * should already have been reset (and boot firmware kicked off etc).
         */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">reset</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">retval</span> <span class="o">=</span> <span class="n">hcd</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">reset</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">dev_err</span><span class="p">(</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">.</span><span class="n">controller</span><span class="p">,</span> <span class="s">"can't setup: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
                                        <span class="n">retval</span><span class="p">);</span>
                        <span class="k">goto</span> <span class="n">err_hcd_driver_setup</span><span class="p">;</span>
                <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">hcd</span><span class="o">-&gt;</span><span class="n">rh_pollable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

        <span class="n">retval</span> <span class="o">=</span> <span class="n">usb_phy_roothub_calibrate</span><span class="p">(</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">phy_roothub</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
                <span class="k">goto</span> <span class="n">err_hcd_driver_setup</span><span class="p">;</span>

        <span class="cm">/* NOTE: root hub and controller capabilities may not be the same */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">device_can_wakeup</span><span class="p">(</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">.</span><span class="n">controller</span><span class="p">)</span>
                        <span class="o">&amp;&amp;</span> <span class="n">device_can_wakeup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">.</span><span class="n">root_hub</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span>
                <span class="n">dev_dbg</span><span class="p">(</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">.</span><span class="n">controller</span><span class="p">,</span> <span class="s">"supports USB remote wakeup</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>

        <span class="cm">/* initialize tasklets */</span>
        <span class="n">init_giveback_urb_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">high_prio_bh</span><span class="p">);</span>
        <span class="n">init_giveback_urb_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">low_prio_bh</span><span class="p">);</span>

        <span class="cm">/* enable irqs just before we start the controller,
         * if the BIOS provides legacy PCI irqs.
         */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">usb_hcd_is_primary_hcd</span><span class="p">(</span><span class="n">hcd</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">irqnum</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">retval</span> <span class="o">=</span> <span class="n">usb_hcd_request_irqs</span><span class="p">(</span><span class="n">hcd</span><span class="p">,</span> <span class="n">irqnum</span><span class="p">,</span> <span class="n">irqflags</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
                        <span class="k">goto</span> <span class="n">err_request_irq</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">hcd</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">HC_STATE_RUNNING</span><span class="p">;</span>
        <span class="n">retval</span> <span class="o">=</span> <span class="n">hcd</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">dev_err</span><span class="p">(</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">.</span><span class="n">controller</span><span class="p">,</span> <span class="s">"startup error %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">retval</span><span class="p">);</span>
                <span class="k">goto</span> <span class="n">err_hcd_driver_start</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="cm">/* starting here, usbcore will pay attention to this root hub */</span>
        <span class="n">retval</span> <span class="o">=</span> <span class="n">register_root_hub</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">goto</span> <span class="n">err_register_root_hub</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">uses_new_polling</span> <span class="o">&amp;&amp;</span> <span class="n">HCD_POLL_RH</span><span class="p">(</span><span class="n">hcd</span><span class="p">))</span>
                <span class="n">usb_hcd_poll_rh_status</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>

        <span class="k">return</span> <span class="n">retval</span><span class="p">;</span>

<span class="nl">err_register_root_hub:</span>
        <span class="n">hcd</span><span class="o">-&gt;</span><span class="n">rh_pollable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">clear_bit</span><span class="p">(</span><span class="n">HCD_FLAG_POLL_RH</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
        <span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">rh_timer</span><span class="p">);</span>
        <span class="n">hcd</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
        <span class="n">hcd</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">HC_STATE_HALT</span><span class="p">;</span>
        <span class="n">clear_bit</span><span class="p">(</span><span class="n">HCD_FLAG_POLL_RH</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
        <span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">rh_timer</span><span class="p">);</span>
<span class="nl">err_hcd_driver_start:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">usb_hcd_is_primary_hcd</span><span class="p">(</span><span class="n">hcd</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">hcd</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">free_irq</span><span class="p">(</span><span class="n">irqnum</span><span class="p">,</span> <span class="n">hcd</span><span class="p">);</span>
<span class="nl">err_request_irq:</span>
<span class="nl">err_hcd_driver_setup:</span>
<span class="nl">err_set_rh_speed:</span>
        <span class="n">usb_put_invalidate_rhdev</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
<span class="nl">err_allocate_root_hub:</span>
        <span class="n">usb_deregister_bus</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">);</span>
<span class="nl">err_register_bus:</span>
        <span class="n">hcd_buffer_destroy</span><span class="p">(</span><span class="n">hcd</span><span class="p">);</span>
<span class="nl">err_create_buf:</span>
        <span class="n">usb_phy_roothub_power_off</span><span class="p">(</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">phy_roothub</span><span class="p">);</span>
<span class="nl">err_usb_phy_roothub_power_on:</span>
        <span class="n">usb_phy_roothub_exit</span><span class="p">(</span><span class="n">hcd</span><span class="o">-&gt;</span><span class="n">phy_roothub</span><span class="p">);</span>

        <span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">usb_add_hcd</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></div></div>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
</pre></td><td class="rouge-code"><pre><span class="cm">/**
 * register_root_hub - called by usb_add_hcd() to register a root hub
 * @hcd: host controller for this root hub
 *
 * This function registers the root hub with the USB subsystem.  It sets up
 * the device properly in the device tree and then calls usb_new_device()
 * to register the usb device.  It also assigns the root hub's USB address
 * (always 1).
 *
 * Return: 0 if successful. A negative error code otherwise.
 */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">register_root_hub</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_hcd</span> <span class="o">*</span><span class="n">hcd</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">parent_dev</span> <span class="o">=</span> <span class="n">hcd</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">.</span><span class="n">controller</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">usb_dev</span> <span class="o">=</span> <span class="n">hcd</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">.</span><span class="n">root_hub</span><span class="p">;</span>
        <span class="k">const</span> <span class="kt">int</span> <span class="n">devnum</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

        <span class="n">usb_dev</span><span class="o">-&gt;</span><span class="n">devnum</span> <span class="o">=</span> <span class="n">devnum</span><span class="p">;</span>
        <span class="n">usb_dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">devnum_next</span> <span class="o">=</span> <span class="n">devnum</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">set_bit</span> <span class="p">(</span><span class="n">devnum</span><span class="p">,</span> <span class="n">usb_dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">devmap</span><span class="p">.</span><span class="n">devicemap</span><span class="p">);</span>
        <span class="n">usb_set_device_state</span><span class="p">(</span><span class="n">usb_dev</span><span class="p">,</span> <span class="n">USB_STATE_ADDRESS</span><span class="p">);</span>

        <span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usb_bus_idr_lock</span><span class="p">);</span>

        <span class="n">usb_dev</span><span class="o">-&gt;</span><span class="n">ep0</span><span class="p">.</span><span class="n">desc</span><span class="p">.</span><span class="n">wMaxPacketSize</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">64</span><span class="p">);</span>
        <span class="n">retval</span> <span class="o">=</span> <span class="n">usb_get_device_descriptor</span><span class="p">(</span><span class="n">usb_dev</span><span class="p">,</span> <span class="n">USB_DT_DEVICE_SIZE</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="k">sizeof</span> <span class="n">usb_dev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usb_bus_idr_lock</span><span class="p">);</span>
                <span class="n">dev_dbg</span> <span class="p">(</span><span class="n">parent_dev</span><span class="p">,</span> <span class="s">"can't read %s device descriptor %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
                                <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usb_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span> <span class="n">retval</span><span class="p">);</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">retval</span> <span class="o">:</span> <span class="o">-</span><span class="n">EMSGSIZE</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">usb_dev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">bcdUSB</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mh">0x0201</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">retval</span> <span class="o">=</span> <span class="n">usb_get_bos_descriptor</span><span class="p">(</span><span class="n">usb_dev</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">usb_dev</span><span class="o">-&gt;</span><span class="n">lpm_capable</span> <span class="o">=</span> <span class="n">usb_device_supports_lpm</span><span class="p">(</span><span class="n">usb_dev</span><span class="p">);</span>
                <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">usb_dev</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">&gt;=</span> <span class="n">USB_SPEED_SUPER</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usb_bus_idr_lock</span><span class="p">);</span>
                        <span class="n">dev_dbg</span><span class="p">(</span><span class="n">parent_dev</span><span class="p">,</span> <span class="s">"can't read %s bos descriptor %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
                                        <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usb_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span> <span class="n">retval</span><span class="p">);</span>
                        <span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
                <span class="p">}</span>
        <span class="p">}</span>

        <span class="n">retval</span> <span class="o">=</span> <span class="n">usb_new_device</span> <span class="p">(</span><span class="n">usb_dev</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">dev_err</span> <span class="p">(</span><span class="n">parent_dev</span><span class="p">,</span> <span class="s">"can't register root hub for %s, %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
                                <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usb_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span> <span class="n">retval</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">spin_lock_irq</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">hcd_root_hub_lock</span><span class="p">);</span>
                <span class="n">hcd</span><span class="o">-&gt;</span><span class="n">rh_registered</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
                <span class="n">spin_unlock_irq</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">hcd_root_hub_lock</span><span class="p">);</span>

                <span class="cm">/* Did the HC die before the root hub was registered? */</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">HCD_DEAD</span><span class="p">(</span><span class="n">hcd</span><span class="p">))</span>
                        <span class="n">usb_hc_died</span> <span class="p">(</span><span class="n">hcd</span><span class="p">);</span>      <span class="cm">/* This time clean up */</span>
        <span class="p">}</span>
        <span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usb_bus_idr_lock</span><span class="p">);</span>

        <span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>##When xHCI platform driver can be probed???</p>


  </div>

  <div class="post-tail-wrapper text-muted">
    <!-- categories -->
    
      <div class="post-meta mb-3">
        <i class="far fa-folder-open fa-fw me-1"></i>
        
          <a href="/categories/linux/">linux,</a>,
          <a href="/categories/embedded-linux/">embedded-linux</a>
      </div>
    

    <!-- tags -->
    

    <div
      class="
        post-tail-bottom
        d-flex justify-content-between align-items-center mt-5 pb-2
      "
    >
      <div class="license-wrapper">
        
          

          This post is licensed under 
        <a href="https://creativecommons.org/licenses/by/4.0/">
          CC BY 4.0
        </a>
         by the author.
        
      </div>

      <!-- Post sharing snippet -->

<div class="share-wrapper d-flex align-items-center">
  <span class="share-label text-muted">Share</span>
  <span class="share-icons">
    
    
    

    

      

      <a
        href="https://twitter.com/intent/tweet?text=Register%20Device%20Through%20Bus%20-%20Ruach&url=https%3A%2F%2Fruach.github.io%2Fposts%2Fregister-device-through-bus%2F"
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Twitter"
        target="_blank"
        rel="noopener"
        aria-label="Twitter"
      >
        <i class="fa-fw fa-brands fa-square-x-twitter"></i>
      </a>
    

      

      <a
        href="https://www.facebook.com/sharer/sharer.php?title=Register%20Device%20Through%20Bus%20-%20Ruach&u=https%3A%2F%2Fruach.github.io%2Fposts%2Fregister-device-through-bus%2F"
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Facebook"
        target="_blank"
        rel="noopener"
        aria-label="Facebook"
      >
        <i class="fa-fw fab fa-facebook-square"></i>
      </a>
    

      

      <a
        href="https://t.me/share/url?url=https%3A%2F%2Fruach.github.io%2Fposts%2Fregister-device-through-bus%2F&text=Register%20Device%20Through%20Bus%20-%20Ruach"
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Telegram"
        target="_blank"
        rel="noopener"
        aria-label="Telegram"
      >
        <i class="fa-fw fab fa-telegram"></i>
      </a>
    

      

      <a
        href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fruach.github.io%2Fposts%2Fregister-device-through-bus%2F"
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Linkedin"
        target="_blank"
        rel="noopener"
        aria-label="Linkedin"
      >
        <i class="fa-fw fab fa-linkedin"></i>
      </a>
    

    <button
      id="copy-link"
      aria-label="Copy link"
      class="btn small"
      data-bs-toggle="tooltip"
      data-bs-placement="top"
      title="Copy link"
      data-title-succeed="Link copied successfully!"
    >
      <i class="fa-fw fas fa-link pe-none fs-6"></i>
    </button>
  </span>
</div>

    </div>
    <!-- .post-tail-bottom -->
  </div>
  <!-- div.post-tail-wrapper -->
</article>


            
          </main>

          <!-- panel -->
          <aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 mb-5 text-muted">
            <div class="access">
              <!-- Get the last 5 posts from lastmod list. -->















              <!-- The trending tags list -->


















            </div>

            
              
              



  <section id="toc-wrapper" class="ps-0 pe-4">
    <h2 class="panel-heading ps-3 pt-2 mb-2">Contents</h2>
    <nav id="toc"></nav>
  </section>


            
          </aside>
        </div>

        <div class="row">
          <!-- tail -->
          <div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4">
            
              
              <!-- Recommend the other 3 posts according to the tags and categories of the current post. -->

<!-- The total size of related posts -->


<!-- An random integer that bigger than 0 -->


<!-- Equals to TAG_SCORE / {max_categories_hierarchy} -->














  

  

  

  

  

  

  

  

  

  

  

  

  

  
    
  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  











  <aside id="related-posts" aria-labelledby="related-label">
    <h3 class="mb-4" id="related-label">Further Reading</h3>
    <nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4">
      
        <article class="col">
          <a href="/posts/initcalls/" class="post-preview card h-100">
            <div class="card-body">
              <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1619582400"
  data-df="ll"
  
>
  Apr 28, 2021
</time>

              <h4 class="pt-0 my-2">Initcalls</h4>
              <div class="text-muted">
                <p>
                  





                  #do_initcalls
static void __init do_basic_setup(void)
{
        cpuset_init_smp();
        driver_init();
        init_irq_proc();
        do_ctors();
        usermodehelper_enable();
        do_in...
                </p>
              </div>
            </div>
          </a>
        </article>
      
        <article class="col">
          <a href="/posts/platform-device/" class="post-preview card h-100">
            <div class="card-body">
              <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1619841600"
  data-df="ll"
  
>
  May  1, 2021
</time>

              <h4 class="pt-0 my-2">Platform Device</h4>
              <div class="text-muted">
                <p>
                  





                  Kernel initialization before DeviceTree
Although we are not going to cover the details of the initialization procedure,
this post will take a look at 
what happens before the device tree is initial...
                </p>
              </div>
            </div>
          </a>
        </article>
      
        <article class="col">
          <a href="/posts/register-platform-device-driver/" class="post-preview card h-100">
            <div class="card-body">
              <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1619928000"
  data-df="ll"
  
>
  May  2, 2021
</time>

              <h4 class="pt-0 my-2">Register Platform Device Driver</h4>
              <div class="text-muted">
                <p>
                  





                  We will cover how the platform device drivers 
can be registered and managed by the platform device bus subsystem.

struct platform_driver {
        int (*probe)(struct platform_device *);
        ...
                </p>
              </div>
            </div>
          </a>
        </article>
      
    </nav>
  </aside>
  <!-- #related-posts -->


            
              
              <!-- Navigation buttons at the bottom of the post. -->

<nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation">
  
  

  
    <a
      href="/posts/register-platform-device-driver/"
      class="btn btn-outline-primary"
      aria-label="Older"
    >
      <p>Register Platform Device Driver</p>
    </a>
  

  
    <a
      href="/posts/clks/"
      class="btn btn-outline-primary"
      aria-label="Newer"
    >
      <p>Clks</p>
    </a>
  
</nav>

            
              
              <!--  The comments switcher -->

  
  <!-- The Disqus lazy loading. -->

<div id="disqus_thread">
  <p class="text-center text-muted small">Comments powered by <a href="https://disqus.com/">Disqus</a>.</p>
</div>

<script type="text/javascript">
  var disqus_config = function () {
    this.page.url = 'https://ruach.github.io/posts/register-device-through-bus/';
    this.page.identifier = '/posts/register-device-through-bus/';
  };

  /* Lazy loading */
  var disqus_observer = new IntersectionObserver(
    function (entries) {
      if (entries[0].isIntersecting) {
        (function () {
          var d = document,
            s = d.createElement('script');
          s.src = 'https://ruach.disqus.com/embed.js';
          s.setAttribute('data-timestamp', +new Date());
          (d.head || d.body).appendChild(s);
        })();

        disqus_observer.disconnect();
      }
    },
    { threshold: [0] }
  );

  disqus_observer.observe(document.querySelector('#disqus_thread'));

  /* Auto switch theme */
  function reloadDisqus() {
    if (event.source === window && event.data && event.data.direction === ModeToggle.ID) {
      /* Disqus hasn't been loaded */
      if (typeof DISQUS === 'undefined') {
        return;
      }

      if (document.readyState == 'complete') {
        DISQUS.reset({ reload: true, config: disqus_config });
      }
    }
  }

  if (document.querySelector('.mode-toggle')) {
    window.addEventListener('message', reloadDisqus);
  }
</script>



            

            <!-- The Footer -->

<footer
  aria-label="Site Info"
  class="
    d-flex flex-column justify-content-center text-muted
    flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3
  "
>
  <p>
    ©
    <time>2024</time>
    <a href="https://ruach.github.io">Jaehyuk Lee</a>.
    
      <span
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author."
      >Some rights reserved.</span>
    
  </p>

  <p>Using the <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme for <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>
  </p>
</footer>

          </div>
        </div>

        <!-- The Search results -->

<div id="search-result-wrapper" class="d-flex justify-content-center unloaded">
  <div class="col-11 content">
    <div id="search-hints">
      <!-- The trending tags list -->


















    </div>
    <div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div>
  </div>
</div>

      </div>

      <aside aria-label="Scroll to Top">
        <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow">
          <i class="fas fa-angle-up"></i>
        </button>
      </aside>
    </div>

    <div id="mask"></div>

    
      <aside
  id="notification"
  class="toast"
  role="alert"
  aria-live="assertive"
  aria-atomic="true"
  data-bs-animation="true"
  data-bs-autohide="false"
>
  <div class="toast-header">
    <button
      type="button"
      class="btn-close ms-auto"
      data-bs-dismiss="toast"
      aria-label="Close"
    ></button>
  </div>
  <div class="toast-body text-center pt-0">
    <p class="px-2 mb-3">A new version of content is available.</p>
    <button type="button" class="btn btn-primary" aria-label="Update">
      Update
    </button>
  </div>
</aside>

    

    <!-- JavaScripts -->

    <!-- JS selector for site. -->

<!-- commons -->



<!-- layout specified -->


  

  
    <!-- image lazy-loading & popup & clipboard -->
    
  















  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  



  <script src="https://cdn.jsdelivr.net/combine/npm/jquery@3.7.1/dist/jquery.min.js,npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js,npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/magnific-popup@1.1.0/dist/jquery.magnific-popup.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.10/dayjs.min.js,npm/dayjs@1.11.10/locale/en.min.js,npm/dayjs@1.11.10/plugin/relativeTime.min.js,npm/dayjs@1.11.10/plugin/localizedFormat.min.js,npm/tocbot@4.21.2/dist/tocbot.min.js"></script>






<script defer src="/assets/js/dist/post.min.js"></script>






    

    <!--
  Jekyll Simple Search loader
  See: <https://github.com/christian-fei/Simple-Jekyll-Search>
-->





<script>
  /* Note: dependent library will be loaded in `js-selector.html` */
  SimpleJekyllSearch({
    searchInput: document.getElementById('search-input'),
    resultsContainer: document.getElementById('search-results'),
    json: '/assets/js/data/search.json',
    searchResultTemplate: '  <article class="px-1 px-sm-2 px-lg-4 px-xl-0">    <header>      <h2><a href="{url}">{title}</a></h2>      <div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1">        {categories}        {tags}      </div>    </header>    <p>{snippet}</p>  </article>',
    noResultsText: '<p class="mt-5"></p>',
    templateMiddleware: function(prop, value, template) {
      if (prop === 'categories') {
        if (value === '') {
          return `${value}`;
        } else {
          return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`;
        }
      }

      if (prop === 'tags') {
        if (value === '') {
          return `${value}`;
        } else {
          return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`;
        }
      }
    }
  });
</script>

  </body>
</html>

