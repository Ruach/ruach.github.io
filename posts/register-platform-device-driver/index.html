<!doctype html>














<!-- `site.alt_lang` can specify a language different from the UI -->
<html lang="en" data-mode="light">
  <!-- The Head -->

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta
    name="viewport"
    content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover"
  >

  

  

  
    <!-- Begin Jekyll SEO tag v2.8.0 -->
<meta name="generator" content="Jekyll v4.3.2" />
<meta property="og:title" content="Register Platform Device Driver" />
<meta property="og:locale" content="en" />
<meta name="description" content="We will cover how the platform device drivers can be registered and managed by the platform device bus subsystem." />
<meta property="og:description" content="We will cover how the platform device drivers can be registered and managed by the platform device bus subsystem." />
<link rel="canonical" href="https://ruach.github.io/posts/register-platform-device-driver/" />
<meta property="og:url" content="https://ruach.github.io/posts/register-platform-device-driver/" />
<meta property="og:site_name" content="Ruach" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-05-02T00:00:00-04:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Register Platform Device Driver" />
<meta name="twitter:site" content="@ruach_lee" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2021-05-02T00:00:00-04:00","datePublished":"2021-05-02T00:00:00-04:00","description":"We will cover how the platform device drivers can be registered and managed by the platform device bus subsystem.","headline":"Register Platform Device Driver","mainEntityOfPage":{"@type":"WebPage","@id":"https://ruach.github.io/posts/register-platform-device-driver/"},"url":"https://ruach.github.io/posts/register-platform-device-driver/"}</script>
<!-- End Jekyll SEO tag -->

  

  <title>Register Platform Device Driver | Ruach
  </title>

  <!--
  The Favicons for Web, Android, Microsoft, and iOS (iPhone and iPad) Apps
  Generated by: https://realfavicongenerator.net/
-->



<link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png">
<link rel="manifest" href="/assets/img/favicons/site.webmanifest">
<link rel="shortcut icon" href="/assets/img/favicons/favicon.ico">
<meta name="apple-mobile-web-app-title" content="Ruach">
<meta name="application-name" content="Ruach">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml">
<meta name="theme-color" content="#ffffff">


  
    
      <link rel="preconnect" href="https://fonts.googleapis.com" >
      <link rel="dns-prefetch" href="https://fonts.googleapis.com" >
    
      <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      <link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin>
    
      <link rel="preconnect" href="https://fonts.googleapis.com" >
      <link rel="dns-prefetch" href="https://fonts.googleapis.com" >
    
      <link rel="preconnect" href="https://cdn.jsdelivr.net" >
      <link rel="dns-prefetch" href="https://cdn.jsdelivr.net" >
    

    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap">
  

  <!-- GA -->
  

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.2/css/all.min.css">

  <link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css">

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.21.2/dist/tocbot.min.css">
  

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css">
  

  
    <!-- Manific Popup -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css">
  

  <!-- JavaScript -->

  

  <!-- A placeholder to allow defining custom metadata -->

</head>


  <body>
    <!-- The Side Bar -->

<aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end">
  <header class="profile-wrapper">
    <a href="/" id="avatar" class="rounded-circle">
      
        
        <img src="/assets/img/jaehyuk.png" width="112" height="112" alt="avatar" onerror="this.style.display='none'">
      
    </a>

    <h1 class="site-title">
      <a href="/">Ruach</a>
    </h1>
    <p class="site-subtitle fst-italic mb-0">Jaehyuk Lee</p>
  </header>
  <!-- .profile-wrapper -->

  <nav class="flex-column flex-grow-1 w-100 ps-0">
    <ul class="nav">
      <!-- home -->
      <li class="nav-item">
        <a href="/" class="nav-link">
          <i class="fa-fw fas fa-home"></i>
          <span>HOME</span>
        </a>
      </li>
      <!-- the real tabs -->
      
        <li class="nav-item">
          <a href="/categories/" class="nav-link">
            <i class="fa-fw fas fa-stream"></i>
            

            <span>CATEGORIES</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/archives/" class="nav-link">
            <i class="fa-fw fas fa-archive"></i>
            

            <span>ARCHIVES</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/Professional-Career/" class="nav-link">
            <i class="fa-fw fas fa-id-card"></i>
            

            <span>PROFESSIONAL CAREER</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/about/" class="nav-link">
            <i class="fa-fw fas fa-info-circle"></i>
            

            <span>ABOUT</span>
          </a>
        </li>
        <!-- .nav-item -->
      
    </ul>
  </nav>

  <div class="sidebar-bottom d-flex flex-wrap  align-items-center w-100">
    

    
      

      
        <a
          href="javascript:location.href = 'mailto:' + ['jaehyuk','gatech.edu'].join('@')"
          aria-label="email"
          

          

          

          
        >
          <i class="fas fa-envelope"></i>
        </a>
      
    
      

      
        <a
          href="https://www.linkedin.com/in/jaehyuk-lee-29b33b121/"
          aria-label="linkedin"
          

          
            target="_blank"
            
          

          

          
            rel="noopener noreferrer"
          
        >
          <i class="fab fa-linkedin"></i>
        </a>
      
    
      

      
        <a
          href="https://github.com/Ruach"
          aria-label="github"
          

          
            target="_blank"
            
          

          

          
            rel="noopener noreferrer"
          
        >
          <i class="fab fa-github"></i>
        </a>
      
    
      

      
        <a
          href="https://stackoverflow.com/users/4460514/ruach?tab=profile"
          aria-label="stack-overflow"
          

          
            target="_blank"
            
          

          

          
            rel="noopener noreferrer"
          
        >
          <i class="fab fa-stack-overflow"></i>
        </a>
      
    
  </div>
  <!-- .sidebar-bottom -->
</aside>
<!-- #sidebar -->


    <div id="main-wrapper" class="d-flex justify-content-center">
      <div class="container d-flex flex-column px-xxl-5">
        <!-- The Top Bar -->

<header id="topbar-wrapper" aria-label="Top Bar">
  <div
    id="topbar"
    class="d-flex align-items-center justify-content-between px-lg-3 h-100"
  >
    <nav id="breadcrumb" aria-label="Breadcrumb">
      

      
        
          
            <span>
              <a href="/">
                Home
              </a>
            </span>

          
        
          
        
          
            
              <span>Register Platform Device Driver</span>
            

          
        
      
    </nav>
    <!-- endof #breadcrumb -->

    <button type="button" id="sidebar-trigger" class="btn btn-link">
      <i class="fas fa-bars fa-fw"></i>
    </button>

    <div id="topbar-title">
      Post
    </div>

    <button type="button" id="search-trigger" class="btn btn-link">
      <i class="fas fa-search fa-fw"></i>
    </button>

    <search class="align-items-center ms-3 ms-lg-0">
      <i class="fas fa-search fa-fw"></i>
      <input
        class="form-control"
        id="search-input"
        type="search"
        aria-label="search"
        autocomplete="off"
        placeholder="Search..."
      >
    </search>
    <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button>
  </div>
</header>


        <div class="row flex-grow-1">
          <main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4">
            
              <!-- Refactor the HTML structure -->



<!--
  In order to allow a wide table to scroll horizontally,
  we suround the markdown table with `<div class="table-wrapper">` and `</div>`
-->



<!--
  Fixed kramdown code highlight rendering:
  https://github.com/penibelst/jekyll-compress-html/issues/101
  https://github.com/penibelst/jekyll-compress-html/issues/71#issuecomment-188144901
-->



<!-- Change the icon of checkbox -->



<!-- Handle images -->





<!-- Add header for code snippets -->



<!-- Create heading anchors -->





  
  

  

  
  

  

  
  

  

  
  

  




<!-- return -->




<article class="px-1">
  <header>
    <h1 data-toc-skip>Register Platform Device Driver</h1>

    <div class="post-meta text-muted">
      <!-- published date -->
      <span>
        Posted
        <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1619928000"
  data-df="ll"
  
    data-bs-toggle="tooltip" data-bs-placement="bottom"
  
>
  May  2, 2021
</time>

      </span>

      <!-- lastmod date -->
      

      

      <div class="d-flex justify-content-between">
        <!-- author(s) -->
        <span>
          

          By

          <em>
            
              <a href="https://ruach.github.io">Jaehyuk Lee</a>
            
          </em>
        </span>

        <!-- read time -->
        <!-- Calculate the post's reading time, and display the word count in tooltip -->



<!-- words per minute -->










<!-- return element -->
<span
  class="readtime"
  data-bs-toggle="tooltip"
  data-bs-placement="bottom"
  title="2372 words"
>
  <em>13 min</em> read</span>

      </div>
      <!-- .d-flex -->
    </div>
    <!-- .post-meta -->
  </header>

  <div class="content">
    <p>We will cover how the platform device drivers 
can be registered and managed by the platform device bus subsystem.</p>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre></td><td class="rouge-code"><pre><span class="k">struct</span> <span class="n">platform_driver</span> <span class="p">{</span>
        <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">probe</span><span class="p">)(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="p">);</span>
        <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">remove</span><span class="p">)(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="p">);</span>
        <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">shutdown</span><span class="p">)(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="p">);</span>
        <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">suspend</span><span class="p">)(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">);</span>
        <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">resume</span><span class="p">)(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="p">);</span>
        <span class="k">struct</span> <span class="n">device_driver</span> <span class="n">driver</span><span class="p">;</span>
        <span class="k">const</span> <span class="k">struct</span> <span class="n">platform_device_id</span> <span class="o">*</span><span class="n">id_table</span><span class="p">;</span>
        <span class="n">bool</span> <span class="n">prevent_deferred_probe</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* module_platform_driver() - Helper macro for drivers that don't do
 * anything special in module init/exit.  This eliminates a lot of
 * boilerplate.  Each module may only use this macro once, and
 * calling it replaces module_init() and module_exit()
 */</span>
<span class="cp">#define module_platform_driver(__platform_driver) \
        module_driver(__platform_driver, platform_driver_register, \
                        platform_driver_unregister)
</span><span class="cm">/*
 * use a macro to avoid include chaining to get THIS_MODULE
 */</span>
<span class="cp">#define platform_driver_register(drv) \
        __platform_driver_register(drv, THIS_MODULE)
</span><span class="k">extern</span> <span class="kt">int</span> <span class="nf">__platform_driver_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_driver</span> <span class="o">*</span><span class="p">,</span>
                                        <span class="k">struct</span> <span class="n">module</span> <span class="o">*</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="nf">platform_driver_unregister</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_driver</span> <span class="o">*</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></div></div>
<p>Every device driver who want to register their driver as platform device
should utilize pre-defined macro or invoke proper platform driver registration APIs
at their driver initialization code.
%
Most kernel device driver utilizes the macro 
compared to have their own APIs to register the device driver
because they don’t require any other complicated operations 
except registering the driver.
Therefore, utilizing the macro will remove boilerplate code 
required for registering your driver to platform driver
and make code looks simple.</p>

<p>Above macro automatically generates 
initialization and de-initialization function for
your platform device driver.
It just invokes platform_driver_register and platform_driver_unregister function 
on module init and exit respectively. 
Both macro requires a platform_driver structure object, and
populating proper platform_driver structure representing current device driver
should be done by the device driver itself.
We will take a look at platform device driver registeration process in detail.</p>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="cm">/**
 * __platform_driver_register - register a driver for platform-level devices
 * @drv: platform driver structure
 * @owner: owning module/driver
 */</span>
<span class="kt">int</span> <span class="nf">__platform_driver_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_driver</span> <span class="o">*</span><span class="n">drv</span><span class="p">,</span>
                                <span class="k">struct</span> <span class="n">module</span> <span class="o">*</span><span class="n">owner</span><span class="p">)</span>
<span class="p">{</span>
        <span class="n">drv</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">owner</span><span class="p">;</span>
        <span class="n">drv</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">.</span><span class="n">bus</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">platform_bus_type</span><span class="p">;</span>
 
        <span class="k">return</span> <span class="n">driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">drv</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">);</span>
<span class="p">}</span>     
</pre></td></tr></tbody></table></code></div></div>
<p>Even though the device driver should provide the platform_driver 
and its associated call-back functions,
it is not driver’s duty to allocate a driver structure 
used for actual device driver registration process.
Therefore, 
the above function and further apis for platform device
will populate the driver structure.
Also, because driver registration process utilize the common driver core apis 
that can be used for every driver registration 
regardless of the bus type,
it should set the generic driver object and pass it to the registration api.
First of all,
the bus_type object for platform device, platform_bus_type 
should be set as its bus
because this driver is supposed to support platform devices,
After the member field of the generic driver object has been filled out,
it invoked driver_register api.</p>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
</pre></td><td class="rouge-code"><pre><span class="cm">/**
 * driver_register - register driver with bus
 * @drv: driver to register
 *
 * We pass off most of the work to the bus_add_driver() call,
 * since most of the things we have to do deal with the bus
 * structures.
 */</span>
<span class="kt">int</span> <span class="nf">driver_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span><span class="n">drv</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span><span class="n">other</span><span class="p">;</span>
 
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">drv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">pr_err</span><span class="p">(</span><span class="s">"Driver '%s' was unable to register with bus_type '%s' because the bus was not initialized.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
                           <span class="n">drv</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">drv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
                <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
        <span class="p">}</span>
 
        <span class="k">if</span> <span class="p">((</span><span class="n">drv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">probe</span> <span class="o">&amp;&amp;</span> <span class="n">drv</span><span class="o">-&gt;</span><span class="n">probe</span><span class="p">)</span> <span class="o">||</span>
            <span class="p">(</span><span class="n">drv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">remove</span> <span class="o">&amp;&amp;</span> <span class="n">drv</span><span class="o">-&gt;</span><span class="n">remove</span><span class="p">)</span> <span class="o">||</span>
            <span class="p">(</span><span class="n">drv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">shutdown</span> <span class="o">&amp;&amp;</span> <span class="n">drv</span><span class="o">-&gt;</span><span class="n">shutdown</span><span class="p">))</span>
                <span class="n">pr_warn</span><span class="p">(</span><span class="s">"Driver '%s' needs updating - please use "</span>
                        <span class="s">"bus_type methods</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">drv</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
        
        <span class="n">other</span> <span class="o">=</span> <span class="n">driver_find</span><span class="p">(</span><span class="n">drv</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">drv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">pr_err</span><span class="p">(</span><span class="s">"Error: Driver '%s' is already registered, "</span>
                        <span class="s">"aborting...</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">drv</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
                <span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
        <span class="p">}</span>
        
        <span class="n">ret</span> <span class="o">=</span> <span class="n">bus_add_driver</span><span class="p">(</span><span class="n">drv</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">driver_add_groups</span><span class="p">(</span><span class="n">drv</span><span class="p">,</span> <span class="n">drv</span><span class="o">-&gt;</span><span class="n">groups</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">bus_remove_driver</span><span class="p">(</span><span class="n">drv</span><span class="p">);</span>
                <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">kobject_uevent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">drv</span><span class="o">-&gt;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="n">KOBJ_ADD</span><span class="p">);</span>
        
        <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">driver_register</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></div></div>
<p>Note that driver_register is not bus-specific api to register the driver.
It is a generic api to register device driver structure to the bus.
This function firstly checks 
whether the bus_type has been properly initialized and registered 
to the system by checking the presence of private sub-system of the bus. 
To understand how the private subsystem has been allocated for a bus,
you might want to check previous posting.</p>

<p>And then not to register same named device driver more than once,
it checks if the bus attached to the device_driver structure 
already has the same named device driver. 
If there is nothing, then it delegates
most of the driver registering process
to bus_add_driver function.</p>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
</pre></td><td class="rouge-code"><pre><span class="k">struct</span> <span class="n">driver_private</span> <span class="p">{</span>
        <span class="k">struct</span> <span class="n">kobject</span> <span class="n">kobj</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">klist</span> <span class="n">klist_devices</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">klist_node</span> <span class="n">knode_bus</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">module_kobject</span> <span class="o">*</span><span class="n">mkobj</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span><span class="n">driver</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/**
 * bus_add_driver - Add a driver to the bus.
 * @drv: driver.
 */</span>
<span class="kt">int</span> <span class="nf">bus_add_driver</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span><span class="n">drv</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">struct</span> <span class="n">bus_type</span> <span class="o">*</span><span class="n">bus</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">driver_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

        <span class="n">bus</span> <span class="o">=</span> <span class="n">bus_get</span><span class="p">(</span><span class="n">drv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bus</span><span class="p">)</span>
                <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

        <span class="n">pr_debug</span><span class="p">(</span><span class="s">"bus: '%s': add driver %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">drv</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

        <span class="n">priv</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">priv</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
                <span class="k">goto</span> <span class="n">out_put_bus</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">klist_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">klist_devices</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
        <span class="n">priv</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">=</span> <span class="n">drv</span><span class="p">;</span>
        <span class="n">drv</span><span class="o">-&gt;</span><span class="n">p</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
        <span class="n">priv</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">.</span><span class="n">kset</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">drivers_kset</span><span class="p">;</span>
        <span class="n">error</span> <span class="o">=</span> <span class="n">kobject_init_and_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">driver_ktype</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
                                     <span class="s">"%s"</span><span class="p">,</span> <span class="n">drv</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
                <span class="k">goto</span> <span class="n">out_unregister</span><span class="p">;</span>

        <span class="n">klist_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">knode_bus</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">klist_drivers</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">drv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">drivers_autoprobe</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">error</span> <span class="o">=</span> <span class="n">driver_attach</span><span class="p">(</span><span class="n">drv</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
                        <span class="k">goto</span> <span class="n">out_unregister</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">module_add_driver</span><span class="p">(</span><span class="n">drv</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">,</span> <span class="n">drv</span><span class="p">);</span>

        <span class="n">error</span> <span class="o">=</span> <span class="n">driver_create_file</span><span class="p">(</span><span class="n">drv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">driver_attr_uevent</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">"%s: uevent attr (%s) failed</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
                        <span class="n">__func__</span><span class="p">,</span> <span class="n">drv</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">error</span> <span class="o">=</span> <span class="n">driver_add_groups</span><span class="p">(</span><span class="n">drv</span><span class="p">,</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">drv_groups</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
                <span class="cm">/* How the hell do we get out of this pickle? Give up */</span>
                <span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">"%s: driver_create_groups(%s) failed</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
                        <span class="n">__func__</span><span class="p">,</span> <span class="n">drv</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">drv</span><span class="o">-&gt;</span><span class="n">suppress_bind_attrs</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">error</span> <span class="o">=</span> <span class="n">add_bind_files</span><span class="p">(</span><span class="n">drv</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
                        <span class="cm">/* Ditto */</span>
                        <span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">"%s: add_bind_files(%s) failed</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
                                <span class="n">__func__</span><span class="p">,</span> <span class="n">drv</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
                <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_unregister:</span>
        <span class="n">kobject_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">);</span>
        <span class="cm">/* drv-&gt;p is freed in driver_release()  */</span>
        <span class="n">drv</span><span class="o">-&gt;</span><span class="n">p</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="nl">out_put_bus:</span>
        <span class="n">bus_put</span><span class="p">(</span><span class="n">bus</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>
<p>The first thing done by the bus_add_driver function is 
allocating driver’s private data 
used to memorize the driver specific information</p>

<p>In detail,
driver_private is used to manage those private information 
related to current device driver.
For example,
it has klist_devices klist telling
which devices has been bound to current driver and 
knode_bus which is a knode object of the bus
that we are trying to register our driver to
It resets the klist_devices list first using klist_init function
because there should be no devices attached to current device
After the driver_private object has been initialized, 
it should be added to the driver.</p>

<p>And then we need to register our driver to the bus.
To do that klist_add_tail function will
add our driver_private’s knodw to the 
klist_driver list of the subsystem of the target bus.
%
When the bus has been initialized 
if the bus has been configured to probe the device
at every driver registration (drivers_autoprobe flag)
it invokes the driver_attach function
to check if there exists device 
hat can be bound to the newly registered driver.</p>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
</pre></td><td class="rouge-code"><pre><span class="cm">/**
 * driver_attach - try to bind driver to devices.
 * @drv: driver.
 *
 * Walk the list of devices that the bus has on it and try to
 * match the driver with each one.  If driver_probe_device()
 * returns 0 and the @dev-&gt;driver is set, we've found a
 * compatible pair.
 */</span>
<span class="kt">int</span> <span class="nf">driver_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span><span class="n">drv</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">return</span> <span class="n">bus_for_each_dev</span><span class="p">(</span><span class="n">drv</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">drv</span><span class="p">,</span> <span class="n">__driver_attach</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">driver_attach</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__driver_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span><span class="n">drv</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

        <span class="cm">/*
         * Lock device and try to bind to it. We drop the error
         * here and always return 0, because we need to keep trying
         * to bind to devices and some drivers will return an error
         * simply if it didn't support the device.
         *
         * driver_probe_device() will spit a warning if there
         * is an error.
         */</span>

        <span class="n">ret</span> <span class="o">=</span> <span class="n">driver_match_device</span><span class="p">(</span><span class="n">drv</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="cm">/* no match */</span>
                <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">EPROBE_DEFER</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">"Device match requests probe deferral</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
                <span class="n">driver_deferred_probe_add</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">"Bus failed to match device: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
                <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
        <span class="p">}</span> <span class="cm">/* ret &gt; 0 means positive match */</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">driver_allows_async_probing</span><span class="p">(</span><span class="n">drv</span><span class="p">))</span> <span class="p">{</span>
                <span class="cm">/*
                 * Instead of probing the device synchronously we will
                 * probe it asynchronously to allow for more parallelism.
                 *
                 * We only take the device lock here in order to guarantee
                 * that the dev-&gt;driver and async_driver fields are protected
                 */</span>
                <span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">"probing driver %s asynchronously</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">drv</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
                <span class="n">device_lock</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">get_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
                        <span class="n">dev</span><span class="o">-&gt;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">async_driver</span> <span class="o">=</span> <span class="n">drv</span><span class="p">;</span>
                        <span class="n">async_schedule_dev</span><span class="p">(</span><span class="n">__driver_attach_async_helper</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="n">device_unlock</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
                <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">device_driver_attach</span><span class="p">(</span><span class="n">drv</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></td></tr></tbody></table></code></div></div>
<p>driver_attach function invokes __driver_attach function 
against all devices registered to the bus 
our device driver attached.
The driver_match_device matches the driver with the tarversed device
(we covered the details about driver_match_device in previous posting).
If the matching device found,
it invokes device_driver_attach to manually bind device to the driver.</p>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre></td><td class="rouge-code"><pre><span class="cm">/**
 * device_driver_attach - attach a specific driver to a specific device
 * @drv: Driver to attach
 * @dev: Device to attach it to
 *
 * Manually attach driver to a device. Will acquire both @dev lock and
 * @dev-&gt;parent lock if needed.
 */</span>
<span class="kt">int</span> <span class="nf">device_driver_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span><span class="n">drv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

        <span class="n">__device_driver_lock</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">);</span>

        <span class="cm">/*
         * If device has been removed or someone has already successfully
         * bound a driver before us just skip the driver probe call.
         */</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dead</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">)</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="n">driver_probe_device</span><span class="p">(</span><span class="n">drv</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

        <span class="n">__device_driver_unlock</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">);</span>

        <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>
<p>If the device is not dead and has not been bound to any device driver,
then it invokes driver_probe_device to actually bind the device to driver.
All the details are already covered in the previous posting.
That’s it! We registered our platform device driver to the platform bus</p>

<p>XXX:move to other posting.</p>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
</pre></td><td class="rouge-code"><pre> <span class="mi">399</span> <span class="cm">/**
 400  * bus_for_each_drv - driver iterator
 401  * @bus: bus we're dealing with.
 402  * @start: driver to start iterating on.
 403  * @data: data to pass to the callback.
 404  * @fn: function to call for each driver.
 405  *
 406  * This is nearly identical to the device iterator above.
 407  * We iterate over each driver that belongs to @bus, and call
 408  * @fn for each. If @fn returns anything but 0, we break out
 409  * and return it. If @start is not NULL, we use it as the head
 410  * of the list.
 411  *
 412  * NOTE: we don't return the driver that returns a non-zero
 413  * value, nor do we leave the reference count incremented for that
 414  * driver. If the caller needs to know that info, it must set it
 415  * in the callback. It must also be sure to increment the refcount
 416  * so it doesn't disappear before returning to the caller.
 417  */</span>
 <span class="mi">418</span> <span class="kt">int</span> <span class="n">bus_for_each_drv</span><span class="p">(</span><span class="k">struct</span> <span class="n">bus_type</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span><span class="n">start</span><span class="p">,</span>
 <span class="mi">419</span>                      <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">fn</span><span class="p">)(</span><span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="p">))</span>
 <span class="mi">420</span> <span class="p">{</span>
 <span class="mi">421</span>         <span class="k">struct</span> <span class="n">klist_iter</span> <span class="n">i</span><span class="p">;</span>
 <span class="mi">422</span>         <span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span><span class="n">drv</span><span class="p">;</span>
 <span class="mi">423</span>         <span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
 <span class="mi">424</span> 
 <span class="mi">425</span>         <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bus</span><span class="p">)</span>
 <span class="mi">426</span>                 <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
 <span class="mi">427</span> 
 <span class="mi">428</span>         <span class="n">klist_iter_init_node</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">klist_drivers</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">,</span>
 <span class="mi">429</span>                              <span class="n">start</span> <span class="o">?</span> <span class="o">&amp;</span><span class="n">start</span><span class="o">-&gt;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">knode_bus</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">);</span>
 <span class="mi">430</span>         <span class="k">while</span> <span class="p">((</span><span class="n">drv</span> <span class="o">=</span> <span class="n">next_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">error</span><span class="p">)</span>
 <span class="mi">431</span>                 <span class="n">error</span> <span class="o">=</span> <span class="n">fn</span><span class="p">(</span><span class="n">drv</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
 <span class="mi">432</span>         <span class="n">klist_iter_exit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i</span><span class="p">);</span>
 <span class="mi">433</span>         <span class="k">return</span> <span class="n">error</span><span class="p">;</span>
 <span class="mi">434</span> <span class="p">}</span>

 <span class="mi">387</span> <span class="k">static</span> <span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span><span class="nf">next_driver</span><span class="p">(</span><span class="k">struct</span> <span class="n">klist_iter</span> <span class="o">*</span><span class="n">i</span><span class="p">)</span>
 <span class="mi">388</span> <span class="p">{</span>
 <span class="mi">389</span>         <span class="k">struct</span> <span class="n">klist_node</span> <span class="o">*</span><span class="n">n</span> <span class="o">=</span> <span class="n">klist_next</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
 <span class="mi">390</span>         <span class="k">struct</span> <span class="n">driver_private</span> <span class="o">*</span><span class="n">drv_priv</span><span class="p">;</span>
 <span class="mi">391</span> 
 <span class="mi">392</span>         <span class="nf">if</span> <span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="p">{</span>
 <span class="mi">393</span>                 <span class="n">drv_priv</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="k">struct</span> <span class="n">driver_private</span><span class="p">,</span> <span class="n">knode_bus</span><span class="p">);</span>
 <span class="mi">394</span>                 <span class="k">return</span> <span class="n">drv_priv</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">;</span>
 <span class="mi">395</span>         <span class="p">}</span>
 <span class="mi">396</span>         <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
 <span class="mi">397</span> <span class="err">}</span>

</pre></td></tr></tbody></table></code></div></div>
<p>For example, bus core provides api called <em>bus_for_each_drv</em>
to run a function against every device driver registered for a bus.
It internally invokes next_driver function,
and this function can retrieve the driver 
by making use of container_of macro.</p>

<p>Here, klist_iter is used to traverse klist_node 
of each device driver associated with current bus.
Also note that the traversed klist is klist_drivers,
which is the member field of subsys_private structure of the bus_type structure.</p>

<p>Therefore, whenever klist_next function is invoked,
it returns one klist_node associated with one device driver
we’ve registered to the bus before.
Note that this klist_node is the memeber field of driver_private
we’ve set in the bus_add_driver function.</p>

<p>As I told before, 
when we have a reference to klist_node of the driver,
we can retrieve the driver_private structure,
and using this reference, we can return the devive driver object itself. 
Note that this device driver structure is the wrapper device driver, drvwrap
that we generated in the usb_register_driver.</p>

<p>When drivers_autoprobe has been set, 
it tries to bind the devices sitting on the bus 
with the new registered driver at the driver register time. 
When you go back to the bus_register function, 
you can find that the drivers_autoprobe flag has been set by default.
Therefore, 
whenever the new device driver is trying to be registered to the bus,
it will try to bind the driver to the already found devices. 
We didn’t cover the detail implementation of the driver_attach function,
but it invokes binding function against the every registered devices on the bus
that are managed by the klist.</p>

  </div>

  <div class="post-tail-wrapper text-muted">
    <!-- categories -->
    
      <div class="post-meta mb-3">
        <i class="far fa-folder-open fa-fw me-1"></i>
        
          <a href="/categories/linux/">linux,</a>,
          <a href="/categories/embedded-linux/">embedded-linux</a>
      </div>
    

    <!-- tags -->
    

    <div
      class="
        post-tail-bottom
        d-flex justify-content-between align-items-center mt-5 pb-2
      "
    >
      <div class="license-wrapper">
        
          

          This post is licensed under 
        <a href="https://creativecommons.org/licenses/by/4.0/">
          CC BY 4.0
        </a>
         by the author.
        
      </div>

      <!-- Post sharing snippet -->

<div class="share-wrapper d-flex align-items-center">
  <span class="share-label text-muted">Share</span>
  <span class="share-icons">
    
    
    

    

      

      <a
        href="https://twitter.com/intent/tweet?text=Register%20Platform%20Device%20Driver%20-%20Ruach&url=https%3A%2F%2Fruach.github.io%2Fposts%2Fregister-platform-device-driver%2F"
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Twitter"
        target="_blank"
        rel="noopener"
        aria-label="Twitter"
      >
        <i class="fa-fw fa-brands fa-square-x-twitter"></i>
      </a>
    

      

      <a
        href="https://www.facebook.com/sharer/sharer.php?title=Register%20Platform%20Device%20Driver%20-%20Ruach&u=https%3A%2F%2Fruach.github.io%2Fposts%2Fregister-platform-device-driver%2F"
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Facebook"
        target="_blank"
        rel="noopener"
        aria-label="Facebook"
      >
        <i class="fa-fw fab fa-facebook-square"></i>
      </a>
    

      

      <a
        href="https://t.me/share/url?url=https%3A%2F%2Fruach.github.io%2Fposts%2Fregister-platform-device-driver%2F&text=Register%20Platform%20Device%20Driver%20-%20Ruach"
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Telegram"
        target="_blank"
        rel="noopener"
        aria-label="Telegram"
      >
        <i class="fa-fw fab fa-telegram"></i>
      </a>
    

      

      <a
        href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fruach.github.io%2Fposts%2Fregister-platform-device-driver%2F"
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Linkedin"
        target="_blank"
        rel="noopener"
        aria-label="Linkedin"
      >
        <i class="fa-fw fab fa-linkedin"></i>
      </a>
    

    <button
      id="copy-link"
      aria-label="Copy link"
      class="btn small"
      data-bs-toggle="tooltip"
      data-bs-placement="top"
      title="Copy link"
      data-title-succeed="Link copied successfully!"
    >
      <i class="fa-fw fas fa-link pe-none fs-6"></i>
    </button>
  </span>
</div>

    </div>
    <!-- .post-tail-bottom -->
  </div>
  <!-- div.post-tail-wrapper -->
</article>


            
          </main>

          <!-- panel -->
          <aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 mb-5 text-muted">
            <div class="access">
              <!-- Get the last 5 posts from lastmod list. -->















              <!-- The trending tags list -->


















            </div>

            
              
              




            
          </aside>
        </div>

        <div class="row">
          <!-- tail -->
          <div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4">
            
              
              <!-- Recommend the other 3 posts according to the tags and categories of the current post. -->

<!-- The total size of related posts -->


<!-- An random integer that bigger than 0 -->


<!-- Equals to TAG_SCORE / {max_categories_hierarchy} -->














  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  
    
  

  

  

  

  

  

  

  

  

  

  

  











  <aside id="related-posts" aria-labelledby="related-label">
    <h3 class="mb-4" id="related-label">Further Reading</h3>
    <nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4">
      
        <article class="col">
          <a href="/posts/initcalls/" class="post-preview card h-100">
            <div class="card-body">
              <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1619582400"
  data-df="ll"
  
>
  Apr 28, 2021
</time>

              <h4 class="pt-0 my-2">Initcalls</h4>
              <div class="text-muted">
                <p>
                  





                  do_initcalls
static void __init do_basic_setup(void)
{
        cpuset_init_smp();
        driver_init();
        init_irq_proc();
        do_ctors();
        usermodehelper_enable();
        do_ini...
                </p>
              </div>
            </div>
          </a>
        </article>
      
        <article class="col">
          <a href="/posts/platform-device/" class="post-preview card h-100">
            <div class="card-body">
              <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1619841600"
  data-df="ll"
  
>
  May  1, 2021
</time>

              <h4 class="pt-0 my-2">Platform Device</h4>
              <div class="text-muted">
                <p>
                  





                  Kernel initialization before DeviceTree
Although we are not going to cover the details of the initialization procedure,
this post will take a look at 
what happens before the device tree is initial...
                </p>
              </div>
            </div>
          </a>
        </article>
      
        <article class="col">
          <a href="/posts/register-device-through-bus/" class="post-preview card h-100">
            <div class="card-body">
              <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1620100800"
  data-df="ll"
  
>
  May  4, 2021
</time>

              <h4 class="pt-0 my-2">Register Device Through Bus</h4>
              <div class="text-muted">
                <p>
                  





                  Initializing usb subsystem
1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
/*
 * In...
                </p>
              </div>
            </div>
          </a>
        </article>
      
    </nav>
  </aside>
  <!-- #related-posts -->


            
              
              <!-- Navigation buttons at the bottom of the post. -->

<nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation">
  
  

  
    <a
      href="/posts/platform-device/"
      class="btn btn-outline-primary"
      aria-label="Older"
    >
      <p>Platform Device</p>
    </a>
  

  
    <a
      href="/posts/register-device-through-bus/"
      class="btn btn-outline-primary"
      aria-label="Newer"
    >
      <p>Register Device Through Bus</p>
    </a>
  
</nav>

            
              
              <!--  The comments switcher -->

  
  <!-- The Disqus lazy loading. -->

<div id="disqus_thread">
  <p class="text-center text-muted small">Comments powered by <a href="https://disqus.com/">Disqus</a>.</p>
</div>

<script type="text/javascript">
  var disqus_config = function () {
    this.page.url = 'https://ruach.github.io/posts/register-platform-device-driver/';
    this.page.identifier = '/posts/register-platform-device-driver/';
  };

  /* Lazy loading */
  var disqus_observer = new IntersectionObserver(
    function (entries) {
      if (entries[0].isIntersecting) {
        (function () {
          var d = document,
            s = d.createElement('script');
          s.src = 'https://ruach.disqus.com/embed.js';
          s.setAttribute('data-timestamp', +new Date());
          (d.head || d.body).appendChild(s);
        })();

        disqus_observer.disconnect();
      }
    },
    { threshold: [0] }
  );

  disqus_observer.observe(document.querySelector('#disqus_thread'));

  /* Auto switch theme */
  function reloadDisqus() {
    if (event.source === window && event.data && event.data.direction === ModeToggle.ID) {
      /* Disqus hasn't been loaded */
      if (typeof DISQUS === 'undefined') {
        return;
      }

      if (document.readyState == 'complete') {
        DISQUS.reset({ reload: true, config: disqus_config });
      }
    }
  }

  if (document.querySelector('.mode-toggle')) {
    window.addEventListener('message', reloadDisqus);
  }
</script>



            

            <!-- The Footer -->

<footer
  aria-label="Site Info"
  class="
    d-flex flex-column justify-content-center text-muted
    flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3
  "
>
  <p>
    ©
    <time>2024</time>
    <a href="https://ruach.github.io">Jaehyuk Lee</a>.
    
      <span
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author."
      >Some rights reserved.</span>
    
  </p>

  <p>Using the <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme for <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>
  </p>
</footer>

          </div>
        </div>

        <!-- The Search results -->

<div id="search-result-wrapper" class="d-flex justify-content-center unloaded">
  <div class="col-11 content">
    <div id="search-hints">
      <!-- The trending tags list -->


















    </div>
    <div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div>
  </div>
</div>

      </div>

      <aside aria-label="Scroll to Top">
        <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow">
          <i class="fas fa-angle-up"></i>
        </button>
      </aside>
    </div>

    <div id="mask"></div>

    
      <aside
  id="notification"
  class="toast"
  role="alert"
  aria-live="assertive"
  aria-atomic="true"
  data-bs-animation="true"
  data-bs-autohide="false"
>
  <div class="toast-header">
    <button
      type="button"
      class="btn-close ms-auto"
      data-bs-dismiss="toast"
      aria-label="Close"
    ></button>
  </div>
  <div class="toast-body text-center pt-0">
    <p class="px-2 mb-3">A new version of content is available.</p>
    <button type="button" class="btn btn-primary" aria-label="Update">
      Update
    </button>
  </div>
</aside>

    

    <!-- JavaScripts -->

    <!-- JS selector for site. -->

<!-- commons -->



<!-- layout specified -->


  

  
    <!-- image lazy-loading & popup & clipboard -->
    
  















  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  



  <script src="https://cdn.jsdelivr.net/combine/npm/jquery@3.7.1/dist/jquery.min.js,npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js,npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/magnific-popup@1.1.0/dist/jquery.magnific-popup.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.10/dayjs.min.js,npm/dayjs@1.11.10/locale/en.min.js,npm/dayjs@1.11.10/plugin/relativeTime.min.js,npm/dayjs@1.11.10/plugin/localizedFormat.min.js"></script>






<script defer src="/assets/js/dist/post.min.js"></script>






    

    <!--
  Jekyll Simple Search loader
  See: <https://github.com/christian-fei/Simple-Jekyll-Search>
-->





<script>
  /* Note: dependent library will be loaded in `js-selector.html` */
  SimpleJekyllSearch({
    searchInput: document.getElementById('search-input'),
    resultsContainer: document.getElementById('search-results'),
    json: '/assets/js/data/search.json',
    searchResultTemplate: '  <article class="px-1 px-sm-2 px-lg-4 px-xl-0">    <header>      <h2><a href="{url}">{title}</a></h2>      <div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1">        {categories}        {tags}      </div>    </header>    <p>{snippet}</p>  </article>',
    noResultsText: '<p class="mt-5"></p>',
    templateMiddleware: function(prop, value, template) {
      if (prop === 'categories') {
        if (value === '') {
          return `${value}`;
        } else {
          return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`;
        }
      }

      if (prop === 'tags') {
        if (value === '') {
          return `${value}`;
        } else {
          return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`;
        }
      }
    }
  });
</script>

  </body>
</html>

