<!doctype html>














<!-- `site.alt_lang` can specify a language different from the UI -->
<html lang="en" data-mode="light">
  <!-- The Head -->

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta
    name="viewport"
    content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover"
  >

  

  

  
    <!-- Begin Jekyll SEO tag v2.8.0 -->
<meta name="generator" content="Jekyll v4.3.2" />
<meta property="og:title" content="Template Generating Microop" />
<meta property="og:locale" content="en" />
<meta name="description" content="Automatic CPP Class Generation for Macroop and Microop In this post, we will continue to make use of the parser and the grammar defined to understand the Domain Specific Language (DSL) of GEM5. Because DSL is not a general language like CPP compiled by g++, it should be translated into another language which can be compiled, or its compiler should be provided. Therefore, GEM5 utilizes Python Lex-Yacc (PLY) to parse ‘*.isa’ files defining Instruction Set Architecture (ISA) and translate them into CPP classes. This ISA includes macroop and microops of X86 architecture. Therefore, to understand how GEM5 defines ISA, and how they are automatically translated into CPP classes, you should understand how PLY works. It is highly recommended to read this link." />
<meta property="og:description" content="Automatic CPP Class Generation for Macroop and Microop In this post, we will continue to make use of the parser and the grammar defined to understand the Domain Specific Language (DSL) of GEM5. Because DSL is not a general language like CPP compiled by g++, it should be translated into another language which can be compiled, or its compiler should be provided. Therefore, GEM5 utilizes Python Lex-Yacc (PLY) to parse ‘*.isa’ files defining Instruction Set Architecture (ISA) and translate them into CPP classes. This ISA includes macroop and microops of X86 architecture. Therefore, to understand how GEM5 defines ISA, and how they are automatically translated into CPP classes, you should understand how PLY works. It is highly recommended to read this link." />
<link rel="canonical" href="https://ruach.github.io/posts/template-generating-microop/" />
<meta property="og:url" content="https://ruach.github.io/posts/template-generating-microop/" />
<meta property="og:site_name" content="Ruach" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-06-02T00:00:00-04:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Template Generating Microop" />
<meta name="twitter:site" content="@ruach_lee" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2020-06-02T00:00:00-04:00","datePublished":"2020-06-02T00:00:00-04:00","description":"Automatic CPP Class Generation for Macroop and Microop In this post, we will continue to make use of the parser and the grammar defined to understand the Domain Specific Language (DSL) of GEM5. Because DSL is not a general language like CPP compiled by g++, it should be translated into another language which can be compiled, or its compiler should be provided. Therefore, GEM5 utilizes Python Lex-Yacc (PLY) to parse ‘*.isa’ files defining Instruction Set Architecture (ISA) and translate them into CPP classes. This ISA includes macroop and microops of X86 architecture. Therefore, to understand how GEM5 defines ISA, and how they are automatically translated into CPP classes, you should understand how PLY works. It is highly recommended to read this link.","headline":"Template Generating Microop","mainEntityOfPage":{"@type":"WebPage","@id":"https://ruach.github.io/posts/template-generating-microop/"},"url":"https://ruach.github.io/posts/template-generating-microop/"}</script>
<!-- End Jekyll SEO tag -->

  

  <title>Template Generating Microop | Ruach
  </title>

  <!--
  The Favicons for Web, Android, Microsoft, and iOS (iPhone and iPad) Apps
  Generated by: https://realfavicongenerator.net/
-->



<link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png">
<link rel="manifest" href="/assets/img/favicons/site.webmanifest">
<link rel="shortcut icon" href="/assets/img/favicons/favicon.ico">
<meta name="apple-mobile-web-app-title" content="Ruach">
<meta name="application-name" content="Ruach">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml">
<meta name="theme-color" content="#ffffff">


  
    
      <link rel="preconnect" href="https://fonts.googleapis.com" >
      <link rel="dns-prefetch" href="https://fonts.googleapis.com" >
    
      <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      <link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin>
    
      <link rel="preconnect" href="https://fonts.googleapis.com" >
      <link rel="dns-prefetch" href="https://fonts.googleapis.com" >
    
      <link rel="preconnect" href="https://cdn.jsdelivr.net" >
      <link rel="dns-prefetch" href="https://cdn.jsdelivr.net" >
    

    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap">
  

  <!-- GA -->
  

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.2/css/all.min.css">

  <link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css">

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.21.2/dist/tocbot.min.css">
  

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css">
  

  
    <!-- Manific Popup -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css">
  

  <!-- JavaScript -->

  

  <!-- A placeholder to allow defining custom metadata -->

</head>


  <body>
    <!-- The Side Bar -->

<aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end">
  <header class="profile-wrapper">
    <a href="/" id="avatar" class="rounded-circle">
      
        
        <img src="/assets/img/jaehyuk.png" width="112" height="112" alt="avatar" onerror="this.style.display='none'">
      
    </a>

    <h1 class="site-title">
      <a href="/">Ruach</a>
    </h1>
    <p class="site-subtitle fst-italic mb-0">Security Researcher at Gatech</p>
  </header>
  <!-- .profile-wrapper -->

  <nav class="flex-column flex-grow-1 w-100 ps-0">
    <ul class="nav">
      <!-- home -->
      <li class="nav-item">
        <a href="/" class="nav-link">
          <i class="fa-fw fas fa-home"></i>
          <span>HOME</span>
        </a>
      </li>
      <!-- the real tabs -->
      
        <li class="nav-item">
          <a href="/categories/" class="nav-link">
            <i class="fa-fw fas fa-stream"></i>
            

            <span>CATEGORIES</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/tags/" class="nav-link">
            <i class="fa-fw fas fa-tags"></i>
            

            <span>TAGS</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/archives/" class="nav-link">
            <i class="fa-fw fas fa-archive"></i>
            

            <span>ARCHIVES</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/about/" class="nav-link">
            <i class="fa-fw fas fa-info-circle"></i>
            

            <span>ABOUT</span>
          </a>
        </li>
        <!-- .nav-item -->
      
    </ul>
  </nav>

  <div class="sidebar-bottom d-flex flex-wrap  align-items-center w-100">
    

    
      

      
        <a
          href="javascript:location.href = 'mailto:' + ['jaehyuk','gatech.edu'].join('@')"
          aria-label="email"
          

          

          

          
        >
          <i class="fas fa-envelope"></i>
        </a>
      
    
      

      
        <a
          href="https://www.linkedin.com/in/jaehyuk-lee-29b33b121/"
          aria-label="linkedin"
          

          
            target="_blank"
            
          

          

          
            rel="noopener noreferrer"
          
        >
          <i class="fab fa-linkedin"></i>
        </a>
      
    
      

      
        <a
          href="https://github.com/Ruach"
          aria-label="github"
          

          
            target="_blank"
            
          

          

          
            rel="noopener noreferrer"
          
        >
          <i class="fab fa-github"></i>
        </a>
      
    
      

      
        <a
          href="https://stackoverflow.com/users/4460514/ruach?tab=profile"
          aria-label="stack-overflow"
          

          
            target="_blank"
            
          

          

          
            rel="noopener noreferrer"
          
        >
          <i class="fab fa-stack-overflow"></i>
        </a>
      
    
  </div>
  <!-- .sidebar-bottom -->
</aside>
<!-- #sidebar -->


    <div id="main-wrapper" class="d-flex justify-content-center">
      <div class="container d-flex flex-column px-xxl-5">
        <!-- The Top Bar -->

<header id="topbar-wrapper" aria-label="Top Bar">
  <div
    id="topbar"
    class="d-flex align-items-center justify-content-between px-lg-3 h-100"
  >
    <nav id="breadcrumb" aria-label="Breadcrumb">
      

      
        
          
            <span>
              <a href="/">
                Home
              </a>
            </span>

          
        
          
        
          
            
              <span>Template Generating Microop</span>
            

          
        
      
    </nav>
    <!-- endof #breadcrumb -->

    <button type="button" id="sidebar-trigger" class="btn btn-link">
      <i class="fas fa-bars fa-fw"></i>
    </button>

    <div id="topbar-title">
      Post
    </div>

    <button type="button" id="search-trigger" class="btn btn-link">
      <i class="fas fa-search fa-fw"></i>
    </button>

    <search class="align-items-center ms-3 ms-lg-0">
      <i class="fas fa-search fa-fw"></i>
      <input
        class="form-control"
        id="search-input"
        type="search"
        aria-label="search"
        autocomplete="off"
        placeholder="Search..."
      >
    </search>
    <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button>
  </div>
</header>


        <div class="row flex-grow-1">
          <main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4">
            
              <!-- Refactor the HTML structure -->



<!--
  In order to allow a wide table to scroll horizontally,
  we suround the markdown table with `<div class="table-wrapper">` and `</div>`
-->



<!--
  Fixed kramdown code highlight rendering:
  https://github.com/penibelst/jekyll-compress-html/issues/101
  https://github.com/penibelst/jekyll-compress-html/issues/71#issuecomment-188144901
-->



<!-- Change the icon of checkbox -->



<!-- Handle images -->





<!-- Add header for code snippets -->



<!-- Create heading anchors -->





  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    

    
  

  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    

    
  

  
  

  

  
  

  




<!-- return -->




<article class="px-1">
  <header>
    <h1 data-toc-skip>Template Generating Microop</h1>

    <div class="post-meta text-muted">
      <!-- published date -->
      <span>
        Posted
        <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1591070400"
  data-df="ll"
  
    data-bs-toggle="tooltip" data-bs-placement="bottom"
  
>
  Jun  2, 2020
</time>

      </span>

      <!-- lastmod date -->
      

      

      <div class="d-flex justify-content-between">
        <!-- author(s) -->
        <span>
          

          By

          <em>
            
              <a href="https://ruach.github.io">Jaehyuk Lee</a>
            
          </em>
        </span>

        <!-- read time -->
        <!-- Calculate the post's reading time, and display the word count in tooltip -->



<!-- words per minute -->










<!-- return element -->
<span
  class="readtime"
  data-bs-toggle="tooltip"
  data-bs-placement="bottom"
  title="8043 words"
>
  <em>44 min</em> read</span>

      </div>
      <!-- .d-flex -->
    </div>
    <!-- .post-meta -->
  </header>

  <div class="content">
    <h1 id="automatic-cpp-class-generation-for-macroop-and-microop">Automatic CPP Class Generation for Macroop and Microop</h1>
<p>In this post, we will continue to make use of the parser and the grammar defined 
to understand the Domain Specific Language (DSL) of GEM5. Because DSL is not a 
general language like CPP compiled by g++, it should be translated into another 
language which can be compiled, or its compiler should be provided. Therefore, 
GEM5 utilizes Python Lex-Yacc (PLY) to parse ‘*.isa’ files defining Instruction 
Set Architecture (ISA) and translate them into CPP classes. This ISA includes 
macroop and microops of X86 architecture. Therefore, to understand how GEM5 
defines ISA, and how they are automatically translated into CPP classes, you 
should understand how PLY works. It is highly recommended to read 
<a href="https://www.dabeaz.com/ply/ply.html">this link</a>.</p>

<h2 id="continues-on-parser-required-for-parsing-macroop-and-microop"><span class="me-2">Continues on Parser required for parsing macroop and microop</span><a href="#continues-on-parser-required-for-parsing-macroop-and-microop" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<p>I will skip lexer part of the GEM5 isa parser and cover some details of GEM5 
DSL and its parser implementation.</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
</pre></td><td class="rouge-code"><pre><span class="o">*</span><span class="n">gem5</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">arch</span><span class="o">/</span><span class="n">isa_parser</span><span class="p">.</span><span class="n">py</span><span class="o">*</span>
<span class="mi">1919</span>     <span class="k">def</span> <span class="nf">p_specification</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
<span class="mi">1920</span>         <span class="sh">'</span><span class="s">specification : opt_defs_and_outputs top_level_decode_block</span><span class="sh">'</span>
<span class="mi">1921</span> 
<span class="mi">1922</span>         <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">splits</span><span class="p">.</span><span class="nf">iterkeys</span><span class="p">():</span>
<span class="mi">1923</span>             <span class="n">f</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="sh">'</span><span class="se">\n</span><span class="s">#endif</span><span class="se">\n</span><span class="sh">'</span><span class="p">)</span>
<span class="mi">1924</span> 
<span class="mi">1925</span>         <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">files</span><span class="p">.</span><span class="nf">itervalues</span><span class="p">():</span> <span class="c1"># close ALL the files;
</span><span class="mi">1926</span>             <span class="n">f</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span> <span class="c1"># not doing so can cause compilation to fail
</span><span class="mi">1927</span> 
<span class="mi">1928</span>         <span class="n">self</span><span class="p">.</span><span class="nf">write_top_level_files</span><span class="p">()</span>
<span class="mi">1929</span> 
<span class="mi">1930</span>         <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
<span class="mi">1931</span> 
<span class="mi">1932</span>     <span class="c1"># 'opt_defs_and_outputs' is a possibly empty sequence of def and/or
</span><span class="mi">1933</span>     <span class="c1"># output statements. Its productions do the hard work of eventually
</span><span class="mi">1934</span>     <span class="c1"># instantiating a GenCode, which are generally emitted (written to disk)
</span><span class="mi">1935</span>     <span class="c1"># as soon as possible, except for the decode_block, which has to be
</span><span class="mi">1936</span>     <span class="c1"># accumulated into one large function of nested switch/case blocks.
</span><span class="mi">1937</span>     <span class="k">def</span> <span class="nf">p_opt_defs_and_outputs_0</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
<span class="mi">1938</span>         <span class="sh">'</span><span class="s">opt_defs_and_outputs : empty</span><span class="sh">'</span>
<span class="mi">1939</span> 
<span class="mi">1940</span>     <span class="k">def</span> <span class="nf">p_opt_defs_and_outputs_1</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
<span class="mi">1941</span>         <span class="sh">'</span><span class="s">opt_defs_and_outputs : defs_and_outputs</span><span class="sh">'</span>
<span class="mi">1942</span> 
<span class="mi">1943</span>     <span class="k">def</span> <span class="nf">p_defs_and_outputs_0</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
<span class="mi">1944</span>         <span class="sh">'</span><span class="s">defs_and_outputs : def_or_output</span><span class="sh">'</span>
<span class="mi">1945</span> 
<span class="mi">1946</span>     <span class="k">def</span> <span class="nf">p_defs_and_outputs_1</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
<span class="mi">1947</span>         <span class="sh">'</span><span class="s">defs_and_outputs : defs_and_outputs def_or_output</span><span class="sh">'</span>
<span class="mi">1948</span> 
<span class="mi">1949</span>     <span class="c1"># The list of possible definition/output statements.
</span><span class="mi">1950</span>     <span class="c1"># They are all processed as they are seen.
</span><span class="mi">1951</span>     <span class="k">def</span> <span class="nf">p_def_or_output</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
<span class="mi">1952</span>         <span class="sh">'''</span><span class="s">def_or_output : name_decl
1953                          | def_format
1954                          | def_bitfield
1955                          | def_bitfield_struct
1956                          | def_template
1957                          | def_operand_types
1958                          | def_operands
1959                          | output
1960                          | global_let
1961                          | split</span><span class="sh">'''</span>
</pre></td></tr></tbody></table></code></div></div>

<p>To parse the isa files, it requires grammar defined for GEM5 DSL. The top rule 
is the <strong>specification</strong>. It means that content in the all isa files can be 
interpreted as specification which can comprise of <em>opt_defs_and_outputs</em> and 
<em>top_level_decode_block</em>. In this posting we will mainly take a look at 
‘opt_defs_and_outputs’ in detail because it will be further parsed down into 
macroop and microop blocks.</p>

<h2 id="let-block-and-def-template"><span class="me-2">let block and def template</span><a href="#let-block-and-def-template" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<p>When you open the isa files in src/arch/x86/isa/microops/ directory, you will 
notice that it has two different types of statements defining the microop: let 
block and def template. Let’s take a look at the grammar rule for let block.</p>

<h3 id="let---"><span class="me-2">let {{ … }};</span><a href="#let---" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
</pre></td><td class="rouge-code"><pre>    <span class="k">def</span> <span class="nf">p_global_let</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="sh">'</span><span class="s">global_let : LET CODELIT SEMI</span><span class="sh">'</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">updateExportContext</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">exportContext</span><span class="p">[</span><span class="sh">"</span><span class="s">header_output</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sh">''</span>
        <span class="n">self</span><span class="p">.</span><span class="n">exportContext</span><span class="p">[</span><span class="sh">"</span><span class="s">decoder_output</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sh">''</span>
        <span class="n">self</span><span class="p">.</span><span class="n">exportContext</span><span class="p">[</span><span class="sh">"</span><span class="s">exec_output</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sh">''</span>
        <span class="n">self</span><span class="p">.</span><span class="n">exportContext</span><span class="p">[</span><span class="sh">"</span><span class="s">decode_block</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sh">''</span>
        <span class="n">self</span><span class="p">.</span><span class="n">exportContext</span><span class="p">[</span><span class="sh">"</span><span class="s">split</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">make_split</span><span class="p">()</span>
        <span class="n">split_setup</span> <span class="o">=</span> <span class="sh">'''</span><span class="s">
def wrap(func):
    def split(sec):
        globals()[sec + </span><span class="sh">'</span><span class="s">_output</span><span class="sh">'</span><span class="s">] += func(sec)
    return split
split = wrap(split)
del wrap
</span><span class="sh">'''</span>                      
        <span class="c1"># This tricky setup (immediately above) allows us to just write
</span>        <span class="c1"># (e.g.) "split('exec')" in the Python code and the split #ifdef's
</span>        <span class="c1"># will automatically be added to the exec_output variable. The inner
</span>        <span class="c1"># Python execution environment doesn't know about the split points,
</span>        <span class="c1"># so we carefully inject and wrap a closure that can retrieve the
</span>        <span class="c1"># next split's #define from the parser and add it to the current
</span>        <span class="c1"># emission-in-progress.
</span>        <span class="k">try</span><span class="p">:</span>
            <span class="nf">exec</span><span class="p">(</span><span class="n">split_setup</span><span class="o">+</span><span class="nf">fixPythonIndentation</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="n">self</span><span class="p">.</span><span class="n">exportContext</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="n">traceback</span><span class="p">.</span><span class="nf">print_exc</span><span class="p">(</span><span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="p">.</span><span class="n">stdout</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                <span class="k">raise</span>
            <span class="nf">error</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="nf">lineno</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="sh">'</span><span class="s">In global let block: %s</span><span class="sh">'</span> <span class="o">%</span> <span class="n">exc</span><span class="p">)</span>
        <span class="nc">GenCode</span><span class="p">(</span><span class="n">self</span><span class="p">,</span>
                <span class="n">header_output</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">exportContext</span><span class="p">[</span><span class="sh">"</span><span class="s">header_output</span><span class="sh">"</span><span class="p">],</span>
                <span class="n">decoder_output</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">exportContext</span><span class="p">[</span><span class="sh">"</span><span class="s">decoder_output</span><span class="sh">"</span><span class="p">],</span>
                <span class="n">exec_output</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">exportContext</span><span class="p">[</span><span class="sh">"</span><span class="s">exec_output</span><span class="sh">"</span><span class="p">],</span>
                <span class="n">decode_block</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">exportContext</span><span class="p">[</span><span class="sh">"</span><span class="s">decode_block</span><span class="sh">"</span><span class="p">]).</span><span class="nf">emit</span><span class="p">()</span>
</pre></td></tr></tbody></table></code></div></div>

<p>If the parser encounters tokens consisting of let  block, then it invokes 
p_global_let function. Note that it defines a python string defining the grammar
for let block. The most important part of parsing let block is invoking GenCode
function to generate CPP files required for defining the macroop and microop 
classes.</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">GenCode</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="c1"># Constructor.
</span>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">parser</span><span class="p">,</span>
                 <span class="n">header_output</span> <span class="o">=</span> <span class="sh">''</span><span class="p">,</span> <span class="n">decoder_output</span> <span class="o">=</span> <span class="sh">''</span><span class="p">,</span> <span class="n">exec_output</span> <span class="o">=</span> <span class="sh">''</span><span class="p">,</span>
                 <span class="n">decode_block</span> <span class="o">=</span> <span class="sh">''</span><span class="p">,</span> <span class="n">has_decode_default</span> <span class="o">=</span> <span class="bp">False</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">parser</span> <span class="o">=</span> <span class="n">parser</span>
        <span class="n">self</span><span class="p">.</span><span class="n">header_output</span> <span class="o">=</span> <span class="n">header_output</span>
        <span class="n">self</span><span class="p">.</span><span class="n">decoder_output</span> <span class="o">=</span> <span class="n">decoder_output</span>
        <span class="n">self</span><span class="p">.</span><span class="n">exec_output</span> <span class="o">=</span> <span class="n">exec_output</span>
        <span class="n">self</span><span class="p">.</span><span class="n">decode_block</span> <span class="o">=</span> <span class="n">decode_block</span>
        <span class="n">self</span><span class="p">.</span><span class="n">has_decode_default</span> <span class="o">=</span> <span class="n">has_decode_default</span>

    <span class="c1"># Write these code chunks out to the filesystem.  They will be properly
</span>    <span class="c1"># interwoven by the write_top_level_files().
</span>    <span class="k">def</span> <span class="nf">emit</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">header_output</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="nf">get_file</span><span class="p">(</span><span class="sh">'</span><span class="s">header</span><span class="sh">'</span><span class="p">).</span><span class="nf">write</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">header_output</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">decoder_output</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="nf">get_file</span><span class="p">(</span><span class="sh">'</span><span class="s">decoder</span><span class="sh">'</span><span class="p">).</span><span class="nf">write</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">decoder_output</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">exec_output</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="nf">get_file</span><span class="p">(</span><span class="sh">'</span><span class="s">exec</span><span class="sh">'</span><span class="p">).</span><span class="nf">write</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">exec_output</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">decode_block</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="nf">get_file</span><span class="p">(</span><span class="sh">'</span><span class="s">decode_block</span><span class="sh">'</span><span class="p">).</span><span class="nf">write</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">decode_block</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="def-template-id-"><span class="me-2">def template ID {…};</span><a href="#def-template-id-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>One important <em>def_or_output</em>
When parser encounters block def template,</p>
<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="o">*</span><span class="n">gem5</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">arch</span><span class="o">/</span><span class="n">isa_parser</span><span class="p">.</span><span class="n">py</span><span class="o">*</span>

    <span class="k">def</span> <span class="nf">p_def_template</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="sh">'</span><span class="s">def_template : DEF TEMPLATE ID CODELIT SEMI</span><span class="sh">'</span>
        <span class="k">if</span> <span class="n">t</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">templateMap</span><span class="p">:</span>
            <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">warning: template %s already defined</span><span class="sh">"</span> <span class="o">%</span> <span class="n">t</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
        <span class="n">self</span><span class="p">.</span><span class="n">templateMap</span><span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span> <span class="o">=</span> <span class="nc">Template</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">t</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>

</pre></td></tr></tbody></table></code></div></div>

<p>As shown in the grammar rule, 
Template object is instantiated with the code literal 
of the def template block, t[4].
The newly instantiated Template objects will be maintained 
by the templateMap of the parser.
Note that its template name (t[3], ID) 
will be used to index the generated Template object 
inside the map. 
The GEM5 parser defines Template python class for this purpose.</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
</pre></td><td class="rouge-code"><pre> <span class="mi">106</span> <span class="c1">####################
</span> <span class="mi">107</span> <span class="c1"># Template objects.
</span> <span class="mi">108</span> <span class="c1">#
</span> <span class="mi">109</span> <span class="c1"># Template objects are format strings that allow substitution from
</span> <span class="mi">110</span> <span class="c1"># the attribute spaces of other objects (e.g. InstObjParams instances).
</span> <span class="mi">111</span> 
 <span class="mi">112</span> <span class="n">labelRE</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">compile</span><span class="p">(</span><span class="sa">r</span><span class="sh">'</span><span class="s">(?&lt;!%)%\(([^\)]+)\)[sd]</span><span class="sh">'</span><span class="p">)</span>
 <span class="mi">113</span> 
 <span class="mi">114</span> <span class="k">class</span> <span class="nc">Template</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
 <span class="mi">115</span>     <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">parser</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
 <span class="mi">116</span>         <span class="n">self</span><span class="p">.</span><span class="n">parser</span> <span class="o">=</span> <span class="n">parser</span>
 <span class="mi">117</span>         <span class="n">self</span><span class="p">.</span><span class="n">template</span> <span class="o">=</span> <span class="n">t</span>
 <span class="mi">118</span> 
 <span class="mi">119</span>     <span class="k">def</span> <span class="nf">subst</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
 <span class="mi">120</span>         <span class="n">myDict</span> <span class="o">=</span> <span class="bp">None</span>
 <span class="mi">121</span> 
 <span class="mi">122</span>         <span class="c1"># Protect non-Python-dict substitutions (e.g. if there's a printf
</span> <span class="mi">123</span>         <span class="c1"># in the templated C++ code)
</span> <span class="mi">124</span>         <span class="n">template</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="nf">protectNonSubstPercents</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">template</span><span class="p">)</span>
 <span class="mi">125</span> 
 <span class="mi">126</span>         <span class="c1"># Build a dict ('myDict') to use for the template substitution.
</span> <span class="mi">127</span>         <span class="c1"># Start with the template namespace.  Make a copy since we're
</span> <span class="mi">128</span>         <span class="c1"># going to modify it.
</span> <span class="mi">129</span>         <span class="n">myDict</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="n">templateMap</span><span class="p">.</span><span class="nf">copy</span><span class="p">()</span>
 <span class="mi">130</span> 
 <span class="mi">131</span>         <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">InstObjParams</span><span class="p">):</span>
 <span class="mi">132</span>             <span class="c1"># If we're dealing with an InstObjParams object, we need
</span> <span class="mi">133</span>             <span class="c1"># to be a little more sophisticated.  The instruction-wide
</span> <span class="mi">134</span>             <span class="c1"># parameters are already formed, but the parameters which
</span> <span class="mi">135</span>             <span class="c1"># are only function wide still need to be generated.
</span> <span class="mi">136</span>             <span class="n">compositeCode</span> <span class="o">=</span> <span class="sh">''</span>
 <span class="mi">137</span> 
 <span class="mi">138</span>             <span class="n">myDict</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">d</span><span class="p">.</span><span class="n">__dict__</span><span class="p">)</span>
 <span class="mi">139</span>             <span class="c1"># The "operands" and "snippets" attributes of the InstObjParams
</span> <span class="mi">140</span>             <span class="c1"># objects are for internal use and not substitution.
</span> <span class="mi">141</span>             <span class="k">del</span> <span class="n">myDict</span><span class="p">[</span><span class="sh">'</span><span class="s">operands</span><span class="sh">'</span><span class="p">]</span>
 <span class="mi">142</span>             <span class="k">del</span> <span class="n">myDict</span><span class="p">[</span><span class="sh">'</span><span class="s">snippets</span><span class="sh">'</span><span class="p">]</span>
 <span class="mi">143</span> 
 <span class="mi">144</span>             <span class="n">snippetLabels</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">labelRE</span><span class="p">.</span><span class="nf">findall</span><span class="p">(</span><span class="n">template</span><span class="p">)</span>
 <span class="mi">145</span>                              <span class="k">if</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">d</span><span class="p">.</span><span class="n">snippets</span><span class="p">]</span>
 <span class="mi">146</span> 
 <span class="mi">147</span>             <span class="n">snippets</span> <span class="o">=</span> <span class="nf">dict</span><span class="p">([(</span><span class="n">s</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="nf">mungeSnippet</span><span class="p">(</span><span class="n">d</span><span class="p">.</span><span class="n">snippets</span><span class="p">[</span><span class="n">s</span><span class="p">]))</span>
 <span class="mi">148</span>                              <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">snippetLabels</span><span class="p">])</span>
 <span class="mi">149</span> 
 <span class="mi">150</span>             <span class="n">myDict</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">snippets</span><span class="p">)</span>
 <span class="mi">151</span> 
 <span class="mi">152</span>             <span class="n">compositeCode</span> <span class="o">=</span> <span class="sh">'</span><span class="s"> </span><span class="sh">'</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="nf">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">snippets</span><span class="p">.</span><span class="nf">values</span><span class="p">()))</span>
 <span class="mi">153</span> 
 <span class="mi">154</span>             <span class="c1"># Add in template itself in case it references any
</span> <span class="mi">155</span>             <span class="c1"># operands explicitly (like Mem)
</span> <span class="mi">156</span>             <span class="n">compositeCode</span> <span class="o">+=</span> <span class="sh">'</span><span class="s"> </span><span class="sh">'</span> <span class="o">+</span> <span class="n">template</span>
 <span class="mi">157</span> 
 <span class="mi">158</span>             <span class="n">operands</span> <span class="o">=</span> <span class="nc">SubOperandList</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">,</span> <span class="n">compositeCode</span><span class="p">,</span> <span class="n">d</span><span class="p">.</span><span class="n">operands</span><span class="p">)</span>
 <span class="mi">159</span> 
 <span class="mi">160</span>             <span class="n">myDict</span><span class="p">[</span><span class="sh">'</span><span class="s">op_decl</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">operands</span><span class="p">.</span><span class="nf">concatAttrStrings</span><span class="p">(</span><span class="sh">'</span><span class="s">op_decl</span><span class="sh">'</span><span class="p">)</span>
 <span class="mi">161</span>             <span class="k">if</span> <span class="n">operands</span><span class="p">.</span><span class="n">readPC</span> <span class="ow">or</span> <span class="n">operands</span><span class="p">.</span><span class="n">setPC</span><span class="p">:</span>
 <span class="mi">162</span>                 <span class="n">myDict</span><span class="p">[</span><span class="sh">'</span><span class="s">op_decl</span><span class="sh">'</span><span class="p">]</span> <span class="o">+=</span> <span class="sh">'</span><span class="s">TheISA::PCState __parserAutoPCState;</span><span class="se">\n</span><span class="sh">'</span>
 <span class="mi">163</span> 
 <span class="mi">164</span>             <span class="c1"># In case there are predicated register reads and write, declare
</span> <span class="mi">165</span>             <span class="c1"># the variables for register indicies. It is being assumed that
</span> <span class="mi">166</span>             <span class="c1"># all the operands in the OperandList are also in the
</span> <span class="mi">167</span>             <span class="c1"># SubOperandList and in the same order. Otherwise, it is
</span> <span class="mi">168</span>             <span class="c1"># expected that predication would not be used for the operands.
</span> <span class="mi">169</span>             <span class="k">if</span> <span class="n">operands</span><span class="p">.</span><span class="n">predRead</span><span class="p">:</span>
 <span class="mi">170</span>                 <span class="n">myDict</span><span class="p">[</span><span class="sh">'</span><span class="s">op_decl</span><span class="sh">'</span><span class="p">]</span> <span class="o">+=</span> <span class="sh">'</span><span class="s">uint8_t _sourceIndex = 0;</span><span class="se">\n</span><span class="sh">'</span>
 <span class="mi">171</span>             <span class="k">if</span> <span class="n">operands</span><span class="p">.</span><span class="n">predWrite</span><span class="p">:</span>
 <span class="mi">172</span>                 <span class="n">myDict</span><span class="p">[</span><span class="sh">'</span><span class="s">op_decl</span><span class="sh">'</span><span class="p">]</span> <span class="o">+=</span> <span class="sh">'</span><span class="s">uint8_t M5_VAR_USED _destIndex = 0;</span><span class="se">\n</span><span class="sh">'</span>
 <span class="mi">173</span> 
 <span class="mi">174</span>             <span class="n">is_src</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">op</span><span class="p">:</span> <span class="n">op</span><span class="p">.</span><span class="n">is_src</span>
 <span class="mi">175</span>             <span class="n">is_dest</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">op</span><span class="p">:</span> <span class="n">op</span><span class="p">.</span><span class="n">is_dest</span>
 <span class="mi">176</span> 
 <span class="mi">177</span>             <span class="n">myDict</span><span class="p">[</span><span class="sh">'</span><span class="s">op_src_decl</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> \
 <span class="mi">178</span>                       <span class="n">operands</span><span class="p">.</span><span class="nf">concatSomeAttrStrings</span><span class="p">(</span><span class="n">is_src</span><span class="p">,</span> <span class="sh">'</span><span class="s">op_src_decl</span><span class="sh">'</span><span class="p">)</span>
 <span class="mi">179</span>             <span class="n">myDict</span><span class="p">[</span><span class="sh">'</span><span class="s">op_dest_decl</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> \
 <span class="mi">180</span>                       <span class="n">operands</span><span class="p">.</span><span class="nf">concatSomeAttrStrings</span><span class="p">(</span><span class="n">is_dest</span><span class="p">,</span> <span class="sh">'</span><span class="s">op_dest_decl</span><span class="sh">'</span><span class="p">)</span>
 <span class="mi">181</span>             <span class="k">if</span> <span class="n">operands</span><span class="p">.</span><span class="n">readPC</span><span class="p">:</span>
 <span class="mi">182</span>                 <span class="n">myDict</span><span class="p">[</span><span class="sh">'</span><span class="s">op_src_decl</span><span class="sh">'</span><span class="p">]</span> <span class="o">+=</span> \
 <span class="mi">183</span>                     <span class="sh">'</span><span class="s">TheISA::PCState __parserAutoPCState;</span><span class="se">\n</span><span class="sh">'</span>
 <span class="mi">184</span>             <span class="k">if</span> <span class="n">operands</span><span class="p">.</span><span class="n">setPC</span><span class="p">:</span>
 <span class="mi">185</span>                 <span class="n">myDict</span><span class="p">[</span><span class="sh">'</span><span class="s">op_dest_decl</span><span class="sh">'</span><span class="p">]</span> <span class="o">+=</span> \
 <span class="mi">186</span>                     <span class="sh">'</span><span class="s">TheISA::PCState __parserAutoPCState;</span><span class="se">\n</span><span class="sh">'</span>
 <span class="mi">187</span> 
 <span class="mi">188</span>             <span class="n">myDict</span><span class="p">[</span><span class="sh">'</span><span class="s">op_rd</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">operands</span><span class="p">.</span><span class="nf">concatAttrStrings</span><span class="p">(</span><span class="sh">'</span><span class="s">op_rd</span><span class="sh">'</span><span class="p">)</span>
 <span class="mi">189</span>             <span class="k">if</span> <span class="n">operands</span><span class="p">.</span><span class="n">readPC</span><span class="p">:</span>
 <span class="mi">190</span>                 <span class="n">myDict</span><span class="p">[</span><span class="sh">'</span><span class="s">op_rd</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="sh">'</span><span class="s">__parserAutoPCState = xc-&gt;pcState();</span><span class="se">\n</span><span class="sh">'</span> <span class="o">+</span> \
 <span class="mi">191</span>                                   <span class="n">myDict</span><span class="p">[</span><span class="sh">'</span><span class="s">op_rd</span><span class="sh">'</span><span class="p">]</span>
 <span class="mi">192</span> 
 <span class="mi">193</span>             <span class="c1"># Compose the op_wb string. If we're going to write back the
</span> <span class="mi">194</span>             <span class="c1"># PC state because we changed some of its elements, we'll need to
</span> <span class="mi">195</span>             <span class="c1"># do that as early as possible. That allows later uncoordinated
</span> <span class="mi">196</span>             <span class="c1"># modifications to the PC to layer appropriately.
</span> <span class="mi">197</span>             <span class="n">reordered</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="n">operands</span><span class="p">.</span><span class="n">items</span><span class="p">)</span>
 <span class="mi">198</span>             <span class="n">reordered</span><span class="p">.</span><span class="nf">reverse</span><span class="p">()</span>
 <span class="mi">199</span>             <span class="n">op_wb_str</span> <span class="o">=</span> <span class="sh">''</span>
 <span class="mi">200</span>             <span class="n">pcWbStr</span> <span class="o">=</span> <span class="sh">'</span><span class="s">xc-&gt;pcState(__parserAutoPCState);</span><span class="se">\n</span><span class="sh">'</span>
 <span class="mi">201</span>             <span class="k">for</span> <span class="n">op_desc</span> <span class="ow">in</span> <span class="n">reordered</span><span class="p">:</span>
 <span class="mi">202</span>                 <span class="k">if</span> <span class="n">op_desc</span><span class="p">.</span><span class="nf">isPCPart</span><span class="p">()</span> <span class="ow">and</span> <span class="n">op_desc</span><span class="p">.</span><span class="n">is_dest</span><span class="p">:</span>
 <span class="mi">203</span>                     <span class="n">op_wb_str</span> <span class="o">=</span> <span class="n">op_desc</span><span class="p">.</span><span class="n">op_wb</span> <span class="o">+</span> <span class="n">pcWbStr</span> <span class="o">+</span> <span class="n">op_wb_str</span>
 <span class="mi">204</span>                     <span class="n">pcWbStr</span> <span class="o">=</span> <span class="sh">''</span>
 <span class="mi">205</span>                 <span class="k">else</span><span class="p">:</span>
 <span class="mi">206</span>                     <span class="n">op_wb_str</span> <span class="o">=</span> <span class="n">op_desc</span><span class="p">.</span><span class="n">op_wb</span> <span class="o">+</span> <span class="n">op_wb_str</span>
 <span class="mi">207</span>             <span class="n">myDict</span><span class="p">[</span><span class="sh">'</span><span class="s">op_wb</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">op_wb_str</span>
 <span class="mi">208</span> 
 <span class="mi">209</span>         <span class="k">elif</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
 <span class="mi">210</span>             <span class="c1"># if the argument is a dictionary, we just use it.
</span> <span class="mi">211</span>             <span class="n">myDict</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
 <span class="mi">212</span>         <span class="k">elif</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="sh">'</span><span class="s">__dict__</span><span class="sh">'</span><span class="p">):</span>
 <span class="mi">213</span>             <span class="c1"># if the argument is an object, we use its attribute map.
</span> <span class="mi">214</span>             <span class="n">myDict</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">d</span><span class="p">.</span><span class="n">__dict__</span><span class="p">)</span>
 <span class="mi">215</span>         <span class="k">else</span><span class="p">:</span>
 <span class="mi">216</span>             <span class="k">raise</span> <span class="nb">TypeError</span><span class="p">,</span> <span class="sh">"</span><span class="s">Template.subst() arg must be or have dictionary</span><span class="sh">"</span>
 <span class="mi">217</span>         <span class="k">return</span> <span class="n">template</span> <span class="o">%</span> <span class="n">myDict</span>
 <span class="mi">218</span> 
 <span class="mi">219</span>     <span class="c1"># Convert to string.
</span> <span class="mi">220</span>     <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
 <span class="mi">221</span>         <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">template</span>
</pre></td></tr></tbody></table></code></div></div>

<p>When the Template object is instantiated, 
its code-literal will be stored
in the self.template field of the Template object. 
This template field will be used later in the subst method 
to substitute code-literal following the substitution string.</p>

<p>One important definition provided by the Template class is <strong>subst</strong>. 
You can see that it returns template (code literal string)
substituted with myDict. 
Note that the passed code literal contains unfinished parts 
that should be replaced before generating complete CPP statements. 
Therefore, the subst function creates the myDict 
based on the object passed to the subst, d.
Usually, this passed object is InstObjParams providing 
microop or macroop specific information to complete 
general implementation provided by the template. 
Note that subst function manages myDict dictionary differently 
based on the type of the object passed to the subst function.
When the InstObjParams type of object is passed,
depending on the information provided by the items 
such as whether it is used for declaration, op_decl,
or for data write-back, op_wb,
it prepares myDict dictionary properly for later substitution.</p>

<h2 id="automatically-define-cpp-classes-and-associated-methods-for-microop-using-template"><span class="me-2">Automatically define CPP classes and associated methods for microop using template</span><a href="#automatically-define-cpp-classes-and-associated-methods-for-microop-using-template" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<p>In the previous posting, we took a look at how the python class dedicated for 
one microop can be used to represent macroop and microop. 
Also, we saw that python class for macroop is used to populate
CPP class counterpart that can be compiled with other CPP source code 
(GEM5 is CPP based project not python). 
In the middle of that journey, we saw that the getAllocator function
of the microop python class generates CPP code snippets instantiating 
<em>CPP microop class</em> which is the counter part of the microop python class. 
We will see how those CPP classes for microops are generated by utilizing templates.</p>

<h3 id="definemicroloadop-define-micro-load-operations-using-templates"><span class="me-2">defineMicroLoadOp: define micro-load operations using templates</span><a href="#definemicroloadop-define-micro-load-operations-using-templates" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>To understand how the CPP class for one microop can be implemented,
we will take a look at the load related micro instructions in x86 architecture. 
The most important function of this microop class generation is 
the <strong>subst</strong> method provided by the Template object.
GEM5 utilize the substitution a lot to populate 
various instructions having similar semantics.</p>

<p><em>gem5/src/arch/x86/isa/microops/ldstop.isa</em></p>
<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
</pre></td><td class="rouge-code"><pre>
<span class="mi">434</span> <span class="n">let</span> <span class="p">{{</span>
<span class="mi">435</span> 
<span class="mi">436</span>     <span class="c1"># Make these empty strings so that concatenating onto
</span><span class="mi">437</span>     <span class="c1"># them will always work.
</span><span class="mi">438</span>     <span class="n">header_output</span> <span class="o">=</span> <span class="sh">""</span>
<span class="mi">439</span>     <span class="n">decoder_output</span> <span class="o">=</span> <span class="sh">""</span>
<span class="mi">440</span>     <span class="n">exec_output</span> <span class="o">=</span> <span class="sh">""</span>
<span class="mi">441</span> 
<span class="mi">442</span>     <span class="n">segmentEAExpr</span> <span class="o">=</span> \
<span class="mi">443</span>         <span class="sh">'</span><span class="s">bits(scale * Index + Base + disp, addressSize * 8 - 1, 0);</span><span class="sh">'</span>
<span class="mi">444</span> 
<span class="mi">445</span>     <span class="n">calculateEA</span> <span class="o">=</span> <span class="sh">'</span><span class="s">EA = SegBase + </span><span class="sh">'</span> <span class="o">+</span> <span class="n">segmentEAExpr</span>
<span class="mi">446</span> 
<span class="mi">447</span>     <span class="n">debuggingEA</span> <span class="o">=</span> \
<span class="mi">448</span>         <span class="sh">'</span><span class="s">DPRINTF(X86, </span><span class="sh">"</span><span class="s">EA:%#x index:%#x base:%#x disp:%#x Segbase:%#x scale:%#x, addressSize:%#x, dataSize: %#x </span><span class="se">\\</span><span class="s">n</span><span class="sh">"</span><span class="s">, EA, Index, Base, disp, SegBase, scale, addressSize, dataSize)</span><span class="sh">'</span>
<span class="mi">449</span> 
<span class="mi">450</span> 
<span class="mi">451</span>     <span class="k">def</span> <span class="nf">defineMicroLoadOp</span><span class="p">(</span><span class="n">mnemonic</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">bigCode</span><span class="o">=</span><span class="sh">''</span><span class="p">,</span>
<span class="mi">452</span>                           <span class="n">mem_flags</span><span class="o">=</span><span class="sh">"</span><span class="s">0</span><span class="sh">"</span><span class="p">,</span> <span class="n">big</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">nonSpec</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
<span class="mi">453</span>                           <span class="n">implicitStack</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
<span class="mi">454</span>         <span class="k">global</span> <span class="n">header_output</span>
<span class="mi">455</span>         <span class="k">global</span> <span class="n">decoder_output</span>
<span class="mi">456</span>         <span class="k">global</span> <span class="n">exec_output</span>
<span class="mi">457</span>         <span class="k">global</span> <span class="n">microopClasses</span>
<span class="mi">458</span>         <span class="n">Name</span> <span class="o">=</span> <span class="n">mnemonic</span>
<span class="mi">459</span>         <span class="n">name</span> <span class="o">=</span> <span class="n">mnemonic</span><span class="p">.</span><span class="nf">lower</span><span class="p">()</span>
<span class="mi">460</span> 
<span class="mi">461</span>         <span class="c1"># Build up the all register version of this micro op
</span><span class="mi">462</span>         <span class="n">iops</span> <span class="o">=</span> <span class="p">[</span><span class="nc">InstObjParams</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">Name</span><span class="p">,</span> <span class="sh">'</span><span class="s">X86ISA::LdStOp</span><span class="sh">'</span><span class="p">,</span>
<span class="mi">463</span>                               <span class="p">{</span> <span class="sh">"</span><span class="s">code</span><span class="sh">"</span><span class="p">:</span> <span class="n">code</span><span class="p">,</span>
<span class="mi">464</span>                                 <span class="sh">"</span><span class="s">ea_code</span><span class="sh">"</span><span class="p">:</span> <span class="n">calculateEA</span><span class="p">,</span>
<span class="mi">465</span>                                 <span class="sh">"</span><span class="s">memDataSize</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">dataSize</span><span class="sh">"</span> <span class="p">})]</span>
<span class="mi">466</span>         <span class="k">if</span> <span class="n">big</span><span class="p">:</span>
<span class="mi">467</span>             <span class="n">iops</span> <span class="o">+=</span> <span class="p">[</span><span class="nc">InstObjParams</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">Name</span> <span class="o">+</span> <span class="sh">"</span><span class="s">Big</span><span class="sh">"</span><span class="p">,</span> <span class="sh">'</span><span class="s">X86ISA::LdStOp</span><span class="sh">'</span><span class="p">,</span>
<span class="mi">468</span>                                    <span class="p">{</span> <span class="sh">"</span><span class="s">code</span><span class="sh">"</span><span class="p">:</span> <span class="n">bigCode</span><span class="p">,</span>
<span class="mi">469</span>                                      <span class="sh">"</span><span class="s">ea_code</span><span class="sh">"</span><span class="p">:</span> <span class="n">calculateEA</span><span class="p">,</span>
<span class="mi">470</span>                                      <span class="sh">"</span><span class="s">memDataSize</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">dataSize</span><span class="sh">"</span> <span class="p">})]</span>
<span class="mi">471</span>         <span class="k">for</span> <span class="n">iop</span> <span class="ow">in</span> <span class="n">iops</span><span class="p">:</span>
<span class="mi">472</span>             <span class="n">header_output</span> <span class="o">+=</span> <span class="n">MicroLdStOpDeclare</span><span class="p">.</span><span class="nf">subst</span><span class="p">(</span><span class="n">iop</span><span class="p">)</span>
<span class="mi">473</span>             <span class="n">decoder_output</span> <span class="o">+=</span> <span class="n">MicroLdStOpConstructor</span><span class="p">.</span><span class="nf">subst</span><span class="p">(</span><span class="n">iop</span><span class="p">)</span>
<span class="mi">474</span>             <span class="n">exec_output</span> <span class="o">+=</span> <span class="n">MicroLoadExecute</span><span class="p">.</span><span class="nf">subst</span><span class="p">(</span><span class="n">iop</span><span class="p">)</span>
<span class="mi">475</span>             <span class="n">exec_output</span> <span class="o">+=</span> <span class="n">MicroLoadInitiateAcc</span><span class="p">.</span><span class="nf">subst</span><span class="p">(</span><span class="n">iop</span><span class="p">)</span>
<span class="mi">476</span>             <span class="n">exec_output</span> <span class="o">+=</span> <span class="n">MicroLoadCompleteAcc</span><span class="p">.</span><span class="nf">subst</span><span class="p">(</span><span class="n">iop</span><span class="p">)</span>
<span class="mi">477</span> 
<span class="mi">478</span>         <span class="k">if</span> <span class="n">implicitStack</span><span class="p">:</span>
<span class="mi">479</span>             <span class="c1"># For instructions that implicitly access the stack, the address
</span><span class="mi">480</span>             <span class="c1"># size is the same as the stack segment pointer size, not the
</span><span class="mi">481</span>             <span class="c1"># address size if specified by the instruction prefix
</span><span class="mi">482</span>             <span class="n">addressSize</span> <span class="o">=</span> <span class="sh">"</span><span class="s">env.stackSize</span><span class="sh">"</span>
<span class="mi">483</span>         <span class="k">else</span><span class="p">:</span>
<span class="mi">484</span>             <span class="n">addressSize</span> <span class="o">=</span> <span class="sh">"</span><span class="s">env.addressSize</span><span class="sh">"</span>
<span class="mi">485</span> 
<span class="mi">486</span>         <span class="n">base</span> <span class="o">=</span> <span class="n">LdStOp</span>
<span class="mi">487</span>         <span class="k">if</span> <span class="n">big</span><span class="p">:</span>
<span class="mi">488</span>             <span class="n">base</span> <span class="o">=</span> <span class="n">BigLdStOp</span>
<span class="mi">489</span>         <span class="k">class</span> <span class="nc">LoadOp</span><span class="p">(</span><span class="n">base</span><span class="p">):</span>
<span class="mi">490</span>             <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">segment</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">disp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="mi">491</span>                     <span class="n">dataSize</span><span class="o">=</span><span class="sh">"</span><span class="s">env.dataSize</span><span class="sh">"</span><span class="p">,</span>
<span class="mi">492</span>                     <span class="n">addressSize</span><span class="o">=</span><span class="n">addressSize</span><span class="p">,</span>
<span class="mi">493</span>                     <span class="n">atCPL0</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">prefetch</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">nonSpec</span><span class="o">=</span><span class="n">nonSpec</span><span class="p">,</span>
<span class="mi">494</span>                     <span class="n">implicitStack</span><span class="o">=</span><span class="n">implicitStack</span><span class="p">,</span>
<span class="mi">495</span>                     <span class="n">uncacheable</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">EnTlb</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
<span class="mi">496</span>                 <span class="nf">super</span><span class="p">(</span><span class="n">LoadOp</span><span class="p">,</span> <span class="n">self</span><span class="p">).</span><span class="nf">__init__</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">segment</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span>
<span class="mi">497</span>                         <span class="n">disp</span><span class="p">,</span> <span class="n">dataSize</span><span class="p">,</span> <span class="n">addressSize</span><span class="p">,</span> <span class="n">mem_flags</span><span class="p">,</span>
<span class="mi">498</span>                         <span class="n">atCPL0</span><span class="p">,</span> <span class="n">prefetch</span><span class="p">,</span> <span class="n">nonSpec</span><span class="p">,</span> <span class="n">implicitStack</span><span class="p">,</span>
<span class="mi">499</span>                         <span class="n">uncacheable</span><span class="p">,</span> <span class="n">EnTlb</span><span class="p">)</span>
<span class="mi">500</span>                 <span class="n">self</span><span class="p">.</span><span class="n">className</span> <span class="o">=</span> <span class="n">Name</span>
<span class="mi">501</span>                 <span class="n">self</span><span class="p">.</span><span class="n">mnemonic</span> <span class="o">=</span> <span class="n">name</span>
<span class="mi">502</span> 
<span class="mi">503</span>         <span class="n">microopClasses</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">LoadOp</span>
<span class="mi">504</span> 
<span class="mi">505</span>     <span class="nf">defineMicroLoadOp</span><span class="p">(</span><span class="sh">'</span><span class="s">Ld</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">Data = merge(Data, Mem, dataSize);</span><span class="sh">'</span><span class="p">,</span>
<span class="mi">506</span>                             <span class="sh">'</span><span class="s">Data = Mem &amp; mask(dataSize * 8);</span><span class="sh">'</span><span class="p">)</span>
<span class="mi">507</span>     <span class="nf">defineMicroLoadOp</span><span class="p">(</span><span class="sh">'</span><span class="s">Ldis</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">Data = merge(Data, Mem, dataSize);</span><span class="sh">'</span><span class="p">,</span>
<span class="mi">508</span>                               <span class="sh">'</span><span class="s">Data = Mem &amp; mask(dataSize * 8);</span><span class="sh">'</span><span class="p">,</span>
<span class="mi">509</span>                                <span class="n">implicitStack</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="mi">510</span>     <span class="nf">defineMicroLoadOp</span><span class="p">(</span><span class="sh">'</span><span class="s">Ldst</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">Data = merge(Data, Mem, dataSize);</span><span class="sh">'</span><span class="p">,</span>
<span class="mi">511</span>                               <span class="sh">'</span><span class="s">Data = Mem &amp; mask(dataSize * 8);</span><span class="sh">'</span><span class="p">,</span>
<span class="mi">512</span>                       <span class="sh">'</span><span class="s">(StoreCheck &lt;&lt; FlagShift)</span><span class="sh">'</span><span class="p">)</span>
<span class="mi">513</span>     <span class="nf">defineMicroLoadOp</span><span class="p">(</span><span class="sh">'</span><span class="s">Ldstl</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">Data = merge(Data, Mem, dataSize);</span><span class="sh">'</span><span class="p">,</span>
<span class="mi">514</span>                                <span class="sh">'</span><span class="s">Data = Mem &amp; mask(dataSize * 8);</span><span class="sh">'</span><span class="p">,</span>
<span class="mi">515</span>                       <span class="sh">'</span><span class="s">(StoreCheck &lt;&lt; FlagShift) | Request::LOCKED_RMW</span><span class="sh">'</span><span class="p">,</span>
<span class="mi">516</span>                       <span class="n">nonSpec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

</pre></td></tr></tbody></table></code></div></div>

<p>As shown on the line 505-516, 
various load microops are populated by invoking 
defineMicroLoadOp python function. 
Because those microops have similar semantics 
which loads data from memory, 
defineMicroLoadOp function generates different 
microops by substituting generic template with microop-specific code-literals.
You can find that multiple subst definitions from
multiple templates are invoked in the defineMicroLoadOp function (line 472-476)
to generate complete implementation of each microop.</p>

<h2 id="operands-and-its-children-classes-can-handle-all-operands-in-gem5"><span class="me-2">Operands and its children classes can handle all operands in GEM5</span><a href="#operands-and-its-children-classes-can-handle-all-operands-in-gem5" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<p>Before we take a look at how the template is used to generate 
actual code for the microops, we should understand what is the 
InstObjParams and why it is necessary for template substitutions.
To understand InstObjParams, we further need a deeper understanding 
about parameter system deployed by the GEM5.
This includes generic classes to represent parameters of microop and macroop, and 
architecture specific operands and its parsing.</p>

<h3 id="generic-classes-representing-various-types-of-operands-in-gem5"><span class="me-2">Generic classes representing various types of operands in GEM5</span><a href="#generic-classes-representing-various-types-of-operands-in-gem5" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>First of all, we need to understand that GEM5 provide common classes
that can define multiple types of operands regardless of architecture.
We will take a look at the class hierarchies representing various operands.</p>

<p><em>gem5/src/arch/isa_parser.py</em></p>
<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
</pre></td><td class="rouge-code"><pre> <span class="mi">396</span> <span class="k">class</span> <span class="nc">Operand</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
 <span class="mi">397</span>     <span class="sh">'''</span><span class="s">Base class for operand descriptors.  An instance of this class
 398     (or actually a class derived from this one) represents a specific
 399     operand for a code block (e.g, </span><span class="sh">"</span><span class="s">Rc.sq</span><span class="sh">"</span><span class="s"> as a dest). Intermediate
 400     derived classes encapsulates the traits of a particular operand
 401     type (e.g., </span><span class="sh">"</span><span class="s">32-bit integer register</span><span class="sh">"</span><span class="s">).</span><span class="sh">'''</span>
 <span class="mi">402</span> 
 <span class="mi">403</span>     <span class="k">def</span> <span class="nf">buildReadCode</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">func</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
 <span class="mi">404</span>         <span class="n">subst_dict</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">base_name</span><span class="p">,</span>
 <span class="mi">405</span>                       <span class="sh">"</span><span class="s">func</span><span class="sh">"</span><span class="p">:</span> <span class="n">func</span><span class="p">,</span>
 <span class="mi">406</span>                       <span class="sh">"</span><span class="s">reg_idx</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">reg_spec</span><span class="p">,</span>
 <span class="mi">407</span>                       <span class="sh">"</span><span class="s">ctype</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">ctype</span><span class="p">}</span>
 <span class="mi">408</span>         <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="sh">'</span><span class="s">src_reg_idx</span><span class="sh">'</span><span class="p">):</span>
 <span class="mi">409</span>             <span class="n">subst_dict</span><span class="p">[</span><span class="sh">'</span><span class="s">op_idx</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">src_reg_idx</span>
 <span class="mi">410</span>         <span class="n">code</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">read_code</span> <span class="o">%</span> <span class="n">subst_dict</span>
 <span class="mi">411</span>         <span class="k">return</span> <span class="sh">'</span><span class="s">%s = %s;</span><span class="se">\n</span><span class="sh">'</span> <span class="o">%</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">base_name</span><span class="p">,</span> <span class="n">code</span><span class="p">)</span>
 <span class="mi">412</span> 
 <span class="mi">413</span>     <span class="k">def</span> <span class="nf">buildWriteCode</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">func</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
 <span class="mi">414</span>         <span class="n">subst_dict</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">base_name</span><span class="p">,</span>
 <span class="mi">415</span>                       <span class="sh">"</span><span class="s">func</span><span class="sh">"</span><span class="p">:</span> <span class="n">func</span><span class="p">,</span>
 <span class="mi">416</span>                       <span class="sh">"</span><span class="s">reg_idx</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">reg_spec</span><span class="p">,</span>
 <span class="mi">417</span>                       <span class="sh">"</span><span class="s">ctype</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">ctype</span><span class="p">,</span>
 <span class="mi">418</span>                       <span class="sh">"</span><span class="s">final_val</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">base_name</span><span class="p">}</span>
 <span class="mi">419</span>         <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="sh">'</span><span class="s">dest_reg_idx</span><span class="sh">'</span><span class="p">):</span>
 <span class="mi">420</span>             <span class="n">subst_dict</span><span class="p">[</span><span class="sh">'</span><span class="s">op_idx</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">dest_reg_idx</span>
 <span class="mi">421</span>         <span class="n">code</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">write_code</span> <span class="o">%</span> <span class="n">subst_dict</span>
 <span class="mi">422</span>         <span class="k">return</span> <span class="sh">'''</span><span class="s">
 423         {
 424             %s final_val = %s;
 425             %s;
 426             if (traceData) { traceData-&gt;setData(final_val); }
 427         }</span><span class="sh">'''</span> <span class="o">%</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">dflt_ctype</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">base_name</span><span class="p">,</span> <span class="n">code</span><span class="p">)</span>
 <span class="mi">428</span> 
 <span class="mi">429</span>     <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">parser</span><span class="p">,</span> <span class="n">full_name</span><span class="p">,</span> <span class="n">ext</span><span class="p">,</span> <span class="n">is_src</span><span class="p">,</span> <span class="n">is_dest</span><span class="p">):</span>
 <span class="mi">430</span>         <span class="n">self</span><span class="p">.</span><span class="n">full_name</span> <span class="o">=</span> <span class="n">full_name</span>
 <span class="mi">431</span>         <span class="n">self</span><span class="p">.</span><span class="n">ext</span> <span class="o">=</span> <span class="n">ext</span>
 <span class="mi">432</span>         <span class="n">self</span><span class="p">.</span><span class="n">is_src</span> <span class="o">=</span> <span class="n">is_src</span>
 <span class="mi">433</span>         <span class="n">self</span><span class="p">.</span><span class="n">is_dest</span> <span class="o">=</span> <span class="n">is_dest</span>
 <span class="mi">434</span>         <span class="c1"># The 'effective extension' (eff_ext) is either the actual
</span> <span class="mi">435</span>         <span class="c1"># extension, if one was explicitly provided, or the default.
</span> <span class="mi">436</span>         <span class="k">if</span> <span class="n">ext</span><span class="p">:</span>
 <span class="mi">437</span>             <span class="n">self</span><span class="p">.</span><span class="n">eff_ext</span> <span class="o">=</span> <span class="n">ext</span>
 <span class="mi">438</span>         <span class="k">elif</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="sh">'</span><span class="s">dflt_ext</span><span class="sh">'</span><span class="p">):</span>
 <span class="mi">439</span>             <span class="n">self</span><span class="p">.</span><span class="n">eff_ext</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">dflt_ext</span>
 <span class="mi">440</span> 
 <span class="mi">441</span>         <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="sh">'</span><span class="s">eff_ext</span><span class="sh">'</span><span class="p">):</span>
 <span class="mi">442</span>             <span class="n">self</span><span class="p">.</span><span class="n">ctype</span> <span class="o">=</span> <span class="n">parser</span><span class="p">.</span><span class="n">operandTypeMap</span><span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">eff_ext</span><span class="p">]</span>
 <span class="mi">443</span> 
 <span class="mi">444</span>     <span class="c1"># Finalize additional fields (primarily code fields).  This step
</span> <span class="mi">445</span>     <span class="c1"># is done separately since some of these fields may depend on the
</span> <span class="mi">446</span>     <span class="c1"># register index enumeration that hasn't been performed yet at the
</span> <span class="mi">447</span>     <span class="c1"># time of __init__(). The register index enumeration is affected
</span> <span class="mi">448</span>     <span class="c1"># by predicated register reads/writes. Hence, we forward the flags
</span> <span class="mi">449</span>     <span class="c1"># that indicate whether or not predication is in use.
</span> <span class="mi">450</span>     <span class="k">def</span> <span class="nf">finalize</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">predRead</span><span class="p">,</span> <span class="n">predWrite</span><span class="p">):</span>
 <span class="mi">451</span>         <span class="n">self</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">getFlags</span><span class="p">()</span>
 <span class="mi">452</span>         <span class="n">self</span><span class="p">.</span><span class="n">constructor</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">makeConstructor</span><span class="p">(</span><span class="n">predRead</span><span class="p">,</span> <span class="n">predWrite</span><span class="p">)</span>
 <span class="mi">453</span>         <span class="n">self</span><span class="p">.</span><span class="n">op_decl</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">makeDecl</span><span class="p">()</span>
 <span class="mi">454</span> 
 <span class="mi">455</span>         <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">is_src</span><span class="p">:</span>
 <span class="mi">456</span>             <span class="n">self</span><span class="p">.</span><span class="n">op_rd</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">makeRead</span><span class="p">(</span><span class="n">predRead</span><span class="p">)</span>
 <span class="mi">457</span>             <span class="n">self</span><span class="p">.</span><span class="n">op_src_decl</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">makeDecl</span><span class="p">()</span>
 <span class="mi">458</span>         <span class="k">else</span><span class="p">:</span>
 <span class="mi">459</span>             <span class="n">self</span><span class="p">.</span><span class="n">op_rd</span> <span class="o">=</span> <span class="sh">''</span>
 <span class="mi">460</span>             <span class="n">self</span><span class="p">.</span><span class="n">op_src_decl</span> <span class="o">=</span> <span class="sh">''</span>
 <span class="mi">461</span> 
 <span class="mi">462</span>         <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">is_dest</span><span class="p">:</span>
 <span class="mi">463</span>             <span class="n">self</span><span class="p">.</span><span class="n">op_wb</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">makeWrite</span><span class="p">(</span><span class="n">predWrite</span><span class="p">)</span>
 <span class="mi">464</span>             <span class="n">self</span><span class="p">.</span><span class="n">op_dest_decl</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">makeDecl</span><span class="p">()</span>
 <span class="mi">465</span>         <span class="k">else</span><span class="p">:</span>
 <span class="mi">466</span>             <span class="n">self</span><span class="p">.</span><span class="n">op_wb</span> <span class="o">=</span> <span class="sh">''</span>
 <span class="mi">467</span>             <span class="n">self</span><span class="p">.</span><span class="n">op_dest_decl</span> <span class="o">=</span> <span class="sh">''</span>
 <span class="mi">468</span> 
 <span class="mi">469</span>     <span class="k">def</span> <span class="nf">isMem</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
 <span class="mi">470</span>         <span class="k">return</span> <span class="mi">0</span>
 <span class="mi">471</span> 
 <span class="mi">472</span>     <span class="k">def</span> <span class="nf">isReg</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
 <span class="mi">473</span>         <span class="k">return</span> <span class="mi">0</span>
 <span class="mi">474</span> 
 <span class="mi">475</span>     <span class="k">def</span> <span class="nf">isFloatReg</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
 <span class="mi">476</span>         <span class="k">return</span> <span class="mi">0</span>
 <span class="mi">477</span> 
 <span class="mi">478</span>     <span class="k">def</span> <span class="nf">isIntReg</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
 <span class="mi">479</span>         <span class="k">return</span> <span class="mi">0</span>
 <span class="mi">480</span> 
 <span class="mi">481</span>     <span class="k">def</span> <span class="nf">isCCReg</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
 <span class="mi">482</span>         <span class="k">return</span> <span class="mi">0</span>
 <span class="mi">483</span> 
 <span class="mi">484</span>     <span class="k">def</span> <span class="nf">isControlReg</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
 <span class="mi">485</span>         <span class="k">return</span> <span class="mi">0</span>
 <span class="mi">486</span> 
 <span class="mi">487</span>     <span class="k">def</span> <span class="nf">isVecReg</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
 <span class="mi">488</span>         <span class="k">return</span> <span class="mi">0</span>
 <span class="mi">489</span> 
 <span class="mi">490</span>     <span class="k">def</span> <span class="nf">isVecElem</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
 <span class="mi">491</span>         <span class="k">return</span> <span class="mi">0</span>
 <span class="mi">492</span> 
 <span class="mi">493</span>     <span class="k">def</span> <span class="nf">isVecPredReg</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
 <span class="mi">494</span>         <span class="k">return</span> <span class="mi">0</span>
 <span class="mi">495</span> 
 <span class="mi">496</span>     <span class="k">def</span> <span class="nf">isPCState</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
 <span class="mi">497</span>         <span class="k">return</span> <span class="mi">0</span>
 <span class="mi">498</span> 
 <span class="mi">499</span>     <span class="k">def</span> <span class="nf">isPCPart</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
 <span class="mi">500</span>         <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="nf">isPCState</span><span class="p">()</span> <span class="ow">and</span> <span class="n">self</span><span class="p">.</span><span class="n">reg_spec</span>
 <span class="mi">501</span> 
 <span class="mi">502</span>     <span class="k">def</span> <span class="nf">hasReadPred</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
 <span class="mi">503</span>         <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">read_predicate</span> <span class="o">!=</span> <span class="bp">None</span>
 <span class="mi">504</span> 
 <span class="mi">505</span>     <span class="k">def</span> <span class="nf">hasWritePred</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
 <span class="mi">506</span>         <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">write_predicate</span> <span class="o">!=</span> <span class="bp">None</span>
 <span class="mi">507</span> 
 <span class="mi">508</span>     <span class="k">def</span> <span class="nf">getFlags</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
 <span class="mi">509</span>         <span class="c1"># note the empty slice '[:]' gives us a copy of self.flags[0]
</span> <span class="mi">510</span>         <span class="c1"># instead of a reference to it
</span> <span class="mi">511</span>         <span class="n">my_flags</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">flags</span><span class="p">[</span><span class="mi">0</span><span class="p">][:]</span>
 <span class="mi">512</span>         <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">is_src</span><span class="p">:</span>
 <span class="mi">513</span>             <span class="n">my_flags</span> <span class="o">+=</span> <span class="n">self</span><span class="p">.</span><span class="n">flags</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
 <span class="mi">514</span>         <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">is_dest</span><span class="p">:</span>
 <span class="mi">515</span>             <span class="n">my_flags</span> <span class="o">+=</span> <span class="n">self</span><span class="p">.</span><span class="n">flags</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
 <span class="mi">516</span>         <span class="k">return</span> <span class="n">my_flags</span>
 <span class="mi">517</span> 
 <span class="mi">518</span>     <span class="k">def</span> <span class="nf">makeDecl</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
 <span class="mi">519</span>         <span class="c1"># Note that initializations in the declarations are solely
</span> <span class="mi">520</span>         <span class="c1"># to avoid 'uninitialized variable' errors from the compiler.
</span> <span class="mi">521</span>         <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">ctype</span> <span class="o">+</span> <span class="sh">'</span><span class="s"> </span><span class="sh">'</span> <span class="o">+</span> <span class="n">self</span><span class="p">.</span><span class="n">base_name</span> <span class="o">+</span> <span class="sh">'</span><span class="s"> = 0;</span><span class="se">\n</span><span class="sh">'</span><span class="p">;</span>
 <span class="mi">522</span> 
 <span class="mi">523</span> 
 <span class="mi">524</span> <span class="n">src_reg_constructor</span> <span class="o">=</span> <span class="sh">'</span><span class="se">\n\t</span><span class="s">_srcRegIdx[_numSrcRegs++] = RegId(%s, %s);</span><span class="sh">'</span>
 <span class="mi">525</span> <span class="n">dst_reg_constructor</span> <span class="o">=</span> <span class="sh">'</span><span class="se">\n\t</span><span class="s">_destRegIdx[_numDestRegs++] = RegId(%s, %s);</span><span class="sh">'</span>
</pre></td></tr></tbody></table></code></div></div>
<p>The <strong>Operand</strong> class is a generic class provides various definitions 
that can be overridden by its children classes.
Only handful of them are overridden to tell 
a type of the current operand class represents.
Let’s take a look at IntRegOperand class which inherits the 
base Operand class.</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre></td><td class="rouge-code"><pre>
 <span class="mi">528</span> <span class="k">class</span> <span class="nc">IntRegOperand</span><span class="p">(</span><span class="n">Operand</span><span class="p">):</span>
 <span class="mi">529</span>     <span class="n">reg_class</span> <span class="o">=</span> <span class="sh">'</span><span class="s">IntRegClass</span><span class="sh">'</span>
 <span class="mi">530</span> 
 <span class="mi">531</span>     <span class="k">def</span> <span class="nf">isReg</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
 <span class="mi">532</span>         <span class="k">return</span> <span class="mi">1</span>
 <span class="mi">533</span> 
 <span class="mi">534</span>     <span class="k">def</span> <span class="nf">isIntReg</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
 <span class="mi">535</span>         <span class="k">return</span> <span class="mi">1</span>
 <span class="mi">536</span> 
 <span class="mi">537</span>     <span class="k">def</span> <span class="nf">makeConstructor</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">predRead</span><span class="p">,</span> <span class="n">predWrite</span><span class="p">):</span>
 <span class="mi">538</span>         <span class="n">c_src</span> <span class="o">=</span> <span class="sh">''</span>
 <span class="mi">539</span>         <span class="n">c_dest</span> <span class="o">=</span> <span class="sh">''</span>
 <span class="mi">540</span> 
 <span class="mi">541</span>         <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">is_src</span><span class="p">:</span>
 <span class="mi">542</span>             <span class="n">c_src</span> <span class="o">=</span> <span class="n">src_reg_constructor</span> <span class="o">%</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">reg_class</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">reg_spec</span><span class="p">)</span>
 <span class="mi">543</span>             <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="nf">hasReadPred</span><span class="p">():</span>
 <span class="mi">544</span>                 <span class="n">c_src</span> <span class="o">=</span> <span class="sh">'</span><span class="se">\n\t</span><span class="s">if (%s) {%s</span><span class="se">\n\t</span><span class="s">}</span><span class="sh">'</span> <span class="o">%</span> \
 <span class="mi">545</span>                         <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">read_predicate</span><span class="p">,</span> <span class="n">c_src</span><span class="p">)</span>
 <span class="mi">546</span> 
 <span class="mi">547</span>         <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">is_dest</span><span class="p">:</span>
 <span class="mi">548</span>             <span class="n">c_dest</span> <span class="o">=</span> <span class="n">dst_reg_constructor</span> <span class="o">%</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">reg_class</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">reg_spec</span><span class="p">)</span>
 <span class="mi">549</span>             <span class="n">c_dest</span> <span class="o">+=</span> <span class="sh">'</span><span class="se">\n\t</span><span class="s">_numIntDestRegs++;</span><span class="sh">'</span>
 <span class="mi">550</span>             <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="nf">hasWritePred</span><span class="p">():</span>
 <span class="mi">551</span>                 <span class="n">c_dest</span> <span class="o">=</span> <span class="sh">'</span><span class="se">\n\t</span><span class="s">if (%s) {%s</span><span class="se">\n\t</span><span class="s">}</span><span class="sh">'</span> <span class="o">%</span> \
 <span class="mi">552</span>                          <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">write_predicate</span><span class="p">,</span> <span class="n">c_dest</span><span class="p">)</span>
 <span class="mi">553</span> 
 <span class="mi">554</span>         <span class="k">return</span> <span class="n">c_src</span> <span class="o">+</span> <span class="n">c_dest</span>

</pre></td></tr></tbody></table></code></div></div>
<p>The IntRegOperand class represents Integer type operand, 
thus it overrides isReg and isIntReg definition.
One operand can be stored in a register or presented as a constant. 
Note that the IntRegOperand represents 
Integer type operand stored in the register.</p>

<h3 id="finalize-function-generates-actual-code-statements-for-operand"><span class="me-2">Finalize function generates actual code statements for operand</span><a href="#finalize-function-generates-actual-code-statements-for-operand" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>One most important definition provided by the base class is <strong>finalize</strong>. 
Note that all the Operands and its children classes and methods are defined as python syntax.
Therefore, 
we should require a method to convert python representation to 
CPP which can be understandable by the GEM5. 
The finalize definition does this!
Although different version of finalize implementation exists
depending on the operand type,
we will take a look at the finalize of the Operand class. 
This is because most of the children classes of Operand
doesn’t override the finalize method.</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="rouge-code"><pre> <span class="mi">450</span>     <span class="k">def</span> <span class="nf">finalize</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">predRead</span><span class="p">,</span> <span class="n">predWrite</span><span class="p">):</span>
 <span class="mi">451</span>         <span class="n">self</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">getFlags</span><span class="p">()</span>
 <span class="mi">452</span>         <span class="n">self</span><span class="p">.</span><span class="n">constructor</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">makeConstructor</span><span class="p">(</span><span class="n">predRead</span><span class="p">,</span> <span class="n">predWrite</span><span class="p">)</span>
 <span class="mi">453</span>         <span class="n">self</span><span class="p">.</span><span class="n">op_decl</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">makeDecl</span><span class="p">()</span>
 <span class="mi">454</span>
 <span class="mi">455</span>         <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">is_src</span><span class="p">:</span>
 <span class="mi">456</span>             <span class="n">self</span><span class="p">.</span><span class="n">op_rd</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">makeRead</span><span class="p">(</span><span class="n">predRead</span><span class="p">)</span>
 <span class="mi">457</span>             <span class="n">self</span><span class="p">.</span><span class="n">op_src_decl</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">makeDecl</span><span class="p">()</span>
 <span class="mi">458</span>         <span class="k">else</span><span class="p">:</span>
 <span class="mi">459</span>             <span class="n">self</span><span class="p">.</span><span class="n">op_rd</span> <span class="o">=</span> <span class="sh">''</span>
 <span class="mi">460</span>             <span class="n">self</span><span class="p">.</span><span class="n">op_src_decl</span> <span class="o">=</span> <span class="sh">''</span>
 <span class="mi">461</span>
 <span class="mi">462</span>         <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">is_dest</span><span class="p">:</span>
 <span class="mi">463</span>             <span class="n">self</span><span class="p">.</span><span class="n">op_wb</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">makeWrite</span><span class="p">(</span><span class="n">predWrite</span><span class="p">)</span>
 <span class="mi">464</span>             <span class="n">self</span><span class="p">.</span><span class="n">op_dest_decl</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">makeDecl</span><span class="p">()</span>
 <span class="mi">465</span>         <span class="k">else</span><span class="p">:</span>
 <span class="mi">466</span>             <span class="n">self</span><span class="p">.</span><span class="n">op_wb</span> <span class="o">=</span> <span class="sh">''</span>
 <span class="mi">467</span>             <span class="n">self</span><span class="p">.</span><span class="n">op_dest_decl</span> <span class="o">=</span> <span class="sh">''</span>
</pre></td></tr></tbody></table></code></div></div>

<p>The finalize method generates mainly two code bloks:
initialization code for operands generated by <strong>makeConstructor</strong>
and code accessing operands such as register read or write 
retrieved by <strong>makeRead and makeWrite</strong>.
Based on the operand type such as source and destination,
either markeRead or makeWrite will be invoked.
As a result, the actual CPP code statement that can access 
the operands will be generated. 
Let’s take a look at makeRead and makeWrite definitions 
provided by the IntRegOperand class as an example.</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
</pre></td><td class="rouge-code"><pre> <span class="mi">528</span> <span class="k">class</span> <span class="nc">IntRegOperand</span><span class="p">(</span><span class="n">Operand</span><span class="p">):</span>
 <span class="p">...</span><span class="bp">...</span>
 <span class="mi">556</span>     <span class="k">def</span> <span class="nf">makeRead</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">predRead</span><span class="p">):</span>
 <span class="mi">557</span>         <span class="nf">if </span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">ctype</span> <span class="o">==</span> <span class="sh">'</span><span class="s">float</span><span class="sh">'</span> <span class="ow">or</span> <span class="n">self</span><span class="p">.</span><span class="n">ctype</span> <span class="o">==</span> <span class="sh">'</span><span class="s">double</span><span class="sh">'</span><span class="p">):</span>
 <span class="mi">558</span>             <span class="nf">error</span><span class="p">(</span><span class="sh">'</span><span class="s">Attempt to read integer register as FP</span><span class="sh">'</span><span class="p">)</span>
 <span class="mi">559</span>         <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">read_code</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
 <span class="mi">560</span>             <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="nf">buildReadCode</span><span class="p">(</span><span class="sh">'</span><span class="s">readIntRegOperand</span><span class="sh">'</span><span class="p">)</span>
 <span class="mi">561</span> 
 <span class="mi">562</span>         <span class="n">int_reg_val</span> <span class="o">=</span> <span class="sh">''</span>
 <span class="mi">563</span>         <span class="k">if</span> <span class="n">predRead</span><span class="p">:</span>
 <span class="mi">564</span>             <span class="n">int_reg_val</span> <span class="o">=</span> <span class="sh">'</span><span class="s">xc-&gt;readIntRegOperand(this, _sourceIndex++)</span><span class="sh">'</span>
 <span class="mi">565</span>             <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="nf">hasReadPred</span><span class="p">():</span>
 <span class="mi">566</span>                 <span class="n">int_reg_val</span> <span class="o">=</span> <span class="sh">'</span><span class="s">(%s) ? %s : 0</span><span class="sh">'</span> <span class="o">%</span> \
 <span class="mi">567</span>                               <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">read_predicate</span><span class="p">,</span> <span class="n">int_reg_val</span><span class="p">)</span>
 <span class="mi">568</span>         <span class="k">else</span><span class="p">:</span>
 <span class="mi">569</span>             <span class="n">int_reg_val</span> <span class="o">=</span> <span class="sh">'</span><span class="s">xc-&gt;readIntRegOperand(this, %d)</span><span class="sh">'</span> <span class="o">%</span> <span class="n">self</span><span class="p">.</span><span class="n">src_reg_idx</span>
 <span class="mi">570</span> 
 <span class="mi">571</span>         <span class="k">return</span> <span class="sh">'</span><span class="s">%s = %s;</span><span class="se">\n</span><span class="sh">'</span> <span class="o">%</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">base_name</span><span class="p">,</span> <span class="n">int_reg_val</span><span class="p">)</span>
 <span class="mi">572</span> 
 <span class="mi">573</span>     <span class="k">def</span> <span class="nf">makeWrite</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">predWrite</span><span class="p">):</span>
 <span class="mi">574</span>         <span class="nf">if </span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">ctype</span> <span class="o">==</span> <span class="sh">'</span><span class="s">float</span><span class="sh">'</span> <span class="ow">or</span> <span class="n">self</span><span class="p">.</span><span class="n">ctype</span> <span class="o">==</span> <span class="sh">'</span><span class="s">double</span><span class="sh">'</span><span class="p">):</span>
 <span class="mi">575</span>             <span class="nf">error</span><span class="p">(</span><span class="sh">'</span><span class="s">Attempt to write integer register as FP</span><span class="sh">'</span><span class="p">)</span>
 <span class="mi">576</span>         <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">write_code</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
 <span class="mi">577</span>             <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="nf">buildWriteCode</span><span class="p">(</span><span class="sh">'</span><span class="s">setIntRegOperand</span><span class="sh">'</span><span class="p">)</span>
 <span class="mi">578</span> 
 <span class="mi">579</span>         <span class="k">if</span> <span class="n">predWrite</span><span class="p">:</span>
 <span class="mi">580</span>             <span class="n">wp</span> <span class="o">=</span> <span class="sh">'</span><span class="s">true</span><span class="sh">'</span>
 <span class="mi">581</span>             <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="nf">hasWritePred</span><span class="p">():</span>
 <span class="mi">582</span>                 <span class="n">wp</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">write_predicate</span>
 <span class="mi">583</span> 
 <span class="mi">584</span>             <span class="n">wcond</span> <span class="o">=</span> <span class="sh">'</span><span class="s">if (%s)</span><span class="sh">'</span> <span class="o">%</span> <span class="p">(</span><span class="n">wp</span><span class="p">)</span>
 <span class="mi">585</span>             <span class="n">windex</span> <span class="o">=</span> <span class="sh">'</span><span class="s">_destIndex++</span><span class="sh">'</span>
 <span class="mi">586</span>         <span class="k">else</span><span class="p">:</span>
 <span class="mi">587</span>             <span class="n">wcond</span> <span class="o">=</span> <span class="sh">''</span>
 <span class="mi">588</span>             <span class="n">windex</span> <span class="o">=</span> <span class="sh">'</span><span class="s">%d</span><span class="sh">'</span> <span class="o">%</span> <span class="n">self</span><span class="p">.</span><span class="n">dest_reg_idx</span>
 <span class="mi">589</span> 
 <span class="mi">590</span>         <span class="n">wb</span> <span class="o">=</span> <span class="sh">'''</span><span class="s">
 591         %s
 592         {
 593             %s final_val = %s;
 594             xc-&gt;setIntRegOperand(this, %s, final_val);</span><span class="se">\n</span><span class="s">
 595             if (traceData) { traceData-&gt;setData(final_val); }
 596         }</span><span class="sh">'''</span> <span class="o">%</span> <span class="p">(</span><span class="n">wcond</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">ctype</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">base_name</span><span class="p">,</span> <span class="n">windex</span><span class="p">)</span>
 <span class="mi">597</span> 
 <span class="mi">598</span>         <span class="k">return</span> <span class="n">wb</span>
</pre></td></tr></tbody></table></code></div></div>
<p>The above two definitions check whether the current operands type 
matches the type represented by the IntRegOperand class. 
After that, it generates CPP statements 
which allow accesses to the operands and returns the string.</p>

<h2 id="populating-proper-operand-class-instances"><span class="me-2">Populating proper operand class instances</span><a href="#populating-proper-operand-class-instances" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<p>We now understand GEM5 utilizes various types of operand classes 
to represent different type of operands independent on the architectures.
Then how the each ISA of different architectures can utilize those 
classes to generate the operands initialization code and proper access codes
formatted in CPP syntax? Yeah answer is the finalize method we’ve seen, but 
where and how can we generate instances of those operand classes?</p>

<h3 id="instobjparams-containing-all-information-required-for-substitutions"><span class="me-2">InstObjParams containing all information required for substitutions</span><a href="#instobjparams-containing-all-information-required-for-substitutions" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>Now it is time to go back to InstObjParams again!</p>
<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="rouge-code"><pre><span class="mi">451</span>     <span class="k">def</span> <span class="nf">defineMicroLoadOp</span><span class="p">(</span><span class="n">mnemonic</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">bigCode</span><span class="o">=</span><span class="sh">''</span><span class="p">,</span>
<span class="mi">452</span>                           <span class="n">mem_flags</span><span class="o">=</span><span class="sh">"</span><span class="s">0</span><span class="sh">"</span><span class="p">,</span> <span class="n">big</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">nonSpec</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
<span class="mi">453</span>                           <span class="n">implicitStack</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
<span class="p">...</span><span class="bp">...</span>
<span class="mi">461</span>         <span class="c1"># Build up the all register version of this micro op
</span><span class="mi">462</span>         <span class="n">iops</span> <span class="o">=</span> <span class="p">[</span><span class="nc">InstObjParams</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">Name</span><span class="p">,</span> <span class="sh">'</span><span class="s">X86ISA::LdStOp</span><span class="sh">'</span><span class="p">,</span>
<span class="mi">463</span>                               <span class="p">{</span> <span class="sh">"</span><span class="s">code</span><span class="sh">"</span><span class="p">:</span> <span class="n">code</span><span class="p">,</span>
<span class="mi">464</span>                                 <span class="sh">"</span><span class="s">ea_code</span><span class="sh">"</span><span class="p">:</span> <span class="n">calculateEA</span><span class="p">,</span>
<span class="mi">465</span>                                 <span class="sh">"</span><span class="s">memDataSize</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">dataSize</span><span class="sh">"</span> <span class="p">})]</span>
<span class="mi">466</span>         <span class="k">if</span> <span class="n">big</span><span class="p">:</span>
<span class="mi">467</span>             <span class="n">iops</span> <span class="o">+=</span> <span class="p">[</span><span class="nc">InstObjParams</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">Name</span> <span class="o">+</span> <span class="sh">"</span><span class="s">Big</span><span class="sh">"</span><span class="p">,</span> <span class="sh">'</span><span class="s">X86ISA::LdStOp</span><span class="sh">'</span><span class="p">,</span>
<span class="mi">468</span>                                    <span class="p">{</span> <span class="sh">"</span><span class="s">code</span><span class="sh">"</span><span class="p">:</span> <span class="n">bigCode</span><span class="p">,</span>
<span class="mi">469</span>                                      <span class="sh">"</span><span class="s">ea_code</span><span class="sh">"</span><span class="p">:</span> <span class="n">calculateEA</span><span class="p">,</span>
<span class="mi">470</span>                                      <span class="sh">"</span><span class="s">memDataSize</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">dataSize</span><span class="sh">"</span> <span class="p">})]</span>
<span class="mi">471</span>         <span class="k">for</span> <span class="n">iop</span> <span class="ow">in</span> <span class="n">iops</span><span class="p">:</span>
<span class="mi">472</span>             <span class="n">header_output</span> <span class="o">+=</span> <span class="n">MicroLdStOpDeclare</span><span class="p">.</span><span class="nf">subst</span><span class="p">(</span><span class="n">iop</span><span class="p">)</span>
<span class="mi">473</span>             <span class="n">decoder_output</span> <span class="o">+=</span> <span class="n">MicroLdStOpConstructor</span><span class="p">.</span><span class="nf">subst</span><span class="p">(</span><span class="n">iop</span><span class="p">)</span>
<span class="mi">474</span>             <span class="n">exec_output</span> <span class="o">+=</span> <span class="n">MicroLoadExecute</span><span class="p">.</span><span class="nf">subst</span><span class="p">(</span><span class="n">iop</span><span class="p">)</span>
<span class="mi">475</span>             <span class="n">exec_output</span> <span class="o">+=</span> <span class="n">MicroLoadInitiateAcc</span><span class="p">.</span><span class="nf">subst</span><span class="p">(</span><span class="n">iop</span><span class="p">)</span>
<span class="mi">476</span>             <span class="n">exec_output</span> <span class="o">+=</span> <span class="n">MicroLoadCompleteAcc</span><span class="p">.</span><span class="nf">subst</span><span class="p">(</span><span class="n">iop</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></div></div>

<p>You might remember that InstObjParams is used for substituting the template.
As shown in the code line 461-470 of the defineMicroLoadOp python definition,
it defines iops which is the array of InstObjParams.
After the iops array is populated, it is passed to the 
subst function of each template shown in the line 471-476.
The subst function will replace the microop specific part of the implementation
with the information provided by the passed InstObjParams instance.
Note that the code snippets defined as python dictionary using { } are passed to
the constructor of the InstObjParams python class.
When you look up the code and calculateEA variables of the defineMicroLoadOp definition,
you can easily find that they are code snippets also.
Let’s take a look at InstObjParams python class.</p>

<p><em>gem5/src/arch/isa_parser.py</em></p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
</pre></td><td class="rouge-code"><pre><span class="mi">1413</span> <span class="k">class</span> <span class="nc">InstObjParams</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="mi">1414</span>     <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">parser</span><span class="p">,</span> <span class="n">mnem</span><span class="p">,</span> <span class="n">class_name</span><span class="p">,</span> <span class="n">base_class</span> <span class="o">=</span> <span class="sh">''</span><span class="p">,</span>
<span class="mi">1415</span>                  <span class="n">snippets</span> <span class="o">=</span> <span class="p">{},</span> <span class="n">opt_args</span> <span class="o">=</span> <span class="p">[]):</span>
<span class="mi">1416</span>         <span class="n">self</span><span class="p">.</span><span class="n">mnemonic</span> <span class="o">=</span> <span class="n">mnem</span>
<span class="mi">1417</span>         <span class="n">self</span><span class="p">.</span><span class="n">class_name</span> <span class="o">=</span> <span class="n">class_name</span>
<span class="mi">1418</span>         <span class="n">self</span><span class="p">.</span><span class="n">base_class</span> <span class="o">=</span> <span class="n">base_class</span>
<span class="mi">1419</span>         <span class="k">if</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">snippets</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
<span class="mi">1420</span>             <span class="n">snippets</span> <span class="o">=</span> <span class="p">{</span><span class="sh">'</span><span class="s">code</span><span class="sh">'</span> <span class="p">:</span> <span class="n">snippets</span><span class="p">}</span>
<span class="mi">1421</span>         <span class="n">compositeCode</span> <span class="o">=</span> <span class="sh">'</span><span class="s"> </span><span class="sh">'</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="nf">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">snippets</span><span class="p">.</span><span class="nf">values</span><span class="p">()))</span>
<span class="mi">1422</span>         <span class="n">self</span><span class="p">.</span><span class="n">snippets</span> <span class="o">=</span> <span class="n">snippets</span>
<span class="mi">1423</span>
<span class="mi">1424</span>         <span class="n">self</span><span class="p">.</span><span class="n">operands</span> <span class="o">=</span> <span class="nc">OperandList</span><span class="p">(</span><span class="n">parser</span><span class="p">,</span> <span class="n">compositeCode</span><span class="p">)</span>
<span class="mi">1425</span>
<span class="mi">1426</span>         <span class="c1"># The header of the constructor declares the variables to be used
</span><span class="mi">1427</span>         <span class="c1"># in the body of the constructor.
</span><span class="mi">1428</span>         <span class="n">header</span> <span class="o">=</span> <span class="sh">''</span>
<span class="mi">1429</span>         <span class="n">header</span> <span class="o">+=</span> <span class="sh">'</span><span class="se">\n\t</span><span class="s">_numSrcRegs = 0;</span><span class="sh">'</span>
<span class="mi">1430</span>         <span class="n">header</span> <span class="o">+=</span> <span class="sh">'</span><span class="se">\n\t</span><span class="s">_numDestRegs = 0;</span><span class="sh">'</span>
<span class="mi">1431</span>         <span class="n">header</span> <span class="o">+=</span> <span class="sh">'</span><span class="se">\n\t</span><span class="s">_numFPDestRegs = 0;</span><span class="sh">'</span>
<span class="mi">1432</span>         <span class="n">header</span> <span class="o">+=</span> <span class="sh">'</span><span class="se">\n\t</span><span class="s">_numVecDestRegs = 0;</span><span class="sh">'</span>
<span class="mi">1433</span>         <span class="n">header</span> <span class="o">+=</span> <span class="sh">'</span><span class="se">\n\t</span><span class="s">_numVecElemDestRegs = 0;</span><span class="sh">'</span>
<span class="mi">1434</span>         <span class="n">header</span> <span class="o">+=</span> <span class="sh">'</span><span class="se">\n\t</span><span class="s">_numVecPredDestRegs = 0;</span><span class="sh">'</span>
<span class="mi">1435</span>         <span class="n">header</span> <span class="o">+=</span> <span class="sh">'</span><span class="se">\n\t</span><span class="s">_numIntDestRegs = 0;</span><span class="sh">'</span>
<span class="mi">1436</span>         <span class="n">header</span> <span class="o">+=</span> <span class="sh">'</span><span class="se">\n\t</span><span class="s">_numCCDestRegs = 0;</span><span class="sh">'</span>
<span class="mi">1437</span>
<span class="mi">1438</span>         <span class="n">self</span><span class="p">.</span><span class="n">constructor</span> <span class="o">=</span> <span class="n">header</span> <span class="o">+</span> \
<span class="mi">1439</span>                            <span class="n">self</span><span class="p">.</span><span class="n">operands</span><span class="p">.</span><span class="nf">concatAttrStrings</span><span class="p">(</span><span class="sh">'</span><span class="s">constructor</span><span class="sh">'</span><span class="p">)</span>
<span class="mi">1440</span>
<span class="mi">1441</span>         <span class="n">self</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">operands</span><span class="p">.</span><span class="nf">concatAttrLists</span><span class="p">(</span><span class="sh">'</span><span class="s">flags</span><span class="sh">'</span><span class="p">)</span>
<span class="mi">1442</span>
<span class="mi">1443</span>         <span class="n">self</span><span class="p">.</span><span class="n">op_class</span> <span class="o">=</span> <span class="bp">None</span>
<span class="mi">1444</span>
<span class="mi">1445</span>         <span class="c1"># Optional arguments are assumed to be either StaticInst flags
</span><span class="mi">1446</span>         <span class="c1"># or an OpClass value.  To avoid having to import a complete
</span><span class="mi">1447</span>         <span class="c1"># list of these values to match against, we do it ad-hoc
</span><span class="mi">1448</span>         <span class="c1"># with regexps.
</span><span class="mi">1449</span>         <span class="k">for</span> <span class="n">oa</span> <span class="ow">in</span> <span class="n">opt_args</span><span class="p">:</span>
<span class="mi">1450</span>             <span class="k">if</span> <span class="n">instFlagRE</span><span class="p">.</span><span class="nf">match</span><span class="p">(</span><span class="n">oa</span><span class="p">):</span>
<span class="mi">1451</span>                 <span class="n">self</span><span class="p">.</span><span class="n">flags</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">oa</span><span class="p">)</span>
<span class="mi">1452</span>             <span class="k">elif</span> <span class="n">opClassRE</span><span class="p">.</span><span class="nf">match</span><span class="p">(</span><span class="n">oa</span><span class="p">):</span>
<span class="mi">1453</span>                 <span class="n">self</span><span class="p">.</span><span class="n">op_class</span> <span class="o">=</span> <span class="n">oa</span>
<span class="mi">1454</span>             <span class="k">else</span><span class="p">:</span>
<span class="mi">1455</span>                 <span class="nf">error</span><span class="p">(</span><span class="sh">'</span><span class="s">InstObjParams: optional arg </span><span class="sh">"</span><span class="s">%s</span><span class="sh">"</span><span class="s"> not recognized </span><span class="sh">'</span>
<span class="mi">1456</span>                       <span class="sh">'</span><span class="s">as StaticInst::Flag or OpClass.</span><span class="sh">'</span> <span class="o">%</span> <span class="n">oa</span><span class="p">)</span>
<span class="mi">1457</span>
<span class="mi">1458</span>         <span class="c1"># Make a basic guess on the operand class if not set.
</span><span class="mi">1459</span>         <span class="c1"># These are good enough for most cases.
</span><span class="mi">1460</span>         <span class="k">if</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="n">op_class</span><span class="p">:</span>
<span class="mi">1461</span>             <span class="k">if</span> <span class="sh">'</span><span class="s">IsStore</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">flags</span><span class="p">:</span>
<span class="mi">1462</span>                 <span class="c1"># The order matters here: 'IsFloating' and 'IsInteger' are
</span><span class="mi">1463</span>                 <span class="c1"># usually set in FP instructions because of the base
</span><span class="mi">1464</span>                 <span class="c1"># register
</span><span class="mi">1465</span>                 <span class="k">if</span> <span class="sh">'</span><span class="s">IsFloating</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">flags</span><span class="p">:</span>
<span class="mi">1466</span>                     <span class="n">self</span><span class="p">.</span><span class="n">op_class</span> <span class="o">=</span> <span class="sh">'</span><span class="s">FloatMemWriteOp</span><span class="sh">'</span>
<span class="mi">1467</span>                 <span class="k">else</span><span class="p">:</span>
<span class="mi">1468</span>                     <span class="n">self</span><span class="p">.</span><span class="n">op_class</span> <span class="o">=</span> <span class="sh">'</span><span class="s">MemWriteOp</span><span class="sh">'</span>
<span class="mi">1469</span>             <span class="k">elif</span> <span class="sh">'</span><span class="s">IsLoad</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">flags</span> <span class="ow">or</span> <span class="sh">'</span><span class="s">IsPrefetch</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">flags</span><span class="p">:</span>
<span class="mi">1470</span>                 <span class="c1"># The order matters here: 'IsFloating' and 'IsInteger' are
</span><span class="mi">1471</span>                 <span class="c1"># usually set in FP instructions because of the base
</span><span class="mi">1472</span>                 <span class="c1"># register
</span><span class="mi">1473</span>                 <span class="k">if</span> <span class="sh">'</span><span class="s">IsFloating</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">flags</span><span class="p">:</span>
<span class="mi">1474</span>                     <span class="n">self</span><span class="p">.</span><span class="n">op_class</span> <span class="o">=</span> <span class="sh">'</span><span class="s">FloatMemReadOp</span><span class="sh">'</span>
<span class="mi">1475</span>                 <span class="k">else</span><span class="p">:</span>
<span class="mi">1476</span>                     <span class="n">self</span><span class="p">.</span><span class="n">op_class</span> <span class="o">=</span> <span class="sh">'</span><span class="s">MemReadOp</span><span class="sh">'</span>
<span class="mi">1477</span>             <span class="k">elif</span> <span class="sh">'</span><span class="s">IsFloating</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">flags</span><span class="p">:</span>
<span class="mi">1478</span>                 <span class="n">self</span><span class="p">.</span><span class="n">op_class</span> <span class="o">=</span> <span class="sh">'</span><span class="s">FloatAddOp</span><span class="sh">'</span>
<span class="mi">1479</span>             <span class="k">elif</span> <span class="sh">'</span><span class="s">IsVector</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">flags</span><span class="p">:</span>
<span class="mi">1480</span>                 <span class="n">self</span><span class="p">.</span><span class="n">op_class</span> <span class="o">=</span> <span class="sh">'</span><span class="s">SimdAddOp</span><span class="sh">'</span>
<span class="mi">1481</span>             <span class="k">else</span><span class="p">:</span>
<span class="mi">1482</span>                 <span class="n">self</span><span class="p">.</span><span class="n">op_class</span> <span class="o">=</span> <span class="sh">'</span><span class="s">IntAluOp</span><span class="sh">'</span>
<span class="mi">1483</span>
<span class="mi">1484</span>         <span class="c1"># add flag initialization to contructor here to include
</span><span class="mi">1485</span>         <span class="c1"># any flags added via opt_args
</span><span class="mi">1486</span>         <span class="n">self</span><span class="p">.</span><span class="n">constructor</span> <span class="o">+=</span> <span class="nf">makeFlagConstructor</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">flags</span><span class="p">)</span>
<span class="mi">1487</span>
<span class="mi">1488</span>         <span class="c1"># if 'IsFloating' is set, add call to the FP enable check
</span><span class="mi">1489</span>         <span class="c1"># function (which should be provided by isa_desc via a declare)
</span><span class="mi">1490</span>         <span class="c1"># if 'IsVector' is set, add call to the Vector enable check
</span><span class="mi">1491</span>         <span class="c1"># function (which should be provided by isa_desc via a declare)
</span><span class="mi">1492</span>         <span class="k">if</span> <span class="sh">'</span><span class="s">IsFloating</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">flags</span><span class="p">:</span>
<span class="mi">1493</span>             <span class="n">self</span><span class="p">.</span><span class="n">fp_enable_check</span> <span class="o">=</span> <span class="sh">'</span><span class="s">fault = checkFpEnableFault(xc);</span><span class="sh">'</span>
<span class="mi">1494</span>         <span class="k">elif</span> <span class="sh">'</span><span class="s">IsVector</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">flags</span><span class="p">:</span>
<span class="mi">1495</span>             <span class="n">self</span><span class="p">.</span><span class="n">fp_enable_check</span> <span class="o">=</span> <span class="sh">'</span><span class="s">fault = checkVecEnableFault(xc);</span><span class="sh">'</span>
<span class="mi">1496</span>         <span class="k">else</span><span class="p">:</span>
<span class="mi">1497</span>             <span class="n">self</span><span class="p">.</span><span class="n">fp_enable_check</span> <span class="o">=</span> <span class="sh">''</span>
</pre></td></tr></tbody></table></code></div></div>

<p>The main purpose of InstObjParams is defining a particular dictionary. 
This dictionary stores all the passed information including class name and 
code snippets, which will be used later in subst definition of template object
to replace microcode specific parts of the microcode implementation template. 
One of the important information managed by the InstObjParams is the operands field (line 1424).
Note that constructor of the InstObjParams instantiate another object called <strong>OperandList</strong>.</p>

<h3 id="operandlist-parses-operands-from-code-snippets"><span class="me-2">OperandList parses operands from code snippets</span><a href="#operandlist-parses-operands-from-code-snippets" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>The OperandList parses code snippets of microop
and generates <strong>Operand</strong> objects.
Yeah this is one of the location where the Operand objects are populated.
Each Operand provides useful information to
constructor creation and defining multiple definitions required for implementing one microop.
The OperandList can generate Operand classes 
based on the operand keywords specified in the code-snippet. 
Note that OperandList takes second argument of the defineMicroLoadOp definition.</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nf">defineMicroLoadOp</span><span class="p">(</span><span class="sh">'</span><span class="s">Ld</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">Data = merge(Data, Mem, dataSize);</span><span class="sh">'</span><span class="p">,</span>
</pre></td></tr></tbody></table></code></div></div>

<p>For example, in the above defineMicroLoadOp invocation, 
‘Data = merge(Data, Mem, dataSize);’ is passed to the OperandList’s constructor 
and stored to the operands field of the InstObjParams (populated in the defineMicroLoadOp).
Note that this code snippet represents microop’s input and output operands.
To understand details,
Let’s take a look at OperandList python class.</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
</pre></td><td class="rouge-code"><pre><span class="mi">1127</span> <span class="k">class</span> <span class="nc">OperandList</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="mi">1128</span>     <span class="sh">'''</span><span class="s">Find all the operands in the given code block.  Returns an operand
1129     descriptor list (instance of class OperandList).</span><span class="sh">'''</span>
<span class="mi">1130</span>     <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">parser</span><span class="p">,</span> <span class="n">code</span><span class="p">):</span>
<span class="mi">1131</span>         <span class="n">self</span><span class="p">.</span><span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
<span class="mi">1132</span>         <span class="n">self</span><span class="p">.</span><span class="n">bases</span> <span class="o">=</span> <span class="p">{}</span>
<span class="mi">1133</span>         <span class="c1"># delete strings and comments so we don't match on operands inside
</span><span class="mi">1134</span>         <span class="k">for</span> <span class="n">regEx</span> <span class="ow">in</span> <span class="p">(</span><span class="n">stringRE</span><span class="p">,</span> <span class="n">commentRE</span><span class="p">):</span>
<span class="mi">1135</span>             <span class="n">code</span> <span class="o">=</span> <span class="n">regEx</span><span class="p">.</span><span class="nf">sub</span><span class="p">(</span><span class="sh">''</span><span class="p">,</span> <span class="n">code</span><span class="p">)</span>
<span class="mi">1136</span>         <span class="c1"># search for operands
</span><span class="mi">1137</span>         <span class="n">next_pos</span> <span class="o">=</span> <span class="mi">0</span>
<span class="mi">1138</span>         <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
<span class="mi">1139</span>             <span class="n">match</span> <span class="o">=</span> <span class="n">parser</span><span class="p">.</span><span class="n">operandsRE</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">next_pos</span><span class="p">)</span>
<span class="mi">1140</span>             <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span>
<span class="mi">1141</span>                 <span class="c1"># no more matches: we're done
</span><span class="mi">1142</span>                 <span class="k">break</span>
<span class="mi">1143</span>             <span class="n">op</span> <span class="o">=</span> <span class="n">match</span><span class="p">.</span><span class="nf">groups</span><span class="p">()</span>
<span class="mi">1144</span>             <span class="c1"># regexp groups are operand full name, base, and extension
</span><span class="mi">1145</span>             <span class="p">(</span><span class="n">op_full</span><span class="p">,</span> <span class="n">op_base</span><span class="p">,</span> <span class="n">op_ext</span><span class="p">)</span> <span class="o">=</span> <span class="n">op</span>
<span class="mi">1146</span>             <span class="c1"># If is a elem operand, define or update the corresponding
</span><span class="mi">1147</span>             <span class="c1"># vector operand
</span><span class="mi">1148</span>             <span class="n">isElem</span> <span class="o">=</span> <span class="bp">False</span>
<span class="mi">1149</span>             <span class="k">if</span> <span class="n">op_base</span> <span class="ow">in</span> <span class="n">parser</span><span class="p">.</span><span class="n">elemToVector</span><span class="p">:</span>
<span class="mi">1150</span>                 <span class="n">isElem</span> <span class="o">=</span> <span class="bp">True</span>
<span class="mi">1151</span>                 <span class="n">elem_op</span> <span class="o">=</span> <span class="p">(</span><span class="n">op_base</span><span class="p">,</span> <span class="n">op_ext</span><span class="p">)</span>
<span class="mi">1152</span>                 <span class="n">op_base</span> <span class="o">=</span> <span class="n">parser</span><span class="p">.</span><span class="n">elemToVector</span><span class="p">[</span><span class="n">op_base</span><span class="p">]</span>
<span class="mi">1153</span>                 <span class="n">op_ext</span> <span class="o">=</span> <span class="sh">''</span> <span class="c1"># use the default one
</span><span class="mi">1154</span>             <span class="c1"># if the token following the operand is an assignment, this is
</span><span class="mi">1155</span>             <span class="c1"># a destination (LHS), else it's a source (RHS)
</span><span class="mi">1156</span>             <span class="n">is_dest</span> <span class="o">=</span> <span class="p">(</span><span class="n">assignRE</span><span class="p">.</span><span class="nf">match</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">match</span><span class="p">.</span><span class="nf">end</span><span class="p">())</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">)</span>
<span class="mi">1157</span>             <span class="n">is_src</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">is_dest</span>
<span class="mi">1158</span>
<span class="mi">1159</span>             <span class="c1"># see if we've already seen this one
</span><span class="mi">1160</span>             <span class="n">op_desc</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">find_base</span><span class="p">(</span><span class="n">op_base</span><span class="p">)</span>
<span class="mi">1161</span>             <span class="k">if</span> <span class="n">op_desc</span><span class="p">:</span>
<span class="mi">1162</span>                 <span class="k">if</span> <span class="n">op_ext</span> <span class="ow">and</span> <span class="n">op_ext</span> <span class="o">!=</span> <span class="sh">''</span> <span class="ow">and</span> <span class="n">op_desc</span><span class="p">.</span><span class="n">ext</span> <span class="o">!=</span> <span class="n">op_ext</span><span class="p">:</span>
<span class="mi">1163</span>                     <span class="nf">error </span><span class="p">(</span><span class="sh">'</span><span class="s">Inconsistent extensions for operand %s: %s - %s</span><span class="sh">'</span> \
<span class="mi">1164</span>                             <span class="o">%</span> <span class="p">(</span><span class="n">op_base</span><span class="p">,</span> <span class="n">op_desc</span><span class="p">.</span><span class="n">ext</span><span class="p">,</span> <span class="n">op_ext</span><span class="p">))</span>
<span class="mi">1165</span>                 <span class="n">op_desc</span><span class="p">.</span><span class="n">is_src</span> <span class="o">=</span> <span class="n">op_desc</span><span class="p">.</span><span class="n">is_src</span> <span class="ow">or</span> <span class="n">is_src</span>
<span class="mi">1166</span>                 <span class="n">op_desc</span><span class="p">.</span><span class="n">is_dest</span> <span class="o">=</span> <span class="n">op_desc</span><span class="p">.</span><span class="n">is_dest</span> <span class="ow">or</span> <span class="n">is_dest</span>
<span class="mi">1167</span>                 <span class="k">if</span> <span class="n">isElem</span><span class="p">:</span>
<span class="mi">1168</span>                     <span class="p">(</span><span class="n">elem_base</span><span class="p">,</span> <span class="n">elem_ext</span><span class="p">)</span> <span class="o">=</span> <span class="n">elem_op</span>
<span class="mi">1169</span>                     <span class="n">found</span> <span class="o">=</span> <span class="bp">False</span>
<span class="mi">1170</span>                     <span class="k">for</span> <span class="n">ae</span> <span class="ow">in</span> <span class="n">op_desc</span><span class="p">.</span><span class="n">active_elems</span><span class="p">:</span>
<span class="mi">1171</span>                         <span class="p">(</span><span class="n">ae_base</span><span class="p">,</span> <span class="n">ae_ext</span><span class="p">)</span> <span class="o">=</span> <span class="n">ae</span>
<span class="mi">1172</span>                         <span class="k">if</span> <span class="n">ae_base</span> <span class="o">==</span> <span class="n">elem_base</span><span class="p">:</span>
<span class="mi">1173</span>                             <span class="k">if</span> <span class="n">ae_ext</span> <span class="o">!=</span> <span class="n">elem_ext</span><span class="p">:</span>
<span class="mi">1174</span>                                 <span class="nf">error</span><span class="p">(</span><span class="sh">'</span><span class="s">Inconsistent extensions for elem</span><span class="sh">'</span>
<span class="mi">1175</span>                                       <span class="sh">'</span><span class="s"> operand %s</span><span class="sh">'</span> <span class="o">%</span> <span class="n">elem_base</span><span class="p">)</span>
<span class="mi">1176</span>                             <span class="k">else</span><span class="p">:</span>
<span class="mi">1177</span>                                 <span class="n">found</span> <span class="o">=</span> <span class="bp">True</span>
<span class="mi">1178</span>                     <span class="k">if</span> <span class="ow">not</span> <span class="n">found</span><span class="p">:</span>
<span class="mi">1179</span>                         <span class="n">op_desc</span><span class="p">.</span><span class="n">active_elems</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">elem_op</span><span class="p">)</span>
<span class="mi">1180</span>             <span class="k">else</span><span class="p">:</span>
<span class="mi">1181</span>                 <span class="c1"># new operand: create new descriptor
</span><span class="mi">1182</span>                 <span class="n">op_desc</span> <span class="o">=</span> <span class="n">parser</span><span class="p">.</span><span class="n">operandNameMap</span><span class="p">[</span><span class="n">op_base</span><span class="p">](</span><span class="n">parser</span><span class="p">,</span>
<span class="mi">1183</span>                     <span class="n">op_full</span><span class="p">,</span> <span class="n">op_ext</span><span class="p">,</span> <span class="n">is_src</span><span class="p">,</span> <span class="n">is_dest</span><span class="p">)</span>
<span class="mi">1184</span>                 <span class="c1"># if operand is a vector elem, add the corresponding vector
</span><span class="mi">1185</span>                 <span class="c1"># operand if not already done
</span><span class="mi">1186</span>                 <span class="k">if</span> <span class="n">isElem</span><span class="p">:</span>
<span class="mi">1187</span>                     <span class="n">op_desc</span><span class="p">.</span><span class="n">elemExt</span> <span class="o">=</span> <span class="n">elem_op</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="mi">1188</span>                     <span class="n">op_desc</span><span class="p">.</span><span class="n">active_elems</span> <span class="o">=</span> <span class="p">[</span><span class="n">elem_op</span><span class="p">]</span>
<span class="mi">1189</span>                 <span class="n">self</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">op_desc</span><span class="p">)</span>
<span class="mi">1190</span>             <span class="c1"># start next search after end of current match
</span><span class="mi">1191</span>             <span class="n">next_pos</span> <span class="o">=</span> <span class="n">match</span><span class="p">.</span><span class="nf">end</span><span class="p">()</span>
<span class="mi">1192</span>         <span class="n">self</span><span class="p">.</span><span class="nf">sort</span><span class="p">()</span>
<span class="mi">1193</span>         <span class="c1"># enumerate source &amp; dest register operands... used in building
</span><span class="mi">1194</span>         <span class="c1"># constructor later
</span><span class="mi">1195</span>         <span class="n">self</span><span class="p">.</span><span class="n">numSrcRegs</span> <span class="o">=</span> <span class="mi">0</span>
<span class="mi">1196</span>         <span class="n">self</span><span class="p">.</span><span class="n">numDestRegs</span> <span class="o">=</span> <span class="mi">0</span>
<span class="mi">1197</span>         <span class="n">self</span><span class="p">.</span><span class="n">numFPDestRegs</span> <span class="o">=</span> <span class="mi">0</span>
<span class="mi">1198</span>         <span class="n">self</span><span class="p">.</span><span class="n">numIntDestRegs</span> <span class="o">=</span> <span class="mi">0</span>
<span class="mi">1199</span>         <span class="n">self</span><span class="p">.</span><span class="n">numVecDestRegs</span> <span class="o">=</span> <span class="mi">0</span>
<span class="mi">1200</span>         <span class="n">self</span><span class="p">.</span><span class="n">numVecPredDestRegs</span> <span class="o">=</span> <span class="mi">0</span>
<span class="mi">1201</span>         <span class="n">self</span><span class="p">.</span><span class="n">numCCDestRegs</span> <span class="o">=</span> <span class="mi">0</span>
<span class="mi">1202</span>         <span class="n">self</span><span class="p">.</span><span class="n">numMiscDestRegs</span> <span class="o">=</span> <span class="mi">0</span>
<span class="mi">1203</span>         <span class="n">self</span><span class="p">.</span><span class="n">memOperand</span> <span class="o">=</span> <span class="bp">None</span>
<span class="mi">1204</span>
<span class="mi">1205</span>         <span class="c1"># Flags to keep track if one or more operands are to be read/written
</span><span class="mi">1206</span>         <span class="c1"># conditionally.
</span><span class="mi">1207</span>         <span class="n">self</span><span class="p">.</span><span class="n">predRead</span> <span class="o">=</span> <span class="bp">False</span>
<span class="mi">1208</span>         <span class="n">self</span><span class="p">.</span><span class="n">predWrite</span> <span class="o">=</span> <span class="bp">False</span>
<span class="mi">1209</span>
<span class="mi">1210</span>         <span class="k">for</span> <span class="n">op_desc</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">items</span><span class="p">:</span>
<span class="mi">1211</span>             <span class="k">if</span> <span class="n">op_desc</span><span class="p">.</span><span class="nf">isReg</span><span class="p">():</span>
<span class="mi">1212</span>                 <span class="k">if</span> <span class="n">op_desc</span><span class="p">.</span><span class="n">is_src</span><span class="p">:</span>
<span class="mi">1213</span>                     <span class="n">op_desc</span><span class="p">.</span><span class="n">src_reg_idx</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">numSrcRegs</span>
<span class="mi">1214</span>                     <span class="n">self</span><span class="p">.</span><span class="n">numSrcRegs</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="mi">1215</span>                 <span class="k">if</span> <span class="n">op_desc</span><span class="p">.</span><span class="n">is_dest</span><span class="p">:</span>
<span class="mi">1216</span>                     <span class="n">op_desc</span><span class="p">.</span><span class="n">dest_reg_idx</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">numDestRegs</span>
<span class="mi">1217</span>                     <span class="n">self</span><span class="p">.</span><span class="n">numDestRegs</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="mi">1218</span>                     <span class="k">if</span> <span class="n">op_desc</span><span class="p">.</span><span class="nf">isFloatReg</span><span class="p">():</span>
<span class="mi">1219</span>                         <span class="n">self</span><span class="p">.</span><span class="n">numFPDestRegs</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="mi">1220</span>                     <span class="k">elif</span> <span class="n">op_desc</span><span class="p">.</span><span class="nf">isIntReg</span><span class="p">():</span>
<span class="mi">1221</span>                         <span class="n">self</span><span class="p">.</span><span class="n">numIntDestRegs</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="mi">1222</span>                     <span class="k">elif</span> <span class="n">op_desc</span><span class="p">.</span><span class="nf">isVecReg</span><span class="p">():</span>
<span class="mi">1223</span>                         <span class="n">self</span><span class="p">.</span><span class="n">numVecDestRegs</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="mi">1224</span>                     <span class="k">elif</span> <span class="n">op_desc</span><span class="p">.</span><span class="nf">isVecPredReg</span><span class="p">():</span>
<span class="mi">1225</span>                         <span class="n">self</span><span class="p">.</span><span class="n">numVecPredDestRegs</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="mi">1226</span>                     <span class="k">elif</span> <span class="n">op_desc</span><span class="p">.</span><span class="nf">isCCReg</span><span class="p">():</span>
<span class="mi">1227</span>                         <span class="n">self</span><span class="p">.</span><span class="n">numCCDestRegs</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="mi">1228</span>                     <span class="k">elif</span> <span class="n">op_desc</span><span class="p">.</span><span class="nf">isControlReg</span><span class="p">():</span>
<span class="mi">1229</span>                         <span class="n">self</span><span class="p">.</span><span class="n">numMiscDestRegs</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="mi">1230</span>             <span class="k">elif</span> <span class="n">op_desc</span><span class="p">.</span><span class="nf">isMem</span><span class="p">():</span>
<span class="mi">1231</span>                 <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">memOperand</span><span class="p">:</span>
<span class="mi">1232</span>                     <span class="nf">error</span><span class="p">(</span><span class="sh">"</span><span class="s">Code block has more than one memory operand.</span><span class="sh">"</span><span class="p">)</span>
<span class="mi">1233</span>                 <span class="n">self</span><span class="p">.</span><span class="n">memOperand</span> <span class="o">=</span> <span class="n">op_desc</span>
<span class="mi">1234</span>
<span class="mi">1235</span>             <span class="c1"># Check if this operand has read/write predication. If true, then
</span><span class="mi">1236</span>             <span class="c1"># the microop will dynamically index source/dest registers.
</span><span class="mi">1237</span>             <span class="n">self</span><span class="p">.</span><span class="n">predRead</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">predRead</span> <span class="ow">or</span> <span class="n">op_desc</span><span class="p">.</span><span class="nf">hasReadPred</span><span class="p">()</span>
<span class="mi">1238</span>             <span class="n">self</span><span class="p">.</span><span class="n">predWrite</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">predWrite</span> <span class="ow">or</span> <span class="n">op_desc</span><span class="p">.</span><span class="nf">hasWritePred</span><span class="p">()</span>
<span class="mi">1239</span>
<span class="mi">1240</span>         <span class="k">if</span> <span class="n">parser</span><span class="p">.</span><span class="n">maxInstSrcRegs</span> <span class="o">&lt;</span> <span class="n">self</span><span class="p">.</span><span class="n">numSrcRegs</span><span class="p">:</span>
<span class="mi">1241</span>             <span class="n">parser</span><span class="p">.</span><span class="n">maxInstSrcRegs</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">numSrcRegs</span>
<span class="mi">1242</span>         <span class="k">if</span> <span class="n">parser</span><span class="p">.</span><span class="n">maxInstDestRegs</span> <span class="o">&lt;</span> <span class="n">self</span><span class="p">.</span><span class="n">numDestRegs</span><span class="p">:</span>
<span class="mi">1243</span>             <span class="n">parser</span><span class="p">.</span><span class="n">maxInstDestRegs</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">numDestRegs</span>
<span class="mi">1244</span>         <span class="k">if</span> <span class="n">parser</span><span class="p">.</span><span class="n">maxMiscDestRegs</span> <span class="o">&lt;</span> <span class="n">self</span><span class="p">.</span><span class="n">numMiscDestRegs</span><span class="p">:</span>
<span class="mi">1245</span>             <span class="n">parser</span><span class="p">.</span><span class="n">maxMiscDestRegs</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">numMiscDestRegs</span>
<span class="mi">1246</span>
<span class="mi">1247</span>         <span class="c1"># now make a final pass to finalize op_desc fields that may depend
</span><span class="mi">1248</span>         <span class="c1"># on the register enumeration
</span><span class="mi">1249</span>         <span class="k">for</span> <span class="n">op_desc</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">items</span><span class="p">:</span>
<span class="mi">1250</span>             <span class="n">op_desc</span><span class="p">.</span><span class="nf">finalize</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">predRead</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">predWrite</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></div></div>

<p>OperandList parses code snippets with regular expression.
Whenever a new keyword matches, 
it first checks its cache by invoking find_base definition of the OperandList class. 
If there has been a match, it will returns a proper Operand object 
that can represent the found keyword. 
If there is no matches, it should look up <strong>parser.operandNameMap</strong>
which contains all mappings from specific keyword to 
particular Operand object (1180-1189).
Note that the type of matching keyword can be anything
that can be represented by the classes inheriting <em>Operand class</em>.
Whenever, a matching Operand object is found, 
It stores parsed operand to the self.items
through the self.append(op_desc) in line 1189.</p>

<p>After parinsg the operands,
it iterates every parsed operands stored in the self.items
and invokes finalize function of each operand (1249-1250).
The finalize function translates each tokens to a code block that
updates or accesses register
depending on destination, source, and type of the operands.</p>

<h3 id="operand-parsing-and-operandnamemap"><span class="me-2">Operand parsing and operandNameMap</span><a href="#operand-parsing-and-operandnamemap" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>When the new keyword is found in the code snippet,
it should look up the operandNameMap 
to find matching Operand object. 
Then where and how the operandNameMap has been initialized 
to contain all required information for mapping keyword to Operand object. 
The answer is on the parsing!</p>

<p><em>gem5/src/arch/x86/isa/operands.isa</em></p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre></td><td class="rouge-code"><pre> <span class="mi">91</span> <span class="k">def</span> <span class="nf">operands</span> <span class="p">{{</span>
 <span class="mi">92</span>         <span class="sh">'</span><span class="s">SrcReg1</span><span class="sh">'</span><span class="p">:</span>       <span class="nf">foldInt</span><span class="p">(</span><span class="sh">'</span><span class="s">src1</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">foldOBit</span><span class="sh">'</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
 <span class="mi">93</span>         <span class="sh">'</span><span class="s">SSrcReg1</span><span class="sh">'</span><span class="p">:</span>      <span class="nf">intReg</span><span class="p">(</span><span class="sh">'</span><span class="s">src1</span><span class="sh">'</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
 <span class="mi">94</span>         <span class="sh">'</span><span class="s">SrcReg2</span><span class="sh">'</span><span class="p">:</span>       <span class="nf">foldInt</span><span class="p">(</span><span class="sh">'</span><span class="s">src2</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">foldOBit</span><span class="sh">'</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
 <span class="mi">95</span>         <span class="sh">'</span><span class="s">SSrcReg2</span><span class="sh">'</span><span class="p">:</span>      <span class="nf">intReg</span><span class="p">(</span><span class="sh">'</span><span class="s">src2</span><span class="sh">'</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
 <span class="mi">96</span>         <span class="sh">'</span><span class="s">Index</span><span class="sh">'</span><span class="p">:</span>         <span class="nf">foldInt</span><span class="p">(</span><span class="sh">'</span><span class="s">index</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">foldABit</span><span class="sh">'</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
 <span class="mi">97</span>         <span class="sh">'</span><span class="s">Base</span><span class="sh">'</span><span class="p">:</span>          <span class="nf">foldInt</span><span class="p">(</span><span class="sh">'</span><span class="s">base</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">foldABit</span><span class="sh">'</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
 <span class="mi">98</span>         <span class="sh">'</span><span class="s">DestReg</span><span class="sh">'</span><span class="p">:</span>       <span class="nf">foldInt</span><span class="p">(</span><span class="sh">'</span><span class="s">dest</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">foldOBit</span><span class="sh">'</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
 <span class="mi">99</span>         <span class="sh">'</span><span class="s">SDestReg</span><span class="sh">'</span><span class="p">:</span>      <span class="nf">intReg</span><span class="p">(</span><span class="sh">'</span><span class="s">dest</span><span class="sh">'</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
<span class="mi">100</span>         <span class="sh">'</span><span class="s">Data</span><span class="sh">'</span><span class="p">:</span>          <span class="nf">foldInt</span><span class="p">(</span><span class="sh">'</span><span class="s">data</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">foldOBit</span><span class="sh">'</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
<span class="mi">101</span>         <span class="sh">'</span><span class="s">DataLow</span><span class="sh">'</span><span class="p">:</span>       <span class="nf">foldInt</span><span class="p">(</span><span class="sh">'</span><span class="s">dataLow</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">foldOBit</span><span class="sh">'</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
<span class="mi">102</span>         <span class="sh">'</span><span class="s">DataHi</span><span class="sh">'</span><span class="p">:</span>        <span class="nf">foldInt</span><span class="p">(</span><span class="sh">'</span><span class="s">dataHi</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">foldOBit</span><span class="sh">'</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
<span class="mi">103</span>         <span class="sh">'</span><span class="s">ProdLow</span><span class="sh">'</span><span class="p">:</span>       <span class="nf">impIntReg</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span>
<span class="mi">104</span>         <span class="sh">'</span><span class="s">ProdHi</span><span class="sh">'</span><span class="p">:</span>        <span class="nf">impIntReg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span>
<span class="mi">105</span>         <span class="sh">'</span><span class="s">Quotient</span><span class="sh">'</span><span class="p">:</span>      <span class="nf">impIntReg</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">9</span><span class="p">),</span>
<span class="mi">106</span>         <span class="sh">'</span><span class="s">Remainder</span><span class="sh">'</span><span class="p">:</span>     <span class="nf">impIntReg</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
<span class="mi">107</span>         <span class="sh">'</span><span class="s">Divisor</span><span class="sh">'</span><span class="p">:</span>       <span class="nf">impIntReg</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">11</span><span class="p">),</span>
<span class="mi">108</span>         <span class="sh">'</span><span class="s">DoubleBits</span><span class="sh">'</span><span class="p">:</span>    <span class="nf">impIntReg</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">11</span><span class="p">),</span>
<span class="mi">109</span>         <span class="sh">'</span><span class="s">Rax</span><span class="sh">'</span><span class="p">:</span>           <span class="nf">intReg</span><span class="p">(</span><span class="sh">'</span><span class="s">(INTREG_RAX)</span><span class="sh">'</span><span class="p">,</span> <span class="mi">12</span><span class="p">),</span>
<span class="mi">110</span>         <span class="sh">'</span><span class="s">Rbx</span><span class="sh">'</span><span class="p">:</span>           <span class="nf">intReg</span><span class="p">(</span><span class="sh">'</span><span class="s">(INTREG_RBX)</span><span class="sh">'</span><span class="p">,</span> <span class="mi">13</span><span class="p">),</span>
<span class="mi">111</span>         <span class="sh">'</span><span class="s">Rcx</span><span class="sh">'</span><span class="p">:</span>           <span class="nf">intReg</span><span class="p">(</span><span class="sh">'</span><span class="s">(INTREG_RCX)</span><span class="sh">'</span><span class="p">,</span> <span class="mi">14</span><span class="p">),</span>
<span class="mi">112</span>         <span class="sh">'</span><span class="s">Rdx</span><span class="sh">'</span><span class="p">:</span>           <span class="nf">intReg</span><span class="p">(</span><span class="sh">'</span><span class="s">(INTREG_RDX)</span><span class="sh">'</span><span class="p">,</span> <span class="mi">15</span><span class="p">),</span>
<span class="mi">113</span>         <span class="sh">'</span><span class="s">Rsp</span><span class="sh">'</span><span class="p">:</span>           <span class="nf">intReg</span><span class="p">(</span><span class="sh">'</span><span class="s">(INTREG_RSP)</span><span class="sh">'</span><span class="p">,</span> <span class="mi">16</span><span class="p">),</span>
<span class="mi">114</span>         <span class="sh">'</span><span class="s">Rbp</span><span class="sh">'</span><span class="p">:</span>           <span class="nf">intReg</span><span class="p">(</span><span class="sh">'</span><span class="s">(INTREG_RBP)</span><span class="sh">'</span><span class="p">,</span> <span class="mi">17</span><span class="p">),</span>
<span class="mi">115</span>         <span class="sh">'</span><span class="s">Rsi</span><span class="sh">'</span><span class="p">:</span>           <span class="nf">intReg</span><span class="p">(</span><span class="sh">'</span><span class="s">(INTREG_RSI)</span><span class="sh">'</span><span class="p">,</span> <span class="mi">18</span><span class="p">),</span>
<span class="mi">116</span>         <span class="sh">'</span><span class="s">Rdi</span><span class="sh">'</span><span class="p">:</span>           <span class="nf">intReg</span><span class="p">(</span><span class="sh">'</span><span class="s">(INTREG_RDI)</span><span class="sh">'</span><span class="p">,</span> <span class="mi">19</span><span class="p">),</span>
<span class="bp">...</span>


</pre></td></tr></tbody></table></code></div></div>
<p>As shown in the above operands definition, <strong>def operands</strong>,
each architecture defines operands list
that can be used as operands of instructions. 
Although it could be seen as a function definition in the python,
note that its file extension is not py but isa.
Also, this is not a correct function definition semantics in python.
Yeah parser needs to parse this python like block!</p>

<p><em>gem5/src/arch/isa_parser.py</em></p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre><span class="mi">2066</span>     <span class="c1"># Define the mapping from operand names to operand classes and
</span><span class="mi">2067</span>     <span class="c1"># other traits.  Stored in operandNameMap.
</span><span class="mi">2068</span>     <span class="k">def</span> <span class="nf">p_def_operands</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
<span class="mi">2069</span>         <span class="sh">'</span><span class="s">def_operands : DEF OPERANDS CODELIT SEMI</span><span class="sh">'</span>
<span class="mi">2070</span>         <span class="k">if</span> <span class="ow">not</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="sh">'</span><span class="s">operandTypeMap</span><span class="sh">'</span><span class="p">):</span>
<span class="mi">2071</span>             <span class="nf">error</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="nf">lineno</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
<span class="mi">2072</span>                   <span class="sh">'</span><span class="s">error: operand types must be defined before operands</span><span class="sh">'</span><span class="p">)</span>
<span class="mi">2073</span>         <span class="k">try</span><span class="p">:</span>
<span class="mi">2074</span>             <span class="n">user_dict</span> <span class="o">=</span> <span class="nf">eval</span><span class="p">(</span><span class="sh">'</span><span class="s">{</span><span class="sh">'</span> <span class="o">+</span> <span class="n">t</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="sh">'</span><span class="s">}</span><span class="sh">'</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">exportContext</span><span class="p">)</span>
<span class="mi">2075</span>         <span class="k">except</span> <span class="nb">Exception</span><span class="p">,</span> <span class="n">exc</span><span class="p">:</span>
<span class="mi">2076</span>             <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
<span class="mi">2077</span>                 <span class="k">raise</span>
<span class="mi">2078</span>             <span class="nf">error</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="nf">lineno</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="sh">'</span><span class="s">In def operands: %s</span><span class="sh">'</span> <span class="o">%</span> <span class="n">exc</span><span class="p">)</span>
<span class="mi">2079</span>         <span class="n">self</span><span class="p">.</span><span class="nf">buildOperandNameMap</span><span class="p">(</span><span class="n">user_dict</span><span class="p">,</span> <span class="n">t</span><span class="p">.</span><span class="n">lexer</span><span class="p">.</span><span class="n">lineno</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></div></div>

<p>The def operand block is parsed by the isa_parser
as other isa definition.
As shown on the above grammar rule,
when the <strong>def operands</strong> block is found,
it invokes <em>buildOperandNameMap</em> function
and generates <strong>operandNameMap</strong>.
As a result, the operandNameMap can provide mapping between
operands keyword to suitable Operand object used
for accessing that operands.
For example, as shown in the above def operands blocks,
Data keyword is translated into IntRegOperand object.</p>

<h3 id="finalize-example"><span class="me-2">finalize example.</span><a href="#finalize-example" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="rouge-code"><pre> <span class="mi">450</span>     <span class="k">def</span> <span class="nf">finalize</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">predRead</span><span class="p">,</span> <span class="n">predWrite</span><span class="p">):</span>
 <span class="mi">451</span>         <span class="n">self</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">getFlags</span><span class="p">()</span>
 <span class="mi">452</span>         <span class="n">self</span><span class="p">.</span><span class="n">constructor</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">makeConstructor</span><span class="p">(</span><span class="n">predRead</span><span class="p">,</span> <span class="n">predWrite</span><span class="p">)</span>
 <span class="mi">453</span>         <span class="n">self</span><span class="p">.</span><span class="n">op_decl</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">makeDecl</span><span class="p">()</span>
 <span class="mi">454</span> 
 <span class="mi">455</span>         <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">is_src</span><span class="p">:</span>
 <span class="mi">456</span>             <span class="n">self</span><span class="p">.</span><span class="n">op_rd</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">makeRead</span><span class="p">(</span><span class="n">predRead</span><span class="p">)</span>
 <span class="mi">457</span>             <span class="n">self</span><span class="p">.</span><span class="n">op_src_decl</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">makeDecl</span><span class="p">()</span>
 <span class="mi">458</span>         <span class="k">else</span><span class="p">:</span>
 <span class="mi">459</span>             <span class="n">self</span><span class="p">.</span><span class="n">op_rd</span> <span class="o">=</span> <span class="sh">''</span>
 <span class="mi">460</span>             <span class="n">self</span><span class="p">.</span><span class="n">op_src_decl</span> <span class="o">=</span> <span class="sh">''</span>
 <span class="mi">461</span> 
 <span class="mi">462</span>         <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">is_dest</span><span class="p">:</span>
 <span class="mi">463</span>             <span class="n">self</span><span class="p">.</span><span class="n">op_wb</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">makeWrite</span><span class="p">(</span><span class="n">predWrite</span><span class="p">)</span>
 <span class="mi">464</span>             <span class="n">self</span><span class="p">.</span><span class="n">op_dest_decl</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">makeDecl</span><span class="p">()</span>
 <span class="mi">465</span>         <span class="k">else</span><span class="p">:</span>
 <span class="mi">466</span>             <span class="n">self</span><span class="p">.</span><span class="n">op_wb</span> <span class="o">=</span> <span class="sh">''</span>
 <span class="mi">467</span>             <span class="n">self</span><span class="p">.</span><span class="n">op_dest_decl</span> <span class="o">=</span> <span class="sh">''</span>
</pre></td></tr></tbody></table></code></div></div>
<p>After all arguments are translated into proper Operand objects,
the finalize definition of those objects should be invoked 
to generate CPP statements. 
Let’s take a look at the IntRegOperand object because 
Data keyword is mapped to this Operand object. 
Because the IntRegOperand does not override the finalize method,
the finalize method of the base class (Operand) will be invoked.
As a consequence, either makeRead or makeWrite of the IntRegOperand 
Because the Data keyword is located on the LHS of the statement,
it will be set as destination, and the makeWrite operation 
will be invoked as a result of the finalize. 
Also the generated result will be stored in the op_wb field of the IntRegOperand object.
We will see how this field will replace the template of the Ld micro-load instruction. 
Also, note that other fields such as op_xx are generated in the finalize definition
(op_decl for declaring variables, op_rd for read operations for example).</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
</pre></td><td class="rouge-code"><pre> <span class="mi">524</span> <span class="n">src_reg_constructor</span> <span class="o">=</span> <span class="sh">'</span><span class="se">\n\t</span><span class="s">_srcRegIdx[_numSrcRegs++] = RegId(%s, %s);</span><span class="sh">'</span>
 <span class="mi">525</span> <span class="n">dst_reg_constructor</span> <span class="o">=</span> <span class="sh">'</span><span class="se">\n\t</span><span class="s">_destRegIdx[_numDestRegs++] = RegId(%s, %s);</span><span class="sh">'</span>
 <span class="mi">526</span> 
 <span class="mi">527</span> 
 <span class="mi">528</span> <span class="k">class</span> <span class="nc">IntRegOperand</span><span class="p">(</span><span class="n">Operand</span><span class="p">):</span>
 <span class="mi">529</span>     <span class="n">reg_class</span> <span class="o">=</span> <span class="sh">'</span><span class="s">IntRegClass</span><span class="sh">'</span>
 <span class="p">...</span><span class="bp">...</span>
 <span class="mi">537</span>     <span class="k">def</span> <span class="nf">makeConstructor</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">predRead</span><span class="p">,</span> <span class="n">predWrite</span><span class="p">):</span>
 <span class="mi">538</span>         <span class="n">c_src</span> <span class="o">=</span> <span class="sh">''</span>
 <span class="mi">539</span>         <span class="n">c_dest</span> <span class="o">=</span> <span class="sh">''</span>
 <span class="mi">540</span> 
 <span class="mi">541</span>         <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">is_src</span><span class="p">:</span>
 <span class="mi">542</span>             <span class="n">c_src</span> <span class="o">=</span> <span class="n">src_reg_constructor</span> <span class="o">%</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">reg_class</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">reg_spec</span><span class="p">)</span>
 <span class="mi">543</span>             <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="nf">hasReadPred</span><span class="p">():</span>
 <span class="mi">544</span>                 <span class="n">c_src</span> <span class="o">=</span> <span class="sh">'</span><span class="se">\n\t</span><span class="s">if (%s) {%s</span><span class="se">\n\t</span><span class="s">}</span><span class="sh">'</span> <span class="o">%</span> \
 <span class="mi">545</span>                         <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">read_predicate</span><span class="p">,</span> <span class="n">c_src</span><span class="p">)</span>
 <span class="mi">546</span> 
 <span class="mi">547</span>         <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">is_dest</span><span class="p">:</span>
 <span class="mi">548</span>             <span class="n">c_dest</span> <span class="o">=</span> <span class="n">dst_reg_constructor</span> <span class="o">%</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">reg_class</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">reg_spec</span><span class="p">)</span>
 <span class="mi">549</span>             <span class="n">c_dest</span> <span class="o">+=</span> <span class="sh">'</span><span class="se">\n\t</span><span class="s">_numIntDestRegs++;</span><span class="sh">'</span>
 <span class="mi">550</span>             <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="nf">hasWritePred</span><span class="p">():</span>
 <span class="mi">551</span>                 <span class="n">c_dest</span> <span class="o">=</span> <span class="sh">'</span><span class="se">\n\t</span><span class="s">if (%s) {%s</span><span class="se">\n\t</span><span class="s">}</span><span class="sh">'</span> <span class="o">%</span> \
 <span class="mi">552</span>                          <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">write_predicate</span><span class="p">,</span> <span class="n">c_dest</span><span class="p">)</span>
 <span class="p">...</span><span class="bp">...</span>
 <span class="mi">573</span>     <span class="k">def</span> <span class="nf">makeWrite</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">predWrite</span><span class="p">):</span>
 <span class="mi">574</span>         <span class="nf">if </span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">ctype</span> <span class="o">==</span> <span class="sh">'</span><span class="s">float</span><span class="sh">'</span> <span class="ow">or</span> <span class="n">self</span><span class="p">.</span><span class="n">ctype</span> <span class="o">==</span> <span class="sh">'</span><span class="s">double</span><span class="sh">'</span><span class="p">):</span>
 <span class="mi">575</span>             <span class="nf">error</span><span class="p">(</span><span class="sh">'</span><span class="s">Attempt to write integer register as FP</span><span class="sh">'</span><span class="p">)</span>
 <span class="mi">576</span>         <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">write_code</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
 <span class="mi">577</span>             <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="nf">buildWriteCode</span><span class="p">(</span><span class="sh">'</span><span class="s">setIntRegOperand</span><span class="sh">'</span><span class="p">)</span>
 <span class="mi">578</span>
 <span class="mi">579</span>         <span class="k">if</span> <span class="n">predWrite</span><span class="p">:</span>
 <span class="mi">580</span>             <span class="n">wp</span> <span class="o">=</span> <span class="sh">'</span><span class="s">true</span><span class="sh">'</span>
 <span class="mi">581</span>             <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="nf">hasWritePred</span><span class="p">():</span>
 <span class="mi">582</span>                 <span class="n">wp</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">write_predicate</span>
 <span class="mi">583</span>
 <span class="mi">584</span>             <span class="n">wcond</span> <span class="o">=</span> <span class="sh">'</span><span class="s">if (%s)</span><span class="sh">'</span> <span class="o">%</span> <span class="p">(</span><span class="n">wp</span><span class="p">)</span>
 <span class="mi">585</span>             <span class="n">windex</span> <span class="o">=</span> <span class="sh">'</span><span class="s">_destIndex++</span><span class="sh">'</span>
 <span class="mi">586</span>         <span class="k">else</span><span class="p">:</span>
 <span class="mi">587</span>             <span class="n">wcond</span> <span class="o">=</span> <span class="sh">''</span>
 <span class="mi">588</span>             <span class="n">windex</span> <span class="o">=</span> <span class="sh">'</span><span class="s">%d</span><span class="sh">'</span> <span class="o">%</span> <span class="n">self</span><span class="p">.</span><span class="n">dest_reg_idx</span>
 <span class="mi">589</span>
 <span class="mi">590</span>         <span class="n">wb</span> <span class="o">=</span> <span class="sh">'''</span><span class="s">
 591         %s
 592         {
 593             %s final_val = %s;
 594             xc-&gt;setIntRegOperand(this, %s, final_val);</span><span class="se">\n</span><span class="s">
 595             if (traceData) { traceData-&gt;setData(final_val); }
 596         }</span><span class="sh">'''</span> <span class="o">%</span> <span class="p">(</span><span class="n">wcond</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">ctype</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">base_name</span><span class="p">,</span> <span class="n">windex</span><span class="p">)</span>
 <span class="mi">597</span>
 <span class="mi">598</span>         <span class="k">return</span> <span class="n">wb</span>
</pre></td></tr></tbody></table></code></div></div>

<p>As shown in the above code,
the makeWrite definition of the IntRegOperand class also utilize string substitutions. 
The final_val local variable is declared as Integer type because it is IntRegOperand class,
and the self.base_name which is the name of the keyword Data is assigned to the variable. 
After that, by invoking setIntRegOperand function, 
it sets the final_val to the destination register operand 
which can be accessible by the ExecContext (xc). 
The substituted string is returned as a result of finalize method, 
but note that still it is not printed out as CPP statement 
to the automatically generated code yet. 
Yeah! The code has been parsed, produced as the OperandList, and 
stored in the operand field of the <strong>InstObjParams</strong>
Remember that InstObjParams is used to replace generic template 
to generate microcode implementation!</p>

<h2 id="in-a-nutshell-generating-cpp-class-for-microop"><span class="me-2">In a nutshell: generating CPP class for microop</span><a href="#in-a-nutshell-generating-cpp-class-for-microop" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<p>Although we spent a lot of times to cover many details of parser 
such as Template and Operands, the one of the most important goal of this posting is 
understanding how the CPP class associated with one microop 
can be automatically generated. 
In the previous posting, we only found that the getAllocator of the python class 
associated with one microop generates constructor code for initiating 
CPP class defined for the microop. 
However, to implement the CPP class, we also need class definition 
and member functions required to implement semantics of the microop 
in addition to the constructor method of the class.</p>

<h3 id="microldstopdeclare-generating-cpp-class-for-micro-load-operations"><span class="me-2">MicroLdStOpDeclare: generating CPP class for micro-load operations</span><a href="#microldstopdeclare-generating-cpp-class-for-micro-load-operations" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>
<p>Although there are several microops related with load operations, 
the skeleton of those microops are same (represented as Template) 
because they have similarities because of the characteristics of the load operation.
First of all, the MicroLdStOpDeclare template is used to generate 
CPP class declaration.</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">template</span> <span class="n">MicroLdStOpDeclare</span> <span class="p">{{</span>
    <span class="k">class</span> <span class="err">%(</span><span class="nc">class_name</span><span class="p">)</span><span class="n">s</span> <span class="p">:</span> <span class="n">public</span> <span class="o">%</span><span class="p">(</span><span class="n">base_class</span><span class="p">)</span><span class="n">s</span>
    <span class="p">{</span>
      <span class="n">public</span><span class="p">:</span>
        <span class="o">%</span><span class="p">(</span><span class="n">class_name</span><span class="p">)</span><span class="nf">s</span><span class="p">(</span><span class="n">ExtMachInst</span> <span class="n">_machInst</span><span class="p">,</span>
                <span class="n">const</span> <span class="n">char</span> <span class="o">*</span> <span class="n">instMnem</span><span class="p">,</span> <span class="n">uint64_t</span> <span class="n">setFlags</span><span class="p">,</span>
                <span class="n">uint8_t</span> <span class="n">_scale</span><span class="p">,</span> <span class="n">InstRegIndex</span> <span class="n">_index</span><span class="p">,</span> <span class="n">InstRegIndex</span> <span class="n">_base</span><span class="p">,</span>
                <span class="n">uint64_t</span> <span class="n">_disp</span><span class="p">,</span> <span class="n">InstRegIndex</span> <span class="n">_segment</span><span class="p">,</span>
                <span class="n">InstRegIndex</span> <span class="n">_data</span><span class="p">,</span>
                <span class="n">uint8_t</span> <span class="n">_dataSize</span><span class="p">,</span> <span class="n">uint8_t</span> <span class="n">_addressSize</span><span class="p">,</span>
                <span class="n">Request</span><span class="p">::</span><span class="n">FlagsType</span> <span class="n">_memFlags</span><span class="p">);</span>

        <span class="n">Fault</span> <span class="nf">execute</span><span class="p">(</span><span class="n">ExecContext</span> <span class="o">*</span><span class="p">,</span> <span class="n">Trace</span><span class="p">::</span><span class="n">InstRecord</span> <span class="o">*</span><span class="p">)</span> <span class="n">const</span><span class="p">;</span>
        <span class="n">Fault</span> <span class="nf">initiateAcc</span><span class="p">(</span><span class="n">ExecContext</span> <span class="o">*</span><span class="p">,</span> <span class="n">Trace</span><span class="p">::</span><span class="n">InstRecord</span> <span class="o">*</span><span class="p">)</span> <span class="n">const</span><span class="p">;</span>
        <span class="n">Fault</span> <span class="nf">completeAcc</span><span class="p">(</span><span class="n">PacketPtr</span><span class="p">,</span> <span class="n">ExecContext</span> <span class="o">*</span><span class="p">,</span> <span class="n">Trace</span><span class="p">::</span><span class="n">InstRecord</span> <span class="o">*</span><span class="p">)</span> <span class="n">const</span><span class="p">;</span>
    <span class="p">};</span>
<span class="p">}};</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Based on the InstObjParams passed to the defineMicroLoadOp, 
microop specific strings will finish the uncompleted parts of the template.
Note that the generated class also have the constructor 
which we were looking for.</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre><span class="mi">271</span> <span class="k">def</span> <span class="nf">template</span> <span class="n">MicroLdStOpConstructor</span> <span class="p">{{</span>
<span class="mi">272</span>     <span class="o">%</span><span class="p">(</span><span class="n">class_name</span><span class="p">)</span><span class="n">s</span><span class="p">::</span><span class="o">%</span><span class="p">(</span><span class="n">class_name</span><span class="p">)</span><span class="nf">s</span><span class="p">(</span>
<span class="mi">273</span>             <span class="n">ExtMachInst</span> <span class="n">machInst</span><span class="p">,</span> <span class="n">const</span> <span class="n">char</span> <span class="o">*</span> <span class="n">instMnem</span><span class="p">,</span> <span class="n">uint64_t</span> <span class="n">setFlags</span><span class="p">,</span>
<span class="mi">274</span>             <span class="n">uint8_t</span> <span class="n">_scale</span><span class="p">,</span> <span class="n">InstRegIndex</span> <span class="n">_index</span><span class="p">,</span> <span class="n">InstRegIndex</span> <span class="n">_base</span><span class="p">,</span>
<span class="mi">275</span>             <span class="n">uint64_t</span> <span class="n">_disp</span><span class="p">,</span> <span class="n">InstRegIndex</span> <span class="n">_segment</span><span class="p">,</span>
<span class="mi">276</span>             <span class="n">InstRegIndex</span> <span class="n">_data</span><span class="p">,</span>
<span class="mi">277</span>             <span class="n">uint8_t</span> <span class="n">_dataSize</span><span class="p">,</span> <span class="n">uint8_t</span> <span class="n">_addressSize</span><span class="p">,</span>
<span class="mi">278</span>             <span class="n">Request</span><span class="p">::</span><span class="n">FlagsType</span> <span class="n">_memFlags</span><span class="p">)</span> <span class="p">:</span>
<span class="mi">279</span>         <span class="o">%</span><span class="p">(</span><span class="n">base_class</span><span class="p">)</span><span class="nf">s</span><span class="p">(</span><span class="n">machInst</span><span class="p">,</span> <span class="sh">"</span><span class="s">%(mnemonic)s</span><span class="sh">"</span><span class="p">,</span> <span class="n">instMnem</span><span class="p">,</span> <span class="n">setFlags</span><span class="p">,</span>
<span class="mi">280</span>                 <span class="n">_scale</span><span class="p">,</span> <span class="n">_index</span><span class="p">,</span> <span class="n">_base</span><span class="p">,</span>
<span class="mi">281</span>                 <span class="n">_disp</span><span class="p">,</span> <span class="n">_segment</span><span class="p">,</span> <span class="n">_data</span><span class="p">,</span>
<span class="mi">282</span>                 <span class="n">_dataSize</span><span class="p">,</span> <span class="n">_addressSize</span><span class="p">,</span> <span class="n">_memFlags</span><span class="p">,</span> <span class="o">%</span><span class="p">(</span><span class="n">op_class</span><span class="p">)</span><span class="n">s</span><span class="p">)</span>
<span class="mi">283</span>     <span class="p">{</span>
<span class="mi">284</span>         <span class="o">%</span><span class="p">(</span><span class="n">constructor</span><span class="p">)</span><span class="n">s</span><span class="p">;</span>
<span class="mi">285</span>     <span class="p">}</span>
<span class="mi">286</span> <span class="p">}};</span>
</pre></td></tr></tbody></table></code></div></div>

<p>The constructor’s implementation itself can be also generated 
with the help of another Template substitution, MicroLdStOpConstructor.</p>

<h2 id="microloadexecute-template-used-to-implement-micro-load-operation"><span class="me-2">MicroLoadExecute: template used to implement micro-load operation</span><a href="#microloadexecute-template-used-to-implement-micro-load-operation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>
<p>More importantly, in addition to the constructor for the microop, 
each microop should implement several definitions 
to have proper semantics of the microop.<br />
Let’s take a look at the MicroLoadExecute template. 
The definition generated by this template is called <strong>execute</strong>, and 
most of the Ld style microcode implements this function. 
However, depending on the semantics of micro-load instructions,
different implementation of the execute will be populated. 
The different InstObjParams result in different replacement in the template,
and the corresponding implementation will be produced as a consequence.</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre></td><td class="rouge-code"><pre>
 <span class="mi">90</span> <span class="k">def</span> <span class="nf">template</span> <span class="n">MicroLoadExecute</span> <span class="p">{{</span>
 <span class="mi">91</span>     <span class="n">Fault</span> <span class="o">%</span><span class="p">(</span><span class="n">class_name</span><span class="p">)</span><span class="n">s</span><span class="p">::</span><span class="nf">execute</span><span class="p">(</span><span class="n">ExecContext</span> <span class="o">*</span><span class="n">xc</span><span class="p">,</span>
 <span class="mi">92</span>           <span class="n">Trace</span><span class="p">::</span><span class="n">InstRecord</span> <span class="o">*</span><span class="n">traceData</span><span class="p">)</span> <span class="n">const</span>
 <span class="mi">93</span>     <span class="p">{</span>

 <span class="mi">94</span>         <span class="n">Fault</span> <span class="n">fault</span> <span class="o">=</span> <span class="n">NoFault</span><span class="p">;</span>
 <span class="mi">95</span>         <span class="n">Addr</span> <span class="n">EA</span><span class="p">;</span>
 <span class="mi">96</span>
 <span class="mi">97</span>         <span class="o">%</span><span class="p">(</span><span class="n">op_decl</span><span class="p">)</span><span class="n">s</span><span class="p">;</span>
 <span class="mi">98</span>         <span class="o">%</span><span class="p">(</span><span class="n">op_rd</span><span class="p">)</span><span class="n">s</span><span class="p">;</span>
 <span class="mi">99</span>         <span class="o">%</span><span class="p">(</span><span class="n">ea_code</span><span class="p">)</span><span class="n">s</span><span class="p">;</span>
<span class="mi">100</span>         <span class="nc">DPRINTF</span><span class="p">(</span><span class="n">X86</span><span class="p">,</span> <span class="sh">"</span><span class="s">%s : %s: The address is %#x</span><span class="se">\n</span><span class="sh">"</span><span class="p">,</span> <span class="n">instMnem</span><span class="p">,</span> <span class="n">mnemonic</span><span class="p">,</span> <span class="n">EA</span><span class="p">);</span>
<span class="mi">101</span>
<span class="mi">102</span>         <span class="n">fault</span> <span class="o">=</span> <span class="nf">readMemAtomic</span><span class="p">(</span><span class="n">xc</span><span class="p">,</span> <span class="n">traceData</span><span class="p">,</span> <span class="n">EA</span><span class="p">,</span> <span class="n">Mem</span><span class="p">,</span> <span class="n">dataSize</span><span class="p">,</span> <span class="n">memFlags</span><span class="p">);</span>
<span class="mi">103</span>
<span class="mi">104</span>         <span class="nf">if </span><span class="p">(</span><span class="n">fault</span> <span class="o">==</span> <span class="n">NoFault</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">105</span>             <span class="o">%</span><span class="p">(</span><span class="n">code</span><span class="p">)</span><span class="n">s</span><span class="p">;</span>
<span class="mi">106</span>         <span class="p">}</span> <span class="k">else</span> <span class="nf">if </span><span class="p">(</span><span class="n">memFlags</span> <span class="o">&amp;</span> <span class="n">Request</span><span class="p">::</span><span class="n">PREFETCH</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">107</span>             <span class="o">//</span> <span class="n">For</span> <span class="n">prefetches</span><span class="p">,</span> <span class="n">ignore</span> <span class="nb">any</span> <span class="n">faults</span><span class="o">/</span><span class="n">exceptions</span><span class="p">.</span>
<span class="mi">108</span>             <span class="k">return</span> <span class="n">NoFault</span><span class="p">;</span>
<span class="mi">109</span>         <span class="p">}</span>
<span class="mi">110</span>         <span class="nf">if</span><span class="p">(</span><span class="n">fault</span> <span class="o">==</span> <span class="n">NoFault</span><span class="p">)</span>
<span class="mi">111</span>         <span class="p">{</span>
<span class="mi">112</span>             <span class="o">%</span><span class="p">(</span><span class="n">op_wb</span><span class="p">)</span><span class="n">s</span><span class="p">;</span>
<span class="mi">113</span>         <span class="p">}</span>
<span class="mi">114</span>
<span class="mi">115</span>         <span class="k">return</span> <span class="n">fault</span><span class="p">;</span>
<span class="mi">116</span>     <span class="p">}</span>
<span class="mi">117</span> <span class="p">}};</span>
</pre></td></tr></tbody></table></code></div></div>
<p>The above template contains incomplete code-snippets starting with % keyword. 
When the subst function of the corresponding template object is invoked,
all those uncompleted parts will be replaced.
For this replacement, we built the myDict dictionary.
Note that this myDict initialize itself using the information 
provided by the InstObjParams such as operands field of it.
Therefore, during substitution, if it encounters any keyword 
starting with %, it should refer to myDict to retrieve 
proper replacement for that. 
For example, class_name is provided by the InstObjParams.
Also, op_wb is the CPP statements translated from the keyword Data 
to write back the result to the output register. 
Let’s take a look at how the execute function will be implemented after substitution.</p>

<p><em>gem5/build/X86/arch/x86/generated/exec-ns.cc.inc</em></p>
<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
</pre></td><td class="rouge-code"><pre><span class="mi">19101</span>     <span class="n">Fault</span> <span class="n">Ld</span><span class="o">::</span><span class="n">execute</span><span class="p">(</span><span class="n">ExecContext</span> <span class="o">*</span><span class="n">xc</span><span class="p">,</span>
<span class="mi">19102</span>           <span class="n">Trace</span><span class="o">::</span><span class="n">InstRecord</span> <span class="o">*</span><span class="n">traceData</span><span class="p">)</span> <span class="k">const</span>
<span class="mi">19103</span>     <span class="p">{</span>
<span class="mi">19104</span>         <span class="n">Fault</span> <span class="n">fault</span> <span class="o">=</span> <span class="n">NoFault</span><span class="p">;</span>
<span class="mi">19105</span>         <span class="n">Addr</span> <span class="n">EA</span><span class="p">;</span>
<span class="mi">19106</span>
<span class="mi">19107</span>         <span class="kt">uint64_t</span> <span class="n">Index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="mi">19108</span> <span class="kt">uint64_t</span> <span class="n">Base</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="mi">19109</span> <span class="kt">uint64_t</span> <span class="n">Data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="mi">19110</span> <span class="kt">uint64_t</span> <span class="n">SegBase</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="mi">19111</span> <span class="kt">uint64_t</span> <span class="n">Mem</span><span class="p">;</span>
<span class="mi">19112</span> <span class="p">;</span>
<span class="mi">19113</span>         <span class="n">Index</span> <span class="o">=</span> <span class="n">xc</span><span class="o">-&gt;</span><span class="n">readIntRegOperand</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="mi">19114</span> <span class="n">Base</span> <span class="o">=</span> <span class="n">xc</span><span class="o">-&gt;</span><span class="n">readIntRegOperand</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="mi">19115</span> <span class="n">Data</span> <span class="o">=</span> <span class="n">xc</span><span class="o">-&gt;</span><span class="n">readIntRegOperand</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="mi">19116</span> <span class="n">SegBase</span> <span class="o">=</span> <span class="n">xc</span><span class="o">-&gt;</span><span class="n">readMiscRegOperand</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
<span class="mi">19117</span> <span class="p">;</span>
<span class="mi">19118</span>         <span class="n">EA</span> <span class="o">=</span> <span class="n">SegBase</span> <span class="o">+</span> <span class="n">bits</span><span class="p">(</span><span class="n">scale</span> <span class="o">*</span> <span class="n">Index</span> <span class="o">+</span> <span class="n">Base</span> <span class="o">+</span> <span class="n">disp</span><span class="p">,</span> <span class="n">addressSize</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);;</span>
<span class="mi">19119</span>         <span class="n">DPRINTF</span><span class="p">(</span><span class="n">X86</span><span class="p">,</span> <span class="s">"%s : %s: The address is %#x</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">instMnem</span><span class="p">,</span> <span class="n">mnemonic</span><span class="p">,</span> <span class="n">EA</span><span class="p">);</span>
<span class="mi">19120</span>
<span class="mi">19121</span>         <span class="n">fault</span> <span class="o">=</span> <span class="n">readMemAtomic</span><span class="p">(</span><span class="n">xc</span><span class="p">,</span> <span class="n">traceData</span><span class="p">,</span> <span class="n">EA</span><span class="p">,</span> <span class="n">Mem</span><span class="p">,</span> <span class="n">dataSize</span><span class="p">,</span> <span class="n">memFlags</span><span class="p">);</span>
<span class="mi">19122</span>
<span class="mi">19123</span>         <span class="k">if</span> <span class="p">(</span><span class="n">fault</span> <span class="o">==</span> <span class="n">NoFault</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">19124</span>             <span class="n">Data</span> <span class="o">=</span> <span class="n">merge</span><span class="p">(</span><span class="n">Data</span><span class="p">,</span> <span class="n">Mem</span><span class="p">,</span> <span class="n">dataSize</span><span class="p">);;</span>
<span class="mi">19125</span>         <span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">memFlags</span> <span class="o">&amp;</span> <span class="n">Request</span><span class="o">::</span><span class="n">PREFETCH</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">19126</span>             <span class="c1">// For prefetches, ignore any faults/exceptions.</span>
<span class="mi">19127</span>             <span class="k">return</span> <span class="n">NoFault</span><span class="p">;</span>
<span class="mi">19128</span>         <span class="p">}</span>
<span class="mi">19129</span>         <span class="k">if</span><span class="p">(</span><span class="n">fault</span> <span class="o">==</span> <span class="n">NoFault</span><span class="p">)</span>
<span class="mi">19130</span>         <span class="p">{</span>
<span class="mi">19131</span>
<span class="mi">19132</span>
<span class="mi">19133</span>         <span class="p">{</span>
<span class="mi">19134</span>             <span class="kt">uint64_t</span> <span class="n">final_val</span> <span class="o">=</span> <span class="n">Data</span><span class="p">;</span>
<span class="mi">19135</span>             <span class="n">xc</span><span class="o">-&gt;</span><span class="n">setIntRegOperand</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">final_val</span><span class="p">);</span>
<span class="mi">19136</span>
<span class="mi">19137</span>             <span class="k">if</span> <span class="p">(</span><span class="n">traceData</span><span class="p">)</span> <span class="p">{</span> <span class="n">traceData</span><span class="o">-&gt;</span><span class="n">setData</span><span class="p">(</span><span class="n">final_val</span><span class="p">);</span> <span class="p">}</span>
<span class="mi">19138</span>         <span class="p">};</span>
<span class="mi">19139</span>         <span class="p">}</span>
<span class="mi">19140</span>
<span class="mi">19141</span>         <span class="k">return</span> <span class="n">fault</span><span class="p">;</span>
<span class="mi">19142</span>     <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>As shown in the Line 19133-19138, 
the CPP statements translated from Data keyword of the code-snippet 
are implemented as a result of replacing op_wb.</p>


  </div>

  <div class="post-tail-wrapper text-muted">
    <!-- categories -->
    
      <div class="post-meta mb-3">
        <i class="far fa-folder-open fa-fw me-1"></i>
        
          <a href="/categories/gem5/">GEM5</a>,
          <a href="/categories/microops/">Microops</a>
      </div>
    

    <!-- tags -->
    

    <div
      class="
        post-tail-bottom
        d-flex justify-content-between align-items-center mt-5 pb-2
      "
    >
      <div class="license-wrapper">
        
          

          This post is licensed under 
        <a href="https://creativecommons.org/licenses/by/4.0/">
          CC BY 4.0
        </a>
         by the author.
        
      </div>

      <!-- Post sharing snippet -->

<div class="share-wrapper d-flex align-items-center">
  <span class="share-label text-muted">Share</span>
  <span class="share-icons">
    
    
    

    

      

      <a
        href="https://twitter.com/intent/tweet?text=Template%20Generating%20Microop%20-%20Ruach&url=https%3A%2F%2Fruach.github.io%2Fposts%2Ftemplate-generating-microop%2F"
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Twitter"
        target="_blank"
        rel="noopener"
        aria-label="Twitter"
      >
        <i class="fa-fw fa-brands fa-square-x-twitter"></i>
      </a>
    

      

      <a
        href="https://www.facebook.com/sharer/sharer.php?title=Template%20Generating%20Microop%20-%20Ruach&u=https%3A%2F%2Fruach.github.io%2Fposts%2Ftemplate-generating-microop%2F"
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Facebook"
        target="_blank"
        rel="noopener"
        aria-label="Facebook"
      >
        <i class="fa-fw fab fa-facebook-square"></i>
      </a>
    

      

      <a
        href="https://t.me/share/url?url=https%3A%2F%2Fruach.github.io%2Fposts%2Ftemplate-generating-microop%2F&text=Template%20Generating%20Microop%20-%20Ruach"
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Telegram"
        target="_blank"
        rel="noopener"
        aria-label="Telegram"
      >
        <i class="fa-fw fab fa-telegram"></i>
      </a>
    

      

      <a
        href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fruach.github.io%2Fposts%2Ftemplate-generating-microop%2F"
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Linkedin"
        target="_blank"
        rel="noopener"
        aria-label="Linkedin"
      >
        <i class="fa-fw fab fa-linkedin"></i>
      </a>
    

    <button
      id="copy-link"
      aria-label="Copy link"
      class="btn small"
      data-bs-toggle="tooltip"
      data-bs-placement="top"
      title="Copy link"
      data-title-succeed="Link copied successfully!"
    >
      <i class="fa-fw fas fa-link pe-none fs-6"></i>
    </button>
  </span>
</div>

    </div>
    <!-- .post-tail-bottom -->
  </div>
  <!-- div.post-tail-wrapper -->
</article>


            
          </main>

          <!-- panel -->
          <aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 mb-5 text-muted">
            <div class="access">
              <!-- Get the last 5 posts from lastmod list. -->















              <!-- The trending tags list -->


















            </div>

            
              
              



  <section id="toc-wrapper" class="ps-0 pe-4">
    <h2 class="panel-heading ps-3 pt-2 mb-2">Contents</h2>
    <nav id="toc"></nav>
  </section>


            
          </aside>
        </div>

        <div class="row">
          <!-- tail -->
          <div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4">
            
              
              <!-- Recommend the other 3 posts according to the tags and categories of the current post. -->

<!-- The total size of related posts -->


<!-- An random integer that bigger than 0 -->


<!-- Equals to TAG_SCORE / {max_categories_hierarchy} -->














  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  
    
  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  











  <aside id="related-posts" aria-labelledby="related-label">
    <h3 class="mb-4" id="related-label">Further Reading</h3>
    <nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4">
      
        <article class="col">
          <a href="/posts/gem5-macroop-to-microop/" class="post-preview card h-100">
            <div class="card-body">
              <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1590984000"
  data-df="ll"
  
>
  Jun  1, 2020
</time>

              <h4 class="pt-0 my-2">Gem5 Macroop To Microop</h4>
              <div class="text-muted">
                <p>
                  





                  Let’s begin by examining the translation of macroops into microops by first 
focusing on the well-known ‘mov’ instructions in the x86 architecture.

gem5/src/arch/x86/isa/insts/general_purpose/data...
                </p>
              </div>
            </div>
          </a>
        </article>
      
        <article class="col">
          <a href="/posts/gem5-event-loop/" class="post-preview card h-100">
            <div class="card-body">
              <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1589947200"
  data-df="ll"
  
>
  May 20, 2020
</time>

              <h4 class="pt-0 my-2">Gem5 Event Loop</h4>
              <div class="text-muted">
                <p>
                  





                  I covered how GEM5 configures the hardware parameters through the python script.
Also, in this posting I explained details how python can instantiate the 
CPP classes that actually simulate hardwar...
                </p>
              </div>
            </div>
          </a>
        </article>
      
        <article class="col">
          <a href="/posts/O3-CPU-GEM5/" class="post-preview card h-100">
            <div class="card-body">
              <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1622001600"
  data-df="ll"
  
>
  May 26, 2021
</time>

              <h4 class="pt-0 my-2">O3 Cpu Gem5</h4>
              <div class="text-muted">
                <p>
                  





                  Python derives O3CPU through DerivO3CPU class
To understand particular processor in the GEM5, 
it is easy to start from the script that instantiate the processor. 
We can easily find that lots of G...
                </p>
              </div>
            </div>
          </a>
        </article>
      
    </nav>
  </aside>
  <!-- #related-posts -->


            
              
              <!-- Navigation buttons at the bottom of the post. -->

<nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation">
  
  

  
    <a
      href="/posts/gem5-macroop-to-microop/"
      class="btn btn-outline-primary"
      aria-label="Older"
    >
      <p>Gem5 Macroop To Microop</p>
    </a>
  

  
    <a
      href="/posts/gem5-x86-tlb/"
      class="btn btn-outline-primary"
      aria-label="Newer"
    >
      <p>Gem5 X86 Tlb</p>
    </a>
  
</nav>

            
              
              <!--  The comments switcher -->

  
  <!-- The Disqus lazy loading. -->

<div id="disqus_thread">
  <p class="text-center text-muted small">Comments powered by <a href="https://disqus.com/">Disqus</a>.</p>
</div>

<script type="text/javascript">
  var disqus_config = function () {
    this.page.url = 'https://ruach.github.io/posts/template-generating-microop/';
    this.page.identifier = '/posts/template-generating-microop/';
  };

  /* Lazy loading */
  var disqus_observer = new IntersectionObserver(
    function (entries) {
      if (entries[0].isIntersecting) {
        (function () {
          var d = document,
            s = d.createElement('script');
          s.src = 'https://ruach.disqus.com/embed.js';
          s.setAttribute('data-timestamp', +new Date());
          (d.head || d.body).appendChild(s);
        })();

        disqus_observer.disconnect();
      }
    },
    { threshold: [0] }
  );

  disqus_observer.observe(document.querySelector('#disqus_thread'));

  /* Auto switch theme */
  function reloadDisqus() {
    if (event.source === window && event.data && event.data.direction === ModeToggle.ID) {
      /* Disqus hasn't been loaded */
      if (typeof DISQUS === 'undefined') {
        return;
      }

      if (document.readyState == 'complete') {
        DISQUS.reset({ reload: true, config: disqus_config });
      }
    }
  }

  if (document.querySelector('.mode-toggle')) {
    window.addEventListener('message', reloadDisqus);
  }
</script>



            

            <!-- The Footer -->

<footer
  aria-label="Site Info"
  class="
    d-flex flex-column justify-content-center text-muted
    flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3
  "
>
  <p>
    ©
    <time>2023</time>
    <a href="https://ruach.github.io">Jaehyuk Lee</a>.
    
      <span
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author."
      >Some rights reserved.</span>
    
  </p>

  <p>Using the <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme for <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>
  </p>
</footer>

          </div>
        </div>

        <!-- The Search results -->

<div id="search-result-wrapper" class="d-flex justify-content-center unloaded">
  <div class="col-11 content">
    <div id="search-hints">
      <!-- The trending tags list -->


















    </div>
    <div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div>
  </div>
</div>

      </div>

      <aside aria-label="Scroll to Top">
        <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow">
          <i class="fas fa-angle-up"></i>
        </button>
      </aside>
    </div>

    <div id="mask"></div>

    
      <aside
  id="notification"
  class="toast"
  role="alert"
  aria-live="assertive"
  aria-atomic="true"
  data-bs-animation="true"
  data-bs-autohide="false"
>
  <div class="toast-header">
    <button
      type="button"
      class="btn-close ms-auto"
      data-bs-dismiss="toast"
      aria-label="Close"
    ></button>
  </div>
  <div class="toast-body text-center pt-0">
    <p class="px-2 mb-3">A new version of content is available.</p>
    <button type="button" class="btn btn-primary" aria-label="Update">
      Update
    </button>
  </div>
</aside>

    

    <!-- JavaScripts -->

    <!-- JS selector for site. -->

<!-- commons -->



<!-- layout specified -->


  

  
    <!-- image lazy-loading & popup & clipboard -->
    
  















  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  



  <script src="https://cdn.jsdelivr.net/combine/npm/jquery@3.7.1/dist/jquery.min.js,npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js,npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/magnific-popup@1.1.0/dist/jquery.magnific-popup.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.10/dayjs.min.js,npm/dayjs@1.11.10/locale/en.min.js,npm/dayjs@1.11.10/plugin/relativeTime.min.js,npm/dayjs@1.11.10/plugin/localizedFormat.min.js,npm/tocbot@4.21.2/dist/tocbot.min.js"></script>






<script defer src="/assets/js/dist/post.min.js"></script>






    

    <!--
  Jekyll Simple Search loader
  See: <https://github.com/christian-fei/Simple-Jekyll-Search>
-->





<script>
  /* Note: dependent library will be loaded in `js-selector.html` */
  SimpleJekyllSearch({
    searchInput: document.getElementById('search-input'),
    resultsContainer: document.getElementById('search-results'),
    json: '/assets/js/data/search.json',
    searchResultTemplate: '  <article class="px-1 px-sm-2 px-lg-4 px-xl-0">    <header>      <h2><a href="{url}">{title}</a></h2>      <div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1">        {categories}        {tags}      </div>    </header>    <p>{snippet}</p>  </article>',
    noResultsText: '<p class="mt-5"></p>',
    templateMiddleware: function(prop, value, template) {
      if (prop === 'categories') {
        if (value === '') {
          return `${value}`;
        } else {
          return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`;
        }
      }

      if (prop === 'tags') {
        if (value === '') {
          return `${value}`;
        } else {
          return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`;
        }
      }
    }
  });
</script>

  </body>
</html>

